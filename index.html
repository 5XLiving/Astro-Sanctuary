
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">命理心怜空间 · Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="命理心怜空间 · 免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等，一站式灵性与命理体验。">
  <meta property="og:title" content="命理心怜空间 · Soul Sanctuary">
  <meta property="og:description" content="免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等。">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dCC; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4; --muted:#9aa3b2;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22); --radius:14px;
  }

  html,body{height:100%} 
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} } 
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }

  .glow{position:fixed; inset:auto auto 10% -10%; width:45vw; height:45vw; max-width:700px; max-height:700px;
    background:radial-gradient(closest-side, #2a98ff33, transparent 70%); filter:blur(30px); z-index:-1; pointer-events:none;}
  .container{width:100%; max-width:1100px; padding:24px 16px 80px; margin:0 auto;}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(12px);
    background:#0b0f14cc; border-bottom:1px solid #0f1622;}
  .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand-badge{width:36px; height:36px; border-radius:10px; background:linear-gradient(145deg,#273243,#0e141c);
    display:grid; place-items:center; color:var(--brand); font-weight:700; box-shadow:var(--shadow)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem}
  .subtitle{color:var(--muted); font-size:.9rem}

  /* 语言选择器 */
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{color:var(--muted); font-size:.9rem}
  .lang select{
    appearance:none; border-radius:10px; border:1px solid #243244; background:#0e1520; color:var(--text);
    padding:12px 40px 12px 14px; font-size:1rem; /* 放大一些 */
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== 按钮统一成高端亮金（加大尺寸） ===== */
  .btn, .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:14px 18px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:700; letter-spacing:.3px; font-size:1.05rem;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover, .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Ghost 按钮保持辅助风格 */
  .btn.ghost{
    background:transparent; color:var(--gold2);
    border:1px solid rgba(212,175,55,.45); box-shadow:none;
  }

  /* block 按钮 */
  .btn.block { display:block; width:100%; max-width:100%; box-sizing:border-box; }
  .row.one .btn.block { display:block !important; }
  .panel .body .btn.block { margin-left:auto; margin-right:auto; }

  /* Chat 浮窗按钮 */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== 无障碍隐藏文字 ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}

  /* Auth 大面板 */
  .astro-auth{ max-width: 980px; margin: 28px auto; padding: 20px 18px;
    background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
    border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 18px 50px rgba(0,0,0,.35); }
  .auth-grid{ display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; }
  @media (max-width: 860px){ .auth-grid{ grid-template-columns: 1fr; } }
  .panel{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .panel .head{ padding:16px 18px; border-bottom:1px solid var(--border);
    color:var(--gold); font-weight:700; letter-spacing:.3px; }
  .panel .body{ padding:18px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row.one{ grid-template-columns: 1fr; }  /* 单列 */
  .row.center{ align-items:center; }
  @media (max-width:640px){ .row{ grid-template-columns: 1fr; } }

  /* 放大输入框（填写栏） */
  .astro-auth input[type="email"], .astro-auth input[type="password"]{
    width:100%; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:12px;
    padding:16px 14px; font-size:1.1rem; min-height:50px; /* 更大更易点按 */
    outline:none; transition:.18s;
  }
  .astro-auth input:focus{ border-color:var(--gold2); box-shadow:0 0 0 3px rgba(212,175,55,.2); }
  .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
  .error{ color:#ffb4b4; background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25);
          padding:10px 12px; border-radius:10px; }
  .spacer{ height:12px; }

  /* ===== Chat 面板样式（移动自 <script>） ===== */
  .ss-chat-panel{
    position:fixed; right:18px; bottom:88px; z-index:50;
    width:min(460px,92vw);
    display:none;
    background:#0e1520; border:1px solid #243244;
    border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35);
    backdrop-filter:blur(10px);
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700;color:#ffe084}
  .ss-close{cursor:pointer;opacity:.85}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;
    border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;
    padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{
    flex:1 1 auto; min-width:0; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:10px; padding:12px;
  }
  .ss-chat-input input:focus{border-color:#f2d27a; box-shadow:0 0 0 2px rgba(242,210,122,.25)}
  .ss-chat-input button{
    flex:0 0 auto; white-space:nowrap;
    padding:10px 14px; border-radius:10px; border:1px solid #e6c76e;
    background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:700;
  }
</style>

</head>
<body>
  <div class="glow"></div>
  <header>
    <div class="head-inner container">
      <div class="brand">
        <div class="brand-badge">5X</div>
        <div>
          <div class="title" data-i18n="site_title">命理心怜空间 · Soul Sanctuary</div>
        </div>
      </div>
      <!-- 语言选择器 -->
      <div class="lang">
        <label for="langSelect" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 免费体验区 -->
    <section class="card section">
      <div class="group-title" data-i18n="free_title">🌀 免费体验区 Free Segment</div>
      <div class="grid-links">
        <a class="link-card" href="bazi.html" data-i18n="link_bazi" aria-label="前往 八字命理分析">八字命理分析</a>
        <a class="link-card" href="natal.html" data-i18n="link_natal" aria-label="前往 本命星盘分析">本命星盘分析</a>
        <a class="link-card" href="life_path.html" data-i18n="link_life" aria-label="前往 灵数分析">灵数分析</a>
        <a class="link-card" href="tarot.html" data-i18n="link_tarot" aria-label="前往 塔罗指引分析">塔罗指引分析</a>
        <a class="link-card" href="kyuusei.html" data-i18n="link_kyuusei" aria-label="前往 九星气学分析">九星气学分析</a>
        <a class="link-card" href="energy.html" data-i18n="link_energy" aria-label="前往 能量类型分析">能量类型分析</a>
        <a class="link-card" href="vedic_astrology.html" data-i18n="link_vedic" aria-label="前往 印度命理吠陀占星">印度命理吠陀占星</a>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <!-- 登录/注册表单 -->
      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head">账户登录 / 注册</div>
            <div class="body">
              <!-- 输入区（单列放大） -->
              <div class="row one" id="authFields">
                <label for="email" class="sr-only">Email</label>
                <input id="email" name="email" type="email" inputmode="email"
                      autocomplete="username" placeholder="邮箱 Email" data-i18n-ph="ph_email" required />

                <label for="password" class="sr-only">密码 Password</label>
                <input id="password" name="password" type="password"
                      autocomplete="current-password"
                      placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required />
              </div>

              <div class="spacer"></div>

              <!-- 登录 -->
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>

              <div class="spacer"></div>

              <!-- 重设密码 -->
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>

              <div class="spacer"></div>

              <!-- 注册 -->
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
              </form>

              <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>

              <!-- 错误提示 -->
              <div class="error" id="error" role="alert" aria-live="polite" style="display:none"></div>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>

              <div class="spacer"></div>

              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>

              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">
                $9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 功能脚本：后端代理 + 多语言 + Chat 浮窗 -->
<script>
  // ============== 统一配置（你的 Worker 域名） ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

  // 工具函数
  const $ = id => document.getElementById(id);
  function showErr(msg){ const e=$("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }

  // ============== 多语言 ==============
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }

  // 翻译表（补上 chat_title，避免回退）
  const translations = {
    "zh-CN": {
      page_title:"命理心怜空间 · Index",
      site_title:"命理心怜空间 · Soul Sanctuary",
      site_subtitle:"免费体验 & 会员专区 · 统一风格版",
      lang_label:"语言",
      free_title:"🌀 免费体验区 Free Segment",
      link_bazi:"八字命理分析", link_natal:"本命星盘分析", link_life:"灵数分析",
      link_tarot:"塔罗指引分析", link_kyuusei:"九星气学分析", link_energy:"能量类型分析", link_vedic:"印度命理吠陀占星",
      vip_title:"🌙 会员区域 VIP Segment",
      vip_mingli:"🗝 命理空间专属内容",
      vip_love:"姻缘方向：恋爱缘分、婚姻走势",
      vip_career:"事业方向：职场发展、创业潜力",
      vip_wealth:"财运方向：财位分析、理财时机",
      vip_pet:"宠物命理：伴侣动物的性格与缘分",
      vip_hepan:"合盘分析：婚期择日、新生择时",
      vip_name:"测名分析：公司名、宝宝名、命名改运",
      vip_fengshui:"财位合盘：住家 / 办公室动线配合",
      vip_xinlian:"🌙 心怜空间专属内容",
      vip_record:"灵性记录：照片、梦境、声音、愿望祈祷",
      vip_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
      vip_memorial:"家族纪念系统：亲人灵性纪念 & 延续",
      vip_tasks:"每周能量练习 / 神明仪式任务",
      vip_shop:"能量商城专属折扣 & 御守订制",
      login_title:"💎 登入 VIP 功能",
      ph_email:"邮箱 Email",
      ph_password:"密码 Password（至少8位，含大小写数字符号）",
      btn_register:"注册账户",
      btn_login:"登入账户",
      btn_upgrade:"💎 升级为 VIP（月费）",
      btn_backshop:"← 返回命理商城",
      btn_reset:"🔑 重设密码",
      note_price:"注册账号赠送一次免费体验",
      note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
      err_need_ep:"请输入邮箱与密码",
      err_pwd_rule:"密码至少8位，需包含大写/小写/数字/特殊符号",
      err_exists:"此邮箱已注册，请直接登入",
      err_register_fail:"注册失败：",
      err_no_account:"账户不存在，请先注册",
      err_wrong_pwd:"密码错误",
      err_expired:"会员已过期，请续费",
      err_login_fail:"登入失败：",
      prompt_email:"请输入注册邮箱：",
      err_email_empty:"邮箱不能为空",
      prompt_newpwd:"请输入新密码（至少8位，含大小写、数字、符号）：",
      err_pwd_empty:"密码不能为空",
      err_reset_fail:"重设失败：",
      msg_reset_ok:"密码已成功更新，请用新密码重新登入。",
      chat_title:"心怜管家 · Chat",
      chat_fab:"问", chat_placeholder:"请问您想了解什么？（如：如何开始免费体验）", chat_send:"发送"
    },
    "zh-TW": { /* 其余同上，略，为简洁仅示关键新增键 */ 
      page_title:"命理心憐空間 · Index",
      site_title:"命理心憐空間 · Soul Sanctuary",
      /* ...其余省略... */
      chat_title:"心憐管家 · Chat",
      chat_fab:"問", chat_placeholder:"想了解什麼？（例如：如何開始免費體驗）", chat_send:"發送"
    },
    "en": {
      page_title:"Soul Sanctuary · Index",
      site_title:"Soul Sanctuary",
      /* ... */
      chat_title:"Concierge · Chat",
      chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., how to start the free trial)", chat_send:"Send"
    },
    "ja": { page_title:"ソウル・サンクチュアリ · Index", site_title:"ソウル・サンクチュアリ",
      /* ... */ chat_title:"心怜コンシェルジュ · チャット", chat_fab:"問", chat_placeholder:"何を知りたいですか？（例：無料体験の始め方）", chat_send:"送信" },
    "th": { page_title:"Soul Sanctuary · หน้าแรก", site_title:"Soul Sanctuary",
      /* ... */ chat_title:"ผู้ช่วย · แชต", chat_fab:"ถาม", chat_placeholder:"อยากรู้อะไร (เช่น เริ่มทดลองฟรีอย่างไร)", chat_send:"ส่ง" },
    "ms": { page_title:"Soul Sanctuary · Indeks", site_title:"Soul Sanctuary",
      /* ... */ chat_title:"Pembantu · Sembang", chat_fab:"Tanya", chat_placeholder:"Anda mahu tahu apa? (cth: cara mula percubaan)", chat_send:"Hantar" }
  };

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  // ============== Chat 浮窗（走 /api/chat） ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    const title = document.querySelector('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('chat_title');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat 按钮与面板
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">${t('chat_title') || '心怜管家 · Chat'}</div>
        <div class="ss-close" id="ssChatClose">✕</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    // 让回车 → 触发“登入账户”
    const fields = document.getElementById('authFields');
    const loginBtn = document.getElementById('loginBtn');
    if (fields && loginBtn) {
      fields.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') {
          e.preventDefault();
          loginBtn.click();
        }
      });
    }

    // 初始语言（页面 + chat）
    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。');
        addMsg(reply);
      }catch(e){
        addMsg('网络异常，请稍后再试。');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // 语言切换
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }
  });

  // ============== 登录流程（集中处理 exists / expired / expiresAt） ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }

  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    // ✅ 统一判断是否过期（兼容 msg/flag/时间戳）
    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      const go = confirm(t('err_expired') + "。是否前往续费？");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== 表单事件（注册 / 登录 / 重设） ========
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById("registerForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideErr();
      const email = $("email").value.trim();
      const password = $("password").value.trim();
      if (!email || !password) return showErr(t('err_need_ep'));
      if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

      lock($("registerBtn"), true);
      try{
        const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }));

        if (res.ok === true){
          localStorage.setItem("vipEmail", email);
          location.href = "vip_trial.html";
          return;
        }

        if ((res.msg||"").toString() === 'exists'){
          await loginFlow(email, password);
          return;
        }

        return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
      } catch(err){
        showErr(t('err_register_fail') + (err?.message || ''));
      } finally{
        lock($("registerBtn"), false);
      }
    });

    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideErr();
      const email = $("email").value.trim();
      const password = $("password").value.trim();
      if (!email || !password) return showErr(t('err_need_ep'));
      lock($("loginBtn"), true);
      try{
        await loginFlow(email, password);
      } catch(err){
        showErr(t('err_login_fail') + (err?.message || ''));
      } finally{
        lock($("loginBtn"), false);
      }
    });

    document.getElementById("resetBtn").addEventListener("click", async ()=>{
      hideErr();
      let email = prompt(t('prompt_email'));
      if (email === null) return; email = email.trim();
      if (!email) return showErr(t('err_email_empty'));

      let newPassword = prompt(t('prompt_newpwd'));
      if (newPassword === null) return; newPassword = newPassword.trim();
      if (!newPassword) return showErr(t('err_pwd_empty'));
      if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

      lock($("resetBtn"), true);
      try{
        const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword })
        }));
        if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
        alert(t('msg_reset_ok'));
      } catch(err){
        showErr(t('err_reset_fail') + (err?.message || ''));
      } finally{
        lock($("resetBtn"), false);
      }
    });
  });
</script>
</body>
</html>
