
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ï¼Œä¸€ç«™å¼çµæ€§ä¸å‘½ç†ä½“éªŒã€‚">
  <meta property="og:title" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary">
  <meta property="og:description" content="å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ã€‚">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dCC; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4; --muted:#9aa3b2;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22); --radius:14px;
  }

  html,body{height:100%} 
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} } 
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }

  .glow{position:fixed; inset:auto auto 10% -10%; width:45vw; height:45vw; max-width:700px; max-height:700px;
    background:radial-gradient(closest-side, #2a98ff33, transparent 70%); filter:blur(30px); z-index:-1; pointer-events:none;}
  .container{width:100%; max-width:1100px; padding:24px 16px 80px; margin:0 auto;}
  
  /* â€”â€” å¤´éƒ¨ï¼ˆTarot åŒæ¬¾ï¼‰ â€”â€” */
  .site-header{
    position:sticky;
    top:0;
    z-index:10;
    background:#0b0f14cc;
    border-bottom:1px solid #0f1622;
    backdrop-filter:saturate(140%) blur(12px);
    transition: all 0.3s ease;
  }
  .site-header.scrolled {
    background: rgba(11, 15, 20, 0.95);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  .head-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    padding:14px 16px;
  }
  
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; 
  place-items:center; 
  width:34px; 
  height:34px; 
  border-radius:8px; 
  background:linear-gradient(180deg,#0e1520,#0b1018); 
  border:1px solid #2a3546; 
  box-shadow:0 4px 14px rgba(0,0,0,.35); 
  font-weight:800; 
  color:#ffe084;
  transition: all 0.3s ease;
}
.brand:hover .brand-badge {
  transform: rotate(15deg);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}
.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

/* æ–°å¢ï¼šé¼ æ ‡åœ¨æ•´æ¡ brand ä¸Šæ—¶ï¼Œé«˜äº®æ ‡é¢˜ */
.brand:hover .title {
  color: var(--gold);
}
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; 
  min-width:170px; 
  border-radius:10px; 
  border:1px solid #243244; 
  background:#0e1520; 
  color:var(--text); 
  padding:10px 34px 10px 12px; 
  font-size:.95rem; 
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E"); 
  background-repeat:no-repeat; 
  background-position:calc(100% - 12px) 50%;
  transition: all 0.3s ease;
}
.lang select:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
}
@media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== æŒ‰é’®ç»Ÿä¸€æˆé«˜ç«¯äº®é‡‘ï¼ˆåŠ å¤§å°ºå¯¸ï¼‰ ===== */
  .btn, .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:14px 18px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:700; letter-spacing:.3px; font-size:1.05rem;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover, .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Ghost æŒ‰é’®ä¿æŒè¾…åŠ©é£æ ¼ */
  .btn.ghost{
    background:transparent; color:var(--gold2);
    border:1px solid rgba(212,175,55,.45); box-shadow:none;
  }

  /* block æŒ‰é’® */
  .btn.block { display:block; width:100%; max-width:100%; box-sizing:border-box; }
  .row.one .btn.block { display:block !important; }
  .panel .body .btn.block { margin-left:auto; margin-right:auto; }

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== æ— éšœç¢éšè—æ–‡å­— ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}

  /* Auth å¤§é¢æ¿ */
  .astro-auth{ max-width: 980px; margin: 28px auto; padding: 20px 18px;
    background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
    border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 18px 50px rgba(0,0,0,.35); }
  .auth-grid{ display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; }
  @media (max-width: 860px){ .auth-grid{ grid-template-columns: 1fr; } }
  .panel{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .panel .head{ padding:16px 18px; border-bottom:1px solid var(--border);
    color:var(--gold); font-weight:700; letter-spacing:.3px; }
  .panel .body{ padding:18px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row.one{ grid-template-columns: 1fr; }  /* å•åˆ— */
  .row.center{ align-items:center; }
  @media (max-width:640px){ .row{ grid-template-columns: 1fr; } }

  /* æ”¾å¤§è¾“å…¥æ¡†ï¼ˆå¡«å†™æ ï¼‰ */
  .astro-auth input[type="email"], .astro-auth input[type="password"]{
    width:100%; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:12px;
    padding:16px 14px; font-size:1.1rem; min-height:50px; /* æ›´å¤§æ›´æ˜“ç‚¹æŒ‰ */
    outline:none; transition:.18s;
  }
  .astro-auth input:focus{ border-color:var(--gold2); box-shadow:0 0 0 3px rgba(212,175,55,.2); }
  .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
  .error{ color:#ffb4b4; background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25);
          padding:10px 12px; border-radius:10px; }
  .spacer{ height:12px; }

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}
</style>

</head>
<body>
  <div class="glow"></div>
  <header>
    <div class="head-inner container">
      <div class="brand">
        <div class="brand-badge">5X</div>
        <div>
          <div class="title" data-i18n="site_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary</div>
        </div>
      </div>
      <!-- è¯­è¨€é€‰æ‹©å™¨ -->
      <div class="lang">
        <label for="langSelect" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- å…è´¹ä½“éªŒåŒº -->
    <section class="card section">
      <div class="group-title" data-i18n="free_title">ğŸŒ€ å…è´¹ä½“éªŒåŒº Free Segment</div>
      <div class="grid-links">
        <a class="link-card" href="bazi.html" data-i18n="link_bazi" aria-label="å‰å¾€ å…«å­—å‘½ç†åˆ†æ">å…«å­—å‘½ç†åˆ†æ</a>
        <a class="link-card" href="natal.html" data-i18n="link_natal" aria-label="å‰å¾€ æœ¬å‘½æ˜Ÿç›˜åˆ†æ">æœ¬å‘½æ˜Ÿç›˜åˆ†æ</a>
        <a class="link-card" href="life_path.html" data-i18n="link_life" aria-label="å‰å¾€ çµæ•°åˆ†æ">çµæ•°åˆ†æ</a>
        <a class="link-card" href="tarot.html" data-i18n="link_tarot" aria-label="å‰å¾€ å¡”ç½—æŒ‡å¼•åˆ†æ">å¡”ç½—æŒ‡å¼•åˆ†æ</a>
        <a class="link-card" href="kyuusei.html" data-i18n="link_kyuusei" aria-label="å‰å¾€ ä¹æ˜Ÿæ°”å­¦åˆ†æ">ä¹æ˜Ÿæ°”å­¦åˆ†æ</a>
        <a class="link-card" href="energy.html" data-i18n="link_energy" aria-label="å‰å¾€ èƒ½é‡ç±»å‹åˆ†æ">èƒ½é‡ç±»å‹åˆ†æ</a>
        <a class="link-card" href="vedic_astrology.html" data-i18n="link_vedic" aria-label="å‰å¾€ å°åº¦å‘½ç†å é™€å æ˜Ÿ">å°åº¦å‘½ç†å é™€å æ˜Ÿ</a>
      </div>
    </section>

    <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

      <!-- ç™»å½•/æ³¨å†Œè¡¨å• -->
      <section class="astro-auth">
        <div class="auth-grid">
          <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
          <div class="panel">
            <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <!-- è¾“å…¥åŒºï¼ˆå•åˆ—æ”¾å¤§ï¼‰ -->
              <div class="row one" id="authFields">
                <label for="email" class="sr-only">Email</label>
                <input id="email" name="email" type="email" inputmode="email"
                      autocomplete="username" placeholder="é‚®ç®± Email" data-i18n-ph="ph_email" required />

                <label for="password" class="sr-only">å¯†ç  Password</label>
                <input id="password" name="password" type="password"
                      autocomplete="current-password"
                      placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required />
              </div>

              <div class="spacer"></div>

              <!-- ç™»å½• -->
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>

              <div class="spacer"></div>

              <!-- é‡è®¾å¯†ç  -->
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>

              <div class="spacer"></div>

              <!-- æ³¨å†Œ -->
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
              </form>

              <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>

              <!-- é”™è¯¯æç¤º -->
              <div class="error" id="error" role="alert" aria-live="polite" style="display:none"></div>
            </div>
          </div>

          <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
          <div class="panel">
            <div class="head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>

              <div class="spacer"></div>

              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>

              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">
                $9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
</body>
          
<!-- GPT / å¿ƒæ€œç®¡å®¶ï¼ˆç»Ÿä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat_fab">é—®</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ€œç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å†…å®¹åŒºï¼šä¿æŒä¸ºç©ºï¼Œæ¶ˆæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¾“å…¥é—®é¢˜â€¦"
      data-i18n-ph="chat_input_ph"
    />
    <button class="btn" id="chatSend" data-i18n="chat_send">å‘é€</button>
  </div>
</div>

  <!-- åŠŸèƒ½è„šæœ¬ï¼šåç«¯ä»£ç† + å¤šè¯­è¨€ + Chat æµ®çª— -->
<script>
(() => {
  'use strict';

  /* ===================== CONFIG ===================== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  const LANG_KEY = 'site_lang';

  /* ===================== DOM ===================== */
  const $ = (id) => document.getElementById(id);

  /* ===================== UI HELPERS ===================== */
  function showErr(msg){
    const e = $('error');
    if (!e) return;
    e.textContent = msg || '';
    e.style.display = 'block';
    window.clearTimeout(showErr._t);
    showErr._t = window.setTimeout(() => {
      e.style.display = 'none';
      e.textContent = '';
    }, 5000);
  }
  function hideErr(){
    const e = $('error');
    if (!e) return;
    e.style.display = 'none';
    e.textContent = '';
  }
  function lock(el, v){ if (el) el.disabled = !!v; }

  function strongPwd(pw){
    if (!pw) return false;
    return pw.length >= 8 &&
      /[A-Z]/.test(pw) &&
      /[a-z]/.test(pw) &&
      /[0-9]/.test(pw) &&
      /[^A-Za-z0-9]/.test(pw);
  }

  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }

  /* ===================== I18N ===================== */
  function getLang(){
    return localStorage.getItem(LANG_KEY) || document.documentElement.lang || 'zh-CN';
  }
  function setLang(code){
    localStorage.setItem(LANG_KEY, code);
    document.documentElement.lang = code;
  }

  const translations = {
    'zh-CN': {
      page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Index",
      site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary",
      lang_label:"è¯­è¨€",

      free_title:"ğŸŒ€ å…è´¹ä½“éªŒåŒº Free Segment",
      link_bazi:"å…«å­—å‘½ç†åˆ†æ",
      link_natal:"æœ¬å‘½æ˜Ÿç›˜åˆ†æ",
      link_life:"çµæ•°åˆ†æ",
      link_tarot:"å¡”ç½—æŒ‡å¼•åˆ†æ",
      link_kyuusei:"ä¹æ˜Ÿæ°”å­¦åˆ†æ",
      link_energy:"èƒ½é‡ç±»å‹åˆ†æ",
      link_vedic:"å°åº¦å‘½ç†å é™€å æ˜Ÿ",

      vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
      vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
      vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
      vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
      vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
      vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
      vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
      vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
      vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",

      vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
      vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
      vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
      vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
      vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
      vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",

      login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",

      // placeholders
      ph_email:"é‚®ç®± Email",
      ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",

      // buttons
      btn_login:"ç™»å…¥è´¦æˆ·",
      btn_register:"æ³¨å†Œè´¦æˆ·",
      btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
      btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
      btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",

      note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
      note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",

      // auth field toggle (privacy preference)
      btn_show_fields:"æ˜¾ç¤ºç™»å½•è¾“å…¥æ¡†",
      btn_hide_fields:"éšè—ç™»å½•è¾“å…¥æ¡†",

      // errors / prompts
      err_need_ep:"è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ",
      err_pwd_rule:"å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·",
      err_no_account:"è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ",
      err_wrong_pwd:"å¯†ç é”™è¯¯",
      err_expired:"ä¼šå‘˜å·²è¿‡æœŸï¼Œè¯·ç»­è´¹",
      err_login_fail:"ç™»å…¥å¤±è´¥ï¼š",
      err_register_fail:"æ³¨å†Œå¤±è´¥ï¼š",
      err_reset_fail:"é‡è®¾å¤±è´¥ï¼š",
      prompt_email:"è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š",
      err_email_empty:"é‚®ç®±ä¸èƒ½ä¸ºç©º",
      prompt_newpwd:"è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š",
      err_pwd_empty:"å¯†ç ä¸èƒ½ä¸ºç©º",
      msg_reset_ok:"å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚",

      // chat
      chat_title:"å¿ƒæ€œç®¡å®¶ Â· GPT",
      chat_fab:"é—®",
      chat_input_ph:"è¾“å…¥é—®é¢˜â€¦",
      chat_send:"å‘é€",
      chat_welcome:"ä½ å¥½ï¼Œæˆ‘æ˜¯å¿ƒæ€œç®¡å®¶ã€‚ä½ å¯ä»¥é—®ï¼šå¦‚ä½•å¼€å§‹å…è´¹ä½“éªŒï¼ŸVIPåŒ…å«ä»€ä¹ˆï¼Ÿå¦‚ä½•ç™»å½•ï¼Ÿ",
      chat_busy:"æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚",
      chat_net_err:"ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚"
    },

    'zh-TW': {
      page_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· Index",
      site_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· Soul Sanctuary",
      lang_label:"èªè¨€",

      free_title:"ğŸŒ€ å…è²»é«”é©—å€ Free Segment",
      link_bazi:"å…«å­—å‘½ç†åˆ†æ",
      link_natal:"æœ¬å‘½æ˜Ÿç›¤åˆ†æ",
      link_life:"éˆæ•¸åˆ†æ",
      link_tarot:"å¡”ç¾…æŒ‡å¼•åˆ†æ",
      link_kyuusei:"ä¹æ˜Ÿæ°£å­¸åˆ†æ",
      link_energy:"èƒ½é‡é¡å‹åˆ†æ",
      link_vedic:"å°åº¦å‘½ç†å é™€å æ˜Ÿ",

      vip_title:"ğŸŒ™ æœƒå“¡å€åŸŸ VIP Segment",
      vip_mingli:"ğŸ— å‘½ç†ç©ºé–“å°ˆå±¬å…§å®¹",
      vip_love:"å§»ç·£æ–¹å‘ï¼šæˆ€æ„›ç·£åˆ†ã€å©šå§»èµ°å‹¢",
      vip_career:"äº‹æ¥­æ–¹å‘ï¼šè·å ´ç™¼å±•ã€å‰µæ¥­æ½›åŠ›",
      vip_wealth:"è²¡é‹æ–¹å‘ï¼šè²¡ä½åˆ†æã€ç†è²¡æ™‚æ©Ÿ",
      vip_pet:"å¯µç‰©å‘½ç†ï¼šä¼´ä¾¶å‹•ç‰©çš„æ€§æ ¼èˆ‡ç·£åˆ†",
      vip_hepan:"åˆç›¤åˆ†æï¼šå©šæœŸæ“‡æ—¥ã€æ–°ç”Ÿæ“‡æ™‚",
      vip_name:"æ¸¬ååˆ†æï¼šå…¬å¸åã€å¯¶å¯¶åã€å‘½åæ”¹é‹",
      vip_fengshui:"è²¡ä½åˆç›¤ï¼šä½å®¶ / è¾¦å…¬å®¤å‹•ç·šé…åˆ",

      vip_xinlian:"ğŸŒ™ å¿ƒæ†ç©ºé–“å°ˆå±¬å…§å®¹",
      vip_record:"éˆæ€§è¨˜éŒ„ï¼šç…§ç‰‡ã€å¤¢å¢ƒã€è²éŸ³ã€é¡˜æœ›ç¥ˆç¦±",
      vip_course:"å‘½ç†èª²ç¨‹ï¼šå…«å­— / å¡”ç¾… / å æ˜Ÿ / éˆæ•¸ / äººé¡åœ–",
      vip_memorial:"å®¶æ—ç´€å¿µç³»çµ±ï¼šè¦ªäººéˆæ€§ç´€å¿µ & å»¶çºŒ",
      vip_tasks:"æ¯é€±èƒ½é‡ç·´ç¿’ / ç¥æ˜å„€å¼ä»»å‹™",
      vip_shop:"èƒ½é‡å•†åŸå°ˆå±¬æŠ˜æ‰£ & å¾¡å®ˆè¨‚è£½",

      login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
      ph_email:"ä¿¡ç®± Email",
      ph_password:"å¯†ç¢¼ Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«æ•¸å­—ç¬¦è™Ÿï¼‰",
      btn_login:"ç™»å…¥å¸³æˆ¶",
      btn_register:"è¨»å†Šå¸³æˆ¶",
      btn_reset:"ğŸ”‘ é‡è¨­å¯†ç¢¼",
      btn_upgrade:"ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆè²»ï¼‰",
      btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
      note_price:"è¨»å†Šå¸³è™Ÿè´ˆé€ä¸€æ¬¡å…è²»é«”é©—",
      note_price1:"$9.9 / æœˆè²» VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ†ç©ºé–“ + éˆæ€§èª²ç¨‹ï¼‰",
      btn_show_fields:"é¡¯ç¤ºç™»å…¥è¼¸å…¥æ¡†",
      btn_hide_fields:"éš±è—ç™»å…¥è¼¸å…¥æ¡†",

      err_need_ep:"è«‹è¼¸å…¥ä¿¡ç®±èˆ‡å¯†ç¢¼",
      err_pwd_rule:"å¯†ç¢¼è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å¯«/å°å¯«/æ•¸å­—/ç‰¹æ®Šç¬¦è™Ÿ",
      err_no_account:"å¸³æˆ¶ä¸å­˜åœ¨ï¼Œè«‹å…ˆè¨»å†Š",
      err_wrong_pwd:"å¯†ç¢¼éŒ¯èª¤",
      err_expired:"æœƒå“¡å·²éæœŸï¼Œè«‹çºŒè²»",
      err_login_fail:"ç™»å…¥å¤±æ•—ï¼š",
      err_register_fail:"è¨»å†Šå¤±æ•—ï¼š",
      err_reset_fail:"é‡è¨­å¤±æ•—ï¼š",
      prompt_email:"è«‹è¼¸å…¥è¨»å†Šä¿¡ç®±ï¼š",
      err_email_empty:"ä¿¡ç®±ä¸èƒ½ç‚ºç©º",
      prompt_newpwd:"è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«ã€æ•¸å­—ã€ç¬¦è™Ÿï¼‰ï¼š",
      err_pwd_empty:"å¯†ç¢¼ä¸èƒ½ç‚ºç©º",
      msg_reset_ok:"å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚",

      chat_title:"å¿ƒæ†ç®¡å®¶ Â· GPT",
      chat_fab:"å•",
      chat_input_ph:"è¼¸å…¥å•é¡Œâ€¦",
      chat_send:"ç™¼é€",
      chat_welcome:"ä½ å¥½ï¼Œæˆ‘æ˜¯å¿ƒæ†ç®¡å®¶ã€‚ä½ å¯ä»¥å•ï¼šå¦‚ä½•é–‹å§‹å…è²»é«”é©—ï¼ŸVIPåŒ…å«ä»€éº¼ï¼Ÿå¦‚ä½•ç™»å…¥ï¼Ÿ",
      chat_busy:"æŠ±æ­‰ï¼Œæœå‹™ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
      chat_net_err:"ç¶²è·¯ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"
    },

    'en': {
      page_title:"Soul Sanctuary Â· Index",
      site_title:"Soul Sanctuary",
      lang_label:"Language",

      free_title:"ğŸŒ€ Free Segment",
      link_bazi:"BaZi Reading",
      link_natal:"Natal Chart",
      link_life:"Numerology",
      link_tarot:"Tarot Guidance",
      link_kyuusei:"Nine Star Ki",
      link_energy:"Energy Type",
      link_vedic:"Vedic Astrology",

      vip_title:"ğŸŒ™ VIP Segment",
      vip_mingli:"ğŸ— BaZi Members Area",
      vip_love:"Love & Relationship: romance, marriage trends",
      vip_career:"Career: work growth, entrepreneurship potential",
      vip_wealth:"Wealth: money timing & wealth spots",
      vip_pet:"Pet Reading: personality & bond",
      vip_hepan:"Compatibility: wedding date & birth timing",
      vip_name:"Naming: company name, baby name",
      vip_fengshui:"Wealth Layout: home/office flow matching",

      vip_xinlian:"ğŸŒ™ Soul Sanctuary Members Area",
      vip_record:"Spiritual logs: photos, dreams, voice, wishes",
      vip_course:"Courses: BaZi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family memorial system",
      vip_tasks:"Weekly energy practice / rituals",
      vip_shop:"Members-only discounts & custom charms",

      login_title:"ğŸ’ VIP Login",
      ph_email:"Email",
      ph_password:"Password (8+ chars with upper/lower/number/symbol)",
      btn_login:"Log in",
      btn_register:"Register",
      btn_reset:"ğŸ”‘ Reset Password",
      btn_upgrade:"ğŸ’ Upgrade to VIP (Monthly)",
      btn_backshop:"â† Back to Shop",
      note_price:"Register to get 1 free trial",
      note_price1:"$9.9/month VIP (BaZi + Soul Sanctuary + Courses)",

      btn_show_fields:"Show login inputs",
      btn_hide_fields:"Hide login inputs",

      err_need_ep:"Please enter email and password",
      err_pwd_rule:"Password must be 8+ chars with upper/lower/number/symbol",
      err_no_account:"Account not found. Please register first.",
      err_wrong_pwd:"Wrong password",
      err_expired:"Membership expired. Please renew.",
      err_login_fail:"Login failed:",
      err_register_fail:"Registration failed:",
      err_reset_fail:"Reset failed:",
      prompt_email:"Enter your registered email:",
      err_email_empty:"Email cannot be empty",
      prompt_newpwd:"Enter a new password (8+ chars with upper/lower/number/symbol):",
      err_pwd_empty:"Password cannot be empty",
      msg_reset_ok:"Password updated. Please log in again with your new password.",

      chat_title:"Concierge Â· GPT",
      chat_fab:"Chat",
      chat_input_ph:"Type a questionâ€¦",
      chat_send:"Send",
      chat_welcome:"Hi, Iâ€™m the concierge. Ask me: how to start free trials, what VIP includes, or how to log in.",
      chat_busy:"Sorry, the service is busy. Please try again later.",
      chat_net_err:"Network error. Please try again."
    },

    'ja': {
      page_title:"ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª Â· Index",
      site_title:"ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª",
      lang_label:"è¨€èª",

      free_title:"ğŸŒ€ ç„¡æ–™ä½“é¨“ã‚¨ãƒªã‚¢",
      link_bazi:"BaZiï¼ˆå…«å­—ï¼‰",
      link_natal:"ãƒã‚¤ã‚¿ãƒ«ãƒãƒ£ãƒ¼ãƒˆ",
      link_life:"æ•°ç§˜",
      link_tarot:"ã‚¿ãƒ­ãƒƒãƒˆ",
      link_kyuusei:"ä¹æ˜Ÿæ°—å­¦",
      link_energy:"ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¿ã‚¤ãƒ—",
      link_vedic:"ãƒ´ã‚§ãƒ¼ãƒ€å æ˜Ÿè¡“",

      vip_title:"ğŸŒ™ VIP ã‚¨ãƒªã‚¢",
      vip_mingli:"ğŸ— å‘½ç†ãƒ¡ãƒ³ãƒãƒ¼å†…å®¹",
      vip_love:"æ‹æ„›ãƒ»çµå©šã®æµã‚Œ",
      vip_career:"ä»•äº‹ãƒ»èµ·æ¥­ã®å¯èƒ½æ€§",
      vip_wealth:"é‡‘é‹ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°",
      vip_pet:"ãƒšãƒƒãƒˆé‘‘å®š",
      vip_hepan:"ç›¸æ€§ãƒ»æ‹©æ—¥/æ‹©æ—¶",
      vip_name:"å‘½åï¼ˆä¼šç¤¾/èµ¤ã¡ã‚ƒã‚“ï¼‰",
      vip_fengshui:"ä½å±…/ã‚ªãƒ•ã‚£ã‚¹å‹•ç·šã®èª¿æ•´",

      vip_xinlian:"ğŸŒ™ Soul Sanctuary ãƒ¡ãƒ³ãƒãƒ¼å†…å®¹",
      vip_record:"è¨˜éŒ²ï¼šå†™çœŸ/å¤¢/éŸ³å£°/ç¥ˆã‚Š",
      vip_course:"è¬›åº§ï¼šå…«å­—/ã‚¿ãƒ­ãƒƒãƒˆ/å æ˜Ÿ/æ•°ç§˜/äººé¡å›³",
      vip_memorial:"å®¶æ—ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«",
      vip_tasks:"é€±ã®ç·´ç¿’/å„€å¼",
      vip_shop:"ä¼šå“¡å‰²å¼• & å¾¡å®ˆ",

      login_title:"ğŸ’ VIP ãƒ­ã‚°ã‚¤ãƒ³",
      ph_email:"ãƒ¡ãƒ¼ãƒ«",
      ph_password:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼šå¤§/å°/æ•°å­—/è¨˜å·ï¼‰",
      btn_login:"ãƒ­ã‚°ã‚¤ãƒ³",
      btn_register:"æ–°è¦ç™»éŒ²",
      btn_reset:"ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š",
      btn_upgrade:"ğŸ’ VIPï¼ˆæœˆé¡ï¼‰ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰",
      btn_backshop:"â† ã‚·ãƒ§ãƒƒãƒ—ã¸æˆ»ã‚‹",
      note_price:"ç™»éŒ²ã§ç„¡æ–™ä½“é¨“ï¼ˆ1å›ï¼‰",
      note_price1:"$9.9 / æœˆ VIPï¼ˆå‘½ç† + Soul Sanctuary + ã‚³ãƒ¼ã‚¹ï¼‰",

      btn_show_fields:"å…¥åŠ›æ¬„ã‚’è¡¨ç¤º",
      btn_hide_fields:"å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º",

      err_need_ep:"ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      err_pwd_rule:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šï¼ˆå¤§/å°/æ•°å­—/è¨˜å·ï¼‰",
      err_no_account:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚",
      err_wrong_pwd:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",
      err_expired:"ä¼šå“¡æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚",
      err_login_fail:"ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š",
      err_register_fail:"ç™»éŒ²å¤±æ•—ï¼š",
      err_reset_fail:"å†è¨­å®šå¤±æ•—ï¼š",
      prompt_email:"ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ï¼š",
      err_email_empty:"ãƒ¡ãƒ¼ãƒ«ã¯å¿…é ˆã§ã™",
      prompt_newpwd:"æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8+ï¼šå¤§/å°/æ•°å­—/è¨˜å·ï¼‰ï¼š",
      err_pwd_empty:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™",
      msg_reset_ok:"æ›´æ–°ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",

      chat_title:"å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPT",
      chat_fab:"å•",
      chat_input_ph:"è³ªå•ã‚’å…¥åŠ›â€¦",
      chat_send:"é€ä¿¡",
      chat_welcome:"ã“ã‚“ã«ã¡ã¯ã€‚ç„¡æ–™ä½“é¨“ã®å§‹ã‚æ–¹ã€VIPå†…å®¹ã€ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ãªã©ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚",
      chat_busy:"æ··é›‘ã—ã¦ã„ã¾ã™ã€‚å°‘ã—å¾…ã£ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
      chat_net_err:"ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
    },

    'th': {
      page_title:"Soul Sanctuary Â· à¸«à¸™à¹‰à¸²à¹à¸£à¸",
      site_title:"Soul Sanctuary",
      lang_label:"à¸ à¸²à¸©à¸²",

      free_title:"ğŸŒ€ à¹‚à¸‹à¸™à¸Ÿà¸£à¸µ",
      link_bazi:"BaZi (à¸”à¸§à¸‡à¸ˆà¸µà¸™)",
      link_natal:"à¸”à¸§à¸‡à¸à¸³à¹€à¸™à¸´à¸”",
      link_life:"à¹€à¸¥à¸‚à¸¨à¸²à¸ªà¸•à¸£à¹Œ",
      link_tarot:"à¹„à¸à¹ˆà¸—à¸²à¹‚à¸£à¸•à¹Œ",
      link_kyuusei:"Nine Star Ki",
      link_energy:"à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸¥à¸±à¸‡à¸‡à¸²à¸™",
      link_vedic:"à¹‚à¸«à¸£à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸§à¸—",

      vip_title:"ğŸŒ™ à¹‚à¸‹à¸™ VIP",
      vip_mingli:"ğŸ— à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ BaZi VIP",
      vip_love:"à¸„à¸§à¸²à¸¡à¸£à¸±à¸/à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œ",
      vip_career:"à¸à¸²à¸£à¸‡à¸²à¸™/à¸˜à¸¸à¸£à¸à¸´à¸ˆ",
      vip_wealth:"à¸à¸²à¸£à¹€à¸‡à¸´à¸™/à¸ˆà¸±à¸‡à¸«à¸§à¸°à¹€à¸‡à¸´à¸™",
      vip_pet:"à¸”à¸§à¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡",
      vip_hepan:"à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸à¸±à¸™à¹„à¸”à¹‰",
      vip_name:"à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­",
      vip_fengshui:"à¸œà¸±à¸‡à¸šà¹‰à¸²à¸™/à¸­à¸­à¸Ÿà¸Ÿà¸´à¸¨",

      vip_xinlian:"ğŸŒ™ Soul Sanctuary VIP",
      vip_record:"à¸šà¸±à¸™à¸—à¸¶à¸: à¸£à¸¹à¸›/à¸à¸±à¸™/à¹€à¸ªà¸µà¸¢à¸‡/à¸„à¸³à¸­à¸˜à¸´à¸©à¸à¸²à¸™",
      vip_course:"à¸„à¸­à¸£à¹Œà¸ª: BaZi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"à¸£à¸°à¸šà¸šà¸£à¸³à¸¥à¸¶à¸à¸„à¸£à¸­à¸šà¸„à¸£à¸±à¸§",
      vip_tasks:"à¹à¸šà¸šà¸à¸¶à¸à¸«à¸±à¸”à¸›à¸£à¸°à¸ˆà¸³à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ",
      vip_shop:"à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¸ªà¸¡à¸²à¸Šà¸´à¸ & à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸‡",

      login_title:"ğŸ’ à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š VIP",
      ph_email:"à¸­à¸µà¹€à¸¡à¸¥",
      ph_password:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (8+ à¸•à¸±à¸§ à¸¡à¸µ A/a/0-9/à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ)",
      btn_login:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
      btn_register:"à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸",
      btn_reset:"ğŸ”‘ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™",
      btn_upgrade:"ğŸ’ à¸­à¸±à¸›à¹€à¸à¸£à¸” VIP (à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™)",
      btn_backshop:"â† à¸à¸¥à¸±à¸šà¸£à¹‰à¸²à¸™à¸„à¹‰à¸²",
      note_price:"à¸ªà¸¡à¸±à¸„à¸£à¹€à¸à¸·à¹ˆà¸­à¸£à¸±à¸šà¸—à¸”à¸¥à¸­à¸‡à¸Ÿà¸£à¸µ 1 à¸„à¸£à¸±à¹‰à¸‡",
      note_price1:"$9.9/à¹€à¸”à¸·à¸­à¸™ VIP (BaZi + Soul Sanctuary + à¸„à¸­à¸£à¹Œà¸ª)",

      btn_show_fields:"à¹à¸ªà¸”à¸‡à¸Šà¹ˆà¸­à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
      btn_hide_fields:"à¸‹à¹ˆà¸­à¸™à¸Šà¹ˆà¸­à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",

      err_need_ep:"à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™",
      err_pwd_rule:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸•à¹‰à¸­à¸‡ 8+ à¸•à¸±à¸§ à¸¡à¸µ A/a/0-9/à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ",
      err_no_account:"à¹„à¸¡à¹ˆà¸à¸šà¸šà¸±à¸à¸Šà¸µ à¸à¸£à¸¸à¸“à¸²à¸ªà¸¡à¸±à¸„à¸£à¸à¹ˆà¸­à¸™",
      err_wrong_pwd:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡",
      err_expired:"à¸ªà¸¡à¸²à¸Šà¸´à¸à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ à¸à¸£à¸¸à¸“à¸²à¸•à¹ˆà¸­à¸­à¸²à¸¢à¸¸",
      err_login_fail:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:",
      err_register_fail:"à¸ªà¸¡à¸±à¸„à¸£à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:",
      err_reset_fail:"à¸£à¸µà¹€à¸‹à¹‡à¸•à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:",
      prompt_email:"à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¸—à¸µà¹ˆà¸ªà¸¡à¸±à¸„à¸£à¹„à¸§à¹‰:",
      err_email_empty:"à¸­à¸µà¹€à¸¡à¸¥à¸«à¹‰à¸²à¸¡à¸§à¹ˆà¸²à¸‡",
      prompt_newpwd:"à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹ƒà¸«à¸¡à¹ˆ (8+ à¸¡à¸µ A/a/0-9/à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ):",
      err_pwd_empty:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸«à¹‰à¸²à¸¡à¸§à¹ˆà¸²à¸‡",
      msg_reset_ok:"à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹à¸¥à¹‰à¸§ à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹ƒà¸«à¸¡à¹ˆ",

      chat_title:"à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ Â· GPT",
      chat_fab:"à¸–à¸²à¸¡",
      chat_input_ph:"à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸–à¸²à¸¡â€¦",
      chat_send:"à¸ªà¹ˆà¸‡",
      chat_welcome:"à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°/à¸„à¸£à¸±à¸š à¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢: à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸”à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰à¸Ÿà¸£à¸µà¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£? VIP à¸¡à¸µà¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡? à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£?",
      chat_busy:"à¸£à¸°à¸šà¸šà¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸‡ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡",
      chat_net_err:"à¹€à¸„à¸£à¸·à¸­à¸‚à¹ˆà¸²à¸¢à¸¡à¸µà¸›à¸±à¸à¸«à¸² à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ"
    },

    'ms': {
      page_title:"Soul Sanctuary Â· Indeks",
      site_title:"Soul Sanctuary",
      lang_label:"Bahasa",

      free_title:"ğŸŒ€ Segmen Percuma",
      link_bazi:"BaZi",
      link_natal:"Carta Natal",
      link_life:"Numerologi",
      link_tarot:"Tarot",
      link_kyuusei:"Nine Star Ki",
      link_energy:"Jenis Tenaga",
      link_vedic:"Astrologi Veda",

      vip_title:"ğŸŒ™ Segmen VIP",
      vip_mingli:"ğŸ— Ruang BaZi VIP",
      vip_love:"Cinta & hubungan",
      vip_career:"Kerjaya & bisnes",
      vip_wealth:"Kewangan & masa",
      vip_pet:"Bacaan haiwan peliharaan",
      vip_hepan:"Keserasian",
      vip_name:"Penamaan",
      vip_fengshui:"Susun atur rumah/pejabat",

      vip_xinlian:"ğŸŒ™ Soul Sanctuary VIP",
      vip_record:"Rekod: foto/mimpi/audio/doa",
      vip_course:"Kursus: BaZi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Sistem memorial keluarga",
      vip_tasks:"Latihan mingguan",
      vip_shop:"Diskaun ahli & azimat",

      login_title:"ğŸ’ Log masuk VIP",
      ph_email:"Email",
      ph_password:"Kata laluan (8+ aksara, ada A/a/nombor/simbol)",
      btn_login:"Log masuk",
      btn_register:"Daftar",
      btn_reset:"ğŸ”‘ Tetap semula kata laluan",
      btn_upgrade:"ğŸ’ Naik taraf VIP (Bulanan)",
      btn_backshop:"â† Kembali ke kedai",
      note_price:"Daftar untuk 1 percubaan percuma",
      note_price1:"$9.9/bulan VIP (BaZi + Soul Sanctuary + Kursus)",

      btn_show_fields:"Tunjukkan input log masuk",
      btn_hide_fields:"Sembunyikan input log masuk",

      err_need_ep:"Sila masukkan email dan kata laluan",
      err_pwd_rule:"Kata laluan mesti 8+ (A/a/nombor/simbol)",
      err_no_account:"Akaun tiada. Sila daftar dahulu.",
      err_wrong_pwd:"Kata laluan salah",
      err_expired:"Keahlian tamat. Sila perbaharui.",
      err_login_fail:"Log masuk gagal:",
      err_register_fail:"Pendaftaran gagal:",
      err_reset_fail:"Reset gagal:",
      prompt_email:"Masukkan email berdaftar:",
      err_email_empty:"Email tidak boleh kosong",
      prompt_newpwd:"Masukkan kata laluan baru (8+ A/a/nombor/simbol):",
      err_pwd_empty:"Kata laluan tidak boleh kosong",
      msg_reset_ok:"Kata laluan dikemas kini. Sila log masuk semula.",

      chat_title:"Pembantu Â· GPT",
      chat_fab:"Tanya",
      chat_input_ph:"Taip soalanâ€¦",
      chat_send:"Hantar",
      chat_welcome:"Hai! Tanya: cara mula percubaan percuma, apa kandungan VIP, atau cara log masuk.",
      chat_busy:"Perkhidmatan sibuk. Cuba lagi nanti.",
      chat_net_err:"Ralat rangkaian. Sila cuba lagi."
    }
  };

  function t(key){
    const lang = getLang();
    const pack = translations[lang] || translations['zh-CN'];
    return pack[key] ?? translations['zh-CN'][key] ?? key;
  }

  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string') el.textContent = val;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(el => {
      const key = el.getAttribute('data-i18n-ph');
      const val = t(key);
      if (typeof val === 'string') el.setAttribute('placeholder', val);
    });

    // <title data-i18n="page_title">
    const titleEl = document.querySelector('title[data-i18n]');
    if (titleEl){
      const key = titleEl.getAttribute('data-i18n');
      titleEl.textContent = t(key);
    }
  }

  function wireLangSelect(){
    const sel = $('langSelect');
    if (!sel) return;

    // keep user choice
    const cur = getLang();
    sel.value = cur;

    sel.addEventListener('change', () => {
      setLang(sel.value);
      applyI18n();
      // chat title/fab/input placeholders are already data-i18n/data-i18n-ph, so applyI18n is enough.
    });
  }

  /* ===================== AUTH FIELDS PRIVACY (HIDE BY DEFAULT) ===================== */
  function initAuthFieldPrivacy(){
    const fields = $('authFields');
    if (!fields) return;

    // hide fields by default
    fields.style.display = 'none';

    // insert toggle button (UI only; no password echo/log)
    const panelBody = fields.closest('.body');
    if (!panelBody) return;

    let toggle = $('authToggleBtn');
    if (!toggle){
      toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.id = 'authToggleBtn';
      toggle.className = 'btn ghost block';
      toggle.textContent = t('btn_show_fields');
      panelBody.insertBefore(toggle, fields);
      // spacer
      const spacer = document.createElement('div');
      spacer.className = 'spacer';
      panelBody.insertBefore(spacer, fields);
    }

    function setVisible(v){
      fields.style.display = v ? 'grid' : 'none';
      toggle.textContent = v ? t('btn_hide_fields') : t('btn_show_fields');
    }

    toggle.addEventListener('click', () => {
      const isHidden = fields.style.display === 'none';
      setVisible(isHidden);
      if (isHidden){
        // focus email when showing
        setTimeout(() => $('email')?.focus(), 50);
      }
    });

    // if user clicks login/register while hidden -> reveal instead of submitting
    const loginBtn = $('loginBtn');
    const registerBtn = $('registerBtn');

    function ensureVisibleOrWarn(){
      if (fields.style.display === 'none'){
        setVisible(true);
        showErr(t('err_need_ep'));
        return false;
      }
      return true;
    }

    // Intercept form submits if hidden
    const loginForm = $('loginForm');
    const regForm = $('registerForm');

    if (loginForm){
      loginForm.addEventListener('submit', (e) => {
        if (!ensureVisibleOrWarn()){
          e.preventDefault();
          return;
        }
      }, true);
    }

    if (regForm){
      regForm.addEventListener('submit', (e) => {
        if (!ensureVisibleOrWarn()){
          e.preventDefault();
          return;
        }
      }, true);
    }

    // Also allow click buttons
    if (loginBtn){
      loginBtn.addEventListener('click', () => { ensureVisibleOrWarn(); }, true);
    }
    if (registerBtn){
      registerBtn.addEventListener('click', () => { ensureVisibleOrWarn(); }, true);
    }
  }

  /* ===================== LOGIN / REGISTER / RESET ===================== */
  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || '').toString().toLowerCase();

    // expired compatibility
    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt){
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired){
      const go = confirm(t('err_expired') + 'ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ');
      if (go) window.open('https://yourshopifyshop.com/products/monthly-vip', '_blank');
      return;
    }

    if (res.ok === true){
      localStorage.setItem('vipEmail', res.email || email);
      location.href = 'https://astro.5xliving.com/vip_soul_sanctuary.html';
      return;
    }

    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));

    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  function wireAuthForms(){
    const registerForm = $('registerForm');
    const loginForm = $('loginForm');
    const resetBtn = $('resetBtn');

    if (registerForm){
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideErr();

        const email = ($('email')?.value || '').trim();
        const password = ($('password')?.value || '').trim();

        if (!email || !password) return showErr(t('err_need_ep'));
        if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

        lock($('registerBtn'), true);
        try{
          const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, password })
          }));

          if (res.ok === true){
            localStorage.setItem('vipEmail', email);
            location.href = 'vip_trial.html';
            return;
          }

          if ((res.msg || '').toString() === 'exists'){
            // if already exists, try login directly
            await loginFlow(email, password);
            return;
          }

          return showErr(t('err_register_fail') + (res.msg ? ` ${res.msg}` : ''));
        } catch(err){
          return showErr(t('err_register_fail') + (err?.message || ''));
        } finally {
          lock($('registerBtn'), false);
        }
      });
    }

    if (loginForm){
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideErr();

        const email = ($('email')?.value || '').trim();
        const password = ($('password')?.value || '').trim();

        if (!email || !password) return showErr(t('err_need_ep'));

        lock($('loginBtn'), true);
        try{
          await loginFlow(email, password);
        } catch(err){
          showErr(t('err_login_fail') + (err?.message || ''));
        } finally {
          lock($('loginBtn'), false);
        }
      });
    }

    if (resetBtn){
      resetBtn.addEventListener('click', async () => {
        hideErr();

        let email = prompt(t('prompt_email'));
        if (email === null) return;
        email = email.trim();
        if (!email) return showErr(t('err_email_empty'));

        let newPassword = prompt(t('prompt_newpwd'));
        if (newPassword === null) return;
        newPassword = newPassword.trim();
        if (!newPassword) return showErr(t('err_pwd_empty'));
        if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

        lock(resetBtn, true);
        try{
          const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, newPassword })
          }));

          if (!res.ok){
            return showErr(t('err_reset_fail') + (res.msg ? ` ${res.msg}` : ''));
          }
          alert(t('msg_reset_ok'));
        } catch(err){
          showErr(t('err_reset_fail') + (err?.message || ''));
        } finally {
          lock(resetBtn, false);
        }
      });
    }
  }

  /* ===================== STATIC CHAT (USE YOUR NEW HTML) ===================== */
  function initStaticChatWidget(){
    const fab   = $('ssChatFab');
    const panel = $('chatPanel');
    const close = $('chatClose');
    const body  = $('chatBody');
    const input = $('chatInput');
    const send  = $('chatSend');

    if (!fab || !panel || !close || !body || !input || !send) return;

    // ensure initial state
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');

    const openPanel = () => {
      panel.style.display = 'block';
      panel.setAttribute('aria-hidden','false');
      setTimeout(() => input.focus(), 50);
    };
    const closePanel = () => {
      panel.style.display = 'none';
      panel.setAttribute('aria-hidden','true');
    };
    const togglePanel = () => {
      const hidden = panel.getAttribute('aria-hidden') !== 'false';
      hidden ? openPanel() : closePanel();
    };

    fab.addEventListener('click', togglePanel);
    close.addEventListener('click', closePanel);

    // chat history
    const chatHistory = [];

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
      return div;
    }

    function buildSystemPrompt(){
      const lang = getLang();
      const promptByLang = {
        'zh-CN': 'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ã€‚è¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚ä¸è¦è¾“å‡ºä»£ç ã€‚',
        'zh-TW': 'ä½ æ˜¯ã€Œå¿ƒæ†ç®¡å®¶ã€ï¼Œå”åŠ©è¨ªå®¢äº†è§£å‘½ç†å¿ƒæ†ç©ºé–“çš„åŠŸèƒ½ã€å°è¦½èˆ‡æœƒå“¡èªªæ˜ã€‚èªæ°£æº«æš–å°ˆæ¥­ã€ç°¡æ½”æœ‰æ¢ç†ã€‚ä¸è¦è¼¸å‡ºç¨‹å¼ç¢¼ã€‚',
        'en':    'You are the Soul Sanctuary Concierge. Help visitors navigate features and membership clearly, warmly, and concisely. Do not output code.',
        'ja':    'ã‚ãªãŸã¯ã€Œå¿ƒæ€œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã€ã§ã™ã€‚æ©Ÿèƒ½æ¡ˆå†…ã¨ä¼šå“¡èª¬æ˜ã‚’ã€ä¸å¯§ã§åˆ†ã‹ã‚Šã‚„ã™ãçŸ­ãã¾ã¨ã‚ã¦æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã¯å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚',
        'th':    'à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ Soul Sanctuary à¹à¸™à¸°à¸™à¸³à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œà¹à¸¥à¸°à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ à¸²à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¸ªà¸¸à¸ à¸²à¸ à¸à¸£à¸°à¸Šà¸±à¸š à¹à¸¥à¸°à¸«à¹‰à¸²à¸¡à¹à¸ªà¸”à¸‡à¹‚à¸„à¹‰à¸”',
        'ms':    'Anda ialah Concierge Soul Sanctuary. Terangkan fungsi & keahlian dengan jelas, mesra, ringkas. Jangan keluarkan kod.'
      };
      return promptByLang[lang] || promptByLang['zh-CN'];
    }

    function extractReply(json){
      if (!json) return '';
      return (
        json.reply ||
        json.answer ||
        json.content ||
        json.message ||
        json.text ||
        (json.data && (json.data.reply || json.data.content || json.data.text)) ||
        (json.choices && json.choices[0] && json.choices[0].message && json.choices[0].message.content) ||
        ''
      );
    }

    async function callChatAPI(userText){
      const lang = getLang();

      if (!chatHistory.length){
        chatHistory.push({ role:'system', content: buildSystemPrompt() });
      }
      chatHistory.push({ role:'user', content: userText });

      const res = await fetch(`${API_BASE}/api/chat`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          lang,
          context: {
            page: 'index',
            vipEmail: localStorage.getItem('vipEmail') || ''
          },
          messages: chatHistory
        })
      });

      const json = await res.json().catch(() => null);
      const reply = extractReply(json);

      if (reply) chatHistory.push({ role:'assistant', content: reply });
      return reply || t('chat_busy');
    }

    // welcome once
    if (!initStaticChatWidget._welcomed){
      initStaticChatWidget._welcomed = true;
      addMsg(t('chat_welcome'), false);
    }

    async function sendMsg(){
      const text = (input.value || '').trim();
      if (!text) return;
      input.value = '';

      addMsg(text, true);
      const typing = addMsg('â€¦', false);

      try{
        const reply = await callChatAPI(text);
        typing.textContent = reply;
      }catch(e){
        typing.textContent = t('chat_net_err');
      }
    }

    send.addEventListener('click', sendMsg);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMsg();
    });
  }

  /* ===================== ENTER-TO-LOGIN (WHEN FIELDS VISIBLE) ===================== */
  function wireEnterToLogin(){
    const fields = $('authFields');
    const loginBtn = $('loginBtn');
    if (!fields || !loginBtn) return;

    fields.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        // if fields are hidden, do nothing; privacy toggle will reveal
        if (fields.style.display === 'none') return;
        e.preventDefault();
        loginBtn.click();
      }
    });
  }

  /* ===================== BOOT ===================== */
  document.addEventListener('DOMContentLoaded', () => {
    // set dropdown to current stored lang
    const sel = $('langSelect');
    const cur = getLang();
    if (sel) sel.value = cur;
    document.documentElement.lang = cur;

    applyI18n();
    wireLangSelect();

    initAuthFieldPrivacy();  // default hide email/password
    wireAuthForms();
    wireEnterToLogin();

    // IMPORTANT: use your static chat DOM (no dynamic create)
    initStaticChatWidget();
  });

})();
</script>
</body>
</html>
