<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>本命星盘 · Natal Chart | 5XLiving</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* —— 统一头部 —— */
    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:calc(100% - 12px) 50%}
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* —— 页面结构 —— */
    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }
  </style>
</head>
<body>
  <!-- 统一头部 -->
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="#" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="page_title">本命星盘解析</span></span>
      </a>

      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">本命星盘解析</h1>

    <!-- 表单区域 -->
    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="name" data-i18n="label_name">姓名（可选）</label>
          <input id="name" type="text" data-i18n-ph="ph_name" placeholder="你的称呼（用于个性化）" />
        </div>
        <div>
          <label class="muted" for="gender" data-i18n="gender_label">性别</label>
          <select id="gender">
            <option value="u" data-i18n="opt_gender_confidential">不透露</option>
            <option value="m" data-i18n="opt_gender_male">男性</option>
            <option value="f" data-i18n="opt_gender_female">女性</option>
          </select>
        </div>
        <div>
          <label class="muted" for="place" data-i18n="label_place">出生地点</label>
          <input id="place" type="text" data-i18n-ph="ph_place" placeholder="城市或坐标，如：Taipei / 25.03,121.56" />
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" for="birthdate" data-i18n="label_birthdate">出生日期</label>
          <input id="birthdate" type="date" />
        </div>
        <div>
          <label class="muted" for="birthtime" data-i18n="label_birthtime">出生时间</label>
          <input id="birthtime" type="time" value="12:00" step="60" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button id="genBtn" class="btn" type="button" data-i18n="btn_generate">生成星盘</button>
        </div>
      </div>
    </section>

    <!-- 结果区域 -->
    <section id="result" class="card" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="chart_title">你的本命报告</h2>
      <div id="chartSummary" class="muted"></div>
      <div id="chartReport" class="report"></div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

<script>
(function(){
  'use strict';

  /* ============== 基础常量/工具 ============== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  const LANG_KEY = 'site_lang';
  const qs  = (s,root=document)=>root.querySelector(s);
  const gid = (id)=>document.getElementById(id);

  /* ============== i18n 文案（新增了 butler_title / chip / 错误等） ============== */
  const I18N = {
    'zh-CN': {
      lang_label:'语言',
      btn_login:'登录账户', btn_register:'注册账户', btn_reset:'🔑 重设密码',
      page_title:'本命星盘｜Natal Chart',
      page_sub:'请输入出生资料，我们将为你绘制专属的本命星盘（演示版）。',
      label_name:'姓名（可选）', ph_name:'你的称呼（用于个性化）',
      gender_label:'性别', opt_gender_confidential:'不透露', opt_gender_male:'男性', opt_gender_female:'女性',
      label_place:'出生地点', ph_place:'城市或坐标，例如：Beijing／39.90, 116.40',
      label_birthdate:'出生日期', label_birthtime:'出生时间',
      btn_generate:'生成星盘', btn_demo:'示例', note_privacy:'说明：仅为本地示范，不会上传任何个人数据。',
      chart_title:'你的本命星盘', chart_placeholder:'（此处可接后端绘图或前端 Canvas，当前为占位）',
      panel_login_head:'账户登录／注册', ph_email:'邮箱 Email',
      ph_password:'密码 Password（至少 8 位，需包含大小写字母、数字与符号）', ph_label_password:'密码 Password',
      chat_fab:'问', chat_placeholder:'想了解什么？（如：功能、会员说明）', chat_send:'发送',
      err_need_ep:'请输入邮箱与密码', err_pwd_rule:'密码至少 8 位，需包含大写/小写/数字/符号',
      err_email_empty:'邮箱不能为空', err_pwd_empty:'密码不能为空', err_login_fail:'登录失败：',
      err_register_fail:'注册失败：', err_reset_fail:'重设失败：', err_no_account:'账户不存在，请先注册',
      err_wrong_pwd:'密码错误', err_expired:'会员已到期，请续费', msg_reset_ok:'已更新密码，请用新密码登录。',
      chat_greeting:'你好，我是心怜管家，需要我怎么协助你？',
      /* 新增 */
      butler_title:'心怜管家 · 智能解读',
      butler_chat_title:'心怜管家 · Chat',
      chip_career:'事业解读', chip_love:'感情关系', chip_money:'财务建议', chip_list:'本周执行清单', chip_30d:'30天计划',
      q_career:'继续解读事业与团队协作', q_love:'说说感情与长期关系', q_money:'给我财务习惯、盲区与改善建议', q_list:'给我一份本周可执行清单', q_30d:'为我定一个30天成长计划',
      vip_tip:'🔒 VIP 解锁后可查看完整解读',
      vip_sub:'包含「事业/财富/执行清单/温柔提醒」全部章节与持续追问',
      btn_unlock:'立即解锁',
      err_network:'网络异常', err_busy:'服务暂时繁忙，请稍后重试。',
      alert_fill:'请补全“日期/地点”。（时间留空将默认为 12:00）'
    "vip_title": "🌙 会员区域 VIP Segment",
    "vip_mingli": "🗝 命理空间专属内容",
    "vip_love": "姻缘方向：恋爱缘分、婚姻走势",
    "vip_career": "事业方向：职场发展、创业潜力",
    "vip_wealth": "财运方向：财位分析、理财时机",
    "vip_pet": "宠物命理：伴侣动物的性格与缘分",
    "vip_hepan": "合盘分析：婚期择日、新生择时",
    "vip_name": "测名分析：公司名、宝宝名、命名改运",
    "vip_fengshui": "财位合盘：住家 / 办公室动线配合",
    "vip_xinlian": "🌙 心怜空间专属内容",
    "vip_record": "灵性记录：照片、梦境、声音、愿望祈祷",
    "vip_course": "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    "vip_memorial": "家族纪念系统：亲人灵性纪念 & 延续",
    "vip_tasks": "每周能量练习 / 神明仪式任务",
    "vip_shop": "能量商城专属折扣 & 御守订制",
    "login_title": "💎 登入 VIP 功能",
    "panel_login_head": "账户登录 / 注册",
    "ph_email": "邮箱 Email",
    "ph_label_password": "密码 Password",
    "ph_password": "密码 Password（至少8位，含大小写数字符号）",
    "btn_login": "登入账户",
    "btn_reset": "🔑 重设密码",
    "btn_register": "注册账户",
    "note_price": "注册账号赠送一次免费体验",
    "panel_member_head": "会员服务",
    "btn_upgrade": "💎 升级为 VIP（月费）",
    "btn_backshop": "← 返回命理商城",
    "note_price1": "$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）"
  },
    'zh-TW': {
      lang_label:'語言',
      btn_login:'登入帳號', btn_register:'註冊帳號', btn_reset:'🔑 重設密碼',
      page_title:'本命星盤｜Natal Chart',
      page_sub:'請輸入出生資料，我們將為你繪製專屬的本命星盤（示範版）。',
      label_name:'姓名（選填）', ph_name:'你的稱呼（用於個人化）',
      gender_label:'性別', opt_gender_confidential:'不透露', opt_gender_male:'男性', opt_gender_female:'女性',
      label_place:'出生地點', ph_place:'城市或座標，例如：Taipei／25.03, 121.56',
      label_birthdate:'出生日期', label_birthtime:'出生時間',
      btn_generate:'產生星盤', btn_demo:'範例', note_privacy:'提醒：僅為本機示範，不會上傳任何個資。',
      chart_title:'你的本命星盤', chart_placeholder:'（此區可串接後端繪圖或前端 Canvas，現為佔位）',
      panel_login_head:'帳號登入／註冊', ph_email:'電子郵件 Email',
      ph_password:'密碼 Password（至少 8 碼，需包含大小寫字母、數字與符號）', ph_label_password:'密碼 Password',
      chat_fab:'問', chat_placeholder:'想了解什麼？（例如：功能、會員說明）', chat_send:'傳送',
      err_need_ep:'請輸入電子郵件與密碼', err_pwd_rule:'密碼至少 8 碼，需包含大小寫字母、數字與符號',
      err_email_empty:'電子郵件不能為空', err_pwd_empty:'密碼不能為空', err_login_fail:'登入失敗：',
      err_register_fail:'註冊失敗：', err_reset_fail:'重設失敗：', err_no_account:'查無帳號，請先註冊',
      err_wrong_pwd:'密碼不正確', err_expired:'會員已到期，請續費', msg_reset_ok:'已更新密碼，請以新密碼登入。',
      chat_greeting:'嗨，我是心怜管家。有什麼需要我協助？',
      butler_title:'心怜管家 · 智能解讀',
      butler_chat_title:'心怜管家 · Chat',
      chip_career:'事業解讀', chip_love:'感情關係', chip_money:'財務建議', chip_list:'本週執行清單', chip_30d:'30天計畫',
      q_career:'繼續解讀事業與團隊協作', q_love:'說說感情與長期關係', q_money:'給我財務習慣、盲點與改善建議', q_list:'給我一份本週可執行清單', q_30d:'為我訂一個30天成長計畫',
      vip_tip:'🔒 升級 VIP 以查看完整解讀',
      vip_sub:'包含「事業／財富／執行清單／溫柔提醒」所有章節與持續追問',
      btn_unlock:'立即解鎖',
      err_network:'網路異常', err_busy:'服務繁忙，請稍後再試。',
      alert_fill:'請補齊「日期／地點」。(時間留空將預設為 12:00)'
      "zh-TW": {
    "vip_title": "🌙 會員區域 VIP Segment",
    "vip_mingli": "🗝 命理空間專屬內容",
    "vip_love": "姻緣方向：戀愛緣分、婚姻走勢",
    "vip_career": "事業方向：職場發展、創業潛力",
    "vip_wealth": "財運方向：財位分析、理財時機",
    "vip_pet": "寵物命理：伴侶動物的性格與緣分",
    "vip_hepan": "合盤分析：婚期擇日、新生擇時",
    "vip_name": "測名分析：公司名、寶寶名、命名改運",
    "vip_fengshui": "財位合盤：住家／辦公室動線配合",
    "vip_xinlian": "🌙 心憐空間專屬內容",
    "vip_record": "靈性記錄：照片、夢境、聲音、願望祈禱",
    "vip_course": "命理課程：八字／塔羅／占星／靈數／人類圖",
    "vip_memorial": "家族紀念系統：親人靈性紀念＆延續",
    "vip_tasks": "每週能量練習／神明儀式任務",
    "vip_shop": "能量商城專屬折扣＆御守訂製",
    "login_title": "💎 登入 VIP 功能",
    "panel_login_head": "帳號登入／註冊",
    "ph_email": "電子郵件 Email",
    "ph_label_password": "密碼 Password",
    "ph_password": "密碼 Password（至少 8 位，需包含大小寫字母、數字與符號）",
    "btn_login": "登入帳號",
    "btn_reset": "🔑 重設密碼",
    "btn_register": "註冊帳號",
    "note_price": "註冊帳號贈送一次免費體驗",
    "panel_member_head": "會員服務",
    "btn_upgrade": "💎 升級為 VIP（月費）",
    "btn_backshop": "← 返回命理商城",
    "note_price1": "$9.9／月 VIP（命理空間＋心憐空間＋靈性課程）"
  },
    'en': {
      lang_label:'Language',
      btn_login:'Log in', btn_register:'Create Account', btn_reset:'🔑 Reset Password',
      page_title:'Natal Chart',
      page_sub:'Enter your birth data to generate your personal natal chart (demo).',
      label_name:'Name (optional)', ph_name:'Your name (for personalization)',
      gender_label:'Gender', opt_gender_confidential:'Prefer not to say', opt_gender_male:'Male', opt_gender_female:'Female',
      label_place:'Place of Birth', ph_place:'City or coordinates, e.g., London / 51.50, -0.12',
      label_birthdate:'Birth Date', label_birthtime:'Birth Time',
      btn_generate:'Generate Chart', btn_demo:'Demo',
      note_privacy:'Note: local demo only — no personal data is uploaded.',
      chart_title:'Your Natal Chart', chart_placeholder:'(Hook up a backend renderer or draw via Canvas; placeholder for now)',
      panel_login_head:'Account Login / Sign-up', ph_email:'Email',
      ph_password:'Password (min 8 chars with upper/lowercase, number & symbol)', ph_label_password:'Password',
      chat_fab:'Chat', chat_placeholder:'What would you like to know? (e.g., features, membership)', chat_send:'Send',
      err_need_ep:'Enter email and password', err_pwd_rule:'Password must be 8+ and include upper/lowercase, number, and symbol',
      err_email_empty:'Email cannot be empty', err_pwd_empty:'Password cannot be empty',
      err_login_fail:'Login failed: ', err_register_fail:'Registration failed: ', err_reset_fail:'Reset failed: ',
      err_no_account:'Account not found. Please sign up first.', err_wrong_pwd:'Incorrect password',
      err_expired:'Membership expired. Please renew.', msg_reset_ok:'Password updated. Please log in with the new one.',
      chat_greeting:'Hi, I’m Xinlian Butler. How can I help?',
      butler_title:'Xinlian Butler · Insight',
      butler_chat_title:'Xinlian Butler · Chat',
      chip_career:'Career', chip_love:'Relationships', chip_money:'Money Advice', chip_list:'Weekly To-Dos', chip_30d:'30-Day Plan',
      q_career:'Continue with career and teamwork insights', q_love:'Talk about love and long-term relationships', q_money:'Give me money habits, blind spots and improvements', q_list:'Give me an actionable list for this week', q_30d:'Make me a 30-day growth plan',
      vip_tip:'🔒 Unlock VIP to read the full analysis',
      vip_sub:'Includes all sections: Career / Wealth / Action List / Gentle Reminder, plus follow-ups',
      btn_unlock:'Unlock now',
      err_network:'Network error', err_busy:'Service is busy. Please try again later.',
      alert_fill:'Please complete “date/place”. (Time defaults to 12:00 if empty)'
    "vip_title": "🌙 VIP Area",
    "vip_mingli": "🗝 Astrology Space — Exclusive Content",
    "vip_love": "Love & Marriage: romantic chemistry, marriage outlook",
    "vip_career": "Career: workplace growth, entrepreneurship potential",
    "vip_wealth": "Wealth: wealth placement analysis, right timing",
    "vip_pet": "Pet Astrology: companion animals’ personality & bonds",
    "vip_hepan": "Synastry: wedding date selection, birth timing",
    "vip_name": "Name Analysis: company names, baby names, luck-renaming",
    "vip_fengshui": "Wealth Feng Shui Match: home/office layout alignment",
    "vip_xinlian": "🌙 Xinlian Space — Exclusive Content",
    "vip_record": "Spiritual Records: photos, dreams, audio, wishes/prayers",
    "vip_course": "Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
    "vip_memorial": "Family Memorial: spiritual remembrance & legacy",
    "vip_tasks": "Weekly energy practices / deity rituals",
    "vip_shop": "Energy shop member discounts & custom amulets",
    "login_title": "💎 Sign in for VIP features",
    "panel_login_head": "Account Login / Sign Up",
    "ph_email": "Email",
    "ph_label_password": "Password",
    "ph_password": "Password (min 8 chars with upper/lowercase, number & symbol)",
    "btn_login": "Log in",
    "btn_reset": "🔑 Reset Password",
    "btn_register": "Create Account",
    "note_price": "Sign up to get one free trial",
    "panel_member_head": "Membership Services",
    "btn_upgrade": "💎 Upgrade to VIP (Monthly)",
    "btn_backshop": "← Back to Astrology Shop",
    "note_price1": "$9.9 / month VIP (Astrology Space + Xinlian Space + Spiritual Courses)"
  },
    'ja': {
      lang_label:'言語',
      btn_login:'ログイン', btn_register:'アカウント作成', btn_reset:'🔑 パスワードをリセット',
      page_title:'出生ホロスコープ｜Natal Chart',
      page_sub:'生年月日と出生地を入力すると、あなた専用の出生図を作成します（デモ）。',
      label_name:'名前（任意）', ph_name:'お名前（パーソナライズ用）',
      gender_label:'性別', opt_gender_confidential:'非公開', opt_gender_male:'男性', opt_gender_female:'女性',
      label_place:'出生地', ph_place:'都市または座標 例：Tokyo／35.68, 139.76',
      label_birthdate:'生年月日', label_birthtime:'出生時刻',
      btn_generate:'チャートを生成', btn_demo:'デモ',
      note_privacy:'注意：ローカルデモのみ。個人情報は送信されません。',
      chart_title:'あなたの出生ホロスコープ',
      panel_login_head:'ログイン／新規登録', ph_email:'メールアドレス',
      ph_password:'パスワード（8文字以上・英大小／数字／記号を含む）', ph_label_password:'パスワード',
      chat_fab:'問', chat_placeholder:'何を知りたいですか？（機能・会員など）', chat_send:'送信',
      chat_greeting:'こんにちは、心怜バトラーです。どうお手伝いできますか？',
      butler_title:'心怜バトラー · インサイト',
      butler_chat_title:'心怜バトラー · チャット',
      chip_career:'キャリア', chip_love:'人間関係', chip_money:'お金のアドバイス', chip_list:'今週のタスク', chip_30d:'30日プラン',
      q_career:'キャリアやチームワークの洞察を続けて', q_love:'恋愛や長期的な関係について', q_money:'金銭習慣・盲点・改善案を教えて', q_list:'今週の実行リストを作って', q_30d:'30日間の成長プランを作って',
      vip_tip:'🔒 VIPで全文表示を解放',
      vip_sub:'キャリア／金銭／行動リスト／優しいリマインドの全セクション＋追質問',
      btn_unlock:'今すぐ解放',
      err_network:'ネットワークエラー', err_busy:'混み合っています。しばらくしてからお試しください。',
      alert_fill:'「日付／場所」を入力してください。（時間未入力は12:00）'
"vip_title": "🌙 会員エリア",
    "vip_mingli": "🗝 命理スペース・限定コンテンツ",
    "vip_love": "縁・結婚：恋愛のご縁、結婚の流れ",
    "vip_career": "キャリア：職場での成長・起業の可能性",
    "vip_wealth": "財運：財位の分析・タイミング",
    "vip_pet": "ペット命理：ペットの性格とご縁",
    "vip_hepan": "合盤：挙式日の選定・出産タイミング",
    "vip_name": "命名鑑定：社名・赤ちゃんの名・改名開運",
    "vip_fengshui": "財位合盤：住まい／オフィスの動線調整",
    "vip_xinlian": "🌙 心怜スペース・限定コンテンツ",
    "vip_record": "スピリチュアル記録：写真・夢・音声・祈り／願い",
    "vip_course": "講座：八字／タロット／占星術／数秘／ヒューマンデザイン",
    "vip_memorial": "家族メモリアル：故人の霊的追悼と継承",
    "vip_tasks": "毎週のエネルギーワーク／神様の儀式タスク",
    "vip_shop": "エナジーショップ限定割引＆御守カスタム",
    "login_title": "💎 VIP 機能にサインイン",
    "panel_login_head": "アカウント ログイン／登録",
    "ph_email": "メールアドレス",
    "ph_label_password": "パスワード",
    "ph_password": "パスワード（8文字以上・英大小／数字／記号を含む）",
    "btn_login": "ログイン",
    "btn_reset": "🔑 パスワードをリセット",
    "btn_register": "アカウント登録",
    "note_price": "登録で無料体験を1回進呈",
    "panel_member_head": "会員サービス",
    "btn_upgrade": "💎 VIP（月額）にアップグレード",
    "btn_backshop": "← 命理ショップへ戻る",
    "note_price1": "$9.9／月 VIP（命理スペース＋心怜スペース＋スピリチュアル講座）"
  },
    'th': {
      lang_label:'ภาษา',
      btn_login:'เข้าสู่ระบบ', btn_register:'สมัครบัญชี', btn_reset:'🔑 รีเซ็ตรหัสผ่าน',
      page_title:'ดวงกำเนิด｜Natal Chart',
      page_sub:'กรอกข้อมูลเกิดเพื่อสร้างดวงกำเนิดส่วนตัว (เดโม)',
      label_name:'ชื่อ (ไม่บังคับ)', ph_name:'ชื่อของคุณ (เพื่อปรับให้เหมาะส่วนบุคคล)',
      gender_label:'เพศ', opt_gender_confidential:'ไม่ระบุ', opt_gender_male:'ชาย', opt_gender_female:'หญิง',
      label_place:'สถานที่เกิด', ph_place:'เมืองหรือพิกัด เช่น Bangkok / 13.75, 100.50',
      label_birthdate:'วันเกิด', label_birthtime:'เวลาเกิด',
      btn_generate:'สร้างแผนภูมิ', note_privacy:'เดโมภายในเครื่องเท่านั้น — ไม่มีการอัปโหลดข้อมูลส่วนตัว',
      chart_title:'ดวงกำเนิดของคุณ',
      ph_email:'อีเมล', ph_label_password:'รหัสผ่าน', ph_password:'รหัสผ่าน (อย่างน้อย 8 ตัว)',
      chat_fab:'ถาม', chat_placeholder:'อยากทราบเรื่องใด? (เช่น ฟีเจอร์/สมาชิก)', chat_send:'ส่ง',
      chat_greeting:'สวัสดี ฉันคือผู้ช่วยซินเหลียน ช่วยอะไรได้บ้าง',
      butler_title:'ผู้ช่วยซินเหลียน · บทวิเคราะห์',
      butler_chat_title:'ผู้ช่วยซินเหลียน · แชต',
      chip_career:'การงาน', chip_love:'ความสัมพันธ์', chip_money:'คำแนะนำการเงิน', chip_list:'รายการทำสัปดาห์นี้', chip_30d:'แผน 30 วัน',
      q_career:'ช่วยวิเคราะห์การงานและการทำงานเป็นทีมต่อ', q_love:'พูดถึงความรักและความสัมพันธ์ระยะยาว', q_money:'บอกนิสัยการเงิน จุดบอด และแนวทางปรับปรุง', q_list:'ขอรายการปฏิบัติได้จริงสำหรับสัปดาห์นี้', q_30d:'วางแผนพัฒนา 30 วันให้ฉัน',
      vip_tip:'🔒 ปลดล็อก VIP เพื่ออ่านฉบับเต็ม',
      vip_sub:'รวมทุกหัวข้อ: งาน / การเงิน / รายการลงมือทำ / คำเตือนอ่อนโยน และการถามต่อ',
      btn_unlock:'ปลดล็อกทันที',
      err_network:'เครือข่ายผิดพลาด', err_busy:'ระบบหนาแน่น โปรดลองใหม่ภายหลัง',
      alert_fill:'กรอก “วันที่/สถานที่” ให้ครบ (เวลากำหนดเป็น 12:00 หากว่าง)'
"vip_title": "🌙 พื้นที่สมาชิก VIP",
    "vip_mingli": "🗝 เนื้อหาพิเศษ — โซนโหราศาสตร์",
    "vip_love": "ทิศทางความรัก: เคมีความรัก & แนวโน้มการแต่งงาน",
    "vip_career": "ทิศทางการงาน: การเติบโตในงาน & ศักยภาพผู้ประกอบการ",
    "vip_wealth": "ทิศทางการเงิน: วิเคราะห์ตำแหน่งทรัพย์ & จังหวะลงทุน",
    "vip_pet": "ดวงสัตว์เลี้ยง: บุคลิก & สายสัมพันธ์ของสัตว์คู่ใจ",
    "vip_hepan": "วิเคราะห์ดวงคู่: เลือกฤกษ์แต่งงาน & เลือกเวลาคลอด",
    "vip_name": "วิเคราะห์ชื่อ: ชื่อบริษัท/ชื่อลูก/เปลี่ยนชื่อเสริมดวง",
    "vip_fengshui": "ปรับฮวงจุ้ยทรัพย์ร่วม: บ้าน / ออฟฟิศ & ทิศทางการเดิน",
    "vip_xinlian": "🌙 เนื้อหาพิเศษ — โซนซินเหลียน",
    "vip_record": "บันทึกเชิงจิตวิญญาณ: รูปภาพ ความฝัน เสียง คำอธิษฐาน",
    "vip_course": "คอร์ส: โป๊ยหยี่ (八字) / ทาโรต์ / โหราศาสตร์ / เลขศาสตร์ / Human Design",
    "vip_memorial": "ระบบอนุสรณ์ครอบครัว: ระลึกถึงญาติ & ส่งต่อเจตจำนง",
    "vip_tasks": "แบบฝึกพลังงานประจำสัปดาห์ / ภารกิจพิธีกรรม",
    "vip_shop": "ส่วนลดเฉพาะสมาชิก & จัดทำเครื่องรางตามสั่ง",
    "login_title": "💎 ลงชื่อเข้าใช้เพื่อใช้ฟีเจอร์ VIP",
    "panel_login_head": "เข้าสู่ระบบ / สมัครสมาชิก",
    "ph_email": "อีเมล",
    "ph_label_password": "รหัสผ่าน",
    "ph_password": "รหัสผ่าน (อย่างน้อย 8 ตัว: ตัวพิมพ์ใหญ่/เล็ก ตัวเลข และสัญลักษณ์)",
    "btn_login": "เข้าสู่ระบบ",
    "btn_reset": "🔑 รีเซ็ตรหัสผ่าน",
    "btn_register": "สมัครบัญชี",
    "note_price": "สมัครใหม่รับสิทธิ์ทดลองฟรี 1 ครั้ง",
    "panel_member_head": "บริการสมาชิก",
    "btn_upgrade": "💎 อัปเกรดเป็น VIP (รายเดือน)",
    "btn_backshop": "← กลับไปหน้าร้านโหราศาสตร์",
    "note_price1": "$9.9 / เดือน VIP (โซนโหราศาสตร์ + โซนซินเหลียน + คอร์สจิตวิญญาณ)"
  },
    'ms': {
      lang_label:'Bahasa',
      btn_login:'Log Masuk', btn_register:'Daftar Akaun', btn_reset:'🔑 Tetapkan Semula Kata Laluan',
      page_title:'Carta Kelahiran｜Natal Chart',
      page_sub:'Masukkan data kelahiran anda untuk jana carta kelahiran (demo).',
      label_name:'Nama (pilihan)', ph_name:'Nama anda (untuk personalisasi)',
      gender_label:'Jantina', opt_gender_confidential:'Rahsia', opt_gender_male:'Lelaki', opt_gender_female:'Perempuan',
      label_place:'Tempat Lahir', ph_place:'Bandar atau koordinat, cth: Kuala Lumpur / 3.14, 101.69',
      label_birthdate:'Tarikh Lahir', label_birthtime:'Masa Lahir',
      btn_generate:'Jana Carta', note_privacy:'Demo setempat sahaja — tiada data peribadi dihantar.',
      chart_title:'Carta Kelahiran Anda',
      ph_email:'Emel', ph_label_password:'Kata Laluan', ph_password:'Kata Laluan (≥8 aksara)',
      chat_fab:'Chat', chat_placeholder:'Apa yang anda ingin tahu? (cth: fungsi/keahlian)', chat_send:'Hantar',
      chat_greeting:'Hai, saya Xinlian Butler. Bagaimana saya boleh bantu?',
      butler_title:'Xinlian Butler · Analisis',
      butler_chat_title:'Xinlian Butler · Chat',
      chip_career:'Kerjaya', chip_love:'Hubungan', chip_money:'Nasihat Kewangan', chip_list:'Senarai Mingguan', chip_30d:'Pelan 30 Hari',
      q_career:'Teruskan dengan wawasan kerjaya dan kerja berpasukan', q_love:'Bincang cinta dan hubungan jangka panjang', q_money:'Berikan tabiat kewangan, titik buta dan penambahbaikan', q_list:'Berikan senarai tindakan minggu ini', q_30d:'Buat pelan perkembangan 30 hari',
      vip_tip:'🔒 Buka VIP untuk melihat analisis penuh',
      vip_sub:'Termasuk semua seksyen: Kerjaya / Kekayaan / Senarai Tindakan / Peringatan Lembut + soalan susulan',
      btn_unlock:'Buka sekarang',
      err_network:'Ralat rangkaian', err_busy:'Perkhidmatan sibuk. Cuba lagi kemudian.',
      alert_fill:'Lengkapkan “tarikh/tempat”. (Masa lalai 12:00 jika kosong)'
      "vip_title": "🌙 Kawasan VIP",
    "vip_mingli": "🗝 Kandungan Eksklusif — Ruang Astrologi",
    "vip_love": "Arah Jodoh: jodoh cinta & aliran perkahwinan",
    "vip_career": "Arah Kerjaya: perkembangan tempat kerja & potensi keusahawanan",
    "vip_wealth": "Arah Kekayaan: analisis kedudukan kekayaan & masa yang sesuai",
    "vip_pet": "Astrologi Haiwan Peliharaan: perangai & ikatan haiwan pendamping",
    "vip_hepan": "Analisis Sinistri: pemilihan tarikh kahwin & masa kelahiran bayi",
    "vip_name": "Analisis Nama: nama syarikat, nama bayi, penukaran nama untuk tuah",
    "vip_fengshui": "Padanan Feng Shui Kekayaan: susun atur rumah / pejabat",
    "vip_xinlian": "🌙 Kandungan Eksklusif — Ruang Xinlian",
    "vip_record": "Rekod Kerohanian: foto, mimpi, audio, doa/hasrat",
    "vip_course": "Kursus: Bazi / Tarot / Astrologi / Numerologi / Human Design",
    "vip_memorial": "Sistem Memorial Keluarga: peringatan rohani & legasi",
    "vip_tasks": "Latihan tenaga mingguan / tugasan ritual",
    "vip_shop": "Diskaun kedai tenaga & jimat tempahan khas",
    "login_title": "💎 Log masuk untuk fungsi VIP",
    "panel_login_head": "Log Masuk / Daftar",
    "ph_email": "Emel",
    "ph_label_password": "Kata Laluan",
    "ph_password": "Kata Laluan (≥8 aksara dengan huruf besar/kecil, angka & simbol)",
    "btn_login": "Log masuk",
    "btn_reset": "🔑 Tetapkan semula kata laluan",
    "btn_register": "Daftar Akaun",
    "note_price": "Daftar akaun untuk 1 kali percubaan percuma",
    "panel_member_head": "Perkhidmatan Keahlian",
    "btn_upgrade": "💎 Naik taraf ke VIP (Bulanan)",
    "btn_backshop": "← Kembali ke Kedai Astrologi",
    "note_price1": "$9.9 / bulan VIP (Ruang Astrologi + Ruang Xinlian + Kursus Kerohanian)"
    }
  };

  /* —— 语言名（给模型指令用） —— */
  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  function getLang(){
    const saved = localStorage.getItem(LANG_KEY);
    if (saved && I18N[saved]) return saved;
    const raw = (navigator.language || 'zh-CN').replace('_','-');
    const map = {'zh':'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW',
                 'en':'en','en-US':'en','en-GB':'en','en-AU':'en','ja':'ja','ja-JP':'ja','th':'th','ms':'ms'};
    return map[raw] || 'zh-CN';
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  function t(key){
    const L = I18N[getLang()] || I18N['zh-CN'];
    return L[key] || (I18N['zh-CN'][key] || key);
  }

  function applyI18n(){
    const setTxt = (sel,val)=>{ const el=qs(sel); if(el) el.textContent = val; };
    const setPh  = (sel,val)=>{ const el=qs(sel); if(el) el.setAttribute('placeholder', val); };

    setTxt('[data-i18n="lang_label"]', t('lang_label'));
    const sel = gid('langSelect'); if(sel) sel.value = getLang();
    setTxt('[data-i18n="page_title"]', t('page_title'));
    setTxt('[data-i18n="page_sub"]', t('page_sub'));
    setTxt('[data-i18n="label_name"]', t('label_name')); setPh('#name', t('ph_name'));
    setTxt('[data-i18n="gender_label"]', t('gender_label'));
    const ou=qs('#gender option[value="u"]'); if(ou) ou.textContent=t('opt_gender_confidential');
    const om=qs('#gender option[value="m"]'); if(om) om.textContent=t('opt_gender_male');
    const of=qs('#gender option[value="f"]'); if(of) of.textContent=t('opt_gender_female');
    setTxt('[data-i18n="label_place"]', t('label_place')); setPh('#place', t('ph_place'));
    setTxt('[data-i18n="label_birthdate"]', t('label_birthdate'));
    setTxt('[data-i18n="label_birthtime"]', t('label_birthtime'));
    const gb=gid('genBtn'); if(gb) gb.textContent=t('btn_generate');
    setTxt('#formNote', t('note_privacy'));
    setTxt('[data-i18n="chart_title"]', t('chart_title'));
    document.title = t('page_title');
  }

  function applyChatI18n(){
    const fab = gid('ssChatFab');
    const inp = gid('ssChatInput');
    const btn = gid('ssChatSend');
    const title = qs('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('butler_chat_title');
  }

  function initLangUI(){
    const sel = gid('langSelect');
    if(!sel) return;
    const current = getLang();
    sel.value = current;
    document.documentElement.lang = current;
    applyI18n();
    applyChatI18n();
    sel.addEventListener('change', ()=>{
      setLang(sel.value);
      applyI18n();
      applyChatI18n();
      if (qs('#result')?.style.display !== 'none'){
        const ctx = readForm();
        if (ctx.date && ctx.place){
          renderReport({...ctx, lang:getLang()});
          runAI();
        }
      }
      // 重新绘制芯片语言
      renderChips();
    });
  }

  /* ============== 太阳星座（近似） ============== */
  const SIGN_LIST = [
    {key:'Aries',start:[3,21],end:[4,19],el:'fire', name:{'zh-CN':'白羊座','zh-TW':'牡羊座','en':'Aries','ja':'牡羊座','th':'เมษ','ms':'Aries'}},
    {key:'Taurus',start:[4,20],end:[5,20],el:'earth',name:{'zh-CN':'金牛座','zh-TW':'金牛座','en':'Taurus','ja':'牡牛座','th':'พฤษภ','ms':'Taurus'}},
    {key:'Gemini',start:[5,21],end:[6,21],el:'air',  name:{'zh-CN':'双子座','zh-TW':'雙子座','en':'Gemini','ja':'双子座','th':'เมถุน','ms':'Gemini'}},
    {key:'Cancer',start:[6,22],end:[7,22],el:'water',name:{'zh-CN':'巨蟹座','zh-TW':'巨蟹座','en':'Cancer','ja':'蟹座','th':'กรกฎ','ms':'Cancer'}},
    {key:'Leo',start:[7,23],end:[8,22],el:'fire',   name:{'zh-CN':'狮子座','zh-TW':'獅子座','en':'Leo','ja':'獅子座','th':'สิงห์','ms':'Leo'}},
    {key:'Virgo',start:[8,23],end:[9,22],el:'earth',name:{'zh-CN':'处女座','zh-TW':'處女座','en':'Virgo','ja':'乙女座','th':'กันย์','ms':'Virgo'}},
    {key:'Libra',start:[9,23],end:[10,23],el:'air', name:{'zh-CN':'天秤座','zh-TW':'天秤座','en':'Libra','ja':'天秤座','th':'ตุล','ms':'Libra'}},
    {key:'Scorpio',start:[10,24],end:[11,22],el:'water',name:{'zh-CN':'天蝎座','zh-TW':'天蠍座','en':'Scorpio','ja':'蠍座','th':'พิจิก','ms':'Scorpio'}},
    {key:'Sagittarius',start:[11,23],end:[12,21],el:'fire',name:{'zh-CN':'射手座','zh-TW':'射手座','en':'Sagittarius','ja':'射手座','th':'ธนู','ms':'Sagittarius'}},
    {key:'Capricorn',start:[12,22],end:[1,19],el:'earth',name:{'zh-CN':'摩羯座','zh-TW':'摩羯座','en':'Capricorn','ja':'山羊座','th':'มังกร','ms':'Capricorn'}},
    {key:'Aquarius',start:[1,20],end:[2,18],el:'air', name:{'zh-CN':'水瓶座','zh-TW':'水瓶座','en':'Aquarius','ja':'水瓶座','th':'กุมภ์','ms':'Aquarius'}},
    {key:'Pisces',start:[2,19],end:[3,20],el:'water',name:{'zh-CN':'双鱼座','zh-TW':'雙魚座','en':'Pisces','ja':'魚座','th':'มีน','ms':'Pisces'}}
  ];
  function inRange(m,d,[sm,sd],[em,ed]){
    return (sm<em || (sm===em && sd<=ed))
      ? (m>sm || (m===sm && d>=sd)) && (m<em || (m===em && d<=ed))
      : (m>sm || (m===sm && d>=sd)) || (m<em || (m===em && d<=ed));
  }
  function getSunSign(dateStr){
    const dt=new Date(dateStr), m=dt.getMonth()+1, d=dt.getDate();
    return SIGN_LIST.find(s=>inRange(m,d,s.start,s.end)) || SIGN_LIST[11];
  }
  const EL_TEXT = {
    'zh-CN':{fire:'火元素偏旺：行动力强，先做后想更常见；给自己留个停顿更准。',
             earth:'土元素偏旺：务实细致；别被完美卡住，先上路再优化。',
             air:'风元素偏旺：想法多善沟通；控制信息过载，用“落地清单”。',
             water:'水元素偏旺：感受力强；写下来或动起来，让情绪流动。'},
    'zh-TW':{fire:'火元素偏旺：行動力強；加個緩衝更穩。', earth:'土元素偏旺：務實細緻；別被完美主義卡住。',
             air:'風元素偏旺：點子多；用清單收束。', water:'水元素偏旺：感受力強；書寫或運動讓情緒流動。'},
    'en':   {fire:'Fire-leaning: bold & fast—add a pause for precision.',
             earth:'Earth-leaning: practical—ship then refine.',
             air:'Air-leaning: ideas flow—tame overload with a list.',
             water:'Water-leaning: sensitive—journal or move to keep emotions flowing.'},
    'ja':   {fire:'火の要素が強め：行動は速い。少し立ち止まると精度UP。',
             earth:'地の要素が強め：実務的。まず出して後で磨く。',
             air:'風の要素が強め：発想豊富。情報過多はリストで制御。',
             water:'水の要素が強め：感受性豊か。書く/動くで循環させよう。'},
    'th':   {fire:'ธาตุไฟเด่น: เร็วและกล้า—เติม “หยุดคิดนิดหนึ่ง” ให้เป๊ะขึ้น',
             earth:'ธาตุดินเด่น: ใช้การได้จริง—ส่งก่อนค่อยขัดเกลา',
             air:'ธาตุลมเด่น: ไอเดียไหล—คุมข้อมูลล้นด้วยลิสต์',
             water:'ธาตุน้ำเด่น: ไวต่อความรู้สึก—จดบันทึกหรือขยับร่างให้ไหลเวียน'},
    'ms':   {fire:'Cenderung Api: pantas & berani—tambah jeda untuk ketepatan.',
             earth:'Cenderung Bumi: praktikal—hantar dahulu, kemas kini kemudian.',
             air:'Cenderung Udara: idea mengalir—kawal lambakan info dengan senarai.',
             water:'Cenderung Air: peka—tulis atau bergerak agar emosi mengalir.'}
  };

  /* ============== 报告渲染 ============== */
  function renderReport(obj){
    const lang = obj.lang && I18N[obj.lang] ? obj.lang : getLang();
    const sign = getSunSign(obj.date);
    const signName = sign.name[lang] || sign.name['zh-CN'];
    const tips = (EL_TEXT[lang] || EL_TEXT['zh-CN'])[sign.el];
    const disclaimer = (lang==='zh-TW') ? '＊示範：僅依日期推太陽星座，非完整本命盤。'
                     : (lang==='en')   ? '*Demo: Sun sign only (not a full chart).'
                     : (lang==='ja')   ? '※デモ：太陽星座のみ（完全な出生図ではありません）。'
                     : (lang==='th')   ? '*เดโม: มีเพียงราศีอาทิตย์ ยังไม่ใช่ดวงเต็ม'
                     : (lang==='ms')   ? '*Demo: Hanya tanda Matahari (bukan carta penuh).'
                     : '＊演示：仅按日期推太阳星座，非完整本命盘。';

    const container = gid('chartReport') || gid('chartSummary');
    if(!container){
      const tmp = document.createElement('div');
      tmp.id = 'chartReport';
      tmp.className = 'report';
      (gid('result') || document.body).appendChild(tmp);
    }
    gid('chartReport').innerHTML =
      '<div class="sec">'+
        '<h3>'+(lang==='zh-TW'?'總覽':lang==='en'?'Overview':lang==='ja'?'概要':lang==='th'?'ภาพรวม':lang==='ms'?'Gambaran':'概览')+'</h3>'+
        '<p>'+(obj.name?obj.name+' · ':'')+obj.date+' '+obj.time+' @ '+obj.place+'</p>'+
        '<p class="muted" style="opacity:.75">'+disclaimer+'</p>'+
      '</div>'+
      '<div class="sec">'+
        '<h3>'+(lang==='zh-TW'?'太陽星座':lang==='en'?'Sun Sign':lang==='ja'?'太陽星座':lang==='th'?'ราศีอาทิตย์':lang==='ms'?'Tanda Matahari':'太阳星座')+'</h3>'+
        '<p>'+ (lang==='en'?'Your Sun is in ': (lang==='ja'?'太陽は『':'你的太阳在「')) + signName + (lang==='en'?'.': (lang==='ja'?'』にあります。':'」。')) + '</p>'+
      '</div>'+
      '<div class="sec">'+
        '<h3>'+(lang==='zh-TW'?'能量提示':lang==='en'?'Energy Tip':lang==='ja'?'エネルギーのヒント':lang==='th'?'ทิปพลังงาน':lang==='ms'?'Petua Tenaga':'能量提示')+'</h3>'+
        '<p>'+tips+'</p>'+
      '</div>';
  }

  function readForm(){
    const name = gid('name')?.value.trim() || '';
    const place= gid('place')?.value.trim() || '';
    const date = gid('birthdate')?.value || '';
    const time = gid('birthtime')?.value || '12:00';
    return {name, place, date, time};
  }

  /* ============== AI 智能解读：多语言输出 ============== */
  function mdToHtml(md){
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  function isVIP(){
    return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
  }

  function ensureAiCard(){
    if (gid('aiCard')) return;
    const sec = document.createElement('section');
    sec.className='ai-card'; sec.id='aiCard';
    sec.innerHTML = `
      <h2 id="butlerTitle">${t('butler_title')}</h2>
      <div id="aiContent" class="ai-content">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>`;
    const result = gid('result') || document.body;
    result.parentNode.insertBefore(sec, result.nextSibling);
    renderChips();
  }

  function renderChips(){
    const wrap = gid('aiChips'); if(!wrap) return;
    wrap.innerHTML = '';
    const items = [
      {k:'chip_career', q:'q_career'},
      {k:'chip_love',   q:'q_love'},
      {k:'chip_money',  q:'q_money'},
      {k:'chip_list',   q:'q_list'},
      {k:'chip_30d',    q:'q_30d'},
    ];
    items.forEach(it=>{
      const btn = document.createElement('button');
      btn.className='chip';
      btn.textContent = t(it.k);
      btn.setAttribute('data-q', t(it.q));
      wrap.appendChild(btn);
    });
  }

  function buildButlerSystemPrompt(lang){
    const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    const headers = {
      'zh-CN': ['人物画像','关系与沟通','事业与自我实现','金钱与物质','今日/本周可执行清单','温柔提醒'],
      'zh-TW': ['人物画像','關係與溝通','事業與自我實現','金錢與物質','今日/本週可執行清單','溫柔提醒'],
      'en':    ['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
      'ja':    ['人物像','関係とコミュニケーション','キャリアと自己実現','お金と物質','今日/今週の実行リスト','やさしいリマインド'],
      'th':    ['ภาพบุคคล','ความสัมพันธ์ & การสื่อสาร','การงาน & การเติมเต็มตนเอง','การเงิน & วัตถุ','รายการปฏิบัติ (วันนี้/สัปดาห์นี้)','คำเตือนอ่อนโยน'],
      'ms':    ['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
    }[lang] || headers['zh-CN'];

    return [
      `You are "Xinlian Butler". OUTPUT LANGUAGE: ${ln}. Reply strictly in ${ln} only.`,
      'Warm, practical, actionable. No medical/legal conclusions.',
      'Markdown structure:',
      `## ${headers[0]}`,
      `## ${headers[1]} (2–4 bullets)`,
      `## ${headers[2]} (2–4 bullets)`,
      `## ${headers[3]} (2–3 bullets)`,
      `## ${headers[4]} (3–5 bullets; start with verbs; quantify if possible)`,
      `## ${headers[5]}`
    ].join('\n');
  }

  async function runAI(){
    ensureAiCard();
    gid('butlerTitle').textContent = t('butler_title');
    const {name, place, date, time} = readForm();
    if(!date || !place){ return; }

    const lang = getLang();
    const sun = getSunSign(date);
    const sunName = (sun.name[lang] || sun.name['zh-CN']);
    const el = sun.el;

    const sys = buildButlerSystemPrompt(lang);
    const usr = [
      `Name: ${name || '-'}`,
      `Birth: ${date} ${time} @ ${place}`,
      `Sun sign: ${sunName} (element: ${el})`,
      `Expectation: human, concrete, and immediately actionable advice.`
    ].join('\n');

    const elC = gid('aiContent');
    if (elC){
      elC.innerHTML = `
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>`;
    }

    try{
      const r = await fetch(API_BASE+'/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:usr}]})
      });
      const data = await r.json().catch(()=>({}));
      const raw = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      let html = mdToHtml(raw);

      if(!isVIP()){
        const parts = raw.split(/\n##\s+/);
        const header = parts.shift() || '';
        const kept = [header, ...(parts.slice(0,2).map(p=>'## '+p))].join('\n\n');
        html = mdToHtml(kept) + `
          <div class="ai-lock-overlay" style="text-align:center;padding:14px 10px;border-top:1px solid #1f2a36;margin-top:10px">
            <div class="tip">${t('vip_tip')}</div>
            <div class="sub" style="margin-top:4px">${t('vip_sub')}</div>
            <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">${t('btn_unlock')}</a>
          </div>`;
      }

      if(elC){
        elC.innerHTML = html;
      }
      renderChips();
    }catch(e){
      if(elC) elC.innerHTML = `<div style="color:#98a7b7">${t('err_network')}: ${e.message}</div>`;
    }
  }

  // 追问芯片（跟随语言 data-q）
  document.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const q = chip.getAttribute('data-q') || chip.textContent;
    const el = gid('aiContent'); if(!el) return;
    el.innerHTML += `<br/><br/><b>—</b> ${q}<br/>`;
    const sys = buildButlerSystemPrompt(getLang());
    fetch(API_BASE+'/api/chat',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:sys + '\n(Continue previous tone. Add concrete steps.)'},
        {role:'user',content:q}
      ]})
    }).then(r=>r.json()).then(data=>{
      const txt=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      el.innerHTML += mdToHtml('\n\n'+txt || ('\n\n'+t('err_busy')));
    }).catch(err=>{
      el.innerHTML += `<div style="color:#98a7b7">${t('err_network')}: ${err.message}</div>`;
    });
  });

  /* ============== 生成：基础 + AI ============== */
  function generateChart(){
    const {name, place, date, time} = readForm();
    if (!date || !place){
      alert(t('alert_fill'));
      return;
    }
    const summary = gid('chartSummary');
    if (summary) summary.textContent = (name?name+' · ':'') + date + ' ' + (time||'12:00') + ' @ ' + place;
    const resultEl = gid('result'); if (resultEl) resultEl.style.display = 'block';
    renderReport({name, date, time: (time||'12:00'), place, lang: getLang()});
    runAI();
  }

  /* ============== 右下角 Chat 悬浮球（多语言） ============== */
  function mountChat(){
    if (gid('ssChatFab')) return;
    const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title=t('butler_chat_title');
    const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label',t('butler_chat_title'));
    chatPanel.innerHTML = `
      <div class="ss-chat-head"><div class="ss-chat-title">${t('butler_chat_title')}</div><div class="ss-close" id="ssChatClose">✕</div></div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')}"/>
        <button id="ssChatSend" class="btn">${t('chat_send')}</button>
      </div>`;
    document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
    applyChatI18n();

    const $body=gid('ssChatBody'), $input=gid('ssChatInput'), $send=gid('ssChatSend'), $close=gid('ssChatClose');
    const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); };
    const closePanel=()=>{ chatPanel.style.display='none'; };
    chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);

    function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
    async function askChat(prompt){
      addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
      const sys = [
        `You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese'}.`,
        'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'
      ].join('\n');
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({messages:[
            {role:'system',content:sys},
            {role:'user',content:prompt}
          ]})
        });
        let data,reply=''; try{data=await r.json()}catch{data={}}
        reply=data?.reply??data?.text??data?.choices?.[0]?.message?.content??'';
        addMsg(reply || t('err_busy'));
      }catch(e){ addMsg(`${t('err_network')}，${t('err_busy')}`); }
    }
    $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
    $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
  }

  /* ============== 页面初始化 ============== */
  document.addEventListener('DOMContentLoaded', ()=>{
    if (gid('birthdate') && !gid('birthdate').value){
      gid('birthdate').value = new Date().toISOString().split('T')[0];
    }
    initLangUI();
    gid('genBtn')?.addEventListener('click', generateChart);
    mountChat();
  });

})();
</script>
</body>
</html>


