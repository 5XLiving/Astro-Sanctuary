<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="5XLiving 本命星盘：输入出生日期、时间和地点，获得个性化解读。">
  <meta name="theme-color" content="#0b0f14">
  <link rel="preconnect" href="https://throbbing-lab-1440.hello5xliving.workers.dev" crossorigin>
  <title>本命星盘 · Natal Chart | 5XLiving</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35) }
    html,body{height:100%}
    body{ margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14); font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale }
    body::before{ content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px) }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 80px }

    /* —— 统一头部 —— */
    .site-header{ position:sticky; top:0; z-index:10; background:#0b0f14cc; border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px) }
    .head-inner{ display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text) }
    .brand-badge{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084 }
    .title{ font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem; line-height:1.25 }
    .title a{ color:inherit; text-decoration:none }
    .title a:hover{ text-decoration:underline; text-underline-offset:3px }
    .now{ color:#9bb0c3; font-size:.9rem }
    .lang{ display:flex; align-items:center; gap:8px }
    .lang label{ white-space:nowrap; color:var(--muted) }
    .lang select{ appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:calc(100% - 12px) 50% }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* —— 页面结构 —— */
    .h1{ margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem }
    .sub{ color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:18px; margin:16px 0 }
    .row{ display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{ display:block; margin-bottom:4px }
    input,select{ width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244; background:#0e1520; color:var(--text); padding:12px 12px; font-size:15px; outline:none }
    input::placeholder{ color:#6f8092 }
    .btn{ display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn.ghost{ background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none }

    /* —— 报告样式 —— */
    .report{ margin-top:12px; display:grid; gap:10px }
    .report .sec{ padding:12px; border:1px solid var(--line); background:#0e1520; border-radius:12px }
    .report .sec h3{ margin:0 0 6px; color:#f2d27a; font-size:1.05rem }
    .report p,.report li{ line-height:1.7 }

    /* —— Butler & Chat —— */
    .ss-chat-fab{ position:fixed; right:18px; bottom:18px; z-index:50; width:56px; height:56px; border-radius:50%; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; display:grid; place-items:center; font-weight:800; box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer; border:1px solid #e6c76e }
    .ss-chat-panel{ position:fixed; right:18px; bottom:88px; z-index:50; width:min(460px,92vw); display:none; background:#0e1520; border:1px solid #243244; border-radius:14px; box-shadow:var(--shadow) }
    .ss-chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #243244 }
    .ss-chat-title{ font-weight:700 }
    .ss-close{ cursor:pointer; opacity:.8 }
    .ss-chat-body{ max-height:300px; overflow:auto; padding:10px 12px }
    .ss-msg{ padding:8px 10px; background:#0f1624; border:1px solid #243244; border-radius:10px; margin:6px 0; max-width:80% }
    .ss-msg.me{ margin-left:auto; background:#132033 }
    .ss-chat-input{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #243244 }
    .ss-chat-input input{ flex:1 1 auto; min-width:0 }
    .ss-chat-input .btn,.ss-chat-input button{ flex:0 0 auto; width:auto !important; white-space:nowrap; padding:10px 14px }

    /* —— 会员区 —— */
    .columns{ display:grid; gap:12px; grid-template-columns:1fr }
    @media(min-width:900px){ .columns{ grid-template-columns:1fr 1fr } }
    .list-block{ border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px }
    .list-block ul{ margin:.2rem 0 0; padding-left:1.1rem }
    .group-title{ font-size:1.05rem; color:#ffe084; margin:6px 0 14px }
    .astro-auth{ max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35) }
    .auth-grid{ display:grid; gap:18px; grid-template-columns:1.2fr .8fr }
    @media(max-width:860px){ .auth-grid{ grid-template-columns:1fr } }
    .panel{ background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
    .panel .head{ padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:.3px }
    .panel .body{ padding:18px }
    .spacer{ height:12px }
    footer{ color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0 }

    .sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{ display:none!important }
  </style>
</head>
<body>
  <!-- 统一头部 -->
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com/" target="_self">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="page_title">本命星盘解析</span></span>
      </a>
      <div class="now" id="nowBox" aria-live="polite"></div>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">本命星盘解析</h1>

    <!-- 表单区域 -->
    <section class="card">
      <form id="chartForm" novalidate>
        <div class="row cols-3">
          <div>
            <label class="muted" for="name" data-i18n="label_name">姓名（可选）</label>
            <input id="name" type="text" data-i18n-ph="ph_name" placeholder="你的称呼（用于个性化）" />
          </div>
          <div>
            <label class="muted" for="gender" data-i18n="gender_label">性别</label>
            <select id="gender">
              <option value="u" data-i18n="opt_gender_confidential">不透露</option>
              <option value="m" data-i18n="opt_gender_male">男性</option>
              <option value="f" data-i18n="opt_gender_female">女性</option>
            </select>
          </div>
          <div>
            <label class="muted" for="place" data-i18n="label_place">出生地点 （必填）</label>
            <input id="place" type="text" required placeholder="城市或坐标，如：Taipei / 25.03,121.56" pattern="^(.{2,}|-?\d{1,2}(\.\d+)?,\s*-?\d{1,3}(\.\d+)?)$" title="输入城市名或坐标，如 Taipei 或 25.03,121.56"/>
          </div>
        </div>
        <div class="row cols-3" style="margin-top:10px">
          <div>
            <label class="muted" for="birthdate" data-i18n="label_birthdate">出生日期</label>
            <input id="birthdate" type="date" required />
          </div>
          <div>
            <label class="muted" for="birthtime" data-i18n="label_birthtime">出生时间</label>
            <input id="birthtime" type="time" value="12:00" step="60" />
          </div>
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button id="genBtn" class="btn" type="submit" data-i18n="btn_generate">生成星盘</button>
          </div>
        </div>
      </form>
    </section>

    <!-- 结果区域 -->
    <section id="result" class="card" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="chart_title">你的本命报告</h2>
      <div id="chartSummary" class="muted"></div>
      <div id="chartReport" class="report"></div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields" style="display:none">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="邮箱 Email" />
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" />
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

<script>
(function(){
  'use strict';

  /* ========================= 常量 & i18n ========================= */
  const API_BASE = (window.API_BASE || 'https://throbbing-lab-1440.hello5xliving.workers.dev');
  const ENDPOINTS = [API_BASE + '/api/chat'];
  const OFFLINE_MODE = false; // 需要强制离线测试时设 true

  const I18N = {
    'zh-CN': { page_title:'本命星盘解析', lang_label:'语言', btn_generate:'生成星盘', label_name:'姓名（可选）', ph_name:'你的称呼（用于个性化）', label_place:'出生地点 （必填）', label_birthdate:'出生日期', label_birthtime:'出生时间', chart_title:'你的本命星盘', butler_title:'心怜管家 · 智能解读', butler_chat_title:'心怜管家 · Chat', chat_fab:'问', chat_placeholder:'想了解什么？（如：功能、会员说明）', chat_send:'发送', alert_fill:'请补全“日期/地点”。（时间留空将默认为 12:00）', err_network:'网络异常', err_busy:'服务暂时繁忙，请稍后重试。', vip_tip:'🔒 VIP 解锁后可查看完整解读', vip_sub:'包含「事业/财富/执行清单/温柔提醒」全部章节与持续追问', btn_unlock:'立即解锁' },
    'ms': { page_title:'Carta Natal', lang_label:'Bahasa', btn_generate:'Jana Carta', label_name:'Nama (pilihan)', ph_name:'Nama anda', label_place:'Tempat Lahir (wajib)', label_birthdate:'Tarikh Lahir', label_birthtime:'Masa Lahir', chart_title:'Laporan Carta Natal Anda', butler_title:'Xinlian Butler · Analisis Pintar', butler_chat_title:'Xinlian Butler · Chat', chat_fab:'Tanya', chat_placeholder:'Apa yang anda mahu tahu?', chat_send:'Hantar', alert_fill:'Sila lengkapkan “Tarikh/Tempat”. (Masa kosong = 12:00)', err_network:'Ralat rangkaian', err_busy:'Perkhidmatan sibuk, cuba lagi.', vip_tip:'🔒 Buka VIP untuk kandungan penuh', vip_sub:'Termasuk semua bab & soalan lanjut', btn_unlock:'Buka VIP' }
  };
  function getLang(){ return document.getElementById('langSelect')?.value || 'zh-CN'; }
  function t(key){ const lang=getLang(); return (I18N[lang] && I18N[lang][key]) || (I18N['zh-CN'][key]||key); }

  /* ========================= 实用函数 ========================= */
  const gid = (id)=>document.getElementById(id);
  const qs  = (s,root=document)=>root.querySelector(s);
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

  function startNowClock(){
    const el = gid('nowBox'); if(!el) return;
    const fmt = (n)=> (n<10?('0'+n):n);
    function tick(){
      const now = new Date();
      const y=now.getFullYear(), m=fmt(now.getMonth()+1), d=fmt(now.getDate());
      const hh=fmt(now.getHours()), mm=fmt(now.getMinutes()), ss=fmt(now.getSeconds());
      el.textContent = `${y}-${m}-${d} ${hh}:${mm}:${ss} SGT`;
    }
    tick(); setInterval(tick, 1000);
  }

  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  /* ========================= 星座与元素（近似） ========================= */
  const SIGN_LIST = [
    {key:'Aries',start:[3,21],end:[4,19],el:'fire', name:{'zh-CN':'白羊座','ms':'Aries'}},
    {key:'Taurus',start:[4,20],end:[5,20],el:'earth',name:{'zh-CN':'金牛座','ms':'Taurus'}},
    {key:'Gemini',start:[5,21],end:[6,21],el:'air',  name:{'zh-CN':'双子座','ms':'Gemini'}},
    {key:'Cancer',start:[6,22],end:[7,22],el:'water',name:{'zh-CN':'巨蟹座','ms':'Cancer'}},
    {key:'Leo',start:[7,23],end:[8,22],el:'fire',   name:{'zh-CN':'狮子座','ms':'Leo'}},
    {key:'Virgo',start:[8,23],end:[9,22],el:'earth',name:{'zh-CN':'处女座','ms':'Virgo'}},
    {key:'Libra',start:[9,23],end:[10,23],el:'air', name:{'zh-CN':'天秤座','ms':'Libra'}},
    {key:'Scorpio',start:[10,24],end:[11,22],el:'water',name:{'zh-CN':'天蝎座','ms':'Scorpio'}},
    {key:'Sagittarius',start:[11,23],end:[12,21],el:'fire',name:{'zh-CN':'射手座','ms':'Sagittarius'}},
    {key:'Capricorn',start:[12,22],end:[1,19],el:'earth',name:{'zh-CN':'摩羯座','ms':'Capricorn'}},
    {key:'Aquarius',start:[1,20],end:[2,18],el:'air', name:{'zh-CN':'水瓶座','ms':'Aquarius'}},
    {key:'Pisces',start:[2,19],end:[3,20],el:'water',name:{'zh-CN':'双鱼座','ms':'Pisces'}}
  ];
  function inRange(m,d,[sm,sd],[em,ed]){ return (sm<em || (sm===em && sd<=ed)) ? ((m>sm || (m===sm && d>=sd)) && (m<em || (m===em && d<=ed))) : ((m>sm || (m===sm && d>=sd)) || (m<em || (m===em && d<=ed))); }
  function getSunSign(dateStr){ const dt=new Date(dateStr), m=dt.getMonth()+1, d=dt.getDate(); return SIGN_LIST.find(s=>inRange(m,d,s.start,s.end)) || SIGN_LIST[11]; }

  const EL_TIPS = {
    'zh-CN':{
      fire:['行动力强、先做后想；设“停顿键”更准。','以短冲刺推进大目标，别拖成长线。'],
      earth:['务实细致；给自己“好够了”的下限。','先上线后优化，别被完美主义拖慢。'],
      air:['想法多、善沟通；写行动清单避免漂移。','定信息摄入上限，留空白。'],
      water:['感受力强；情绪写下/动起来让能量流动。','每天10分钟身体扫描减压。']
    }
  };

  /* ========================= 报告渲染（专业版结构） ========================= */
  function renderProNatalReport(model){
    const wrap = gid('chartReport'); if(!wrap) return;
    const lang = getLang();
    const sun = getSunSign(model.date);
    const sunName = sun.name[lang] || sun.name['zh-CN'];
    const el = sun.el;
    const elTips = (EL_TIPS[lang]||EL_TIPS['zh-CN'])[el] || [];

    const pro = [
      { title:'命盘总览', body:`${esc(model.name||'')}${model.name?' · ':''}${model.date} ${model.time}${model.place?(' @ '+esc(model.place)) : ''}<br>太阳星座：<b>${sunName}</b>` },
      { title:'性格画像', body:`基调由太阳星座定调：<b>${sunName}</b>；你更倾向以“${el==='fire'?'行动':'earth'===el?'稳定':'air'===el?'思考':'感受'}”来回应世界。` },
      { title:'关系与沟通', list:[ '先确认对方感受/需求再给建议','把“我观察—我感受—我需要—我请求”四句法写出来','每周一次关系检视：说一句感谢，提一个小期待' ] },
      { title:'事业与天赋', list:[ '只保留一个本周事业优先项，并写出「完成定义」','以“3×25 分钟”番茄钟推进关键任务','把你最拿手的能力绑定到可见产出（作品/案例）' ] },
      { title:'财富与物质', list:[ '建立每日 5 分钟金钱检视（支出/价值/机会）','把钱流分三桶：生活/积累/尝试','任何支出写一句“为什么值得”' ] },
      { title:'健康与节律', list:[ '固定睡前 30 分钟无屏时间','每周 2 次有氧 + 1 次力量','午后 5 分钟伸展 + 饮水 300ml' ] },
      { title:'本周执行清单', list:[ '今天向目标相关的人发 1 条主动讯息','安排 1 小时用于“安静的深度工作”','清理 3 件低价值承诺','为明天写 3 条最小行动' ] },
      { title:'温柔提醒', body: elTips.map(x=>`• ${x}`).join('<br>') }
    ];

    const proHTML = pro.map(sec=>{
      const items = sec.list ? `<ul>${sec.list.map(li=>`<li>${esc(li)}</li>`).join('')}</ul>` : `<p>${sec.body||''}</p>`;
      return `<div class="sec"><h3>${esc(sec.title)}</h3>${items}</div>`;
    }).join('');

    const vipGate = `
      <div class="ai-lock-overlay" style="position:static;margin-top:8px;padding-top:8px;border-top:1px solid #233145;text-align:center">
        <div class="tip" style="color:#ffd88a;font-weight:700;margin-bottom:4px">${t('vip_tip')}</div>
        <div class="sub" style="color:#9aa8b9;margin-top:4px">${t('vip_sub')}</div>
        <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener">${t('btn_unlock')}</a>
      </div>`;

    // 前 3 节对所有人开放，其余节若未登录 VIP 则加锁
    const isVIP = localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
    if(!isVIP){
      // 拆分 proHTML
      const tmp = document.createElement('div'); tmp.innerHTML = proHTML;
      const openParts = Array.from(tmp.children).slice(0,3).map(n=>n.outerHTML).join('');
      const lockedParts = Array.from(tmp.children).slice(3).map(n=>n.outerHTML).join('');
      wrap.innerHTML = openParts + lockedParts + vipGate;
    }else{
      wrap.innerHTML = proHTML;
    }
  }

  /* ========================= Butler（AI 解读卡） ========================= */
  function ensureAiCard(){
    if (gid('aiCard')) return;
    const wrap = gid('chartReport'); if(!wrap) return;
    const sec = document.createElement('div'); sec.className='sec'; sec.id='aiCard';
    sec.innerHTML = `
      <h3 id="butlerTitle">${t('butler_title')}</h3>
      <div id="aiContent" class="ai-content">
        <div class="skeleton"><div style="height:10px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite"></div></div>
      </div>
      <div class="chips" id="aiChips"></div>`;
    wrap.appendChild(sec);
  }

  function buildButlerSystemPrompt(lang, topic=''){
    const headers = ['人物画像','关系与沟通','事业与自我实现','金钱与物质','今日/本周可执行清单','温柔提醒'];
    return [
      `You are "Xinlian Butler". OUTPUT LANGUAGE: ${lang==='ms'?'Malay':'Simplified Chinese'}. Reply strictly in that language.`,
      'Warm, practical, actionable. No medical/legal conclusions.',
      'Markdown structure:',
      `## ${headers[0]}`,
      `## ${headers[1]} (2–4 bullets)`,
      `## ${headers[2]} (2–4 bullets)`,
      `## ${headers[3]} (2–3 bullets)`,
      `## ${headers[4]} (3–5 bullets; start with verbs; quantify if possible)`,
      `## ${headers[5]}`,
      topic ? `Primary focus topic: ${topic}` : ''
    ].filter(Boolean).join('\n');
  }

  async function fetchWithRetry(endpoints, body, { retries=2, timeout=15000, backoffBase=700, signal }={}){
    let lastErr;
    for(const url of endpoints){
      for(let a=0; a<=retries; a++){
        const ctl = new AbortController();
        const timer = setTimeout(()=>ctl.abort('timeout'), timeout);
        const onAbort = ()=> ctl.abort('outer-abort');
        if(signal){ if(signal.aborted){ clearTimeout(timer); throw new DOMException('Aborted','AbortError'); } signal.addEventListener('abort', onAbort, { once:true }); }
        try{
          const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), signal: ctl.signal, cache:'no-store', credentials:'omit', keepalive:true });
          clearTimeout(timer); signal?.removeEventListener('abort', onAbort);
          if(res.ok) return res;
          if(!(res.status>=500 || res.status===429 || res.status===408)) throw new Error('HTTP '+res.status);
          await sleep(backoffBase*(a+1));
        }catch(err){ clearTimeout(timer); signal?.removeEventListener('abort', onAbort); lastErr=err; if(err?.name==='AbortError') throw err; if(a===retries) break; await sleep(backoffBase*(a+1)); }
      }
    }
    throw lastErr || new Error('All endpoints failed');
  }

  async function safeJson(res){ const ct=(res.headers.get('content-type')||'').toLowerCase(); if(ct.includes('application/json')) return res.json(); const txt=await res.text(); console.warn('[Butler] Non-JSON:', txt.slice(0,180)); throw new Error('Non-JSON response'); }

  function mdToHtml(md){ const safe = esc(md||''); return safe.replace(/^###?\s+(.*)$/gm,'<h3 style="margin:8px 0 4px;color:#f2d27a">$1<\/h3>').replace(/^\s*[-*]\s+(.*)$/gm,'• $1').replace(/\*\*(.+?)\*\*/g,'<b>$1<\/b>').replace(/\n{2,}/g,'\n\n').replace(/\n/g,'<br/>'); }

  function isVIP(){ return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail'); }

  function localButlerFallback(lang, sunName, el){
    const tips = (EL_TIPS[lang]||EL_TIPS['zh-CN'])[el]||[];
    return `
      <h3 style="margin:12px 0 6px;color:#f2d27a">人物画像</h3>
      <p>太阳星座：${sunName}</p>
      <h3 style="margin:12px 0 6px;color:#f2d27a">关系与沟通</h3>
      <p>• 先确认对方感受，再给建议。</p>
      <h3 style="margin:12px 0 6px;color:#f2d27a">事业与自我实现</h3>
      <p>• 本周只定一个事业优先项，并写出「完成定义」。</p>
      <h3 style="margin:12px 0 6px;color:#f2d27a">金钱与物质</h3>
      <p>• 建立每日金钱检视小仪式。</p>
      <h3 style="margin:12px 0 6px;color:#f2d27a">今日/本周可执行清单</h3>
      <p>• 今天为优先项预留 25 分钟专注时间。</p>
      <h3 style="margin:12px 0 6px;color:#f2d27a">温柔提醒</h3>
      <p>${tips.map(x=>'• '+x).join('<br>')}</p>`;
  }

  let aiAbort = null;
  async function runAI(topic=''){
    ensureAiCard();
    const out = gid('aiContent');
    const { name, place, date, time } = readForm();
    if(!date){ out && (out.innerHTML = `<div class="ai-content" style="color:#98a7b7">${t('alert_fill')}</div>`); return; }
    if(aiAbort){ aiAbort.abort(); aiAbort=null; }
    aiAbort = new AbortController(); const thisCall = aiAbort;
    const lang = getLang(); const sun = getSunSign(date); const sunName = (sun.name[lang]||sun.name['zh-CN']); const el = sun.el;
    out && (out.innerHTML = `<div class='skeleton'><div style='height:10px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite'></div></div>`);

    const sys = buildButlerSystemPrompt(lang, topic);
    const at = place ? (' @ '+place) : '';
    const usr = [`Name: ${name||'-'}`,`Birth: ${date} ${time||'12:00'}${at}`,`Sun sign: ${sunName} (element: ${el})`, topic?`Task: ${topic}`:`Task: 事业解读`].join('\n');

    try{
      if(OFFLINE_MODE) throw new Error('OFFLINE_MODE');
      const res = await fetchWithRetry(ENDPOINTS, { messages:[{role:'system',content:sys},{role:'user',content:usr}] }, { retries:2, timeout:15000, signal:thisCall.signal });
      if(thisCall.signal.aborted) return;
      const data = await safeJson(res); const raw = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      if(!raw) throw new Error('Empty');
      let html = mdToHtml(raw);
      if(!isVIP()){
        const parts = raw.split(/\n##\s+/); const header = parts.shift()||''; const kept = [header, ...(parts.slice(0,2).map(p=>'## '+p))].join('\n\n');
        html = mdToHtml(kept) + `
          <div class='ai-lock-overlay' style='position:static;margin-top:8px;padding-top:8px;border-top:1px solid #233145;text-align:center'>
            <div class='tip' style='color:#ffd88a;font-weight:700;margin-bottom:4px'>${t('vip_tip')}</div>
            <div class='sub' style='color:#9aa8b9;margin-top:4px'>${t('vip_sub')}</div>
            <a class='btn' href='https://yourshopifyshop.com/products/monthly-vip' target='_blank' rel='noopener'>${t('btn_unlock')}</a>
          </div>`;
      }
      out && (out.innerHTML = html);
    }catch(e){ if(e?.name==='AbortError') return; console.warn('[Butler] fallback:', e); out && (out.innerHTML = `<div class='ai-content'><div style='color:#ffd88a;font-weight:700;margin-bottom:6px'>${t('err_network')} / ${t('err_busy')}（本地离线解读）</div>${localButlerFallback(getLang(), sunName, el)}</div>`); }
    finally{ if(thisCall===aiAbort) aiAbort=null; }
  }

  /* ========================= 表单/流程 ========================= */
  function readForm(){ const name=(gid('name')?.value||'').trim(); const place=(gid('place')?.value||'').trim(); const date=gid('birthdate')?.value||''; const time=gid('birthtime')?.value||'12:00'; return { name, place, date, time }; }

  function renderHeaderSummary(model){ const s = gid('chartSummary'); if(!s) return; const at = model.place?(' @ '+model.place):''; s.textContent = `${model.name?model.name+' · ':''}${model.date} ${model.time}${at}`; }

  function renderOverview(model){ const wrap = gid('chartReport'); if(!wrap) return; const sign=getSunSign(model.date); const lang=getLang(); const signName=sign.name[lang]||sign.name['zh-CN']; const disclaimer='＊当前仅展示太阳星座示意；完整盘需使用出生地与精确时刻计算。';
    wrap.innerHTML = `<div class='sec'><h3>概览</h3><p>${esc(model.name||'')}${model.name?' · ':''}${model.date} ${model.time}${model.place?(' @ '+esc(model.place)) : ''}</p><p class='muted' style='opacity:.75'>${disclaimer}</p></div><div class='sec'><h3>太阳星座</h3><p>你的太阳在「${signName}」。</p></div><div class='sec'><h3>能量提示</h3><p>${(EL_TIPS[lang]||EL_TIPS['zh-CN'])[sign.el].map(x=>'• '+x).join('<br>')}</p></div>`; }

  function generateChart(){ const btn=gid('genBtn'); if(btn){ btn.disabled=true; setTimeout(()=>btn.disabled=false,800); }
    const model = readForm(); if(!model.date || !model.place){ alert(t('alert_fill')); return; }
    gid('result').style.display='block'; renderHeaderSummary(model); renderOverview(model); renderProNatalReport(model); ensureAiCard(); runAI(); }

  /* ========================= 右下角 Chat 悬浮球 ========================= */
  function mountChat(){ if(gid('ssChatFab')) return; const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title=t('butler_chat_title'); const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label',t('butler_chat_title')); chatPanel.setAttribute('aria-modal','true'); chatPanel.innerHTML = `<div class='ss-chat-head'><div class='ss-chat-title'>${t('butler_chat_title')}</div><div class='ss-close' id='ssChatClose'>✕</div></div><div class='ss-chat-body' id='ssChatBody' aria-live='polite'></div><div class='ss-chat-input'><input id='ssChatInput' type='text' placeholder='${t('chat_placeholder')}'/><button id='ssChatSend' class='btn'>${t('chat_send')}</button></div>`; document.body.appendChild(chatFab); document.body.appendChild(chatPanel); const $body=gid('ssChatBody'), $input=gid('ssChatInput'), $send=gid('ssChatSend'), $close=gid('ssChatClose'); const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); }; const closePanel=()=>{ chatPanel.style.display='none'; }; chatFab.textContent=t('chat_fab'); chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel); function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
    let chatAbort=null; async function askChat(prompt){ addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); } if(chatAbort){ chatAbort.abort(); chatAbort=null; } chatAbort=new AbortController(); const thisCall=chatAbort; const sys=[`You are "Xinlian Butler". OUTPUT LANGUAGE: ${getLang()==='ms'?'Malay':'Simplified Chinese'}.`,'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'].join('\n'); try{ if(OFFLINE_MODE) throw new Error('OFFLINE_MODE'); const res = await fetchWithRetry(ENDPOINTS, { messages:[ {role:'system',content:sys},{role:'user',content:prompt} ] }, { retries:2, timeout:15000, signal:thisCall.signal }); if(thisCall.signal.aborted) return; const data=await safeJson(res); const reply=data?.reply??data?.text??data?.choices?.[0]?.message?.content??''; addMsg(reply || t('err_busy')); }catch(e){ if(e?.name==='AbortError') return; addMsg(`${t('err_network')}，${t('err_busy')}（本地离线模式）`); }finally{ if(thisCall===chatAbort) chatAbort=null; } }
    $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); }); $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }}); }

  /* ========================= 登录区域：默认不展示账号字段 ========================= */
  function setupAuthVisibility(){ const fields=gid('authFields'); const loginBtn=gid('loginBtn'); const registerBtn=gid('registerBtn'); const resetBtn=gid('resetBtn'); if(!fields||!loginBtn||!registerBtn) return; function show(){ fields.style.display='grid'; }
    loginBtn.addEventListener('click', (e)=>{ if(fields.style.display==='none'){ e.preventDefault(); show(); } });
    registerBtn.addEventListener('click', (e)=>{ if(fields.style.display==='none'){ e.preventDefault(); show(); } });
    resetBtn?.addEventListener('click', ()=>{ fields.style.display='grid'; gid('authError').style.display='none'; }); }

  /* ========================= 初始化 ========================= */
  document.addEventListener('DOMContentLoaded', ()=>{
    // 默认日期：今天（仅空白时）
    if(gid('birthdate') && !gid('birthdate').value){ gid('birthdate').value = new Date().toISOString().split('T')[0]; }

    // 表单 submit：原生校验通过后再生成
    const form = gid('chartForm'); if(form){ form.addEventListener('submit', (e)=>{ e.preventDefault(); if(!form.reportValidity()) return; generateChart(); }); }

    // 语言切换后的文案刷新标题
    const $lang = gid('langSelect'); if($lang){ $lang.addEventListener('change', ()=>{ qs('[data-i18n="page_title"]').textContent = t('page_title'); gid('ssChatFab') && (gid('ssChatFab').textContent = t('chat_fab')); qs('.ss-chat-title') && (qs('.ss-chat-title').textContent = t('butler_chat_title')); }); }

    // 头部时钟
    startNowClock();

    // 右下角 Butler Chat
    mountChat();

    // 登录字段默认隐藏，点击按钮才显示（不泄露个人邮箱/密码）
    setupAuthVisibility();
  });
})();
</script>
</body>
</html>
