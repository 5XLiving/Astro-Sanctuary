<script>
(function(){
  'use strict';

  /* ============ 基础配置 ============ */
  const API_BASE   = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  const FREE_LIMIT = 1;  // 非 VIP 可免费使用 AI 次数

  /* ============ 小工具 ============ */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function scrollToAuth(){
    const el = document.querySelector('.astro-auth') || document.querySelector('[data-i18n="vip_title"]') || document.body;
    el.scrollIntoView({behavior:'smooth', block:'start'});
  }
  function showAuthErr(msg){ const e=$('#authError'); if(!e) return; e.textContent = msg; e.style.display='block'; setTimeout(()=> e.style.display='none', 5000); }
  function showToast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    t.style.cssText='position:fixed;left:50%;top:18px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;background:#0e1520;border:1px solid #2a3546;color:#e8edf3;z-index:9999';
    document.body.appendChild(t); setTimeout(()=>t.remove(),1800);
  }

  /* ============ 本地存储的认证状态 ============ */
  const AUTH_KEY = 'astro_auth_v1';
  function saveAuth({token,email,vip,expiresAt}){
    localStorage.setItem(AUTH_KEY, JSON.stringify({token,email,vip:!!vip,expiresAt:expiresAt||null,ts:Date.now()}));
    localStorage.setItem('vipEmail', email||'');
  }
  function loadAuth(){
    try{ return JSON.parse(localStorage.getItem(AUTH_KEY)||'{}'); }catch(_){ return {}; }
  }
  function clearAuth(){
    localStorage.removeItem(AUTH_KEY);
    localStorage.removeItem('vipEmail');
  }
  function isVIP(auth){
    if(!auth || !auth.token) return false;
    if(auth.expiresAt){ try{ if(new Date(auth.expiresAt).getTime() < Date.now()) return false; }catch(_){/* ignore */} }
    return !!auth.vip;
  }

  /* ============ 会员 UI ============ */
  function updateAuthUI(){
    const auth = loadAuth();
    const loggedIn = !!auth.token;
    // 状态条（如果不存在就插入）
    if(!$('#authStatus')){
      const host = document.querySelector('.astro-auth .panel .head') || document.querySelector('.astro-auth .head');
      if(host){ host.insertAdjacentHTML('afterend', `<div id="authStatus" class="muted" style="padding:10px 18px;border-bottom:1px solid rgba(212,175,55,.22)"></div>`); }
    }
    const status = $('#authStatus');
    if(status){
      if(loggedIn){
        status.innerHTML = `已登录：<b>${auth.email||'用户'}</b> · ${isVIP(auth)?'VIP ✅':'普通用户'}`;
      }else{
        status.textContent = '未登录';
      }
    }
    // 注入 / 显示退出按钮
    if(loggedIn && !$('#logoutBtn')){
      const box = document.querySelector('.astro-auth .panel .body') || document.querySelector('.astro-auth');
      if(box){
        const wrap = document.createElement('div');
        wrap.className = 'row one';
        wrap.innerHTML = `<div class="spacer"></div><button class="btn ghost" id="logoutBtn" type="button">退出登录</button>`;
        box.appendChild(wrap);
        $('#logoutBtn')?.addEventListener('click', ()=>{ clearAuth(); updateAuthUI(); showToast('已退出'); });
      }
    }
  }

  /* ============ 接口请求 ============ */
  async function apiLogin(email,password){
    const r = await fetch(API_BASE+'/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    return r.json();
  }
  async function apiRegister(email,password){
    const r = await fetch(API_BASE+'/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    return r.json();
  }
  async function apiReset(email,newPassword){
    const r = await fetch(API_BASE+'/api/reset',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword})});
    return r.json();
  }
  async function apiProfile(){
    const auth=loadAuth(); if(!auth.token) return {};
    const r = await fetch(API_BASE+'/api/profile',{headers:{'Authorization':'Bearer '+auth.token}});
    return r.json();
  }

  /* ============ 会员事件绑定 ============ */
  function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }

  $('#loginForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = $('#email')?.value.trim(); const password=$('#password')?.value.trim();
    if(!email||!password) return showAuthErr('请输入邮箱与密码');
    try{
      const data = await apiLogin(email,password);
      if(!data?.ok) {
        const map = {wrong_pwd:'密码错误', no_account:'账户不存在，请先注册'};
        return showAuthErr('登录失败：' + (map[data?.msg] || data?.msg || ''));
      }
      saveAuth({token:data.token||'token', email, vip: !!data.vip, expiresAt:data.expiresAt});
      updateAuthUI(); showToast('登录成功'); 
    }catch(err){ showAuthErr('登录失败：'+err.message); }
  });

  $('#registerForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = $('#email')?.value.trim(); const password=$('#password')?.value.trim();
    if(!email||!password) return showAuthErr('请输入邮箱与密码');
    if(!strongPwd(password)) return showAuthErr('密码至少 8 位，需包含大写/小写/数字/符号');
    try{
      const data = await apiRegister(email,password);
      if(!data?.ok) return showAuthErr('注册失败：' + (data?.msg||''));
      saveAuth({token:data.token||'token', email, vip: !!data.vip, expiresAt:data.expiresAt});
      updateAuthUI(); showToast('注册成功，已登录');
    }catch(err){ showAuthErr('注册失败：'+err.message); }
  });

  $('#resetBtn')?.addEventListener('click', async ()=>{
    const email = prompt('邮箱 Email') || '';
    if(!email) return showAuthErr('邮箱不能为空');
    const newPassword = prompt('新密码（至少8位，含大小写数字符号）') || '';
    if(!newPassword) return showAuthErr('密码不能为空');
    if(!strongPwd(newPassword)) return showAuthErr('密码至少 8 位，需包含大写/小写/数字/符号');
    try{
      const data = await apiReset(email,newPassword);
      if(!data?.ok) return showAuthErr('重设失败：' + (data?.msg||'')); 
      showToast('已更新密码，请用新密码登录');
    }catch(err){ showAuthErr('重设失败：'+err.message); }
  });

  // 启动时尝试刷新 VIP 状态（如果后端支持 /api/profile）
  (async ()=>{
    const auth=loadAuth();
    if(auth?.token){
      try{
        const prof = await apiProfile();
        if(prof?.ok){
          saveAuth({token:auth.token,email:prof.email||auth.email,vip:!!prof.vip,expiresAt:prof.expiresAt||auth.expiresAt});
        }
      }catch(_){}
    }
    updateAuthUI();
  })();

  /* ============ 基础报告（本地） & AI 智能解读（含会员门槛） ============ */

  // —— 太阳星座近似推断 —— //
  const SIGNS = [
    {k:'Aries', s:[3,21], e:[4,19], el:'fire',  n:{'zh-CN':'白羊座','zh-TW':'牡羊座','en':'Aries'}},
    {k:'Taurus',s:[4,20], e:[5,20], el:'earth', n:{'zh-CN':'金牛座','zh-TW':'金牛座','en':'Taurus'}},
    {k:'Gemini',s:[5,21], e:[6,21], el:'air',   n:{'zh-CN':'双子座','zh-TW':'雙子座','en':'Gemini'}},
    {k:'Cancer',s:[6,22], e:[7,22], el:'water', n:{'zh-CN':'巨蟹座','zh-TW':'巨蟹座','en':'Cancer'}},
    {k:'Leo',   s:[7,23], e:[8,22], el:'fire',  n:{'zh-CN':'狮子座','zh-TW':'獅子座','en':'Leo'}},
    {k:'Virgo', s:[8,23], e:[9,22], el:'earth', n:{'zh-CN':'处女座','zh-TW':'處女座','en':'Virgo'}},
    {k:'Libra', s:[9,23], e:[10,23],el:'air',   n:{'zh-CN':'天秤座','zh-TW':'天秤座','en':'Libra'}},
    {k:'Scorpio',s:[10,24],e:[11,22],el:'water',n:{'zh-CN':'天蝎座','zh-TW':'天蠍座','en':'Scorpio'}},
    {k:'Sagittarius',s:[11,23],e:[12,21],el:'fire',n:{'zh-CN':'射手座','zh-TW':'射手座','en':'Sagittarius'}},
    {k:'Capricorn',s:[12,22],e:[1,19],el:'earth',n:{'zh-CN':'摩羯座','zh-TW':'摩羯座','en':'Capricorn'}},
    {k:'Aquarius', s:[1,20], e:[2,18], el:'air',  n:{'zh-CN':'水瓶座','zh-TW':'水瓶座','en':'Aquarius'}},
    {k:'Pisces',   s:[2,19], e:[3,20], el:'water',n:{'zh-CN':'双鱼座','zh-TW':'雙魚座','en':'Pisces'}}
  ];
  function inRange(m,d,S,E){
    const [sm,sd]=S,[em,ed]=E;
    if(sm<em || (sm===em && sd<=ed)) return (m>sm||(m===sm&&d>=sd)) && (m<em||(m===em&&d<=ed));
    return (m>sm||(m===sm&&d>=sd)) || (m<em||(m===em&&d<=ed));
  }
  function getSunSign(dateStr){
    const dt=new Date(dateStr), m=dt.getMonth()+1, d=dt.getDate();
    return SIGNS.find(s=>inRange(m,d,s.s,s.e)) || SIGNS[11];
  }
  const EL_TIPS = {
    'zh-CN':{fire:'火元素偏旺：行动力强，先做后想更常见；给自己留个停顿更准。',
             earth:'土元素偏旺：务实细致；别被完美卡住，先上路再优化。',
             air:'风元素偏旺：想法多善沟通；控制信息过载，用“落地清单”。',
             water:'水元素偏旺：感受力强；写下来或动起来，让情绪流动。'}
  };

  function renderBase({name,date,time,place,lang}){
    const sign=getSunSign(date);
    const signName=sign.n[lang]||sign.n['zh-CN'];
    const tips=EL_TIPS['zh-CN'][sign.el];
    const disclaimer='* 演示：仅按日期推太阳星座，非完整本命盘。';
    const box=$('#chartReport');
    box.innerHTML = `
      <div class="sec"><h3>概览</h3>
        <p>${name?name+' · ':''}${date} ${time} @ ${place}</p>
        <p class="muted">${disclaimer}</p></div>
      <div class="sec"><h3>太阳星座</h3>
        <p>你的太阳在「${signName}」。</p></div>
      <div class="sec"><h3>能量提示</h3>
        <p>${tips}</p></div>`;
    return {signKey:sign.k, signName, element:sign.el, tips};
  }

  // 极简 Markdown -> HTML
  function mdToHtml(md){
    return md
      .replace(/^###?\s+(.*)$/gm,'<h3>$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }

  // AI 次数控制
  function canUseAI(){
    const auth = loadAuth();
    if(isVIP(auth)) return true;
    const used = +(localStorage.getItem('ai_used')||0);
    return used < FREE_LIMIT;
  }
  function incrAI(){
    const used = +(localStorage.getItem('ai_used')||0) + 1;
    localStorage.setItem('ai_used', used);
  }

  async function runAI(payload){
    const el=$('#aiContent');
    $('#aiCard').style.display='block';

    // 门槛检查
    if(!canUseAI()){
      el.innerHTML = `<div class="muted">免费智能解读额度已用完。登录/升级 VIP 可继续使用无限次。</div>
      <div style="margin-top:10px"><button class="btn" id="gotoVip">去登录/升级</button></div>`;
      $('#gotoVip')?.addEventListener('click', scrollToAuth);
      return;
    }

    el.innerHTML = `<div class="skeleton">
      <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
      <div style="width:70%"></div><div style="width:50%"></div></div>`;

    const auth = loadAuth();
    const headers = {'Content-Type':'application/json'};
    if(auth?.token) headers['Authorization'] = 'Bearer '+auth.token;

    const system = [
`你是「心怜管家」，一位温柔、务实、可操作的占星/灵性向生活教练。
- 资料来源：仅有【太阳星座】【元素倾向】及用户填写的信息。不要臆造上升、宫位、相位等。
- 语气：温柔、有画面；每段落给“可执行一步”。
- 输出 Markdown（中文）。结构：
  ## 人物画像（1 段）
  ## 关系与沟通（2-4 条）
  ## 事业与自我实现（2-4 条）
  ## 金钱与物质（2-3 条）
  ## 今日/本周可执行清单（3-5 条，动词开头，尽量量化）
  ## 温柔提醒（1 段）
- 避免医疗/法律结论。`
    ].join('\n');

    const user = `用户信息：
- 姓名：${payload.name||'（未填）'}
- 出生：${payload.date} ${payload.time} @ ${payload.place}
- 太阳星座：${payload.signName}（元素：${payload.element}）
- 元素提示：${payload.tips}
请给出人性化、务实且可落地的建议。`;

    try{
      const r = await fetch(API_BASE + '/api/chat', {
        method:'POST', headers,
        body: JSON.stringify({messages:[
          {role:'system', content: system},
          {role:'user',   content: user}
        ]})
      });
      const data = await r.json().catch(()=>({}));
      const txt = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '（暂无回复）';
      el.innerHTML = mdToHtml(txt);

      // 只有非 VIP 才计数
      if(!isVIP(auth)) incrAI();

    }catch(e){
      el.innerHTML = `<div class="muted">网络异常：${e.message}</div>`;
    }
  }

  // 生成报告 + 触发 AI
  function getLang(){ return ($('#langSelect')?.value)||'zh-CN'; }
  function generate(){
    const name=$('#name').value.trim();
    const place=$('#place').value.trim();
    const d=$('#birthdate').value;
    const t=$('#birthtime').value || '12:00';
    if(!d || !place){ alert('请补全“日期/地点”。（时间留空默认 12:00）'); return; }
    $('#chartSummary').textContent = `${name?name+' · ':''}${d} ${t} @ ${place}`;
    $('#result').style.display='block';
    const base = renderBase({name,date:d,time:t,place,lang:getLang()});
    runAI({name, date:d, time:t, place, lang:getLang(), ...base});
  }
  function fillDemo(){
    $('#name').value='Avery';
    $('#gender').value='u';
    $('#place').value='Singapore';
    $('#birthdate').value='1978-02-21';
    $('#birthtime').value='12:45';
    generate();
  }

  $('#genBtn')?.addEventListener('click', generate);
  $('#demoBtn')?.addEventListener('click', fillDemo);

  // 芯片追问（若超额则引导去会员）
  document.addEventListener('click', e=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    if(!canUseAI()){ $('#aiContent').innerHTML = `<div class="muted">免费额度已用完，登录/升级 VIP 即可继续追问。</div><div style="margin-top:10px"><button class="btn" id="gotoVip2">去登录/升级</button></div>`; $('#gotoVip2')?.addEventListener('click', scrollToAuth); return; }
    const q = chip.getAttribute('data-q') || chip.textContent;
    const ai = $('#aiContent');
    ai.innerHTML += `<br/><br/><b>你：</b>${q}<br/>`;
    const auth = loadAuth();
    const headers = {'Content-Type':'application/json'}; if(auth?.token) headers['Authorization']='Bearer '+auth.token;
    fetch(API_BASE+'/api/chat',{
      method:'POST',headers,
      body: JSON.stringify({messages:[
        {role:'system',content:'你是心怜管家，请承接上文，延续语气与格式，直接给出补充解读或更细的执行建议（中文 Markdown）。'},
        {role:'user',content:q}
      ]})
    }).then(r=>r.json()).then(data=>{
      const txt=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '…';
      ai.innerHTML += mdToHtml('\n\n'+txt);
      const auth2=loadAuth(); if(!isVIP(auth2)) incrAI();
    }).catch(err=>{
      ai.innerHTML += `<div class="muted">网络异常：${err.message}</div>`;
    });
  });

  // 默认日期：今天
  const bd=$('#birthdate'); if(bd && !bd.value){ bd.value=new Date().toISOString().split('T')[0]; }

})();
</script>
