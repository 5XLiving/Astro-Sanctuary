<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* 保持你的原有样式，并修复/补全少量细节 */
:root{
  --bg:#0b0f14;
  --bg-accent:#0e1520;
  --card:#11161dcc;
  --surface:#0f1624;
  --line:#1f2a36;
  --text:#e8edf3;
  --muted:#98a7b7;

  --brand:#d4af37;
  --gold:#d4af37;
  --gold2:#f2d27a;
  --accent:#58b9ff;

  --radius:14px;
  --radius-sm:10px;
  --radius-lg:18px;

  --shadow:0 8px 30px rgba(0,0,0,.35);
  --shadow-sm:0 4px 14px rgba(0,0,0,.28);

  --container:1100px;
  --gap:12px;
  --pad:18px;

  /* 修复：添加正确的focus变量 */
  --focus: 0 0 0 2px rgba(212,175,55,0.2);

  /* 仅供注释说明：媒体查询仍用固定数值写 */
  --bp-s:520px;
  --bp-m:760px;
  --bp-l:900px;
}

/* Reset + base */
*,
*::before,
*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
    linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}

.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}

.site-header{
  position:sticky; top:0; z-index:10;
  background:rgba(11,15,20,.8);
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:var(--shadow-sm);
  font-weight:800; color:#ffe084
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}

.lang{display:flex; align-items:center; gap:8px}
.lang select{
  appearance:none; min-width:140px;
  border-radius:10px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:10px 34px 10px 12px; font-size:0.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

.section{margin-top:18px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  padding:var(--pad);
  margin:16px 0;
}
.h2{
  font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084;
  display:flex; gap:8px; align-items:center
}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}

.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width: 760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row.cols-2{grid-template-columns:1fr 1fr}
}

input,select{
  width:100%;
  border-radius:12px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:12px 12px; font-size:15px; outline:0;
}
input::placeholder{color:#6f8092}
input:focus, select:focus{box-shadow:var(--focus); border-color:#3a4c63}

.btn{
  display:inline-grid; place-items:center;
  padding:12px 16px; border-radius:12px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919; font-weight:800; cursor:pointer;
  transition:transform .2s ease, box-shadow .2s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}

.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width: 520px){
  .pillars{grid-template-columns:repeat(2,1fr)}
}

.bazi-table{
  width:100%; border-collapse:collapse; margin-top:12px;
  background:var(--surface); border-radius:8px; overflow:hidden
}
.bazi-table th,.bazi-table td{
  padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle
}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
/* 小屏表格可横向滚动：把 table 用 div 包一层 .bazi-table-wrap 即可 */
.bazi-table-wrap{overflow:auto}
@media (max-width: 420px){
  .bazi-table th,.bazi-table td{padding:8px 10px}
}

.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:60px 1fr 60px; gap:10px; align-items:center}

.error-message{
  background:rgba(255,90,95,.1);
  border:1px solid #ff5a5f; border-radius:8px;
  padding:10px; display:none; margin-top:10px
}
.badge-warn{display:inline-block; padding:2px 8px; margin-left:6px; border:1px solid #ffb84d; border-radius:999px; color:#ffb84d; font-size:0.82rem}
.muted{color:var(--muted)}

.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}

.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}

.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.rating{display:flex; align-items:center; gap:8px; margin:8px 0}
.rating-stars{color:var(--gold2)}
.tag{display:inline-block; background:rgba(212,175,55,.1); color:var(--gold2); padding:4px 8px; border-radius:6px; font-size:0.85rem; margin:2px}

.luck-grid{display:grid; gap:10px}
.luck-item{background:rgba(255,255,255,.05); border-radius:8px; padding:12px; border-left:3px solid var(--gold2)}
.luck-year{font-weight:700; color:var(--gold2)}
.luck-desc{font-size:0.9rem; margin-top:4px}

.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width: 900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
  border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)
}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

.ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0}
.ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px}
.ai-box-c{color:#e8edf3; line-height:1.7}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
.chip{padding:6px 10px; border-radius:999px; border:1px solid #2a3546; background:#0e1520; color:#e8edf3; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease}
.chip:hover{border-color:#f2d27a; box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
.chip:disabled{opacity:.6; cursor:not-allowed}

.skeleton{display:grid; gap:8px}
.skeleton div{height:12px; border-radius:6px; background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431); animation:sh 1.2s infinite}
@keyframes sh{0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5}}

.ai-lock-overlay{margin-top:10px; padding-top:10px; border-top:1px solid #1f2a36; text-align:center}
.ai-lock-overlay .tip{color:#ffd88a; font-weight:700; margin-bottom:4px}
.ai-lock-overlay .sub{color:var(--muted)}

.detail-view{display:none}
.detail-header{display:flex; align-items:center; gap:12px; margin-bottom:20px}
.back-btn{background:rgba(212,175,55,.1); border:1px solid rgba(212,175,55,.3); color:var(--gold2); padding:8px 16px; border-radius:8px; cursor:pointer}
.detail-content{line-height:1.8}
.detail-section{margin-bottom:24px}
.detail-section h4{color:var(--gold2); margin-bottom:12px; font-size:1.1rem}
.action-list{list-style:none; padding:0; margin:0}
.action-list li{margin-bottom:8px; padding-left:20px; position:relative}
.action-list li::before{content:"•"; color:var(--gold2); position:absolute; left:0; top:0}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}

/* Motion 优化 */
@media (prefers-reduced-motion: reduce){
  *{animation:none !important; transition:none !important}
}

/* Utilities */
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
.chips-container{display:flex; flex-wrap:wrap; gap:8px; margin:20px 0; justify-content:center}

/* VIP section demo 可见 */
.vip-section{display:block !important}

/* Butler 组件 */
.butler-professional{display:none; margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:20px}
.butler-header{display:flex; align-items:center; gap:10px; margin-bottom:20px; color:var(--gold2); font-size:1.2rem; font-weight:700}
.butler-content{line-height:1.8; max-height:600px; overflow-y:auto; padding:15px; background:var(--surface); border-radius:10px; border:1px solid #253245}
.butler-section{margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #253245}
.butler-section h4{color:var(--gold2); margin-bottom:10px; font-size:1.1rem}
.butler-chat{margin-top:20px; border-top:1px solid var(--line); padding-top:15px}
.chat-messages{height:200px; overflow-y:auto; margin-bottom:15px; padding:10px; background:var(--surface); border-radius:8px; border:1px solid #253245}
.chat-input-area{display:flex; gap:10px}
.chat-input-area input{flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3}
.chat-send-btn{padding:10px 20px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer}

/* ==== remove the brown/gold focus outline ==== */
input:focus,
select:focus,
textarea:focus{
  outline: none !important;
  box-shadow: none !important;
  border-color: #243244 !important;
}
button:focus,
.btn:focus,
a:focus{
  outline: none !important;
  box-shadow: none !important;
}

/* (optional) also remove tap highlight on mobile */
*{ -webkit-tap-highlight-color: transparent; }    
.chip:hover{ border-color:#2a3546; box-shadow:none; }

/* 浮窗聊天样式 */
.chat-float {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  z-index: 1000;
  display: none;
  flex-direction: column;
}

.chat-float-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--line);
  background: rgba(212,175,55,.1);
  color: var(--gold2);
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
}

.chat-float-close {
  background: none;
  border: none;
  color: var(--gold2);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
}

.chat-float-close:hover {
  background: rgba(212,175,55,.2);
}

.chat-float-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0;
}

.chat-float-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  background: var(--surface);
}

.chat-float-input-area {
  padding: 12px;
  border-top: 1px solid var(--line);
  background: var(--bg-accent);
}

.chat-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(180deg,#fff9e6,#e6c76e);
  border: 1px solid #e6c76e;
  color: #191919;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(230,199,110,.3);
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-toggle-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(230,199,110,.5);
}

/* 响应式调整 */
@media (max-width: 768px) {
  .chat-float {
    width: 300px;
    height: 400px;
    bottom: 10px;
    right: 10px;
  }
  
  .chat-toggle-btn {
    width: 50px;
    height: 50px;
    bottom: 10px;
    right: 10px;
  }
}    
</style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com/" target="_self">
        <span class="brand-badge">5X</span>
      <span class="title" data-i18n="brand.subtitle">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="nav.langLabel">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN" data-i18n="lang.zh-CN">简体中文</option>
        <option value="zh-TW" data-i18n="lang.zh-TW">繁體中文</option>
        <option value="en"    data-i18n="lang.en">English</option>
        <option value="ja"    data-i18n="lang.ja">日本語</option>
        <option value="th"    data-i18n="lang.th">ไทย</option>
        <option value="ms"    data-i18n="lang.ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2" data-i18n="app.title">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="form.nameLabel">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted" data-i18n="form.genderLabel">性别</label>
        <select id="gender">
          <option value=""        data-i18n="form.gender.hidden">不透露</option>
          <option value="male"    data-i18n="form.gender.male">男性</option>
          <option value="female"  data-i18n="form.gender.female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="form.calendarLabel">历法</label>
        <select id="calendar">
          <option value="gregorian" data-i18n="form.calendar.gregorian">阳历</option>
          <option value="lunar"     data-i18n="form.calendar.lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="form.birthdateLabel">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted" data-i18n="form.birthtimeLabel">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span data-i18n="form.timeUnknown">出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText" data-i18n="btn.generate">生成八字</span>
          <span id="genBtnLoading" style="display:none" data-i18n="btn.loading">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

<section id="result" style="display:none;">
    <div class="card">
      <div class="h2" data-i18n="result.title">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>
     
      <table class="bazi-table">
        <thead>
          <tr>
            <th></th>
            <th data-i18n="pillar.year">年柱</th>
            <th data-i18n="pillar.month">月柱</th>
            <th data-i18n="pillar.day">日柱</th>
            <th data-i18n="pillar.hour">时柱</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td data-i18n="table.row.stem">天干</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.branch">地支</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.fiveElem">五行</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.nayin">纳音</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2" data-i18n="energy.title">五行能量分析</div>
      <div class="bar-row"><span data-i18n="elem.wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted"></div>
    </div>
  </section>

  <section id="butlerProfessional" class="butler-professional">
    <div class="butler-header">
      <span data-i18n="pro.title">🧙‍♂️ 心怜管家 · 专业命理分析</span>
    </div>
    <div class="butler-content" id="professionalReport"></div>
</section>
    
<!-- 浮窗聊天按钮 -->
<button class="chat-toggle-btn" id="chatToggle" data-i18n="chat.toggle">问</button>

<!-- 浮窗聊天窗口 -->
<div class="chat-float" id="chatFloat">
  <div class="chat-float-header">
    <span data-i18n="pro.title">🧙‍♂️ 心怜管家 · 专业命理分析</span>
    <button class="chat-float-close" id="chatClose">×</button>
  </div>
  <div class="chat-float-body">
    <div class="chat-float-messages" id="chatMessages">
      <div class="ss-msg" data-i18n="pro.welcome">您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。</div>
    </div>
    <div class="chat-float-input-area">
      <div style="display: flex; gap: 8px;">
        <input type="text" id="chatInput" placeholder="请输入您的问题..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #253245; background: #0e1520; color: #e8edf3;">
        <button class="chat-send-btn" id="chatSend" data-i18n="chat.send" style="padding: 10px 16px; background: var(--gold); color: #191919; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">发送</button>
      </div>
    </div>
  </div>
</div>  

  <section class="card section vip-section">
    <h2 class="group-title" data-i18n="vip.title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip.group.astrology">🗝 命理空间专属内容</div>
        <ul>
          <li data-i18n="vip.astrology.match">姻缘方向：恋爱缘分、婚姻走势</li>
          <li data-i18n="vip.astrology.career">事业方向：职场发展、创业潜力</li>
          <li data-i18n="vip.astrology.wealth">财运方向：财位分析、理财时机</li>
          <li data-i18n="vip.astrology.pet">宠物命理：伴侣动物的性格与缘分</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip.group.spiritual">🌙 心怜空间专属内容</div>
        <ul>
          <li data-i18n="vip.spiritual.record">灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li data-i18n="vip.spiritual.courses">命理课程：八字 / 塔罗 / 占星 / 灵数</li>
          <li data-i18n="vip.spiritual.family">家族纪念系统：亲人灵性纪念 & 延续</li>
          <li data-i18n="vip.spiritual.practice">每周能量练习 / 神明仪式任务</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="vip.login.title">💎 登入 VIP 功能</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <div class="panel">
          <div class="head" data-i18n="auth.header">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="邮箱 Email">
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="密码 Password（至少8位，含大小写数字符号）">
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="auth.login">登入账户</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="auth.reset">🔑 重设密码</button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="auth.register">注册账户</button>
              <div class="muted" data-i18n="auth.freeTrialNote">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <div class="panel">
          <div class="head" data-i18n="vip.services.header">会员服务</div>
          <div class="body">
            <div class="row one">
              <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="vip.upgrade">💎 升级为 VIP（月费）</a>
            </div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="vip.back">← 返回命理商城</a>
            </div>
            <div class="muted" data-i18n="vip.priceNote">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer data-i18n="footer.copy">© 5XLiving • Astro Sanctuary</footer>
</main>
  
<script>window.API_BASE='https://throbbing-lab-1440.hello5xliving.workers.dev';</script>
<script>
/*!
 * 5XLiving · Bazi Quick Chart - MULTI-LANGUAGE VERSION
 */
(() => {
  'use strict';

  const CONFIG = {
    API_BASE: '' // 使用本地计算
  };

  // 完整的多语言字典
  const I18N = {
    'zh-CN': {
      brand: { subtitle: '5xLiving · 八字简评' },
      nav: { langLabel: '语言' },
      lang: { 
        'zh-CN':'简体中文',
        'zh-TW':'繁體中文',
        'en':'English',
        'ja':'日本語', 
        'th':'ไทย',
        'ms':'Bahasa Melayu'
      },
      app: { title: '八字命理 · 快速排盘' },
      form: {
        nameLabel: '姓名（可选）',
        namePlaceholder: '你的称呼（用于个性化）',
        genderLabel: '性别',
        gender: { hidden:'不透露', male:'男性', female:'女性' },
        calendarLabel: '历法',
        calendar: { gregorian:'阳历', lunar:'农历' },
        birthdateLabel: '出生日期',
        birthtimeLabel: '出生时间',
        timeUnknown: '出生时间不详'
      },
      btn: { generate: '生成八字', loading: '计算中...' },
      result: { title: '您的生辰八字命盘' },
      pillar: { year:'年柱', month:'月柱', day:'日柱', hour:'时柱' },
      table: { 
        row: { stem:'天干', branch:'地支', fiveElem:'五行', nayin:'纳音' }
      },
      energy: { title: '五行能量分析' },
      elem: { wood: '木', fire: '火', earth: '土', metal: '金', water: '水' },
      pro: { 
        title: '🧙‍♂️ 心怜管家 · 专业命理分析', 
        welcome: '您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。'
      },
      chat: { send: '发送', placeholder: '请输入您的问题...', toggle: '问' },
      vip: {
        title: '🌙 会员区域 VIP Segment',
        group: { astrology:'🗝 命理空间专属内容', spiritual:'🌙 心怜空间专属内容' },
        astrology: { 
          match:'姻缘方向：恋爱缘分、婚姻走势', 
          career:'事业方向：职场发展、创业潜力', 
          wealth:'财运方向：财位分析、理财时机', 
          pet:'宠物命理：伴侣动物的性格与缘分'
        },
        spiritual: { 
          record:'灵性记录：照片、梦境、声音、愿望祈祷', 
          courses:'命理课程：八字 / 塔罗 / 占星 / 灵数', 
          family:'家族纪念系统：亲人灵性纪念 & 延续', 
          practice:'每周能量练习 / 神明仪式任务'
        },
        login: { title: '💎 登入 VIP 功能' },
        services: { header: '会员服务' },
        upgrade: '💎 升级为 VIP（月费）',
        back: '← 返回命理商城',
        priceNote: '$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）'
      },
      auth: {
        header: '账户登录 / 注册',
        login: '登入账户',
        reset: '🔑 重设密码',
        register: '注册账户',
        freeTrialNote: '注册账号赠送一次免费体验',
        emailPlaceholder: '邮箱 Email',
        passwordPlaceholder: '密码 Password（至少8位，含大小写数字符号）'
      },
      footer: { copy: '© 5XLiving • Astro Sanctuary' },
      err: {
        fillBirthdate: '请填写出生日期',
        invalidDate: '无效的日期格式，请用 YYYY-MM-DD',
        generateFail: '生成失败，请稍后重试'
      },
      ui: {
        unknown: '未知',
        timeUnknown: '时间不详',
        hourSuffix: '{h}时',
        birthSummary: '出生日期: {y}年{m}月{d}日 {timeText}',
        balance: '五行中{strongest}最强，{weakest}最弱。'
      },
      badge: { noHour: '未纳入时柱' },
      chatDyn: { autoReply: '收到：{q}。稍后可在专业报告相应章节找到要点。' },
      elemNames: { 木:'木', 火:'火', 土:'土', 金:'金', 水:'水' },
      report: { 
        hourUnknownTip: '⚠️ 提示：因出生时间不详，部分分析仅供参考。',
        tipTitle: '提示',
        generating: '正在生成专业分析报告...',
        failed: '报告生成失败，请稍后重试'
      },
      // 专业报告内容
      reportTitles: {
        overview: '📊 命盘总览',
        fiveElements: '🌿 五行分析',
        tenGods: '⚡ 十神配置',
        relationship: '💕 感情婚姻',
        career: '💼 事业发展',
        wealth: '💰 财运分析',
        health: '🌡️ 健康养生',
        nearTerm: '🔮 近期运势'
      },    
      report: {
        errorTitle: '提示',
        noContent: '未获取到报告内容',
        hourUnknownTip: '⚠️ 提示：因出生时间不详，部分分析仅供参考。',
        tipTitle: '提示'
      },
      reportLabels: {
        dayMaster: '日主命理',
        strength: '日主强弱',
        usefulSpirit: '喜用神',
        elementCount: '五行个数',
        elementStrength: '五行旺衰',
        supportElements: '帮扶五行',
        restrainElements: '克泄五行',
        missingElements: '五行所缺',
        traits: '感情特质',
        marriageAdvice: '婚姻建议',
        relationshipTips: '相处之道',
        suitableCareers: '适合行业',
        careerAdvice: '发展建议',
        favorableDirections: '有利方位',
        wealthCharacteristics: '财运特点',
        wealthDirections: '求财方向',
        financialAdvice: '理财建议',
        healthCharacteristics: '体质特点',
        healthTips: '注意事项',
        wellnessAdvice: '养生建议',
        overallFortune: '整体运势',
        favorableTiming: '有利时机',
        cautions: '注意事项'
      }
    },
// zh-TW 繁體中文
'zh-TW': {
  brand: { subtitle: '5xLiving · 八字簡評' },
  nav: { langLabel: '語言' },
  lang: { 
    'zh-CN':'簡體中文',
    'zh-TW':'繁體中文',
    'en':'English',
    'ja':'日本語', 
    'th':'ไทย',
    'ms':'Bahasa Melayu'
  },
  app: { title: '八字命理 · 快速排盤' },
  form: {
    nameLabel: '姓名（可選）',
    namePlaceholder: '你的稱呼（用於個性化）',
    genderLabel: '性別',
    gender: { hidden:'不透露', male:'男性', female:'女性' },
    calendarLabel: '曆法',
    calendar: { gregorian:'陽曆', lunar:'農曆' },
    birthdateLabel: '出生日期',
    birthtimeLabel: '出生時間',
    timeUnknown: '出生時間不詳'
  },
  btn: { generate: '生成八字', loading: '計算中...' },
  result: { title: '您的生辰八字命盤' },
  pillar: { year:'年柱', month:'月柱', day:'日柱', hour:'時柱' },
  table: { 
    row: { stem:'天干', branch:'地支', fiveElem:'五行', nayin:'納音' }
  },
  energy: { title: '五行能量分析' },
  elem: { wood: '木', fire: '火', earth: '土', metal: '金', water: '水' },
  pro: { 
    title: '🧙‍♂️ 心憐管家 · 專業命理分析', 
    welcome: '您好！我是您的專業命理顧問，已為您生成詳細分析報告。有什麼具體問題可以隨時問我。'
  },
  chat: { send: '發送', placeholder: '請輸入您的問題...', toggle: '問' },
  vip: {
    title: '🌙 會員區域 VIP Segment',
    group: { astrology:'🗝 命理空間專屬內容', spiritual:'🌙 心憐空間專屬內容' },
    astrology: { 
      match:'姻緣方向：戀愛緣分、婚姻走勢', 
      career:'事業方向：職場發展、創業潛力', 
      wealth:'財運方向：財位分析、理財時機', 
      pet:'寵物命理：伴侶動物的性格與緣分'
    },
    spiritual: { 
      record:'靈性記錄：照片、夢境、聲音、願望祈禱', 
      courses:'命理課程：八字 / 塔羅 / 占星 / 靈數', 
      family:'家族紀念系統：親人靈性紀念 & 延續', 
      practice:'每週能量練習 / 神明儀式任務'
    },
    login: { title: '💎 登入 VIP 功能' },
    services: { header: '會員服務' },
    upgrade: '💎 升級為 VIP（月費）',
    back: '← 返回命理商城',
    priceNote: '$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）'
  },
  auth: {
    header: '賬戶登錄 / 註冊',
    login: '登入賬戶',
    reset: '🔑 重設密碼',
    register: '註冊賬戶',
    freeTrialNote: '註冊賬號贈送一次免費體驗',
    emailPlaceholder: '郵箱 Email',
    passwordPlaceholder: '密碼 Password（至少8位，含大小寫數字符號）'
  },
  footer: { copy: '© 5XLiving • Astro Sanctuary' },
  err: {
    fillBirthdate: '請填寫出生日期',
    invalidDate: '無效的日期格式，請用 YYYY-MM-DD',
    generateFail: '生成失敗，請稍後重試'
  },
  ui: {
    unknown: '未知',
    timeUnknown: '時間不詳',
    hourSuffix: '{h}時',
    birthSummary: '出生日期: {y}年{m}月{d}日 {timeText}',
    balance: '五行中{strongest}最強，{weakest}最弱。'
  },
  badge: { noHour: '未納入時柱' },
  chatDyn: { autoReply: '收到：{q}。稍後可在專業報告相應章節找到要點。' },
  elemNames: { 木:'木', 火:'火', 土:'土', 金:'金', 水:'水' },
  report: { 
    hourUnknownTip: '⚠️ 提示：因出生時間不詳，部分分析僅供參考。',
    tipTitle: '提示',
    generating: '正在生成專業分析報告...',
    failed: '報告生成失敗，請稍後重試'
  },
  reportTitles: {
    overview: '📊 命盤總覽',
    fiveElements: '🌿 五行分析',
    tenGods: '⚡ 十神配置',
    relationship: '💕 感情婚姻',
    career: '💼 事業發展',
    wealth: '💰 財運分析',
    health: '🌡️ 健康養生',
    nearTerm: '🔮 近期運勢'
  },
  reportLabels: {
    dayMaster: '日主命理',
    strength: '日主強弱',
    usefulSpirit: '喜用神',
    elementCount: '五行個數',
    elementStrength: '五行旺衰',
    supportElements: '幫扶五行',
    restrainElements: '剋泄五行',
    missingElements: '五行所缺',
    traits: '感情特質',
    marriageAdvice: '婚姻建議',
    relationshipTips: '相處之道',
    suitableCareers: '適合行業',
    careerAdvice: '發展建議',
    favorableDirections: '有利方位',
    wealthCharacteristics: '財運特點',
    wealthDirections: '求財方向',
    financialAdvice: '理財建議',
    healthCharacteristics: '體質特點',
    healthTips: '注意事項',
    wellnessAdvice: '養生建議',
    overallFortune: '整體運勢',
    favorableTiming: '有利時機',
    cautions: '注意事項'
  }
},

// en English
'en': {
  brand: { subtitle: '5xLiving · Bazi Brief' },
  nav: { langLabel: 'Language' },
  lang: { 
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese', 
    'en':'English',
    'ja':'Japanese',
    'th':'Thai',
    'ms':'Malay'
  },
  app: { title: 'Bazi Destiny · Quick Chart' },
  form: {
    nameLabel: 'Name (optional)',
    namePlaceholder: 'Your name (for personalization)',
    genderLabel: 'Gender',
    gender: { hidden:'Prefer not to say', male:'Male', female:'Female' },
    calendarLabel: 'Calendar',
    calendar: { gregorian:'Solar', lunar:'Lunar' },
    birthdateLabel: 'Birth Date',
    birthtimeLabel: 'Birth Time',
    timeUnknown: 'Time unknown'
  },
  btn: { generate: 'Generate Bazi', loading: 'Calculating...' },
  result: { title: 'Your Bazi Destiny Chart' },
  pillar: { year:'Year', month:'Month', day:'Day', hour:'Hour' },
  table: { 
    row: { stem:'Heavenly Stem', branch:'Earthly Branch', fiveElem:'Elements', nayin:'Nayin' }
  },
  energy: { title: 'Five Elements Analysis' },
  elem: { wood: 'Wood', fire: 'Fire', earth: 'Earth', metal: 'Metal', water: 'Water' },
  pro: { 
    title: '🧙‍♂️ Butler · Professional Analysis', 
    welcome: 'Hello! I am your professional destiny advisor. I have generated a detailed analysis report for you. Feel free to ask me any specific questions.'
  },
  chat: { send: 'Send', placeholder: 'Type your question...', toggle: 'Ask' },
  vip: {
    title: '🌙 VIP Members Area',
    group: { astrology:'🗝 Exclusive Astrology', spiritual:'🌙 Spiritual Space' },
    astrology: { 
      match:'Relationships: Love & Marriage', 
      career:'Career: Workplace & Entrepreneurship', 
      wealth:'Wealth: Analysis & Timing', 
      pet:'Pet Astrology: Personality & Bond'
    },
    spiritual: { 
      record:'Spiritual Records: Photos, Dreams, Voice, Prayers', 
      courses:'Courses: Bazi / Tarot / Astrology / Numerology', 
      family:'Family Memorial System', 
      practice:'Weekly Practices / Rituals'
    },
    login: { title: '💎 VIP Login' },
    services: { header: 'Membership Services' },
    upgrade: '💎 Upgrade to VIP (Monthly)',
    back: '← Back to Store',
    priceNote: '$9.9 / Month VIP (Astrology + Spiritual + Courses)'
  },
  auth: {
    header: 'Login / Register',
    login: 'Sign In',
    reset: '🔑 Reset Password',
    register: 'Register',
    freeTrialNote: 'Free trial for new accounts',
    emailPlaceholder: 'Email',
    passwordPlaceholder: 'Password (min 8 chars, mixed case & symbols)'
  },
  footer: { copy: '© 5XLiving • Astro Sanctuary' },
  err: {
    fillBirthdate: 'Please enter birth date',
    invalidDate: 'Invalid date format, use YYYY-MM-DD',
    generateFail: 'Generation failed, please try again later'
  },
  ui: {
    unknown: 'Unknown',
    timeUnknown: 'Time unknown',
    hourSuffix: '{h}:00',
    birthSummary: 'Birth: {y}-{m}-{d} {timeText}',
    balance: '{strongest} strongest, {weakest} weakest among elements.'
  },
  badge: { noHour: 'Hour pillar excluded' },
  chatDyn: { autoReply: 'Received: {q}. Key points will be in relevant report sections.' },
  elemNames: { 木:'Wood', 火:'Fire', 土:'Earth', 金:'Metal', 水:'Water' },
  report: { 
    hourUnknownTip: '⚠️ Note: Birth time unknown; analysis for reference only.',
    tipTitle: 'TIP',
    generating: 'Generating professional analysis...',
    failed: 'Report generation failed, please try again later'
  },
  reportTitles: {
    overview: '📊 Chart Overview',
    fiveElements: '🌿 Elements Analysis',
    tenGods: '⚡ Ten Gods',
    relationship: '💕 Relationship',
    career: '💼 Career',
    wealth: '💰 Wealth',
    health: '🌡️ Health',
    nearTerm: '🔮 Near Term'
  },
  reportLabels: {
    dayMaster: 'Day Master',
    strength: 'Strength',
    usefulSpirit: 'Useful Elements',
    elementCount: 'Elements Count',
    elementStrength: 'Elements Strength',
    supportElements: 'Supporting',
    restrainElements: 'Restraining', 
    missingElements: 'Missing Elements',
    traits: 'Relationship Traits',
    marriageAdvice: 'Marriage Advice',
    relationshipTips: 'Relationship Tips',
    suitableCareers: 'Suitable Careers',
    careerAdvice: 'Career Advice',
    favorableDirections: 'Favorable Directions',
    wealthCharacteristics: 'Wealth Traits',
    wealthDirections: 'Wealth Directions',
    financialAdvice: 'Financial Advice',
    healthCharacteristics: 'Health Traits',
    healthTips: 'Health Tips',
    wellnessAdvice: 'Wellness Advice',
    overallFortune: 'Overall Fortune',
    favorableTiming: 'Favorable Timing',
    cautions: 'Cautions'
  }
},

// ja 日本語
'ja': {
  brand: { subtitle: '5xLiving · 八字簡評' },
  nav: { langLabel: '言語' },
  lang: { 
    'zh-CN':'簡体字',
    'zh-TW':'繁体字', 
    'en':'英語',
    'ja':'日本語',
    'th':'タイ語',
    'ms':'マレー語'
  },
  app: { title: '八字命理 · 快速排盤' },
  form: {
    nameLabel: '名前（任意）',
    namePlaceholder: 'あなたの名前（個人用）',
    genderLabel: '性別',
    gender: { hidden:'非公開', male:'男性', female:'女性' },
    calendarLabel: '暦法',
    calendar: { gregorian:'太陽暦', lunar:'太陰暦' },
    birthdateLabel: '生年月日',
    birthtimeLabel: '出生時間',
    timeUnknown: '出生時間不明'
  },
  btn: { generate: '八字生成', loading: '計算中...' },
  result: { title: 'あなたの生辰八字命盤' },
  pillar: { year:'年柱', month:'月柱', day:'日柱', hour:'時柱' },
  table: { 
    row: { stem:'天干', branch:'地支', fiveElem:'五行', nayin:'納音' }
  },
  energy: { title: '五行エネルギー分析' },
  elem: { wood: '木', fire: '火', earth: '土', metal: '金', water: '水' },
  pro: { 
    title: '🧙‍♂️ 管家 · 専門命理分析', 
    welcome: 'こんにちは！専門の命理顧問です。詳細な分析レポートを生成しました。具体的な質問があればお聞きください。'
  },
  chat: { send: '送信', placeholder: '質問を入力...', toggle: '質問' },
  vip: {
    title: '🌙 会員エリア VIP',
    group: { astrology:'🗝 命理空間', spiritual:'🌙 スピリチュアル' },
    astrology: { 
      match:'恋愛・結婚運', 
      career:'キャリア・起業', 
      wealth:'財運・投資', 
      pet:'ペット相性'
    },
    spiritual: { 
      record:'スピリチュアル記録', 
      courses:'講座: 八字/タロット/占星術', 
      family:'家族記念システム', 
      practice:'週次練習・儀式'
    },
    login: { title: '💎 VIPログイン' },
    services: { header: '会員サービス' },
    upgrade: '💎 VIPアップグレード（月額）',
    back: '← ショップに戻る',
    priceNote: '$9.9/月 VIP（命理+スピリチュアル+講座）'
  },
  auth: {
    header: 'ログイン / 登録',
    login: 'ログイン',
    reset: '🔑 パスワードリセット',
    register: 'アカウント登録',
    freeTrialNote: '新規登録で無料体験',
    emailPlaceholder: 'メールアドレス',
    passwordPlaceholder: 'パスワード（8文字以上）'
  },
  footer: { copy: '© 5XLiving • Astro Sanctuary' },
  err: {
    fillBirthdate: '生年月日を入力',
    invalidDate: '無効な日付形式 YYYY-MM-DD',
    generateFail: '生成失敗、後ほど再試行'
  },
  ui: {
    unknown: '不明',
    timeUnknown: '時間不明',
    hourSuffix: '{h}時',
    birthSummary: '出生: {y}年{m}月{d}日 {timeText}',
    balance: '五行で{strongest}が最強、{weakest}が最弱'
  },
  badge: { noHour: '時柱なし' },
  chatDyn: { autoReply: '受信: {q}。関連セクションに要点があります。' },
  elemNames: { 木:'木', 火:'火', 土:'土', 金:'金', 水:'水' },
  report: { 
    hourUnknownTip: '⚠️ 注意: 出生時間不明、参考情報です',
    tipTitle: 'ヒント',
    generating: '専門分析生成中...',
    failed: '報告生成失敗、後ほど再試行'
  },
  reportTitles: {
    overview: '📊 命盤概要',
    fiveElements: '🌿 五行分析',
    tenGods: '⚡ 十神配置',
    relationship: '💕 恋愛婚姻',
    career: '💼 キャリア',
    wealth: '💰 財運',
    health: '🌡️ 健康',
    nearTerm: '🔮 近期運勢'
  },
  reportLabels: {
    dayMaster: '日主',
    strength: '強弱',
    usefulSpirit: '喜用神',
    elementCount: '五行数',
    elementStrength: '五行強弱',
    supportElements: '支援五行',
    restrainElements: '抑制五行',
    missingElements: '不足五行',
    traits: '恋愛特性',
    marriageAdvice: '結婚アドバイス',
    relationshipTips: '関係のコツ',
    suitableCareers: '適職',
    careerAdvice: 'キャリアアドバイス',
    favorableDirections: '有利な方位',
    wealthCharacteristics: '財運特性',
    wealthDirections: '求財方位',
    financialAdvice: '財務アドバイス',
    healthCharacteristics: '体質特性',
    healthTips: '注意点',
    wellnessAdvice: '健康アドバイス',
    overallFortune: '全体運勢',
    favorableTiming: '有利な時期',
    cautions: '注意事項'
  }
},

// th ไทย
'th': {
  brand: { subtitle: '5xLiving · 八字簡評' },
  nav: { langLabel: 'ภาษา' },
  lang: { 
    'zh-CN':'จีนตัวย่อ',
    'zh-TW':'จีนตัวเต็ม',
    'en':'อังกฤษ',
    'ja':'ญี่ปุ่น',
    'th':'ไทย', 
    'ms':'มาเลย์'
  },
  app: { title: 'โหราศาสตร์八字 · จัดทำดวง' },
  form: {
    nameLabel: 'ชื่อ (ไม่จำเป็น)',
    namePlaceholder: 'ชื่อของคุณ (สำหรับส่วนตัว)',
    genderLabel: 'เพศ',
    gender: { hidden:'ไม่เปิดเผย', male:'ชาย', female:'หญิง' },
    calendarLabel: 'ปฏิทิน',
    calendar: { gregorian:'สากล', lunar:'จันทรคติ' },
    birthdateLabel: 'วันเกิด',
    birthtimeLabel: 'เวลาเกิด',
    timeUnknown: 'เวลาเกิดไม่แน่ชัด'
  },
  btn: { generate: 'สร้าง八字', loading: 'กำลังคำนวณ...' },
  result: { title: 'ดวงชะตาพื้นฐานของคุณ' },
  pillar: { year:'ปี', month:'เดือน', day:'วัน', hour:'เวลา' },
  table: { 
    row: { stem:'สวรรค์', branch:'โลก', fiveElem:'ธาตุ', nayin:'น่าอิ่น' }
  },
  energy: { title: 'การวิเคราะห์ธาตุทั้งห้า' },
  elem: { wood: 'ไม้', fire: 'ไฟ', earth: 'ดิน', metal: 'ทอง', water: 'น้ำ' },
  pro: { 
    title: '🧙‍♂️ ผู้ดูแล · การวิเคราะห์มืออาชีพ', 
    welcome: 'สวัสดี! ฉันเป็นที่ปรึกษาโหราศาสตร์มืออาชีพของคุณ ได้สร้างรายงานการวิเคราะห์โดยละเอียดแล้ว มีคำถามอะไรก็ถามได้'
  },
  chat: { send: 'ส่ง', placeholder: 'พิมพ์คำถาม...', toggle: 'ถาม' },
  vip: {
    title: '🌙 พื้นที่สมาชิก VIP',
    group: { astrology:'🗝 โหราศาสตร์', spiritual:'🌙 จิตวิญญาณ' },
    astrology: { 
      match:'ความรัก・การแต่งงาน', 
      career:'อาชีพ・ธุรกิจ', 
      wealth:'โชคลาภ・การเงิน', 
      pet:'โหราศาสตร์สัตว์เลี้ยง'
    },
    spiritual: { 
      record:'บันทึกจิตวิญญาณ', 
      courses:'คอร์ส: 八字/ทาโรต์/ดวงดาว', 
      family:'ระบบความทรงจำครอบครัว', 
      practice:'แบบฝึกหัดรายสัปดาห์'
    },
    login: { title: '💎 เข้าสู่ระบบ VIP' },
    services: { header: 'บริการสมาชิก' },
    upgrade: '💎 อัปเกรดเป็น VIP (รายเดือน)',
    back: '← กลับสู่ร้านค้า',
    priceNote: '$9.9/เดือน VIP (โหราศาสตร์+จิตวิญญาณ+คอร์ส)'
  },
  auth: {
    header: 'เข้าสู่ระบบ / ลงทะเบียน',
    login: 'เข้าสู่ระบบ',
    reset: '🔑 รีเซ็ตรหัสผ่าน',
    register: 'ลงทะเบียน',
    freeTrialNote: 'ทดลองฟรีสำหรับบัญชีใหม่',
    emailPlaceholder: 'อีเมล',
    passwordPlaceholder: 'รหัสผ่าน (8 ตัวอักษรขึ้นไป)'
  },
  footer: { copy: '© 5XLiving • Astro Sanctuary' },
  err: {
    fillBirthdate: 'กรุณากรอกวันเกิด',
    invalidDate: 'รูปแบบวันที่ไม่ถูกต้อง YYYY-MM-DD',
    generateFail: 'สร้างล้มเหลว กรุณาลองใหม่'
  },
  ui: {
    unknown: 'ไม่ทราบ',
    timeUnknown: 'เวลาไม่ทราบ',
    hourSuffix: '{h}:00',
    birthSummary: 'เกิด: {y}-{m}-{d} {timeText}',
    balance: '{strongest} แข็งแรงที่สุด {weakest} อ่อนแอที่สุด'
  },
  badge: { noHour: 'ไม่มีชั่วโมง' },
  chatDyn: { autoReply: 'ได้รับ: {q} ดูจุดสำคัญในส่วนที่เกี่ยวข้อง' },
  elemNames: { 木:'ไม้', 火:'ไฟ', 土:'ดิน', 金:'ทอง', 水:'น้ำ' },
  report: { 
    hourUnknownTip: '⚠️ หมายเหตุ: เวลาเกิดไม่ทราบ วิเคราะห์เพื่ออ้างอิง',
    tipTitle: 'คำแนะนำ',
    generating: 'กำลังสร้างการวิเคราะห์...',
    failed: 'สร้างรายงานล้มเหลว กรุณาลองใหม่'
  },
  reportTitles: {
    overview: '📊 ภาพรวมดวง',
    fiveElements: '🌿 การวิเคราะห์ธาตุ',
    tenGods: '⚡ เทพสิบองค์',
    relationship: '💕 ความสัมพันธ์',
    career: '💼 อาชีพ',
    wealth: '💰 โชคลาภ',
    health: '🌡️ สุขภาพ',
    nearTerm: '🔮 ดวงระยะใกล้'
  },
  reportLabels: {
    dayMaster: 'ดาวประจำวัน',
    strength: 'ความแข็งแรง',
    usefulSpirit: 'ธาตุเสริม',
    elementCount: 'จำนวนธาตุ',
    elementStrength: 'ความแข็งแรงธาตุ',
    supportElements: 'ธาตุสนับสนุน',
    restrainElements: 'ธาตุควบคุม',
    missingElements: 'ธาตุขาด',
    traits: 'ลักษณะความสัมพันธ์',
    marriageAdvice: 'คำแนะนำการแต่งงาน',
    relationshipTips: 'เคล็ดลับความสัมพันธ์',
    suitableCareers: 'อาชีพที่เหมาะ',
    careerAdvice: 'คำแนะนำอาชีพ',
    favorableDirections: 'ทิศทางดี',
    wealthCharacteristics: 'ลักษณะโชคลาภ',
    wealthDirections: 'ทิศทางหาเงิน',
    financialAdvice: 'คำแนะนำการเงิน',
    healthCharacteristics: 'ลักษณะสุขภาพ',
    healthTips: 'ข้อควรระวัง',
    wellnessAdvice: 'คำแนะนำสุขภาพ',
    overallFortune: 'ดวงรวม',
    favorableTiming: 'ช่วงเวลาดี',
    cautions: 'ข้อควรระวัง'
  }
},

// ms Bahasa Melayu
'ms': {
  brand: { subtitle: '5xLiving · Ringkas Bazi' },
  nav: { langLabel: 'Bahasa' },
  lang: { 
    'zh-CN':'Cina Ringkas',
    'zh-TW':'Cina Tradisional',
    'en':'Inggeris',
    'ja':'Jepun',
    'th':'Thai',
    'ms':'Melayu'
  },
  app: { title: 'Bazi · Carta Pantas' },
  form: {
    nameLabel: 'Nama (pilihan)',
    namePlaceholder: 'Nama anda (untuk peribadi)',
    genderLabel: 'Jantina',
    gender: { hidden:'Rahsia', male:'Lelaki', female:'Perempuan' },
    calendarLabel: 'Kalendar',
    calendar: { gregorian:'Masihi', lunar:'Qamari' },
    birthdateLabel: 'Tarikh Lahir',
    birthtimeLabel: 'Masa Lahir',
    timeUnknown: 'Masa tidak pasti'
  },
  btn: { generate: 'Jana Bazi', loading: 'Mengira...' },
  result: { title: 'Carta Bazi Anda' },
  pillar: { year:'Tahun', month:'Bulan', day:'Hari', hour:'Jam' },
  table: { 
    row: { stem:'Batang Langit', branch:'Cawangan Bumi', fiveElem:'Unsur', nayin:'Nayin' }
  },
  energy: { title: 'Analisis Lima Unsur' },
  elem: { wood: 'Kayu', fire: 'Api', earth: 'Tanah', metal: 'Logam', water: 'Air' },
  pro: { 
    title: '🧙‍♂️ Butler · Analisis Profesional', 
    welcome: 'Helo! Saya penasihat nasib profesional anda. Laporan terperinci telah dijana. Tanya soalan khusus.'
  },
  chat: { send: 'Hantar', placeholder: 'Taip soalan...', toggle: 'Tanya' },
  vip: {
    title: '🌙 Kawasan VIP',
    group: { astrology:'🗝 Astrologi', spiritual:'🌙 Kerohanian' },
    astrology: { 
      match:'Hubungan & Perkahwinan', 
      career:'Kerjaya & Perniagaan', 
      wealth:'Kewangan & Pelaburan', 
      pet:'Astrologi Haiwan'
    },
    spiritual: { 
      record:'Rekod Kerohanian', 
      courses:'Kursus: Bazi/Tarot/Astrologi', 
      family:'Sistem Memorial Keluarga', 
      practice:'Amalan Mingguan'
    },
    login: { title: '💎 Log Masuk VIP' },
    services: { header: 'Perkhidmatan Ahli' },
    upgrade: '💎 Naik Taraf VIP (Bulanan)',
    back: '← Kembali ke Kedai',
    priceNote: '$9.9/Bulan VIP (Astrologi+Kerohanian+Kursus)'
  },
  auth: {
    header: 'Log Masuk / Daftar',
    login: 'Log Masuk',
    reset: '🔑 Reset Kata Laluan',
    register: 'Daftar',
    freeTrialNote: 'Percubaan percuma akaun baru',
    emailPlaceholder: 'Emel',
    passwordPlaceholder: 'Kata Laluan (min 8 aksara)'
  },
  footer: { copy: '© 5XLiving • Astro Sanctuary' },
  err: {
    fillBirthdate: 'Sila isi tarikh lahir',
    invalidDate: 'Format tarikh tidak sah YYYY-MM-DD',
    generateFail: 'Jana gagal, cuba lagi'
  },
  ui: {
    unknown: 'Tidak diketahui',
    timeUnknown: 'Masa tidak diketahui',
    hourSuffix: '{h}:00',
    birthSummary: 'Lahir: {y}-{m}-{d} {timeText}',
    balance: '{strongest} paling kuat, {weakest} paling lemah'
  },
  badge: { noHour: 'Tiada jam' },
  chatDyn: { autoReply: 'Diterima: {q}. Lihat titik utama dalam bahagian berkaitan.' },
  elemNames: { 木:'Kayu', 火:'Api', 土:'Tanah', 金:'Logam', 水:'Air' },
  report: { 
    hourUnknownTip: '⚠️ Nota: Masa lahir tidak diketahui, analisis untuk rujukan',
    tipTitle: 'TIP',
    generating: 'Menjana analisis profesional...',
    failed: 'Jana laporan gagal, cuba lagi'
  },
  reportTitles: {
    overview: '📊 Gambaran Keseluruhan',
    fiveElements: '🌿 Analisis Unsur',
    tenGods: '⚡ Sepuluh Dewa',
    relationship: '💕 Hubungan',
    career: '💼 Kerjaya',
    wealth: '💰 Kekayaan',
    health: '🌡️ Kesihatan',
    nearTerm: '🔮 Nasib Terdekat'
  },
  reportLabels: {
    dayMaster: 'Tuan Hari',
    strength: 'Kekuatan',
    usefulSpirit: 'Unsur Berguna',
    elementCount: 'Bilangan Unsur',
    elementStrength: 'Kekuatan Unsur',
    supportElements: 'Unsur Menyokong',
    restrainElements: 'Unsur Menahan',
    missingElements: 'Unsur Tiada',
    traits: 'Ciri Hubungan',
    marriageAdvice: 'Nasihat Perkahwinan',
    relationshipTips: 'Tip Hubungan',
    suitableCareers: 'Kerjaya Sesuai',
    careerAdvice: 'Nasihat Kerjaya',
    favorableDirections: 'Arah Menguntungkan',
    wealthCharacteristics: 'Ciri Kekayaan',
    wealthDirections: 'Arah Kekayaan',
    financialAdvice: 'Nasihat Kewangan',
    healthCharacteristics: 'Ciri Kesihatan',
    healthTips: 'Tip Kesihatan',
    wellnessAdvice: 'Nasihat Kesihatan',
    overallFortune: 'Nasib Keseluruhan',
    favorableTiming: 'Masa Menguntungkan',
    cautions: 'Langkah Berjaga-jaga'
  }
}  // ← ms 语言结束
}; // ← 整个 I18N 对象结束

  // 工具函数
  const $ = id => document.getElementById(id);
  const state = { 
    lang: localStorage.getItem('5x_lang') || 'zh-CN'
  };

  function get(obj, path) {
    return path.split('.').reduce((o, k) => (o && o[k] != null) ? o[k] : undefined, obj);
  }

  function t(key) {
    const dict = I18N[state.lang] || I18N['zh-CN'];
    const val = get(dict, key);
    return (typeof val === 'string') ? val : key;
  }

  function applyI18n() {
    const dict = I18N[state.lang] || I18N['zh-CN'];
    document.documentElement.lang = state.lang;

    // 翻译所有 data-i18n 元素
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const val = get(dict, key);
      if (typeof val === 'string' && val) el.textContent = val;
    });

    // 翻译选项
    document.querySelectorAll('option[data-i18n]').forEach(opt => {
      const key = opt.getAttribute('data-i18n');
      const val = get(dict, key);
      if (typeof val === 'string' && val) opt.textContent = val;
    });

    // 设置placeholder
    const ph = {
      name: get(dict, 'form.namePlaceholder'),
      email: get(dict, 'auth.emailPlaceholder'),
      password: get(dict, 'auth.passwordPlaceholder'),
      chat: get(dict, 'chat.placeholder')
    };
    if ($('name') && ph.name) $('name').placeholder = ph.name;
    if ($('email') && ph.email) $('email').placeholder = ph.email;
    if ($('password') && ph.password) $('password').placeholder = ph.password;
    if ($('chatInput') && ph.chat) $('chatInput').placeholder = ph.chat;

    // 更新语言选择器
    const langSelect = $('langSelect');
    if (langSelect) langSelect.value = state.lang;
  }

  function showErr(msg) {
    const box = $('error');
    if (!box) return;
    box.textContent = msg || t('err.generateFail');
    box.style.display = 'block';
    setTimeout(() => { box.style.display = 'none'; }, 4000);
  }

  function setGenLoading(v) {
    const btn = $('genBtn'), txt = $('genBtnText'), ld = $('genBtnLoading');
    if (!btn) return;
    btn.disabled = !!v;
    if (txt) txt.style.display = v ? 'none' : 'inline';
    if (ld) ld.style.display = v ? 'inline' : 'none';
  }

  // 八字计算器
  class BaziCalculator {
    constructor() {
      this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
      this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
      this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
    }

    calculateYearPillar(year) {
      const s = (year - 4) % 10;
      const b = (year - 4) % 12;
      return { 
        stem: this.HEAVENLY_STEMS[(s + 10) % 10], 
        branch: this.EARTHLY_BRANCHES[(b + 12) % 12] 
      };
    }

    solarMonthIndex(y, m, d) {
      const mmdd = m * 100 + d;
      const gates = [[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
      let idx = 11; 
      for (const [thr, val] of gates) { 
        if (mmdd >= thr) idx = val; 
      }
      const branchBy = {1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
      return { index: idx, branch: branchBy[idx] };
    }

    calculateMonthPillar(year, month, day) {
      const { index, branch } = this.solarMonthIndex(year, month, day);
      const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
      const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
      return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
    }

    calculateDayPillar(year, month, day) {
      const baseUTC = Date.UTC(1900, 0, 31);
      const targetUTC = Date.UTC(year, month - 1, day);
      const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
      const stemIdx = (0 + dayDiff) % 10;
      const branchIdx = (4 + dayDiff) % 12;
      return { 
        stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10], 
        branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12] 
      };
    }

    calculateHourPillar(dayStem, hour) {
      const branchMap = {
        23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',
        7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',
        15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'
      };
      const startMap = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex = Math.floor((hour + 1) / 2) % 12;
      const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
      return { 
        stem: this.HEAVENLY_STEMS[stemIdx], 
        branch: branchMap[hour] 
      };
    }

    getStemElement(stem) {
      const map = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
      return map[stem] || '-';
    }

    getBranchElement(branch) {
      const map = {子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
      return map[branch] || '-';
    }

    getNayin(stem, branch) {
      const si = this.HEAVENLY_STEMS.indexOf(stem);
      const bi = this.EARTHLY_BRANCHES.indexOf(branch);
      return this.NAYIN[(si * 2 + bi) % this.NAYIN.length];
    }

    // 计算十神
    calculateTenGods(dayStem, stems) {
      const tenGodsMap = {
        '甲': { '甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印' },
        '乙': { '甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印' },
        '丙': { '甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官' },
        '丁': { '甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀' },
        '戊': { '甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财' },
        '己': { '甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财' },
        '庚': { '甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官' },
        '辛': { '甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神' },
        '壬': { '甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财' },
        '癸': { '甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩' }
      };
      
      const map = tenGodsMap[dayStem];
      if (!map) return stems.map(() => '-');
      
      return stems.map(stem => map[stem] || '-');
    }
  }

  // 渲染函数
  function renderPillars(labels) {
    const titles = [t('pillar.year'), t('pillar.month'), t('pillar.day'), t('pillar.hour')];
    const html = labels.map((label, i) => `
      <div class="pillar">
        <div class="tit">${titles[i]}</div>
        <div class="gz">${label || '-'}</div>
      </div>
    `).join('');
    const box = $('bazi-pillars');
    if (box) box.innerHTML = html;
  }

  function renderTable(data) {
    const KEYS = ['year','month','day','hour'];
    const rows = ['stem','branch','element','nayin'];
    const rowLabels = [
      t('table.row.stem'),
      t('table.row.branch'), 
      t('table.row.fiveElem'),
      t('table.row.nayin')
    ];
    
    KEYS.forEach((k, i) => {
      rows.forEach((row, j) => {
        const cell = $(`${k}-${row}`);
        if (cell) {
          cell.textContent = (data[row] && data[row][i]) ? data[row][i] : '-';
        }
      });
    });
  }

  function renderBars(pcts) {
    const elems = ['木','火','土','金','水'];
    const elemNames = {
      '木': t('elem.wood'),
      '火': t('elem.fire'),
      '土': t('elem.earth'),
      '金': t('elem.metal'), 
      '水': t('elem.water')
    };
    
    elems.forEach(e => {
      const pct = Math.max(0, Math.min(100, Math.round(pcts[e] || 0)));
      const bar = $(`bar-${e}`);
      const lab = $(`pct-${e}`);
      const label = $(`elem-${e}`);
      if (bar) bar.style.width = pct + '%';
      if (lab) lab.textContent = pct + '%';
      if (label) label.textContent = elemNames[e];
    });
  }

  function showResultContainers() {
    const result = $('result');
    const butler = $('butlerProfessional');
    if (result) result.style.display = 'block';
    if (butler) butler.style.display = 'block';
  }

  // 专业报告生成器 - 多语言版本
function generateProfessionalReport(baziData) {
  const calc = new BaziCalculator();
  const dayStem = baziData.stem[2];
  const tenGods = calc.calculateTenGods(dayStem, baziData.stem);
  
  // 计算五行个数
  const elementCounts = { '金': 0, '木': 0, '水': 0, '火': 0, '土': 0 };
  baziData.stem.forEach(stem => {
    const element = calc.getStemElement(stem);
    if (element !== '-') elementCounts[element]++;
  });
  baziData.branch.forEach(branch => {
    const element = calc.getBranchElement(branch);
    if (element !== '-') elementCounts[element]++;
  });

  // 直接使用真实数据，不使用变量名
  const dayMasterAnalysis = getDayMasterAnalysis(dayStem);
  const relationshipTraits = getRelationshipTraits(dayStem);
  const marriageAdvice = getMarriageAdvice(tenGods);
  const suitableCareers = getSuitableCareers(dayStem);
  const careerAdvice = getCareerAdvice(tenGods);
  const favorableDirections = getFavorableDirections(dayStem);
  const wealthAnalysis = getWealthAnalysis(tenGods);
  const healthAnalysis = getHealthAnalysis(dayStem);
  const healthTips = getHealthTips(dayStem);

  return `
    <div class="butler-section">
      <h4>${t('reportTitles.overview')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.dayMaster')}：</strong>${dayMasterAnalysis}</p>
        <p><strong>${t('reportLabels.elementCount')}：</strong>${elementCounts['金']}${t('elem.metal')}，${elementCounts['木']}${t('elem.wood')}，${elementCounts['水']}${t('elem.water')}，${elementCounts['火']}${t('elem.fire')}，${elementCounts['土']}${t('elem.earth')}</p>
        <p><strong>${t('reportLabels.elementStrength')}：</strong>${Object.entries(baziData.elementsPct).sort((a,b) => b[1]-a[1]).map(([k,v]) => {
          const elemNames = { '木': t('elem.wood'), '火': t('elem.fire'), '土': t('elem.earth'), '金': t('elem.metal'), '水': t('elem.water') };
          return `${elemNames[k]}${Math.round(v)}%`;
        }).join('，')}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.tenGods')}</h4>
      <div class="detail-content">
        <p><strong>${baziData.stem[0]}${baziData.branch[0]}：</strong>${tenGods[0]} - ${getTenGodsDescription(tenGods[0])}</p>
        <p><strong>${baziData.stem[1]}${baziData.branch[1]}：</strong>${tenGods[1]} - ${getTenGodsDescription(tenGods[1])}</p>
        <p><strong>${baziData.stem[2]}${baziData.branch[2]}：</strong>${tenGods[2]} - ${getTenGodsDescription(tenGods[2])}</p>
        <p><strong>${baziData.stem[3]}${baziData.branch[3]}：</strong>${tenGods[3]} - ${getTenGodsDescription(tenGods[3])}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.relationship')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.traits')}：</strong>${relationshipTraits}</p>
        <p><strong>${t('reportLabels.marriageAdvice')}：</strong>${marriageAdvice}</p>
        <p><strong>${t('reportLabels.relationshipTips')}：</strong>${getRelationshipTips(dayStem)}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.career')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.suitableCareers')}：</strong>${suitableCareers}</p>
        <p><strong>${t('reportLabels.careerAdvice')}：</strong>${careerAdvice}</p>
        <p><strong>${t('reportLabels.favorableDirections')}：</strong>${favorableDirections}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.wealth')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.wealthCharacteristics')}：</strong>${wealthAnalysis}</p>
        <p><strong>${t('reportLabels.wealthDirections')}：</strong>${favorableDirections}</p>
        <p><strong>${t('reportLabels.financialAdvice')}：</strong>${getFinancialAdvice(tenGods)}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.health')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.healthCharacteristics')}：</strong>${healthAnalysis}</p>
        <p><strong>${t('reportLabels.healthTips')}：</strong>${healthTips}</p>
        <p><strong>${t('reportLabels.wellnessAdvice')}：</strong>${getWellnessAdvice(dayStem)}</p>
      </div>
    </div>

    <div class="butler-section">
      <h4>${t('reportTitles.nearTerm')}</h4>
      <div class="detail-content">
        <p><strong>${t('reportLabels.overallFortune')}：</strong>${getOverallFortune(tenGods)}</p>
        <p><strong>${t('reportLabels.favorableTiming')}：</strong>${getFavorableTiming(dayStem)}</p>
        <p><strong>${t('reportLabels.cautions')}：</strong>${getCautions(tenGods)}</p>
      </div>
    </div>
  `;
}

// 新增辅助函数
function getTenGodsDescription(tenGod) {
  const descriptions = {
    '比肩': '表示兄弟姐妹、朋友同事，主合作与竞争',
    '劫财': '表示异性朋友、竞争对手，主破财与机遇',
    '食神': '表示子女、食禄，主才华与享受',
    '伤官': '表示才华、艺术，主创意与挑战',
    '偏财': '表示父亲、意外之财，主横财与风险',
    '正财': '表示妻子、稳定收入，主正财与稳定',
    '七杀': '表示压力、权威，主挑战与权力',
    '正官': '表示丈夫、官职，主事业与责任',
    '偏印': '表示继母、特殊才能，主智慧与神秘',
    '正印': '表示母亲、学识，主学习与保护'
  };
  return descriptions[tenGod] || '表示特定的人际关系和运势特征';
}

    return `
      <div class="butler-section">
        <h4>${t('reportTitles.overview')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.dayMaster')}：</strong>${getDayMasterAnalysis(dayStem)}</p>
          <p><strong>${t('reportLabels.elementCount')}：</strong>${elementCounts['金']}${t('elem.metal')}，${elementCounts['木']}${t('elem.wood')}，${elementCounts['水']}${t('elem.water')}，${elementCounts['火']}${t('elem.fire')}，${elementCounts['土']}${t('elem.earth')}</p>
          <p><strong>${t('reportLabels.elementStrength')}：</strong>${Object.entries(baziData.elementsPct).sort((a,b) => b[1]-a[1]).map(([k,v]) => {
            const elemNames = { '木': t('elem.wood'), '火': t('elem.fire'), '土': t('elem.earth'), '金': t('elem.metal'), '水': t('elem.water') };
            return `${elemNames[k]}${Math.round(v)}%`;
          }).join('，')}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.tenGods')}</h4>
        <div class="detail-content">
          <p><strong>${baziData.stem[0]}${baziData.branch[0]}：</strong>${tenGods[0]} - ${tenGodsDesc[tenGods[0]] || ''}</p>
          <p><strong>${baziData.stem[1]}${baziData.branch[1]}：</strong>${tenGods[1]} - ${tenGodsDesc[tenGods[1]] || ''}</p>
          <p><strong>${baziData.stem[2]}${baziData.branch[2]}：</strong>${tenGods[2]} - ${tenGodsDesc[tenGods[2]] || ''}</p>
          <p><strong>${baziData.stem[3]}${baziData.branch[3]}：</strong>${tenGods[3]} - ${tenGodsDesc[tenGods[3]] || ''}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.relationship')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.traits')}：</strong>${getRelationshipTraits(dayStem)}</p>
          <p><strong>${t('reportLabels.marriageAdvice')}：</strong>${getMarriageAdvice(tenGods)}</p>
          <p><strong>${t('reportLabels.relationshipTips')}：</strong>${t('report.relationship.tips') || '学会沟通理解，互相包容支持'}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.career')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.suitableCareers')}：</strong>${getSuitableCareers(dayStem)}</p>
          <p><strong>${t('reportLabels.careerAdvice')}：</strong>${getCareerAdvice(tenGods)}</p>
          <p><strong>${t('reportLabels.favorableDirections')}：</strong>${getFavorableDirections(dayStem)}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.wealth')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.wealthCharacteristics')}：</strong>${getWealthAnalysis(tenGods)}</p>
          <p><strong>${t('reportLabels.wealthDirections')}：</strong>${getWealthDirections(dayStem)}</p>
          <p><strong>${t('reportLabels.financialAdvice')}：</strong>${t('report.wealth.advice') || '稳扎稳打，合理规划'}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.health')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.healthCharacteristics')}：</strong>${getHealthAnalysis(dayStem)}</p>
          <p><strong>${t('reportLabels.healthTips')}：</strong>${getHealthTips(dayStem)}</p>
          <p><strong>${t('reportLabels.wellnessAdvice')}：</strong>${t('report.health.advice') || '规律作息，适当运动'}</p>
        </div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.nearTerm')}</h4>
        <div class="detail-content">
          <p><strong>${t('reportLabels.overallFortune')}：</strong>${t('report.fortune.overall') || '稳中求进，适合学习提升'}</p>
          <p><strong>${t('reportLabels.favorableTiming')}：</strong>${t('report.fortune.timing') || '未来3-6个月是关键发展期'}</p>
          <p><strong>${t('reportLabels.cautions')}：</strong>${t('report.fortune.cautions') || '避免冲动决策，注意人际关系'}</p>
        </div>
      </div>
    `;
  }
 
// 辅助函数 - 整合版本
const BaziAnalysis = {
  // 日主分析
  getDayMasterAnalysis(dayStem) {
    const analysis = {
      '甲': t('report.dayMaster.jia') || '甲木命：有积极性的开拓精神，精力旺盛',
      '乙': t('report.dayMaster.yi') || '乙木命：性格柔顺，喜行善事，有同情心',
      '丙': t('report.dayMaster.bing') || '丙火命：热情豪爽，自信好胜，善言健谈',
      '丁': t('report.dayMaster.ding') || '丁火命：敦厚朴实，重信守义',
      '戊': t('report.dayMaster.wu') || '戊土命：有积极性，干一行易于对事物热衷',
      '己': t('report.dayMaster.ji') || '己土命：和缓，谨慎，心灵手巧',
      '庚': t('report.dayMaster.geng') || '庚金命：积极进取，勇敢果决',
      '辛': t('report.dayMaster.xin') || '辛金命：沉着坦直无私，待人接物认真',
      '壬': t('report.dayMaster.ren') || '壬水命：心胸宽广，机智灵敏',
      '癸': t('report.dayMaster.gui') || '癸水命：逞强顽固，是努力家'
    };
    return analysis[dayStem] || t('report.dayMaster.default') || '个性独特，适应力强';
  },

  // 感情关系分析
  getRelationshipAnalysis(dayStem) {
    const analysis = {
      '甲': {
        traits: '感情较为主动，喜欢掌握主导权，但要注意给对方空间',
        tips: '学会倾听对方意见，保持沟通平衡'
      },
      '乙': {
        traits: '感情细腻温柔，需要稳定的情感支持，但不要过度依赖对方',
        tips: '建立自信，明确表达自己的需求'
      },
      '丙': {
        traits: '感情热情奔放，但容易冲动，要控制情绪波动',
        tips: '控制情绪波动，避免冲动言行'
      },
      '丁': {
        traits: '感情专一执着，但容易猜疑，要避免过度猜疑',
        tips: '信任伴侣，减少不必要的猜疑'
      },
      '戊': {
        traits: '感情稳重务实，重视家庭稳定，但要学会表达情感',
        tips: '学会浪漫表达，增加情感交流'
      },
      '己': {
        traits: '感情细腻体贴，但容易缺乏安全感，要建立自信心',
        tips: '培养安全感，不要过度依赖'
      },
      '庚': {
        traits: '感情果断直接，不喜欢拖泥带水，但要考虑对方感受',
        tips: '考虑对方感受，适当放慢节奏'
      },
      '辛': {
        traits: '感情追求完美，对伴侣要求较高，但要接受对方缺点',
        tips: '接受不完美，降低对伴侣的要求'
      },
      '壬': {
        traits: '感情丰富多变，需要新鲜感，但要保持感情稳定',
        tips: '保持感情稳定，培养共同兴趣'
      },
      '癸': {
        traits: '感情细腻敏感，容易情绪化，但要学会情绪管理',
        tips: '学会情绪管理，理性处理矛盾'
      }
    };
    const defaultAnalysis = {
      traits: '感情运势平稳，需要用心经营，相互理解、真诚沟通是维系感情的关键',
      tips: '相互尊重，真诚沟通是维系感情的关键'
    };
    return analysis[dayStem] || defaultAnalysis;
  },

  // 婚姻建议
  getMarriageAdvice(tenGods) {
    if (tenGods.includes('正官') || tenGods.includes('正财')) {
      return t('report.marriage.stable') || '婚姻较为稳定，适合建立长期关系';
    } else if (tenGods.includes('七杀') || tenGods.includes('偏财')) {
      return t('report.marriage.experienced') || '感情经历可能较多，需要找到真正适合的伴侣';
    } else {
      return t('report.marriage.default') || '婚姻需要双方共同努力经营';
    }
  },

  // 职业分析
  getCareerAnalysis(dayStem, tenGods) {
    const careers = {
      '甲': t('report.career.jia') || '管理岗位、创业开拓、建筑工程',
      '乙': t('report.career.yi') || '教育文化、创意设计、咨询顾问',
      '丙': t('report.career.bing') || '市场营销、娱乐产业、能源行业',
      '丁': t('report.career.ding') || '技术研发、医疗服务、精密制造',
      '戊': t('report.career.wu') || '金融投资、房地产、资源管理',
      '己': t('report.career.ji') || '人力资源、服务行业、农业相关',
      '庚': t('report.career.geng') || '法律行业、机械工程、军警职业',
      '辛': t('report.career.xin') || '金融分析、精密仪器、珠宝行业',
      '壬': t('report.career.ren') || '贸易物流、旅游行业、创意产业',
      '癸': t('report.career.gui') || '研究机构、心理咨询、艺术创作'
    };
    
    let advice = '';
    if (tenGods.includes('正官') || tenGods.includes('七杀')) {
      advice = t('report.career.leadership') || '适合管理岗位或自主创业，有领导潜力';
    } else if (tenGods.includes('正财') || tenGods.includes('偏财')) {
      advice = t('report.career.business') || '适合商业、金融领域，财运较好';
    } else if (tenGods.includes('食神') || tenGods.includes('伤官')) {
      advice = t('report.career.creative') || '适合创意、艺术、技术类工作';
    } else {
      advice = t('report.career.steady') || '稳扎稳打，在专业领域深耕发展';
    }
    
    return {
      suitable: careers[dayStem] || t('report.career.default') || '多样化发展，根据兴趣选择',
      advice: advice
    };
  },

  // 求财方位
  getWealthDirections(dayStem) {
    const directions = {
      '甲': '东方、东南方求财有利',
      '乙': '东方、南方财运较佳',
      '丙': '南方是求财最佳方位',
      '丁': '南方、西南方有利财运',
      '戊': '中部地区、本地发展财运较好',
      '己': '中部、西南方求财有利',
      '庚': '西方、西北方财运旺盛',
      '辛': '西方、北方适合求财',
      '壬': '北方是财运最佳方位',
      '癸': '北方、东方有利财富积累'
    };
    return directions[dayStem] || '根据具体命盘确定最佳求财方位';
  },
  
  // 财务建议
  getFinancialAdvice(tenGods) {
    if (tenGods.includes('偏财')) {
      return '可以适当投资理财，但要控制风险，见好就收';
    } else if (tenGods.includes('正财')) {
      return '稳扎稳打，通过专业技能和稳定工作积累财富';
    } else {
      return '量入为出，做好财务规划，避免不必要的开支';
    }
  },

  // 健康分析
  getHealthAnalysis(dayStem) {
    const analysis = {
      '甲': '需要注意肝胆健康、视力问题和筋骨不适',
      '乙': '需要注意肝脏功能和情绪调节，避免过度用眼',
      '丙': '需要注意心血管健康和眼睛问题，控制情绪波动',
      '丁': '需要注意心脏和血液循环系统，保证充足睡眠',
      '戊': '需要注意脾胃消化功能，保持规律饮食',
      '己': '需要注意脾胃和皮肤问题，注意饮食卫生',
      '庚': '需要注意呼吸系统和大肠健康，避免干燥环境',
      '辛': '需要注意肺部和呼吸系统，保持空气流通',
      '壬': '需要注意肾脏和泌尿系统，保持水分平衡',
      '癸': '需要注意肾脏和膀胱健康，避免过度劳累'
    };
    return analysis[dayStem] || '体质较为平衡，注意全面保健和规律作息';
  },

  // 养生建议
  getWellnessAdvice(dayStem) {
    const advice = {
      '甲': '注意保护眼睛，肝脏和胆健康、筋骨问题，多进行户外运动，少饮酒，保护视力',
      '乙': '注意肝脏、视力问题，保持心情愉悦，避免过度用眼和情绪压抑',
      '丙': '注意心血管、眼睛健康，控制情绪波动',
      '丁': '注意心脏、血液循环，保证充足睡眠，避免过度紧张和焦虑',
      '戊': '注意脾胃消化功能，规律饮食',
      '己': '注意脾胃、皮肤问题，饮食卫生，避免潮湿环境',
      '庚': '注意呼吸系统、大肠健康，避免干燥环境',
      '辛': '注意肺部、呼吸系统，保持空气流通',
      '壬': '注意肾脏、泌尿系统，保持水分平衡',
      '癸': '注意肾脏、膀胱，适当休息，避免过度劳累和熬夜'
    };
    return advice[dayStem] || '体质较为平衡，保持均衡饮食、适量运动和良好作息，注意全面保健';
  },

  // 健康提示
  getHealthTips(dayStem) {
    const tips = {
      '甲': t('report.health.tips.jia') || '定期检查肝功能，保护视力',
      '乙': t('report.health.tips.yi') || '注意情绪调节，避免眼部疲劳',
      '丙': t('report.health.tips.bing') || '控制情绪，避免熬夜',
      '丁': t('report.health.tips.ding') || '保证充足睡眠，避免过度紧张',
      '戊': t('report.health.tips.wu') || '规律饮食，避免暴饮暴食',
      '己': t('report.health.tips.ji') || '注意饮食卫生，避免潮湿环境',
      '庚': t('report.health.tips.geng') || '注意保暖，避免干燥环境',
      '辛': t('report.health.tips.xin') || '保持空气流通，避免烟尘',
      '壬': t('report.health.tips.ren') || '保持水分平衡，避免受凉',
      '癸': t('report.health.tips.gui') || '适量饮水，避免过度劳累'
    };
    return tips[dayStem] || t('report.health.tips.default') || '保持健康生活习惯，定期体检';
  },

  // 运势分析
  getFortuneAnalysis(tenGods, dayStem) {
    let overall = '';
    if (tenGods.includes('正官') || tenGods.includes('正印')) {
      overall = '近期运势平稳上升，适合学习提升和事业发展';
    } else if (tenGods.includes('七杀') || tenGods.includes('伤官')) {
      overall = '面临一些挑战，但也是成长和突破的机会';
    } else {
      overall = '运势相对平稳，适合巩固基础和规划未来';
    }

    const timing = {
      '甲': '春季和冬季运势较佳',
      '乙': '春季和夏季发展机会较多',
      '丙': '夏季运势最旺',
      '丁': '夏季和秋季适合推进计划',
      '戊': '四季皆宜，尤其夏秋之交',
      '己': '夏秋季节运势较好',
      '庚': '秋季机遇最多',
      '辛': '秋季和冬季适合发展',
      '壬': '冬季运势最佳',
      '癸': '冬季和春季有利发展'
    };

    return {
      overall: overall,
      timing: timing[dayStem] || '未来3-6个月是关键发展期',
      cautions: this.getCautions(tenGods)
    };
  },

  // 注意事项
  getCautions(tenGods) {
    const cautions = [];
    
    if (tenGods.includes('七杀')) {
      cautions.push('注意压力管理，避免冲动决策');
    }
    if (tenGods.includes('伤官')) {
      cautions.push('注意言辞，避免人际冲突');
    }
    if (tenGods.includes('劫财')) {
      cautions.push('注意财务安全，避免投资风险');
    }
    
    if (cautions.length === 0) {
      cautions.push('保持谨慎态度，注意身体健康');
    }
    
    return cautions.join('；');
  }
};
  
  // 计算八字数据
  function calculateBaziData(birthdate, timeStr, timeUnknown) {
    const [Y, M, D] = birthdate.split('-').map(n => parseInt(n, 10));
    let hour = 12;
    if (!timeUnknown && timeStr) {
      const hh = parseInt(timeStr.slice(0, 2), 10);
      if (!Number.isNaN(hh)) hour = hh;
    }

    const calc = new BaziCalculator();
    const yearP = calc.calculateYearPillar(Y);
    const monthP = calc.calculateMonthPillar(Y, M, D);
    const dayP = calc.calculateDayPillar(Y, M, D);
    const hourP = timeUnknown ? { stem: '-', branch: '-' } : calc.calculateHourPillar(dayP.stem, hour);

    const stems = [yearP.stem, monthP.stem, dayP.stem, hourP.stem];
    const branches = [yearP.branch, monthP.branch, dayP.branch, hourP.branch];
    const elements = stems.map(stem => calc.getStemElement(stem));
    const nayin = stems.map((stem, i) => 
      timeUnknown && i === 3 ? '-' : calc.getNayin(stem, branches[i])
    );

    // 计算五行百分比
    const counts = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
    const consider = timeUnknown
      ? [[stems[0], branches[0]], [stems[1], branches[1]], [stems[2], branches[2]]]
      : [[stems[0], branches[0]], [stems[1], branches[1]], [stems[2], branches[2]], [stems[3], branches[3]]];

    consider.forEach(([s, b]) => {
      counts[calc.getStemElement(s)] += 1;
      counts[calc.getBranchElement(b)] += 1;
    });

    const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
    const elementsPct = Object.fromEntries(
      Object.entries(counts).map(([k, v]) => [k, v / total * 100])
    );

    return {
      pillars: {
        labels: [
          stems[0] + branches[0],
          stems[1] + branches[1],
          stems[2] + branches[2],
          timeUnknown ? '-' : (stems[3] + branches[3])
        ]
      },
      stem: stems,
      branch: branches,
      element: elements,
      nayin: nayin,
      elementsPct,
      timeUnknown: !!timeUnknown
    };
  }

  // 主要生成函数
  async function onGenerate() {
    const date = $('birthdate')?.value;
    const unknown = $('timeUnknown')?.checked;
    const timeVal = $('birthtime')?.value || '00:00';
    
    if (!date) {
      showErr(t('err.fillBirthdate'));
      return;
    }

    setGenLoading(true);

    try {
      // 显示基本信息
      const [yy, mm, dd] = date.split('-');
      const timeText = unknown ? t('ui.timeUnknown') : 
        (state.lang === 'en' ? `${timeVal.slice(0, 2)}:00` : `${timeVal.slice(0, 2)}时`);
      
      const summary = t('ui.birthSummary')
        .replace('{y}', yy)
        .replace('{m}', mm)
        .replace('{d}', dd)
        .replace('{timeText}', timeText);
      
      if ($('bazi-date')) $('bazi-date').textContent = summary;

      // 计算八字数据
      const baziData = calculateBaziData(date, timeVal, unknown);

      // 渲染八字信息
      renderPillars(baziData.pillars.labels);
      renderTable(baziData);
      renderBars(baziData.elementsPct);
      showResultContainers();

      // 生成专业报告
      const professionalReport = $('professionalReport');
      if (professionalReport) {
        professionalReport.innerHTML = generateProfessionalReport(baziData);
      }

    } catch (err) {
      console.error('Generate error:', err);
      showErr(t('err.generateFail'));
    } finally {
      setGenLoading(false);
    }
  }

  // 初始化聊天功能
  function initFloatChat() {
    const toggleBtn = $('chatToggle');
    const floatWindow = $('chatFloat');
    const closeBtn = $('chatClose');
    const sendBtn = $('chatSend');
    const input = $('chatInput');
    const messages = $('chatMessages');
    
    if (toggleBtn && floatWindow) {
      toggleBtn.addEventListener('click', () => {
        floatWindow.style.display = floatWindow.style.display === 'flex' ? 'none' : 'flex';
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        if (floatWindow) floatWindow.style.display = 'none';
      });
    }

    // 简单的聊天功能
    function sendMessage() {
      const q = (input?.value || '').trim();
      if (!q) return;
      
      // 添加用户消息
      const userMsg = document.createElement('div');
      userMsg.className = 'ss-msg';
      userMsg.textContent = q;
      userMsg.style.background = 'rgba(212,175,55,0.1)';
      userMsg.style.marginLeft = 'auto';
      userMsg.style.marginRight = '0';
      userMsg.style.maxWidth = '80%';
      messages.appendChild(userMsg);
      
      input.value = '';
      
      // 添加自动回复
      setTimeout(() => {
        const autoMsg = document.createElement('div');
        autoMsg.className = 'ss-msg';
        autoMsg.textContent = t('chatDyn.autoReply').replace('{q}', q);
        autoMsg.style.background = 'rgba(255,255,255,0.05)';
        autoMsg.style.maxWidth = '80%';
        messages.appendChild(autoMsg);
        messages.scrollTop = messages.scrollHeight;
      }, 1000);
      
      messages.scrollTop = messages.scrollHeight;
    }
    
    if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    if (input) input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  // 初始化
  document.addEventListener('DOMContentLoaded', () => {
    // 设置默认日期为今天
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');
    
    const dateInput = $('birthdate');
    const timeInput = $('birthtime');
    if (dateInput && !dateInput.value) dateInput.value = `${yyyy}-${mm}-${dd}`;
    if (timeInput && !timeInput.value) timeInput.value = `${hh}:${mi}`;

    // 事件监听
    const timeUnknown = $('timeUnknown');
    if (timeUnknown) {
      timeUnknown.addEventListener('change', e => {
        const birthtime = $('birthtime');
        if (birthtime) birthtime.disabled = !!e.target.checked;
      });
    }

    const genBtn = $('genBtn');
    if (genBtn) genBtn.addEventListener('click', onGenerate);

    // 语言选择
    const langSelect = $('langSelect');
    if (langSelect) {
      langSelect.value = state.lang;
      langSelect.addEventListener('change', e => {
        state.lang = e.target.value;
        localStorage.setItem('5x_lang', state.lang);
        applyI18n();
        
        // 重新生成报告以更新语言
        const professionalReport = $('professionalReport');
        if (professionalReport && professionalReport.innerHTML) {
          const date = $('birthdate')?.value;
          const unknown = $('timeUnknown')?.checked;
          const timeVal = $('birthtime')?.value || '00:00';
          if (date) {
            const baziData = calculateBaziData(date, timeVal, unknown);
            professionalReport.innerHTML = generateProfessionalReport(baziData);
          }
        }
      });
    }

    // 初始化翻译和聊天
    applyI18n();
    initFloatChat();
  
  if (!reportData.sections) return reportData;
  
  // 定义所有可能出现的英文变量名的中文翻译
  const translations = {
    'report.dayMaster.ren': isChinese ? '壬水日主' : 'Ren Water Day Master',
    'report.tenGods.shangguan': isChinese ? '伤官' : 'Hurting Officer',
    'report.tenGods.piancai': isChinese ? '偏财' : 'Partial Wealth',
    'report.tenGods.bijian': isChinese ? '比肩' : 'Comparable',
    'report.relationship.ren': isChinese ? '壬水日主感情丰富，重视精神交流' : 'Ren Water values emotional connection',
    'report.marriage.experienced': isChinese ? '适合找成熟稳重的伴侣' : 'Suitable for mature partners',
    'report.relationship.tips': isChinese ? '多沟通，少猜疑' : 'More communication, less suspicion',
    'report.career.ren': isChinese ? '适合水、木相关行业' : 'Suitable for water/wood industries',
    'report.career.business': isChinese ? '可考虑自主创业' : 'Consider entrepreneurship',
    'report.direction.ren': isChinese ? '北方、西方有利' : 'North and West directions favorable',
    'report.wealth.good': isChinese ? '偏财运佳，有意外之财' : 'Good partial wealth luck',
    'report.wealth.advice': isChinese ? '宜投资，但需谨慎' : 'Good for investment but be cautious',
    'report.health.ren': isChinese ? '肾水系统需注意' : 'Pay attention to kidney system',
    'report.health.tips.ren': isChinese ? '避免熬夜，多喝水' : 'Avoid staying up late, drink more water',
    'report.health.advice': isChinese ? '定期体检，注意休息' : 'Regular checkups, adequate rest',
    'report.fortune.overall': isChinese ? '近期运势平稳上升' : 'Recent fortune steadily improving',
    'report.fortune.timing': isChinese ? '冬季运势最佳' : 'Best fortune in winter',
    'report.fortune.cautions': isChinese ? '注意人际关系纠纷' : 'Watch for interpersonal conflicts'
  };
  
  // 递归修复所有文本内容
  function fixTextContent(obj) {
    if (typeof obj === 'string') {
      // 直接替换已知的英文变量
      return translations[obj] || obj;
    } else if (Array.isArray(obj)) {
      return obj.map(item => fixTextContent(item));
    } else if (typeof obj === 'object' && obj !== null) {
      const fixed = {};
      for (const [key, value] of Object.entries(obj)) {
        fixed[key] = fixTextContent(value);
      }
      return fixed;
    }
    return obj;
  }
  
  return fixTextContent(reportData);
}
  
  // 修复国际化显示
  const fixedData = fixReportTemplateI18n(json, state.lang);
  
  const html = fixedData.sections.map(sec => {
    const traits = (sec.traits || []).map(s => `<li>${s}</li>`).join('');
    const actions = (sec.actions || []).map(s => `<li>${s}</li>`).join('');
    const outcomes = (sec.outcomes || []).map(s => `<li>${s}</li>`).join('');
    const cautions = (sec.cautions || []).map(s => `<li>${s}</li>`).join('');

    return `
      <div class="butler-section">
        <h4>${sec.title || sec.id}</h4>
        ${traits ? `<div class="detail-section"><strong>${state.lang.startsWith('zh') ? '特质' : 'Traits'}</strong><ul class="action-list">${traits}</ul></div>` : ''}
        ${actions ? `<div class="detail-section"><strong>${state.lang.startsWith('zh') ? '行动建议' : 'Actions'}</strong><ul class="action-list">${actions}</ul></div>` : ''}
        ${outcomes ? `<div class="detail-section"><strong>${state.lang.startsWith('zh') ? '潜在结果' : 'Outcomes'}</strong><ul class="action-list">${outcomes}</ul></div>` : ''}
        ${cautions ? `<div class="detail-section"><strong>${state.lang.startsWith('zh') ? '注意事项' : 'Cautions'}</strong><ul class="action-list">${cautions}</ul></div>` : ''}
        ${sec.timing ? `<div class="detail-section"><strong>${state.lang.startsWith('zh') ? '时机' : 'Timing'}</strong><div>${sec.timing}</div></div>` : ''}
        ${typeof sec.confidence === 'number' ? `<div class="detail-section muted">${state.lang.startsWith('zh') ? '可信度' : 'Confidence'} ${Math.round(sec.confidence * 100)}%</div>` : ''}
      </div>
    `;
  }).join('');
  
  host.innerHTML = html;
  
  const butlerSection = $('butlerProfessional');
  if (butlerSection) {
    butlerSection.style.display = 'block';
  }
  });
})();
</script>
</body>
</html>
