<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* —— 统一头部 —— */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + "不详"同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏"估时间"按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* —— 心怜管家样式 —— */
    .butler-section { margin-top: 20px; }
    .butler-card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 18px; margin: 16px 0; }
    .butler-title { font-size: 1.2rem; margin: 0 0 12px; font-weight: 800; color: var(--gold2); display: flex; gap: 8px; align-items: center; }
    .butler-title::before { content: ""; width: 4px; height: 18px; background: var(--brand); border-radius: 2px; }
    .butler-content { line-height: 1.7; white-space: pre-wrap; }
    .butler-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .butler-chip { padding: 6px 12px; border-radius: 999px; border: 1px solid #2a3546; background: #0e1520; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .butler-chip:hover { border-color: var(--gold2); background: rgba(212,175,55,0.1); }
    .butler-skeleton { display: grid; gap: 8px; }
    .butler-skeleton div { height: 12px; border-radius: 6px; background: linear-gradient(90deg, #1a2431, #1f2b3b, #1a2431); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { opacity: .5; } 50% { opacity: 1; } 100% { opacity: .5; } }
    .butler-lock { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--line); text-align: center; }
    .butler-lock .tip { color: #ffd88a; font-weight: 700; margin-bottom: 4px; }
    .butler-lock .sub { color: var(--muted); }

    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:140px}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
      <div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="label_name">姓名（可选）</label>
          <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
        </div>
        <div>
          <label class="muted" data-i18n="gender_label">性别</label>
          <select id="gender">
            <option value="" data-i18n="opt_gender_confidential">不透露</option>
            <option value="male" data-i18n="opt_gender_male">男性</option>
            <option value="female" data-i18n="opt_gender_female">女性</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="label_calendar">历法</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
            <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="label_birthdate">出生日期</label>
          <input type="date" id="birthdate" />
        </div>

        <div>
          <label class="muted" data-i18n="label_birthtime">出生时间</label>
          <div class="time-row">
            <input type="time" id="birthtime" value="12:00" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="cb_time_unknown">出生时间不详</span>
            </label>
          </div>
        </div>

        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
            <span id="genBtnLoading" style="display:none">计算中...</span>
          </button>
        </div>

        <div id="error" class="error-message"></div>
      </div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">五行能量分析</div>
        <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- 心怜管家 AI 解读区域 -->
      <div class="butler-section">
        <div class="butler-card">
          <div class="butler-title">🧠 心怜管家 · 命理解读</div>
          <div id="butler-content" class="butler-content">
            <div class="butler-skeleton">
              <div style="width:60%"></div>
              <div style="width:80%"></div>
              <div style="width:90%"></div>
              <div style="width:70%"></div>
              <div style="width:50%"></div>
            </div>
          </div>
          <div class="butler-chips">
            <button class="butler-chip" data-question="career">💼 事业方向</button>
            <button class="butler-chip" data-question="love">❤️ 感情婚姻</button>
            <button class="butler-chip" data-question="wealth">💰 财运分析</button>
            <button class="butler-chip" data-question="health">🌿 健康养生</button>
            <button class="butler-chip" data-question="personality">🌟 性格特质</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username"
                  placeholder=""
                  data-i18n-ph="ph_email"
                  required
                />
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  placeholder="密码 Password（至少8位，含大小写数字符号）"
                  data-i18n-ph="ph_password"
                  required
                />
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点"填入时间"，会用该时段的中位时间写到上方时间输入框，并自动取消"时间不详"。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>
  <script>
'use strict';

// ================== 配置 & 工具函数 ==================
const $ = id => document.getElementById(id);

function showErr(msg){ 
  const e = $("error"); 
  if(!e) return; 
  e.textContent = msg; 
  e.style.display = "block"; 
  setTimeout(() => { e.style.display = 'none' }, 5000); 
}

function hideErr(){ 
  const e = $("error"); 
  if(!e) return; 
  e.style.display = "none"; 
  e.textContent = ""; 
}

function showAuthErr(msg){ 
  const e = $("authError"); 
  if(!e) return; 
  e.textContent = msg; 
  e.style.display = "block"; 
  setTimeout(() => { e.style.display = 'none' }, 5000); 
}

function hideAuthErr(){ 
  const e = $("authError"); 
  if(!e) return; 
  e.style.display = "none"; 
  e.textContent = ""; 
}

function lock(el, v){ 
  if(el) el.disabled = v; 
}

function setText(id, v){ 
  const el = $(id); 
  if(el) el.textContent = v; 
}

function setBar(el, pct){ 
  if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; 
}

// ================== 八字计算器核心 ==================
class BaziCalculator {
  constructor(){
    this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }

  calculateYearPillar(year){ 
    const s = (year - 4) % 10;
    const b = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(s + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(b + 12) % 12],
      zodiac: this.ZODIAC[(b + 12) % 12]
    }; 
  }

  solarMonthIndex(y, m, d){ 
    const mmdd = m * 100 + d;
    const gates = [
      [106,12], [204,1], [306,2], [405,3], [506,4], 
      [606,5], [707,6], [808,7], [908,8], [1008,9], 
      [1107,10], [1207,11]
    ];
    let idx = 11;
    for(const [thr, val] of gates) {
      if(mmdd >= thr) idx = val;
    }
    const branchBy = {
      1:'寅', 2:'卯', 3:'辰', 4:'巳', 5:'午', 
      6:'未', 7:'申', 8:'酉', 9:'戌', 10:'亥', 
      11:'子', 12:'丑'
    };
    return { index: idx, branch: branchBy[idx] };
  }

  calculateMonthPillar(year, month, day){ 
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0};
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  calculateDayPillar(year, month, day){ 
    const baseUTC = Date.UTC(1900, 0, 31);
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx = (0 + dayDiff) % 10;
    const branchIdx = (4 + dayDiff) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12]
    };
  }

  calculateHourPillar(dayStem, hour){ 
    const branchMap = {
      23:'子', 0:'子', 1:'丑', 2:'丑', 3:'寅', 4:'寅',
      5:'卯', 6:'卯', 7:'辰', 8:'辰', 9:'巳', 10:'巳',
      11:'午', 12:'午', 13:'未', 14:'未', 15:'申', 16:'申',
      17:'酉', 18:'酉', 19:'戌', 20:'戌', 21:'亥', 22:'亥'
    };
    const startMap = {0:0, 1:2, 2:4, 3:6, 4:8, 5:0, 6:2, 7:4, 8:6, 9:8};
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getElement(stem, branch){ 
    const s = {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    };
    const b = {
      '子':'水', '丑':'土', '寅':'木', '卯':'木', 
      '辰':'土', '巳':'火', '午':'火', '未':'土', 
      '申':'金', '酉':'金', '戌':'土', '亥':'水'
    };
    return `${s[stem]}${b[branch]}`;
  }

  getNayin(stem, branch){ 
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length];
  }

  getStemElement(stem){ 
    return {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    }[stem];
  }

  getBranchElement(branch){ 
    return {
      '子':'水', '丑':'土', '寅':'木', '卯':'木', 
      '辰':'土', '巳':'火', '午':'火', '未':'土', 
      '申':'金', '酉':'金', '戌':'土', '亥':'水'
    }[branch];
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false){
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'？', branch:'？'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // 计算五行分布
    const cnt = {木:0, 火:0, 土:0, 金:0, 水:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(p => {
      if(p.stem && p.stem !== '？') cnt[this.getStemElement(p.stem)] += 1;
      if(p.branch && p.branch !== '？') cnt[this.getBranchElement(p.branch)] += 1;
    });

    const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
    const pct = {
      wood: cnt['木'] / total * 100,
      fire: cnt['火'] / total * 100,
      earth: cnt['土'] / total * 100,
      metal: cnt['金'] / total * 100,
      water: cnt['水'] / total * 100
    };

    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}

const baziCalculator = new BaziCalculator();

// ================== 心怜管家 AI 解读系统 ==================
class ButlerAI {
  constructor() {
    this.currentAnalysis = null;
  }

  // 生成命盘分析报告
  analyzeBazi(baziData) {
    const { pillars, counts, percents, timeUnknown } = baziData;
    
    // 判断命局强弱
    const strength = this.judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    
    // 分析喜用神
    const usefulElements = this.analyzeUsefulElements(strength.mark, pillars.day.element);
    
    // 生成个性分析
    const personality = this.analyzePersonality(pillars.day.stem, strength.mark);
    
    // 生成综合解读
    const comprehensive = this.generateComprehensiveAnalysis(pillars, strength, usefulElements, percents, timeUnknown);

    this.currentAnalysis = {
      pillars,
      strength,
      usefulElements,
      personality,
      comprehensive,
      percents,
      timeUnknown
    };

    return this.currentAnalysis;
  }

  judgeStrength(dayGan, monthZhi, counts) {
    const STEM_ELEM = {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    };
    
    const SEASON_BY_MONTH_BRANCH = {
      '寅':'春', '卯':'春', '辰':'春', 
      '巳':'夏', '午':'夏', '未':'夏', 
      '申':'秋', '酉':'秋', '戌':'秋', 
      '亥':'冬', '子':'冬', '丑':'冬'
    };

    const dmEl = STEM_ELEM[dayGan];
    const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
    
    let score = 0;
    
    // 季节得分
    if ((season === '春' && '木火'.includes(dmEl)) ||
        (season === '夏' && '火土'.includes(dmEl)) ||
        (season === '秋' && dmEl === '金') ||
        (season === '冬' && dmEl === '水')) {
      score += 2;
    }
    
    // 同类五行得分
    score += (counts[dmEl] || 0) * 1.2;
    
    const mark = score >= 3 ? '偏强' : (score <= 1 ? '偏弱' : '平衡');
    const focus = mark === '偏强' ? '泄秀/制化' : (mark === '偏弱' ? '补助/顺势' : '守中/调和');
    
    return { season, mark, focus, score };
  }

  analyzeUsefulElements(strength, dmElem) {
    if (strength === '偏强') {
      return {
        strategy: '泄秀/制化',
        useful: this.getWeakeningElements(dmElem),
        avoid: [dmElem],
        advice: '宜泄不宜补，寻求平衡发展'
      };
    } else if (strength === '偏弱') {
      return {
        strategy: '生扶/补助',
        useful: this.getStrengtheningElements(dmElem),
        avoid: this.getWeakeningElements(dmElem),
        advice: '需要生扶补助，增强自身能量'
      };
    } else {
      return {
        strategy: '调和',
        useful: ['木','火','土','金','水'],
        avoid: [],
        advice: '保持平衡，顺势而为'
      };
    }
  }

  getStrengtheningElements(element) {
    const map = {
      '木': ['木', '水'],
      '火': ['火', '木'],
      '土': ['土', '火'],
      '金': ['金', '土'],
      '水': ['水', '金']
    };
    return map[element] || [];
  }

  getWeakeningElements(element) {
    const map = {
      '木': ['火', '土', '金'],
      '火': ['土', '金', '水'],
      '土': ['金', '水', '木'],
      '金': ['水', '木', '火'],
      '水': ['木', '火', '土']
    };
    return map[element] || [];
  }

  analyzePersonality(dayStem, strength) {
    const personalityMap = {
      '甲': { strong: '领导力强，正直果断', weak: '温和包容，有韧性', balanced: '稳重可靠，有担当' },
      '乙': { strong: '灵活变通，善于交际', weak: '温柔体贴，有艺术气质', balanced: '细腻周到，善解人意' },
      '丙': { strong: '热情开朗，充满活力', weak: '温和善良，重情重义', balanced: '乐观积极，感染力强' },
      '丁': { strong: '细致认真，追求完美', weak: '温和体贴，善解人意', balanced: '聪慧敏锐，有创造力' },
      '戊': { strong: '稳重可靠，责任心强', weak: '温和包容，有耐心', balanced: '踏实务实，值得信赖' },
      '己': { strong: '细致周到，善于规划', weak: '温和谦逊，有包容心', balanced: '务实稳重，注重实际' },
      '庚': { strong: '果断坚决，有魄力', weak: '温和正直，重原则', balanced: '刚毅果断，有正义感' },
      '辛': { strong: '精明干练，追求完美', weak: '温和细腻，有品味', balanced: '聪慧敏锐，善于分析' },
      '壬': { strong: '胸怀宽广，有远见', weak: '温和包容，善解人意', balanced: '智慧通达，适应力强' },
      '癸': { strong: '聪慧敏锐，洞察力强', weak: '温和细腻，有同情心', balanced: '智慧内敛，善于思考' }
    };

    return personalityMap[dayStem]?.[strength === '偏强' ? 'strong' : (strength === '偏弱' ? 'weak' : 'balanced')] || '具有独特的个性特质';
  }

  generateComprehensiveAnalysis(pillars, strength, usefulElements, percents, timeUnknown) {
    const dayMaster = pillars.day.stem;
    const dayElement = pillars.day.element;
    
    let analysis = `您的八字日主为${dayMaster}${dayElement}，命局${strength.mark}。\n\n`;
    
    analysis += `📊 五行分布：\n`;
    analysis += `木 ${Math.round(percents.wood)}% | 火 ${Math.round(percents.fire)}% | 土 ${Math.round(percents.earth)}% | 金 ${Math.round(percents.metal)}% | 水 ${Math.round(percents.water)}%\n\n`;
    
    analysis += `🎯 发展策略：\n`;
    analysis += `宜采用"${strength.focus}"的策略，${usefulElements.advice}\n\n`;
    
    analysis += `💎 喜用元素：\n`;
    analysis += `增强：${usefulElements.useful.join('、')}\n`;
    if (usefulElements.avoid.length > 0) {
      analysis += `注意：${usefulElements.avoid.join('、')}\n`;
    }
    
    if (timeUnknown) {
      analysis += `\n⚠️ 提示：由于出生时间不详，时柱未纳入分析，建议仅供参考。`;
    }
    
    return analysis;
  }

  // 回答特定问题
  answerQuestion(questionType) {
    if (!this.currentAnalysis) return "请先生成八字命盘";
    
    const { pillars, strength, usefulElements, personality, percents } = this.currentAnalysis;
    const dayElement = pillars.day.element;
    
    const questionAnswers = {
      career: this.getCareerAdvice(pillars, strength, usefulElements, percents),
      love: this.getLoveAdvice(pillars, strength, usefulElements),
      wealth: this.getWealthAdvice(pillars, strength, usefulElements, percents),
      health: this.getHealthAdvice(pillars, strength, usefulElements, percents),
      personality: this.getPersonalityDetail(personality, pillars, strength)
    };
    
    return questionAnswers[questionType] || "这个问题我还在学习中...";
  }

  getCareerAdvice(pillars, strength, usefulElements, percents) {
    const elementCareers = {
      '木': ['教育文化', '创意设计', '医疗健康', '环保农业', '出版传媒'],
      '火': ['演艺娱乐', '餐饮旅游', '能源电力', '市场营销', '心理咨询'],
      '土': ['房地产', '建筑工程', '金融投资', '行政管理', '矿产资源'],
      '金': ['科技IT', '机械制造', '法律司法', '金融银行', '精密仪器'],
      '水': ['物流运输', '贸易商务', '旅游服务', '咨询顾问', '文化艺术']
    };
    
    let advice = `💼 事业方向建议：\n\n`;
    
    // 推荐行业
    usefulElements.useful.forEach(element => {
      const careers = elementCareers[element] || [];
      if (careers.length > 0) {
        advice += `基于${element}元素，适合：${careers.slice(0, 3).join('、')}\n`;
      }
    });
    
    advice += `\n${strength.mark === '偏强' ? 
      '您命局偏强，适合挑战性工作，可以承担更多责任。' : 
      strength.mark === '偏弱' ? 
      '您命局偏弱，适合稳定性工作，团队合作更能发挥优势。' : 
      '您命局平衡，适应性强，多种领域都有发展潜力。'
    }\n\n`;
    
    advice += `🌟 发展建议：\n`;
    advice += `• 多接触${usefulElements.useful.join('、')}相关的环境和人群\n`;
    advice += `• ${strength.focus}的策略更适合您的职业发展\n`;
    advice += `• 关注五行平衡，避免极端选择`;
    
    return advice;
  }

  getLoveAdvice(pillars, strength, usefulElements) {
    const elementPartners = {
      '木': '适合与火、土元素较强的人相处',
      '火': '适合与土、金元素较强的人相处', 
      '土': '适合与金、水元素较强的人相处',
      '金': '适合与水、木元素较强的人相处',
      '水': '适合与木、火元素较强的人相处'
    };
    
    let advice = `❤️ 感情婚姻建议：\n\n`;
    
    advice += `您的日主${pillars.day.stem}${pillars.day.element}，在感情中：\n`;
    advice += `${this.getPersonalityDetail(this.analyzePersonality(pillars.day.stem, strength.mark), pillars, strength)}\n\n`;
    
    advice += `💞 伴侣选择：\n`;
    usefulElements.useful.forEach(element => {
      advice += `${elementPartners[element]}\n`;
    });
    
    advice += `\n📝 相处建议：\n`;
    advice += `• ${strength.mark === '偏强' ? '学会倾听和包容' : '增强自信，表达真实感受'}\n`;
    advice += `• 多参与${usefulElements.useful.join('、')}相关的社交活动\n`;
    advice += `• 注重沟通，理解彼此的五行特质`;
    
    return advice;
  }

  getWealthAdvice(pillars, strength, usefulElements, percents) {
    let advice = `💰 财运分析建议：\n\n`;
    
    advice += `您的财星配置：\n`;
    
    // 简单的财星分析
    const wealthElements = this.getWealthElements(pillars.day.element);
    wealthElements.forEach(element => {
      const percent = percents[element === '木' ? 'wood' : element === '火' ? 'fire' : element === '土' ? 'earth' : element === '金' ? 'metal' : 'water'];
      advice += `• ${element}元素（财星）：${Math.round(percent)}% ${percent > 20 ? '🌟' : percent > 10 ? '✅' : '💡'}\n`;
    });
    
    advice += `\n🎯 理财策略：\n`;
    advice += `• 主要投资：${usefulElements.useful.join('、')}相关领域\n`;
    advice += `• 财运方位：${this.getWealthDirections(usefulElements.useful)}\n`;
    advice += `• 合作对象：${usefulElements.useful.map(e => e + '元素').join('、')}较强的人\n\n`;
    
    advice += `💡 温馨提示：\n`;
    advice += `${strength.advice || '根据命局特点制定理财计划'}`;
    
    return advice;
  }

  getHealthAdvice(pillars, strength, usefulElements, percents) {
    const weakestElement = this.getWeakestElement(percents);
    
    let advice = `🌿 健康养生建议：\n\n`;
    
    advice += `当前五行最弱：${weakestElement}\n`;
    advice += `需要特别关注${this.getHealthConcerns(weakestElement)}相关的健康问题\n\n`;
    
    advice += `🏥 保健重点：\n`;
    advice += `• 增强${usefulElements.useful.join('、')}元素的能量\n`;
    advice += `• 注意${this.getHealthOrgans(weakestElement)}的保养\n`;
    advice += `• 适合${this.getHealthActivities(usefulElements.useful)}\n\n`;
    
    advice += `💪 调理建议：\n`;
    advice += `${this.getHealthRegimen(strength.mark, weakestElement, usefulElements.useful)}`;
    
    return advice;
  }

  getHealthConcerns(element) {
    const concerns = {
      '木': '肝胆、眼睛、筋骨',
      '火': '心脏、血液循环、小肠',
      '土': '脾胃、消化系统、肌肉',
      '金': '肺脏、呼吸系统、皮肤',
      '水': '肾脏、泌尿系统、骨骼'
    };
    return concerns[element] || '整体健康';
  }

  getHealthOrgans(element) {
    const organs = {
      '木': '肝胆系统',
      '火': '心血管系统',
      '土': '消化系统',
      '金': '呼吸系统',
      '水': '泌尿系统'
    };
    return organs[element] || '相关脏腑';
  }

  getHealthActivities(usefulElements) {
    const activities = {
      '木': ['散步', '瑜伽', '太极', '森林浴'],
      '火': ['有氧运动', '舞蹈', '社交活动', '阳光浴'],
      '土': ['园艺', '徒步', '冥想', '接地气'],
      '金': ['深呼吸', '跑步', '器械训练', '户外活动'],
      '水': ['游泳', '静坐', '按摩', '水疗']
    };
    
    let recommended = [];
    usefulElements.forEach(element => {
      if (activities[element]) {
        recommended = recommended.concat(activities[element].slice(0, 2));
      }
    });
    
    return recommended.length > 0 ? recommended.join('、') : '适度运动';
  }

  getHealthRegimen(strength, weakestElement, usefulElements) {
    let regimen = '';
    
    if (strength === '偏强') {
      regimen = `由于命局偏强，建议：\n` +
               `• 多进行放松减压的活动\n` +
               `• 适当宣泄情绪，避免积压\n` +
               `• 注重${weakestElement}元素的补充\n` +
               `• 保持规律作息，避免过度劳累`;
    } else if (strength === '偏弱') {
      regimen = `由于命局偏弱，建议：\n` +
               `• 加强营养，增强体质\n` +
               `• 适度运动，循序渐进\n` +
               `• 多接触${usefulElements.join('、')}元素环境\n` +
               `• 保证充足睡眠，避免熬夜`;
    } else {
      regimen = `命局平衡，建议：\n` +
               `• 保持现有健康习惯\n` +
               `• 注重${weakestElement}元素的维护\n` +
               `• 均衡饮食，适度运动\n` +
               `• 定期体检，预防为主`;
    }
    
    return regimen;
  }

  getPersonalityDetail(personality, pillars, strength) {
    const dayStem = pillars.day.stem;
    const stemDetails = {
      '甲': '如参天大树，有领导气质和开拓精神',
      '乙': '如藤蔓花草，灵活变通，善于适应',
      '丙': '如太阳之火，热情奔放，充满活力',
      '丁': '如灯烛之火，细致专注，温暖他人',
      '戊': '如高山厚土，稳重可靠，值得信赖',
      '己': '如田园之土，包容滋养，善于规划',
      '庚': '如钢铁之金，刚毅果断，原则性强',
      '辛': '如珠宝之金，精致完美，追求品质',
      '壬': '如江河之水，智慧通达，适应力强',
      '癸': '如雨露之水，细腻敏感，洞察力强'
    };
    
    return `${personality}。${stemDetails[dayStem] || '具有独特的个性魅力'}。${
      strength.mark === '偏强' ? 
      '您内在能量充足，适合主动出击。' :
      strength.mark === '偏弱' ?
      '您需要适当借助外力，合作共赢。' :
      '您平衡性很好，能够灵活应对各种情况。'
    }`;
  }

  getWealthElements(dayElement) {
    // 简单的财星推算（以我克者为财）
    const wealthMap = {
      '木': ['土'], // 木克土
      '火': ['金'], // 火克金
      '土': ['水'], // 土克水
      '金': ['木'], // 金克木
      '水': ['火']  // 水克火
    };
    return wealthMap[dayElement] || [];
  }

  getWealthDirections(usefulElements) {
    const directionMap = {
      '木': '东方',
      '火': '南方',
      '土': '中央',
      '金': '西方',
      '水': '北方'
    };
    
    return usefulElements.map(element => directionMap[element]).filter(Boolean).join('、');
  }

  getWeakestElement(percents) {
    const elements = [
      { name: '木', value: percents.wood },
      { name: '火', value: percents.fire },
      { name: '土', value: percents.earth },
      { name: '金', value: percents.metal },
      { name: '水', value: percents.water }
    ];
    
    return elements.reduce((weakest, current) => 
      current.value < weakest.value ? current : weakest
    ).name;
  }
}

// ================== 界面渲染函数 ==================
function renderPillars(root, p, timeUnknown = false) {
  if (!root) return;
  root.innerHTML = '';
  
  [['年柱', p.year], ['月柱', p.month], ['日柱', p.day], ['时柱', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === '时柱' && timeUnknown);
    const stem = isUnknown ? '？' : v.stem;
    const branch = isUnknown ? '？' : v.branch;
    
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `;
    root.appendChild(div);
  });
}

function displayClassicArea(p, timeUnknown) {
  const getElement = (s, b) => baziCalculator.getElement(s, b);
  const getNayin = (s, b) => baziCalculator.getNayin(s, b);
  
  // 天干
  setText('year-stem', p.year.stem);
  setText('month-stem', p.month.stem);
  setText('day-stem', p.day.stem);
  setText('hour-stem', timeUnknown ? '？' : p.hour.stem);
  
  // 地支
  setText('year-branch', p.year.branch);
  setText('month-branch', p.month.branch);
  setText('day-branch', p.day.branch);
  setText('hour-branch', timeUnknown ? '？' : p.hour.branch);
  
  // 五行
  setText('year-element', getElement(p.year.stem, p.year.branch));
  setText('month-element', getElement(p.month.stem, p.month.branch));
  setText('day-element', getElement(p.day.stem, p.day.branch));
  setText('hour-element', timeUnknown ? '未知' : getElement(p.hour.stem, p.hour.branch));
  
  // 纳音
  setText('year-nayin', getNayin(p.year.stem, p.year.branch));
  setText('month-nayin', getNayin(p.month.stem, p.month.branch));
  setText('day-nayin', getNayin(p.day.stem, p.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : getNayin(p.hour.stem, p.hour.branch));
}

function updateButlerDisplay(analysis, questionType = 'comprehensive') {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  let content = '';
  
  if (questionType === 'comprehensive') {
    content = analysis.comprehensive;
  } else {
    content = butlerAI.answerQuestion(questionType);
  }
  
  butlerContent.innerHTML = `
    <div style="white-space: pre-wrap; line-height: 1.6;">${content}</div>
  `;
}

function showButlerLoading() {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  butlerContent.innerHTML = `
    <div class="butler-skeleton">
      <div style="width:60%"></div>
      <div style="width:80%"></div>
      <div style="width:90%"></div>
      <div style="width:70%"></div>
      <div style="width:50%"></div>
    </div>
  `;
}

// ================== 主逻辑函数 ==================
const butlerAI = new ButlerAI();

async function genChart() {
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  
  if (!birth) {
    showErr('请填写出生日期。');
    return;
  }

  const btn = $('genBtn');
  const tx = $('genBtnText');
  const ld = $('genBtnLoading');
  
  if (btn) btn.disabled = true;
  if (tx) tx.style.display = 'none';
  if (ld) ld.style.display = 'inline-block';

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12;
    
    if (!timeUnknown) {
      const t = ($('birthtime')?.value || '').trim();
      if (t) {
        const h = parseInt(t.split(':')[0], 10);
        if (!Number.isNaN(h)) hour = h;
      }
    }

    // 计算八字
    const baziData = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    const { pillars, counts, percents, timeUnknown: tu } = baziData;

    // 显示结果区域
    $('result')?.style.setProperty('display', 'block');
    
    // 更新日期显示
    const timeText = tu ? '时间不详' : (hour + '时');
    setText('bazi-date', `出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if (tu) {
      const el = $('bazi-date');
      if (el) el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>';
    }

    // 渲染四柱
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    // 更新五行条
    setBar($('bar-木'), percents.wood);
    setText('pct-木', Math.round(percents.wood) + '%');
    setBar($('bar-火'), percents.fire);
    setText('pct-火', Math.round(percents.fire) + '%');
    setBar($('bar-土'), percents.earth);
    setText('pct-土', Math.round(percents.earth) + '%');
    setBar($('bar-金'), percents.metal);
    setText('pct-金', Math.round(percents.metal) + '%');
    setBar($('bar-水'), percents.water);
    setText('pct-水', Math.round(percents.water) + '%');

    // 五行平衡提示
    const elements = [
      { name: '木', value: percents.wood },
      { name: '火', value: percents.fire },
      { name: '土', value: percents.earth },
      { name: '金', value: percents.metal },
      { name: '水', value: percents.water }
    ];
    
    const strongest = elements.reduce((a, b) => a.value > b.value ? a : b);
    const weakest = elements.reduce((a, b) => a.value < b.value ? a : b);
    
    setText('bazi-elements-balance', 
      `五行中${strongest.name}元素最强，${weakest.name}元素最弱。`
    );

    // 心怜管家分析
    showButlerLoading();
    
    // 模拟分析时间
    setTimeout(() => {
      const analysis = butlerAI.analyzeBazi(baziData);
      updateButlerDisplay(analysis, 'comprehensive');
    }, 1000);

  } catch (err) {
    console.error(err);
    showErr('计算八字时出现错误，请重试');
  } finally {
    if (btn) btn.disabled = false;
    if (tx) tx.style.display = 'inline';
    if (ld) ld.style.display = 'none';
  }
}

// ================== 事件监听 ==================
document.addEventListener('DOMContentLoaded', () => {
  // 生成按钮事件
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', genChart);
  }

  // 心怜管家芯片点击事件
  const chips = document.querySelectorAll('.butler-chip');
  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      const questionType = chip.getAttribute('data-question');
      if (butlerAI.currentAnalysis) {
        updateButlerDisplay(butlerAI.currentAnalysis, questionType);
      } else {
        showErr('请先生成八字命盘');
      }
    });
  });

  // 出生时间不详复选框事件
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }

  // 设置默认日期为今天
  const birthdate = $('birthdate');
  if (birthdate && !birthdate.value) {
    birthdate.value = new Date().toISOString().split('T')[0];
  }

  // 输入框回车事件
  ['birthdate', 'birthtime'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          genChart();
        }
      });
    }
  });
});

// ================== 测试函数 ==================
function testBaziCalculation() {
  console.log('=== 八字计算测试 ===');
  
  // 测试 1978-02-21 12:00
  const testData = baziCalculator.calculateBazi(1978, 2, 21, 12, false);
  console.log('1978-02-21 12:00 八字：');
  console.log('年柱:', testData.pillars.year.stem + testData.pillars.year.branch);
  console.log('月柱:', testData.pillars.month.stem + testData.pillars.month.branch);
  console.log('日柱:', testData.pillars.day.stem + testData.pillars.day.branch);
  console.log('时柱:', testData.pillars.hour.stem + testData.pillars.hour.branch);
  console.log('五行分布:', testData.percents);
}

// 页面加载完成后运行测试
window.addEventListener('load', testBaziCalculation);

console.log('心怜管家系统已加载完成！');
console.log('功能包括：八字计算、五行分析、个性解读、事业建议、感情指导、财运分析、健康养生等');
</script>
</body>
</html>
