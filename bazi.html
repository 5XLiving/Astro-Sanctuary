<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* 头部样式 */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* 主要内容区域 */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* 八字柱样式 */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* 五行能量条 */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* 时间输入行 */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* 生成按钮包装 */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* 详细分析区域 */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* 大运流年 */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .analysis-grid {grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 八字排盘表单 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar">
          <option value="gregorian">阳历</option>
          <option value="lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:45" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果显示区域 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- 详细分析区域 -->
    <div class="card">
      <div class="h2">🧙‍♂️ 命主基本信息</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>🔍 总体命运解读</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💼 事业分析</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💰 财富状况</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>❤️ 婚姻感情</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- 大运流年 -->
    <div class="card">
      <div class="h2">📈 大运流年分析</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>
  </section>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<script>
/* 18) 八字计算器 + 规则 */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='？')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

// 工具函数
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function lock(el, v) { if(el) el.disabled = v; }

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// 渲染八字柱
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: '年柱', pillar: pillars.year },
    { title: '月柱', pillar: pillars.month },
    { title: '日柱', pillar: pillars.day },
    { title: '时柱', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === '时柱' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? '？' : pillar.stem}${isUnknown ? '？' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// 显示详细信息表格
function displayDetailedInfo(pillars, timeUnknown = false) {
  // 天干地支
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? '？' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? '？' : pillars.hour.branch);

  // 五行
  setText('year-element', baziCalculator.getElement(pillars.year.stem, pillars.year.branch));
  setText('month-element', baziCalculator.getElement(pillars.month.stem, pillars.month.branch));
  setText('day-element', baziCalculator.getElement(pillars.day.stem, pillars.day.branch));
  setText('hour-element', timeUnknown ? '未知' : baziCalculator.getElement(pillars.hour.stem, pillars.hour.branch));

  // 纳音
  setText('year-nayin', baziCalculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', baziCalculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', baziCalculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : baziCalculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// 分析日主强弱
function analyzeDayMasterStrength(pillars, counts) {
  const dayStem = pillars.day.stem;
  const dayElement = baziCalculator.getStemElement(dayStem);
  const monthBranch = pillars.month.branch;
  
  // 季节判断
  const seasonMap = {
    '寅':'春','卯':'春','辰':'春',
    '巳':'夏','午':'夏','未':'夏', 
    '申':'秋','酉':'秋','戌':'秋',
    '亥':'冬','子':'冬','丑':'冬'
  };
  
  const season = seasonMap[monthBranch] || '中';
  
  // 日主强弱判断
  let strengthScore = counts[dayElement] || 0;
  
  // 季节加成
  if ((season === '春' && dayElement === '木') ||
      (season === '夏' && dayElement === '火') ||
      (season === '秋' && dayElement === '金') ||
      (season === '冬' && dayElement === '水')) {
    strengthScore += 2;
  }
  
  let strength, pattern;
  if (strengthScore >= 4) {
    strength = '极旺';
    pattern = '建禄格';
  } else if (strengthScore >= 3) {
    strength = '偏旺'; 
    pattern = '身旺格';
  } else if (strengthScore >= 2) {
    strength = '中和';
    pattern = '中和格';
  } else {
    strength = '偏弱';
    pattern = '身弱格';
  }
  
  return { strength, pattern, season };
}

// 生成八字命盘
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('请填写出生日期');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // 显示加载状态
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);

    // 显示结果区域
    $('result').style.display = 'block';

    // 设置日期显示
    const timeText = tu ? '时间不详' : `${hour}时`;
    setText('bazi-date', `出生日期: ${year}年${month}月${day}日 ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">未纳入时柱</span>';
    }

    // 渲染八字柱和详细信息
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // 更新五行能量条
    setBar('bar-木', percents.wood); setText('pct-木', Math.round(percents.wood) + '%');
    setBar('bar-火', percents.fire); setText('pct-火', Math.round(percents.fire) + '%');
    setBar('bar-土', percents.earth); setText('pct-土', Math.round(percents.earth) + '%');
    setBar('bar-金', percents.metal); setText('pct-金', Math.round(percents.metal) + '%');
    setBar('bar-水', percents.water); setText('pct-水', Math.round(percents.water) + '%');

    // 五行平衡分析
    const elementEntries = Object.entries(counts);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `五行中${strongest}元素最强，${weakest}元素最弱。`);

    // 分析日主强弱
    const strengthAnalysis = analyzeDayMasterStrength(pillars, counts);

    // 生成详细分析
    generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, tu);

    console.log('计算出的八字:', 
      pillars.year.stem + pillars.year.branch,
      pillars.month.stem + pillars.month.branch, 
      pillars.day.stem + pillars.day.branch,
      tu ? '？？' : (pillars.hour.stem + pillars.hour.branch)
    );

  } catch (error) {
    console.error('八字计算错误:', error);
    showError('计算八字时出现错误，请重试');
  } finally {
    // 恢复按钮状态
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// 生成详细分析
function generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, timeUnknown) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  // 基本信息
  const name = $('name').value || '未知';
  const gender = $('gender').value === 'male' ? '男' : ($('gender').value === 'female' ? '女' : '未透露');
  
  let basicInfo = `<p><strong>姓名：</strong>${name}</p>`;
  basicInfo += `<p><strong>性别：</strong>${gender}</p>`;
  basicInfo += `<p><strong>日主：</strong>${dayStem}${dayElement}（${strengthAnalysis.strength}）</p>`;
  basicInfo += `<p><strong>格局：</strong>${strengthAnalysis.pattern}</p>`;
  basicInfo += `<p><strong>季节：</strong>${strengthAnalysis.season}</p>`;
  
  $('basic-info').innerHTML = basicInfo;

  // 总体命运解读
  let overallDestiny = '';
  if (strengthAnalysis.strength === '偏旺' || strengthAnalysis.strength === '极旺') {
    overallDestiny = `<p>命主${dayStem}${dayElement}生于${strengthAnalysis.season}季，身旺有力，性格坚毅果断，有领导才能。</p>`;
  } else if (strengthAnalysis.strength === '偏弱') {
    overallDestiny = `<p>命主${dayStem}${dayElement}生于${strengthAnalysis.season}季，身弱需扶，性格温和内敛，善于合作。</p>`;
  } else {
    overallDestiny = `<p>命主${dayStem}${dayElement}生于${strengthAnalysis.season}季，中和平衡，性格稳重，适应力强。</p>`;
  }
  
  $('overall-destiny').innerHTML = overallDestiny;

  // 事业分析
  const careerAnalysis = `<p>${dayStem}${dayElement}日主，适合从事与${getCareerAdvice(dayElement, counts)}相关的行业。${getCareerTrend(strengthAnalysis.strength)}</p>`;
  $('career-analysis').innerHTML = careerAnalysis;

  // 财富状况
  const wealthAnalysis = `<p>${getWealthAnalysis(dayElement, counts, strengthAnalysis.strength)}</p>`;
  $('wealth-analysis').innerHTML = wealthAnalysis;

  // 婚姻感情
  const marriageAnalysis = `<p>${getMarriageAnalysis(dayElement, gender, strengthAnalysis.strength)}</p>`;
  $('marriage-analysis').innerHTML = marriageAnalysis;

  // 大运流年
  generateLuckAnalysis(pillars, gender);
}

// 职业建议
function getCareerAdvice(dayElement, counts) {
  const advice = {
    '木': '教育、文化、艺术、医疗',
    '火': '科技、能源、娱乐、餐饮',
    '土': '房地产、建筑、金融、管理',
    '金': '法律、机械、金融、技术',
    '水': '贸易、物流、旅游、咨询'
  };
  return advice[dayElement] || '多元化领域';
}

// 职业趋势
function getCareerTrend(strength) {
  if (strength === '偏旺' || strength === '极旺') {
    return '适合自主创业或担任领导职位，中年后事业有成。';
  } else if (strength === '偏弱') {
    return '适合在稳定环境中发展，依靠团队合作获得成功。';
  } else {
    return '事业发展平稳，适合在专业领域深耕。';
  }
}

// 财富分析
function getWealthAnalysis(dayElement, counts, strength) {
  const wealthElements = {
    '木': '木旺则财源广进，土为财星',
    '火': '火旺则名利双收，金为财星', 
    '土': '土旺则积蓄丰厚，水为财星',
    '金': '金旺则财运稳定，木为财星',
    '水': '水旺则流动生财，火为财星'
  };
  
  let analysis = wealthElements[dayElement] || '';
  
  if (strength === '偏旺' || strength === '极旺') {
    analysis += ' 身旺能担财，中年后财运亨通，但需注意理财规划。';
  } else if (strength === '偏弱') {
    analysis += ' 身弱财多，需借助他人力量求财，适合稳定收入。';
  } else {
    analysis += ' 财运平稳，通过勤奋努力可获得稳定财富。';
  }
  
  return analysis;
}

// 婚姻分析
function getMarriageAnalysis(dayElement, gender, strength) {
  let analysis = '';
  
  if (gender === '男') {
    analysis = '男命以财为妻，';
    if (strength === '偏旺' || strength === '极旺') {
      analysis += '身旺能担财，婚姻稳定，妻子能干。';
    } else {
      analysis += '身弱需扶，晚婚为宜，妻子多为贤内助。';
    }
  } else if (gender === '女') {
    analysis = '女命以官为夫，';
    if (strength === '偏旺' || strength === '极旺') {
      analysis += '身旺官星有制，婚姻自主，丈夫有为。';
    } else {
      analysis += '身弱官星为忌，需寻包容之伴侣。';
    }
  } else {
    analysis = '婚姻感情需结合具体命局分析，一般来说' + (strength === '偏旺' ? '身旺者婚姻自主' : '身弱者需寻扶持') + '。';
  }
  
  return analysis;
}

// 生成大运流年分析
function generateLuckAnalysis(pillars, gender) {
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const luckCycles = [
    { age: '5-14岁', desc: '童年运势平稳，学业基础阶段' },
    { age: '15-24岁', desc: '青少年时期，性格形成关键期' },
    { age: '25-34岁', desc: '事业起步阶段，积累经验时期' },
    { age: '35-44岁', desc: '中年发展期，事业上升阶段' },
    { age: '45-54岁', desc: '人生黄金期，收获成果之时' },
    { age: '55-64岁', desc: '稳定发展期，规划晚年生活' }
  ];
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// 初始化时间未知功能
function initTimeUnknown() {
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }
}

// 初始化函数
function init() {
  // 设置默认日期为1970-02-21
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    birthdateInput.value = '1970-02-21';
  }

  // 绑定事件
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // 初始化各个模块
  initTimeUnknown();

  // 回车键快速生成
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('八字命理系统初始化完成');
}

// 页面加载完成后初始化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
