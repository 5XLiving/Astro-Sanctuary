<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ï¼Œä¸€ç«™å¼çµæ€§ä¸å‘½ç†ä½“éªŒã€‚">
  <meta property="og:title" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary">
  <meta property="og:description" content="å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ã€‚">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* ================== åŸºç¡€å˜é‡ï¼ˆå”¯ä¸€ä»½ï¼‰ ================== */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
      --gold:#d4af37; --gold2:#f2d27a; --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22);
    }

    /* ================== å…¨å±€æ’ç‰ˆ ================== */
    html,body{height:100%}
    html{font-size:16px}
    @media(min-width:768px){ html{font-size:17px} }
    @media(min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter, system-ui, -apple-system, "Noto Sans SC", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('assets/images/gate.jpg') center/cover no-repeat;
      filter:brightness(.45) saturate(.9) blur(2px);
    }
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* å¤´éƒ¨ */
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em;font-size:1.1rem}
    .subtitle{color:var(--muted);font-size:.9rem}

    /* è¯­è¨€é€‰æ‹©å™¨ */
    .lang{display:flex;align-items:center;gap:8px}
    .lang label{color:var(--muted);font-size:.9rem}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    /* å¡ç‰‡/åˆ†åŒº */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    /* è¡¨å•æ …æ ¼ï¼ˆç»Ÿä¸€å®šä¹‰ï¼Œç§»åŠ¨ç«¯1åˆ—ï¼Œ>=640ï¼š2åˆ—ï¼›å¯ç”¨ .cols-3 æ”¹ä¸º3åˆ—ï¼‰ */
    .row{display:grid;gap:12px}
    @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
    .row.cols-3{grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    .row.cols-2{grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} }

    /* è¡¨å•å…ƒç´  */
    input,select,button{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .muted{color:var(--muted)}

    /* æŒ‰é’®ï¼ˆäº®é‡‘ï¼‰ */
    .btn,.btn-gold{
      display:inline-grid;place-items:center;text-decoration:none;
      padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;cursor:pointer;
      font-weight:700;letter-spacing:.3px;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
      box-shadow:0 6px 18px rgba(230,199,110,.4);transition:.15s;
    }
    .btn:hover,.btn-gold:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* å…«å­—ç»“æœå¸ƒå±€ */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}

    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}

    /* å³ä¸‹æ‚¬æµ®çƒï¼ˆChatï¼‰ */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }

    /* VIP ä¸¤åˆ—ï¼ˆä¿æŒå·¦=å‘½ç†ç©ºé—´ï¼Œå³=å¿ƒæ€œç©ºé—´ï¼‰ */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}

    /* ä¼šå‘˜ç™»å½•å¡ç‰‡ï¼ˆEmail/Password æ¡Œé¢ç«¯å·¦å³å¹¶æ’ï¼‰ */
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid var(--border);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}

    /* ç™»å½•è¡¨å•è¡Œï¼šé»˜è®¤ä¸¤åˆ—ï¼Œç§»åŠ¨ç«¯è‡ªåŠ¨ä¸€åˆ— */
    .astro-auth .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:640px){ .astro-auth .row{grid-template-columns:1fr} }
    .row.one{grid-template-columns:1fr}

    .astro-auth input[type="email"], .astro-auth input[type="password"]{
      width:100%;background:#0f1522;color:#eaf0ff;border:1px solid rgba(212,175,55,.28);border-radius:10px;padding:13px 12px;outline:none;transition:.18s
    }
    .astro-auth input:focus{border-color:var(--gold2);box-shadow:0 0 0 3px rgba(212,175,55,.2)}
    .error{color:#ffb4b4;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.25);padding:10px 12px;border-radius:10px;margin-top:8px}
    .spacer{height:12px}

    /* ç»†èŠ‚ä¸è¾…åŠ© */
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .link-card{display:flex;align-items:center;justify-content:center;text-align:center;padding:16px 12px;border:1px solid #263448;background:#0e1520;border-radius:12px;text-decoration:none;color:var(--text);transition:transform .05s ease, box-shadow .2s ease}
    .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  </style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">å‘½ç†ä¾›é—¨ Â· å…«å­—ç®€è¯„</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰">
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender"><option value="">ä¸é€éœ²</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar"><option value="gregorian">é˜³å† / Gregorian</option><option value="lunar">å†œå† / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> å‡ºç”Ÿæ—¶é—´ä¸è¯¦</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

      <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

<!-- ç™»å½•/æ³¨å†Œè¡¨å•ï¼Œæ”¯æŒå›è½¦æäº¤ -->
<section class="astro-auth">
  <div class="auth-grid">
    <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
    <div class="panel">
      <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
      <div class="body">
        <!-- ç‹¬ç«‹è¾“å…¥åŒºï¼ˆç™»å½•/æ³¨å†Œå…±äº«è¿™äº›è¾“å…¥ï¼‰ -->
        <div class="row" id="authFields">
          <label for="email" class="sr-only">Email</label>
          <input
            id="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            placeholder="é‚®ç®± Email"
            data-i18n-ph="ph_email"
            required
          />

          <input
            id="password"
            type="password"
            autocomplete="new-password"
            placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
            data-i18n-ph="ph_password"
            required
           />
        </div>

        <div class="spacer"></div>

        <!-- ç™»å½•è¡¨å•ï¼ˆå¤ç”¨ä¸Šæ–¹ä¸¤æ ¼è¾“å…¥ï¼‰ -->
        <form id="loginForm" class="row one">
          <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
        </form>

        <div class="spacer"></div>

        <!-- é‡è®¾å¯†ç ï¼ˆæŒ‰é’®éæäº¤ï¼‰ -->
        <div class="row one">
          <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
        </div>

        <div class="spacer"></div>

        <!-- æ³¨å†Œè¡¨å•ï¼ˆå¤ç”¨ä¸Šæ–¹ä¸¤æ ¼è¾“å…¥ï¼‰ -->
        <form class="row one" id="registerForm">
          <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
        
        <div class="muted" data-i18n="note_price">
        æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ
        </div>  

        <div class="spacer"></div>

        <div class="error" id="error" style="display:none"></div>
      </div>
    </div>
    </form>
    
    <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
    <div class="panel">
      <div class="head">ä¼šå‘˜æœåŠ¡</div>
      <div class="body">
        <div class="row one">
          <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
        </div>

        <div class="spacer"></div>

        <div class="row one">
          <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
        </div>

        <div class="spacer"></div>
        <div class="muted" data-i18n="note_price1">
          $9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰
        </div>
      </div>
    </div>
  </div>
</section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

<script>
'use strict';

/* ================== ç»Ÿä¸€é…ç½® ================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

/* ================== å·¥å…·å‡½æ•° ================== */
const $ = (id) => document.getElementById(id);
const q  = (sel, root=document) => root.querySelector(sel);
const qa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const on = (id, evt, handler) => { const el = $(id); if (el && typeof el.addEventListener === 'function') el.addEventListener(evt, handler); };
function showErr(msg){ const e=$("error"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ================== å¤šè¯­è¨€ ================== */
const LANG_KEY = "site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

/* ä½ çš„ç¿»è¯‘è¡¨ï¼ˆä¿ç•™å¹¶æ‰©å±•äº† chat_* æ–‡æ¡ˆï¼‰ */
const translations = {
  "zh-CN": { page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Index", site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary", site_subtitle:"å…è´¹ä½“éªŒ & ä¼šå‘˜ä¸“åŒº Â· ç»Ÿä¸€é£æ ¼ç‰ˆ", lang_label:"è¯­è¨€",
    free_title:"ğŸŒ€ å…è´¹ä½“éªŒåŒº Free Segment", link_bazi:"å…«å­—å‘½ç†åˆ†æ", link_natal:"æœ¬å‘½æ˜Ÿç›˜åˆ†æ", link_life:"çµæ•°åˆ†æ", link_tarot:"å¡”ç½—æŒ‡å¼•åˆ†æ", link_kyuusei:"ä¹æ˜Ÿæ°”å­¦åˆ†æ", link_energy:"èƒ½é‡ç±»å‹åˆ†æ", link_vedic:"å°åº¦å‘½ç†å é™€å æ˜Ÿ",
    vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment", vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹", vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿", vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›", vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº", vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†", vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿", vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ", vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹", vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾", vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­", vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡", vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½", ph_email:"é‚®ç®± Email", ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰", btn_register:"æ³¨å†Œè´¦æˆ·", btn_login:"ç™»å…¥è´¦æˆ·", btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰", btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
    btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ", note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ", note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
    err_need_ep:"è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ", err_pwd_rule:"å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·", err_exists:"æ­¤é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å…¥", err_register_fail:"æ³¨å†Œå¤±è´¥ï¼š",
    err_no_account:"è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ", err_wrong_pwd:"å¯†ç é”™è¯¯", err_expired:"ä¼šå‘˜å·²è¿‡æœŸï¼Œè¯·ç»­è´¹", err_login_fail:"ç™»å…¥å¤±è´¥ï¼š", prompt_email:"è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š", err_email_empty:"é‚®ç®±ä¸èƒ½ä¸ºç©º",
    prompt_newpwd:"è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š", err_pwd_empty:"å¯†ç ä¸èƒ½ä¸ºç©º", err_reset_fail:"é‡è®¾å¤±è´¥ï¼š", msg_reset_ok:"å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚",
    chat_fab:"é—®", chat_placeholder:"è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ï¼šå¦‚ä½•å¼€å§‹å…è´¹ä½“éªŒï¼‰", chat_send:"å‘é€"
  },
  "zh-TW": { /* çœç•¥ï¼šä¸ä½ ä¸Šæ¡ä¸€è‡´ */ },
  "en":    { /* çœç•¥ï¼šä¸ä½ ä¸Šæ¡ä¸€è‡´ */ },
  "ja":    { /* çœç•¥ï¼šä¸ä½ ä¸Šæ¡ä¸€è‡´ */ },
  "th":    { /* çœç•¥ï¼šä¸ä½ ä¸Šæ¡ä¸€è‡´ */ },
  "ms":    { /* çœç•¥ï¼šä¸ä½ ä¸Šæ¡ä¸€è‡´ */ }
};
function t(key){ const L = translations[getLang()] || translations["zh-CN"]; return L[key] || (translations["zh-CN"][key] || key); }
function applyI18n(){
  qa("[data-i18n]").forEach(el=>{ const key = el.getAttribute("data-i18n"); el.textContent = t(key); });
  qa("[data-i18n-ph]").forEach(el=>{ const key = el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(key)); });
  const titleEl = q("title[data-i18n]"); if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
function applyChatI18n(){
  const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
}

/* ================== å…«å­—è®¡ç®—å™¨ï¼ˆä¿æŒä½ çš„ç®—æ³•ï¼‰ ================== */
class BaziCalculator{
  constructor(){ this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']; this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']; this.ZODIAC=['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª']; this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´']; }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'}; const b={å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; }
  getBranchElement(branch){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='ï¼Ÿ')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='ï¼Ÿ')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['æœ¨']/total*100,fire:cnt['ç«']/total*100,earth:cnt['åœŸ']/total*100,metal:cnt['é‡‘']/total*100,water:cnt['æ°´']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

/* ================== è§„åˆ™/æ¸²æŸ“ ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='æ—¶æŸ±'&&timeUnknown); const stem=u?'ï¼Ÿ':v.stem,branch=u?'ï¼Ÿ':v.branch;
    const div=document.createElement('div'); div.className='pillar'; div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`; root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem); setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);
  const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'æœªçŸ¥':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'æœªçŸ¥':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan,monthZhi,cnt){
  const STEM_ELEM={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH={å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0; if((season==='æ˜¥'&&'æœ¨ç«'.includes(dmEl))||(season==='å¤'&&'ç«åœŸ'.includes(dmEl))||(season==='ç§‹'&&dmEl==='é‡‘')||(season==='å†¬'&&dmEl==='æ°´')) score+=2;
  score+=(cnt[dmEl]||0)*1.2; const mark=score>=3?'åå¼º':(score<=1?'åå¼±':'å¹³è¡¡'); const focus=mark==='åå¼º'?'æ³„ç§€/åˆ¶åŒ–':(mark==='åå¼±'?'è¡¥åŠ©/é¡ºåŠ¿':'å®ˆä¸­/è°ƒå’Œ'); return{season,mark,focus};
}
function chooseUseful(strength,dmElem){
  if(strength==='åå¼º') return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful:({æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']})[dmElem], avoid:[dmElem]};
  if(strength==='åå¼±') return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:({æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']})[dmElem], avoid:[]};
  return {strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}

/* ================== å¿ƒæ€œç®¡å®¶ï¼ˆåˆ†æå™¨ï¼‰ ================== */
class XinLianAssistant{
  constructor(){ this.currentContext=null; }
  generateAnalysis(baziData){ this.currentContext=baziData; const a=$('assistant-analysis'), b=$('assistant-advice'); if(a) a.innerHTML=this.analyzeBazi(baziData); if(b) b.innerHTML=this.generateAdvice(baziData); }
  analyzeBazi({dayMaster,elements,strength,season,timeUnknown}){
    const timeNote=timeUnknown?'<li><strong>æ³¨æ„ï¼š</strong>å·²å‹¾é€‰â€œå‡ºç”Ÿæ—¶é—´ä¸è¯¦â€ï¼Œ<strong>æœªçº³å…¥æ—¶æŸ±</strong>ã€‚</li>':'';
    return `<ul class="ul"><li>æ—¥ä¸»ï¼š<strong>${dayMaster.stem}ï¼ˆ${dayMaster.element}ï¼‰</strong></li><li>å‘½å±€<strong>${strength.mark}</strong>ï¼š${this.getStrengthDescription(strength.mark)}</li><li>å­£èŠ‚ï¼š<strong>${season}</strong>ï¼Œ${this.getSeasonInfluence(season)}</li><li>äº”è¡Œåˆ†å¸ƒï¼š${this.getElementDistribution(elements)}</li>${timeNote}</ul>`;
  }
  generateAdvice({strength,useful,timeUnknown}){ const timeWarn=timeUnknown?'<li><strong>æç¤ºï¼š</strong>æ— æ—¶æŸ±ï¼Œå»ºè®®ä»…ä½œå‚è€ƒã€‚</li>':''; return `<ul class="ul"><li><strong>å‘å±•ç­–ç•¥ï¼š</strong>${strength.focus}</li><li><strong>å–œç”¨å…ƒç´ ï¼š</strong>${(useful.useful||[]).join('ã€')}</li><li><strong>å¹¸è¿é¢œè‰²ï¼š</strong>${this.getLuckyColors(useful.useful||[])}</li><li><strong>é€‚åˆæ–¹ä½ï¼š</strong>${this.getLuckyDirections(useful.useful||[])}</li>${timeWarn}</ul>`; }
  getStrengthDescription(m){ return {åå¼º:'æ½œåŠ›è¶³ã€æŠ—å‹å¥½',åå¼±:'éœ€å¤–æ´æ›´èƒ½å‘æŒ¥',å¹³è¡¡:'å‡è¡¡ã€é€‚åº”æ€§å¼º'}[m]||'å…·æœ‰ç‹¬ç‰¹ç‰¹ç‚¹'; }
  getSeasonInfluence(season){ const m={æ˜¥:'æœ¨æ—ºç”Ÿå‘',å¤:'ç«æ—ºå¤–æ”¾',ç§‹:'é‡‘æ—ºæ”¶æ•›',å†¬:'æ°´æ—ºå†…è—'}; return m[season]||'å­£èŠ‚å¯¹å‘½å±€æœ‰ä¸€å®šå½±å“'; }
  getLuckyColors(list){ const m={æœ¨:'ç»¿è‰²/é’è‰²',ç«:'çº¢è‰²/ç´«è‰²',åœŸ:'é»„è‰²/æ£•è‰²',é‡‘:'ç™½è‰²/é‡‘è‰²',æ°´:'é»‘è‰²/è“è‰²'}; return list.map(x=>m[x]).filter(Boolean).join('ã€'); }
  getLuckyDirections(list){ const m={æœ¨:'ä¸œæ–¹',ç«:'å—æ–¹',åœŸ:'ä¸­å¤®/ä¸œåŒ—/è¥¿å—',é‡‘:'è¥¿æ–¹',æ°´:'åŒ—æ–¹'}; return list.map(x=>m[x]).filter(Boolean).join('ã€'); }
  ELABEL(){ return {wood:'æœ¨',fire:'ç«',earth:'åœŸ',metal:'é‡‘',water:'æ°´'}; }
  getElementDistribution(elements){ const L=this.ELABEL(); return Object.entries(elements).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${L[k]||k}${Math.round(v)}%`).join('ã€'); }
}

/* ================== å…è´¹/å¯Œå†…å®¹æŠ¥å‘Š ================== */
function buildFreeReportHTML({pillars,percents,st,adv,timeUnknown}){
  const L={wood:'æœ¨',fire:'ç«',earth:'åœŸ',metal:'é‡‘',water:'æ°´'};
  const entries=Object.entries(percents); const strongestK=entries.reduce((a,b)=>a[1]>b[1]?a:b)[0]; const weakestK=entries.reduce((a,b)=>a[1]<b[1]?a:b)[0];
  const strongest=L[strongestK], weakest=L[weakestK]; const absents=Object.keys(percents).filter(k=>Math.round(percents[k])===0).map(k=>L[k]).join('ã€');
  const fmt=k=>`${L[k]} ${Math.round(percents[k]||0)}%`; const line=['wood','fire','earth','metal','water'].map(fmt).join('ã€€');
  const fav=(adv?.useful||[]).join('ã€'); const avoid=(adv?.avoid||[]).join('ã€')||'â€”'; const hourTxt=timeUnknown?'ï¼Ÿï¼Ÿ':(pillars.hour.stem+pillars.hour.branch);
  return `<div class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);"><h3 style="margin:0 0 8px;color:var(--brand)">å…è´¹æŠ¥å‘Š</h3><p style="margin:6px 0;">å››æŸ±ï¼š<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p><p style="margin:6px 0;">æ—¥ä¸»ï¼š<strong>${pillars.day.stem}</strong>ï¼ˆ<strong>${pillars.day.element}</strong>ï¼‰ï½œå­£èŠ‚ï¼š<strong>${st.season||'-'}</strong>ï½œå‘½å±€ï¼š<strong>${st.mark}</strong> Â· <strong>${st.focus}</strong></p><p style="margin:8px 0;">äº”è¡Œï¼š${line}</p><p style="margin:4px 0;"><strong>${strongest}</strong>åæ—ºï¼›<strong>${weakest}</strong>åå¼±ã€‚${absents?`<span style="color:var(--muted)">ï¼ˆç¼ºï¼š${absents}ï¼‰</span>`:''}</p><ul style="margin:6px 0 0 18px;line-height:1.6"><li>å–œç”¨ä¼˜å…ˆï¼š<strong>${fav||'â€”'}</strong>ï¼›å¿Œè®³ï¼š${avoid}</li><li>è°ƒè¡¡è¦ç‚¹ï¼š${st.focus}</li></ul>${timeUnknown?`<p style="margin:6px 0 0;color:var(--muted)">æç¤ºï¼šæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥ã€‚</p>`:''}</div>`;
}
function buildRichReportHTML({pillars,percents,st,adv,timeUnknown}){
  const L={wood:'æœ¨',fire:'ç«',earth:'åœŸ',metal:'é‡‘',water:'æ°´'}; const P=pillars;
  const line=['wood','fire','earth','metal','water'].map(k=>`${L[k]}${Math.round(percents[k]||0)}%`).join(' ');
  const entries=Object.entries(percents); const strongestK=entries.reduce((a,b)=>a[1]>b[1]?a:b, ['wood',0])[0]; const weakestK=entries.reduce((a,b)=>a[1]<b[1]?a:b, ['wood',0])[0];
  const strongest=L[strongestK]||'â€”', weakest=L[weakestK]||'â€”'; const absents=Object.keys(percents).filter(k=>Math.round(percents[k]||0)===0).map(k=>L[k]).join('ã€');
  const favList=(adv?.useful||[]).join('ã€')||'â€”', avoidList=(adv?.avoid||[]).join('ã€')||'â€”'; const hourTxt=timeUnknown?'ï¼Ÿï¼Ÿ':(P.hour.stem+P.hour.branch);
  return `
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">ä¸€ã€å‘½ç›˜æ€»è§ˆ</h3>
    <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
      <div>å››æŸ±ï¼š<strong>${P.year.stem}${P.year.branch} ${P.month.stem}${P.month.branch} ${P.day.stem}${P.day.branch} ${hourTxt}</strong></div>
      <div>æ—¥ä¸»ï¼š<strong>${P.day.stem}</strong>ï¼ˆ<strong>${P.day.element}</strong>ï¼‰</div>
      <div>å­£èŠ‚ï¼š<strong>${st.season||'-'}</strong></div>
      <div>å‘½å±€ï¼š<strong>${st.mark}</strong> Â· ç­–ç•¥ï¼š<strong>${st.focus}</strong></div>
    </div></section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">äºŒã€äº”è¡Œèƒ½é‡åˆ†æ</h3>
    <div style="font-size:14px;">${line}</div>
    <p style="margin:10px 0 0;"><strong>${strongest}</strong>åæ—ºï¼›<strong>${weakest}</strong>åå¼±ã€‚${absents?`<span class="muted">ï¼ˆç¼ºï¼š${absents}ï¼‰</span>`:''}</p>
    <ul style="margin:10px 0 0 18px;line-height:1.6"><li>å–œç”¨ä¼˜å…ˆï¼š<strong>${favList}</strong></li><li>è°ƒè¡¡è¦ç‚¹ï¼š${st.focus}</li></ul>
    ${timeUnknown?`<p class="muted" style="margin-top:8px;">æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ã€‚</p>`:''}
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">ä¸‰ã€æ€§æ ¼ä¸å¤©èµ‹</h3>
    <p style="margin:8px 0;">ä¾æ®æ—¥ä¸»ã€å­£èŠ‚ä¸å¼ºå¼±ç»™å‡ºæ ¸å¿ƒæ€§æ ¼æ ‡ç­¾ï¼ˆæ¨¡æ¿åŒ–ï¼‰ã€‚</p>
    <p style="margin:8px 0;">ä¼˜åŠ¿èƒ½é‡ï¼šæ‰§è¡Œ/åˆ›é€ /å­¦ä¹ ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;">æ½œåœ¨æŒ‘æˆ˜ï¼šæ€¥èº/è¾¹ç•Œï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">å››ã€æ ¼å±€ä¸å–œå¿Œ</h3>
    <p style="margin:8px 0;">å–œç”¨ï¼š${favList}ï¼›å¿Œè®³ï¼š${avoidList}</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">äº”ã€äº‹ä¸šä¸å‘å±•ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;">é€‚åˆé¢†åŸŸï¼šä¾æ®å–œç”¨ä¸æ—¥ä¸»æ°”è´¨ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;">å‘å±•ç­–ç•¥ï¼š${st.focus}ï¼Œå»ºç«‹ SOP</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">å…­ã€æ„Ÿæƒ…ä¸å…³ç³»ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;">æ²Ÿé€šèŠ‚å¥ä¸è¾¹ç•Œï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">ä¸ƒã€è´¢å¯Œä¸ç†è´¢ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;">ç†è´¢å»ºè®®ï¼šä»¥ ${favList} ä¸ºä¸»è°ƒï¼Œç¨³ä¸­æ±‚è¿›</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">å…«ã€å¥åº·ä¸ä½œæ¯</h3>
    <p style="margin:8px 0;">æŒ‰æœ€å¼±äº”è¡Œï¼ˆ${weakest}ï¼‰åˆ¶å®šä½œæ¯ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>
  <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">ä¹ã€ç¯å¢ƒä¸è‰²å½©</h3>
    <p style="margin:8px 0;">æœ‰åˆ©æ–¹ä½ä¸é…è‰²éšå–œç”¨ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>
  <section class="card" style="padding:20px;margin-bottom:10px;"><h3 style="margin-top:0;color:var(--brand)">è§£é”å®Œæ•´ä¸“å±æŠ¥å‘Š</h3>
    <p style="margin:8px 0;">å‡çº§ VIP è·å– â€œäº‹ä¸šç­–ç•¥æ ‘ / å©šå§»åˆç›˜ / 90 å¤©é‡Œç¨‹ç¢‘ / é£æ°´å¾®è°ƒ / ç¥ˆæ„¿ä¿®å¿ƒâ€ã€‚</p>
    <div style="margin-top:10px;"><a href="/vip" style="display:inline-block;padding:10px 16px;border-radius:10px;background:var(--brand);color:#111;font-weight:700;text-decoration:none;">å‡çº§ VIP</a></div>
  </section>`;
}
function mountRichReport({pillars,percents,st,adv,timeUnknown}){
  let host=$('xl-rich-report'); if(!host){ host=document.createElement('section'); host.id='xl-rich-report'; host.className='container'; host.style.paddingTop='12px'; ( $('result') || document.body).appendChild(host); }
  host.innerHTML=buildRichReportHTML({pillars,percents,st,adv,timeUnknown});
}

/* ================== ç®¡å®¶å¡ç‰‡ & GPT æŠ½å±‰ ================== */
function buildButlerHTML(){ return `<div id="assistant-panel" class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);"><h3 style="margin:0 0 8px;color:var(--brand)">å¿ƒæ€œç®¡å®¶ Â· æ™ºèƒ½è§£è¯»</h3><div id="assistant-analysis"></div><div id="assistant-advice" style="margin-top:8px"></div></div>`; }
function buildChatDrawerHTML(){ return `<details id="" class="xl-card" style="margin-top:12px;padding:0;border-radius:10px;background:var(--card);box-shadow:var(--shadow);"><summary style="cursor:pointer;list-style:none;padding:12px 16px;font-weight:700;color:var(--brand);">GPT é—®ç­”</summary><div style="padding:10px 12px;"><div id="gpt-body" style="max-height:260px;overflow:auto;font-size:14px;line-height:1.5;border:1px solid #222;border-radius:8px;padding:8px;"></div><div style="display:flex;gap:8px;margin-top:8px;"><input id="gpt-input" placeholder="é—®ç‚¹ä»€ä¹ˆâ€¦" style="flex:1;padding:8px;border-radius:8px;border:1px solid #222;background:#0b0f14;color:var(--text)"><button id="gpt-send" style="padding:8px 12px;border-radius:8px;background:var(--brand);color:#111;font-weight:700">å‘é€</button></div></div></details>`; }
async function callChatAPI(userText,ctx){
  const payload={messages:[{role:'user',content:userText}],context:ctx};
  async function post(url){ try{ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(r.ok){ const t=await r.text(); try{ const j=JSON.parse(t); return j.reply||t||'ï¼ˆæ— å“åº”ï¼‰'; }catch{return t||'ï¼ˆæ— å“åº”ï¼‰'; } } }catch(_){} return null; }
  return await post('/api/butler/chat') || await post('/api/chat') || 'ï¼ˆæš‚æ—¶æ— æ³•è¿æ¥åˆ°æœåŠ¡ç«¯ï¼‰';
}

/* ================== ç»Ÿä¸€æŒ‚è½½ ================== */
function mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown}){
  const resultEl=$('result'); if(!resultEl){ console.warn('[mount] æ‰¾ä¸åˆ° #result'); return; }
  let freeNode=$('xl-free-report'); if(!freeNode){ freeNode=document.createElement('div'); freeNode.id='xl-free-report'; resultEl.appendChild(freeNode); }
  freeNode.innerHTML=buildFreeReportHTML({pillars,percents,st,adv,timeUnknown});
  let butler=$('assistant-panel'); if(!butler){ const wrap=document.createElement('div'); wrap.innerHTML=buildButlerHTML(); resultEl.appendChild(wrap.firstElementChild); }
  const ctx={ dayMaster:{stem:pillars.day.stem,element:pillars.day.element}, elements:percents, strength:st, season:st.season, useful:adv, timeUnknown };
  new XinLianAssistant().generateAnalysis(ctx);
  window.__bazi_ctx__={pillars,wuxing_ratio:percents,season:st.season,strength:st.mark,strategy:st.focus,useful:adv?.useful||[],timeUnknown};
}

/* ================== ç”Ÿæˆå‘½ç›˜ ================== */
async function genChart(){
  const birth=($('birthdate')?.value||'').trim(); const timeUnknown=$('timeUnknown')?.checked||false;
  if(!birth){ showErr('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸã€‚'); return; }
  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading'); if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';
  try{
    const [Y,M,D]=birth.split('-').map(Number); let hour=12;
    if(!timeUnknown){ const t=($('birthtime')?.value||'').trim(); if(t) hour=parseInt(t.split(':')[0],10); }
    const {pillars,counts,percents,timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    $('result')?.style.setProperty('display','block'); ensureGPTDrawer();
    const timeText=tu?'æ—¶é—´ä¸è¯¦':(hour+'æ—¶'); setText('bazi-date',`å‡ºç”Ÿæ—¥æœŸ: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if(tu){ const el=$('bazi-date'); el&&(el.innerHTML+=' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>'); }

    renderPillars($('bazi-pillars'),pillars,tu); displayClassicArea(pillars,tu);
    setBar($('bar-æœ¨'),percents.wood);  setText('pct-æœ¨',Math.round(percents.wood)+'%');
    setBar($('bar-ç«'),percents.fire);  setText('pct-ç«',Math.round(percents.fire)+'%');
    setBar($('bar-åœŸ'),percents.earth); setText('pct-åœŸ',Math.round(percents.earth)+'%');
    setBar($('bar-é‡‘'),percents.metal); setText('pct-é‡‘',Math.round(percents.metal)+'%');
    setBar($('bar-æ°´'),percents.water); setText('pct-æ°´',Math.round(percents.water)+'%');

    const st=judgeStrength(pillars.day.stem,pillars.month.branch,counts);
    const adv=chooseUseful(st.mark,pillars.day.element);
    const keys=Object.keys(counts); const maxK=keys.reduce((a,b)=>counts[a]>counts[b]?a:b); const minK=keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance',`äº”è¡Œä¸­${maxK}å…ƒç´ æœ€å¼ºï¼Œ${minK}å…ƒç´ æœ€å¼±ã€‚`);

    mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown:tu});
    mountRichReport({pillars,percents,st,adv,timeUnknown:tu});

    // åç«¯ç®¡å®¶è§£è¯´ï¼ˆå¤±è´¥é™é»˜ï¼‰
    try{
      const payload={ profile:{ name:$('name')?.value||'',gender:$('gender')?.value||'',calendar:$('calendar')?.value||'gregorian',birth:`${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`,time:tu?null:($('birthtime')?.value||''),timezone:'+08:00' },
        chart:{ year:pillars.year,month:pillars.month,day:{stem:pillars.day.stem,branch:pillars.day.branch},hour:tu?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:pillars.hour,day_master:pillars.day.stem,season:st.season,wuxing_ratio:{wood:percents.wood,fire:percents.fire,earth:percents.earth,metal:percents.metal,water:percents.water} },
        prefs:{ lang:getLang(), tier:'free' } };
      const resp=await fetch('/api/butler/explain',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>r.json()).catch(()=>null);
      const ana=$('assistant-analysis'), advc=$('assistant-advice'); if(resp&&resp.layout){ if(ana&&resp?.layout?.cards?.[0]?.html) ana.innerHTML=resp.layout.cards[0].html; if(advc&&resp?.layout?.cards?.[1]?.html) advc.innerHTML=resp.layout.cards[1].html; }
    }catch(_){}

    console.log('å®é™… â†’', pillars.year.stem+pillars.year.branch, pillars.month.stem+pillars.month.branch, pillars.day.stem+pillars.day.branch, tu?'ï¼Ÿ':(pillars.hour.stem+pillars.hour.branch));
  }catch(err){ console.error(err); showErr('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•'); }
  finally{ if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none'; }
}

/* ================== ç™»å½•æµç¨‹ ================== */
async function safeJson(resp){ try{return await resp.json()}catch{return{ok:false,msg:'upstream_error'}} }
async function loginFlow(email,password){
  const res=await safeJson(await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
  const msg=(res.msg||"").toString().toLowerCase(); let expired=false;
  if(res.expired===true) expired=true; else if(msg==='expired') expired=true; else if(res.expiresAt){ const ts=Date.parse(res.expiresAt); if(!Number.isNaN(ts)&&ts<Date.now()) expired=true; }
  if(expired){ const go=confirm(t('err_expired')+'ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ'); if(go) window.open('https://yourshopifyshop.com/products/monthly-vip','_blank'); return; }
  if(res.ok===true){ localStorage.setItem('vipEmail',res.email||email); location.href='https://astro.5xliving.com/vip_soul_sanctuary.html'; return; }
  if(msg==='no_account') return showErr(t('err_no_account')); if(msg==='wrong_pwd') return showErr(t('err_wrong_pwd')); return showErr(t('err_login_fail')+(res.msg?` ${res.msg}`:''));
}

/* ================== DOM å°±ç»ªï¼šä¸€æ¬¡æ€§åˆå§‹åŒ– ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Chat æµ®çª—ï¼ˆæŒ‰é’®+é¢æ¿ï¼‰
  const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title='å¿ƒæ€œç®¡å®¶';
  const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');
  chatPanel.innerHTML=`<div class="ss-chat-head"><div class="ss-chat-title">å¿ƒæ€œç®¡å®¶ Â· Chat</div><div class="ss-close" id="ssChatClose">âœ•</div></div><div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div><div class="ss-chat-input"><input id="ssChatInput" type="text"/><button id="ssChatSend"></button></div>`;
  document.body.appendChild(chatFab); document.body.appendChild(chatPanel);

  // è¯­è¨€
  const select=$("langSelect"); const current=getLang(); if(select) select.value=current; applyI18n(); applyChatI18n();
  if(select){ select.addEventListener('change', ()=>{ setLang(select.value); applyI18n(); applyChatI18n(); }); }

  // Chat è¡Œä¸º
  const $body=$('ssChatBody'), $input=$('ssChatInput'), $send=$('ssChatSend'), $close=$('ssChatClose');
  const openPanel=()=>{ chatPanel.style.display='flex'; $input&&$input.focus(); }; const closePanel=()=>{ chatPanel.style.display='none'; };
  chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);
  function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
  async function askChat(prompt){ addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); } try{ const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ï¼Œè¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚'},{role:'user',content:prompt}]})}); let data,reply=''; try{data=await r.json()}catch{data={}} reply=data.reply??data.text??data?.choices?.[0]?.message?.content??""; if(!reply) return addMsg('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚'); addMsg(reply);}catch(e){ addMsg('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚'); } }
  $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
  $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

  // === å¼€å…³ï¼šæ˜¯å¦æ˜¾ç¤ºâ€œGPT é—®ç­”â€æŠ½å±‰ï¼ˆä¸æ˜¯å³ä¸‹è§’å¿ƒæ€œç®¡å®¶æµ®çª—ï¼‰===
  const ENABLE_INLINE_GPT_QA = false;

  // è¡¨å•é»˜è®¤å€¼ä¸ç»‘å®š
  const today=new Date(); const def=today.toISOString().split('T')[0]; if($('birthdate')&&!$('birthdate').value) $('birthdate').value=def;
  const tChk=$('timeUnknown'), tBox=$('timeInputContainer'); if(tChk){ tChk.addEventListener('change', function(){ tBox && tBox.classList.toggle('disabled', this.checked); }); }
  $('genBtn')?.addEventListener('click',genChart);

  // è´¦å·ç›¸å…³ï¼ˆå®‰å…¨ç»‘å®šï¼Œä¸å­˜åœ¨ä¸æŠ¥é”™ï¼‰
  on('registerForm','submit', async (e)=>{ e.preventDefault(); hideErr(); const email=$('email').value.trim(); const password=$('password').value.trim(); if(!email||!password) return showErr(t('err_need_ep')); if(!strongPwd(password)) return showErr(t('err_pwd_rule')); lock($('registerBtn'),true); try{ const res=await safeJson(await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})})); if(res.ok===true){ localStorage.setItem('vipEmail',email); location.href='vip_trial.html'; return; } if((res.msg||"").toString()==='exists'){ await loginFlow(email,password); return; } return showErr((res.msg&&(res.msg+''))||t('err_register_fail')); }catch(err){ showErr(t('err_register_fail')+(err?.message||'')); }finally{ lock($('registerBtn'),false); } });
  on('loginForm','submit', async (e)=>{ e.preventDefault(); hideErr(); const email=$('email').value.trim(); const password=$('password').value.trim(); if(!email||!password) return showErr(t('err_need_ep')); lock($('loginBtn'),true); try{ await loginFlow(email,password); }catch(err){ showErr(t('err_login_fail')+(err?.message||'')); }finally{ lock($('loginBtn'),false); } });
  on('resetBtn','click', async ()=>{ hideErr(); let email=prompt(t('prompt_email')); if(email===null) return; email=email.trim(); if(!email) return showErr(t('err_email_empty')); let newPassword=prompt(t('prompt_newpwd')); if(newPassword===null) return; newPassword=newPassword.trim(); if(!newPassword) return showErr(t('err_pwd_empty')); if(!strongPwd(newPassword)) return showErr(t('err_pwd_rule')); lock($('resetBtn'),true); try{ const res=await safeJson(await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword})})); if(!res.ok) return showErr((res.msg&&(res.msg+''))||t('err_reset_fail')); alert(t('msg_reset_ok')); }catch(err){ showErr(t('err_reset_fail')+(err?.message||'')); }finally{ lock($('resetBtn'),false); } });
});

/* ================== è‡ªæµ‹ï¼š1978-02-21 12:00ï¼ˆUTC+8ï¼‰ ================== */
(function(){
  const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12);
  console.log('åº”ä¸º â†’ å¹´ æˆŠåˆï½œæœˆ ç”²å¯…ï½œæ—¥ ç”²å¯…ï½œæ—¶ åºšåˆ');
  console.log('å®é™… â†’', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
