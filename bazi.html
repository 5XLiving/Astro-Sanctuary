<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…«å­—å‘½ç† Â· 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f14;
  --card: #11161dcc;
  --line: #1f2a36;
  --text: #e8edf3;
  --muted: #9aa3b2;
  --brand: #d4af37;
  --gold: #d4af37;
  --gold2: #f2d27a;
  --radius: 14px;
  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --accent: #3a86ff;
  --success: #4cc9a7;
  --warning: #ff9e00;
  --danger: #ff5a5f;
}

html, body {
  height: 100%;
  margin: 0;
  color: var(--text);
  background: var(--bg);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(135deg, #0b0f14 0%, #1a2433 100%);
  filter: brightness(.8);
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px 16px 80px;
}

header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #0b0f14cc;
  border-bottom: 1px solid #0f1622;
  backdrop-filter: saturate(140%) blur(12px);
}

.head-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-badge {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(145deg, #273243, #0e141c);
  display: grid;
  place-items: center;
  color: var(--brand);
  font-weight: 700;
  box-shadow: var(--shadow);
}

.title {
  font-family: "Noto Serif SC", "Noto Serif", serif;
  font-weight: 600;
  letter-spacing: .02em;
  font-size: 1.4rem;
}

.subtitle {
  color: var(--muted);
  font-size: 0.9rem;
}

.lang {
  display: flex;
  align-items: center;
  gap: 8px;
}

.lang label {
  color: var(--muted);
  font-size: .9rem;
}

.lang select {
  appearance: none;
  border-radius: 10px;
  border: 1px solid #243244;
  background: #0e1520;
  color: var(--text);
  padding: 10px 34px 10px 12px;
  font-size: 0.9rem;
}

.card {
  background: var(--card);
  border: 1px solid #1f2a36;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 20px;
}

.section {
  margin-top: 18px;
}

.row {
  display: grid;
  gap: 12px;
}

@media (min-width: 760px) {
  .row.cols-3 {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .row.cols-2 {
    grid-template-columns: 1fr 1fr;
  }
}

input, select, textarea {
  width: 100%;
  box-sizing: border-box;
  border-radius: 12px;
  border: 1px solid #243244;
  background: #0e1520;
  color: var(--text);
  padding: 12px 12px;
  font-size: 15px;
  transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
}

button, .btn {
  width: auto;
  display: inline-grid;
  place-items: center;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid #e6c76e;
  background: linear-gradient(180deg, #fff9e6, #e6c76e);
  color: #191919;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}

.btn:disabled {
  opacity: .6;
  cursor: not-allowed;
  transform: none;
}

.h2 {
  font-size: 1.3rem;
  margin: 0 0 1rem;
  font-weight: 700;
  color: #ffe084;
  display: flex;
  align-items: center;
  gap: 10px;
}

.h2::before {
  content: "";
  display: block;
  width: 4px;
  height: 20px;
  background: var(--brand);
  border-radius: 2px;
}

.muted {
  color: #9aa3b2;
}

footer {
  color: #6c7b8c;
  font-size: .85rem;
  text-align: center;
  padding: 30px 0;
  margin-top: 30px;
}

/* ç»“æœæ ·å¼ */
.pillars {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 8px;
}

.pillar {
  background: #0f1624;
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 14px 10px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.pillar::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--brand);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.pillar:hover {
  transform: translateY(-3px);
  border-color: var(--brand);
}

.pillar:hover::before {
  opacity: 1;
}

.pillar .tit {
  color: #9aa3b2;
  font-size: .85rem;
  margin-bottom: 6px;
}

.pillar .gz {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: .05em;
  color: var(--gold2);
}

.bars {
  display: grid;
  gap: 8px;
  margin-top: 10px;
}

.bar {
  height: 10px;
  background: #0d1420;
  border: 1px solid #233146;
  border-radius: 999px;
  overflow: hidden;
  position: relative;
}

.bar i {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, #ffe084, #f2d27a);
  transition: width 1s ease;
}

.bar-label {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 0.85rem;
}

.ul {
  margin: .4rem 0 0 .9rem;
  line-height: 1.8;
}

/* å¿ƒæ€œç®¡å®¶æ ·å¼ */
.assistant-container {
  margin-top: 30px;
  border-top: 1px solid #1f2a36;
  padding-top: 20px;
}

.assistant-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.assistant-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #191919;
  font-weight: 700;
  font-size: 1.2rem;
}

.assistant-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--gold2);
}

.assistant-subtitle {
  color: var(--muted);
  font-size: 0.9rem;
}

.assistant-message {
  background: rgba(15, 22, 36, 0.7);
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 15px;
  position: relative;
  animation: fadeIn 0.5s ease;
}

.assistant-message::before {
  content: "";
  position: absolute;
  top: -6px;
  left: 20px;
  width: 12px;
  height: 12px;
  background: inherit;
  border-top: 1px solid #253245;
  border-left: 1px solid #253245;
  transform: rotate(45deg);
}

.assistant-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.action-btn {
  padding: 8px 16px;
  border-radius: 20px;
  background: rgba(212, 175, 55, 0.1);
  border: 1px solid rgba(212, 175, 55, 0.3);
  color: var(--gold2);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.action-btn:hover {
  background: rgba(212, 175, 55, 0.2);
  transform: translateY(-2px);
}

.vip-promo {
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(76, 201, 167, 0.1));
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  position: relative;
  overflow: hidden;
}

.vip-promo::before {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), transparent);
  border-radius: 0 0 0 80px;
}

.vip-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.vip-badge {
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  color: #191919;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
}

.vip-title {
  font-weight: 600;
  color: var(--gold2);
}

.vip-features {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.vip-feature {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
}

.vip-feature::before {
  content: "âœ“";
  color: var(--success);
  font-weight: 700;
}

.vip-cta {
  display: inline-block;
  padding: 10px 20px;
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  color: #191919;
  border-radius: 8px;
  font-weight: 700;
  text-decoration: none;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.vip-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(255, 90, 95, 0.1);
  border: 1px solid var(--danger);
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
  color: #ffb4b4;
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">å‘½ç†ä¾›é—¨ Â· å…«å­—ç®€è¯„</div>
        <div class="subtitle">å…è´¹ç‰ˆ Â· å…¨é¢ä¸æ·±ï½œVIP è§£é”æµå¹´/å¤§è¿/æ‹©æ—¥/å‘½å</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰">
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">é˜³å† / Gregorian</option>
            <option value="lunar">å†œå† / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> é—°æœˆ
          </label>
        </div>
        <div id="calendarHint" class="muted" style="display:none; margin-top:6px;">
          é€‰æ‹©å†œå†æ—¶ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºé—°æœˆï¼›è‹¥ä¸ºé—°æœˆè¯·å‹¾é€‰"é—°æœˆ"ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ¢ç®—ä¸ºé˜³å†åè®¡ç®—ã€‚
        </div>
      </div>
    </div>

    <div id="depsRow" class="muted" style="display:flex;align-items:center;gap:10px;margin-top:8px">
      <span>ä¾èµ–çŠ¶æ€ï¼š</span>
      <span id="depsStatus" style="color:#ffdf8a">æœªåŠ è½½</span>
      <button id="depsReload" class="btn" style="padding:6px 10px;border-radius:10px">é‡æ–°åŠ è½½</button>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" value="1990-01-01">
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <input type="time" id="birthtime" value="12:00">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" class="loading" style="display:none"></span>
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">æç¤ºï¼šä¸´æ—¶é»˜è®¤ä¸œå…«åŒºï¼ˆUTC+8ï¼‰ã€‚åç»­å°†æ”¯æŒæŒ‰å‡ºç”Ÿåœ°æ¢ç®—ã€‚</div>
    <div id="error" class="error-message" style="display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <!-- å…«å­—ç»“æœæ˜¾ç¤ºéƒ¨åˆ† -->
    <div class="card section">
      <div class="h2">å…«å­—å‘½ç†æ’ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2">äº”è¡Œåˆ†æ</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"></i></div>
        <div class="bar-label">
          <span>æœ¨</span>
          <span id="pct-wood">0%</span>
        </div>
        <div class="bar"><i id="bar-fire"></i></div>
        <div class="bar-label">
          <span>ç«</span>
          <span id="pct-fire">0%</span>
        </div>
        <div class="bar"><i id="bar-earth"></i></div>
        <div class="bar-label">
          <span>åœŸ</span>
          <span id="pct-earth">0%</span>
        </div>
        <div class="bar"><i id="bar-metal"></i></div>
        <div class="bar-label">
          <span>é‡‘</span>
          <span id="pct-metal">0%</span>
        </div>
        <div class="bar"><i id="bar-water"></i></div>
        <div class="bar-label">
          <span>æ°´</span>
          <span id="pct-water">0%</span>
        </div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <!-- å¿ƒæ€œç®¡å®¶ AI åŠ©æ‰‹ -->
    <div class="assistant-container">
      <div class="assistant-header">
        <div class="assistant-avatar">å¿ƒ</div>
        <div>
          <div class="assistant-title">å¿ƒæ€œç®¡å®¶ Â· AI å‘½ç†åŠ©æ‰‹</div>
          <div class="assistant-subtitle">åŸºäºæ‚¨çš„å…«å­—åˆ†æï¼Œä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–å»ºè®®</div>
        </div>
      </div>
      
      <div class="assistant-message" id="assistant-initial">
        <p>æ‚¨å¥½ï¼æˆ‘æ˜¯å¿ƒæ€œç®¡å®¶ï¼ŒåŸºäºæ‚¨çš„å…«å­—åˆ†æï¼Œæˆ‘æ³¨æ„åˆ°ï¼š</p>
        <div id="assistant-analysis"></div>
        <p>ä»¥ä¸‹æ˜¯æ ¹æ®æ‚¨çš„å‘½ç†ç‰¹ç‚¹æä¾›çš„å»ºè®®ï¼š</p>
        <div id="assistant-advice"></div>
        
        <div class="assistant-actions">
          <div class="action-btn" data-action="career">äº‹ä¸šå»ºè®®</div>
          <div class="action-btn" data-action="wealth">è´¢è¿åˆ†æ</div>
          <div class="action-btn" data-action="relationship">æ„Ÿæƒ…æŒ‡å¯¼</div>
          <div class="action-btn" data-action="health">å¥åº·æé†’</div>
          <div class="action-btn" data-action="lucky">å¹¸è¿æ–¹å‘</div>
        </div>
      </div>

      <!-- VIP æœåŠ¡æ¨è -->
      <div class="vip-promo">
        <div class="vip-header">
          <div class="vip-badge">VIP</div>
          <div class="vip-title">è§£é”æ·±åº¦å‘½ç†åˆ†æ</div>
        </div>
        <p>å…è´¹ç‰ˆä»…æä¾›åŸºç¡€åˆ†æï¼ŒVIPæœåŠ¡åŒ…å«ï¼š</p>
        <div class="vip-features">
          <div class="vip-feature">è¯¦ç»†æµå¹´è¿åŠ¿åˆ†æ</div>
          <div class="vip-feature">åå¹´å¤§è¿ç²¾å‡†é¢„æµ‹</div>
          <div class="vip-feature">ä¸ªæ€§åŒ–æ‹©æ—¥æœåŠ¡</div>
          <div class="vip-feature">ä¸“ä¸šå‘½åå»ºè®®</div>
          <div class="vip-feature">å…¨å¹´è¿åŠ¿æœˆå†</div>
          <div class="vip-feature">ä¸€å¯¹ä¸€å‘½ç†å’¨è¯¢</div>
        </div>
        <p>ç«‹å³å‡çº§VIPï¼Œè·å–ä¸“å±å‘½ç†æŒ‡å¯¼ï¼</p>
        <a href="#" class="vip-cta">äº†è§£VIPæœåŠ¡è¯¦æƒ…</a>
      </div>
    </div>
  </section>
</main>

<footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

<script>
// ç®€åŒ–çš„å…«å­—è®¡ç®—å‡½æ•° - ä¸ä¾èµ–å¤–éƒ¨åº“
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    this.EARTHLY_BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    this.STEM_ELEMENTS = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
    this.BRANCH_ELEMENTS = { 'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´' };
  }

  // è®¡ç®—å¹´æŸ±
  calculateYearPillar(year) {
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex],
      element: this.STEM_ELEMENTS[this.HEAVENLY_STEMS[stemIndex]]
    };
  }

  // è®¡ç®—æœˆæŸ±ï¼ˆç®€åŒ–ç‰ˆï¼‰
  calculateMonthPillar(year, month) {
    // æœˆæ”¯å›ºå®šå¯¹åº”æœˆä»½
    const branchMap = { 1: 'å¯…', 2: 'å¯', 3: 'è¾°', 4: 'å·³', 5: 'åˆ', 6: 'æœª', 7: 'ç”³', 8: 'é…‰', 9: 'æˆŒ', 10: 'äº¥', 11: 'å­', 12: 'ä¸‘' };
    const branch = branchMap[month];
    
    // ç®€åŒ–æœˆå¹²è®¡ç®—
    const yearStem = this.calculateYearPillar(year).stem;
    const stemStartMap = { 'ç”²': 2, 'ä¹™': 2, 'ä¸™': 0, 'ä¸': 0, 'æˆŠ': 2, 'å·±': 2, 'åºš': 0, 'è¾›': 0, 'å£¬': 2, 'ç™¸': 2 };
    const startIndex = stemStartMap[yearStem];
    const stemIndex = (startIndex + month - 1) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: branch,
      element: this.STEM_ELEMENTS[this.HEAVENLY_STEMS[stemIndex]]
    };
  }

  // è®¡ç®—æ—¥æŸ±ï¼ˆç®€åŒ–ç‰ˆ - ä½¿ç”¨å›ºå®šç®—æ³•ï¼‰
  calculateDayPillar(year, month, day) {
    // ç®€åŒ–ç®—æ³•ï¼šåŸºäºåŸºå§†æ‹‰å°”æ£®è®¡ç®—å…¬å¼è®¡ç®—æ˜ŸæœŸï¼Œç„¶åæ¨ç®—
    if (month < 3) {
      month += 12;
      year--;
    }
    const K = year % 100;
    const J = Math.floor(year / 100);
    const h = (day + Math.floor(13 * (month + 1) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) + 5 * J) % 60;
    
    const stemIndex = h % 10;
    const branchIndex = h % 12;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex],
      element: this.STEM_ELEMENTS[this.HEAVENLY_STEMS[stemIndex]]
    };
  }

  // è®¡ç®—æ—¶æŸ±
  calculateHourPillar(dayStem, hour) {
    // æ—¶æ”¯å›ºå®šå¯¹åº”æ—¶è¾°
    const branchMap = { 
      23: 'å­', 0: 'å­', 1: 'ä¸‘', 2: 'ä¸‘', 3: 'å¯…', 4: 'å¯…', 5: 'å¯', 6: 'å¯',
      7: 'è¾°', 8: 'è¾°', 9: 'å·³', 10: 'å·³', 11: 'åˆ', 12: 'åˆ', 13: 'æœª', 14: 'æœª',
      15: 'ç”³', 16: 'ç”³', 17: 'é…‰', 18: 'é…‰', 19: 'æˆŒ', 20: 'æˆŒ', 21: 'äº¥', 22: 'äº¥'
    };
    
    const branch = branchMap[hour];
    
    // æ—¶å¹²è®¡ç®—
    const dayStemIndex = this.HEAVENLY_STEMS.indexOf(dayStem);
    const stemStartMap = { 0: 0, 1: 2, 2: 4, 3: 6, 4: 8, 5: 0, 6: 2, 7: 4, 8: 6, 9: 8 };
    const startIndex = stemStartMap[dayStemIndex];
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIndex = (startIndex + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: branch,
      element: this.STEM_ELEMENTS[this.HEAVENLY_STEMS[stemIndex]]
    };
  }

  // è®¡ç®—å…«å­—
  calculateBazi(year, month, day, hour) {
    const yearPillar = this.calculateYearPillar(year);
    const monthPillar = this.calculateMonthPillar(year, month);
    const dayPillar = this.calculateDayPillar(year, month, day);
    const hourPillar = this.calculateHourPillar(dayPillar.stem, hour);
    
    return {
      year: yearPillar,
      month: monthPillar,
      day: dayPillar,
      hour: hourPillar
    };
  }
}

// å¿ƒæ€œç®¡å®¶ AI åŠŸèƒ½
class XinLianAssistant {
  constructor() {
    this.currentContext = null;
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('action-btn')) {
        const action = e.target.getAttribute('data-action');
        this.handleAction(action);
      }
    });
  }

  generateAnalysis(baziData) {
    this.currentContext = baziData;
    
    const analysis = this.analyzeBazi(baziData);
    const advice = this.generateAdvice(baziData);
    
    document.getElementById('assistant-analysis').innerHTML = analysis;
    document.getElementById('assistant-advice').innerHTML = advice;
  }

  analyzeBazi(baziData) {
    const { dayMaster, elements, strength, season } = baziData;
    
    let analysis = `
      <ul class="ul">
        <li>æ‚¨çš„æ—¥ä¸»ä¸º <strong>${dayMaster.stem}ï¼ˆ${dayMaster.element}ï¼‰</strong></li>
        <li>å‘½å±€æ•´ä½“<strong>${strength.mark}</strong>ï¼Œ${this.getStrengthDescription(strength.mark)}</li>
        <li>å‡ºç”Ÿäº<strong>${season}</strong>å­£èŠ‚ï¼Œ${this.getSeasonInfluence(season, dayMaster.element)}</li>
        <li>äº”è¡Œåˆ†å¸ƒï¼š${this.getElementDistribution(elements)}</li>
      </ul>
    `;
    
    return analysis;
  }

  generateAdvice(baziData) {
    const { strength, useful } = baziData;
    
    let advice = `
      <ul class="ul">
        <li><strong>å‘å±•ç­–ç•¥ï¼š</strong>${strength.focus}</li>
        <li><strong>å–œç”¨å…ƒç´ ï¼š</strong>${useful.useful.join('ã€')}</li>
        <li><strong>å¹¸è¿é¢œè‰²ï¼š</strong>${this.getLuckyColors(useful.useful)}</li>
        <li><strong>é€‚åˆæ–¹ä½ï¼š</strong>${this.getLuckyDirections(useful.useful)}</li>
      </ul>
    `;
    
    return advice;
  }

  handleAction(action) {
    if (!this.currentContext) return;
    
    let response = '';
    
    switch(action) {
      case 'career':
        response = this.getCareerAdvice();
        break;
      case 'wealth':
        response = this.getWealthAdvice();
        break;
      case 'relationship':
        response = this.getRelationshipAdvice();
        break;
      case 'health':
        response = this.getHealthAdvice();
        break;
      case 'lucky':
        response = this.getLuckyDirectionsAdvice();
        break;
    }
    
    this.showActionResponse(action, response);
  }

  getCareerAdvice() {
    const { dayMaster, strength } = this.currentContext;
    const careers = {
      'æœ¨': ['æ•™è‚²è¡Œä¸š', 'åˆ›æ„è®¾è®¡', 'å‡ºç‰ˆä¼ åª’', 'ç¯ä¿äº§ä¸š'],
      'ç«': ['äº’è”ç½‘ç§‘æŠ€', 'å¸‚åœºè¥é”€', 'å¨±ä¹äº§ä¸š', 'é¤é¥®è¡Œä¸š'],
      'åœŸ': ['æˆ¿åœ°äº§', 'å»ºç­‘å·¥ç¨‹', 'é‡‘èæŠ•èµ„', 'ç®¡ç†å’¨è¯¢'],
      'é‡‘': ['æ³•å¾‹è¡Œä¸š', 'ç²¾å¯†åˆ¶é€ ', 'é‡‘èåˆ†æ', 'æŠ€æœ¯ç ”å‘'],
      'æ°´': ['ç‰©æµè¿è¾“', 'æ—…æ¸¸è¡Œä¸š', 'å¿ƒç†å’¨è¯¢', 'å›½é™…è´¸æ˜“']
    };
    
    const suitableCareers = careers[dayMaster.element] || ['å¤šå…ƒåŒ–å‘å±•'];
    const strengthText = strength.mark === 'åå¼º' ? 'é€‚åˆæŒ‘æˆ˜æ€§å·¥ä½œ' : 'é€‚åˆç¨³å®šæ€§å·¥ä½œ';
    
    return `åŸºäºæ‚¨çš„${dayMaster.element}å±æ€§æ—¥ä¸»ï¼Œ${strengthText}ã€‚æ¨èèŒä¸šæ–¹å‘ï¼š${suitableCareers.join('ã€')}ã€‚`;
  }

  getWealthAdvice() {
    const { elements, useful } = this.currentContext;
    const strongElement = this.getStrongestElement(elements);
    const weakElement = this.getWeakestElement(elements);
    
    return `æ‚¨çš„è´¢è¿${strongElement === 'é‡‘' || strongElement === 'åœŸ' ? 'è¾ƒä½³' : 'éœ€åŠªåŠ›'}ã€‚å»ºè®®åŠ å¼º${useful.useful.join('ã€')}å…ƒç´ çš„è¿ç”¨ï¼Œé¿å…${weakElement}ç›¸å…³çš„é«˜é£é™©æŠ•èµ„ã€‚`;
  }

  getRelationshipAdvice() {
    const { dayMaster, elements } = this.currentContext;
    const compatibleElements = this.getCompatibleElements(dayMaster.element);
    
    return `æ„Ÿæƒ…æ–¹é¢ï¼Œæ‚¨ä¸${compatibleElements.join('ã€')}å±æ€§çš„äººè¾ƒä¸ºæŠ•ç¼˜ã€‚å»ºè®®å¤šå‚ä¸ç¤¾äº¤æ´»åŠ¨ï¼Œæ‰©å¤§äº¤é™…åœˆã€‚`;
  }

  getHealthAdvice() {
    const { elements } = this.currentContext;
    const weakElement = this.getWeakestElement(elements);
    const healthMap = {
      'æœ¨': 'è‚èƒ†ã€çœ¼ç›',
      'ç«': 'å¿ƒè„ã€è¡€æ¶²å¾ªç¯',
      'åœŸ': 'è„¾èƒƒã€æ¶ˆåŒ–ç³»ç»Ÿ',
      'é‡‘': 'è‚ºã€å‘¼å¸ç³»ç»Ÿ',
      'æ°´': 'è‚¾ã€æ³Œå°¿ç³»ç»Ÿ'
    };
    
    return `å¥åº·æ–¹é¢éœ€ç‰¹åˆ«æ³¨æ„${healthMap[weakElement]}çš„ä¿å…»ã€‚å»ºè®®å®šæœŸä½“æ£€ï¼Œä¿æŒè§„å¾‹ä½œæ¯ã€‚`;
  }

  getLuckyDirectionsAdvice() {
    const { useful } = this.currentContext;
    const directionMap = {
      'æœ¨': 'ä¸œæ–¹',
      'ç«': 'å—æ–¹',
      'åœŸ': 'ä¸­å¤®ã€ä¸œåŒ—ã€è¥¿å—',
      'é‡‘': 'è¥¿æ–¹',
      'æ°´': 'åŒ—æ–¹'
    };
    
    const directions = useful.useful.map(el => directionMap[el]).filter(Boolean);
    return `æ‚¨çš„å¹¸è¿æ–¹ä½æ˜¯ï¼š${directions.join('ã€')}ã€‚åœ¨è¿™äº›æ–¹å‘å·¥ä½œã€ç”Ÿæ´»æˆ–æ—…è¡Œä¼šå¸¦æ¥å¥½è¿ã€‚`;
  }

  showActionResponse(action, response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'assistant-message';
    messageDiv.innerHTML = `
      <p><strong>${this.getActionTitle(action)}ï¼š</strong>${response}</p>
      <p class="muted" style="margin-top: 10px; font-size: 0.9em;">
        ğŸ’¡ æƒ³è¦æ›´ç²¾å‡†çš„æŒ‡å¯¼ï¼Ÿ<a href="#" style="color: var(--gold2);">å‡çº§VIPè·å–ä¸“å±åˆ†æ</a>
      </p>
    `;
    
    document.querySelector('.assistant-container').insertBefore(messageDiv, document.querySelector('.vip-promo'));
    messageDiv.scrollIntoView({ behavior: 'smooth' });
  }

  // è¾…åŠ©æ–¹æ³•
  getStrengthDescription(strength) {
    const descriptions = {
      'åå¼º': 'å…·æœ‰è¾ƒå¥½çš„å‘å±•æ½œåŠ›å’ŒæŠ—å‹èƒ½åŠ›',
      'åå¼±': 'éœ€è¦æ›´å¤šçš„æ”¯æŒå’Œå¸®åŠ©æ‰èƒ½å‘æŒ¥æ½œåŠ›',
      'å¹³è¡¡': 'å„æ–¹é¢å‘å±•è¾ƒä¸ºå‡è¡¡ï¼Œé€‚åº”æ€§å¼º'
    };
    return descriptions[strength] || 'å…·æœ‰ç‹¬ç‰¹çš„å‘å±•ç‰¹ç‚¹';
  }

  getSeasonInfluence(season, element) {
    const influences = {
      'æ˜¥': 'æœ¨æ°”æ—ºç››ï¼Œç”Ÿæœºå‹ƒå‹ƒ',
      'å¤': 'ç«æ°”æ—ºç››ï¼Œçƒ­æƒ…æ´‹æº¢',
      'ç§‹': 'é‡‘æ°”æ—ºç››ï¼Œæ”¶è·æ—¶èŠ‚',
      'å†¬': 'æ°´æ°”æ—ºç››ï¼Œå†…æ•›æ²‰é™'
    };
    return influences[season] || 'å­£èŠ‚ç‰¹ç‚¹å¯¹å‘½å±€æœ‰ä¸€å®šå½±å“';
  }

  getElementDistribution(elements) {
    const sorted = Object.entries(elements)
      .sort((a, b) => b[1] - a[1])
      .map(([el, val]) => `${el}${Math.round(val)}%`)
      .join('ã€');
    return sorted;
  }

  getLuckyColors(elements) {
    const colorMap = {
      'æœ¨': 'ç»¿è‰²ã€é’è‰²',
      'ç«': 'çº¢è‰²ã€ç´«è‰²',
      'åœŸ': 'é»„è‰²ã€æ£•è‰²',
      'é‡‘': 'ç™½è‰²ã€é‡‘è‰²',
      'æ°´': 'é»‘è‰²ã€è“è‰²'
    };
    return elements.map(el => colorMap[el]).join('ã€');
  }

  getLuckyDirections(elements) {
    const directionMap = {
      'æœ¨': 'ä¸œæ–¹',
      'ç«': 'å—æ–¹',
      'åœŸ': 'ä¸­å¤®',
      'é‡‘': 'è¥¿æ–¹',
      'æ°´': 'åŒ—æ–¹'
    };
    return elements.map(el => directionMap[el]).join('ã€');
  }

  getStrongestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] > b[1] ? a : b)[0];
  }

  getWeakestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  }

  getCompatibleElements(element) {
    const compatibility = {
      'æœ¨': ['ç«', 'æ°´'],
      'ç«': ['æœ¨', 'åœŸ'],
      'åœŸ': ['ç«', 'é‡‘'],
      'é‡‘': ['åœŸ', 'æ°´'],
      'æ°´': ['é‡‘', 'æœ¨']
    };
    return compatibility[element] || ['å¤šæ ·åŒ–'];
  }

  getActionTitle(action) {
    const titles = {
      'career': 'äº‹ä¸šå»ºè®®',
      'wealth': 'è´¢è¿åˆ†æ',
      'relationship': 'æ„Ÿæƒ…æŒ‡å¯¼',
      'health': 'å¥åº·æé†’',
      'lucky': 'å¹¸è¿æ–¹å‘'
    };
    return titles[action] || 'ä¸“ä¸šå»ºè®®';
  }
}

// åˆå§‹åŒ–
const baziCalculator = new BaziCalculator();
const assistant = new XinLianAssistant();

// å·¥å…·å‡½æ•°
function $(id) { return document.getElementById(id); }
function setBar(el, pct) { if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function el(tag, attrs = {}, html = "") { 
  const d = document.createElement(tag); 
  Object.entries(attrs).forEach(([k, v]) => d.setAttribute(k, v)); 
  d.innerHTML = html; 
  return d; 
}

// äº”è¡Œåˆ†æ
function countElements(pillars) {
  const cnt = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
  const STEM_ELEM = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const BRANCH_ELEM = {å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
  
  Object.values(pillars).forEach(pillar => {
    if(pillar.stem && STEM_ELEM[pillar.stem]) cnt[STEM_ELEM[pillar.stem]] += 1;
    if(pillar.branch && BRANCH_ELEM[pillar.branch]) cnt[BRANCH_ELEM[pillar.branch]] += 1;
  });
  
  const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
  return {
    cnt, 
    pct: {
      wood: cnt['æœ¨'] / total * 100,
      fire: cnt['ç«'] / total * 100,
      earth: cnt['åœŸ'] / total * 100,
      metal: cnt['é‡‘'] / total * 100,
      water: cnt['æ°´'] / total * 100
    }
  };
}

// åˆ¤æ–­å‘½å±€å¼ºå¼±
function judgeStrength(dayGan, monthZhi, cnt) {
  const STEM_ELEM = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH = {å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  
  const dmEl = STEM_ELEM[dayGan];
  const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  
  let score = 0;
  if((season === 'æ˜¥' && 'æœ¨ç«'.includes(dmEl)) || (season === 'å¤' && 'ç«åœŸ'.includes(dmEl)) || 
     (season === 'ç§‹' && dmEl === 'é‡‘') || (season === 'å†¬' && dmEl === 'æ°´')) score += 2;
  
  score += (cnt[dmEl] || 0) * 1.2;
  
  const mark = score >= 3 ? 'åå¼º' : (score <= 1 ? 'åå¼±' : 'å¹³è¡¡');
  const focus = mark === 'åå¼º' ? 'æ³„ç§€/åˆ¶åŒ–' : (mark === 'åå¼±' ? 'è¡¥åŠ©/é¡ºåŠ¿' : 'å®ˆä¸­/è°ƒå’Œ');
  
  return {season, mark, focus};
}

// é€‰æ‹©å–œç”¨ç¥
function chooseUseful(strength, dmElem) {
  if (strength === 'åå¼º') {
    const useful = ({æœ¨:['ç«','åœŸ','é‡‘'], ç«:['åœŸ','é‡‘','æ°´'], åœŸ:['é‡‘','æ°´','æœ¨'], é‡‘:['æ°´','æœ¨','ç«'], æ°´:['æœ¨','ç«','åœŸ']})[dmElem];
    return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful, avoid:[dmElem]};
  } else if (strength === 'åå¼±') {
    const helper = ({æœ¨:['æœ¨','æ°´'], ç«:['ç«','æœ¨'], åœŸ:['åœŸ','ç«'], é‡‘:['é‡‘','åœŸ'], æ°´:['æ°´','é‡‘']})[dmElem];
    return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:helper, avoid:[]};
  }
  return {strategy:'å®ˆä¸­/è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}

// æ¸²æŸ“å››æŸ±
function renderPillars(root, p) {
  root.innerHTML = '';
  [['å¹´æŸ±', p.year], ['æœˆæŸ±', p.month], ['æ—¥æŸ±', p.day], ['æ—¶æŸ±', p.hour]].forEach(([tit, v]) => {
    const div = el('div', {class: 'pillar'}, `
      <div class="tit">${tit}</div>
      <div class="gz">${v.stem}${v.branch}</div>
    `);
    root.appendChild(div);
  });
}

// ç”Ÿæˆå…«å­—
async function genChart() {
  const err = $('error');
  err.style.display = 'none';
  err.textContent = '';
  
  const birth = ($('birthdate').value || '').trim();
  const time = ($('birthtime').value || '').trim();
  
  if(!birth || !time) {
    err.textContent = 'è¯·å®Œå–„å‡ºç”Ÿæ—¥æœŸä¸æ—¶é—´ã€‚';
    err.style.display = 'block';
    return;
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  $('genBtnText').style.display = 'none';
  $('genBtnLoading').style.display = 'inline-block';
  $('genBtn').disabled = true;

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    const [hh, mm] = time.split(':').map(Number);
    
    // ä½¿ç”¨å†…ç½®è®¡ç®—å™¨
    const pillars = baziCalculator.calculateBazi(Y, M, D, hh);
    
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';
    $('bazi-date').textContent = `ç”¨äºè®¡ç®—ï¼ˆUTC+8ï¼Œé˜³å†ï¼‰ï¼š${birth} ${time}`;
    
    // æ¸²æŸ“å››æŸ±
    renderPillars($('bazi-pillars'), pillars);
    $('bazi-day-master').textContent = `æ—¥ä¸»ï¼š${pillars.day.stem}ï¼ˆ${pillars.day.element}ï¼‰`;
    
    // äº”è¡Œåˆ†æ
    const {cnt, pct} = countElements(pillars);
    setBar($('bar-wood'), pct.wood);
    setBar($('bar-fire'), pct.fire);
    setBar($('bar-earth'), pct.earth);
    setBar($('bar-metal'), pct.metal);
    setBar($('bar-water'), pct.water);
    
    // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
    $('pct-wood').textContent = Math.round(pct.wood) + '%';
    $('pct-fire').textContent = Math.round(pct.fire) + '%';
    $('pct-earth').textContent = Math.round(pct.earth) + '%';
    $('pct-metal').textContent = Math.round(pct.metal) + '%';
    $('pct-water').textContent = Math.round(pct.water) + '%';
    
    $('bazi-elements-balance').textContent = `äº”è¡Œå æ¯”ï¼šæœ¨${Math.round(pct.wood)}% ç«${Math.round(pct.fire)}% åœŸ${Math.round(pct.earth)}% é‡‘${Math.round(pct.metal)}% æ°´${Math.round(pct.water)}%`;
    
    // å‘½å±€åˆ†æ
    const st = judgeStrength(pillars.day.stem, pillars.month.branch, cnt);
    const adv = chooseUseful(st.mark, pillars.day.element);
    
    $('bazi-strengths').textContent = `å‘½å±€${st.mark}ï¼Œå»ºè®®ç­–ç•¥ï¼š${st.focus}`;
    
    // è°ƒç”¨AIåŠ©æ‰‹
    const baziData = {
      dayMaster: pillars.day,
      elements: {
        wood: pct.wood,
        fire: pct.fire,
        earth: pct.earth,
        metal: pct.metal,
        water: pct.water
      },
      strength: st,
      season: st.season,
      useful: adv
    };
    
    assistant.generateAnalysis(baziData);
    
  } catch(e) {
    err.textContent = 'è®¡ç®—å¤±è´¥ï¼š' + (e?.message || 'è¯·æ£€æŸ¥è¾“å…¥æ•°æ®');
    err.style.display = 'block';
    console.error('å…«å­—è®¡ç®—é”™è¯¯:', e);
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    $('genBtnText').style.display = 'inline-block';
    $('genBtnLoading').style.display = 'none';
    $('genBtn').disabled = false;
  }
}

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  $('birthdate').value = formattedDate;
  
  // ç»‘å®šäº‹ä»¶
  $('genBtn').addEventListener('click', genChart);
  
  // å†æ³•æç¤ºæ˜¾éš
  const cal = $('calendar'), leap = $('leapWrap'), hint = document.querySelector('#calendarHint');
  const toggle = () => {
    const isLunar = cal?.value === 'lunar';
    if (leap) leap.style.display = isLunar ? 'inline-flex' : 'none';
    if (hint) hint.style.display = isLunar ? 'block' : 'none';
  };
  cal?.addEventListener('change', toggle);
  
  // ä¾èµ–çŠ¶æ€è®¾ç½®ä¸ºå°±ç»ªï¼ˆä½¿ç”¨å†…ç½®è®¡ç®—å™¨ï¼‰
  $('depsStatus').textContent = 'å†…ç½®è®¡ç®—å™¨å·²å°±ç»ª';
  $('depsStatus').style.color = '#9aa3b2';
  
  console.log('å…«å­—å‘½ç†ç³»ç»Ÿå·²åˆå§‹åŒ–');
});
</script>
</body>
</html>
