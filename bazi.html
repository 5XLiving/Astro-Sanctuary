<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <style>
    /* ç®€åŒ–CSSä»¥ä¾¿è°ƒè¯• */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a;
      --radius:14px;
    }
    body{
      color:var(--text); background: #0b0f14;
      font-family: system-ui, -apple-system, sans-serif;
      margin:0; padding:20px;
    }
    .container{max-width:1100px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084}
    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);}
    .btn{padding:12px 16px;border-radius:12px;background:var(--gold);color:#191919;font-weight:800;cursor:pointer;border:none;}
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
    .butler-professional{display:none;margin-top:20px;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:20px;}
    .butler-header{color:var(--gold2);font-size:1.2rem;font-weight:bold;margin-bottom:20px;}
    .butler-content{line-height:1.8;padding:15px;background:#0f1624;border-radius:10px;border:1px solid #253245;}
    .butler-section{margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid #253245;}
    .butler-section h4{color:var(--gold2);margin-bottom:10px;}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none;margin-top:10px;}
  </style>
</head>
<body>
<div class="container">
  <!-- å…«å­—æ’ç›˜è¡¨å• -->
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label>å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼" />
      </div>
      <div>
        <label>æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label>å†æ³•</label>
        <select id="calendar">
          <option value="gregorian">é˜³å†</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label>å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label>å‡ºç”Ÿæ—¶é—´</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="time" id="birthtime" style="width:auto" />
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="timeUnknown" />
            <span>å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-end">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div id="bazi-date" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- å¿ƒæ€œç®¡å®¶ä¸“ä¸šçª—å£ -->
  <section id="butlerProfessional" class="butler-professional">
    <div class="butler-header">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</div>
    <div class="butler-content" id="professionalReport"></div>
  </section>
</div>

<script>
// å…«å­—è®¡ç®—å™¨ç±»
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
  }
  
  calculateYearPillar(year){ 
    const s=(year-4)%10, b=(year-4)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(s+10)%10],
      branch: this.EARTHLY_BRANCHES[(b+12)%12]
    }; 
  }
  
  solarMonthIndex(y,m,d){ 
    const mmdd=m*100+d; 
    const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; 
    let idx=11; 
    for(const [thr,val] of gates) if(mmdd>=thr) idx=val; 
    const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'}; 
    return {index:idx, branch:branchBy[idx]}; 
  }
  
  calculateMonthPillar(year,month,day){ 
    const {index,branch}=this.solarMonthIndex(year,month,day); 
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); 
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; 
    const stemIdx=(startMap[yStemIdx]+(index-1))%10; 
    return {stem:this.HEAVENLY_STEMS[stemIdx], branch}; 
  }
  
  calculateDayPillar(year,month,day){ 
    const baseUTC=Date.UTC(1900,0,31); 
    const targetUTC=Date.UTC(year,month-1,day); 
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); 
    const stemIdx=(0+dayDiff)%10; 
    const branchIdx=(4+dayDiff)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10],
      branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12]
    }; 
  }
  
  calculateHourPillar(dayStem,hour){ 
    const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'}; 
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; 
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); 
    const hourIndex=Math.floor((hour+1)/2)%12; 
    const stemIdx=(startMap[dayIdx]+hourIndex)%10; 
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    }; 
  }
  
  getStemElement(stem){ 
    return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; 
  }
  
  getBranchElement(branch){ 
    return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; 
  }
  
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), 
          monthP=this.calculateMonthPillar(year,month,day), 
          dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ 
      if(p.stem&&p.stem!=='ï¼Ÿ') cnt[this.getStemElement(p.stem)]+=1; 
      if(p.branch&&p.branch!=='ï¼Ÿ') cnt[this.getBranchElement(p.branch)]+=1; 
    });
    
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={
      wood: cnt['æœ¨']/total*100,
      fire: cnt['ç«']/total*100,
      earth: cnt['åœŸ']/total*100, 
      metal: cnt['é‡‘']/total*100,
      water: cnt['æ°´']/total*100
    };
    
    return {pillars, counts:cnt, percents:pct, timeUnknown};
  }
}

const baziCalculator = new BaziCalculator();
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: 'å¹´æŸ±', pillar: pillars.year },
    { title: 'æœˆæŸ±', pillar: pillars.month },
    { title: 'æ—¥æŸ±', pillar: pillars.day },
    { title: 'æ—¶æŸ±', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === 'æ—¶æŸ±' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? 'ï¼Ÿ' : pillar.stem}${isUnknown ? 'ï¼Ÿ' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// ä¸“ä¸šæŠ¥å‘Šç”Ÿæˆå‡½æ•° - æ ¹æ®å®é™…å…«å­—åŠ¨æ€åˆ†æ
async function generateProfessionalReport(baziData) {
    const pillars = baziData.pillars;
    const counts = baziData.counts;
    const gender = baziData.gender || 'æœªé€éœ²';
    
    const baziString = `${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${pillars.hour.stem}${pillars.hour.branch}`;
    
    // åŸºäºå®é™…å…«å­—æ•°æ®åŠ¨æ€åˆ†æ
    const dayStem = pillars.day.stem;
    const dayElement = pillars.day.element;
    
    // åŠ¨æ€åˆ†ææ ¼å±€
    const patterns = analyzePatterns(pillars, counts);
    const tenGodsAnalysis = analyzeTenGods(pillars);
    const usefulGods = analyzeUsefulGods(pillars, counts);
    const careerAnalysis = analyzeCareer(pillars, counts, gender);
    const wealthAnalysis = analyzeWealth(pillars, counts);
    const loveAnalysis = analyzeLove(pillars, counts, gender);
    const spiritualAnalysis = analyzeSpiritual(pillars);
    const yearlyAnalysis = analyzeNext3Years(pillars);
    
    return `
        <div class="butler-section">
            <h4>ğŸ”® ä¸€ã€æ ¼å±€å±‚æ¬¡</h4>
            <p><strong>å…«å­—ï¼š</strong>${baziString}</p>
            <p><strong>æ—¥ä¸»ï¼š</strong>${dayStem}${dayElement}</p>
            <p><strong>äº”è¡Œåˆ†å¸ƒï¼š</strong>æœ¨${Math.round(counts.æœ¨)}% ç«${Math.round(counts.ç«)}% åœŸ${Math.round(counts.åœŸ)}% é‡‘${Math.round(counts.é‡‘)}% æ°´${Math.round(counts.æ°´)}%</p>
            <p><strong>ä¸»è¦æ ¼å±€ï¼š</strong></p>
            <ul>
                ${patterns.map(pattern => `<li><strong>${pattern.name}</strong> - ${pattern.description}</li>`).join('')}
            </ul>
            <p><strong>æ ¼å±€ç­‰çº§ï¼š</strong>${patterns[0]?.level || 'éœ€è¯¦ç»†åˆ†æ'}</p>
        </div>

        <div class="butler-section">
            <h4>âš”ï¸ äºŒã€åç¥é…ç½®åˆ†æ</h4>
            ${tenGodsAnalysis}
        </div>

        <div class="butler-section">
            <h4>ğŸ’ ä¸‰ã€ç”¨ç¥å–œå¿Œ</h4>
            ${usefulGods}
        </div>

        <div class="butler-section">
            <h4>ğŸ¯ å››ã€äº‹ä¸šå‘å±•</h4>
            ${careerAnalysis}
        </div>

        <div class="butler-section">
            <h4>ğŸ’° äº”ã€è´¢è¿åˆ†æ</h4>
            ${wealthAnalysis}
        </div>

        <div class="butler-section">
            <h4>â¤ï¸ å…­ã€çˆ±æƒ…åˆ†æ</h4>
            ${loveAnalysis}
        </div>

        <div class="butler-section">
            <h4>ğŸ”® ä¸ƒã€ç„å­¦ç¼˜åˆ†</h4>
            ${spiritualAnalysis}
        </div>

        <div class="butler-section">
            <h4>ğŸ“… å…«ã€æµå¹´è¯¦æ‰¹ï¼ˆæœªæ¥3å¹´ï¼‰</h4>
            ${yearlyAnalysis}
        </div>
    `;
}

// åŠ¨æ€æ ¼å±€åˆ†æå‡½æ•°
function analyzePatterns(pillars, counts) {
    const patterns = [];
    const dayStem = pillars.day.stem;
    const monthBranch = pillars.month.branch;
    
    // å»ºç¦„æ ¼åˆ¤æ–­
    const jianLuBranches = {
        'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 'æˆŠ': 'å·³',
        'å·±': 'åˆ', 'åºš': 'ç”³', 'è¾›': 'é…‰', 'å£¬': 'äº¥', 'ç™¸': 'å­'
    };
    
    if (monthBranch === jianLuBranches[dayStem]) {
        patterns.push({
            name: 'å»ºç¦„æ ¼',
            level: 'å¼ºæ ¼',
            description: 'æ—¥ä¸»å¾—æœˆä»¤ï¼Œæ ¹åŸºæ·±åšï¼Œè‡ªå¼ºä¸æ¯'
        });
    }
    
    // æœ¨ç«é€šæ˜æ ¼åˆ¤æ–­
    if ((counts.æœ¨ >= 25 && counts.ç« >= 25) && (dayStem === 'ç”²' || dayStem === 'ä¹™' || dayStem === 'ä¸™' || dayStem === 'ä¸')) {
        patterns.push({
            name: 'æœ¨ç«é€šæ˜æ ¼',
            level: 'è´µæ ¼',
            description: 'æœ¨ç«ç›¸ç”Ÿï¼Œæ–‡æ˜ä¹‹è±¡ï¼Œæ–‡é‡‡å‡ºä¼—'
        });
    }
    
    // ä»å¼ºæ ¼åˆ¤æ–­
    const dayElement = baziCalculator.getStemElement(dayStem);
    if (counts[dayElement] >= 40) {
        patterns.push({
            name: 'ä»å¼ºæ ¼',
            level: 'ç‰¹æ®Šæ ¼å±€',
            description: 'æ—¥ä¸»ææ—ºï¼Œé¡ºåŠ¿è€Œä¸º'
        });
    }
    
    return patterns.length > 0 ? patterns : [{
        name: 'æ™®é€šæ ¼å±€',
        level: 'éœ€è¯¦ç»†åˆ†æ',
        description: 'æ ¼å±€ç»„åˆè¾ƒä¸ºå¹³è¡¡'
    }];
}

// åç¥åˆ†æå‡½æ•°
function analyzeTenGods(pillars) {
    const tenGodsMap = {
        'ç”²': { 'ç”²':'æ¯”è‚©', 'ä¹™':'åŠ«è´¢', 'ä¸™':'é£Ÿç¥', 'ä¸':'ä¼¤å®˜', 'æˆŠ':'åè´¢', 'å·±':'æ­£è´¢', 'åºš':'ä¸ƒæ€', 'è¾›':'æ­£å®˜', 'å£¬':'åå°', 'ç™¸':'æ­£å°' },
        'ä¹™': { 'ç”²':'åŠ«è´¢', 'ä¹™':'æ¯”è‚©', 'ä¸™':'ä¼¤å®˜', 'ä¸':'é£Ÿç¥', 'æˆŠ':'æ­£è´¢', 'å·±':'åè´¢', 'åºš':'æ­£å®˜', 'è¾›':'ä¸ƒæ€', 'å£¬':'æ­£å°', 'ç™¸':'åå°' },
        'ä¸™': { 'ç”²':'åå°', 'ä¹™':'æ­£å°', 'ä¸™':'æ¯”è‚©', 'ä¸':'åŠ«è´¢', 'æˆŠ':'é£Ÿç¥', 'å·±':'ä¼¤å®˜', 'åºš':'åè´¢', 'è¾›':'æ­£è´¢', 'å£¬':'ä¸ƒæ€', 'ç™¸':'æ­£å®˜' },
        'ä¸': { 'ç”²':'æ­£å°', 'ä¹™':'åå°', 'ä¸™':'åŠ«è´¢', 'ä¸':'æ¯”è‚©', 'æˆŠ':'ä¼¤å®˜', 'å·±':'é£Ÿç¥', 'åºš':'æ­£è´¢', 'è¾›':'åè´¢', 'å£¬':'æ­£å®˜', 'ç™¸':'ä¸ƒæ€' },
        'æˆŠ': { 'ç”²':'ä¸ƒæ€', 'ä¹™':'æ­£å®˜', 'ä¸™':'åå°', 'ä¸':'æ­£å°', 'æˆŠ':'æ¯”è‚©', 'å·±':'åŠ«è´¢', 'åºš':'é£Ÿç¥', 'è¾›':'ä¼¤å®˜', 'å£¬':'åè´¢', 'ç™¸':'æ­£è´¢' },
        'å·±': { 'ç”²':'æ­£å®˜', 'ä¹™':'ä¸ƒæ€', 'ä¸™':'æ­£å°', 'ä¸':'åå°', 'æˆŠ':'åŠ«è´¢', 'å·±':'æ¯”è‚©', 'åºš':'ä¼¤å®˜', 'è¾›':'é£Ÿç¥', 'å£¬':'æ­£è´¢', 'ç™¸':'åè´¢' },
        'åºš': { 'ç”²':'åè´¢', 'ä¹™':'æ­£è´¢', 'ä¸™':'ä¸ƒæ€', 'ä¸':'æ­£å®˜', 'æˆŠ':'åå°', 'å·±':'æ­£å°', 'åºš':'æ¯”è‚©', 'è¾›':'åŠ«è´¢', 'å£¬':'é£Ÿç¥', 'ç™¸':'ä¼¤å®˜' },
        'è¾›': { 'ç”²':'æ­£è´¢', 'ä¹™':'åè´¢', 'ä¸™':'æ­£å®˜', 'ä¸':'ä¸ƒæ€', 'æˆŠ':'æ­£å°', 'å·±':'åå°', 'åºš':'åŠ«è´¢', 'è¾›':'æ¯”è‚©', 'å£¬':'ä¼¤å®˜', 'ç™¸':'é£Ÿç¥' },
        'å£¬': { 'ç”²':'é£Ÿç¥', 'ä¹™':'ä¼¤å®˜', 'ä¸™':'åè´¢', 'ä¸':'æ­£è´¢', 'æˆŠ':'ä¸ƒæ€', 'å·±':'æ­£å®˜', 'åºš':'åå°', 'è¾›':'æ­£å°', 'å£¬':'æ¯”è‚©', 'ç™¸':'åŠ«è´¢' },
        'ç™¸': { 'ç”²':'ä¼¤å®˜', 'ä¹™':'é£Ÿç¥', 'ä¸™':'æ­£è´¢', 'ä¸':'åè´¢', 'æˆŠ':'æ­£å®˜', 'å·±':'ä¸ƒæ€', 'åºš':'æ­£å°', 'è¾›':'åå°', 'å£¬':'åŠ«è´¢', 'ç™¸':'æ¯”è‚©' }
    };
    
    const dayStem = pillars.day.stem;
    let analysis = '';
    
    // å¹´æŸ±åç¥
    const yearGod = tenGodsMap[dayStem]?.[pillars.year.stem] || 'æœªçŸ¥';
    analysis += `<p><strong>å¹´æŸ±ï¼š</strong>${yearGod} - ä»£è¡¨ç¥–ä¸Šæ ¹åŸºä¸æ—©å¹´è¿åŠ¿</p>`;
    
    // æœˆæŸ±åç¥
    const monthGod = tenGodsMap[dayStem]?.[pillars.month.stem] || 'æœªçŸ¥';
    analysis += `<p><strong>æœˆæŸ±ï¼š</strong>${monthGod} - ä»£è¡¨çˆ¶æ¯å…„å¼Ÿä¸é’å¹´è¿åŠ¿</p>`;
    
    // æ—¥æŸ±åç¥ï¼ˆæ—¥ä¸»ï¼‰
    analysis += `<p><strong>æ—¥æŸ±ï¼š</strong>${dayStem}${baziCalculator.getStemElement(dayStem)}æ—¥ä¸» - ä»£è¡¨è‡ªæˆ‘ä¸é…å¶</p>`;
    
    // æ—¶æŸ±åç¥
    const hourGod = tenGodsMap[dayStem]?.[pillars.hour.stem] || 'æœªçŸ¥';
    analysis += `<p><strong>æ—¶æŸ±ï¼š</strong>${hourGod} - ä»£è¡¨å­å¥³ä¸æ™šå¹´è¿åŠ¿</p>`;
    
    return analysis;
}

// ç”¨ç¥åˆ†æå‡½æ•°
function analyzeUsefulGods(pillars, counts) {
    const dayStem = pillars.day.stem;
    const dayElement = baziCalculator.getStemElement(dayStem);
    
    // ç®€å•çš„èº«å¼ºèº«å¼±åˆ¤æ–­
    const totalElements = Object.values(counts).reduce((a, b) => a + b, 0);
    const selfStrength = counts[dayElement] / totalElements * 100;
    
    let bodyStrength, usefulGods, avoidGods;
    
    if (selfStrength >= 30) {
        bodyStrength = 'èº«å¼º';
        usefulGods = getControllingElements(dayElement); // å…‹æ³„è€—
        avoidGods = getSupportingElements(dayElement);   // ç”Ÿæ‰¶
    } else {
        bodyStrength = 'èº«å¼±';
        usefulGods = getSupportingElements(dayElement);  // ç”Ÿæ‰¶
        avoidGods = getControllingElements(dayElement);  // å…‹æ³„è€—
    }
    
    return `
        <p><strong>èº«å¼ºåˆ†æï¼š</strong>${bodyStrength}ï¼Œ${dayStem}${dayElement}æ—¥ä¸»å æ¯”${Math.round(selfStrength)}%</p>
        <p><strong>å–œç”¨ç¥ï¼š</strong>${usefulGods.join('ã€')}</p>
        <p><strong>å¿Œç¥ï¼š</strong>${avoidGods.join('ã€')}</p>
        <p><strong>è°ƒå€™å»ºè®®ï¼š</strong>æ ¹æ®äº”è¡Œå¹³è¡¡è¿›è¡Œè°ƒæ•´</p>
    `;
}

// è¾…åŠ©å‡½æ•°
function getSupportingElements(element) {
    const supportive = {
        'æœ¨': ['æ°´', 'æœ¨'],
        'ç«': ['æœ¨', 'ç«'],
        'åœŸ': ['ç«', 'åœŸ'],
        'é‡‘': ['åœŸ', 'é‡‘'],
        'æ°´': ['é‡‘', 'æ°´']
    };
    return supportive[element] || [];
}

function getControllingElements(element) {
    const controlling = {
        'æœ¨': ['é‡‘', 'ç«', 'åœŸ'],
        'ç«': ['æ°´', 'åœŸ', 'é‡‘'],
        'åœŸ': ['æœ¨', 'é‡‘', 'æ°´'],
        'é‡‘': ['ç«', 'æ°´', 'æœ¨'],
        'æ°´': ['åœŸ', 'æœ¨', 'ç«']
    };
    return controlling[element] || [];
}

// å…¶ä»–åˆ†æå‡½æ•°
function analyzeCareer(pillars, counts, gender) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const careers = {
        'æœ¨': ['æ•™è‚²æ–‡åŒ–', 'åˆ›æ„è®¾è®¡', 'ç¯ä¿å¥åº·', 'åŒ»ç–—å…»ç”Ÿ'],
        'ç«': ['ç§‘æŠ€åˆ›æ–°', 'èƒ½æºç”µåŠ›', 'å¨±ä¹ä¼ åª’', 'é¤é¥®æœåŠ¡'],
        'åœŸ': ['æˆ¿åœ°äº§', 'å»ºç­‘å·¥ç¨‹', 'é‡‘èæŠ•èµ„', 'å†œä¸šé£Ÿå“'],
        'é‡‘': ['æ³•å¾‹å’¨è¯¢', 'æœºæ¢°åˆ¶é€ ', 'é‡‘èè¯åˆ¸', 'æŠ€æœ¯ç ”å‘'],
        'æ°´': ['è´¸æ˜“ç‰©æµ', 'æ—…æ¸¸æœåŠ¡', 'å’¨è¯¢é¡¾é—®', 'åª’ä½“ä¼ æ’­']
    };
    
    return `
        <p><strong>æœ€ä½³é¢†åŸŸï¼š</strong></p>
        <ul>
            ${(careers[dayElement] || careers['æœ¨']).map(field => `<li><strong>${field}</strong> - é€‚åˆ${dayElement}å…ƒç´ ç‰¹è´¨çš„å‘å±•æ–¹å‘</li>`).join('')}
        </ul>
        <p><strong>å‘å±•å»ºè®®ï¼š</strong>æ ¹æ®ä¸ªäººå…´è¶£å’Œä¸“ä¸šæŠ€èƒ½é€‰æ‹©é€‚åˆçš„è¡Œä¸šå‘å±•è·¯å¾„</p>
    `;
}

function analyzeWealth(pillars, counts) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const wealthTypes = {
        'æœ¨': 'é€šè¿‡ä¸“ä¸šæŠ€èƒ½å’Œç¨³å®šå·¥ä½œç§¯ç´¯è´¢å¯Œ',
        'ç«': 'é€‚åˆæŠ•èµ„å’Œåˆ›æ–°é¢†åŸŸè·å¾—è´¢å¯Œ',
        'åœŸ': 'æˆ¿åœ°äº§å’Œå®ä½“äº§ä¸šæ˜¯è´¢å¯Œæ¥æº',
        'é‡‘': 'é‡‘èæŠ•èµ„å’ŒæŠ€æœ¯ä¸“åˆ©å¸¦æ¥è´¢å¯Œ',
        'æ°´': 'è´¸æ˜“æµé€šå’Œå’¨è¯¢æœåŠ¡åˆ›é€ è´¢å¯Œ'
    };
    
    return `
        <p><strong>è´¢è¿ç‰¹ç‚¹ï¼š</strong>${wealthTypes[dayElement] || wealthTypes['æœ¨']}</p>
        <p><strong>æŠ•èµ„å»ºè®®ï¼š</strong>æ ¹æ®äº”è¡Œå¹³è¡¡é€‰æ‹©åˆé€‚çš„æŠ•èµ„æ–¹å‘</p>
        <p><strong>è´¢å¯Œç§¯ç´¯ï¼š</strong>ä¸­å¹´æ—¶æœŸè´¢è¿è¾ƒä¸ºæ—ºç››</p>
    `;
}

function analyzeLove(pillars, counts, gender) {
    const dayStem = pillars.day.stem;
    const advice = gender === 'male' ? 
        'é€‚åˆå¯»æ‰¾æ€§æ ¼æ¸©å’Œã€å–„è§£äººæ„çš„ä¼´ä¾£' : 
        'é€‚åˆå¯»æ‰¾æœ‰è´£ä»»å¿ƒã€äº‹ä¸šç¨³å®šçš„ä¼´ä¾£';
    
    return `
        <p><strong>æ„Ÿæƒ…æ¨¡å¼ï¼š</strong>${dayStem}æ—¥ä¸»åœ¨æ„Ÿæƒ…ä¸­æ¯”è¾ƒ${getLoveTrait(dayStem)}</p>
        <p><strong>ä¼´ä¾£é€‰æ‹©ï¼š</strong>${advice}</p>
        <p><strong>å©šå§»æ—¶æœºï¼š</strong>25-30å²æ˜¯ç†æƒ³çš„ç»“å©šå¹´é¾„æ®µ</p>
    `;
}

function getLoveTrait(stem) {
    const traits = {
        'ç”²': 'ä¸»åŠ¨ç§¯æ', 'ä¹™': 'æ¸©å’Œä½“è´´', 'ä¸™': 'çƒ­æƒ…å¥”æ”¾', 'ä¸': 'ç»†è…»æ•æ„Ÿ',
        'æˆŠ': 'ç¨³é‡å¯é ', 'å·±': 'åŒ…å®¹ç†è§£', 'åºš': 'åšæ¯…æœæ–­', 'è¾›': 'è¿½æ±‚å®Œç¾',
        'å£¬': 'æµªæ¼«å¤šæƒ…', 'ç™¸': 'æ¸©æŸ”ä½“è´´'
    };
    return traits[stem] || 'çœŸè¯šä¸“ä¸€';
}

function analyzeSpiritual(pillars) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const spiritual = {
        'æœ¨': 'å…·æœ‰å¼ºçƒˆçš„ç›´è§‰å’Œæ„ŸçŸ¥èƒ½åŠ›',
        'ç«': 'å¿ƒçµæ•é”ï¼Œé€‚åˆç²¾ç¥ä¿®è¡Œ',
        'åœŸ': 'æ³¨é‡å®é™…ï¼Œä½†å…·æœ‰å†…åœ¨æ™ºæ…§',
        'é‡‘': 'ç†æ€§æ€è€ƒï¼Œé€‚åˆç ”ç©¶å‘½ç†',
        'æ°´': 'çµæ„Ÿä¸°å¯Œï¼Œé€‚åˆçµæ€§æ¢ç´¢'
    };
    
    return `
        <p><strong>çµæ€§ç‰¹è´¨ï¼š</strong>${spiritual[dayElement] || spiritual['æœ¨']}</p>
        <p><strong>é€‚åˆä¿®è¡Œï¼š</strong>å†¥æƒ³ã€å‘½ç†ç ”ç©¶ã€èƒ½é‡ç–—æ„ˆ</p>
        <p><strong>ç„å­¦ç¼˜åˆ†ï¼š</strong>å…·æœ‰è¾ƒå¼ºçš„å‘½ç†å­¦ä¹ æ½œåŠ›</p>
    `;
}

function analyzeNext3Years(pillars) {
    const currentYear = new Date().getFullYear();
    return `
        <p><strong>${currentYear}å¹´ï¼š</strong>äº‹ä¸šä¸Šæœ‰æ–°æœºä¼šï¼Œé€‚åˆå­¦ä¹ è¿›ä¿®</p>
        <p><strong>${currentYear + 1}å¹´ï¼š</strong>è´¢è¿æå‡ï¼Œæœ‰æŠ•èµ„æœºä¼š</p>
        <p><strong>${currentYear + 2}å¹´ï¼š</strong>äººé™…å…³ç³»é‡è¦å¹´ä»½ï¼Œæ³¨æ„åˆä½œ</p>
    `;
}

// æ˜¾ç¤ºä¸“ä¸šæŠ¥å‘Š
async function showProfessionalReport(baziData) {
    const butlerSection = document.getElementById('butlerProfessional');
    const reportContainer = document.getElementById('professionalReport');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    reportContainer.innerHTML = `æ­£åœ¨ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š...`;
    butlerSection.style.display = 'block';
    
    try {
        const report = await generateProfessionalReport(baziData);
        reportContainer.innerHTML = report;
        butlerSection.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        reportContainer.innerHTML = `æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•`;
    }
}

// ç”Ÿæˆå…«å­—å‘½ç›˜
async function generateBaziChart() {
    const birthdate = $('birthdate').value;
    if (!birthdate) {
        showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ');
        return;
    }

    const timeUnknown = $('timeUnknown').checked;
    const [year, month, day] = birthdate.split('-').map(Number);
    
    let hour = 12;
    if (!timeUnknown) {
        const timeValue = $('birthtime').value;
        if (timeValue) {
            hour = parseInt(timeValue.split(':')[0], 10);
        }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const genBtn = $('genBtn');
    const genBtnText = $('genBtnText');
    const genBtnLoading = $('genBtnLoading');
    
    genBtn.disabled = true;
    genBtnText.style.display = 'none';
    genBtnLoading.style.display = 'inline-block';

    try {
        const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);

        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        $('result').style.display = 'block';

        // è®¾ç½®æ—¥æœŸæ˜¾ç¤º
        const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
        $('bazi-date').textContent = `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`;

        // æ¸²æŸ“å…«å­—æŸ±
        renderPillars(pillars, tu);

        // è®¡ç®—å®Œæˆåæ˜¾ç¤ºä¸“ä¸šæŠ¥å‘Š
        const baziData = {
            pillars: pillars,
            counts: counts, 
            gender: document.getElementById('gender').value,
            name: document.getElementById('name').value || 'æœªçŸ¥'
        };
        
        await showProfessionalReport(baziData);

    } catch (error) {
        console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
        showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        genBtn.disabled = false;
        genBtnText.style.display = 'inline';
        genBtnLoading.style.display = 'none';
    }
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
function init() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const birthdateInput = $('birthdate');
    if (birthdateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        birthdateInput.value = `${year}-${month}-${day}`;
    }

    // ç»‘å®šäº‹ä»¶
    const genBtn = $('genBtn');
    if (genBtn) {
        genBtn.addEventListener('click', generateBaziChart);
    }

    // åˆå§‹åŒ–æ—¶é—´æœªçŸ¥åŠŸèƒ½
    const timeUnknown = $('timeUnknown');
    const birthtime = $('birthtime');
    if (timeUnknown && birthtime) {
        timeUnknown.addEventListener('change', () => {
            birthtime.disabled = timeUnknown.checked;
            if (timeUnknown.checked) {
                birthtime.value = '';
            }
        });
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
