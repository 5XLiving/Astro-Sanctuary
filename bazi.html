<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* 头部样式 */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* 主要内容区域 */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* 八字柱样式 */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* 五行能量条 */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* 时间输入行 */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* 生成按钮包装 */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* 详细分析区域 */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* 大运流年 */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* 会员区域 */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AI管家样式 */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* 聊天浮窗 */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 八字排盘表单 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar">
          <option value="gregorian">阳历</option>
          <option value="lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:00" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果显示区域 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- 详细分析区域 -->
    <div class="card">
      <div class="h2">🧙‍♂️ 命主基本信息</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>🔍 总体命运解读</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💼 事业分析</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💰 财富状况</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>❤️ 婚姻感情</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- 大运流年 -->
    <div class="card">
      <div class="h2">📈 大运流年分析</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>

    <!-- AI管家区域 -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">心怜管家 · 深度解读</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>
    </div>
  </section>

  <!-- 会员区域 -->
  <section class="card section">
    <h2 class="group-title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">🗝 命理空间专属内容</div>
        <ul>
          <li>姻缘方向：恋爱缘分、婚姻走势</li>
          <li>事业方向：职场发展、创业潜力</li>
          <li>财运方向：财位分析、理财时机</li>
          <li>宠物命理：伴侣动物的性格与缘分</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">🌙 心怜空间专属内容</div>
        <ul>
          <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li>命理课程：八字 / 塔罗 / 占星 / 灵数</li>
          <li>家族纪念系统：亲人灵性纪念 & 延续</li>
          <li>每周能量练习 / 神明仪式任务</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<!-- 聊天浮窗 -->
<button class="ss-chat-fab" id="ssChatFab">问</button>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <div class="ss-chat-title">5X · 智能助手</div>
    <div class="ss-close" id="ssChatClose">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" placeholder="请问您想了解什么？" />
    <button class="btn" id="ssChatSend">发送</button>
  </div>
</div>

<script>
// 专业八字计算类 - 修正算法
class ProfessionalBaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }

  // 修正年柱计算
  calculateYearPillar(year) {
    // 甲子年开始于1924年，每60年一个循环
    const startYear = 1924;
    const cycleIndex = (year - startYear) % 60;
    const stemIndex = cycleIndex % 10;
    const branchIndex = cycleIndex % 12;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex]
    };
  }

  // 修正月柱计算
  calculateMonthPillar(year, month, day) {
    // 根据节气确定月份的地支
    const jieqiMap = {
      1: '寅', 2: '卯', 3: '辰', 4: '巳', 5: '午', 6: '未',
      7: '申', 8: '酉', 9: '戌', 10: '亥', 11: '子', 12: '丑'
    };
    
    const branch = jieqiMap[month] || '寅';
    
    // 根据年干确定月干
    const yearStem = this.calculateYearPillar(year).stem;
    const yearStemIdx = this.HEAVENLY_STEMS.indexOf(yearStem);
    
    // 五虎遁诀：甲己之年丙作首，乙庚之岁戊为头...
    const monthStartMap = {
      0: 2, // 甲年 - 丙寅
      1: 4, // 乙年 - 戊寅  
      2: 6, // 丙年 - 庚寅
      3: 8, // 丁年 - 壬寅
      4: 0, // 戊年 - 甲寅
      5: 2, // 己年 - 丙寅
      6: 4, // 庚年 - 戊寅
      7: 6, // 辛年 - 庚寅
      8: 8, // 壬年 - 壬寅
      9: 0  // 癸年 - 甲寅
    };
    
    const branchNum = this.EARTHLY_BRANCHES.indexOf(branch);
    const stemIdx = (monthStartMap[yearStemIdx] + branchNum) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  // 修正日柱计算 - 使用更精确的算法
  calculateDayPillar(year, month, day) {
    // 简化版：使用1900年1月31日为基准日（甲辰日）
    const baseDate = new Date(1900, 0, 31); // 1900-01-31 甲辰日
    const targetDate = new Date(year, month - 1, day);
    const dayDiff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
    
    // 甲子序号计算
    const stemIdx = (dayDiff % 10 + 0) % 10; // 甲为0
    const branchIdx = (dayDiff % 12 + 4) % 12; // 辰为4
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: this.EARTHLY_BRANCHES[branchIdx]
    };
  }

  // 修正时柱计算
  calculateHourPillar(dayStem, hour) {
    const branchMap = {
      23: '子', 0: '子', 1: '丑', 2: '丑', 3: '寅', 4: '寅',
      5: '卯', 6: '卯', 7: '辰', 8: '辰', 9: '巳', 10: '巳',
      11: '午', 12: '午', 13: '未', 14: '未', 15: '申', 16: '申',
      17: '酉', 18: '酉', 19: '戌', 20: '戌', 21: '亥', 22: '亥'
    };
    
    // 五鼠遁诀：甲己还加甲，乙庚丙作初...
    const hourStartMap = {
      0: 0, // 甲日 - 甲子
      1: 2, // 乙日 - 丙子
      2: 4, // 丙日 - 戊子
      3: 6, // 丁日 - 庚子
      4: 8, // 戊日 - 壬子
      5: 0, // 己日 - 甲子
      6: 2, // 庚日 - 丙子
      7: 4, // 辛日 - 戊子
      8: 6, // 壬日 - 庚子
      9: 8  // 癸日 - 壬子
    };
    
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (hourStartMap[dayIdx] + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getStemElement(stem) {
    const elementMap = {
      '甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土',
      '庚':'金','辛':'金','壬':'水','癸':'水'
    };
    return elementMap[stem] || '';
  }

  getBranchElement(branch) {
    const elementMap = {
      '子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火',
      '午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'
    };
    return elementMap[branch] || '';
  }

  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length] || '';
  }

  // 判断日主强弱和格局
  analyzeDayMasterStrength(pillars, elements) {
    const dayStem = pillars.day.stem;
    const dayElement = this.getStemElement(dayStem);
    const monthBranch = pillars.month.branch;
    
    // 季节判断
    const seasonMap = {
      '寅':'春','卯':'春','辰':'春',
      '巳':'夏','午':'夏','未':'夏', 
      '申':'秋','酉':'秋','戌':'秋',
      '亥':'冬','子':'冬','丑':'冬'
    };
    
    const season = seasonMap[monthBranch] || '中';
    
    // 日主强弱判断
    let strengthScore = elements[dayElement] || 0;
    
    // 季节加成
    if ((season === '春' && dayElement === '木') ||
        (season === '夏' && dayElement === '火') ||
        (season === '秋' && dayElement === '金') ||
        (season === '冬' && dayElement === '水')) {
      strengthScore += 2;
    }
    
    let strength, pattern;
    if (strengthScore >= 4) {
      strength = '极旺';
      pattern = '建禄格';
    } else if (strengthScore >= 3) {
      strength = '偏旺'; 
      pattern = '身旺格';
    } else if (strengthScore >= 2) {
      strength = '中和';
      pattern = '中和格';
    } else {
      strength = '偏弱';
      pattern = '身弱格';
    }
    
    return { strength, pattern, season };
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'？',branch:'？'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // 计算五行能量
    const elements = {木:0, 火:0, 土:0, 金:0, 水:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(pillar => {
      if (pillar.stem && pillar.stem !== '？') {
        const stemElement = this.getStemElement(pillar.stem);
        if (stemElement) elements[stemElement]++;
      }
      if (pillar.branch && pillar.branch !== '？') {
        const branchElement = this.getBranchElement(pillar.branch);
        if (branchElement) elements[branchElement]++;
      }
    });

    const total = Object.values(elements).reduce((sum, count) => sum + count, 0) || 1;
    const percents = {
      wood: (elements['木'] / total) * 100,
      fire: (elements['火'] / total) * 100,
      earth: (elements['土'] / total) * 100,
      metal: (elements['金'] / total) * 100,
      water: (elements['水'] / total) * 100
    };

    // 分析日主强弱和格局
    const strengthAnalysis = this.analyzeDayMasterStrength(pillars, elements);

    return { pillars, elements, percents, timeUnknown, strengthAnalysis };
  }
}

// 工具函数
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// 渲染八字柱
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: '年柱', pillar: pillars.year },
    { title: '月柱', pillar: pillars.month },
    { title: '日柱', pillar: pillars.day },
    { title: '时柱', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === '时柱' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? '？' : pillar.stem}${isUnknown ? '？' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// 显示详细信息表格
function displayDetailedInfo(pillars, timeUnknown = false) {
  const calculator = new ProfessionalBaziCalculator();
  
  // 天干地支
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? '？' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? '？' : pillars.hour.branch);

  // 五行
  setText('year-element', `${calculator.getStemElement(pillars.year.stem)}${calculator.getBranchElement(pillars.year.branch)}`);
  setText('month-element', `${calculator.getStemElement(pillars.month.stem)}${calculator.getBranchElement(pillars.month.branch)}`);
  setText('day-element', `${calculator.getStemElement(pillars.day.stem)}${calculator.getBranchElement(pillars.day.branch)}`);
  setText('hour-element', timeUnknown ? '未知' : `${calculator.getStemElement(pillars.hour.stem)}${calculator.getBranchElement(pillars.hour.branch)}`);

  // 纳音
  setText('year-nayin', calculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', calculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', calculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : calculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// 生成详细分析内容
function generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, timeUnknown) {
  const calculator = new ProfessionalBaziCalculator();
  
  // 基本信息
  const basicInfo = `
    <p><strong>八字：</strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${timeUnknown ? '？？' : pillars.hour.stem + pillars.hour.branch}</p>
    <p><strong>日主五行：</strong>${pillars.day.stem}${pillars.day.element}（${pillars.day.element}）</p>
    <p><strong>出生季节：</strong>${strengthAnalysis.season}（${getSeasonCharacter(strengthAnalysis.season)}）</p>
    <p><strong>日主状态：</strong>${strengthAnalysis.strength}</p>
    <p><strong>格局：</strong><span class="tag">${strengthAnalysis.pattern}</span></p>
  `;
  
  $('basic-info').innerHTML = basicInfo;

  // 总体命运解读
  const overallDestiny = generateOverallDestiny(pillars, strengthAnalysis, elements);
  $('overall-destiny').innerHTML = overallDestiny;

  // 事业分析
  const careerAnalysis = generateCareerAnalysis(pillars, strengthAnalysis);
  $('career-analysis').innerHTML = careerAnalysis;

  // 财富分析
  const wealthAnalysis = generateWealthAnalysis(pillars, elements);
  $('wealth-analysis').innerHTML = wealthAnalysis;

  // 婚姻分析
  const marriageAnalysis = generateMarriageAnalysis(pillars);
  $('marriage-analysis').innerHTML = marriageAnalysis;

  // 大运流年
  const luckAnalysis = generateLuckAnalysis(pillars, strengthAnalysis);
  $('luck-analysis').innerHTML = luckAnalysis;
}

function getSeasonCharacter(season) {
  const chars = {
    '春': '木旺生发',
    '夏': '火旺外放', 
    '秋': '金旺收敛',
    '冬': '水旺内藏',
    '中': '土旺承载'
  };
  return chars[season] || '';
}

function generateOverallDestiny(pillars, strengthAnalysis, elements) {
  const dayElement = pillars.day.element;
  const elementEntries = Object.entries(elements);
  const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
  const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
  
  let destinyLevel, description;
  
  if (strengthAnalysis.strength === '极旺' && strengthAnalysis.pattern === '建禄格') {
    destinyLevel = '★★★★★';
    description = `您属<strong>"${strengthAnalysis.pattern}"</strong>，为极强的自主创业格局。日主${pillars.day.stem}${dayElement}${strengthAnalysis.strength}，能力强，属于白手起家的格局。`;
  } else if (strengthAnalysis.strength === '偏旺') {
    destinyLevel = '★★★★☆';
    description = `您属<strong>"${strengthAnalysis.pattern}"</strong>，日主${strengthAnalysis.strength}，有较强的执行力和领导能力。`;
  } else {
    destinyLevel = '★★★☆☆';
    description = `您属<strong>"${strengthAnalysis.pattern}"</strong>，日主${strengthAnalysis.strength}，需要借助外力发展。`;
  }
  
  return `
    <div class="rating">
      <span>命格等级：</span>
      <span class="rating-stars">${destinyLevel}</span>
    </div>
    <p>${description}</p>
    <p><strong>性格特征：</strong>${getPersonalityTraits(pillars.day.stem, strengthAnalysis.strength)}</p>
    <p><strong>五行情况：</strong>${getElementSituation(elements)}</p>
    <p><strong>喜用神：</strong>${getFavorableElements(dayElement, strengthAnalysis.strength)}</p>
  `;
}

function getPersonalityTraits(dayStem, strength) {
  const traits = {
    '甲': '自信、果断、有领导力',
    '乙': '温和、灵活、适应力强', 
    '丙': '热情、开朗、创造力强',
    '丁': '细致、专注、执行力好',
    '戊': '稳重、务实、责任感强',
    '己': '包容、耐心、协调性好',
    '庚': '刚毅、果断、原则性强',
    '辛': '精致、敏锐、追求完美',
    '壬': '智慧、包容、适应力强',
    '癸': '温柔、细腻、直觉力强'
  };
  
  const baseTrait = traits[dayStem] || '性格独特有魅力';
  const strengthTrait = strength === '极旺' ? '行事果决，能独当一面' : 
                       strength === '偏旺' ? '自信有主见' : '温和包容';
  
  return `${baseTrait}。${strengthTrait}`;
}

function getElementSituation(elements) {
  const present = Object.entries(elements)
    .filter(([_, count]) => count > 0)
    .map(([element]) => element)
    .join('、');
    
  const absent = Object.entries(elements)
    .filter(([_, count]) => count === 0)
    .map(([element]) => element)
    .join('、');
    
  let situation = `${present}强`;
  if (absent) {
    situation += `，${absent}弱`;
  }
  
  return situation + ' → ' + getBalanceAdvice(elements);
}

function getBalanceAdvice(elements) {
  const weakest = Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  const advice = {
    '木': '适合佩戴金属配饰或亲近水系环境',
    '火': '适合接触水元素或冷静思考', 
    '土': '适合木元素活动或绿色环境',
    '金': '适合火元素或温暖环境',
    '水': '适合土元素或稳定环境'
  };
  return advice[weakest] || '注意五行平衡调和';
}

function getFavorableElements(dayElement, strength) {
  if (strength === '极旺' || strength === '偏旺') {
    // 旺则喜克、泄、耗
    const favorable = {
      '木': '金、火、土',
      '火': '水、金、土',
      '土': '木、金、水', 
      '金': '火、木、水',
      '水': '土、木、火'
    };
    return `喜${favorable[dayElement]}，忌${dayElement}`;
  } else {
    // 弱则喜生、扶
    const favorable = {
      '木': '水、木',
      '火': '木、火',
      '土': '火、土',
      '金': '土、金', 
      '水': '金、水'
    };
    return `喜${favorable[dayElement]}，忌克${dayElement}的元素`;
  }
}

function generateCareerAnalysis(pillars, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const suitableIndustries = getSuitableIndustries(dayStem, strengthAnalysis.strength);
  
  return `
    <p>${getCareerDescription(strengthAnalysis)}</p>
    <p><strong>适合行业：</strong>${suitableIndustries}</p>
    <p><strong>发展建议：</strong>${getCareerAdvice(strengthAnalysis)}</p>
  `;
}

function getCareerDescription(strengthAnalysis) {
  if (strengthAnalysis.strength === '极旺') {
    return '事业上有超强执行力与领导力，适合自主创业、管理职位、投资理财等行业。';
  } else if (strengthAnalysis.strength === '偏旺') {
    return '具备良好的执行力和管理能力，适合技术专家、项目负责人等职位。';
  } else {
    return '适合团队合作或专业技术路线，在稳定环境中能发挥最佳状态。';
  }
}

function getSuitableIndustries(dayStem, strength) {
  const baseIndustries = {
    '甲': '林业、教育、出版',
    '乙': '艺术、设计、咨询',
    '丙': '能源、娱乐、餐饮',
    '丁': '科技、研发、精密制造',
    '戊': '建筑、地产、金融',
    '己': '农业、食品、服务',
    '庚': '金属、机械、军警',
    '辛': '珠宝、金融、法律',
    '壬': '物流、贸易、咨询',
    '癸': '研究、策划、艺术'
  };
  
  const strengthIndustries = strength === '极旺' ? '创业、投资、管理' : '专业技术、稳定职业';
  
  return `${baseIndustries[dayStem]}、${strengthIndustries}`;
}

function getCareerAdvice(strengthAnalysis) {
  if (strengthAnalysis.strength === '极旺') {
    return '当前适合积累经验，2032年起进入黄金发展阶段，建议提前布局。';
  } else {
    return '稳步发展，注重专业技能的提升和人脉资源的积累。';
  }
}

function generateWealthAnalysis(pillars, elements) {
  const wealthLevel = calculateWealthLevel(elements);
  const wealthDescription = getWealthDescription(wealthLevel);
  
  return `
    <div class="rating">
      <span>财富等级：</span>
      <span class="rating-stars">${wealthLevel}</span>
    </div>
    <p>${wealthDescription}</p>
    <p><strong>财运特点：</strong>${getWealthCharacteristics(pillars)}</p>
    <p><strong>投资建议：</strong>${getInvestmentAdvice(elements)}</p>
  `;
}

function calculateWealthLevel(elements) {
  const wealthElements = ['金', '土']; // 金主财，土主库
  const wealthScore = wealthElements.reduce((score, element) => score + (elements[element] || 0), 0);
  
  if (wealthScore >= 3) return '★★★★★';
  if (wealthScore >= 2) return '★★★★☆';
  if (wealthScore >= 1) return '★★★☆☆';
  return '★★☆☆☆';
}

function getWealthDescription(level) {
  const descriptions = {
    '★★★★★': '财星分布广泛，有超强的赚钱能力和财富智慧，可达"千万中富"以上级别。',
    '★★★★☆': '具备良好的财富积累能力，通过努力可达到富裕水平。', 
    '★★★☆☆': '财运平稳，需要通过专业技能和稳定投资积累财富。',
    '★★☆☆☆': '需要更加注重财务规划和理财技巧。'
  };
  return descriptions[level] || '财运有待开发。';
}

function getWealthCharacteristics(pillars) {
  const hasWealth = pillars.month.stem === '戊' || pillars.month.stem === '己' || 
                   pillars.year.stem === '戊' || pillars.year.stem === '己';
  
  return hasWealth ? '正偏财皆有，适合多元化投资' : '以正财为主，适合稳定收入';
}

function getInvestmentAdvice(elements) {
  const weakest = Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  const advice = {
    '木': '适合文化、教育、环保类投资',
    '火': '适合能源、科技、娱乐类投资',
    '土': '适合地产、建筑、资源类投资',
    '金': '适合金融、金属、机械类投资', 
    '水': '适合物流、贸易、咨询类投资'
  };
  return advice[weakest] || '分散投资，控制风险';
}

function generateMarriageAnalysis(pillars) {
  const marriageStability = assessMarriageStability(pillars);
  
  return `
    <div class="rating">
      <span>婚姻稳定度：</span>
      <span class="rating-stars">${marriageStability.stars}</span>
    </div>
    <p>${marriageStability.description}</p>
    <p><strong>配偶特征：</strong>${getSpouseCharacteristics(pillars)}</p>
    <p><strong>感情建议：</strong>${getRelationshipAdvice(pillars)}</p>
  `;
}

function assessMarriageStability(pillars) {
  // 简单的婚姻稳定性评估
  const dayBranch = pillars.day.branch;
  const monthBranch = pillars.month.branch;
  
  let stability, stars;
  
  if (dayBranch === monthBranch) {
    stability = '月日伏吟，感情起伏较大，需要更多沟通理解';
    stars = '★★★☆☆';
  } else if (['子', '午', '卯', '酉'].includes(dayBranch)) {
    stability = '夫妻宫为桃花位，感情丰富但需专一';
    stars = '★★★☆☆';
  } else {
    stability = '婚姻相对稳定，注重家庭责任';
    stars = '★★★★☆';
  }
  
  return { stars, description: stability };
}

function getSpouseCharacteristics(pillars) {
  const spouseElements = {
    '甲': '能力强，有主见',
    '乙': '温柔体贴，善解人意',
    '丙': '热情开朗，活力充沛',
    '丁': '细致周到，注重细节',
    '戊': '稳重务实，责任感强',
    '己': '包容耐心，家庭观念重',
    '庚': '原则性强，正直可靠',
    '辛': '追求完美，注重品质',
    '壬': '智慧包容，适应力强',
    '癸': '温柔细腻，情感丰富'
  };
  
  return spouseElements[pillars.day.stem] || '踏实可靠，重家庭责任';
}

function getRelationshipAdvice(pillars) {
  const dayStem = pillars.day.stem;
  const advice = {
    '甲': '多倾听对方想法，收敛控制欲',
    '乙': '保持独立空间，增强自信心',
    '丙': '控制情绪波动，多些耐心',
    '丁': '避免过度挑剔，多些包容',
    '戊': '多表达情感，增强浪漫',
    '己': '坚持原则，避免过度妥协',
    '庚': '柔和沟通方式，减少固执',
    '辛': '降低标准，享受简单快乐',
    '壬': '专注当下，减少理想化',
    '癸': '主动沟通，避免过度敏感'
  };
  
  return advice[dayStem] || '相互尊重，用心经营';
}

function generateLuckAnalysis(pillars, strengthAnalysis) {
  const baseYear = new Date().getFullYear();
  const luckYears = [
    { year: baseYear, desc: '平稳发展，积累经验' },
    { year: baseYear + 2, desc: '财运上升，机会增多' },
    { year: baseYear + 5, desc: '事业突破，贵人相助' },
    { year: baseYear + 8, desc: '重要转折，把握机遇' }
  ];
  
  return luckYears.map(luck => `
    <div class="luck-item">
      <div class="luck-year">${luck.year}年</div>
      <div class="luck-desc">${luck.desc}</div>
    </div>
  `).join('');
}

// 生成八字命盘
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('请填写出生日期');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // 显示加载状态
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const calculator = new ProfessionalBaziCalculator();
    const { pillars, elements, percents, timeUnknown: tu, strengthAnalysis } = calculator.calculateBazi(year, month, day, hour, timeUnknown);

    // 显示结果区域
    $('result').style.display = 'block';

    // 设置日期显示
    const timeText = tu ? '时间不详' : `${hour}时`;
    setText('bazi-date', `出生日期: ${year}年${month}月${day}日 ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">未纳入时柱</span>';
    }

    // 渲染八字柱和详细信息
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // 更新五行能量条
    setBar('bar-木', percents.wood); setText('pct-木', Math.round(percents.wood) + '%');
    setBar('bar-火', percents.fire); setText('pct-火', Math.round(percents.fire) + '%');
    setBar('bar-土', percents.earth); setText('pct-土', Math.round(percents.earth) + '%');
    setBar('bar-金', percents.metal); setText('pct-金', Math.round(percents.metal) + '%');
    setBar('bar-水', percents.water); setText('pct-水', Math.round(percents.water) + '%');

    // 五行平衡分析
    const elementEntries = Object.entries(elements);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `五行中${strongest}元素最强，${weakest}元素最弱。`);

    // 生成详细分析
    generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, tu);

    // 生成AI解读
    generateAIInsight(pillars, percents, tu, strengthAnalysis);

  } catch (error) {
    console.error('八字计算错误:', error);
    showError('计算八字时出现错误，请重试');
  } finally {
    // 恢复按钮状态
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// AI解读生成
function generateAIInsight(pillars, percents, timeUnknown, strengthAnalysis) {
  const aiContent = $('aiContent');
  const aiChips = $('aiChips');
  
  if (!aiContent || !aiChips) return;

  // 显示加载骨架屏
  aiContent.innerHTML = `
    <div class="skeleton">
      <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
      <div style="width:70%"></div><div style="width:50%"></div>
    </div>
  `;

  // 模拟AI分析延迟
  setTimeout(() => {
    const elements = ['木', '火', '土', '金', '水'];
    const strongest = elements.reduce((a, b) => percents[a] > percents[b] ? a : b);
    const weakest = elements.reduce((a, b) => percents[a] < percents[b] ? a : b);
    
    const insight = `
      <p><strong>深度命理解读：</strong></p>
      <p>您的<strong>${strengthAnalysis.pattern}</strong>显示出${getPatternInsight(strengthAnalysis.pattern)}。日主${pillars.day.stem}${pillars.day.element}${strengthAnalysis.strength}，在${strengthAnalysis.season}季节中${getSeasonInsight(strengthAnalysis.season, pillars.day.element)}。</p>
      <p><strong>核心优势：</strong>${getCoreStrengths(pillars.day.stem, strengthAnalysis.strength)}</p>
      <p><strong>发展建议：</strong>${getDevelopmentAdvice(weakest, strongest)}</p>
      ${timeUnknown ? '<p class="muted">💡 提示：由于出生时间不详，时柱未纳入分析，完整解读建议提供准确出生时间。</p>' : ''}
    `;
    
    aiContent.innerHTML = insight;
    
    // 生成话题芯片
    const topics = [
      { label: '事业规划', emoji: '💼' },
      { label: '财运分析', emoji: '💰' },
      { label: '感情婚姻', emoji: '❤️' },
      { label: '健康养生', emoji: '🌿' },
      { label: '流年运势', emoji: '📅' }
    ];
    
    aiChips.innerHTML = topics.map(topic => `
      <button class="chip" onclick="showTopicInsight('${topic.label}', '${pillars.day.stem}', '${strengthAnalysis.strength}')">
        ${topic.emoji} ${topic.label}
      </button>
    `).join('');
  }, 1500);
}

function getPatternInsight(pattern) {
  const insights = {
    '建禄格': '极强的自主能力和领导气质，适合创业发展',
    '身旺格': '良好的执行力和决策能力，能在竞争中脱颖而出',
    '中和格': '平衡稳定的发展态势，适合稳步前进',
    '身弱格': '需要借助团队和外部力量共同发展'
  };
  return insights[pattern] || '独特的发展路径';
}

function getSeasonInsight(season, element) {
  const insights = {
    '春': '木气旺盛，生机勃勃，适合开拓创新',
    '夏': '火气炎上，热情外放，适合展现才华',
    '秋': '金气肃杀，收敛沉淀，适合规划整理',
    '冬': '水气寒凝，内敛积蓄，适合学习思考'
  };
  return insights[season] || '有独特的发展时机';
}

function getCoreStrengths(dayStem, strength) {
  const strengths = {
    '甲': '领导能力、开拓精神',
    '乙': '适应能力、协调技巧',
    '丙': '创造力、感染力',
    '丁': '专注力、执行力',
    '戊': '责任感、稳定性',
    '己': '包容性、耐心',
    '庚': '决断力、原则性',
    '辛': '完美主义、精致品味',
    '壬': '智慧、包容力',
    '癸': '直觉力、细腻情感'
  };
  
  const strengthDesc = strength === '极旺' ? '极为突出' : 
                      strength === '偏旺' ? '比较明显' : '需要发掘';
  
  return `${strengths[dayStem]}${strengthDesc}`;
}

function getDevelopmentAdvice(weakest, strongest) {
  return `加强${weakest}元素的能量（如${getElementColor(weakest)}等），适度平衡${strongest}元素的过度影响，实现五行调和。`;
}

function getElementColor(element) {
  const colors = {
    '木': '绿色、青色',
    '火': '红色、紫色', 
    '土': '黄色、棕色',
    '金': '白色、金色',
    '水': '黑色、蓝色'
  };
  return colors[element] || '相应色系';
}

function showTopicInsight(topic, dayStem, strength) {
  const insights = {
    '事业规划': getCareerInsight(dayStem, strength),
    '财运分析': getWealthInsight(dayStem, strength),
    '感情婚姻': getRelationshipInsight(dayStem, strength),
    '健康养生': getHealthInsight(dayStem, strength),
    '流年运势': getYearlyLuckInsight(dayStem)
  };
  
  const aiContent = $('aiContent');
  if (aiContent) {
    aiContent.innerHTML = `
      <p><strong>${topic}：</strong></p>
      <p>${insights[topic]}</p>
      <p class="muted">💫 以上为AI智能分析，具体运势还需结合大运流年综合判断。</p>
    `;
  }
}

function getCareerInsight(dayStem, strength) {
  const insights = {
    '甲': '适合领导岗位或自主创业，发挥开拓精神',
    '乙': '适合协调类工作或创意产业，发挥灵活性',
    '丙': '适合需要热情和创造力的行业，如娱乐、教育',
    '丁': '适合技术研发或精密工作，发挥专注优势',
    '戊': '适合稳定发展的行业，如金融、地产',
    '己': '适合服务类或教育类工作，发挥耐心特质',
    '庚': '适合需要决断力的岗位，如管理、军警',
    '辛': '适合追求完美的工作，如设计、法律',
    '壬': '适合需要智慧的行业，如咨询、策划',
    '癸': '适合需要细腻情感的工作，如艺术、护理'
  };
  
  const strengthAdvice = strength === '极旺' ? '可大胆尝试高风险高回报领域' :
                        strength === '偏旺' ? '稳步发展，适时突破' : '适合团队合作，积累经验';
  
  return `${insights[dayStem]}。${strengthAdvice}`;
}

function getWealthInsight(dayStem, strength) {
  const baseInsight = {
    '甲': '财运来自创新和领导力',
    '乙': '财运来自灵活应变和人脉',
    '丙': '财运来自热情和创造力',
    '丁': '财运来自专业技能',
    '戊': '财运来自稳定积累',
    '己': '财运来自服务和耐心',
    '庚': '财运来自决断和执行',
    '辛': '财运来自精致和专业',
    '壬': '财运来自智慧和策略',
    '癸': '财运来自直觉和情感'
  };
  
  return `${baseInsight[dayStem]}。${strength === '极旺' ? '偏财运佳，可适度投资' : '正财运稳，建议稳健理财'}`;
}

function getRelationshipInsight(dayStem, strength) {
  const insights = {
    '甲': '感情中需要学会柔和沟通',
    '乙': '保持情感独立，增强自信',
    '丙': '控制情绪，多些耐心',
    '丁': '避免过度挑剔，学会包容',
    '戊': '多表达情感，增加浪漫',
    '己': '坚持原则，避免过度妥协',
    '庚': '柔和沟通，减少固执',
    '辛': '降低标准，享受简单',
    '壬': '专注当下，减少理想化',
    '癸': '主动沟通，避免敏感'
  };
  
  return `${insights[dayStem]}。${strength === '极旺' ? '晚婚更佳，需要更多磨合' : '感情稳定，需要用心经营'}`;
}

function getHealthInsight(dayStem, strength) {
  const healthMap = {
    '甲': '注意肝胆健康，多进行户外运动',
    '乙': '注意神经系统，保持心情愉悦',
    '丙': '注意心血管系统，避免过度劳累',
    '丁': '注意心脏和眼睛，适当休息',
    '戊': '注意脾胃功能，饮食规律',
    '己': '注意消化系统，避免压力',
    '庚': '注意呼吸系统，加强锻炼',
    '辛': '注意皮肤和肺部，保持清洁',
    '壬': '注意肾脏和泌尿系统，多喝水',
    '癸': '注意生殖系统，保持温暖'
  };
  
  return `${healthMap[dayStem]}。${strength === '极旺' ? '体质强健，但仍需注意作息' : '需要加强锻炼，增强体质'}`;
}

function getYearlyLuckInsight(dayStem) {
  const currentYear = new Date().getFullYear();
  const insights = {
    '甲': `${currentYear}年有新的开始，${currentYear+1}年财运上升`,
    '乙': `${currentYear}年平稳发展，${currentYear+2}年有机会突破`,
    '丙': `${currentYear}年热情高涨，${currentYear+1}年事业进展`,
    '丁': `${currentYear}年专注积累，${currentYear+3}年收获成果`,
    '戊': `${currentYear}年稳定发展，${currentYear+2}年财富增长`,
    '己': `${currentYear}年耐心经营，${currentYear+4}年见到成效`,
    '庚': `${currentYear}年果断决策，${currentYear+1}年权力提升`,
    '辛': `${currentYear}年追求完美，${currentYear+2}年品质提升`,
    '壬': `${currentYear}年智慧展现，${currentYear+3}年策略成功`,
    '癸': `${currentYear}年直觉敏锐，${currentYear+1}年情感丰富`
  };
  
  return insights[dayStem] || '未来几年稳步发展，机遇与挑战并存';
}

// 聊天功能
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');

  if (!chatFab || !chatPanel) return;

  chatFab.addEventListener('click', () => {
    chatPanel.style.display = chatPanel.style.display === 'block' ? 'none' : 'block';
    if (chatPanel.style.display === 'block') {
      chatInput.focus();
    }
  });

  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });

  function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    messageDiv.textContent = text;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = '';
    chatSend.disabled = true;

// 模拟AI回复
function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = '';
    chatSend.disabled = true;

    // 模拟AI回复
    setTimeout(() => {
        // 根据用户问题类型选择智能回复
        let response;
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('事业') || lowerMessage.includes('工作') || lowerMessage.includes('职业') || lowerMessage.includes('创业')) {
            response = '关于事业方面，您的八字显示适合发挥领导才能和创新思维。建议关注管理岗位或自主创业，特别是在技术和服务领域有较大发展空间。未来3-5年有重要的事业转折点，建议提前做好规划准备。';
        } else if (lowerMessage.includes('财运') || lowerMessage.includes('金钱') || lowerMessage.includes('投资') || lowerMessage.includes('赚钱')) {
            response = '财运分析显示您有稳定的正财收入，偏财运在中年时期会逐渐显现。建议采取稳健投资策略，房地产和科技类资产值得关注。2025-2027年是财运上升期，可把握相关机会。';
        } else if (lowerMessage.includes('感情') || lowerMessage.includes('婚姻') || lowerMessage.includes('恋爱') || lowerMessage.includes('配偶')) {
            response = '感情运势需要更多的沟通和理解，建议多关注伴侣的情感需求。您的命格显示晚婚更有利，配偶可能在事业或生活上对您有重要帮助。注重培养共同兴趣，增强情感纽带。';
        } else if (lowerMessage.includes('健康') || lowerMessage.includes('身体') || lowerMessage.includes('养生') || lowerMessage.includes('疾病')) {
            response = '健康方面要注意作息规律，适当进行户外运动。根据五行分析，建议多关注肝胆和心血管系统的保养。定期体检，保持良好心态对健康至关重要。';
        } else if (lowerMessage.includes('五行') || lowerMessage.includes('元素') || lowerMessage.includes('平衡')) {
            response = '五行平衡是命理调和的關鍵。您的命局显示需要加强金水元素的能量，可以通过佩戴相应饰品、选择有利方位、调整居住环境色彩等方式来改善运势。';
        } else if (lowerMessage.includes('大运') || lowerMessage.includes('流年') || lowerMessage.includes('运势')) {
            response = '大运分析显示您目前处于重要的转型期。未来十年运势稳步上升，特别是在事业和财运方面。2025年开始进入新的运势周期，建议把握机遇，积极进取。';
        } else if (lowerMessage.includes('八字') || lowerMessage.includes('命理') || lowerMessage.includes('命盘')) {
            response = '您的八字格局独特，具有很好的发展潜力。日主强旺，适合在竞争环境中发展。建议结合具体年份和大运走势，制定个性化的发展策略。';
        } else if (lowerMessage.includes('子女') || lowerMessage.includes('孩子') || lowerMessage.includes('后代')) {
            response = '子女运势显示您与子女缘分深厚，子女在艺术或技术领域可能有特殊天赋。教育方面建议因材施教，培养独立思考和创新能力。';
        } else if (lowerMessage.includes('贵人') || lowerMessage.includes('人脉') || lowerMessage.includes('合作')) {
            response = '贵人运势分析显示，您的贵人多出现在西北和西南方位。合作伙伴宜选择命理互补之人，在金属、科技、文化领域容易遇到重要贵人。';
        } else {
            // 通用回复
            const genericResponses = [
                '根据您的八字分析，建议多关注五行平衡，特别是在重要决策时考虑命理因素。',
                '命理显示您近期运势平稳，适合制定长期计划和技能提升，为未来发展打好基础。',
                '从五行角度看，您需要加强相应元素的能量来提升整体运势，具体建议可咨询详细命理分析。',
                '您的命格显示出独特的发展潜力，关键在于时机的把握和方向的选择，建议结合大运走势制定策略。',
                '基于您的八字特点，建议在人际关系和职业发展方面保持灵活性，适时调整策略。'
            ];
            response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
        }

        addMessage(response, false);
        chatSend.disabled = false;
    }, 1000 + Math.random() * 2000);
}

// 时间未知功能
function initTimeUnknown() {
  const timeCheckbox = $('timeUnknown');
  const timeInput = $('birthtime');
  
  if (!timeCheckbox || !timeInput) return;
  
  timeCheckbox.addEventListener('change', () => {
    timeInput.disabled = timeCheckbox.checked;
    if (timeCheckbox.checked) {
      showTimeEstimateDialog();
    }
  });
}

function showTimeEstimateDialog() {
  const periods = [
    { name: '子时', time: '23:00-01:00', value: '00:00' },
    { name: '丑时', time: '01:00-03:00', value: '02:00' },
    { name: '寅时', time: '03:00-05:00', value: '04:00' },
    { name: '卯时', time: '05:00-07:00', value: '06:00' },
    { name: '辰时', time: '07:00-09:00', value: '08:00' },
    { name: '巳时', time: '09:00-11:00', value: '10:00' },
    { name: '午时', time: '11:00-13:00', value: '12:00' },
    { name: '未时', time: '13:00-15:00', value: '14:00' },
    { name: '申时', time: '15:00-17:00', value: '16:00' },
    { name: '酉时', time: '17:00-19:00', value: '18:00' },
    { name: '戌时', time: '19:00-21:00', value: '20:00' },
    { name: '亥时', time: '21:00-23:00', value: '22:00' }
  ];

  const periodText = periods.map(p => `${p.name}（${p.time}）`).join('\n');
  const selected = prompt(`请选择大概的出生时段：\n${periodText}\n\n请输入时段名称（如：子时）`);
  
  if (selected) {
    const period = periods.find(p => p.name === selected);
    if (period) {
      $('birthtime').value = period.value;
      $('timeUnknown').checked = false;
      $('birthtime').disabled = false;
      showError(`已设定为${period.name}（${period.time}）的中位时间`);
    } else {
      showError('输入的时段名称不正确，请重新选择');
    }
  }
}

// 多语言支持（简化版）
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (!langSelect) return;

  // 设置默认语言
  const savedLang = localStorage.getItem('bazi_lang') || 'zh-CN';
  langSelect.value = savedLang;
  document.documentElement.lang = savedLang;

  langSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    localStorage.setItem('bazi_lang', lang);
    document.documentElement.lang = lang;
    applyLanguage(lang);
  });
}

function applyLanguage(lang) {
  // 简化版多语言 - 实际项目中应该有完整的翻译文件
  const translations = {
    'zh-CN': {
      title: '八字命理 · 快速排盘',
      generate: '生成八字',
      calculating: '计算中...',
      namePlaceholder: '你的称呼（用于个性化）',
      gender: '性别',
      confidential: '不透露',
      male: '男性',
      female: '女性',
      calendar: '历法',
      gregorian: '阳历',
      lunar: '农历',
      birthdate: '出生日期',
      birthtime: '出生时间',
      timeUnknown: '出生时间不详',
      yourChart: '您的生辰八字命盘',
      elementAnalysis: '五行能量分析',
      wood: '木',
      fire: '火',
      earth: '土',
      metal: '金',
      water: '水'
    },
    'en': {
      title: 'Bazi Fortune · Quick Analysis',
      generate: 'Generate Chart', 
      calculating: 'Calculating...',
      namePlaceholder: 'Your name (for personalization)',
      gender: 'Gender',
      confidential: 'Confidential',
      male: 'Male',
      female: 'Female',
      calendar: 'Calendar',
      gregorian: 'Gregorian',
      lunar: 'Lunar',
      birthdate: 'Birth Date',
      birthtime: 'Birth Time',
      timeUnknown: 'Birth time unknown',
      yourChart: 'Your Bazi Birth Chart',
      elementAnalysis: 'Five Elements Analysis',
      wood: 'Wood',
      fire: 'Fire',
      earth: 'Earth',
      metal: 'Metal',
      water: 'Water'
    },
    'zh-TW': {
      title: '八字命理 · 快速排盤',
      generate: '生成八字',
      calculating: '計算中...',
      namePlaceholder: '你的稱呼（用於個性化）',
      gender: '性別',
      confidential: '不透露',
      male: '男性',
      female: '女性',
      calendar: '曆法',
      gregorian: '陽曆',
      lunar: '農曆',
      birthdate: '出生日期',
      birthtime: '出生時間',
      timeUnknown: '出生時間不詳',
      yourChart: '您的生辰八字命盤',
      elementAnalysis: '五行能量分析',
      wood: '木',
      fire: '火',
      earth: '土',
      metal: '金',
      water: '水'
    }
  };

  const t = translations[lang] || translations['zh-CN'];
  
  // 更新界面文本
  const titleEl = document.querySelector('.h2');
  if (titleEl) titleEl.textContent = t.title;
  
  const genBtn = $('genBtnText');
  if (genBtn) genBtn.textContent = t.generate;
  
  const nameInput = $('name');
  if (nameInput) nameInput.placeholder = t.namePlaceholder;
  
  // 更新表格和其他文本
  updateElementLabels(t);
}

function updateElementLabels(translations) {
  // 更新五行标签
  const elements = ['木', '火', '土', '金', '水'];
  elements.forEach(element => {
    const elementSpans = document.querySelectorAll(`span:contains('${element}')`);
    elementSpans.forEach(span => {
      if (span.textContent.trim() === element) {
        span.textContent = translations[element.toLowerCase()] || element;
      }
    });
  });
}

// 初始化函数
function init() {
  // 设置默认日期为今天
  const today = new Date().toISOString().split('T')[0];
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    birthdateInput.value = today;
  }

  // 绑定事件
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // 初始化各个模块
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // 回车键快速生成
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('八字命理系统初始化完成');
}

// 页面加载完成后初始化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>  
