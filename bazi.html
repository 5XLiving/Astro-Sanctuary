<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{ font-size:16px }
    @media (min-width:768px){ html{ font-size:17px } }
    @media (min-width:1200px){ html{ font-size:18px } }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}

    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* â€”â€” å¤´éƒ¨ â€”â€” */
    .site-header{ position:sticky; top:0; z-index:10; background:#0b0f14cc; border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px); }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084; }
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25; }

    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text); padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* â€”â€” é€šç”¨å¡ç‰‡/æ’ç‰ˆ â€”â€” */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    label.muted{display:block;margin-bottom:4px}

    input,select{ width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text); padding:12px 12px;font-size:15px;outline:none; }
    input::placeholder{color:#6f8092}

    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

    /* â€”â€” æŸ±/è¡¨æ ¼ â€”â€” */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* â€”â€” äº”è¡Œæ¡ â€”â€” */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}

    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* â€”â€” å‡ºç”Ÿæ—¶é—´è¾“å…¥ â€”â€” */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row input[type="time"]{ width:auto !important; flex:0 0 160px; min-width:140px; }
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* â€”â€” å³ä¸‹è§’å¿ƒæ€œç®¡å®¶ï¼ˆéšè—è§¦å‘ FABï¼‰ â€”â€” */
    .ss-chat-fab, .ss-chat-panel { display: none !important; }

    /* â€”â€” ä¼šå‘˜åŒº â€”â€” */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px; overflow:hidden}
    .spacer{height:12px}
    .panel .body .row.one > * { min-width: 0; }
    .panel .body .btn { display:flex; align-items:center; justify-content:center; text-align:center; white-space:normal; line-height:1.2; word-break:break-word; padding:10px 14px; }
    .btn.block { display:block; width:100%; box-sizing:border-box; }

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* â€”â€” åªä¿ç•™ä¸€ä¸ª GPT çª—å£ï¼šéšè—ç»“æœåŒºæŠ½å±‰ â€”â€” */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* â€”â€” ä¼°æ—¶é—´å¼¹çª— â€”â€” */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}

    .sr-only{ position:absolute !important; width:1px;height:1px;padding:0;margin:-1px; overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title"> 5xLiving Â· <span data-i18n="title_bazi_brief">å…«å­—ç®€è¯„</span> </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2" data-i18n="title_quickcalc">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>

    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="label_name">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" data-i18n-ph="ph_name" />
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">æ€§åˆ«</label>
        <select id="gender">
          <option value="" data-i18n="opt_gender_confidential">ä¸é€éœ²</option>
          <option value="male" data-i18n="opt_gender_male">ç”·æ€§</option>
          <option value="female" data-i18n="opt_gender_female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="label_calendar">å†æ³•</label>
        <select id="calendar">
          <option value="gregorian" data-i18n="opt_cal_gregorian">é˜³å†</option>
          <option value="lunar" data-i18n="opt_cal_lunar">å†œå†</option>
        </select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="label_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted" data-i18n="label_birthtime">å‡ºç”Ÿæ—¶é—´</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:00" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span data-i18n="cb_time_unknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText" data-i18n="btn_generate_chart">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2" data-i18n="rpt_chart_title">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2" data-i18n="rpt_sec_elements_title">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span data-i18n="el_wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span data-i18n="el_fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span data-i18n="el_earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span data-i18n="el_metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span data-i18n="el_water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- Butler AI will mount here -->
    <div id="rich-report" class="report"></div>
  </section>

  <!-- ä¼šå‘˜ä¸“åŒº -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

    <section class="astro-auth">
      <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é‚®ç®± Email" data-i18n-ph="ph_email" required />
              <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>
            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- ä¼°æ—¶é—´å¼¹çª— -->
<div class="tw-mask" id="twMask" aria-hidden="true">
  <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
    <div class="tw-head" id="twTitle">ğŸ§­ ä¼°ä¸€ä¸ªå¤§è‡´å‡ºç”Ÿæ—¶é—´</div>
    <div class="tw-body">
      <div class="muted" style="margin-bottom:8px">é€‰æ‹©ä½ è®°å¾—çš„<strong>å¤§æ¦‚æ—¶æ®µ</strong>ï¼ˆåœ°æ”¯åŒå°æ—¶æ®µï¼‰</div>
      <div class="tw-grid" id="twGrid"></div>
      <div class="muted" style="margin-top:10px;font-size:.9em">é€‰æ‹©åç‚¹â€œå¡«å…¥æ—¶é—´â€ï¼Œä¼šç”¨è¯¥æ—¶æ®µçš„ä¸­ä½æ—¶é—´å†™åˆ°ä¸Šæ–¹æ—¶é—´è¾“å…¥æ¡†ï¼Œå¹¶è‡ªåŠ¨å–æ¶ˆâ€œæ—¶é—´ä¸è¯¦â€ã€‚</div>
    </div>
    <div class="tw-foot">
      <button class="btn ghost" id="twCancel" type="button">å–æ¶ˆ</button>
      <button class="btn" id="twApply" type="button" disabled>å¡«å…¥æ—¶é—´</button>
    </div>
  </div>
</div>

<script>
'use strict';

/* ================== é…ç½® & å·¥å…· ================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const $ = (id) => document.getElementById(id);

function showErr(msg){ const e=$("error"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
function showAuthErr(msg){ const e=$("authError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideAuthErr(){ const e=$("authError"); if(!e) return; e.style.display="none"; e.textContent=""; }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ---------- æ›´ç¨³çš„ç½‘ç»œåŠ©æ‰‹ï¼šçŠ¶æ€ç /è¶…æ—¶/é JSON ---------- */
async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, mode: 'cors', body: JSON.stringify(payload), signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){ return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') }; }
  finally{ clearTimeout(timer); }
}

/* ================== å¤šè¯­è¨€ï¼ˆå« msï¼‰ ================== */
const LANG_KEY="site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

if (typeof window.translations === 'undefined') {
  window.translations = {
    "zh-CN": {
      page_title:"å…«å­—å‘½ç† Â· 5XLiving",
      lang_label:"è¯­è¨€", title_bazi_brief:"å…«å­—ç®€è¯„",
      title_quickcalc:"å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜",
      label_name:"å§“åï¼ˆå¯é€‰ï¼‰", ph_name:"ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰",
      gender_label:"æ€§åˆ«", label_calendar:"å†æ³•",
      label_birthdate:"å‡ºç”Ÿæ—¥æœŸ", label_birthtime:"å‡ºç”Ÿæ—¶é—´",
      opt_gender_confidential:"ä¸é€éœ²", opt_gender_male:"ç”·æ€§", opt_gender_female:"å¥³æ€§",
      opt_cal_gregorian:"é˜³å†", opt_cal_lunar:"å†œå†",
      cb_time_unknown:"å‡ºç”Ÿæ—¶é—´ä¸è¯¦", btn_generate_chart:"ç”Ÿæˆå…«å­—",
      rpt_free_title:"å…è´¹ç®€æŠ¥", rpt_pillars_label:"å››æŸ±",
      rpt_daymaster_label:"æ—¥ä¸»", rpt_season_label:"å­£èŠ‚",
      rpt_chart_label:"å‘½å±€", rpt_wuxing_label:"äº”è¡Œåˆ†å¸ƒ",
      rpt_time_hint:"æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ï¼Œä»…ä¾›å‚è€ƒã€‚",
      rpt_time_unknown:"æ—¶é—´ä¸è¯¦", rpt_fav_avoid_template:"å–œç”¨ï¼š{fav}ï½œå¿Œï¼š{avoid}",
      rpt_sec_overview_title:"ä¸€ã€å‘½ç›˜æ€»è§ˆ", rpt_sec_elements_title:"äºŒã€äº”è¡Œèƒ½é‡åˆ†æ",
      rpt_chart_title:"æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜",
      rpt_balance_focus_label:"è°ƒè¡¡è¦ç‚¹", rpt_strongest_word:"åæ—º", rpt_weakest_word:"åå¼±",
      rpt_absent_prefix:"ç¼ºï¼š", elements_balance_tpl:"äº”è¡Œä¸­{max}å…ƒç´ æœ€å¼ºï¼Œ{min}å…ƒç´ æœ€å¼±ã€‚",
      butler_title:"å¿ƒæ€œç®¡å®¶ Â· è§£è¯»",
      el_wood:"æœ¨", el_fire:"ç«", el_earth:"åœŸ", el_metal:"é‡‘", el_water:"æ°´",
      vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment", vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹", vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
      vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿", vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
      vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº", vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
      vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶", vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
      vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ", vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
      vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾", vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
      vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡", vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
      login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½", panel_login_head:"è´¦æˆ·ç™»å½• / æ³¨å†Œ", panel_member_head:"ä¼šå‘˜æœåŠ¡",
      btn_login:"ç™»å…¥è´¦æˆ·", btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ", btn_register:"æ³¨å†Œè´¦æˆ·", btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
      btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ", note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ", note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
      ph_email:"é‚®ç®± Email", ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
      q_career:"è¯·ç»“åˆæˆ‘çš„å…«å­—â€¦ç»™æˆ‘èŒä¸šå‘å±•å»ºè®®ã€‚",
      q_love:"è¯·ç»“åˆå…«å­—ä¿¡æ¯â€¦æ‹çˆ±/å©šå§»å»ºè®®ã€‚",
      q_money:"è¯·ç»“åˆå…«å­—ä¿¡æ¯â€¦æœªæ¥åŠå¹´è´¢è¿ä¸ç†è´¢å»ºè®®ã€‚",
      q_list:"åŸºäºæˆ‘çš„å…«å­—ç»“æ„ï¼Œç”Ÿæˆâ€œä»Šæ—¥å¾…åŠâ€çš„3-5æ¡ã€‚",
      q_30d:"ç»“åˆæˆ‘çš„å¼±é¡¹äº”è¡Œï¼Œç»™æˆ‘ä¸€ä»½è¿ç»­30å¤©çš„å°ç»ƒä¹ æ¸…å•ã€‚",
      chip_career:"èŒä¸šå»ºè®®", chip_love:"æƒ…æ„Ÿå»ºè®®", chip_money:"è´¢è¿å»ºè®®", chip_list:"ä»Šæ—¥å¾…åŠ", chip_30d:"30å¤©ç»ƒä¹ "
    },
    "en": {
      page_title:"Bazi Â· 5XLiving",
      lang_label:"Language", title_bazi_brief:"Bazi Quick Reading",
      title_quickcalc:"Bazi Â· Quick Chart",
      label_name:"Name (optional)", ph_name:"Your name (for personalization)",
      gender_label:"Gender", label_calendar:"Calendar",
      label_birthdate:"Birth Date", label_birthtime:"Birth Time",
      opt_gender_confidential:"Prefer not to say", opt_gender_male:"Male", opt_gender_female:"Female",
      opt_cal_gregorian:"Gregorian", opt_cal_lunar:"Lunar",
      cb_time_unknown:"Birth time unknown", btn_generate_chart:"Generate Chart",
      rpt_free_title:"Free Summary", rpt_pillars_label:"Pillars",
      rpt_daymaster_label:"Day Master", rpt_season_label:"Season",
      rpt_chart_label:"Chart", rpt_wuxing_label:"Five Elements",
      rpt_time_hint:"Note: birth time unknown; hour pillar excludedâ€”reference only.",
      rpt_time_unknown:"Unknown time", rpt_fav_avoid_template:"Favorable: {fav} | Avoid: {avoid}",
      rpt_sec_overview_title:"1) Overview", rpt_sec_elements_title:"2) Element Analysis",
      rpt_chart_title:"Your Bazi Chart",
      rpt_balance_focus_label:"Balance focus", rpt_strongest_word:"strongest", rpt_weakest_word:"weakest",
      rpt_absent_prefix:"Absent: ", elements_balance_tpl:"Strongest: {max} Â· Weakest: {min}",
      butler_title:"Xinlian Butler Â· Insight",
      el_wood:"Wood", el_fire:"Fire", el_earth:"Earth", el_metal:"Metal", el_water:"Water",
      vip_title:"ğŸŒ™ VIP Segment", vip_mingli:"ğŸ— Astro-only Content", vip_xinlian:"ğŸŒ™ Xinlian-only Content",
      vip_love:"Love & Marriage", vip_career:"Career & Entrepreneurship",
      vip_wealth:"Wealth & Timing", vip_pet:"Pet Destiny",
      vip_hepan:"Synastry / Date Picking", vip_name:"Name Analysis (Co/Baby)",
      vip_fengshui:"Wealth/Feng Shui Alignment", vip_record:"Spiritual Records",
      vip_course:"Courses: Bazi/Tarot/Astrology/Numerology/HD", vip_memorial:"Family Memorial",
      vip_tasks:"Weekly Practice / Rituals", vip_shop:"Shop Discounts & Amulets",
      login_title:"ğŸ’ Log in for VIP", panel_login_head:"Account Login / Sign-up", panel_member_head:"Membership",
      btn_login:"Log In", btn_reset:"ğŸ”‘ Reset Password", btn_register:"Create Account", btn_upgrade:"ğŸ’ Upgrade to VIP (Monthly)",
      btn_backshop:"â† Back to Shop", note_price:"Sign-up bonus: one free try", note_price1:"$9.9 / month VIP (Astro + Xinlian + Courses)",
      ph_email:"Email", ph_password:"Password (min 8 chars incl. cases, number, symbol)",
      q_career:"Using my Baziâ€¦ practical career advice.",
      q_love:"Using my Baziâ€¦ relationship/marriage advice.",
      q_money:"Using my Baziâ€¦ 6-month wealth advice.",
      q_list:"Based on my Baziâ€¦ today's 3â€“5 to-dos.",
      q_30d:"Using my weakest elementâ€¦ 30-day micro-habit plan.",
      chip_career:"Career", chip_love:"Love", chip_money:"Wealth", chip_list:"Toâ€‘dos", chip_30d:"30â€‘day Plan"
    },
    "ms": {
      page_title:"Bazi Â· 5XLiving",
      lang_label:"Bahasa", title_bazi_brief:"Bacaan Bazi Ringkas",
      title_quickcalc:"Bazi Â· Carta Pantas",
      label_name:"Nama (pilihan)", ph_name:"Nama anda (untuk peribadi)",
      gender_label:"Jantina", label_calendar:"Kalendar",
      label_birthdate:"Tarikh Lahir", label_birthtime:"Masa Lahir",
      opt_gender_confidential:"Tidak mahu nyatakan", opt_gender_male:"Lelaki", opt_gender_female:"Perempuan",
      opt_cal_gregorian:"Gregorian", opt_cal_lunar:"Lunar",
      cb_time_unknown:"Masa lahir tidak pasti", btn_generate_chart:"Jana Carta",
      rpt_free_title:"Ringkasan Percuma", rpt_pillars_label:"Tiang",
      rpt_daymaster_label:"Day Master", rpt_season_label:"Musim",
      rpt_chart_label:"Carta", rpt_wuxing_label:"Lima Unsur",
      rpt_time_hint:"Nota: masa lahir tidak pasti; tiang jam dikecualikan.",
      rpt_time_unknown:"Tidak pasti", rpt_fav_avoid_template:"Baik: {fav} | Elak: {avoid}",
      rpt_sec_overview_title:"1) Gambaran Umum", rpt_sec_elements_title:"2) Analisis Unsur",
      rpt_chart_title:"Carta Bazi Anda",
      rpt_balance_focus_label:"Fokus imbangan", rpt_strongest_word:"terkuat", rpt_weakest_word:"terlemah",
      rpt_absent_prefix:"Tiada: ", elements_balance_tpl:"Terkuat: {max} Â· Terlemah: {min}",
      butler_title:"Xinlian Butler Â· Panduan",
      el_wood:"Kayu", el_fire:"Api", el_earth:"Tanah", el_metal:"Logam", el_water:"Air",
      vip_title:"ğŸŒ™ Segmen VIP", vip_mingli:"ğŸ— Kandungan Astro Eksklusif", vip_xinlian:"ğŸŒ™ Kandungan Xinlian Eksklusif",
      vip_love:"Cinta & Perkahwinan", vip_career:"Kerjaya & Usahawan",
      vip_wealth:"Kekayaan & Pemasa", vip_pet:"Nasib Haiwan Peliharaan",
      vip_hepan:"Keserasian / Pilih Tarikh", vip_name:"Analisis Nama (Syarikat/Bayi)",
      vip_fengshui:"Keseimbangan Feng Shui", vip_record:"Rekod Rohani",
      vip_course:"Kursus: Bazi/Tarot/Astrologi/Numerologi/HD", vip_memorial:"Memorial Keluarga",
      vip_tasks:"Amalan Mingguan / Ritual", vip_shop:"Diskaun Kedai & Azimat",
      login_title:"ğŸ’ Log masuk untuk VIP", panel_login_head:"Log Masuk / Daftar", panel_member_head:"Keahlian",
      btn_login:"Log Masuk", btn_reset:"ğŸ”‘ Tetap Semula Kata Laluan", btn_register:"Daftar Akaun", btn_upgrade:"ğŸ’ Naik Taraf ke VIP (Bulanan)",
      btn_backshop:"â† Kembali ke Kedai", note_price:"Daftar: 1 percubaan percuma", note_price1:"$9.9 / bulan VIP (Astro + Xinlian + Kursus)",
      ph_email:"E-mel", ph_password:"Kata laluan (â‰¥8 aksara, huruf besar/kecil, nombor, simbol)",
      q_career:"Guna Bazi sayaâ€¦ nasihat kerjaya praktikal.",
      q_love:"Guna Bazi sayaâ€¦ nasihat hubungan/perkahwinan.",
      q_money:"Guna Bazi sayaâ€¦ nasihat kekayaan 6 bulan.",
      q_list:"Berdasarkan Bazi sayaâ€¦ 3â€“5 tugasan hari ini.",
      q_30d:"Guna unsur terlemah sayaâ€¦ pelan tabiat 30 hari.",
      chip_career:"Kerjaya", chip_love:"Cinta", chip_money:"Kekayaan", chip_list:"Tugasan", chip_30d:"Pelan 30 Hari"
    }
  };
}

function t(key){ const L = translations[getLang()] || translations["zh-CN"]; return L[key] || (translations["zh-CN"][key] || key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{ const key = el.getAttribute("data-i18n"); el.textContent = t(key); });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{ const key = el.getAttribute("data-i18n-ph"); const val=t(key); if(val && val!==key) el.setAttribute("placeholder", val); });
  const titleEl = document.querySelector("title[data-i18n]"); if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
function ELABEL(){ return { wood:t('el_wood'), fire:t('el_fire'), earth:t('el_earth'), metal:t('el_metal'), water:t('el_water') }; }

/* ================== Butler AI å¡ç‰‡ ================== */
(function injectAiStyle(){
  const old=document.getElementById('ai-style'); if(old) old.remove();
  const style=document.createElement('style'); style.id='ai-style';
  style.textContent=`
    .sec h3{margin:0 0 8px;color:var(--brand)}
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  `;
  document.head.appendChild(style);
})();

function mdToHtml(md){
  return (md||'')
    .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
    .replace(/^\s*[-*]\s+(.*)$/gm,'â€¢ $1')
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    .replace(/\n{2,}/g,'\n\n')
    .replace(/\n/g,'<br/>');
}
function isVIP(){ return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail'); }

function ensureAiCard(){
  const target = document.getElementById('rich-report') || document.getElementById('result');
  if (!target) return;
  let card = document.getElementById('aiCard');
  if (card) { if (card.parentElement !== target) target.appendChild(card); return; }
  const sec = document.createElement('div');
  sec.className = 'sec';
  sec.id = 'aiCard';
  sec.innerHTML = `
    <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')||'å¿ƒæ€œç®¡å®¶ Â· è§£è¯»'}</h3>
    <div id="aiContent" class="ai-content">
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>
    </div>
    <div class="chips" id="aiChips"></div>
  `;
  target.appendChild(sec);
  renderChips();
}
function renderChips(){
  const wrap=document.getElementById('aiChips'); if(!wrap) return;
  wrap.innerHTML='';
  [
    {k:'chip_career',q:'q_career'},
    {k:'chip_love',  q:'q_love'},
    {k:'chip_money', q:'q_money'},
    {k:'chip_list',  q:'q_list'},
    {k:'chip_30d',   q:'q_30d'}
  ].forEach(it=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=t(it.k);
    btn.setAttribute('data-q', t(it.q));
    wrap.appendChild(btn);
  });
}

const BUTLER_LANG_NAME = { 'zh-CN':'Simplified Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay' };
function buildButlerSystemPrompt(lang){
  const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
  return [
    `You are a concise Bazi assistant. Reply in ${ln}.`,
    `- Use short paragraphs and bullet points; be concrete and actionable.`,
    `- If hour pillar is missing, include a brief caution.`,
    `- Avoid deterministic predictions; frame as tendencies and practical tips.`,
    `- Mirror the user's language tone (polite, warm).`
  ].join('\n');
}
function buildUserPrompt(topic, ctx){
  const {pillars, percents, st, adv, timeUnknown} = ctx || {};
  const ln = BUTLER_LANG_NAME[(getLang && getLang()) || 'zh-CN'] || 'Simplified Chinese';
  const E = ELABEL();
  const elemLine = ['wood','fire','earth','metal','water'].map(k=>`${E[k]} ${Math.round((percents||{})[k]||0)}%`).join(' Â· ');
  const fav   = (adv?.useful||[]).join('/'); const avoid = (adv?.avoid ||[]).join('/');
  const hourTxt = timeUnknown ? t('rpt_time_unknown') : ((pillars?.hour?.stem||'') + (pillars?.hour?.branch||''));
  const lines = [
    `Bazi summary:`,
    `Year ${pillars?.year?.stem||''}${pillars?.year?.branch||''} Â· Month ${pillars?.month?.stem||''}${pillars?.month?.branch||''} Â· Day ${pillars?.day?.stem||''}${pillars?.day?.branch||''} Â· Hour ${hourTxt||''}`,
    `Day Master: ${pillars?.day?.stem||''} (${pillars?.day?.element||''})`,
    `Season: ${st?.season||''}; Strength: ${st?.mark||''}; Strategy: ${st?.focus||''}`,
    `Elements: ${elemLine}`,
    `Favorable: ${fav||'-'}; Avoid: ${avoid||'-'}`,
    timeUnknown ? `Caution: hour pillar excluded.` : ``,
    ``,
    `Task: ${topic}`,
    `Language: ${ln}. Reply ONLY in ${ln}.`
  ].filter(Boolean);
  return lines.join('\n');
}

async function askAi(topic){
  ensureAiCard();
  const card = document.getElementById('aiCard');
  if (card) { card.dataset.lastQ = topic; card.dataset.lang = (getLang && getLang()) || 'zh-CN'; }

  const out = document.getElementById('aiContent');
  if (out) out.innerHTML = `
    <div class="skeleton">
      <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
      <div style="width:70%"></div><div style="width:50%"></div>
    </div>`;

  try{
    const ctx  = window.__last_report__ || {};
    const lang = (getLang && getLang()) || 'zh-CN';
    const sys  = buildButlerSystemPrompt(lang);
    const user = buildUserPrompt(topic, ctx);

    const data = await fetchJSON('/api/chat', {
      messages: [ { role:'system', content: sys }, { role:'user', content: user } ]
    }, { timeout: 12000 });

    let text = '';
    if (data && data.ok !== false) {
      text = data.reply || data.text || data?.choices?.[0]?.message?.content || '';
    } else {
      console.warn('chat api error:', data);
      text = (getLang && getLang()).startsWith('zh')
        ? 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼ˆç½‘ç»œæˆ–ä¸Šæ¸¸ 5xxï¼‰ã€‚ç»§ç»­çœ‹å…è´¹æŠ¥å‘Šä¸å—å½±å“ã€‚'
        : 'AI service temporarily unavailable (network or 5xx). Free report still works.';
    }
    if(!text){ text = lang.startsWith('zh') ? 'æŠ±æ­‰ï¼Œæš‚æ—¶æ²¡æœ‰ç”Ÿæˆåˆ°å†…å®¹ï¼Œè¯·ç¨åå†è¯•ã€‚' : 'Sorry, no content generated. Please try again.'; }

    if (out){
      if(!isVIP()){
        const teaser = text.split('\n').slice(0,6).join('\n');
        out.innerHTML = mdToHtml(teaser) + `
          <div class="ai-lock-overlay">
            <div class="tip">ğŸ’ ${t('vip_title') || 'VIP Segment'}</div>
            <div class="sub">${ (getLang()||'zh-CN').startsWith('zh') ? 'ç™»å½•/å‡çº§åè§£é”å®Œæ•´è§£è¯»' : 'Log in / upgrade to unlock the full guidance.' }</div>
          </div>`;
      }else{
        out.innerHTML = mdToHtml(text);
      }
    }
  }catch(e){
    console.error('askAi error:', e);
    if(out){
      out.innerHTML = (getLang && getLang()).startsWith('zh')
        ? 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡ç¹å¿™ï¼ˆä¾‹å¦‚ 502ï¼‰ã€‚è¯·ç¨åé‡è¯•ã€‚'
        : 'Network error or service busy (e.g., 502). Please try again later.';
    }
  }
}

/* ================== æŠ¥å‘Šå‡½æ•°ï¼ˆå…œåº•ï¼‰ ================== */
if (typeof window.buildFreeReportHTML !== 'function') {
  window.buildFreeReportHTML = function({ pillars, percents, st, adv, timeUnknown } = {}) {
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const E = ELABEL(); const p = percents || {};
    const ym = `${esc(pillars?.year?.stem||'')}${esc(pillars?.year?.branch||'')}`;
    const mm = `${esc(pillars?.month?.stem||'')}${esc(pillars?.month?.branch||'')}`;
    const dm = `${esc(pillars?.day?.stem||'')}${esc(pillars?.day?.branch||'')}`;
    const hm = timeUnknown ? t('rpt_time_unknown') : `${esc(pillars?.hour?.stem||'')}${esc(pillars?.hour?.branch||'')}`;
    const fav=(adv?.useful||[]).join('/'), avoid=(adv?.avoid||[]).join('/');
    return `
      <div class="card">
        <div class="h2">${esc(t('rpt_free_title'))}</div>
        <div>${esc(t('rpt_pillars_label'))}ï¼š${ym}ï½œ${mm}ï½œ${dm}ï½œ${hm}</div>
        <div>${esc(t('rpt_daymaster_label'))}ï¼š${esc(pillars?.day?.stem||'')}ï¼ˆ${esc(pillars?.day?.element||'')}ï¼‰</div>
        <div>${esc(t('rpt_season_label'))}ï¼š${esc(st?.season||'-')} ï½œ ${esc(t('rpt_chart_label'))}ï¼š${esc(st?.mark||'-')}</div>
        <div style="margin-top:8px">${esc(t('rpt_wuxing_label'))}ï¼š${E.wood} ${Math.round(p.wood||0)}% Â· ${E.fire} ${Math.round(p.fire||0)}% Â· ${E.earth} ${Math.round(p.earth||0)}% Â· ${E.metal} ${Math.round(p.metal||0)}% Â· ${E.water} ${Math.round(p.water||0)}%</div>
        ${timeUnknown ? `<div class="muted" style="margin-top:6px">${esc(t('rpt_time_hint'))}</div>` : ''}
        <div style="margin-top:8px">${esc(t('rpt_fav_avoid_template').replace('{fav}', fav||'-').replace('{avoid}', avoid||'-'))}</div>
      </div>`;
  };
}
if (typeof window.buildRichReportHTML !== 'function') {
  window.buildRichReportHTML = function({ pillars, percents, st, adv, timeUnknown } = {}) {
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const E = ELABEL(); const p = percents || {};
    const kv = [[E.wood,p.wood||0],[E.fire,p.fire||0],[E.earth,p.earth||0],[E.metal,p.metal||0],[E.water,p.water||0]];
    const strongest = kv.reduce((a,b)=> a[1]>=b[1]?a:b)[0];
    const weakest   = kv.reduce((a,b)=> a[1]<=b[1]?a:b)[0];
    const absent    = kv.filter(([,v])=>Math.round(v)===0).map(([k])=>k);
    const ym = `${esc(pillars?.year?.stem||'')}${esc(pillars?.year?.branch||'')}`;
    const mm = `${esc(pillars?.month?.stem||'')}${esc(pillars?.month?.branch||'')}`;
    const dm = `${esc(pillars?.day?.stem||'')}${esc(pillars?.day?.branch||'')}`;
    const hm = timeUnknown ? t('rpt_time_unknown') : `${esc(pillars?.hour?.stem||'')}${esc(pillars?.hour?.branch||'')}`;
    const fav=(adv?.useful||[]).join('/'), avoid=(adv?.avoid||[]).join('/');
    const sec=(title,body)=>`<div class="sec"><h3>${esc(title)}</h3><div class="ai-content">${body}</div></div>`;
    const bullet = arr => (arr||[]).map(x=>`â€¢ ${esc(x)}`).join('<br>');
    return [
      sec(t('rpt_sec_overview_title'),
        `${esc(t('rpt_pillars_label'))}ï¼š${ym}ï½œ${mm}ï½œ${dm}ï½œ${hm}<br>`+
        `${esc(t('rpt_daymaster_label'))}ï¼š${esc(pillars?.day?.stem||'')}ï¼ˆ${esc(pillars?.day?.element||'')}ï¼‰<br>`+
        `${esc(t('rpt_season_label'))}ï¼š${esc(st?.season||'-')} ï½œ ${esc(t('rpt_chart_label'))}ï¼š${esc(st?.mark||'-')}`+
        (timeUnknown?`<br><span class="muted">${esc(t('rpt_time_hint'))}</span>`:'')
      ),
      sec(t('rpt_sec_elements_title'),
        `${E.wood} ${Math.round(p.wood||0)}% Â· ${E.fire} ${Math.round(p.fire||0)}% Â· ${E.earth} ${Math.round(p.earth||0)}% Â· ${E.metal} ${Math.round(p.metal||0)}% Â· ${E.water} ${Math.round(p.water||0)}%<br>`+
        `${esc(t('rpt_balance_focus_label'))}ï¼š${esc(strongest)} ${esc(t('rpt_strongest_word'))}ï¼Œ${esc(weakest)} ${esc(t('rpt_weakest_word'))}`+
        (absent.length?`ï¼Œ${esc(t('rpt_absent_prefix'))}${esc(absent.join('/'))}`:'')
      ),
      sec('â€¦â€¦ï¼ˆå¯æŒ‰éœ€æ‰©å±• VIP å…¨æ–‡ï¼‰', bullet([]))
    ].join('');
  };
}

/* ================== å…«å­—è®¡ç®—å™¨ ================== */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC=['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'}; const b={å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; }
  getBranchElement(branch){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='ï¼Ÿ')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='ï¼Ÿ')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['æœ¨']/total*100,fire:cnt['ç«']/total*100,earth:cnt['åœŸ']/total*100,metal:cnt['é‡‘']/total*100,water:cnt['æ°´']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

/* ================== è§„åˆ™/æ¸²æŸ“ ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='æ—¶æŸ±'&&timeUnknown); const stem=u?'ï¼Ÿ':v.stem,branch=u?'ï¼Ÿ':v.branch;
    const div=document.createElement('div'); div.className='pillar'; div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`; root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem); setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);
  const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'æœªçŸ¥':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'æœªçŸ¥':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan,monthZhi,cnt){
  const STEM_ELEM={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH={å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='æ˜¥'&&'æœ¨ç«'.includes(dmEl))||(season==='å¤'&&'ç«åœŸ'.includes(dmEl))||(season==='ç§‹'&&dmEl==='é‡‘')||(season==='å†¬'&&dmEl==='æ°´')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'åå¼º':(score<=1?'åå¼±':'å¹³è¡¡');
  const focus=mark==='åå¼º'?'æ³„ç§€/åˆ¶åŒ–':(mark==='åå¼±'?'è¡¥åŠ©/é¡ºåŠ¿':'å®ˆä¸­/è°ƒå’Œ');
  return{season,mark,focus};
}
function chooseUseful(strength,dmElem){
  if(strength==='åå¼º') return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful:({æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']})[dmElem], avoid:[dmElem]};
  if(strength==='åå¼±') return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:({æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']})[dmElem], avoid:[]};
  return {strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}

/* ================== ç»“æœæŒ‚è½½ ================== */
function mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown}){
  const resultEl = document.getElementById('result'); if (!resultEl) return;
  let freeNode = document.getElementById('xl-free-report');
  if (!freeNode) { freeNode = document.createElement('div'); freeNode.id = 'xl-free-report'; resultEl.appendChild(freeNode); }
  freeNode.innerHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown});
}
function mountButlerCard(){ ensureAiCard(); const aiCard = document.getElementById('aiCard'); if (aiCard && !aiCard.dataset.autorun) { aiCard.dataset.autorun = '1'; askAi(t('q_career')); } }

/* ================== ä¼°æ—¶é—´å¼¹çª— ================== */
function initTimeWindow(){
  const grid = $('twGrid'), apply=$('twApply'), mask=$('twMask'), cancel=$('twCancel');
  if(!grid || !apply || !mask || !cancel) return;
  const slots=[ ['å­','23:30'],['ä¸‘','01:30'],['å¯…','03:30'],['å¯','05:30'], ['è¾°','07:30'],['å·³','09:30'],['åˆ','11:30'],['æœª','13:30'], ['ç”³','15:30'],['é…‰','17:30'],['æˆŒ','19:30'],['äº¥','21:30'] ];
  grid.innerHTML=''; let picked=null;
  slots.forEach(([z,mid])=>{
    const btn=document.createElement('button');
    btn.type='button'; btn.className='tw-btn'; btn.textContent=z+'æ—¶æ®µ';
    btn.onclick=()=>{ grid.querySelectorAll('.tw-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); picked=mid; apply.disabled=false; };
    grid.appendChild(btn);
  });
  cancel.onclick=()=>{ mask.style.display='none'; };
  apply.onclick=()=>{
    if(!picked) return;
    const timeInput = $('birthtime'); if(timeInput){ timeInput.value=picked; timeInput.disabled=false; timeInput.style.opacity=1; }
    const cb = $('timeUnknown'); if(cb){ cb.checked=false; }
    mask.style.display='none';
  };
}

/* ================== ç”Ÿæˆå‘½ç›˜ ================== */
async function genChart(){
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  if (!birth){ showErr(t('label_birthdate')+ 'ï¼š' + (getLang().startsWith('en')?'required':'è¯·å¡«å†™')); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled = true; if(tx) tx.style.display = 'none'; if(ld) ld.style.display = 'inline-block';

  try{
    const [Y,M,D] = birth.split('-').map(Number);
    let hour = 12;
    if (!timeUnknown){
      const t = ($('birthtime')?.value || '').trim();
      if (t){ const h = parseInt(t.split(':')[0], 10); if (!Number.isNaN(h)) hour = h; }
    }

    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);

    $('result')?.style.setProperty('display','block');
    const timeText = tu ? t('rpt_time_unknown') : (hour + 'æ—¶');
    setText('bazi-date', `${t('label_birthdate')}: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if (tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span class="badge-warn">' + t('rpt_time_hint') + '</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('bar-æœ¨'), percents.wood);  setText('pct-æœ¨',  Math.round(percents.wood)  + '%');
    setBar($('bar-ç«'), percents.fire);  setText('pct-ç«',  Math.round(percents.fire)  + '%');
    setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ',  Math.round(percents.earth) + '%');
    setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘',  Math.round(percents.metal) + '%');
    setBar($('bar-æ°´'), percents.water); setText('pct-æ°´',  Math.round(percents.water) + '%');

    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);

    { // æœ€å¼º/æœ€å¼±æç¤º
      const keys = Object.keys(counts);
      const maxK = keys.reduce((a,b)=> counts[a] > counts[b] ? a : b);
      const minK = keys.reduce((a,b)=> counts[a] < counts[b] ? a : b);
      const E = ELABEL();
      const char2Locale = { æœ¨: E.wood, ç«: E.fire, åœŸ: E.earth, é‡‘: E.metal, æ°´: E.water };
      setText('bazi-elements-balance', t('elements_balance_tpl').replace('{max}', char2Locale[maxK]).replace('{min}', char2Locale[minK]));
    }

    window.__last_report__ = { pillars, percents, st, adv, timeUnknown: tu };
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });
    mountButlerCard();

    console.log('å®é™… â†’', pillars.year.stem+pillars.year.branch, pillars.month.stem+pillars.month.branch, pillars.day.stem+pillars.day.branch, tu ? 'ï¼Ÿ' : (pillars.hour.stem+pillars.hour.branch));

  } catch (err){ console.error(err); showErr((getLang().startsWith('en')?'Error: ':'') + 'è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•'); }
  finally { if(btn) btn.disabled = false; if(tx) tx.style.display = 'inline'; if(ld) ld.style.display = 'none'; }
}

/* ================== äº‹ä»¶ç»‘å®š & å¯åŠ¨ ================== */
addEventListener('click', (e)=>{ const el = e.target; if(el && el.classList.contains('chip')){ const q = el.getAttribute('data-q') || ''; if(q) askAi(q); } });

function bindUI(){
  $('genBtn')?.addEventListener('click', genChart);

  $('timeUnknown')?.addEventListener('change', e=>{
    const v=e.target.checked; const ti=$('birthtime'); if(ti){ ti.disabled=v; ti.style.opacity=v?0.6:1; }
    if (v){ const mask=$('twMask'); if(mask) mask.style.display='flex'; }
  });

  $('langSelect')?.addEventListener('change', e=>{
    setLang(e.target.value); applyI18n();
    const titleEl = document.getElementById('butlerTitle'); if (titleEl) titleEl.textContent = t('butler_title');
    renderChips();
    const aiCard = document.getElementById('aiCard'); const lastQ  = (aiCard && aiCard.dataset.lastQ) || t('q_career');
    if (aiCard){ const oldLang = aiCard.dataset.lang || 'zh-CN'; const newLang = (getLang && getLang()) || 'zh-CN'; if (oldLang !== newLang){ aiCard.dataset.lang = newLang; askAi(lastQ); } }
  });

  initTimeWindow();
}

(function bootstrap(){ try{ setLang(getLang()); }catch{} applyI18n(); bindUI(); })();

/* ================== è‡ªæµ‹ï¼š1978-02-21 12:00 â†’ æˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ ================== */
(function(){ const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12); console.log('åº”ä¸º â†’ å¹´ æˆŠåˆï½œæœˆ ç”²å¯…ï½œæ—¥ ç”²å¯…ï½œæ—¶ åºšåˆ'); console.log('å®é™… â†’', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch); })();
</script>
</body>
</html>
