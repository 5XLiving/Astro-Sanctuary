<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ï¼Œä¸€ç«™å¼çµæ€§ä¸å‘½ç†ä½“éªŒã€‚">
  <meta property="og:title" content="å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary">
  <meta property="og:description" content="å…è´¹ä½“éªŒåŒºä¸VIPä¸“åŒºï¼šå…«å­—ã€å æ˜Ÿã€çµæ•°ã€å¡”ç½—ã€ä¹æ˜Ÿæ°”å­¦ã€èƒ½é‡ç±»å‹ç­‰ã€‚">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dCC; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4; --muted:#9aa3b2;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22); --radius:14px;
  }
    html,body{height:100%} 
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} } 
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6}
.container{max-width:1060px;margin:0 auto;padding:24px 16px 64px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
.h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
.h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
.muted{color:var(--muted)}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
.bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
.badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
#gpt-drawer { display:block !important; }
#gpt-drawer[hidden] { display:block !important; }
#gpt-drawer > summary { display:block; cursor:pointer; }
   /* è¯­è¨€é€‰æ‹©å™¨ */
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{color:var(--muted); font-size:.9rem}
  .lang select{
    appearance:none; border-radius:10px; border:1px solid #243244; background:#0e1520; color:var(--text);
    padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== æŒ‰é’®ç»Ÿä¸€æˆé«˜ç«¯äº®é‡‘ ===== */
  .btn,
  .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:13px 16px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:600; letter-spacing:.3px;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover,
  .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Ghost æŒ‰é’®ä¿æŒè¾…åŠ©é£æ ¼ */
  .btn.ghost{
    background:transparent; color:var(--gold2);
    border:1px solid rgba(212,175,55,.45); box-shadow:none;
  }

  /* block æŒ‰é’® */
  .btn.block {
    display: block;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .row.one .btn.block { display: block !important; }
  .panel .body .btn.block { margin-left:auto; margin-right:auto; }

  /* Chat æµ®çª—æŒ‰é’®ä¹Ÿæ¢æˆäº®é‡‘ */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== æ— éšœç¢éšè—æ–‡å­— ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
  .astro-auth{ max-width: 980px; margin: 28px auto; padding: 20px 18px;
    background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
    border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 18px 50px rgba(0,0,0,.35); }
  .auth-grid{ display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; }
  @media (max-width: 860px){ .auth-grid{ grid-template-columns: 1fr; } }
  .panel{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .panel .head{ padding:16px 18px; border-bottom:1px solid var(--border);
    color:var(--gold); font-weight:700; letter-spacing:.3px; }
  .panel .body{ padding:18px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row.one{ grid-template-columns: 1fr; }
  .row.center{ align-items:center; }
  @media (max-width:640px){ .row{ grid-template-columns: 1fr; } }
  .astro-auth input[type="email"], .astro-auth input[type="password"]{
    width:100%; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:10px;
    padding:13px 12px; outline:none; transition:.18s;
  }
  .astro-auth input:focus{ border-color:var(--gold2); box-shadow:0 0 0 3px rgba(212,175,55,.2); }
  .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
  .error{ color:#ffb4b4; background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25);
          padding:10px 12px; border-radius:10px; }
  .spacer{ height:12px; }
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">å‘½ç†ä¾›é—¨ Â· å…«å­—ç®€è¯„</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰">
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender"><option value="">ä¸é€éœ²</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar"><option value="gregorian">é˜³å† / Gregorian</option><option value="lunar">å†œå† / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> å‡ºç”Ÿæ—¶é—´ä¸è¯¦</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

      <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

<!-- ç™»å½•/æ³¨å†Œè¡¨å•ï¼Œæ”¯æŒå›è½¦æäº¤ -->
<section class="astro-auth">
  <div class="auth-grid">
    <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
    <div class="panel">
      <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
      <div class="body">
        <!-- ç‹¬ç«‹è¾“å…¥åŒºï¼ˆç™»å½•/æ³¨å†Œå…±äº«è¿™äº›è¾“å…¥ï¼‰ -->
        <div class="row" id="authFields">
          <label for="email" class="sr-only">Email</label>
          <input
            id="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            placeholder="é‚®ç®± Email"
            data-i18n-ph="ph_email"
            required
          />

          <input
            id="password"
            type="password"
            autocomplete="new-password"
            placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
            data-i18n-ph="ph_password"
            required
           />
        </div>

        <div class="spacer"></div>

        <!-- ç™»å½•è¡¨å•ï¼ˆå¤ç”¨ä¸Šæ–¹ä¸¤æ ¼è¾“å…¥ï¼‰ -->
        <form id="loginForm" class="row one">
          <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
        </form>

        <div class="spacer"></div>

        <!-- é‡è®¾å¯†ç ï¼ˆæŒ‰é’®éæäº¤ï¼‰ -->
        <div class="row one">
          <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
        </div>

        <div class="spacer"></div>

        <!-- æ³¨å†Œè¡¨å•ï¼ˆå¤ç”¨ä¸Šæ–¹ä¸¤æ ¼è¾“å…¥ï¼‰ -->
        <form class="row one" id="registerForm">
          <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
        
        <div class="muted" data-i18n="note_price">
        æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ
        </div>  

        <div class="spacer"></div>

        <div class="error" id="error" style="display:none"></div>
      </div>
    </div>
    </form>
    
    <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
    <div class="panel">
      <div class="head">ä¼šå‘˜æœåŠ¡</div>
      <div class="body">
        <div class="row one">
          <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
        </div>

        <div class="spacer"></div>

        <div class="row one">
          <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
        </div>

        <div class="spacer"></div>
        <div class="muted" data-i18n="note_price1">
          $9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰
        </div>
      </div>
    </div>
  </div>
</section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

  <!-- åŠŸèƒ½è„šæœ¬ï¼šåç«¯ä»£ç† + å¤šè¯­è¨€ + Chat æµ®çª— -->
<script>
  // ============== ç»Ÿä¸€é…ç½®ï¼ˆä½ çš„ Worker åŸŸåï¼‰ ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // â† æ”¹æˆä½ çš„ Workers.dev

  // å·¥å…·å‡½æ•°
  const $ = id => document.getElementById(id);
  function showErr(msg){ const e=$("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }

  // ============== å¤šè¯­è¨€ ==============
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }

  // ï¼ˆä¿ç•™ä½ åŸæ¥çš„ç¿»è¯‘è¡¨ï¼Œæˆ‘è¿™é‡Œæ˜¯å®Œæ•´ä¸€ä»½ï¼ŒåŒ…å« chat_fab/chat_placeholder/chat_sendï¼‰
  const translations = {
    "zh-CN": {
      page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Index",
      site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary",
      site_subtitle:"å…è´¹ä½“éªŒ & ä¼šå‘˜ä¸“åŒº Â· ç»Ÿä¸€é£æ ¼ç‰ˆ",
      lang_label:"è¯­è¨€",
      free_title:"ğŸŒ€ å…è´¹ä½“éªŒåŒº Free Segment",
      link_bazi:"å…«å­—å‘½ç†åˆ†æ", link_natal:"æœ¬å‘½æ˜Ÿç›˜åˆ†æ", link_life:"çµæ•°åˆ†æ",
      link_tarot:"å¡”ç½—æŒ‡å¼•åˆ†æ", link_kyuusei:"ä¹æ˜Ÿæ°”å­¦åˆ†æ", link_energy:"èƒ½é‡ç±»å‹åˆ†æ", link_vedic:"å°åº¦å‘½ç†å é™€å æ˜Ÿ",
      vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
      vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
      vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
      vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
      vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
      vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
      vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
      vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
      vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
      vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
      vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
      vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
      vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
      vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
      vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
      login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
      ph_email:"é‚®ç®± Email",
      ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
      btn_register:"æ³¨å†Œè´¦æˆ·",
      btn_login:"ç™»å…¥è´¦æˆ·",
      btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
      btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
      btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
      note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
      note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
      err_need_ep:"è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ",
      err_pwd_rule:"å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·",
      err_exists:"æ­¤é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å…¥",
      err_register_fail:"æ³¨å†Œå¤±è´¥ï¼š",
      err_no_account:"è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ",
      err_wrong_pwd:"å¯†ç é”™è¯¯",
      err_expired:"ä¼šå‘˜å·²è¿‡æœŸï¼Œè¯·ç»­è´¹",
      err_login_fail:"ç™»å…¥å¤±è´¥ï¼š",
      prompt_email:"è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š",
      err_email_empty:"é‚®ç®±ä¸èƒ½ä¸ºç©º",
      prompt_newpwd:"è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š",
      err_pwd_empty:"å¯†ç ä¸èƒ½ä¸ºç©º",
      err_reset_fail:"é‡è®¾å¤±è´¥ï¼š",
      msg_reset_ok:"å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚",
      chat_fab:"é—®", chat_placeholder:"è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ï¼šå¦‚ä½•å¼€å§‹å…è´¹ä½“éªŒï¼‰", chat_send:"å‘é€"
    },
    "zh-TW": {
      page_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· Index",
      site_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· Soul Sanctuary",
      site_subtitle:"å…è²»é«”é©— & æœƒå“¡å°ˆå€ Â· çµ±ä¸€é¢¨æ ¼ç‰ˆ",
      lang_label:"èªè¨€",
      free_title:"ğŸŒ€ å…è²»é«”é©—å€ Free Segment",
      link_bazi:"å…«å­—å‘½ç†åˆ†æ", link_natal:"æœ¬å‘½æ˜Ÿç›¤åˆ†æ", link_life:"éˆæ•¸åˆ†æ",
      link_tarot:"å¡”ç¾…æŒ‡å¼•åˆ†æ", link_kyuusei:"ä¹æ˜Ÿæ°£å­¸åˆ†æ", link_energy:"èƒ½é‡é¡å‹åˆ†æ", link_vedic:"å°åº¦å‘½ç†å é™€å æ˜Ÿ",
      vip_title:"ğŸŒ™ æœƒå“¡å€åŸŸ VIP Segment",
      vip_mingli:"ğŸ— å‘½ç†ç©ºé–“å°ˆå±¬å…§å®¹",
      vip_love:"å§»ç·£æ–¹å‘ï¼šæˆ€æ„›ç·£åˆ†ã€å©šå§»èµ°å‹¢",
      vip_career:"äº‹æ¥­æ–¹å‘ï¼šè·å ´ç™¼å±•ã€å‰µæ¥­æ½›åŠ›",
      vip_wealth:"è²¡é‹æ–¹å‘ï¼šè²¡ä½åˆ†æã€ç†è²¡æ™‚æ©Ÿ",
      vip_pet:"å¯µç‰©å‘½ç†ï¼šä¼´ä¾¶å‹•ç‰©çš„æ€§æ ¼èˆ‡ç·£åˆ†",
      vip_hepan:"åˆç›¤åˆ†æï¼šå©šæœŸæ“‡æ—¥ã€æ–°ç”Ÿæ“‡æ™‚",
      vip_name:"æ¸¬ååˆ†æï¼šå…¬å¸åã€å¯¶å¯¶åã€å‘½åæ”¹é‹",
      vip_fengshui:"è²¡ä½åˆç›¤ï¼šä½å®¶ / è¾¦å…¬å®¤å‹•ç·šé…åˆ",
      vip_xinlian:"ğŸŒ™ å¿ƒæ†ç©ºé–“å°ˆå±¬å…§å®¹",
      vip_record:"éˆæ€§è¨˜éŒ„ï¼šç…§ç‰‡ã€å¤¢å¢ƒã€è²éŸ³ã€é¡˜æœ›ç¥ˆç¦±",
      vip_course:"å‘½ç†èª²ç¨‹ï¼šå…«å­— / å¡”ç¾… / å æ˜Ÿ / éˆæ•¸ / äººé¡åœ–",
      vip_memorial:"å®¶æ—ç´€å¿µç³»çµ±ï¼šè¦ªäººéˆæ€§ç´€å¿µ & å»¶çºŒ",
      vip_tasks:"æ¯é€±èƒ½é‡ç·´ç¿’ / ç¥æ˜å„€å¼ä»»å‹™",
      vip_shop:"èƒ½é‡å•†åŸå°ˆå±¬æŠ˜æ‰£ & å¾¡å®ˆè¨‚è£½",
      login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
      ph_email:"é›»å­éƒµä»¶ Email",
      ph_password:"å¯†ç¢¼ Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«æ•¸å­—ç¬¦è™Ÿï¼‰",
      btn_register:"è¨»å†Šå¸³æˆ¶", btn_login:"ç™»å…¥å¸³æˆ¶",
      btn_upgrade:"ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆè²»ï¼‰", btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
      btn_reset:"ğŸ”‘ é‡è¨­å¯†ç¢¼",
      note_price:"è¨»å†Šè´ˆä¸€æ¬¡å…è²»é«”é©—",
      note_price1:"$9.9 / æœˆè²» VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ†ç©ºé–“ + éˆæ€§èª²ç¨‹ï¼‰",
      err_need_ep:"è«‹è¼¸å…¥é›»å­éƒµä»¶èˆ‡å¯†ç¢¼",
      err_pwd_rule:"å¯†ç¢¼è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å°å¯«/æ•¸å­—/ç‰¹æ®Šç¬¦è™Ÿ",
      err_exists:"æ­¤éƒµç®±å·²è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥",
      err_register_fail:"è¨»å†Šå¤±æ•—ï¼š",
      err_no_account:"å¸³æˆ¶ä¸å­˜åœ¨ï¼Œè«‹å…ˆè¨»å†Š",
      err_wrong_pwd:"å¯†ç¢¼éŒ¯èª¤",
      err_expired:"æœƒå“¡å·²éæœŸï¼Œè«‹çºŒè²»",
      err_login_fail:"ç™»å…¥å¤±æ•—ï¼š",
      prompt_email:"è«‹è¼¸å…¥è¨»å†Šéƒµç®±ï¼š",
      err_email_empty:"éƒµç®±ä¸èƒ½ç‚ºç©º",
      prompt_newpwd:"è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«ã€æ•¸å­—ã€ç¬¦è™Ÿï¼‰ï¼š",
      err_pwd_empty:"å¯†ç¢¼ä¸èƒ½ç‚ºç©º",
      err_reset_fail:"é‡è¨­å¤±æ•—ï¼š",
      msg_reset_ok:"å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼Œè«‹ç”¨æ–°å¯†ç¢¼é‡æ–°ç™»å…¥ã€‚",
      chat_fab:"å•", chat_placeholder:"æƒ³äº†è§£ä»€éº¼ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¦‚ä½•é–‹å§‹å…è²»é«”é©—ï¼‰", chat_send:"ç™¼é€"
    },
    "en": {
      page_title:"Soul Sanctuary Â· Index",
      site_title:"Soul Sanctuary",
      site_subtitle:"Free Segment & VIP Area Â· Unified Style",
      lang_label:"Language",
      free_title:"ğŸŒ€ Free Segment",
      link_bazi:"Bazi Reading", link_natal:"Natal Chart", link_life:"Numerology",
      link_tarot:"Tarot Guidance", link_kyuusei:"Nine Star Ki", link_energy:"Energy Type", link_vedic:"Vedic Astrology",
      vip_title:"ğŸŒ™ VIP Segment",
      vip_mingli:"ğŸ— Astro Sanctuary Â· Exclusive",
      vip_love:"Love: Dating Fate, Marriage Trend",
      vip_career:"Career: Workplace, Entrepreneurship",
      vip_wealth:"Wealth: Wealth Position, Timing",
      vip_pet:"Pet Destiny: Temperament & Bond",
      vip_hepan:"Synastry: Wedding Dates, Birthtime",
      vip_name:"Name Reading: Company/Baby/Renaming",
      vip_fengshui:"Wealth & Layout: Home / Office",
      vip_xinlian:"ğŸŒ™ Soul Sanctuary Â· Exclusive",
      vip_record:"Spiritual Logs: Photos, Dreams, Voice, Prayers",
      vip_course:"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family Memorial: Spiritual Archive & Legacy",
      vip_tasks:"Weekly Energy Practices / Divine Ritual Tasks",
      vip_shop:"Store Discounts & Omamori",
      login_title:"ğŸ’ VIP Login",
      ph_email:"Email",
      ph_password:"Password (8+ chars, upper/lower/digit/symbol)",
      btn_register:"Create Account", btn_login:"Log in",
      btn_upgrade:"ğŸ’ Upgrade to VIP (Monthly)", btn_backshop:"â† Back to Store",
      btn_reset:"ğŸ”‘ Reset Password",
      note_price:"New account gets one free trial.",
      note_price1:"$9.9 / month Â· VIP (Astro + Soul + Courses)",
      err_need_ep:"Enter email and password",
      err_pwd_rule:"Password must be 8+ and include upper/lowercase, number, symbol",
      err_exists:"Email already registered. Please log in.",
      err_register_fail:"Registration failed: ",
      err_no_account:"Account not found. Please register first.",
      err_wrong_pwd:"Incorrect password",
      err_expired:"Membership expired. Please renew.",
      err_login_fail:"Login failed: ",
      prompt_email:"Enter your registered email:",
      err_email_empty:"Email cannot be empty",
      prompt_newpwd:"Enter a new password (8+, upper/lower/digit/symbol):",
      err_pwd_empty:"Password cannot be empty",
      err_reset_fail:"Reset failed: ",
      msg_reset_ok:"Password updated. Please log in with the new one.",
      chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., how to start the free trial)", chat_send:"Send"
    },
    "ja": {
      page_title:"ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª Â· Index",
      site_title:"ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª",
      site_subtitle:"ç„¡æ–™ä½“é¨“ & VIP Â· çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³",
      lang_label:"è¨€èª",
      free_title:"ğŸŒ€ ç„¡æ–™ä½“é¨“ã‚¾ãƒ¼ãƒ³",
      link_bazi:"å››æŸ±æ¨å‘½", link_natal:"ãƒã‚¤ã‚¿ãƒ«ãƒãƒ£ãƒ¼ãƒˆ", link_life:"æ•°ç§˜è¡“",
      link_tarot:"ã‚¿ãƒ­ãƒƒãƒˆ", link_kyuusei:"ä¹æ˜Ÿæ°—å­¦", link_energy:"ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¿ã‚¤ãƒ—", link_vedic:"ãƒ´ã‚§ãƒ¼ãƒ‡ã‚£ãƒƒã‚¯å æ˜Ÿè¡“",
      vip_title:"ğŸŒ™ VIP ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ",
      vip_mingli:"ğŸ— å‘½ç†ã‚¨ãƒªã‚¢ Â· é™å®š",
      vip_love:"ç¸çµã³ï¼šæ‹æ„›ãƒ»çµå©šã®æµã‚Œ",
      vip_career:"ä»•äº‹ï¼šè·å ´ãƒ»èµ·æ¥­ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«",
      vip_wealth:"é‡‘é‹ï¼šè²¡ä½ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°",
      vip_pet:"ãƒšãƒƒãƒˆå‘½ç†ï¼šæ€§æ ¼ã¨ã”ç¸",
      vip_hepan:"ç›¸æ€§ï¼šçµå©šæ—¥ãƒ»å‡ºç”£æ™‚åˆ»",
      vip_name:"å‘½åï¼šä¼šç¤¾åãƒ»èµ¤ã¡ã‚ƒã‚“åãƒ»æ”¹å",
      vip_fengshui:"è²¡ä½Ã—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šä½å®… / ã‚ªãƒ•ã‚£ã‚¹",
      vip_xinlian:"ğŸŒ™ å¿ƒæ€œã‚¨ãƒªã‚¢ Â· é™å®š",
      vip_record:"ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«è¨˜éŒ²ï¼šå†™çœŸ/å¤¢/éŸ³å£°/ç¥ˆã‚Š",
      vip_course:"è¬›åº§ï¼šå››æŸ±/ã‚¿ãƒ­ãƒƒãƒˆ/å æ˜Ÿ/æ•°ç§˜/HD",
      vip_memorial:"å®¶æ—ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ï¼šéœŠçš„è¨˜éŒ²ã¨ç¶™æ‰¿",
      vip_tasks:"æ¯é€±ã‚¨ãƒŠã‚¸ãƒ¼ç·´ç¿’ / å„€å¼ã‚¿ã‚¹ã‚¯",
      vip_shop:"ã‚¹ãƒˆã‚¢å‰²å¼• & ãŠå®ˆã‚Š",
      login_title:"ğŸ’ VIP ãƒ­ã‚°ã‚¤ãƒ³",
      ph_email:"ãƒ¡ãƒ¼ãƒ«",
      ph_password:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€å¤§å°è‹±å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ï¼‰",
      btn_register:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ", btn_login:"ãƒ­ã‚°ã‚¤ãƒ³",
      btn_upgrade:"ğŸ’ VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆæœˆé¡ï¼‰", btn_backshop:"â† ã‚¹ãƒˆã‚¢ã¸æˆ»ã‚‹",
      btn_reset:"ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š",
      note_price:"æ–°è¦ç™»éŒ²ã¯1å›ç„¡æ–™ä½“é¨“ã€‚",
      note_price1:"$9.9/æœˆï¼ˆå‘½ç† + å¿ƒæ€œ + è¬›åº§ï¼‰",
      err_need_ep:"ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      err_pwd_rule:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã€å¤§å°è‹±å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚ã¦ãã ã•ã„",
      err_exists:"ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
      err_register_fail:"ç™»éŒ²å¤±æ•—ï¼š",
      err_no_account:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚",
      err_wrong_pwd:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™",
      err_expired:"ä¼šå“¡æœŸé™åˆ‡ã‚Œã€‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚",
      err_login_fail:"ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š",
      prompt_email:"ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š",
      err_email_empty:"ãƒ¡ãƒ¼ãƒ«ã¯å¿…é ˆã§ã™",
      prompt_newpwd:"æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€å¤§å°è‹±å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ï¼‰ï¼š",
      err_pwd_empty:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™",
      err_reset_fail:"å†è¨­å®šå¤±æ•—ï¼š",
      msg_reset_ok:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
      chat_fab:"å•", chat_placeholder:"ä½•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿï¼ˆä¾‹ï¼šç„¡æ–™ä½“é¨“ã®å§‹ã‚æ–¹ï¼‰", chat_send:"é€ä¿¡"
    },
    "th": {
      page_title:"Soul Sanctuary Â· à¸«à¸™à¹‰à¸²à¹à¸£à¸",
      site_title:"Soul Sanctuary",
      site_subtitle:"à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸Ÿà¸£à¸µ & à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ VIP Â· à¸ªà¹„à¸•à¸¥à¹Œà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™",
      lang_label:"à¸ à¸²à¸©à¸²",
      free_title:"ğŸŒ€ à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸—à¸”à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰à¸Ÿà¸£à¸µ",
      link_bazi:"à¸”à¸§à¸‡à¸ˆà¸µà¸™ (Bazi)", link_natal:"à¸”à¸§à¸‡à¸à¸³à¹€à¸™à¸´à¸”", link_life:"à¸•à¸±à¸§à¹€à¸¥à¸‚à¸Šà¸µà¸§à¸´à¸•",
      link_tarot:"à¹„à¸à¹ˆà¸—à¸²à¹‚à¸£à¸•à¹Œ", link_kyuusei:"à¹€à¸à¹‰à¸²à¸”à¸²à¸§à¸„à¸´à¸§à¹€à¸‹", link_energy:"à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸¥à¸±à¸‡à¸‡à¸²à¸™", link_vedic:"à¹‚à¸«à¸£à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸§à¸—",
      vip_title:"ğŸŒ™ à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ VIP",
      vip_mingli:"ğŸ— à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸à¸´à¹€à¸¨à¸© Â· Astro",
      vip_love:"à¸„à¸§à¸²à¸¡à¸£à¸±à¸: à¸„à¸¹à¹ˆà¹à¸—à¹‰/à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¹à¸•à¹ˆà¸‡à¸‡à¸²à¸™",
      vip_career:"à¸à¸²à¸£à¸‡à¸²à¸™: à¸—à¸µà¹ˆà¸—à¸³à¸‡à¸²à¸™/à¸¨à¸±à¸à¸¢à¸ à¸²à¸à¸˜à¸¸à¸£à¸à¸´à¸ˆ",
      vip_wealth:"à¸à¸²à¸£à¹€à¸‡à¸´à¸™: à¸ˆà¸¸à¸”à¹‚à¸Šà¸„à¸¥à¸²à¸ /à¸ˆà¸±à¸‡à¸«à¸§à¸°à¸¥à¸‡à¸—à¸¸à¸™",
      vip_pet:"à¸”à¸§à¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡: à¸™à¸´à¸ªà¸±à¸¢ & à¸ªà¸²à¸¢à¹ƒà¸¢",
      vip_hepan:"à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸à¸±à¸™à¹„à¸”à¹‰: à¸§à¸±à¸™à¹à¸•à¹ˆà¸‡/à¹€à¸§à¸¥à¸²à¸„à¸¥à¸­à¸”",
      vip_name:"à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­: à¸šà¸£à¸´à¸©à¸±à¸—/à¸—à¸²à¸£à¸/à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸·à¹ˆà¸­",
      vip_fengshui:"à¸®à¸§à¸‡à¸ˆà¸¸à¹‰à¸¢à¸à¸²à¸£à¹€à¸‡à¸´à¸™: à¸šà¹‰à¸²à¸™ / à¸ªà¸³à¸™à¸±à¸à¸‡à¸²à¸™",
      vip_xinlian:"ğŸŒ™ à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹€à¸‰à¸à¸²à¸° Â· Soul",
      vip_record:"à¸šà¸±à¸™à¸—à¸¶à¸à¸ˆà¸´à¸•à¸§à¸´à¸à¸à¸²à¸“: à¸£à¸¹à¸›/à¸„à¸§à¸²à¸¡à¸à¸±à¸™/à¹€à¸ªà¸µà¸¢à¸‡/à¸„à¸³à¸­à¸˜à¸´à¸©à¸à¸²à¸™",
      vip_course:"à¸„à¸­à¸£à¹Œà¸ª: Bazi / Tarot / Astrology / Numerology / HD",
      vip_memorial:"à¸­à¸™à¸¸à¸ªà¸£à¸“à¹Œà¸„à¸£à¸­à¸šà¸„à¸£à¸±à¸§: à¸šà¸±à¸™à¸—à¸¶à¸à¸§à¸´à¸à¸à¸²à¸“ & à¸ªà¸·à¸šà¸ªà¸²à¸™",
      vip_tasks:"à¸à¸¶à¸à¸à¸¥à¸±à¸‡à¸‡à¸²à¸™à¸£à¸²à¸¢à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ / à¸à¸´à¸˜à¸µà¸à¸£à¸£à¸¡",
      vip_shop:"à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¸£à¹‰à¸²à¸™à¸„à¹‰à¸² & Omamori",
      login_title:"ğŸ’ à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š VIP",
      ph_email:"à¸­à¸µà¹€à¸¡à¸¥",
      ph_password:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (8+ à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ à¸¡à¸µà¸à¸´à¸¡à¸à¹Œà¹€à¸¥à¹‡à¸/à¹ƒà¸«à¸à¹ˆ à¸•à¸±à¸§à¹€à¸¥à¸‚à¹à¸¥à¸°à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ)",
      btn_register:"à¸ªà¸¡à¸±à¸„à¸£à¸šà¸±à¸à¸Šà¸µ", btn_login:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
      btn_upgrade:"ğŸ’ à¸­à¸±à¸›à¹€à¸à¸£à¸” VIP (à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™)", btn_backshop:"â† à¸à¸¥à¸±à¸šà¸£à¹‰à¸²à¸™à¸„à¹‰à¸²",
      btn_reset:"ğŸ”‘ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™",
      note_price:"à¸ªà¸¡à¸±à¸„à¸£à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸Šà¹‰à¸Ÿà¸£à¸µ 1 à¸„à¸£à¸±à¹‰à¸‡",
      note_price1:"$9.9 / à¹€à¸”à¸·à¸­à¸™ (Astro + Soul + à¸„à¸­à¸£à¹Œà¸ª)",
      err_need_ep:"à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™",
      err_pwd_rule:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸•à¹‰à¸­à¸‡ 8+ à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ à¹à¸¥à¸°à¸¡à¸µà¸à¸´à¸¡à¸à¹Œà¹€à¸¥à¹‡à¸/à¹ƒà¸«à¸à¹ˆ à¸•à¸±à¸§à¹€à¸¥à¸‚ à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ",
      err_exists:"à¸­à¸µà¹€à¸¡à¸¥à¸™à¸µà¹‰à¸¡à¸µà¸šà¸±à¸à¸Šà¸µà¹à¸¥à¹‰à¸§ à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
      err_register_fail:"à¸ªà¸¡à¸±à¸„à¸£à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ",
      err_no_account:"à¹„à¸¡à¹ˆà¸à¸šà¸šà¸±à¸à¸Šà¸µ à¸à¸£à¸¸à¸“à¸²à¸ªà¸¡à¸±à¸„à¸£à¸à¹ˆà¸­à¸™",
      err_wrong_pwd:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡",
      err_expired:"à¸ªà¸¡à¸²à¸Šà¸´à¸à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ à¸à¸£à¸¸à¸“à¸²à¸•à¹ˆà¸­à¸­à¸²à¸¢à¸¸",
      err_login_fail:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ",
      prompt_email:"à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¸—à¸µà¹ˆà¸ªà¸¡à¸±à¸„à¸£:",
      err_email_empty:"à¸­à¸µà¹€à¸¡à¸¥à¸«à¹‰à¸²à¸¡à¸§à¹ˆà¸²à¸‡",
      prompt_newpwd:"à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ (8+, à¸¡à¸µà¸à¸´à¸¡à¸à¹Œà¹€à¸¥à¹‡à¸/à¹ƒà¸«à¸à¹ˆ à¸•à¸±à¸§à¹€à¸¥à¸‚ à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ):",
      err_pwd_empty:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸«à¹‰à¸²à¸¡à¸§à¹ˆà¸²à¸‡",
      err_reset_fail:"à¸£à¸µà¹€à¸‹à¹‡à¸•à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ",
      msg_reset_ok:"à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹à¸¥à¹‰à¸§ à¹‚à¸›à¸£à¸”à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸”à¹‰à¸§à¸¢à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ",
      chat_fab:"à¸–à¸²à¸¡", chat_placeholder:"à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸­à¸°à¹„à¸£ (à¹€à¸Šà¹ˆà¸™ à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸”à¸¥à¸­à¸‡à¸Ÿà¸£à¸µà¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£)", chat_send:"à¸ªà¹ˆà¸‡"
    },
    "ms": {
      page_title:"Soul Sanctuary Â· Indeks",
      site_title:"Soul Sanctuary",
      site_subtitle:"Segmen Percuma & VIP Â· Gaya Bersatu",
      lang_label:"Bahasa",
      free_title:"ğŸŒ€ Segmen Percuma",
      link_bazi:"Bazi", link_natal:"Carta Kelahiran", link_life:"Numerologi",
      link_tarot:"Tarot", link_kyuusei:"Nine Star Ki", link_energy:"Jenis Tenaga", link_vedic:"Astrologi Veda",
      vip_title:"ğŸŒ™ Segmen VIP",
      vip_mingli:"ğŸ— Kandungan Eksklusif Â· Astro",
      vip_love:"Cinta: Jodoh/Lalu lintas perkahwinan",
      vip_career:"Kerjaya: Tempat kerja/Usahawan",
      vip_wealth:"Kewangan: Posisi kekayaan/Masa",
      vip_pet:"Nasib Haiwan: Perangai & Ikatan",
      vip_hepan:"Keserasian: Tarikh nikah/Waktu lahir",
      vip_name:"Nama: Syarikat/Bayi/Pertukaran nama",
      vip_fengshui:"Feng Shui Kekayaan: Rumah / Pejabat",
      vip_xinlian:"ğŸŒ™ Kandungan Eksklusif Â· Soul",
      vip_record:"Log Spirit: Foto, Mimpi, Suara, Doa",
      vip_course:"Kursus: Bazi / Tarot / Astrologi / Numerologi / HD",
      vip_memorial:"Memorial Keluarga: Arkib & Legasi",
      vip_tasks:"Latihan Tenaga Mingguan / Ritual",
      vip_shop:"Diskaun Kedai & Omamori",
      login_title:"ğŸ’ Log Masuk VIP",
      ph_email:"Emel",
      ph_password:"Kata laluan (8+ aksara, huruf besar/kecil, nombor, simbol)",
      btn_register:"Daftar Akaun", btn_login:"Log Masuk",
      btn_upgrade:"ğŸ’ Naik Taraf VIP (Bulanan)", btn_backshop:"â† Kembali ke Kedai",
      btn_reset:"ğŸ”‘ Tetap Semula Kata Laluan",
      note_price:"Akaun baharu percubaan percuma sekali.",
      note_price1:"$9.9 / bulan (Astro + Soul + Kursus).",
      err_need_ep:"Masukkan emel dan kata laluan",
      err_pwd_rule:"Kata laluan mesti 8+ dan ada huruf besar/kecil, nombor, simbol",
      err_exists:"Emel telah didaftarkan. Sila log masuk.",
      err_register_fail:"Pendaftaran gagal: ",
      err_no_account:"Akaun tidak ditemui. Sila daftar dahulu.",
      err_wrong_pwd:"Kata laluan salah",
      err_expired:"Keahlian tamat tempoh. Sila perbaharui.",
      err_login_fail:"Log masuk gagal: ",
      prompt_email:"Masukkan emel berdaftar:",
      err_email_empty:"Emel tidak boleh kosong",
      prompt_newpwd:"Masukkan kata laluan baharu (8+, huruf besar/kecil, nombor, simbol):",
      err_pwd_empty:"Kata laluan tidak boleh kosong",
      err_reset_fail:"Tetap semula gagal: ",
      msg_reset_ok:"Kata laluan dikemas kini. Sila log masuk semula.",
      chat_fab:"Tanya", chat_placeholder:"Anda mahu tahu apa? (cth: cara mula percubaan)", chat_send:"Hantar"
    }
  };

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  // ============== Chat æµ®çª—ï¼ˆèµ° /api/chatï¼‰ ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

// ======================= å…«å­—è®¡ç®—å™¨ï¼ˆä¸æ”¹ç®—æ³•ï¼‰ =======================
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS   = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC           = ['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }
  calculateYearPillar(year) {
    const s = (year - 4) % 10, b = (year - 4) % 12;
    return { stem: this.HEAVENLY_STEMS[(s+10)%10], branch: this.EARTHLY_BRANCHES[(b+12)%12], zodiac: this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y, m, d) {
    const mmdd = m*100 + d;
    const gates = [[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx = 11; for (const [thr,val] of gates) if (mmdd >= thr) idx = val;
    const branchBy = {1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
    return { index: idx, branch: branchBy[idx] };
  }
  calculateMonthPillar(year, month, day) {
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx  = (startMap[yStemIdx] + (index - 1)) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(year, month, day) {
    const baseUTC   = Date.UTC(1900, 0, 31); // ç”²è¾°ï¼ˆè¾°=4ï¼‰
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff   = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx   = (0 + dayDiff) % 10;    // ç”²=0
    const branchIdx = (4 + dayDiff) % 12;    // è¾°=4
    return { stem: this.HEAVENLY_STEMS[(stemIdx+10)%10], branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour) {
    const branchMap = {23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
    const startMap  = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; // æ—¥å¹²â†’å­æ—¶èµ·å¹²
    const dayIdx    = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx   = (startMap[dayIdx] + hourIndex) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch: branchMap[hour] };
  }
  getElement(stem, branch) {
    const s = {'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'};
    const b = {'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
    return `${s[stem]}${b[branch]}`;
  }
  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem), bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si*2 + bi) % this.NAYIN.length];
  }
  getStemElement(stem){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; }
  getBranchElement(branch){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; }
  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP  = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP   = this.calculateDayPillar(year, month, day);
    const hourP  = timeUnknown ? {stem:'ï¼Ÿ', branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = { year:yearP, month:monthP, day:{...dayP, element:dayElement}, hour:hourP };

    const cnt = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    const list = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    list.forEach(p => {
      if (p.stem   && p.stem   !== 'ï¼Ÿ') cnt[this.getStemElement(p.stem)]   += 1;
      if (p.branch && p.branch !== 'ï¼Ÿ') cnt[this.getBranchElement(p.branch)] += 1;
    });
    const total = Object.values(cnt).reduce((a,b)=>a+b,0) || 1;
    const pct = { wood:cnt['æœ¨']/total*100, fire:cnt['ç«']/total*100, earth:cnt['åœŸ']/total*100, metal:cnt['é‡‘']/total*100, water:cnt['æ°´']/total*100 };
    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}
window.baziCalculator = window.baziCalculator || new BaziCalculator();


// ======================= å¿ƒæ€œç®¡å®¶ï¼ˆæ¸²æŸ“å™¨ï¼‰ =======================
class XinLianAssistant {
  constructor(){ this.currentContext=null; }
  generateAnalysis(baziData){
    this.currentContext = baziData;
    const a = document.getElementById('assistant-analysis');
    const b = document.getElementById('assistant-advice');
    if (a) a.innerHTML = this.analyzeBazi(baziData);
    if (b) b.innerHTML = this.generateAdvice(baziData);
  }
  analyzeBazi({dayMaster, elements, strength, season, timeUnknown}){
    const timeNote = timeUnknown
      ? '<li><strong>æ³¨æ„ï¼š</strong>å·²å‹¾é€‰â€œå‡ºç”Ÿæ—¶é—´ä¸è¯¦â€ï¼Œæœ¬é¡µåˆ†æ<strong>æœªçº³å…¥æ—¶æŸ±</strong>ï¼ˆå‡†ç¡®åº¦ä¼šç•¥é™ï¼›è¡¥å……å…·ä½“æ—¶é—´å¯æ›´ç²¾å‡†ï¼‰ã€‚</li>'
      : '';
    return `
      <ul class="ul">
        <li>æ‚¨çš„æ—¥ä¸»ä¸º <strong>${dayMaster.stem}ï¼ˆ${dayMaster.element}ï¼‰</strong></li>
        <li>å‘½å±€æ•´ä½“<strong>${strength.mark}</strong>ï¼Œ${this.getStrengthDescription(strength.mark)}</li>
        <li>å‡ºç”Ÿäº<strong>${season}</strong>å­£ï¼Œ${this.getSeasonInfluence(season)}</li>
        <li>äº”è¡Œåˆ†å¸ƒï¼š${this.getElementDistribution(elements)}</li>
        ${timeNote}
      </ul>`;
  }
  generateAdvice({strength, useful, timeUnknown}){
    const timeWarn = timeUnknown ? '<li><strong>æç¤ºï¼š</strong>æ— æ—¶æŸ±ï¼Œå»ºè®®ä»…ä½œå‚è€ƒã€‚</li>' : '';
    return `
      <ul class="ul">
        <li><strong>å‘å±•ç­–ç•¥ï¼š</strong>${strength.focus}</li>
        <li><strong>å–œç”¨å…ƒç´ ï¼š</strong>${(useful.useful||[]).join('ã€')}</li>
        <li><strong>å¹¸è¿é¢œè‰²ï¼š</strong>${this.getLuckyColors(useful.useful||[])}</li>
        <li><strong>é€‚åˆæ–¹ä½ï¼š</strong>${this.getLuckyDirections(useful.useful||[])}</li>
        ${timeWarn}
      </ul>`;
  }
  getStrengthDescription(m){ return {åå¼º:'æ½œåŠ›è¶³ã€æŠ—å‹å¥½',åå¼±:'éœ€å¤–æ´æ›´èƒ½å‘æŒ¥',å¹³è¡¡:'å„é¢å‡è¡¡ã€é€‚åº”æ€§å¼º'}[m]||'å…·æœ‰ç‹¬ç‰¹ç‰¹ç‚¹'; }
  getSeasonInfluence(season){ const m={æ˜¥:'æœ¨æ—ºç”Ÿå‘',å¤:'ç«æ—ºå¤–æ”¾',ç§‹:'é‡‘æ—ºæ”¶æ•›',å†¬:'æ°´æ—ºå†…è—'}; return m[season]||'å­£èŠ‚å¯¹å‘½å±€æœ‰ä¸€å®šå½±å“'; }
  getLuckyColors(list){ const m={æœ¨:'ç»¿è‰²/é’è‰²',ç«:'çº¢è‰²/ç´«è‰²',åœŸ:'é»„è‰²/æ£•è‰²',é‡‘:'ç™½è‰²/é‡‘è‰²',æ°´:'é»‘è‰²/è“è‰²'}; return list.map(x=>m[x]).filter(Boolean).join('ã€'); }
  getLuckyDirections(list){ const m={æœ¨:'ä¸œæ–¹',ç«:'å—æ–¹',åœŸ:'ä¸­å¤®/ä¸œåŒ—/è¥¿å—',é‡‘:'è¥¿æ–¹',æ°´:'åŒ—æ–¹'}; return list.map(x=>m[x]).filter(Boolean).join('ã€'); }
  ELABEL(){ return {wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´'}; }
  getElementDistribution(elements) {
    const L = this.ELABEL();
    return Object.entries(elements)
      .sort((a,b) => b[1] - a[1])
      .map(([k,v]) => `${L[k]||k}${Math.round(v)}%`)
      .join('ã€');
  }
  getStrongestElement(elements){
    const L = this.ELABEL();
    const [k] = Object.entries(elements).reduce((a,b)=> a[1]>b[1]?a:b);
    return L[k] || k;
  }
  getWeakestElement(elements){
    const L = this.ELABEL();
    const [k] = Object.entries(elements).reduce((a,b)=> a[1]<b[1]?a:b);
    return L[k] || k;
  }
  getWealthAdvice(){
    const { elements = {}, useful = { useful: [] }, timeUnknown } = this.currentContext || {};
    const strong = this.getStrongestElement(elements);
    const weak   = this.getWeakestElement(elements);
    const isGood = (strong === 'é‡‘' || strong === 'åœŸ');
    const list   = Array.isArray(useful.useful) ? useful.useful.join('ã€') : '';
    const note   = timeUnknown ? ' ç”±äºæ—¶æŸ±ä¿¡æ¯ä¸å®Œæ•´ï¼Œè´¢è¿åˆ†æå¯èƒ½ä¸å¤Ÿç²¾ç¡®ã€‚' : '';
    return `æ‚¨çš„è´¢è¿${isGood ? 'è¾ƒä½³' : 'éœ€åŠªåŠ›'}ã€‚å»ºè®®åŠ å¼º${list}å…ƒç´ çš„è¿ç”¨ï¼Œé¿å…${weak}ç›¸å…³çš„é«˜é£é™©æŠ•èµ„ã€‚${note}`;
  }
  getHealthAdvice(){
    const { elements = {}, timeUnknown } = this.currentContext || {};
    const weak = this.getWeakestElement(elements);
    const healthMap = {æœ¨:'è‚èƒ†ã€çœ¼ç›',ç«:'å¿ƒè„ã€è¡€æ¶²å¾ªç¯',åœŸ:'è„¾èƒƒã€æ¶ˆåŒ–ç³»ç»Ÿ',é‡‘:'è‚ºã€å‘¼å¸ç³»ç»Ÿ',æ°´:'è‚¾ã€æ³Œå°¿ç³»ç»Ÿ'};
    const part = healthMap[weak] || 'æ•´ä½“ä½œæ¯';
    const note = timeUnknown ? ' å¥åº·åˆ†æåŸºäºç°æœ‰ä¿¡æ¯ï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µã€‚' : '';
    return `å¥åº·æ–¹é¢éœ€ç‰¹åˆ«æ³¨æ„${part}çš„ä¿å…»ã€‚å»ºè®®å®šæœŸä½“æ£€ï¼Œä¿æŒè§„å¾‹ä½œæ¯ã€‚${note}`;
  }
  showActionResponse(action, response){
    const messageDiv = document.createElement('div');
    messageDiv.className = 'assistant-message';
    messageDiv.innerHTML = `
      <p><strong>${this.getActionTitle(action)}ï¼š</strong>${response}</p>
      <p class="muted" style="margin-top:10px;font-size:.9em;">
        ğŸ’¡ æƒ³è¦æ›´ç²¾å‡†çš„æŒ‡å¯¼ï¼Ÿ<a href="#" style="color: var(--gold2);">å‡çº§VIPè·å–ä¸“å±åˆ†æ</a>
      </p>`;
    let container = document.querySelector('.assistant-container');
    if (!container){
      container = document.createElement('div');
      container.className = 'assistant-container';
      (document.getElementById('result') || document.body).appendChild(container);
    }
    const hook = container.querySelector('.vip-promo');
    hook && hook.parentNode===container ? container.insertBefore(messageDiv, hook) : container.appendChild(messageDiv);
    messageDiv.scrollIntoView({behavior:'smooth'});
  }
  getActionTitle(action){
    const t = {career:'äº‹ä¸šå»ºè®®', wealth:'è´¢è¿åˆ†æ', relationship:'æ„Ÿæƒ…æŒ‡å¯¼', health:'å¥åº·æé†’', lucky:'å¹¸è¿æ–¹å‘'};
    return t[action] || 'ä¸“ä¸šå»ºè®®';
  }
}
const assistant = new XinLianAssistant();

// ======================= å·¥å…· & è§„åˆ™å‡½æ•° =======================
function $(id){ return document.getElementById(id); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH = {å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  const dmEl = STEM_ELEM[dayGan]; const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  let score = 0;
  if ((season==='æ˜¥' && 'æœ¨ç«'.includes(dmEl)) || (season==='å¤' && 'ç«åœŸ'.includes(dmEl)) || (season==='ç§‹' && dmEl==='é‡‘') || (season==='å†¬' && dmEl==='æ°´')) score += 2;
  score += (cnt[dmEl]||0) * 1.2;
  const mark  = score >= 3 ? 'åå¼º' : (score <= 1 ? 'åå¼±' : 'å¹³è¡¡');
  const focus = mark==='åå¼º' ? 'æ³„ç§€/åˆ¶åŒ–' : (mark==='åå¼±' ? 'è¡¥åŠ©/é¡ºåŠ¿' : 'å®ˆä¸­/è°ƒå’Œ');
  return {season, mark, focus};
}
function chooseUseful(strength, dmElem){
  if (strength==='åå¼º'){
    return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful:({æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']})[dmElem], avoid:[dmElem]};
  }else if (strength==='åå¼±'){
    return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:({æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']})[dmElem], avoid:[]};
  }
  return {strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}
function renderPillars(root, p, timeUnknown=false){
  if (!root) return;
  root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='æ—¶æŸ±' && timeUnknown);
    const stem = u?'ï¼Ÿ':v.stem, branch=u?'ï¼Ÿ':v.branch;
    const div = document.createElement('div');
    div.className='pillar';
    div.innerHTML = `<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p, timeUnknown){
  const ge = (s,b)=> baziCalculator.getElement(s,b);
  const ny = (s,b)=> baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem);   setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem);     setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem);
  setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);
  const setIf = (id,val)=>{ const el=$(id); if(el) el.textContent = val; };
  setIf('year-element',  ge(p.year.stem,  p.year.branch));
  setIf('month-element', ge(p.month.stem, p.month.branch));
  setIf('day-element',   ge(p.day.stem,   p.day.branch));
  setIf('hour-element',  timeUnknown?'æœªçŸ¥':ge(p.hour.stem, p.hour.branch));
  setIf('year-nayin',  ny(p.year.stem,  p.year.branch));
  setIf('month-nayin', ny(p.month.stem, p.month.branch));
  setIf('day-nayin',   ny(p.day.stem,   p.day.branch));
  setIf('hour-nayin',  timeUnknown?'æœªçŸ¥':ny(p.hour.stem, p.hour.branch));
}
function showError(msg){
  const el = $('error'); if(!el) return;
  el.textContent = msg; el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 5000);
}
function ensureAssistantSlots(){
  if (document.getElementById('assistant-analysis')) return;
  const host = document.querySelector('.assistant-container') || document.getElementById('result') || document.body;
  const wrap = document.createElement('div'); wrap.className = 'assistant-container';
  const a = document.createElement('div'); a.id = 'assistant-analysis';
  const b = document.createElement('div'); b.id = 'assistant-advice';
  wrap.append(a, b); host.appendChild(wrap);
}

// ======================= å…è´¹æŠ¥å‘Šï¼ˆæ–‡æœ¬æ¨¡å—ï¼‰ =======================
function buildFreeReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´'};
  const entries = Object.entries(percents);
  const strongestK = entries.reduce((a,b)=> a[1]>b[1]?a:b)[0];
  const weakestK   = entries.reduce((a,b)=> a[1]<b[1]?a:b)[0];
  const strongest  = L[strongestK], weakest = L[weakestK];
  const absents = Object.keys(percents).filter(k => Math.round(percents[k])===0).map(k=>L[k]).join('ã€');
  const fmt = k => `${L[k]} ${Math.round(percents[k])}%`;
  const line = ['wood','fire','earth','metal','water'].map(fmt).join('ã€€');
  const fav  = (adv?.useful||[]).join('ã€');
  const avoid= (adv?.avoid||[]).join('ã€') || 'â€”';
  const hourTxt = timeUnknown ? 'ï¼Ÿï¼Ÿ' : (pillars.hour.stem + pillars.hour.branch);
  return `
    <div class="xl-card" style="margin-top:12px; padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px; color:var(--brand)">å…è´¹æŠ¥å‘Š</h3>
      <p style="margin:6px 0;">å››æŸ±ï¼š<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">æ—¥ä¸»ï¼š<strong>${pillars.day.stem}</strong>ï¼ˆ<strong>${pillars.day.element}</strong>ï¼‰ï½œå­£èŠ‚ï¼š<strong>${st.season||'-'}</strong>ï½œå‘½å±€ï¼š<strong>${st.mark}</strong> Â· <strong>${st.focus}</strong></p>
      <p style="margin:8px 0;">äº”è¡Œï¼š${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>åæ—ºï¼›<strong>${weakest}</strong>åå¼±ã€‚${absents?`<span style="color:var(--muted)">ï¼ˆç¼ºï¼š${absents}ï¼‰</span>`:''}</p>
      <ul style="margin:6px 0 0 18px; line-height:1.6">
        <li>å–œç”¨ä¼˜å…ˆï¼š<strong>${fav||'â€”'}</strong>ï¼›å¿Œè®³ï¼š${avoid}</li>
        <li>è°ƒè¡¡è¦ç‚¹ï¼š${st.focus}</li>
      </ul>
      ${timeUnknown?`<p style="margin:6px 0 0; color:var(--muted)">æç¤ºï¼šæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥ã€‚</p>`:''}
    </div>
  `;
}

// ======================= å¯Œå†…å®¹æŠ¥å‘Šï¼ˆç« èŠ‚åŒ–ï¼‰ =======================
function buildRichReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´'};
  const P = pillars;
  const line = ['wood','fire','earth','metal','water'].map(k => `${L[k]}${Math.round(percents[k]||0)}%`).join(' ');
  const entries = Object.entries(percents);
  const strongestK = entries.reduce((a,b)=> (a[1]>b[1]?a:b), ['wood',0])[0];
  const weakestK   = entries.reduce((a,b)=> (a[1]<b[1]?a:b), ['wood',0])[0];
  const strongest  = L[strongestK]||'â€”';
  const weakest    = L[weakestK]||'â€”';
  const absents = Object.keys(percents).filter(k => Math.round(percents[k]||0)===0).map(k=>L[k]).join('ã€');
  const favList   = (adv?.useful||[]).join('ã€') || 'â€”';
  const avoidList = (adv?.avoid||[]).join('ã€') || 'â€”';
  const hourTxt   = timeUnknown ? 'ï¼Ÿï¼Ÿ' : (P.hour.stem + P.hour.branch);

  return `
  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">ä¸€ã€å‘½ç›˜æ€»è§ˆ</h3>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; font-size:14px;">
      <div>å››æŸ±ï¼š<strong>${P.year.stem}${P.year.branch} ${P.month.stem}${P.month.branch} ${P.day.stem}${P.day.branch} ${hourTxt}</strong></div>
      <div>æ—¥ä¸»ï¼š<strong>${P.day.stem}</strong>ï¼ˆ<strong>${P.day.element}</strong>ï¼‰</div>
      <div>å­£èŠ‚ï¼š<strong>${st.season||'-'}</strong></div>
      <div>å‘½å±€ï¼š<strong>${st.mark}</strong> Â· ç­–ç•¥ï¼š<strong>${st.focus}</strong></div>
    </div>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">äºŒã€äº”è¡Œèƒ½é‡åˆ†æ</h3>
    <div style="font-size:14px;">${line}</div>
    <p style="margin:10px 0 0;">
      <strong>${strongest}</strong>åæ—ºï¼›<strong>${weakest}</strong>åå¼±ã€‚
      ${absents ? `<span class="muted" style="color:var(--muted)">ï¼ˆç¼ºï¼š${absents}ï¼‰</span>` : ``}
    </p>
    <ul style="margin:10px 0 0 18px; line-height:1.6">
      <li>å–œç”¨ä¼˜å…ˆï¼š<strong>${favList}</strong></li>
      <li>è°ƒè¡¡è¦ç‚¹ï¼š${st.focus}</li>
    </ul>
    ${timeUnknown ? `<p class="muted" style="color:var(--muted); margin-top:8px;">æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ã€‚</p>` : ``}
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">ä¸‰ã€æ€§æ ¼ä¸å¤©èµ‹</h3>
    <p style="margin:8px 0;"><strong>æ€§æ ¼æ ¸å¿ƒï¼š</strong>ä¾æ®æ—¥ä¸»ã€å­£èŠ‚ä¸å¼ºå¼±ç»™å‡ºæ ¸å¿ƒæ€§æ ¼æ ‡ç­¾ï¼ˆç¤ºä¾‹ï¼šå¤–å‘è¡¨è¾¾ã€è¡ŒåŠ¨åŠ›å¼ºï¼‰ã€‚</p>
    <p style="margin:8px 0;"><strong>ä¼˜åŠ¿èƒ½é‡ï¼š</strong>æ‰§è¡ŒåŠ› / åˆ›é€ åŠ› / å­¦ä¹ åŠ›ï¼ˆæ¨¡æ¿åŒ–è¡¥å……ï¼‰</p>
    <p style="margin:8px 0;"><strong>æ½œåœ¨æŒ‘æˆ˜ï¼š</strong>æ€¥èº / è¿‡åº¦æ‰¿æ‹… / è¾¹ç•Œæ„Ÿï¼ˆæ¨¡æ¿åŒ–è¡¥å……ï¼‰</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">å››ã€æ ¼å±€ä¸å–œå¿Œ</h3>
    <p style="margin:8px 0;"><strong>æ ¼å±€è¦ç‚¹ï¼š</strong>æŒ‰å››æŸ±ç‰¹å¾ï¼ˆåç¦„/æ¯”åŠ«/ä¼¤å®˜/ä¸ƒæ€ç­‰ï¼‰æ¨¡æ¿åŒ–è¾“å‡ºã€‚</p>
    <p style="margin:8px 0;"><strong>å–œç”¨ï¼š</strong>${favList}</p>
    <p style="margin:8px 0;"><strong>å¿Œè®³ï¼š</strong>${avoidList}</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">äº”ã€äº‹ä¸šä¸å‘å±•ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;"><strong>é€‚åˆé¢†åŸŸï¼š</strong>ä¾æ®å–œç”¨ä¸æ—¥ä¸»æ°”è´¨ï¼šç­–åˆ’/é¡¾é—®/è®¾è®¡/è¿è¥ç­‰ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>å‘å±•ç­–ç•¥ï¼š</strong>${st.focus}ï¼Œå»ºç«‹ SOP ä¸å¯å¤åˆ¶æµç¨‹</p>
    <p style="margin:8px 0;"><strong>æ˜“é”™ä½é£é™©ï¼š</strong>äº‹å¿…èº¬äº² / å†³ç­–å¤±è¡¡ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:10px 0 0;" class="muted">VIP è§£é”ï¼šå²—ä½å®šä½ã€ä¸‰å¹´è¿åŠ¿ã€è½¬èŒæ‹©æ—¶ä¸è¡ŒåŠ¨æ¸…å•ã€‚</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">å…­ã€æ„Ÿæƒ…ä¸å…³ç³»ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;"><strong>å¸å¼•ç±»å‹ï¼š</strong>ä¸æ—¥ä¸»äº’è¡¥/éœ€è¦æ”¯æŒå‹ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>å…³ç³»è¯¾é¢˜ï¼š</strong>è¾¹ç•Œ / æ²Ÿé€šèŠ‚å¥ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>ç›¸å¤„å»ºè®®ï¼š</strong>å°Šé‡èŠ‚å¥ã€å®šæœŸå¤ç›˜ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">ä¸ƒã€è´¢å¯Œä¸ç†è´¢ï¼ˆå…è´¹è¯•è¯»ï¼‰</h3>
    <p style="margin:8px 0;"><strong>è´¢æ˜Ÿæ ¼å±€ï¼š</strong>ç»“åˆå¼ºå¼±åˆ¤æ–­ï¼Œåè´¢/æ­£è´¢ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>è¿›è´¢æ–¹å¼ï¼š</strong>å†…å®¹/ç³»ç»Ÿ/å¤è´­ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>ç ´è´¢éšæ‚£ï¼š</strong>æƒ…ç»ªæ¶ˆè´¹/ä¼™ä¼´é£é™©ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>ç†è´¢å»ºè®®ï¼š</strong>${favList} ä¸ºä¸»è°ƒï¼Œç¨³ä¸­æ±‚è¿›</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">å…«ã€å¥åº·ä¸ä½œæ¯</h3>
    <p style="margin:8px 0;"><strong>æ˜“æ„Ÿéƒ¨ä½ï¼š</strong>æŒ‰æœ€å¼±äº”è¡Œï¼ˆ${weakest}ï¼‰å¯¹åº”ç³»ç»Ÿï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>è°ƒç†å»ºè®®ï¼š</strong>ä½œæ¯è§„å¾‹ã€èˆ’å‹è®­ç»ƒã€å­£èŠ‚å…»ç”Ÿï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">ä¹ã€ç¯å¢ƒä¸è‰²å½©ï¼ˆäº”è¡Œè°ƒæ³•ï¼‰</h3>
    <p style="margin:8px 0;"><strong>æœ‰åˆ©æ–¹ä½ï¼š</strong>ä¾æ®å–œç”¨ï¼šä¸œ/å—/è¥¿/åŒ—/ä¸­ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>è‰²å½©/æè´¨ï¼š</strong>ä¸å–œç”¨å¯¹åº”è‰²ç³»ä¸æè´¨ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>ç©ºé—´å¾®è°ƒï¼š</strong>å°èŒƒå›´æ‘†è®¾ä¸åŠ¨çº¿å»ºè®®ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">åã€æµå¹´ / æµæœˆ Â· å…è´¹é¢„å‘Š</h3>
    <p style="margin:8px 0;"><strong>å¹´åº¦æç¤ºï¼š</strong>ä¾æ®å½“å¹´å¹²æ”¯ä¸å–œç”¨ç»™ä¸€å¥è¯é¢„å‘Šï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:8px 0;"><strong>æœ¬æœˆå…³æ³¨ï¼š</strong>èŠ‚å¾‹ä¸è¡ŒåŠ¨å…³é”®è¯ï¼ˆæ¨¡æ¿åŒ–ï¼‰</p>
    <p style="margin:10px 0 0;" class="muted">VIP è§£é”ï¼š12 ä¸ªæœˆè¡ŒåŠ¨æ¸…å•ä¸æ‹©æ—¥è¡¨ã€‚</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:10px;">
    <h3 style="margin-top:0; color:var(--brand)">è§£é”ä½ çš„å®Œæ•´ä¸“å±æŠ¥å‘Š</h3>
    <p style="margin:8px 0;">
      å…è´¹ç‰ˆä¸ºåŸºç¡€è§£è¯»ã€‚å‡çº§ <strong>VIP</strong>ï¼Œå³å¯è·å¾—
      <strong>å©šå§» / äº‹ä¸š / è´¢åº“ / æ‹©æ—¥</strong> çš„å®Œæ•´æ–¹æ¡ˆä¸å¯æ‰§è¡Œæ¸…å•ã€‚
    </p>
    <div style="margin-top:10px;">
      <a href="/vip" style="display:inline-block; padding:10px 16px; border-radius:10px; background:var(--brand); color:#111; font-weight:700; text-decoration:none;">å‡çº§ VIP</a>
    </div>
  </section>
  `;
}
function mountRichReport({pillars, percents, st, adv, timeUnknown}) {
  let host = document.getElementById('xl-rich-report');
  if (!host) {
    host = document.createElement('section');
    host.id = 'xl-rich-report';
    host.className = 'container';
    host.style.paddingTop = '12px';
    (document.getElementById('result') || document.body).appendChild(host);
  }
  host.innerHTML = buildRichReportHTML({pillars, percents, st, adv, timeUnknown});
}

// ======================= å¿ƒæ€œç®¡å®¶å¡ç‰‡ & GPTæŠ½å±‰ =======================
function buildButlerHTML(){
  return `
    <div id="assistant-panel" class="xl-card" style="margin-top:12px; padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px; color:var(--brand)">å¿ƒæ€œç®¡å®¶ Â· æ™ºèƒ½è§£è¯»</h3>
      <div id="assistant-analysis"></div>
      <div id="assistant-advice" style="margin-top:8px"></div>
    </div>
  `;
}
function buildChatDrawerHTML(){
  return `
    <details id="gpt-drawer" class="xl-card" style="margin-top:12px; padding:0; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <summary style="cursor:pointer; list-style:none; padding:12px 16px; font-weight:700; color:var(--brand);">GPT é—®ç­”</summary>
      <div style="padding:10px 12px;">
        <div id="gpt-body" style="max-height:260px; overflow:auto; font-size:14px; line-height:1.5; border:1px solid #222; border-radius:8px; padding:8px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input id="gpt-input" placeholder="é—®ç‚¹ä»€ä¹ˆâ€¦" style="flex:1; padding:8px; border-radius:8px; border:1px solid #222; background:#0b0f14; color:var(--text)">
          <button id="gpt-send" style="padding:8px 12px; border-radius:8px; background:var(--brand); color:#111; font-weight:700">å‘é€</button>
        </div>
      </div>
    </details>
  `;
}
async function callChatAPI(userText, ctx){
  const payload = { messages: [{role:'user', content: userText}], context: ctx };
  async function post(url){
    try{
      const r = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (r.ok) {
        // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼
        const t = await r.text();
        try {
          const j = JSON.parse(t);
          return j.reply || t || 'ï¼ˆæ— å“åº”ï¼‰';
        } catch { return t || 'ï¼ˆæ— å“åº”ï¼‰'; }
      }
    }catch(_){}
    return null;
  }
  return await post('/api/butler/chat') || await post('/api/chat') || 'ï¼ˆæš‚æ—¶æ— æ³•è¿æ¥åˆ°æœåŠ¡ç«¯ï¼‰';
}
function wireChatDrawer(){
  const send = $('gpt-send'), input=$('gpt-input'), body=$('gpt-body');
  if(!send || !input || !body) return;
  send.onclick = async ()=>{
    const text = (input.value||'').trim(); if(!text) return;
    body.insertAdjacentHTML('beforeend', `<div style="text-align:right; margin:6px 0;">${text}</div>`);
    input.value='';
    const ctx = window.__bazi_ctx__ || {};
    const reply = await callChatAPI(text, ctx);
    body.insertAdjacentHTML('beforeend', `<div style="margin:6px 0;">${reply}</div>`);
    body.scrollTop = body.scrollHeight;
  };
}

// ======================= ç»Ÿä¸€æŒ‚è½½ï¼ˆå…è´¹æŠ¥å‘Š + ç®¡å®¶å¡ç‰‡ + GPTæŠ½å±‰ï¼‰ =======================
function mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown}){
  const resultEl = $('result');
  if(!resultEl){ console.warn('[mount] æ‰¾ä¸åˆ° #resultï¼Œè·³è¿‡æ‰©å±•æ¨¡å—æ¸²æŸ“'); return; }

  // 1) å…è´¹æŠ¥å‘Š
  let freeNode = $('xl-free-report');
  if(!freeNode){
    freeNode = document.createElement('div');
    freeNode.id = 'xl-free-report';
    resultEl.appendChild(freeNode);
  }
  freeNode.innerHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown});

  // 2) å¿ƒæ€œç®¡å®¶å¡ç‰‡
  let butler = $('assistant-panel');
  if(!butler){
    const wrap = document.createElement('div');
    wrap.innerHTML = buildButlerHTML();
    resultEl.appendChild(wrap.firstElementChild);
  }
  assistant.generateAnalysis({
    dayMaster: { stem: pillars.day.stem, element: pillars.day.element },
    elements: { wood:percents.wood, fire:percents.fire, earth:percents.earth, metal:percents.metal, water:percents.water },
    strength: st, season: st.season, useful: adv, timeUnknown
  });

  // 3) GPT æŠ½å±‰
  let drawer = $('gpt-drawer');
  if(!drawer){
    const wrap = document.createElement('div');
    wrap.innerHTML = buildChatDrawerHTML();
    resultEl.appendChild(wrap.firstElementChild);
    wireChatDrawer();
  }

  // 4) èŠå¤©ä¸Šä¸‹æ–‡
  window.__bazi_ctx__ = {
    pillars,
    wuxing_ratio: percents,
    season: st.season,
    strength: st.mark,
    strategy: st.focus,
    useful: adv?.useful || [],
    timeUnknown
  };
}

function ensureGPTDrawer() {
  const host = document.getElementById('result') || document.body;
  let drawer = document.getElementById('gpt-drawer');

  // ä¸å­˜åœ¨å°±åˆ›å»º
  if (!drawer) {
    const wrap = document.createElement('div');
    wrap.innerHTML = buildChatDrawerHTML();
    // æ”¾åˆ°ç»“æœåŒºçš„æœ€å‰é¢ï¼Œç¡®ä¿â€œçœ‹å¾—è§â€
    host.insertBefore(wrap.firstElementChild, host.firstChild);
    drawer = document.getElementById('gpt-drawer');
  } else {
    // å·²å­˜åœ¨ï¼šè‹¥ä¸åœ¨ #resultï¼Œç§»è¿‡æ¥å¹¶æ”¾æœ€å‰
    if (host && drawer.parentNode !== host) {
      host.insertBefore(drawer, host.firstChild);
    }
  }

  // å…œåº•ï¼šç¡®ä¿æ˜¾ç¤ºã€ä¸è¢«éšè—
  drawer.style.display = 'block';
  drawer.removeAttribute('hidden');

  // åå¤ç»‘å®šä¹Ÿæ²¡äº‹ï¼šå…ˆè§£ç»‘å†ç»‘ï¼ˆç®€å•ç²—æš´ï¼‰
  const send = document.getElementById('gpt-send');
  if (send) {
    const cloned = send.cloneNode(true);
    send.parentNode.replaceChild(cloned, send);
  }
  wireChatDrawer();
}

// ======================= ä¸»æµç¨‹ï¼šç”Ÿæˆå…«å­—å¹¶æ¸²æŸ“ =======================
async function genChart(){
  const birth = ($('birthdate')?.value||'').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  if (!birth){ showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸã€‚'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D] = birth.split('-').map(Number);
    let hour = 12;
    if (!timeUnknown){
      const t = ($('birthtime')?.value||'').trim();
      if(t) hour = parseInt(t.split(':')[0],10);
    }

    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    // æ˜¾ç¤ºç»“æœåŒº
    $('result')?.style.setProperty('display','block');
    ensureGPTDrawer(); // â† å¼ºåˆ¶æŠŠ GPT æŠ½å±‰æ”¾åˆ°ç»“æœåŒºæœ€ä¸Šæ–¹å¹¶ç»‘å®šäº‹ä»¶

    // æ—¥æœŸä¸â€œæœªçº³å…¥æ—¶æŸ±â€å¾½ç« 
    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : (hour + 'æ—¶');
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if (tu) {
      const el = document.getElementById('bazi-date');
      el && (el.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>');
    }

    // ç»å…¸åŒºï¼šå››æŸ±è¡¨ + äº”è¡Œæ¡
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);
    setBar($('bar-æœ¨'),  percents.wood);  setText('pct-æœ¨',  Math.round(percents.wood)+'%');
    setBar($('bar-ç«'),  percents.fire);  setText('pct-ç«',  Math.round(percents.fire)+'%');
    setBar($('bar-åœŸ'),  percents.earth); setText('pct-åœŸ',  Math.round(percents.earth)+'%');
    setBar($('bar-é‡‘'),  percents.metal); setText('pct-é‡‘',  Math.round(percents.metal)+'%');
    setBar($('bar-æ°´'),  percents.water); setText('pct-æ°´',  Math.round(percents.water)+'%');

    // å¼ºå¼±/å–œç”¨
    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);
    const keys = Object.keys(counts);
    const maxK = keys.reduce((a,b)=>counts[a]>counts[b]?a:b);
    const minK = keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance', `äº”è¡Œä¸­${maxK}å…ƒç´ æœ€å¼ºï¼Œ${minK}å…ƒç´ æœ€å¼±ã€‚`);

    // ç»Ÿä¸€æŒ‚è½½ï¼ˆå…è´¹æŠ¥å‘Š + ç®¡å®¶å¡ç‰‡ + GPTæŠ½å±‰ï¼‰
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });

    // å¯Œå†…å®¹æŠ¥å‘Šï¼ˆç¬¬2~10ç« ï¼‰
    mountRichReport({ pillars, percents, st, adv, timeUnknown: tu });

    // â€”â€” å¯é€‰ï¼šåç«¯â€œå¿ƒæ€œç®¡å®¶â€è§£è¯´ï¼ˆå¤±è´¥é™é»˜ï¼‰
    try {
      const payload = {
        profile: {
          name: $('name')?.value || '', gender: $('gender')?.value || '',
          calendar: $('calendar')?.value || 'gregorian',
          birth: `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`,
          time: tu ? null : ($('birthtime')?.value || ''), timezone: '+08:00'
        },
        chart: {
          year: pillars.year, month: pillars.month, day: {stem:pillars.day.stem, branch:pillars.day.branch},
          hour: tu ? {stem:'ï¼Ÿ',branch:'ï¼Ÿ'} : pillars.hour,
          day_master: pillars.day.stem, season: st.season,
          wuxing_ratio: { wood: percents.wood, fire: percents.fire, earth: percents.earth, metal: percents.metal, water: percents.water }
        },
        prefs: { lang: 'zh-CN', tier: 'free' }
      };
      const resp = await fetch('/api/butler/explain', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).catch(()=>null);
      const ana = document.getElementById('assistant-analysis');
      const advc= document.getElementById('assistant-advice');
      if (resp && resp.layout) {
        if (ana && resp?.layout?.cards?.[0]?.html) ana.innerHTML = resp.layout.cards[0].html;
        if (advc && resp?.layout?.cards?.[1]?.html) advc.innerHTML= resp.layout.cards[1].html;
      }
    } catch(_) { /* é™é»˜å¤±è´¥ï¼Œä¸å½±å“é¡µé¢ */ }

    // æ§åˆ¶å°æ ¡éªŒ
    console.log('å®é™… â†’',
      pillars.year.stem+pillars.year.branch,
      pillars.month.stem+pillars.month.branch,
      pillars.day.stem+pillars.day.branch,
      tu ? 'ï¼Ÿ' : (pillars.hour.stem+pillars.hour.branch)
    );

  } catch(err){
    console.error(err);
    showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none';
  }
}
  <!-- åŠŸèƒ½è„šæœ¬ï¼šåç«¯ä»£ç† + å¤šè¯­è¨€ + Chat æµ®çª— -->

  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat æŒ‰é’®ä¸é¢æ¿
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = 'å¿ƒæ€œç®¡å®¶';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">å¿ƒæ€œç®¡å®¶ Â· Chat</div>
        <div class="ss-close" id="ssChatClose">âœ•</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    // åˆå§‹è¯­è¨€ï¼ˆé¡µé¢ + chatï¼‰
    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ï¼Œè¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        addMsg(reply);
      }catch(e){
        addMsg('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // è¯­è¨€åˆ‡æ¢æ—¶ï¼ŒåŒæ­¥æ›´æ–°
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }
  });

  // ============== ç™»å½•æµç¨‹ï¼ˆé›†ä¸­å¤„ç† exists / expired / expiresAtï¼‰ ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }

  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    // âœ… ç»Ÿä¸€åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼ˆå…¼å®¹ msg/flag/æ—¶é—´æˆ³ï¼‰
    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      // åªæç¤ºï¼Œä¸è·³è½¬ï¼›å¯ä¸€é”®å¼•å¯¼ç»­è´¹
      const go = confirm(t('err_expired') + "ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    // âœ… æ­£å¸¸é€šè¿‡æ‰è·³ VIP
    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    // å¸¸è§é”™è¯¯
    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== è¡¨å•äº‹ä»¶ï¼ˆæ³¨å†Œ / ç™»å½• / é‡è®¾ï¼‰ ========
  document.getElementById("registerForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

    lock($("registerBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      }));

      if (res.ok === true){
        localStorage.setItem("vipEmail", email);
        location.href = "vip_trial.html";
        return;
      }

      // å·²å­˜åœ¨ï¼šè‡ªåŠ¨å°è¯•ç™»å½•ï¼ˆç”¨åˆšè¾“å…¥çš„å¯†ç ï¼‰
      if ((res.msg||"").toString() === 'exists'){
        await loginFlow(email, password);
        return;
      }

      return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
    } catch(err){
      showErr(t('err_register_fail') + (err?.message || ''));
    } finally{
      lock($("registerBtn"), false);
    }
  });

  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    lock($("loginBtn"), true);
    try{
      await loginFlow(email, password);
    } catch(err){
      showErr(t('err_login_fail') + (err?.message || ''));
    } finally{
      lock($("loginBtn"), false);
    }
  });

  document.getElementById("resetBtn").addEventListener("click", async ()=>{
    hideErr();
    let email = prompt(t('prompt_email'));
    if (email === null) return; email = email.trim();
    if (!email) return showErr(t('err_email_empty'));

    let newPassword = prompt(t('prompt_newpwd'));
    if (newPassword === null) return; newPassword = newPassword.trim();
    if (!newPassword) return showErr(t('err_pwd_empty'));
    if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

    lock($("resetBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword })
      }));
      if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
      alert(t('msg_reset_ok'));
    } catch(err){
      showErr(t('err_reset_fail') + (err?.message || ''));
    } finally{
      lock($("resetBtn"), false);
    }
  });
  
// äº‹ä»¶ç»‘å®š
document.addEventListener('DOMContentLoaded', ()=>{
  const today = new Date(); const def = today.toISOString().split('T')[0];
  if ($('birthdate') && !$('birthdate').value) $('birthdate').value = def;
  const tChk = $('timeUnknown'), tBox = $('timeInputContainer');
  if (tChk){ tChk.addEventListener('change', function(){ tBox && tBox.classList.toggle('disabled', this.checked); }); }
  $('genBtn')?.addEventListener('click', genChart);
});     

// ===== è‡ªæµ‹ï¼ˆæ§åˆ¶å°ï¼‰ï¼š1978-02-21 12:00ï¼ˆUTC+8ï¼‰åº”ä¸º æˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ =====
(function(){
  const c = new BaziCalculator();
  const Y=c.calculateYearPillar(1978);
  const M=c.calculateMonthPillar(1978,2,21);
  const D=c.calculateDayPillar(1978,2,21);
  const H=c.calculateHourPillar(D.stem,12);
  console.log('åº”ä¸º â†’ å¹´ æˆŠåˆï½œæœˆ ç”²å¯…ï½œæ—¥ ç”²å¯…ï½œæ—¶ åºšåˆ');
  console.log('å®é™… â†’', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
