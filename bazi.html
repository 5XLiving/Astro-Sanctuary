<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    
    * {
      box-sizing: border-box;
    }
    
    html,body{
      height:100%;
      margin:0;
      padding:0;
      color:var(--text); 
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background: linear-gradient(135deg, #0b0f14 0%, #16202b 100%);
      filter: brightness(.45) saturate(.9) blur(2px);
    }
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:24px 16px 80px;
      opacity: 1 !important;
      visibility: visible !important;
    }
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .title{
      font-family:"Noto Serif SC",serif;
      font-weight:700;
      letter-spacing:.02em;
    }
    .subtitle{
      color:var(--muted);
      font-size:.9rem;
    }
    .lang{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .lang select{
      appearance:none;
      border-radius:10px;
      border:1px solid #243244;
      background:#0e1520;
      color:var(--text);
      padding:10px 34px 10px 12px;
      font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:calc(100% - 12px) 50%;
    }

    .section{
      margin-top:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      padding:18px;
      margin:16px 0;
      opacity: 1 !important;
      visibility: visible !important;
    }
    .h2{
      font-size:1.2rem;
      margin:0 0 12px;
      font-weight:800;
      color:#ffe084;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .h2::before{
      content:"";
      width:4px;
      height:18px;
      background:var(--brand);
      border-radius:2px;
    }

    .row{
      display:grid;
      gap:12px;
    }
    @media(min-width:760px){
      .row.cols-3{
        grid-template-columns:1fr 1fr 1fr;
      }
      .row.cols-2{
        grid-template-columns:1fr 1fr;
      }
    }

    input,select{
      width:100%;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid #243244;
      background:#0e1520;
      color:var(--text);
      padding:12px 12px;
      font-size:15px;
      outline:none;
      opacity: 1 !important;
      visibility: visible !important;
    }
    input::placeholder{
      color:#6f8092;
    }
    .btn{
      display:inline-grid;
      place-items:center;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #e6c76e;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);
      color:#191919;
      font-weight:800;
      cursor:pointer;
      opacity: 1 !important;
      visibility: visible !important;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(230,199,110,.5);
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .btn.ghost{
      background:transparent;
      color:var(--gold2);
      border:1px solid rgba(212,175,55,.45);
      box-shadow:none;
    }
    .btn.block{
      display:block;
      width:100%;
    }

    .pillars{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    .pillar{
      background:#0f1624;
      border:1px solid #253245;
      border-radius:12px;
      padding:14px 10px;
      text-align:center;
    }
    .pillar .tit{
      color:#9aa3b2;
      font-size:.85rem;
      margin-bottom:6px;
    }
    .pillar .gz{
      font-size:1.5rem;
      font-weight:800;
      color:var(--gold2);
    }

    .bazi-table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      background:#0f1624;
      border-radius:8px;
      overflow:hidden;
    }
    .bazi-table th,.bazi-table td{
      padding:10px 12px;
      border:1px solid #253245;
      text-align:center;
    }
    .bazi-table th{
      background:rgba(212,175,55,.1);
      color:var(--gold2);
    }

    .bar{
      height:10px;
      background:#0d1420;
      border:1px solid #233146;
      border-radius:999px;
      overflow:hidden;
      margin:6px 0;
    }
    .bar i{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#ffe084,#f2d27a);
      width:0;
      transition: width 0.5s ease;
    }
    .bar-row{
      display:grid;
      grid-template-columns:60px 1fr 60px;
      gap:10px;
      align-items:center;
    }
    .error-message{
      background:rgba(255,90,95,.1);
      border:1px solid #ff5a5f;
      border-radius:8px;
      padding:10px;
      display:none;
    }
    .badge-warn{
      display:inline-block;
      padding:2px 8px;
      margin-left:6px;
      border:1px solid #ffb84d;
      border-radius:999px;
      color:#ffb84d;
      font-size:.82rem;
    }
    .muted{
      color:var(--muted);
    }

    /* —— 出生时间：时间输入 + “不详”同一行 —— */
    .time-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .time-row .time-unknown{
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-mini{
      padding:8px 10px;
      border-radius:10px;
    }
    /* —— 隐藏“估时间”按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{
      display:none !important;
      visibility:hidden !important;
    }

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:50;
      width:56px;
      height:56px;
      border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);
      color:#191919;
      display:grid;
      place-items:center;
      font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
      cursor:pointer;
      border:1px solid #e6c76e;
    }
    .ss-chat-panel{
      position:fixed;
      right:18px;
      bottom:88px;
      z-index:50;
      width:min(460px,92vw);
      display:none;
      background:#0e1520;
      border:1px solid #243244;
      border-radius:14px;
      box-shadow:var(--shadow);
    }
    .ss-chat-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid #243244;
    }
    .ss-chat-title{
      font-weight:700;
    }
    .ss-close{
      cursor:pointer;
      opacity:.8;
    }
    .ss-chat-body{
      max-height:300px;
      overflow:auto;
      padding:10px 12px;
    }
    .ss-msg{
      padding:8px 10px;
      background:#0f1624;
      border:1px solid #243244;
      border-radius:10px;
      margin:6px 0;
      max-width:80%;
    }
    .ss-msg.me{
      margin-left:auto;
      background:#132033;
    }
    /* 聊天输入行：输入框撑满、按钮按内容自适应 */
    .ss-chat-input{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-top:1px solid #243244;
    }
    .ss-chat-input input{
      flex:1 1 auto;
      min-width:0;
    }
    .ss-chat-input .btn,
    .ss-chat-input button{
      flex:0 0 auto;
      width:auto !important;
      white-space:nowrap;
      padding:10px 14px;
    }

    /* —— 会员区布局 —— */
    .columns{
      display:grid;
      gap:12px;
      grid-template-columns:1fr;
    }
    @media(min-width:900px){
      .columns{
        grid-template-columns:1fr 1fr;
      }
    }
    .list-block{
      border:1px solid #263448;
      background:#0e1520;
      border-radius:12px;
      padding:16px;
    }
    .list-block ul{
      margin:.2rem 0 0;
      padding-left:1.1rem;
    }
    .group-title{
      font-size:1.05rem;
      color:#ffe084;
      margin:6px 0 14px;
    }
    .astro-auth{
      max-width:980px;
      margin:28px auto;
      padding:20px 18px;
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      border:1px solid rgba(212,175,55,.22);
      border-radius:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }
    .auth-grid{
      display:grid;
      gap:18px;
      grid-template-columns:1.2fr .8fr;
    }
    @media(max-width:860px){
      .auth-grid{
        grid-template-columns:1fr;
      }
    }
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      border:1px solid rgba(212,175,55,.22);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .panel .head{
      padding:16px 18px;
      border-bottom:1px solid rgba(212,175,55,.22);
      color:var(--gold);
      font-weight:700;
      letter-spacing:.3px;
    }
    .panel .body{
      padding:18px;
    }
    .spacer{
      height:12px;
    }
    footer{
      color:#6c7b8c;
      font-size:.85rem;
      text-align:center;
      padding:30px 0;
    }

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{
      display:none !important;
    }

    /* —— 估时间弹窗 —— */
    .tw-mask{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .tw-box{
      width:min(560px,94vw);
      background:#0e1520;
      border:1px solid #243244;
      border-radius:14px;
      box-shadow:var(--shadow);
    }
    .tw-head{
      padding:12px 14px;
      border-bottom:1px solid #243244;
      font-weight:700;
    }
    .tw-body{
      padding:14px;
    }
    .tw-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
    }
    .tw-btn{
      padding:10px;
      border:1px solid #243244;
      border-radius:12px;
      background:#0f1624;
      color:var(--text);
      cursor:pointer;
    }
    .tw-btn.active{
      border-color:var(--gold2);
      box-shadow:0 0 0 2px rgba(212,175,55,.25) inset;
    }
    .tw-foot{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid #243244;
    }
    /* 修复：Grid 子项允许收缩，避免内容把面板撑破 */
    .auth-grid > * {
      min-width: 0;
    }
    .panel .body .row.one > * {
      min-width: 0;
    }

    /* 让会员按钮在窄宽度下能换行、居中且不溢出 */
    .panel .body .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: normal;
      line-height: 1.2;
      word-break: break-word;
    }

    /* 块级按钮确保占满容器且不超出 */
    .btn.block {
      display:block;
      width:100%;
      box-sizing:border-box;
    }

    /* 可选：如果仍有轻微位移，限制溢出 */
    .panel .body {
      overflow: hidden;
    }

    .panel .body .btn {
      padding: 10px 14px;
    }
    
    /* === 表单网格：大屏 3 列，窄屏 1 列 === */
    .row{
      display:grid;
      gap:12px;
      grid-template-columns:1fr;
    }
    .row > *{
      min-width:0;
    }
    @media (min-width:760px){
      .row.cols-3{
        grid-template-columns:1fr 1fr 1fr;
      }
    }

    /* 标签更紧凑 */
    label.muted{
      display:block;
      margin-bottom:4px;
    }

    /* 按钮不要 100% 宽 */
    #genBtn{
      width:auto !important;
    }
    .gen-wrap{
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
    }

    /* 时间输入与"不详"并排、紧凔 */
    .time-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .time-row input[type="time"]{
      width:auto !important;
      flex:0 0 160px;
      min-width:140px;
    }
    .time-row .time-unknown{
      white-space:nowrap;
    }
    .title a{
      color: inherit;
      text-decoration: none;
    }
    .title a:hover{
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    
    /* —— 统一头部 —— */
    .site-header{
      position:sticky;
      top:0;
      z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 16px;
    }

    /* 品牌区：徽章 + 标题 */
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:var(--text);
    }
    .brand-badge{
      display:inline-grid;
      place-items:center;
      width:34px;
      height:34px;
      border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546;
      box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800;
      color:#ffe084;
    }
    .title{
      font-family:"Noto Serif SC",serif;
      font-weight:700;
      letter-spacing:.02em;
    }

    /* 语言选择：防止"语言"竖排、与第一张一致 */
    .lang{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .lang label{
      white-space:nowrap;
      color:var(--muted);
      margin-right:4px;
    }
    .lang select{
      appearance:none;
      min-width:170px;
      border-radius:10px;
      border:1px solid #243244;
      background:#0e1520;
      color:var(--text);
      padding:10px 34px 10px 12px;
      font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:calc(100% - 12px) 50%;
    }

    @media (max-width:520px){
      .title{
        font-size:1rem;
      }
      .lang select{
        min-width:140px;
      }
    }
    
    /* 与 Index 保持一致的根字号（会影响 rem 计算） */
    html {
      font-size: 16px;
    }
    @media (min-width: 768px){
      html {
        font-size: 17px;
      }
    }
    @media (min-width: 1200px){
      html {
        font-size: 18px;
      }
    }

    /* 标题用 Noto Serif SC；字号/字重与 Index 完全一致 */
    .site-header .brand .title,
    .site-header .title{
      font-family: "Noto Serif SC","Noto Serif",serif !important;
      font-weight: 600 !important;
      letter-spacing: .02em;
      font-size: 1.1rem !important;
      line-height: 1.25;
    }

    /* —— 简易报告样式 —— */
    .report{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .report .sec{
      padding:12px;
      border:1px solid var(--line);
      background:#0e1520;
      border-radius:12px;
    }
    .report .sec h3{
      margin:0 0 6px;
      color:#f2d27a;
      font-size:1.05rem;
    }
    .report p,.report li{
      line-height:1.7;
    }

    /* —— 估时间弹窗 —— */
    .tw-mask{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .tw-box{
      width:min(560px,94vw);
      background:#0e1520;
      border:1px solid #243244;
      border-radius:14px;
      box-shadow:var(--shadow);
    }
    .tw-head{
      padding:12px 14px;
      border-bottom:1px solid #243244;
      font-weight:700;
    }
    .tw-body{
      padding:14px;
    }
    .tw-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
    }
    .tw-btn{
      padding:10px;
      border:1px solid #243244;
      border-radius:12px;
      background:#0f1624;
      color:#e8edf3;
      cursor:pointer;
    }
    .tw-btn.active{
      border-color:var(--gold2);
      box-shadow:0 0 0 2px rgba(212,175,55,.25) inset;
    }
    .tw-foot{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid #243244;
    }
    .auth-grid > * {
      min-width: 0;
    }
    .panel .body .row.one > * {
      min-width: 0;
    }

    /* —— 简易报告样式 —— */
    .report{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .report .sec{
      padding:12px;
      border:1px solid var(--line);
      background:#0e1520;
      border-radius:12px;
    }
    .report .sec h3{
      margin:0 0 6px;
      color:#f2d27a;
      font-size:1.05rem;
    }
    .report p,.report li{
      line-height:1.7;
    }
  
    .sr-only{
      position:absolute !important;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    
    /* AI 卡片样式 */
    .ai-card .ai-content{
      white-space:pre-wrap;
      line-height:1.7;
    }
    .ai-card .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .ai-card .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #2a3546;
      background:#0e1520;
      color:#e8edf3;
      cursor:pointer;
    }
    .ai-card .chip:hover{
      border-color:#f2d27a;
      box-shadow:0 0 0 2px rgba(242,210,122,.15) inset;
    }
    .ai-card .skeleton{
      display:grid;
      gap:8px;
    }
    .ai-card .skeleton div{
      height:12px;
      border-radius:6px;
      background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);
      animation:sh 1.2s infinite;
    }
    @keyframes sh{
      0%{opacity:.5}
      50%{opacity:1}
      100%{opacity:.5}
    }
    .ai-lock-overlay{
      position:static;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      text-align:center;
    }
    .ai-lock-overlay .tip{
      color:#ffd88a;
      font-weight:700;
      margin-bottom:4px;
    }
    .ai-lock-overlay .sub{
      color:var(--muted);
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <!-- 品牌：点击回到"八字简评"本页 -->
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="label_name">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">性别</label>
        <select id="gender">
          <option value="" data-i18n="opt_gender_confidential">不透露</option>
          <option value="male" data-i18n="opt_gender_male">男性</option>
          <option value="female" data-i18n="opt_gender_female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="label_calendar">历法</label>
        <select id="calendar">
          <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
          <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
        </select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="label_birthdate">出生日期</label>
        <input type="date" id="birthdate" />
      </div>

      <div>
        <label class="muted" data-i18n="label_birthtime">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:00" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span data-i18n="cb_time_unknown">出生时间不详</span>
          </label>
        </div>
      </div>

      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

<table class="bazi-table">
  <thead>
    <tr>
      <th></th>
      <th>年柱</th>
      <th>月柱</th>
      <th>日柱</th>
      <th>时柱</th>
    </tr>
  </thead>
  <tbody id="bazi-details">
    <tr>
      <td>天干</td>
      <td id="year-stem">-</td>
      <td id="month-stem">-</td>
      <td id="day-stem">-</td>
      <td id="hour-stem">-</td>
    </tr>
    <tr>
      <td>地支</td>
      <td id="year-branch">-</td>
      <td id="month-branch">-</td>
      <td id="day-branch">-</td>
      <td id="hour-branch">-</td>
    </tr>
    <tr>
      <td>五行</td>
      <td id="year-element">-</td>
      <td id="month-element">-</td>
      <td id="day-element">-</td>
      <td id="hour-element">-</td>
    </tr>
    <tr>
      <td>纳音</td>
      <td id="year-nayin">-</td>
      <td id="month-nayin">-</td>
      <td id="day-nayin">-</td>
      <td id="hour-nayin">-</td>
    </tr>
  </tbody>
</table>      
    </div>

    <div class="card">
      <div class="h2" data-i18n="rpt_sec_elements_title">五行能量分析</div>
      <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
    
    <!-- AI 解读卡片 -->
    <div class="card" id="aiCard">
      <div class="h2" id="butlerTitle">心怜管家 · 解读</div>
      <div id="aiContent" class="ai-content">
        <div class="skeleton">
          <div style="width:60%"></div>
          <div style="width:80%"></div>
          <div style="width:90%"></div>
          <div style="width:70%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>
    </div>
  </section>

  <!-- 专业报告挂载容器（i18n 文案走 JS 注入） -->
<section class="card" id="proReportCard">
  <div id="chartReport" aria-live="polite"></div>
</section>

  <!-- 会员专区 -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
        <ul>
          <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
          <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
          <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
          <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
          <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
          <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
          <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
        <ul>
          <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
          <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
          <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
          <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

    <section class="astro-auth">
      <div class="auth-grid">
        <!-- 左侧：输入 + 注册/登录 -->
        <div class="panel">
          <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <!-- 登录/注册建议用 username，密码管理器更容易配对 -->
              <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
              <input
                id="email"
                name="email"
                type="email"
                inputmode="email"
                autocomplete="username"
                placeholder=""
                data-i18n-ph="ph_email"
                required
              />
              <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
              <input
                id="password"
                name="password"
                type="password"
                autocomplete="current-password"
                placeholder="密码 Password（至少8位，含大小写数字符号）"
                data-i18n-ph="ph_password"
                required
              />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
              <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- 右侧：会员与返回 -->
        <div class="panel">
          <div class="head" data-i18n="panel_member_head">会员服务</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
            </div>
            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<!-- 估时间弹窗 -->
<div class="tw-mask" id="twMask" aria-hidden="true">
  <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
    <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
    <div class="tw-body">
      <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
      <div class="tw-grid" id="twGrid"></div>
      <div class="muted" style="margin-top:10px;font-size:.9em">
        选择后点"填入时间"，会用该时段的中位时间写到上方时间输入框，并自动取消"时间不详"。
      </div>
    </div>
    <div class="tw-foot">
      <button class="btn ghost" id="twCancel" type="button">取消</button>
      <button class="btn" id="twApply" type="button" disabled>填入时间</button>
    </div>
  </div>
</div>

<!-- ============ 浮窗 Chat UI（DOM） ============ -->
<div class="ss-chat-fab" id="chatFab" aria-label="Chat" title="Chat">
  <span data-i18n="chat_fab">问</span>
</div>
<div class="ss-chat-panel" id="chatPanel" role="dialog" aria-modal="true" aria-labelledby="chatTitle">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="butler_title">心怜管家 · 解读</div>
    <div class="ss-close" id="chatClose" aria-label="Close">✕</div>
  </div>
  <div class="ss-chat-body" id="chatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="chatInput" placeholder="" data-i18n-ph="chat_placeholder" />
    <button class="btn" id="chatSend" type="button" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
'use strict';

// 确保DOM完全加载后执行
document.addEventListener('DOMContentLoaded', function() {
  console.log('页面加载完成，开始初始化...');
  
  // 确保关键元素存在
  const ensureElements = () => {
    const requiredElements = ['genBtn', 'birthdate', 'result'];
    requiredElements.forEach(id => {
      if (!document.getElementById(id)) {
        console.error(`缺少必要元素: ${id}`);
      }
    });
  };
  
  ensureElements();
  
  // 设置默认日期
  const birthdateInput = document.getElementById('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    birthdateInput.value = `${year}-${month}-${day}`;
  }
  
  // 初始化多语言
  if (typeof applyI18n === 'function') {
    try {
      applyI18n();
    } catch (e) {
      console.error('多语言初始化失败:', e);
    }
  }
});

/* ================== 配置 & 工具 ================== */
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:8787' 
  : 'https://throbbing-lab-1440.hello5xliving.workers.dev';

const $ = id => document.getElementById(id);
function showErr(msg){ const e=$("error"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
function showAuthErr(msg){ const e=$("authError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideAuthErr(){ const e=$("authError"); if(!e) return; e.style.display="none"; e.textContent=""; }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ---------- 更稳的网络助手：状态码/超时/非 JSON ---------- */
async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors',
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){
    return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') };
  }finally{
    clearTimeout(timer);
  }
}

/* ================== 多语言（仅 zh-CN / en / ja / th / ms） ================== */
const LANG_KEY="site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

const translations = {
  "zh-CN": {
    // —— 通用 / 顶部与表单 ——
    lang_label: "语言",
    btn_register: "注册账户",
    btn_login: "登入账户",
    btn_reset: "🔑 重设密码",
    note_price: "注册账号赠送一次免费体验",
    note_price1: "$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",

    err_need_ep: "请输入邮箱与密码",
    err_pwd_rule: "密码至少8位，需包含大写/小写/数字/特殊符号",
    err_no_account: "账户不存在，请先注册",
    err_wrong_pwd: "密码错误",
    err_expired: "会员已过期，请续费",
    err_login_fail: "登入失败：",
    err_register_fail: "注册失败：",
    err_email_empty: "邮箱不能为空",
    err_pwd_empty: "密码不能为空",
    err_reset_fail: "重设密码失败：",

    prompt_email: "请输入注册邮箱：",
    prompt_newpwd: "请输入新密码（至少8位，含大小写、数字、符号）：",

    btn_upgrade: "💎 升级为 VIP（月费）",
    btn_backshop: "← 返回命理商城",

    vip_title: "🌙 会员区域 VIP Segment",
    vip_mingli: "🗝 命理空间专属内容",
    vip_xinlian: "🌙 心怜空间专属内容",
    vip_love: "姻缘方向：恋爱缘分、婚姻走势",
    vip_career: "事业方向：职场发展、创业潜力",
    vip_wealth: "财运方向：财位分析、理财时机",
    vip_pet: "宠物命理：伴侣动物的性格与缘分",
    vip_hepan: "合盘分析：婚期择日、新生择时",
    vip_name: "测名分析：公司名、宝宝名、命名改运",
    vip_fengshui: "财位合盘：住家 / 办公室动线配合",
    vip_record: "灵性记录：照片、梦境、声音、愿望祈祷",
    vip_course: "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    vip_memorial: "家族纪念系统：亲人灵性纪念 & 延续",
    vip_tasks: "每周能量练习 / 神明仪式任务",
    vip_shop: "能量商城专属折扣 & 御守订制",
    login_title: "💎 登入 VIP 功能",

    chat_fab: "问",
    chat_placeholder: "请问您想了解什么？（如：如何开始免费体验）",
    chat_send: "发送",
    msg_reset_ok: "密码已成功更新，请用新密码重新登入。",

    ph_email: "邮箱 Email",
    ph_password: "密码 Password（至少8位，含大小写数字符号）",
    ph_label_password: "密码 Password",

    title_quickcalc: "八字命理 · 快速排盘",
    title_bazi_brief: "八字简评",
    label_name: "姓名（可选）",
    ph_name: "你的称呼（用于个性化）",
    gender_label: "性别",
    label_calendar: "历法",
    label_birthdate: "出生日期",
    label_birthtime: "出生时间",
    cb_time_unknown: "出生时间不详",
    btn_generate_chart: "生成八字",
    panel_login_head: "账户登录 / 注册",
    panel_member_head: "会员服务",

    // 下拉项
    opt_gender_confidential: "不透露",
    opt_gender_male: "男性",
    opt_gender_female: "女性",
    opt_cal_gregorian: "阳历",
    opt_cal_lunar: "农历",

    elements_balance_tpl: "五行中{max}元素最强，{min}元素最弱。",

    // —— Butler / Report keys（中文） ——
    butler_title: "心怜管家 · 解读",
    day_master: "日主",
    chart_strength: "命局",
    season: "季节",
    wuxing_distribution: "五行分布",
    note: "注意",
    time_unknown_checked: "已勾选'出生时间不详'",
    hour_pillar_excluded: "未纳入时柱",
    hint: "提示",
    no_hour_tip: "无时柱，建议仅作参考。",
    dev_strategy: "发展策略：",
    useful_elements: "喜用元素：",
    lucky_colors: "幸运颜色：",
    lucky_directions: "适合方位：",
    strength_strong: "偏强",
    strength_weak: "偏弱",
    strength_balanced: "平衡",
    desc_strong: "潜力足、抗压好",
    desc_weak: "需外援更能发挥",
    desc_balanced: "均衡、适应性强",
    desc_generic: "具有独特特点",
    season_spring: "木旺生发",
    season_summer: "火旺外放",
    season_autumn: "金旺收敛",
    season_winter: "水旺内藏",
    season_generic: "季节对命局有一定影响",
    el_wood: "木",
    el_fire: "火",
    el_earth: "土",
    el_metal: "金",
    el_water: "水",
    dir_wood: "东方",
    dir_fire: "南方",
    dir_earth: "中央/东北/西南",
    dir_metal: "西方",
    dir_water: "北方",
    color_wood: "绿色/青色",
    color_fire: "红色/紫色",
    color_earth: "黄色/棕色",
    color_metal: "白色/金色",
    color_water: "黑色/蓝色",

    // 报告分段
    rpt_free_title: "免费简报",
    rpt_pillars_label: "四柱",
    rpt_daymaster_label: "日主",
    rpt_season_label: "季节",
    rpt_chart_label: "命局",
    rpt_strategy_label: "策略",
    rpt_wuxing_label: "五行分布",
    rpt_strongest_word: "偏旺",
    rpt_weakest_word: "偏弱",
    rpt_absent_prefix: "缺：",
    rpt_fav_avoid_template: "喜用：{fav}｜忌：{avoid}",
    rpt_balance_focus_label: "调衡要点",
    rpt_time_hint: "提示：出生时间不详，未纳入时柱，仅供参考。",
    rpt_time_unknown: "时间不详",
    rpt_sec_overview_title: "一、命盘总览",
    rpt_sec_elements_title: "二、五行能量分析",
    rpt_sec_traits_title: "三、性格与天赋",
    rpt_traits_intro: "依据日主、季节与强弱给出核心性格标签（模板化占位）。",
    rpt_traits_adv: "优势能量：执行 / 创造 / 学习（模板化占位）。",
    rpt_traits_chal: "潜在挑战：节奏 / 边界 / 过犹不及（模板化占位）。",
    rpt_sec_structure_title: "四、格局与喜忌",
    rpt_structure_line_template: "喜用：{fav}；忌讳：{avoid}",
    rpt_sec_career_title: "五、事业与发展（免费试读）",
    rpt_career_fields_placeholder: "适合领域：结合喜用与气质（模板化占位）。",
    rpt_dev_strategy_prefix: "发展策略：",
    rpt_sec_love_title: "六、感情与关系（免费试读）",
    rpt_love_placeholder: "沟通节奏与边界建议（模板化占位）。",
    rpt_sec_wealth_title: "七、财富与理财（免费试读）",
    rpt_wealth_suggestion_template: "理财建议：以 {fav} 为主调，稳中求进。",
    rpt_sec_health_title: "八、健康与作息",
    rpt_health_placeholder_template: "围绕最弱五行（{weak}）做作息与环境优化（模板化占位）。",
    rpt_sec_env_title: "九、环境与色彩",
    rpt_env_placeholder: "有利方位与配色随喜用（模板化占位）。",
    rpt_strategy_drain: "泄秀/制化",
    rpt_strategy_support: "生扶/补助",
    rpt_strategy_balance: "调和",

    // AI 芯片 & 任务
    chip_career: "事业",
    chip_love: "感情",
    chip_money: "财运",
    chip_list: "今日待办",
    chip_30d: "30天建议",

    q_career: "请结合我的八字日主、季节、强弱与五行比例，给我职业发展建议：适合行业、岗位风格、短期突破点，尽量落地、可执行。",
    q_love: "请结合八字信息，给出恋爱/婚姻建议：择偶倾向、相处节奏、沟通边界、容易踩的坑与修正办法。",
    q_money: "请结合八字信息，给出未来半年财运与理财建议：现金流、风险与稳健比例、开支结构优化，列出具体行动清单。",
    q_list: "基于我的八字结构，生成'今日待办'的3-5条具体行动，要求可执行、可量化，附小提醒与时间建议。",
    q_30d: "结合我的弱项五行，给我一份连续30天的小练习清单（每天1条），用于调衡/巩固，尽量简单且可坚持。"
  },

  "en": {
    // —— Common / Form ——
    lang_label: "Language",
    btn_register: "Create Account",
    btn_login: "Log in",
    btn_reset: "🔑 Reset Password",
    note_price: "New account gets one free trial.",
    note_price1: "$9.9 / month · VIP (Astro + Soul + Courses)",

    err_need_ep: "Enter email and password",
    err_pwd_rule: "Password must be 8+ and include upper/lowercase, number, symbol",
    err_no_account: "Account not found. Please register first.",
    err_wrong_pwd: "Incorrect password",
    err_expired: "Membership expired. Please renew.",
    err_login_fail: "Login failed: ",
    err_register_fail: "Registration failed: ",
    err_email_empty: "Email cannot be empty",
    err_pwd_empty: "Password cannot be empty",
    err_reset_fail: "Password reset failed: ",

    prompt_email: "Enter your registered email:",
    prompt_newpwd: "Enter a new password (8+, upper/lower/digit/symbol):",

    btn_upgrade: "💎 Upgrade to VIP (Monthly)",
    btn_backshop: "← Back to Store",

    vip_title: "🌙 VIP Segment",
    vip_mingli: "🗝 Astro Sanctuary · Exclusive",
    vip_xinlian: "🌙 Soul Sanctuary · Exclusive",
    vip_love: "Love: Dating Fate, Marriage Trend",
    vip_career: "Career: Workplace, Entrepreneurship",
    vip_wealth: "Wealth: Wealth Position, Timing",
    vip_pet: "Pet Destiny: Temperament & Bond",
    vip_hepan: "Synastry: Wedding Dates, Birthtime",
    vip_name: "Name Reading: Company/Baby/Renaming",
    vip_fengshui: "Wealth & Layout: Home / Office",
    vip_record: "Spiritual Logs: Photos, Dreams, Voice, Prayers",
    vip_course: "Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
    vip_memorial: "Family Memorial: Spiritual Archive & Legacy",
    vip_tasks: "Weekly Energy Practices / Divine Ritual Tasks",
    vip_shop: "Store Discounts & Omamori",
    login_title: "💎 VIP Login",

    chat_fab: "Chat",
    chat_placeholder: "What would you like to know? (e.g., how to start the free trial)",
    chat_send: "Send",
    msg_reset_ok: "Password updated. Please log in with the new one.",

    ph_email: "Email",
    ph_password: "Password (8+, upper/lower/digit/symbol)",
    ph_label_password:"Password",

    title_quickcalc: "Bazi · Quick Chart",
    title_bazi_brief: "Bazi Quick Reading",
    label_name: "Name (optional)",
    ph_name: "Your name (for personalization)",
    gender_label: "Gender",
    label_calendar: "Calendar",
    label_birthdate: "Birth Date",
    label_birthtime: "Birth Time",
    cb_time_unknown: "Birth time unknown",
    btn_generate_chart: "Generate Chart",
    panel_login_head: "Account Login / Sign-up",
    panel_member_head: "Membership Services",

    opt_gender_confidential: "Confidential",
    opt_gender_male: "Male",
    opt_gender_female: "Female",
    opt_cal_gregorian: "Gregorian",
    opt_cal_lunar: "Lunar",

    elements_balance_tpl: "Strongest: {max} · Weakest: {min}",

    // —— Butler / Report keys（English） ——
    butler_title: "Xinlian Butler · Insight",
    day_master: "Day Master",
    chart_strength: "Chart Strength",
    season: "Season",
    wuxing_distribution: "Five Elements",
    note: "Note",
    time_unknown_checked: "Birth time unknown is checked",
    hour_pillar_excluded: "Hour pillar not included",
    hint: "Hint",
    no_hour_tip: "No hour pillar — treat as reference only.",
    dev_strategy: "Development strategy: ",
    useful_elements: "Favorable elements: ",
    lucky_colors: "Lucky colors: ",
    lucky_directions: "Lucky directions: ",
    strength_strong: "Strong-leaning",
    strength_weak: "Weak-leaning",
    strength_balanced: "Balanced",
    desc_strong: "High potential and stress-tolerant",
    desc_weak: "Works better with external support",
    desc_balanced: "Well-balanced and adaptable",
    desc_generic: "Has unique characteristics",
    season_spring: "Wood thrives; outward growth",
    season_summer: "Fire thrives; expression/outflow",
    season_autumn: "Metal thrives; organize/refine",
    season_winter: "Water thrives; conserve/reflect",
    season_generic: "Seasonal qi has some influence",
    el_wood: "Wood",
    el_fire: "Fire",
    el_earth: "Earth",
    el_metal: "Metal",
    el_water: "Water",
    dir_wood: "East",
    dir_fire: "South",
    dir_earth: "Center/NE/SW",
    dir_metal: "West",
    dir_water: "North",
    color_wood: "Green/Teal",
    color_fire: "Red/Purple",
    color_earth: "Yellow/Brown",
    color_metal: "White/Gold",
    color_water: "Black/Blue",

    rpt_free_title: "Free Summary",
    rpt_pillars_label: "Pillars",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "Season",
    rpt_chart_label: "Chart",
    rpt_strategy_label: "Strategy",
    rpt_wuxing_label: "Five Elements",
    rpt_strongest_word: "strongest",
    rpt_weakest_word: "weakest",
    rpt_absent_prefix: "Absent: ",
    rpt_fav_avoid_template: "Favorable: {fav} | Avoid: {avoid}",
    rpt_balance_focus_label: "Balance focus",
    rpt_time_hint: "Note: birth time unknown; hour pillar excluded—use as reference only.",
    rpt_time_unknown: "Unknown time",
    rpt_sec_overview_title: "1) Overview",
    rpt_sec_elements_title: "2) Element Analysis",
    rpt_sec_traits_title: "3) Traits & Talents",
    rpt_traits_intro: "Core trait tags based on DM, season, and strength (placeholder).",
    rpt_traits_adv: "Advantages: Execution / Creativity / Learning (placeholder).",
    rpt_traits_chal: "Challenges: Pace / Boundaries (placeholder).",
    rpt_sec_structure_title: "4) Structure & Preferences",
    rpt_structure_line_template: "Favorable: {fav}; Avoid: {avoid}",
    rpt_sec_career_title: "5) Career (sample)",
    rpt_career_fields_placeholder: "Suitable fields (placeholder).",
    rpt_dev_strategy_prefix: "Development strategy: ",
    rpt_sec_love_title: "6) Love (sample)",
    rpt_love_placeholder: "Communication pace & boundaries (placeholder).",
    rpt_sec_wealth_title: "7) Wealth (sample)",
    rpt_wealth_suggestion_template: "Wealth tip: prefer flows aligned with {fav}.",
    rpt_sec_health_title: "8) Health",
    rpt_health_placeholder_template: "Care for weakest element: {weak}.",
    rpt_sec_env_title: "9) Environment & Colors",
    rpt_env_placeholder: "Favorable directions & palette follow your favorable elements.",
    rpt_strategy_drain: "Drain/Control",
    rpt_strategy_support: "Support/Nourish",
    rpt_strategy_balance: "Balance",

    chip_career: "Career",
    chip_love: "Love",
    chip_money: "Wealth",
    chip_list: "Today's To-Dos",
    chip_30d: "30-Day Plan",

    q_career: "Using my Bazi day master, season, strength, and element ratios, give practical career advice: suitable industries/roles and near-term breakthroughs.",
    q_love: "Using my Bazi info, give relationship/marriage advice: partner tendencies, communication pace, boundaries, pitfalls and fixes.",
    q_money: "Using my Bazi info, give wealth advice for the next 6 months: cashflow, risk vs. safety mix, and concrete budget/expense actions.",
    q_list: "Based on my Bazi structure, create 3–5 actionable, measurable to-dos for today, with small reminders and time suggestions.",
    q_30d: "Using my weakest element, design a 30-day micro-habit plan (1 item/day) for balance; keep it simple and sustainable."
  }
};

function t(key){
  const L = translations[getLang()] || translations["zh-CN"];
  return L[key] || (translations["zh-CN"][key] || key);
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
  
function ELABEL(){
  return {
    wood:  t('el_wood'),
    fire:  t('el_fire'),
    earth: t('el_earth'),
    metal: t('el_metal'),
    water: t('el_water'),
  };
}

// 初始化多语言
document.addEventListener('DOMContentLoaded', function() {
  applyI18n();
});

/* ⬇️ 就貼在這裡（在上面這段 applyI18n() 初始化的「下面」） */
// 语言切换（只负责切换文案 + 可能的重渲染）
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('langSelect');
  if (!sel) return;

  // 让下拉框显示本地存储语言
  try { sel.value = getLang(); } catch {}

  sel.addEventListener('change', (e) => {
    setLang(e.target.value);
    applyI18n();

// 八字生成功能（独立于语言切换；不要放进上面的 change 回调）
document.addEventListener('DOMContentLoaded', () => {
  const genBtn = document.getElementById('genBtn');
  if (!genBtn) return;

  genBtn.addEventListener('click', function () {
    const name = document.getElementById('name').value;
    const birthdate = document.getElementById('birthdate').value;
    const birthtime = document.getElementById('birthtime').value;
    const timeUnknown = document.getElementById('timeUnknown').checked;

    if (!birthdate) {
      showErr('请选择出生日期');
      return;
    }

    generateBazi(name, birthdate, birthtime, timeUnknown);
    document.getElementById('result')?.scrollIntoView({ behavior: 'smooth' });
  });
});    

    // 若已有一次命盤，重渲染專業報告以套用新語言
    const ctx = window.__last_report__;
    if (ctx?.pillars?.day?.stem && window.BaziUltra) {
      const ps = [
        [ctx.pillars.year.stem,  ctx.pillars.year.branch],
        [ctx.pillars.month.stem, ctx.pillars.month.branch],
        [ctx.pillars.day.stem,   ctx.pillars.day.branch],
        ctx.timeUnknown ? ['-','-'] : [ctx.pillars.hour.stem, ctx.pillars.hour.branch]
      ];
      window.BaziUltra.render({
        mountId:'chartReport',
        name: document.getElementById('name')?.value || '',
        gender: document.getElementById('gender')?.selectedOptions?.[0]?.text || '',
        birth: document.getElementById('birthtime')?.value
          ? `${document.getElementById('birthdate').value} ${document.getElementById('birthtime').value}`
          : `${document.getElementById('birthdate').value}${ctx.timeUnknown ? `（${t('rpt_time_unknown')||'时间不详'}）` : ''}`,
        location:'',
        dayStem: ctx.pillars.day.stem,
        pillars: ps
      });
    }

// 八字生成功能
document.getElementById('genBtn').addEventListener('click', function() {
  const name = document.getElementById('name').value;
  const birthdate = document.getElementById('birthdate').value;
  const birthtime = document.getElementById('birthtime').value;
  const timeUnknown = document.getElementById('timeUnknown').checked;
  
  // 简单验证
  if (!birthdate) {
    showErr('请选择出生日期');
    return;
  }

  // 模拟八字计算
  generateBazi(name, birthdate, birthtime, timeUnknown);
});

function generateBazi(name, date, time, timeUnknown) {
  // 顯示結果區
  document.getElementById('result').style.display = 'block';

  // —— 模擬四柱數據（替換為你的真實計算結果即可）——
  const y = { stem:'甲', branch:'子', element:'木', nayin:'海中金' };
  const m = { stem:'乙', branch:'丑', element:'木', nayin:'海中金' };
  const d = { stem:'丙', branch:'寅', element:'火', nayin:'炉中火' };
  const h = timeUnknown
    ? { stem:'-', branch:'-', element:'-', nayin:'-' }
    : { stem:'丁', branch:'卯', element:'火', nayin:'炉中火' };

  // —— 頂部四卡 —— 
  const pillars = [
    { title:'年柱', ganZhi:`${y.stem}${y.branch}`, element:y.element },
    { title:'月柱', ganZhi:`${m.stem}${m.branch}`, element:m.element },
    { title:'日柱', ganZhi:`${d.stem}${d.branch}`, element:d.element },
    { title:'时柱', ganZhi: timeUnknown ? (t('rpt_time_unknown') || '時間不詳') : `${h.stem}${h.branch}`, element: h.element }
  ];
  const pillarsContainer = document.getElementById('bazi-pillars');
  if (pillarsContainer) {
    pillarsContainer.innerHTML = pillars.map(p => `
      <div class="pillar">
        <div class="tit">${p.title}</div>
        <div class="gz">${p.ganZhi}</div>
        <div class="tit">${p.element}</div>
      </div>
    `).join('');
  }

  // —— 表格填值 —— 
  const setCell = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  setCell('year-stem',   y.stem);   setCell('year-branch',  y.branch);  setCell('year-element', y.element); setCell('year-nayin', y.nayin);
  setCell('month-stem',  m.stem);   setCell('month-branch', m.branch);  setCell('month-element',m.element); setCell('month-nayin',m.nayin);
  setCell('day-stem',    d.stem);   setCell('day-branch',   d.branch);  setCell('day-element',  d.element); setCell('day-nayin',  d.nayin);
  setCell('hour-stem',   h.stem);   setCell('hour-branch',  h.branch);  setCell('hour-element', h.element); setCell('hour-nayin', h.nayin);

  // —— 日期提示 —— 
  const dd = document.getElementById('bazi-date');
  if (dd) dd.textContent = timeUnknown ? `${date}（${t('rpt_time_unknown') || '時間不詳'}）` : `${date} ${time}`;

  // —— 五行百分比（示例數據）——
  const elements = { '木':30, '火':25, '土':20, '金':15, '水':10 };
  Object.keys(elements).forEach(k => {
    const pct = elements[k];
    const bar = document.getElementById(`bar-${k}`);
    const label = document.getElementById(`pct-${k}`);
    if (bar)   bar.style.width = `${pct}%`;
    if (label) label.textContent = `${pct}%`;
  });
  const balance = document.getElementById('bazi-elements-balance');
  if (balance) {
    const maxEl = '木', minEl = '水'; // 示例
    balance.textContent = (t('elements_balance_tpl') || '五行中{max}元素最強，{min}元素最弱。')
      .replace('{max}', maxEl).replace('{min}', minEl);
  }

  // —— 存上下文給 AI 卡片 —— 
  window.__last_report__ = {
    pillars: {
      year:{ stem:y.stem, branch:y.branch, element:y.element },
      month:{ stem:m.stem, branch:m.branch, element:m.element },
      day:{ stem:d.stem, branch:d.branch, element:d.element },
      hour:{ stem:h.stem, branch:h.branch, element:h.element }
    },
    percents: { wood:30, fire:25, earth:20, metal:15, water:10 },
    st: { season:'', mark:'', focus:'' },
    adv:{ useful:['木','火'], avoid:['金'] },
    timeUnknown: !!timeUnknown
  };

  // —— 渲染 Ultra 專業報告（放在 y/m/d/h 之後；不要 <script> 包裹）——
  try {
    if (window.BaziUltra) {
      const genderVal = (document.getElementById('gender')?.value) || '';
      const genderTxt = genderVal==='male'
        ? (t('opt_gender_male') || '男性')
        : (genderVal==='female' ? (t('opt_gender_female') || '女性') : (t('opt_gender_confidential') || '—'));
      const pillarsData = [
        [y.stem, y.branch],
        [m.stem, m.branch],
        [d.stem, d.branch],
        timeUnknown ? ['-','-'] : [h.stem, h.branch]
      ];
      window.BaziUltra.render({
        mountId:'chartReport',
        name: (name||''),
        gender: genderTxt,
        birth: timeUnknown ? `${date}（${t('rpt_time_unknown') || '時間不詳'}）` : `${date} ${time}`,
        location: '',
        dayStem: d.stem,
        pillars: pillarsData
        // peekYear / luckPillars 之後接你的後端再傳入
      });
    }
  } catch (e) {
    console.error('BaziUltra 渲染失敗：', e);
  }

  // —— 啟動/刷新 AI 卡片 —— 
  if (typeof mountButlerCard === 'function') { mountButlerCard(); }
  });
});
  
  // 滾動到結果
  document.getElementById('result')?.scrollIntoView({ behavior: 'smooth' });
}

// 浮窗聊天功能
(function(){
  const fab   = document.getElementById('chatFab');
  const panel = document.getElementById('chatPanel');
  const close = document.getElementById('chatClose');
  const body  = document.getElementById('chatBody');
  const input = document.getElementById('chatInput');
  const send  = document.getElementById('chatSend');

  function toggle(open){ panel.style.display = open ? 'block' : 'none'; if (open) setTimeout(()=>input.focus(), 50); }
  function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  function append(role, html){
    const div=document.createElement('div');
    div.className='ss-msg'+(role==='me'?' me':'');
    div.innerHTML=html;
    body.appendChild(div);
    body.scrollTop=body.scrollHeight;
    return div;
  }

  async function doSend(){
    const text = input.value.trim(); if (!text) return;
    append('me', escHtml(text).replace(/\n/g,'<br/>'));
    input.value='';

    const thinking = append('bot', '…');
    try{
      // 模拟AI回复
      setTimeout(() => {
        thinking.innerHTML = '感谢您的提问！这是一个模拟回复。在实际应用中，这里会连接到AI服务提供个性化的八字解读和建议。';
      }, 1000);
    }catch(e){
      thinking.textContent = '（发送失败）';
    }
  }

  fab?.addEventListener('click', ()=>toggle(true));
  close?.addEventListener('click', ()=>toggle(false));
  send?.addEventListener('click', doSend);
  input?.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }});
})();

// AI卡片功能
(function(){
  const BUTLER_LANG_NAME = {
    'zh-CN': 'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };
  const qs = (sel)=>document.querySelector(sel);
  const isVIP = () => (localStorage.getItem('vipStatus') === 'active') || !!localStorage.getItem('vipEmail');
  const nowLang = () => (typeof getLang==='function'?getLang(): (document.documentElement.lang||'zh-CN'));
  const LNAME = () => BUTLER_LANG_NAME[nowLang()] || BUTLER_LANG_NAME['zh-CN'];

  function mdToHtml(md=''){
    return String(md)
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n').replace(/\n/g,'<br/>');
  }
  function safeCtx(){
    const ctx = (window.__last_report__ && typeof window.__last_report__==='object') ? window.__last_report__ : {};
    const def = { pillars:{}, percents:{}, st:{}, adv:{}, timeUnknown:false };
    return Object.assign(def, ctx);
  }
  function strongWeak(percents={}){
    const arr = [['wood',percents.wood??0],['fire',percents.fire??0],['earth',percents.earth??0],['metal',percents.metal??0],['water',percents.water??0]];
    const strongest = arr.reduce((a,b)=> a[1]>=b[1]?a:b)[0];
    const weakest   = arr.reduce((a,b)=> a[1]<=b[1]?a:b)[0];
    return { strongest, weakest };
  }

  // 卡片渲染
  function ensureAiCard(){
    const host = document.getElementById('result') || document.body;
    let card = document.getElementById('aiCard');
    if (card && card.parentElement !== host) host.appendChild(card);
    if (card) return card;
    card = document.createElement('div');
    card.className='card ai-card';
    card.id='aiCard';
    card.innerHTML = `
      <div class="h2" id="butlerTitle">${t('butler_title') || '心怜管家 · 解读'}</div>
      <div id="aiContent" class="ai-content">
        <div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div></div>
      </div>
      <div class="chips" id="aiChips"></div>`;
    host.appendChild(card);
    renderChips();
    return card;
  }
  function mainLabel(){
    const L = nowLang();
    if (L.startsWith('zh')) return '主（当前渲染资料）';
    if (L==='en') return 'Main (Current Data)';
    if (L==='ja') return '主（現在のデータ）';
    if (L==='th') return 'หลัก (ข้อมูลปัจจุบัน)';
    if (L==='ms') return 'Utama (Data Semasa)';
    return 'Main';
  }
  function renderChips(){
    const wrap = document.getElementById('aiChips');
    if(!wrap) return;
    wrap.innerHTML='';
    const items = [
      { label: mainLabel(), topic:'current' },
      { label: t('chip_career'), topic:'career', q:t('q_career') },
      { label: t('chip_love'),   topic:'love',   q:t('q_love')   },
      { label: t('chip_money'),  topic:'money',  q:t('q_money')  },
      { label: t('chip_list'),   topic:'list',   q:t('q_list')   },
      { label: t('chip_30d'),    topic:'30d',    q:t('q_30d')    },
    ];
    items.forEach(it=>{
      const b=document.createElement('button');
      b.className='chip';
      b.textContent=it.label||'';
      if (it.q) b.dataset.q = it.q;
      b.dataset.topic = it.topic;
      wrap.appendChild(b);
    });
  }

  // 主视图
  function renderCurrent(){
    ensureAiCard();
    const out=document.getElementById('aiContent');
    if(!out) return;
    const ctx=safeCtx();
    const { pillars={}, percents={}, st={}, adv={}, timeUnknown }=ctx;
    const E= ELABEL?ELABEL():{wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
    const elemLine=[`${E.wood} ${Math.round(percents.wood||0)}%`,`${E.fire} ${Math.round(percents.fire||0)}%`,`${E.earth} ${Math.round(percents.earth||0)}%`,`${E.metal} ${Math.round(percents.metal||0)}%`,`${E.water} ${Math.round(percents.water||0)}%`].join(' · ');
    const hourTxt=timeUnknown ? (t('rpt_time_unknown')||'时间不详') : `${pillars?.hour?.stem||''}${pillars?.hour?.branch||''}`;
    const md=[`### ${nowLang().startsWith('zh')?'当前渲染资料':'Current Context'}`,`- 年柱：${(pillars?.year?.stem||'')}${(pillars?.year?.branch||'')}`,`- 月柱：${(pillars?.month?.stem||'')}${(pillars?.month?.branch||'')}`,`- 日柱：${(pillars?.day?.stem||'')}${(pillars?.day?.branch||'')}`,`- 时柱：${hourTxt}`,`- 季节/强弱：${st?.season||''} / ${st?.mark||''}`,`- 策略：${st?.focus||''}`,`- 五行：${elemLine}`,(adv?.useful?.length || adv?.avoid?.length)?`- 喜用/忌：${(adv.useful||[]).join('/') || '-'} / ${(adv.avoid||[]).join('/') || '-'}`:'' ].filter(Boolean).join('\n');
    out.innerHTML = mdToHtml(md);
    const aiCard=document.getElementById('aiCard');
    aiCard.dataset.lastTopic='current';
    aiCard.dataset.lastQ='__current__';
    aiCard.dataset.lang=nowLang();
  }

  // 专题渲染
  async function renderTopic(topicType,qText){
    ensureAiCard();
    const out=document.getElementById('aiContent');
    if(!out) return;
    const chips=document.getElementById('aiChips');
    out.innerHTML=`<div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div></div>`;
    chips?.querySelectorAll('.chip').forEach(c=>{ c.disabled=true; c.style.opacity=.6; });
    
    // 模拟AI处理
    setTimeout(() => {
      let text = '';
      if (topicType === 'career') {
        text = '**事业建议**\n\n基于您的八字分析，建议您考虑以下职业方向：\n- 创意设计类工作\n- 教育培训行业\n- 文化艺术领域\n\n您的命局显示您有较强的表达能力和创造力，适合需要发挥个人才华的工作环境。';
      } else if (topicType === 'love') {
        text = '**感情建议**\n\n在感情方面，建议您：\n- 寻找性格互补的伴侣\n- 注重精神层面的交流\n- 保持适当的个人空间\n\n您的命局显示您重视深度连接，但也需要保持一定的独立性。';
      } else {
        text = `**${topicType} 分析**\n\n这是关于${topicType}的个性化建议。基于您的八字命盘，我们为您提供了专业的分析和指导。`;
      }
      
      out.innerHTML = mdToHtml(text);
      chips?.querySelectorAll('.chip').forEach(c=>{ c.disabled=false; c.style.opacity=1; });
      
      const aiCard=document.getElementById('aiCard');
      aiCard.dataset.lastTopic = topicType||'generic';
      aiCard.dataset.lastQ = qText||'';
      aiCard.dataset.lang = nowLang();
    }, 1500);
  }

  // 首屏挂载
  window.mountButlerCard = function(){ ensureAiCard(); renderCurrent(); };

  // 事件
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.chip');
    if(!btn) return;
    const topic=btn.dataset.topic||'current';
    if (topic==='current'){ renderCurrent(); return; }
    const q=btn.dataset.q||topic;
    renderTopic(topic,q);
  });

  // 给浮窗复用的轻量 API
  window.ButlerAPI = {
    chat: async () => ({ ok: true, data: { reply: '这是模拟的AI回复' } }),
    extract: (data) => data.reply || '',
    sysPrompt: () => 'You are a concise Bazi assistant.',
    userPrompt: (text, topic, ctx) => `User question: ${text}`,
    safeCtx,
    mdToHtml
  };
})();

/* =========================================================
  Bazi Ultra Renderer · v4 (i18n-ready, 离线·零依赖)
  - 四柱明干/藏干 + 十神（任意日主）
  - 五行统计（权重可调）
  - 合/会/冲/刑/害（提示）
  - 用神/平衡建议（基于失衡导向）
  - 年度提示（干支十神 + 支五行侧重点）
  - 月份能量带（节气序）
  - 大运时间线（可选）
  - 导出：打印PDF / 复制摘要 / 导出JSON
========================================================= */
(function(){
'use strict';

const MOUNT_ID='chartReport';

/* ---------- i18n helpers ---------- */
function hasI18n(){ return typeof window.t === 'function'; }
function tr(key, fallback){
  try{
    if(!hasI18n()) return fallback;
    const v = window.t(key);
    return (v && v !== key) ? v : fallback;
  }catch{ return fallback; }
}
function trf(key, fallback, params){
  let s = tr(key, fallback);
  if(params) Object.keys(params).forEach(k=>{
    s = s.replace(new RegExp('\\{'+k+'\\}','g'), params[k]);
  });
  return s;
}

/* ---------- 基础字典 ---------- */
const stems = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const stemInfo={
  甲:{el:'木',yang:true}, 乙:{el:'木',yang:false},
  丙:{el:'火',yang:true}, 丁:{el:'火',yang:false},
  戊:{el:'土',yang:true}, 己:{el:'土',yang:false},
  庚:{el:'金',yang:true}, 辛:{el:'金',yang:false},
  壬:{el:'水',yang:true}, 癸:{el:'水',yang:false}
};
const branchOrder=['寅','卯','辰','巳','午','未','申','酉','戌','亥','子','丑']; // 节气月序
const branchInfo={
  子:{el:'水',yang:true,  hidden:['癸']},
  丑:{el:'土',yang:false, hidden:['己','癸','辛']},
  寅:{el:'木',yang:true,  hidden:['甲','丙','戊']},
  卯:{el:'木',yang:false, hidden:['乙']},
  辰:{el:'土',yang:true,  hidden:['戊','乙','癸']},
  巳:{el:'火',yang:false, hidden:['丙','戊','庚']},
  午:{el:'火',yang:true,  hidden:['丁','己']},
  未:{el:'土',yang:false, hidden:['己','丁','乙']},
  申:{el:'金',yang:true,  hidden:['庚','壬','戊']},
  酉:{el:'金',yang:false, hidden:['辛']},
  戌:{el:'土',yang:true,  hidden:['戊','辛','丁']},
  亥:{el:'水',yang:false, hidden:['壬','甲']}
};
/* 六合/三合/冲/刑/害（简） */
const liuHe = {子:'丑', 丑:'子', 寅:'亥', 亥:'寅', 卯:'戌', 戌:'卯', 辰:'酉', 酉:'辰', 巳:'申', 申:'巳', 午:'未', 未:'午'};
const sanHe = [['申','子','辰','水'], ['寅','午','戌','火'], ['亥','卯','未','木'], ['巳','酉','丑','金']];
const chongPairs = [['子','午'],['丑','未'],['寅','申'],['卯','酉'],['辰','戌'],['巳','亥']];
const xingHints = [['子','卯'],['寅','巳'],['巳','申'],['申','寅'],['丑','戌','未'],['辰','午','酉','亥']];
const haiPairs = [['子','未'],['丑','午'],['寅','巳'],['卯','辰'],['申','亥'],['酉','戌']];

/* ---------- DOM helpers ---------- */
const $=id=>document.getElementById(id);
function el(tag,cls,txt){const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e;}
function injectStyle(){
  if($('#bazi-ultra-style')) return;
  const css=`
  .sec{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px 18px;margin:16px 0;box-shadow:var(--shadow)}
  .h{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .h h3{margin:0;color:var(--brand)}
  .muted{color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px}
  .tbl{width:100%;border-collapse:collapse;margin-top:8px}
  .tbl th,.tbl td{border:1px solid var(--line);padding:8px 10px;text-align:center}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:center}
  .bar{height:10px;border-radius:6px;background:linear-gradient(90deg, rgba(212,175,55,.95), rgba(212,175,55,.2))}
  .tips{margin:8px 0 0 0;padding-left:18px;line-height:1.85}
  .cta{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;text-decoration:none;color:var(--text);cursor:pointer;background:transparent}
  .badge{display:inline-block;color:var(--muted);border:1px solid var(--line);border-radius:8px;padding:2px 8px;margin-left:6px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  `;
  const s=document.createElement('style'); s.id='bazi-ultra-style'; s.textContent=css; document.head.appendChild(s);
}
function table(headers, rows){
  const t=el('table','tbl'), thead=el('thead'), trr=el('tr');
  headers.forEach(h=>trr.appendChild(el('th',null,h))); thead.appendChild(trr); t.appendChild(thead);
  const tb=el('tbody'); rows.forEach(r=>{ const tr=el('tr'); r.forEach(c=>tr.appendChild(el('td',null,c))); tb.appendChild(tr); }); t.appendChild(tb);
  return t;
}
function section(title, nodes){ const s=el('section','sec'); const h=el('div','h'); h.appendChild(el('h3',null,title)); s.appendChild(h); nodes.forEach(n=>s.appendChild(n)); return s; }

/* ---------- 十神（任意日主） ---------- */
const cycle = ['木','火','土','金','水']; // 生：木→火→土→金→水→木
function elIndex(E){return cycle.indexOf(E);}
function relOf(a,b){ // a(日主) 相对 b(他者)
  const ia=elIndex(a), ib=elIndex(b);
  if(ia===ib) return 'same';         // 比/劫
  if((ia+1)%5===ib) return 'output'; // 我生他：食/伤
  if((ia+2)%5===ib) return 'drain';  // 我克他：财
  if((ia+3)%5===ib) return 'control';// 他克我：官杀
  if((ia+4)%5===ib) return 'input';  // 他生我：印
  return '';
}
function tenGodGeneric(dayStem, otherStem){
  const d = stemInfo[dayStem], o = stemInfo[otherStem]; if(!d||!o) return '';
  const rel = relOf(d.el, o.el);
  const sameYang = (d.yang===o.yang);
  switch(rel){
    case 'same':   return sameYang? tr('tg.bijian','比肩') : tr('tg.jiecai','劫财');
    case 'output': return sameYang? tr('tg.shishen','食神') : tr('tg.shangguan','伤官');
    case 'drain':  return sameYang? tr('tg.piancai','偏财') : tr('tg.zhengcai','正财');
    case 'control':return sameYang? tr('tg.qisha','七杀')  : tr('tg.zhengguan','正官');
    case 'input':  return sameYang? tr('tg.pianyin','偏印') : tr('tg.zhengyin','正印');
    default: return '';
  }
}

/* ---------- 统计与结构 ---------- */
function hiddenStems(z){return (branchInfo[z]?.hidden)||[];}
function fiveOfStem(g){return stemInfo[g]?.el||'';}
function fiveOfBranch(z){return branchInfo[z]?.el||'';}
function countFive(pillars, wMain=1, wHidden=.5){
  const acc={木:0,火:0,土:0,金:0,水:0};
  pillars.forEach(([g,z])=>{ const eg=fiveOfStem(g); if(eg) acc[eg]+=wMain;
                              hiddenStems(z).forEach(h=>{ const eh=fiveOfStem(h); if(eh) acc[eh]+=wHidden; }); });
  return acc;
}
function relationTips(branches){
  const set=new Set(branches);
  const tips=[];
  // 六合
  branches.forEach(b=>{
    const p=liuHe[b];
    if(p && set.has(p)) tips.push(trf('rel.liuhe','{a}合{b}（六合）：彼此牵引、易成事',{a:b,b:p}));
  });
  // 三合
  sanHe.forEach(([a,b,c,elem])=>{
    const cnt = [a,b,c].filter(x=>set.has(x)).length;
    if(cnt===2) tips.push(trf('rel.sanhe.half','{a}{b}{c}半会{el}：该元素势增强',{a,b,c,el:elem}));
    if(cnt===3) tips.push(trf('rel.sanhe.full','{a}{b}{c}三会{el}：该元素主导明显',{a,b,c,el:elem}));
  });
  // 冲
  chongPairs.forEach(([a,b])=>{
    if(set.has(a)&&set.has(b)) tips.push(trf('rel.chong','{a}冲{b}：结构拉扯、节律易变',{a,b}));
  });
  // 刑
  xingHints.forEach(group=>{
    const cnt = group.filter(x=>set.has(x)).length;
    if(cnt>=2) tips.push(trf('rel.xing', '{g}相刑：需以规则化解内耗',{g:group.join('、')}));
  });
  // 害
  haiPairs.forEach(([a,b])=>{
    if(set.has(a)&&set.has(b)) tips.push(trf('rel.hai','{a}害{b}：小人/误解/暗耗，重边界',{a,b}));
  });
  // 自刑：午午
  if(branches.filter(b=>b==='午').length>=2) tips.push(tr('rel.self.wu','午午自刑：心火偏急，运动与作息稳态'));
  return Array.from(new Set(tips));
}
function balanceAdvice(five){
  const arr=Object.entries(five).sort((a,b)=>b[1]-a[1]);
  const max = arr[0], min = arr[arr.length-1];
  const msg = [];
  msg.push(trf('bal.core','五行偏 {max}，相对不足为 {min}。策略：补{min}、泄{max}、生所需。',{max:max[0], min:min[0]}));
  if((five.木+five.火)>(five.金+five.水+five.土))
    msg.push(tr('bal.muhuosheng','木火偏盛：以制度/数据/复盘（属金水）为“刹车”，以预算/流程（属土）为“地基”。'));
  if(five.金 < Math.min(five.木,five.火)) msg.push(tr('bal.jinweak','金弱：要有规则、复盘、文档、审计与清单。'));
  if(five.水 < Math.min(five.木,five.火)) msg.push(tr('bal.shuiweak','水弱：作息/饮水/伸展/复盘冥想，给大脑冷静区。'));
  return {maxEl:max[0], minEl:min[0], text:msg};
}

/* ---------- 年度提示 & 月份能量带 ---------- */
function yearBrief(dayStem, yearStem, yearBranch){
  const tg = tenGodGeneric(dayStem, yearStem);
  const be = fiveOfBranch(yearBranch);
  const pts=[];
  pts.push(trf('year.tg','天干 {stem}（相对日主：{tg}）→ 资源分配/权责/合作边界主题显著。',{stem:yearStem,tg}));
  if(be){
    const tail = be==='火' ? tr('year.br.fire','行动高峰，要稳节律')
               : be==='金' ? tr('year.br.metal','制度/审计节点多')
               : be==='水' ? tr('year.br.water','情绪/出行/学习主题多')
               : be==='木' ? tr('year.br.wood','拓展/人脉增长')
               :              tr('year.br.earth','资产/地产/预算为重');
    pts.push(trf('year.br','地支 {branch}（{el}）→ 当年{tip}。',{branch:yearBranch, el:be, tip:tail}));
  }
  if(yearBranch==='巳') pts.push(tr('year.si','巳藏庚戊丙（杀/财/火）：执行力强，注意支出与情绪管理。'));
  return pts;
}
const monthBand = branchOrder.map(z=>{
  const el=fiveOfBranch(z);
  const hint = el==='木' ? tr('month.wood','拓展、人脉、学习')
             : el==='火' ? tr('month.fire','发布、行动、曝光')
             : el==='土' ? tr('month.earth','收纳、整理、预算')
             : el==='金' ? tr('month.metal','复盘、制度、合规')
             :             tr('month.water','修复、学习、冷静');
  return {branch:z, el, hint};
});

/* ---------- 主渲染 ---------- */
function render(data){
  injectStyle();
  const host=$(data.mountId||MOUNT_ID) || document.body; host.innerHTML='';
  const root = document.createElement('div'); host.appendChild(root);

  const pillars = data.pillars; // [['干','支'],...]
  const dayStem = data.dayStem;
  const dayBranch = pillars?.[2]?.[1] || '';

  /* 头卡片 */
  const head = section(tr('ultra.sec.basic','基本信息'), [
    el('div',null,`${(data.name||tr('ultra.name','命主'))} · ${(data.gender||'—')} · ${(data.birth||'')} · ${(data.location||'')}`),
    el('div','muted', trf('ultra.pillars','四柱：{s}',{ s: (pillars||[]).map(p=>p.join('')).join('｜') })),
    (()=>{ const ch=el('div','chips');
      [tr('ultra.tag.offline','离线渲染'),
       tr('ultra.tag.ten','十神/藏干/五行'),
       tr('ultra.tag.struct','结构（合冲刑害）'),
       tr('ultra.tag.year','年度与月份提示'),
       tr('ultra.tag.luck','大运时间线'),
       tr('ultra.tag.export','导出工具')].forEach(t=>ch.appendChild(el('span','chip',t)));
      return ch;
    })()
  ]);
  root.appendChild(head);

  /* 十神 + 藏干表 */
  const rows=[];
  (pillars||[]).forEach((p,i)=>{
    const [g,z]=p;
    const hs = hiddenStems(z);
    rows.push([[tr('col.year','年'),tr('col.month','月'),tr('col.day','日'),tr('col.hour','时')][i]||'',
               g||'-', tenGodGeneric(dayStem,g)||'', z||'-', hs.join(' '), hs.map(h=>tenGodGeneric(dayStem,h)).join(' ')]);
  });
  root.appendChild(section(tr('ultra.sec.tengod','十神分解（明干/藏干）'), [
    table([tr('th.pillar','柱'),tr('th.gan','天干'),tr('th.tgdm','十神(相对日主)'),
           tr('th.zhi','地支'),tr('th.hidden','藏干'),tr('th.hiddentg','藏干十神')], rows)
  ]));

  /* 五行统计 + 用神倾向 */
  const five = countFive(pillars||[], data.weightMain||1, data.weightHidden||0.5);
  const total = Object.values(five).reduce((a,b)=>a+b,0)||1;
  const kv = el('div','kv');
  Object.entries(five).forEach(([k,v])=>{
    const pct = Math.round(v/total*100);
    const lab = el('div',null,`${k} ${v.toFixed(1)}（${pct}%）`);
    const barWrap=el('div'); const bar=el('div','bar'); bar.style.width=pct+'%'; barWrap.appendChild(bar);
    kv.append(lab,barWrap);
  });
  const bal = balanceAdvice(five);
  const balList = el('ul','tips'); bal.text.forEach(t=>balList.appendChild(el('li',null,t)));
  root.appendChild(section(tr('ultra.sec.balance','五行统计与平衡建议'), [kv, balList]));

  /* 合会冲刑害 */
  const bs = (pillars||[]).map(p=>p[1]).filter(Boolean);
  const rel = relationTips(bs);
  const relList = el('ul','tips'); (rel.length?rel:[tr('ultra.rel.none','（未见显著冲合；以节律与规划为主）')]).forEach(t=>relList.appendChild(el('li',null,t)));
  root.appendChild(section(tr('ultra.sec.struct','结构提示 · 合/会/冲/刑/害'), [relList]));

  /* 年度提示（可选） */
  if(data.peekYear){
    const y = data.peekYear;
    const lst = el('ul','tips'); yearBrief(dayStem, y.stem, y.branch).forEach(t=>lst.appendChild(el('li',null,t)));
    root.appendChild(section(trf('ultra.sec.year','年度提示 · {yb}',{yb: `${y.stem||''}${y.branch||''}` }), [lst]));
  }

  /* 12个月能量带 */
  const mRows = monthBand.map(m=>[m.branch, m.el, m.hint]);
  root.appendChild(section(tr('ultra.sec.month','月份能量带（节律建议）'), [table([tr('th.month.zhi','月支'), tr('th.month.el','元素'), tr('th.month.hint','倾向')], mRows)]));

  /* 大运时间线（可选） */
  if(Array.isArray(data.luckPillars)&&data.luckPillars.length){
    const lpRows = data.luckPillars.map(x=>[`${x.start||''}–${x.end||''}`, `${(x.stem||'')}${(x.branch||'')}`, x.note||'']);
    root.appendChild(section(tr('ultra.sec.luck','大运时间线'), [table([tr('th.luck.years','年份'), tr('th.luck.pillar','大运'), tr('th.luck.note','备注')], lpRows)]));
  }

  /* 健康/作息/空间（非医疗建议） */
  const hl = el('ul','tips');
  hl.appendChild(el('li',null,tr('ultra.health.firewood','木火偏盛：重视心肝轴；用“水（金）”冷却与复盘；每周≥2次中等强度运动。')));
  hl.appendChild(el('li',null,tr('ultra.health.space','空间：卧室/客厅以温土+金属质感做收纳与秩序；减少强烈红光/杂物。')));
  hl.appendChild(el('li',null,tr('ultra.health.routine','作息：固定睡窗与进食窗；高强度输出期配合冥想/拉伸。')));
  root.appendChild(section(tr('ultra.sec.health','健康 · 作息 · 空间（五行轴提醒）'), [hl]));

  /* 行动清单（当周/当月/12周） */
  const g3=el('div','grid3');
  const wList=el('ul','tips'); [tr('ultra.todo.week1','无手机双人时段×1'),tr('ultra.todo.week2','共同账本记账'),tr('ultra.todo.week3','本周1个可交付物')].forEach(t=>wList.appendChild(el('li',null,t)));
  const mList=el('ul','tips'); [tr('ultra.todo.month1','预算复盘一次'),tr('ultra.todo.month2','规则/流程SOP更新'),tr('ultra.todo.month3','人脉拓展/复盘各一次')].forEach(t=>mList.appendChild(el('li',null,t)));
  const qList=el('ul','tips'); [tr('ultra.todo.q1','12周冲刺：每周1产出'),tr('ultra.todo.q2','第4/8/12周做里程碑评审'),tr('ultra.todo.q3','形成可复用模板')].forEach(t=>qList.appendChild(el('li',null,t)));
  g3.appendChild(section(tr('ultra.sec.week','当周'), [wList]));
  g3.appendChild(section(tr('ultra.sec.monthtodo','当月'), [mList]));
  g3.appendChild(section(tr('ultra.sec.quarter','12周冲刺'), [qList]));
  root.appendChild(g3);

  /* 导出 */
  const tools = section(tr('ultra.sec.export','导出'), []);
  const bar = el('div','cta');
  const btnPrint = el('button','btn'); btnPrint.textContent=tr('btn.print','打印为 PDF'); btnPrint.onclick=()=>window.print();
  const btnCopy = el('button','btn'); btnCopy.textContent=tr('btn.copy','复制关键信息');
  btnCopy.onclick=()=>{
    const summary = [
      trf('copy.pillars','四柱：{s}',{ s:(pillars||[]).map(p=>p.join('')).join('｜') }),
      trf('copy.five','五行：{s}',{ s:Object.entries(five).map(([k,v])=>`${k}${v.toFixed(1)}`).join(' ') }),
      trf('copy.struct','结构：{s}',{ s:(rel||[]).join('；') || tr('copy.stable','平稳') }),
      trf('copy.advice','用神倾向：补{min}、泄{max}',{ min:bal.minEl, max:bal.maxEl }),
    ].join('\n');
    navigator.clipboard.writeText(summary).catch(()=>{});
  };
  const btnJSON = el('button','btn'); btnJSON.textContent=tr('btn.json','导出JSON');
  btnJSON.onclick=()=>{
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`bazi_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
  };
  bar.append(btnPrint, btnCopy, btnJSON); tools.appendChild(bar); root.appendChild(tools);
}

/* —— 对外 API —— */
window.BaziUltra = { render };
/* 兼容：BaziPro 指向 Ultra（v4 已覆盖 v3 功能；若日后需要独立 v3，可再替换） */
window.BaziPro = { render };

})();
</script>  
</body>
</html>
