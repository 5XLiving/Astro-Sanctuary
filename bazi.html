<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* =====================================
       5XLiving Â· Dark + Gold Baseline Theme
       ===================================== */
:root{
  --bg:#0b0f14;
  --bg-accent:#0e1520;
  --card:#11161dcc;
  --surface:#0f1624;
  --line:#1f2a36;
  --text:#e8edf3;
  --muted:#98a7b7;

  --brand:#d4af37;
  --gold:#d4af37;
  --gold2:#f2d27a;
  --accent:#58b9ff;

  --radius:14px;
  --radius-sm:10px;
  --radius-lg:18px;

  --shadow:0 8px 30px rgba(0,0,0,.35);
  --shadow-sm:0 4px 14px rgba(0,0,0,.28);

  --container:1100px;
  --gap:12px;
  --pad:18px;

  --focus: 0 0 0 2px rgba(212,175,55,0.2);

  --bp-s:520px;
  --bp-m:760px;
  --bp-l:900px;
}

/* Reset + base */
*, *::before, *::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
    linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}

.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}

.site-header{
  position:sticky; top:0; z-index:10;
  background:rgba(11,15,20,.8);
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:var(--shadow-sm);
  font-weight:800; color:#ffe084
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}

.now{font-variation-settings:"wght" 450; color:#9db0c4; font-size:.9rem}

.lang{display:flex; align-items:center; gap:8px}
.lang select{
  appearance:none; min-width:140px;
  border-radius:10px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:10px 34px 10px 12px; font-size:0.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

.section{margin-top:18px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  padding:var(--pad);
  margin:16px 0;
}
.h2{
  font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084;
  display:flex; gap:8px; align-items:center
}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}

.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width: 760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row.cols-2{grid-template-columns:1fr 1fr}
}

input,select{
  width:100%;
  border-radius:12px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:12px 12px; font-size:15px; outline:0;
}
input::placeholder{color:#6f8092}
input:focus, select:focus{box-shadow:var(--focus); border-color:#3a4c63}

.btn{
  display:inline-grid; place-items:center;
  padding:12px 16px; border-radius:12px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919; font-weight:800; cursor:pointer;
  transition:transform .2s ease, box-shadow .2s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}

.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width: 520px){
  .pillars{grid-template-columns:repeat(2,1fr)}
}

.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width: 420px){
  .bazi-table th,.bazi-table td{padding:8px 10px}
}

.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:60px 1fr 60px; gap:10px; align-items:center}

.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.badge-warn{display:inline-block; padding:2px 8px; margin-left:6px; border:1px solid #ffb84d; border-radius:999px; color:#ffb84d; font-size:0.82rem}
.muted{color:var(--muted)}

.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}

.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}

.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.rating{display:flex; align-items:center; gap:8px; margin:8px 0}
.rating-stars{color:var(--gold2)}
.tag{display:inline-block; background:rgba(212,175,55,.1); color:var(--gold2); padding:4px 8px; border-radius:6px; font-size:0.85rem; margin:2px}

.luck-grid{display:grid; gap:10px}
.luck-item{background:rgba(255,255,255,.05); border-radius:8px; padding:12px; border-left:3px solid var(--gold2)}
.luck-year{font-weight:700; color:var(--gold2)}
.luck-desc{font-size:0.9rem; margin-top:4px}

.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width: 900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

.ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0}
.ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px}
.ai-box-c{color:#e8edf3; line-height:1.7}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
.chip{padding:6px 10px; border-radius:999px; border:1px solid #2a3546; background:#0e1520; color:#e8edf3; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease}
.chip:hover{border-color:#f2d27a; box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
.chip:disabled{opacity:.6; cursor:not-allowed}

.skeleton{display:grid; gap:8px}
.skeleton div{height:12px; border-radius:6px; background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431); animation:sh 1.2s infinite}
@keyframes sh{0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5}}

.ai-lock-overlay{margin-top:10px; padding-top:10px; border-top:1px solid #1f2a36; text-align:center}
.ai-lock-overlay .tip{color:#ffd88a; font-weight:700; margin-bottom:4px}
.ai-lock-overlay .sub{color:var(--muted)}

.detail-view{display:none}
.detail-header{display:flex; align-items:center; gap:12px; margin-bottom:20px}
.back-btn{background:rgba(212,175,55,.1); border:1px solid rgba(212,175,55,.3); color:var(--gold2); padding:8px 16px; border-radius:8px; cursor:pointer}
.detail-content{line-height:1.8}
.detail-section{margin-bottom:24px}
.detail-section h4{color:var(--gold2); margin-bottom:12px; font-size:1.1rem}
.action-list{list-style:none; padding:0; margin:0}
.action-list li{margin-bottom:8px; padding-left:20px; position:relative}
.action-list li::before{content:"â€¢"; color:var(--gold2); position:absolute; left:0; top:0}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}

/* Motion accessibility */
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important} }

/* Utilities */
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
.chips-container{display:flex; flex-wrap:wrap; gap:8px; margin:20px 0; justify-content:center}

/* VIP section demo å¯è§ */
.vip-section{display:block !important}

/* Butler ç»„ä»¶ */
.butler-professional{display:none; margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:20px}
.butler-header{display:flex; align-items:center; gap:10px; margin-bottom:20px; color:var(--gold2); font-size:1.2rem; font-weight:700}
.butler-content{line-height:1.8; max-height:600px; overflow-y:auto; padding:15px; background:var(--surface); border-radius:10px; border:1px solid #253245}
.butler-section{margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #253245}
.butler-section h4{color:var(--gold2); margin-bottom:10px; font-size:1.1rem}
.butler-chat{margin-top:20px; border-top:1px solid var(--line); padding-top:15px}
.chat-messages{height:200px; overflow-y:auto; margin-bottom:15px; padding:10px; background:var(--surface); border-radius:8px; border:1px solid #253245}
.chat-input-area{display:flex; gap:10px}
.chat-input-area input{flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3}
.chat-send-btn{padding:10px 20px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer}

/* Focus visuals removed by request */
input:focus, select:focus, textarea:focus{ outline: none !important; box-shadow: none !important; border-color: #243244 !important; }
button:focus, .btn:focus, a:focus{ outline: none !important; box-shadow: none !important; }
*{ -webkit-tap-highlight-color: transparent; }
.chip:hover{ border-color:#2a3546; box-shadow:none; }

/* æµ®çª—èŠå¤©æ ·å¼ */
.chat-toggle-btn{ position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:linear-gradient(180deg,#fff9e6,#e6c76e); border:1px solid #e6c76e; color:#191919; font-size:1.5rem; cursor:pointer; box-shadow:0 4px 12px rgba(230,199,110,.3); z-index:1001; display:flex; align-items:center; justify-content:center }
.chat-toggle-btn:hover{ transform:scale(1.05); box-shadow:0 6px 20px rgba(230,199,110,.5) }
.chat-float{ position:fixed; bottom:20px; right:20px; width:350px; height:500px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); z-index:1000; display:none; flex-direction:column }
.chat-float-header{ padding:12px 16px; border-bottom:1px solid var(--line); background:rgba(212,175,55,.1); color:var(--gold2); font-weight:700; display:flex; justify-content:space-between; align-items:center; cursor:move }
.chat-float-close{ background:none; border:none; color:var(--gold2); font-size:1.2rem; cursor:pointer; padding:4px; border-radius:4px }
.chat-float-close:hover{ background:rgba(212,175,55,.2) }
.chat-float-body{ flex:1; display:flex; flex-direction:column; padding:0 }
.chat-float-messages{ flex:1; overflow-y:auto; padding:12px; background:var(--surface) }
.chat-float-input-area{ padding:12px; border-top:1px solid var(--line); background:var(--bg-accent) }
@media (max-width: 768px){ .chat-float{ width:300px; height:400px; bottom:10px; right:10px } .chat-toggle-btn{ width:50px; height:50px; bottom:10px; right:10px } }

/* Hide login inputs by default per user preference */
#authFields{ display:none }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com/" target="_self">
        <span class="brand-badge">5X</span>
        <span class="title" data-i18n="brand.subtitle">5xLiving Â· å…«å­—ç®€è¯„</span>
      </a>
      <div class="now muted" id="nowBox" aria-live="polite"></div>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="nav.langLabel">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN" data-i18n="lang.zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW" data-i18n="lang.zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en"    data-i18n="lang.en">English</option>
          <option value="ja"    data-i18n="lang.ja">æ—¥æœ¬èª</option>
          <option value="th"    data-i18n="lang.th">à¹„à¸—à¸¢</option>
          <option value="ms"    data-i18n="lang.ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="h2" data-i18n="app.title">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="form.nameLabel">å§“åï¼ˆå¯é€‰ï¼‰</label>
          <input id="name" data-i18n-ph="form.namePlaceholder" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
        </div>
        <div>
          <label class="muted" data-i18n="form.genderLabel">æ€§åˆ«</label>
          <select id="gender">
            <option value=""        data-i18n="form.gender.hidden">ä¸é€éœ²</option>
            <option value="male"    data-i18n="form.gender.male">ç”·æ€§</option>
            <option value="female"  data-i18n="form.gender.female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="form.calendarLabel">å†æ³•</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="form.calendar.gregorian">é˜³å†</option>
            <option value="lunar"     data-i18n="form.calendar.lunar">å†œå†</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="form.birthdateLabel">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted" data-i18n="form.birthtimeLabel">å‡ºç”Ÿæ—¶é—´</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="form.timeUnknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn.generate">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none" data-i18n="btn.loading">è®¡ç®—ä¸­...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2" data-i18n="result.title">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <div class="bazi-table-wrap">
          <table class="bazi-table">
            <thead>
              <tr>
                <th></th>
                <th data-i18n="pillar.year">å¹´æŸ±</th>
                <th data-i18n="pillar.month">æœˆæŸ±</th>
                <th data-i18n="pillar.day">æ—¥æŸ±</th>
                <th data-i18n="pillar.hour">æ—¶æŸ±</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td data-i18n="table.row.stem">å¤©å¹²</td>
                <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
              </tr>
              <tr>
                <td data-i18n="table.row.branch">åœ°æ”¯</td>
                <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
              </tr>
              <tr>
                <td data-i18n="table.row.fiveElem">äº”è¡Œ</td>
                <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
              </tr>
              <tr>
                <td data-i18n="table.row.nayin">çº³éŸ³</td>
                <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="h2" data-i18n="energy.title">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span data-i18n="elem.wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
        <div id="bazi-elements-balance" class="muted"></div>
      </div>
    </section>

    <section id="butlerProfessional" class="butler-professional">
      <div class="butler-header">
        <span data-i18n="pro.title">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</span>
      </div>
      <div class="butler-content" id="professionalReport"></div>
    </section>

    <!-- æµ®çª—èŠå¤©æŒ‰é’® -->
    <button class="chat-toggle-btn" id="chatToggle" data-i18n="chat.toggle">é—®</button>

    <!-- æµ®çª—èŠå¤©çª—å£ -->
    <div class="chat-float" id="chatFloat">
      <div class="chat-float-header" id="chatDrag">
        <span data-i18n="pro.title">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</span>
        <button class="chat-float-close" id="chatClose">Ã—</button>
      </div>
      <div class="chat-float-body">
        <div class="chat-float-messages" id="chatMessages">
          <div class="ss-msg" data-i18n="pro.welcome">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šå‘½ç†é¡¾é—®ï¼Œå·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Šã€‚æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘ã€‚</div>
        </div>
        <div class="chat-float-input-area">
          <div style="display:flex; gap:8px;">
            <input type="text" id="chatInput" data-i18n-ph="chat.placeholder" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3;">
            <button class="chat-send-btn" id="chatSend" data-i18n="chat.send" style="padding:10px 16px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer;">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <section class="card section vip-section">
      <h2 class="group-title" data-i18n="vip.title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip.group.astrology">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip.astrology.match">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip.astrology.career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip.astrology.wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip.astrology.pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip.group.spiritual">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip.spiritual.record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip.spiritual.courses">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
            <li data-i18n="vip.spiritual.family">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip.spiritual.practice">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="vip.login.title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="auth.header">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row one" style="margin-bottom:10px;">
                <button class="btn ghost" id="revealLoginBtn" type="button" data-i18n="auth.reveal">æ˜¾ç¤ºç™»å½•è¡¨å•</button>
              </div>
              <div class="row" id="authFields">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" data-i18n-ph="auth.emailPlaceholder" placeholder="é‚®ç®± Email">
                <input id="password" name="password" type="password" autocomplete="current-password" data-i18n-ph="auth.passwordPlaceholder" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="auth.login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="auth.reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="auth.register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="auth.freeTrialNote">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="vip.services.header">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="vip.upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="vip.back">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="muted" data-i18n="vip.priceNote">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer data-i18n="footer.copy">Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <script>
    // Allow overriding via server-side injection
    window.API_BASE = window.API_BASE || 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  </script>

  <!-- ================= I18N CORE PACK (condensed) ================= -->
  <script>
  (function(){
    const I18N = (window.I18N = window.I18N || {});

    // Utility to shallow-merge a map into existing language
    function ensure(lang, obj){ I18N[lang] = Object.assign({}, I18N[lang]||{}, obj); }

    // Common label name dictionaries
    const STEM_ELEM = { 'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´' };
    const STEMS_ZH = { 'ç”²':'ç”²æœ¨','ä¹™':'ä¹™æœ¨','ä¸™':'ä¸™ç«','ä¸':'ä¸ç«','æˆŠ':'æˆŠåœŸ','å·±':'å·±åœŸ','åºš':'åºšé‡‘','è¾›':'è¾›é‡‘','å£¬':'å£¬æ°´','ç™¸':'ç™¸æ°´' };

    ensure('zh-CN', {
      brand:{ subtitle:'5xLiving Â· å…«å­—ç®€è¯„' },
      nav:{ langLabel:'è¯­è¨€' },
      lang:{ 'zh-CN':'ç®€ä½“ä¸­æ–‡','zh-TW':'ç¹é«”ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª','th':'à¹„à¸—à¸¢','ms':'Bahasa Melayu' },
      app:{ title:'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜' },
      form:{ nameLabel:'å§“åï¼ˆå¯é€‰ï¼‰', namePlaceholder:'ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰', genderLabel:'æ€§åˆ«', gender:{ hidden:'ä¸é€éœ²', male:'ç”·æ€§', female:'å¥³æ€§' }, calendarLabel:'å†æ³•', calendar:{ gregorian:'é˜³å†', lunar:'å†œå†' }, birthdateLabel:'å‡ºç”Ÿæ—¥æœŸ', birthtimeLabel:'å‡ºç”Ÿæ—¶é—´', timeUnknown:'å‡ºç”Ÿæ—¶é—´ä¸è¯¦' },
      btn:{ generate:'ç”Ÿæˆå…«å­—', loading:'è®¡ç®—ä¸­...' },
      result:{ title:'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜' },
      pillar:{ year:'å¹´æŸ±', month:'æœˆæŸ±', day:'æ—¥æŸ±', hour:'æ—¶æŸ±' },
      table:{ row:{ stem:'å¤©å¹²', branch:'åœ°æ”¯', fiveElem:'äº”è¡Œ', nayin:'çº³éŸ³' } },
      energy:{ title:'äº”è¡Œèƒ½é‡åˆ†æ' },
      elem:{ wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´', month:'æœˆ', fiveElements:'äº”è¡Œ' },
      pro:{ title:'ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ', welcome:'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šå‘½ç†é¡¾é—®ï¼Œå·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Šã€‚æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘ã€‚' },
      chat:{ send:'å‘é€', placeholder:'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...', toggle:'é—®' },
      vip:{ title:'ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment', group:{ astrology:'ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹', spiritual:'ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹' }, astrology:{ match:'å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿', career:'äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›', wealth:'è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº', pet:'å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†' }, spiritual:{ record:'çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·', courses:'å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°', family:'å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­', practice:'æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡' }, login:{ title:'ğŸ’ ç™»å…¥ VIP åŠŸèƒ½' }, services:{ header:'ä¼šå‘˜æœåŠ¡' }, upgrade:'ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰', back:'â† è¿”å›å‘½ç†å•†åŸ', priceNote:'$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰' },
      auth:{ header:'è´¦æˆ·ç™»å½• / æ³¨å†Œ', login:'ç™»å…¥è´¦æˆ·', reset:'ğŸ”‘ é‡è®¾å¯†ç ', register:'æ³¨å†Œè´¦æˆ·', freeTrialNote:'æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ', emailPlaceholder:'é‚®ç®± Email', passwordPlaceholder:'å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰', reveal:'æ˜¾ç¤ºç™»å½•è¡¨å•' },
      footer:{ copy:'Â© 5XLiving â€¢ Astro Sanctuary' },
      err:{ fillBirthdate:'è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ', invalidDate:'æ— æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè¯·ç”¨ YYYY-MM-DD', generateFail:'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' },
      ui:{ unknown:'æœªçŸ¥', timeUnknown:'æ—¶é—´ä¸è¯¦', hourSuffix:'{hh}:{mm}', birthSummary:'å‡ºç”Ÿæ—¥æœŸ: {y}å¹´{m}æœˆ{d}æ—¥ {timeText}', balance:'äº”è¡Œä¸­{strongest}æœ€å¼ºï¼Œ{weakest}æœ€å¼±ã€‚' },
      badge:{ noHour:'æœªçº³å…¥æ—¶æŸ±' },
      report:{ tipTitle:'æç¤º', generating:'æ­£åœ¨ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š...', failed:'æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', hourUnknownTip:'âš ï¸ æç¤ºï¼šå› å‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œéƒ¨åˆ†åˆ†æä»…ä¾›å‚è€ƒã€‚' },
      reportTitles:{ overview:'ğŸ“Š å‘½ç›˜æ€»è§ˆ', fiveElements:'ğŸŒ¿ äº”è¡Œåˆ†æ', tenGods:'âš¡ åç¥é…ç½®', useful:'ğŸ”‘ å–œç”¨ç¥', relationship:'ğŸ’• æ„Ÿæƒ…å©šå§»', career:'ğŸ’¼ äº‹ä¸šå‘å±•', wealth:'ğŸ’° è´¢è¿åˆ†æ', health:'ğŸŒ¡ï¸ å¥åº·å…»ç”Ÿ', nearTerm:'ğŸ”® è¿‘æœŸè¿åŠ¿', actions:'ğŸ“ è¡ŒåŠ¨æ¸…å•' }
    });

    ensure('zh-TW', { auth:{ reveal:'é¡¯ç¤ºç™»å…¥è¡¨å–®' } });
    ensure('en',    { auth:{ reveal:'Reveal login form' }, chat:{ send:'Send', placeholder:'Ask about your readingâ€¦', toggle:'Ask' }, ui:{ timeUnknown:'Time unknown', hourSuffix:'{hh}:{mm}', birthSummary:'Birth: {y}-{m}-{d} {timeText}', balance:'Balance: strongest {strongest}, weakest {weakest}' }, report:{ tipTitle:'Note', generating:'Generating professional analysisâ€¦', failed:'Report generation failed. Please try again later', hourUnknownTip:'âš ï¸ Hour unknown; hour pillar parts are generalized.' }, reportTitles:{ overview:'ğŸ“Š Overview', fiveElements:'ğŸŒ¿ Five-Element Analysis', tenGods:'âš¡ Ten Gods', useful:'ğŸ”‘ Useful Spirit', relationship:'ğŸ’• Relationships & Marriage', career:'ğŸ’¼ Career Development', wealth:'ğŸ’° Wealth Analysis', health:'ğŸŒ¡ï¸ Health & Wellness', nearTerm:'ğŸ”® Near-Term Fortune', actions:'ğŸ“ Action Checklist' } });
    ensure('ja',    { auth:{ reveal:'ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º' } });
    ensure('th',    { auth:{ reveal:'à¹à¸ªà¸”à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡à¸¥à¹‡à¸­à¸à¸­à¸´à¸™' } });
    ensure('ms',    { auth:{ reveal:'Tunjuk borang log masuk' } });

    // expose tiny helpers & stem element map for fallback labels
    window._stemElem = STEM_ELEM;
    window.labelStem = window.labelStem || function(stem){ return STEMS_ZH[stem] || stem };
  })();
  </script>

  <!-- ================= APP SCRIPT ================= -->
  <script>
  (function(){
    'use strict';
    const SG_TZ = 'Asia/Singapore';
    const $ = (id) => document.getElementById(id);
    const state = { lang: localStorage.getItem('5x_lang') || 'zh-CN', lastCtx: null };

    /* ---------------- Clock ---------------- */
    function pad(n){ return (n<10?'0':'')+n }
    function tickNow(){
      try{
        const now = new Date();
        const fmt = new Intl.DateTimeFormat(undefined,{ timeZone:SG_TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        const s = fmt.format(now);
        const box = $('nowBox'); if (box) box.textContent = s + ' Â· SG';
      }catch(e){ /* ignore */ }
    }

    /* ---------------- I18N ---------------- */
    const I18N = window.I18N || {};
    function t(path){
      const parts = String(path||'').split('.');
      let cur = I18N[state.lang] || I18N['zh-CN'] || {};
      for(const p of parts){ if(cur && typeof cur === 'object' && p in cur) cur = cur[p]; else return '' }
      return (typeof cur === 'string') ? cur : '';
    }
    function applyI18N(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); const val=t(key); if(val) el.textContent = val; });
      document.querySelectorAll('[data-i18n-ph]').forEach(el=>{ const key=el.getAttribute('data-i18n-ph'); const val=t(key); if(val) el.setAttribute('placeholder', val); });
    }

    /* ---------------- UX helpers ---------------- */
    function showErr(msg){ const e=$('error'); if(!e) return; e.textContent=msg; e.style.display='block'; setTimeout(()=>{e.style.display='none'},5000); }
    function setLoading(v){
      const spin=$('genBtnLoading'), txt=$('genBtnText');
      if(v){ if(spin) spin.style.display='inline'; if(txt) txt.style.display='none'; }
      else { if(spin) spin.style.display='none'; if(txt) txt.style.display='inline'; }
    }

    /* ---------------- Lang select ---------------- */
    const langSel = $('langSelect');
    if(langSel){ langSel.value = state.lang; langSel.addEventListener('change', ()=>{ state.lang = langSel.value; localStorage.setItem('5x_lang', state.lang); applyI18N(); renderFromCache(); }); }

    /* ---------------- Time unknown toggle ---------------- */
    const cbUnknown = $('timeUnknown'); const timeInput = $('birthtime');
    function syncTimeUnknown(){ const un = cbUnknown && cbUnknown.checked; if(timeInput){ timeInput.disabled = !!un; timeInput.style.opacity = un? .5: 1; } }
    if(cbUnknown){ cbUnknown.addEventListener('change', syncTimeUnknown); syncTimeUnknown(); }

    /* ---------------- Reveal login (hide fields by default) ---------------- */
    const revealBtn = $('revealLoginBtn');
    if(revealBtn){ revealBtn.addEventListener('click', ()=>{ const af=$('authFields'); if(af){ af.style.display='grid'; } revealBtn.style.display='none'; }); }

    // Prevent logging creds; stub handlers only
    const loginForm = $('loginForm'); if(loginForm){ loginForm.addEventListener('submit', (e)=>{ e.preventDefault(); $('authError').style.display='block'; $('authError').textContent = 'è¯·åœ¨æ­£å¼æ¥ä¸Šåå°åå¯ç”¨ç™»å½• / Enable login after wiring backend.'; setTimeout(()=>{ $('authError').style.display='none'}, 4000); }); }
    const registerForm = $('registerForm'); if(registerForm){ registerForm.addEventListener('submit',(e)=>{ e.preventDefault(); $('authError').style.display='block'; $('authError').textContent = 'æ³¨å†ŒåŠŸèƒ½å¾…æ¥å…¥åç«¯ / Registration pending backend.'; setTimeout(()=>{ $('authError').style.display='none'}, 4000); }); }
    const resetBtn = $('resetBtn'); if(resetBtn){ resetBtn.addEventListener('click', ()=>{ $('authError').style.display='block'; $('authError').textContent = 'é‡è®¾å¯†ç åŠŸèƒ½å¾…æ¥å…¥åç«¯ / Reset pending backend.'; setTimeout(()=>{ $('authError').style.display='none'}, 4000); }); }

    /* ---------------- Chat Float ---------------- */
    const chatToggle = $('chatToggle'), chatFloat = $('chatFloat'), chatClose = $('chatClose');
    if(chatToggle){ chatToggle.addEventListener('click', ()=>{ chatFloat.style.display = 'flex'; }); }
    if(chatClose){ chatClose.addEventListener('click', ()=>{ chatFloat.style.display = 'none'; }); }
    // Drag
    (function makeDraggable(){
      const drag = $('chatDrag'); if(!drag) return; let sx=0, sy=0, ox=0, oy=0, moving=false;
      function onDown(e){ moving=true; const r = chatFloat.getBoundingClientRect(); ox=r.left; oy=r.top; sx = e.clientX; sy = e.clientY; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); }
      function onMove(e){ if(!moving) return; const dx=e.clientX-sx, dy=e.clientY-sy; chatFloat.style.left=(ox+dx)+"px"; chatFloat.style.top=(oy+dy)+"px"; chatFloat.style.right='auto'; chatFloat.style.bottom='auto'; chatFloat.style.position='fixed'; }
      function onUp(){ moving=false; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
      drag.addEventListener('mousedown', onDown);
    })();
    // Chat send (local echo)
    const chatSend=$('chatSend'), chatInput=$('chatInput'), chatMessages=$('chatMessages');
    function appendMsg(txt, role){ const div=document.createElement('div'); div.className='msg '+role; div.textContent=txt; chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight; }
    if(chatSend){ chatSend.addEventListener('click', ()=>{ const q=(chatInput.value||'').trim(); if(!q) return; appendMsg(q,'user'); const templ = (I18N[state.lang]?.chatDyn?.autoReply)||'æ”¶åˆ°ï¼š{q}'; appendMsg( templ.replace('{q}', q), 'assistant'); chatInput.value=''; }); }

    /* ---------------- Bazi calc helpers (front-end fallback only) ---------------- */
    const ELEMENTS = ['æœ¨','ç«','åœŸ','é‡‘','æ°´'];
    function stemElem(stem){ return window._stemElem?.[stem] || '' }
    function updateBars(elemPct){ ELEMENTS.forEach(k=>{ const i=$('bar-'+k); const pctEl=$('pct-'+k); const v=Math.max(0, Math.min(100, Math.round((elemPct?.[k]||0)))); if(i) i.style.width = v+'%'; if(pctEl) pctEl.textContent = v+'%'; }); const bal=$('bazi-elements-balance'); if(bal){ const strongest = ELEMENTS.sort((a,b)=>(elemPct[b]||0)-(elemPct[a]||0))[0]||''; const weakest = ELEMENTS.sort((a,b)=>(elemPct[a]||0)-(elemPct[b]||0))[0]||''; const txt = (I18N[state.lang]?.ui?.balance)||'äº”è¡Œä¸­{strongest}æœ€å¼ºï¼Œ{weakest}æœ€å¼±ã€‚'; bal.textContent = txt.replace('{strongest}', strongest).replace('{weakest}', weakest); }
    }

    function renderPillars(p){
      const wrap = $('bazi-pillars'); if(!wrap) return; wrap.innerHTML='';
      const order=[['year', t('pillar.year')||'å¹´æŸ±'],['month', t('pillar.month')||'æœˆæŸ±'],['day', t('pillar.day')||'æ—¥æŸ±'],['hour', t('pillar.hour')||'æ—¶æŸ±']];
      order.forEach(([k,label])=>{
        const stem=(p?.[k]?.stem)||''; const branch=(p?.[k]?.branch)||''; const gz = (stem||branch) ? (stem+branch) : '-';
        const el = document.createElement('div'); el.className='pillar';
        el.innerHTML = `<div class="tit">${label||''}</div><div class="gz">${gz}</div>`;
        wrap.appendChild(el);
      });
      // table
      const ids = ['year','month','day','hour'];
      ids.forEach(k=>{ const ps=p?.[k]||{}; const s = ps.stem||'-', b = ps.branch||'-'; const e = ps.element || stemElem(s) || '-'; const n = ps.nayin || '-';
        const u=(id,v)=>{ const el=$(id); if(el) el.textContent=v };
        u(k+'-stem', s); u(k+'-branch', b); u(k+'-element', e); u(k+'-nayin', n);
      });
    }

    function renderReportSections(data){
      const host = $('professionalReport'); if(!host) return; host.innerHTML='';
      const titles = I18N[state.lang]?.reportTitles || I18N['zh-CN'].reportTitles;
      const order = ['overview','fiveElements','tenGods','useful','relationship','career','wealth','health','nearTerm','actions'];
      order.forEach(id=>{
        const sec = document.createElement('section'); sec.className='butler-section';
        const h = document.createElement('h4'); h.textContent = titles[id] || id; sec.appendChild(h);
        const c = document.createElement('div'); c.className='butler-text';
        // fill from backend if present
        const content = data?.sections?.find(s=>s.id===id)?.html || '';
        c.innerHTML = content || `<div class="skeleton"><div></div><div></div><div></div></div>`;
        sec.appendChild(c);
        host.appendChild(sec);
      });
      const box = $('butlerProfessional'); if(box) box.style.display = 'block';
    }

    function birthSummary(y,m,d,timeText){
      const fmt = (I18N[state.lang]?.ui?.birthSummary) || 'å‡ºç”Ÿæ—¥æœŸ: {y}å¹´{m}æœˆ{d}æ—¥ {timeText}';
      return fmt.replace('{y}',y).replace('{m}',m).replace('{d}',d).replace('{timeText}', timeText);
    }

    function parseApiResult(res){
      // Try to normalize multiple possible server shapes
      const out = { pillars:{}, elements:{}, sections:res?.sections||[] };
      // pillars
      if(res?.pillars){ out.pillars = res.pillars }
      else if(res?.gz){
        const map = (str)=>({ stem:(str||'').charAt(0)||'', branch:(str||'').charAt(1)||'' });
        out.pillars = { year:map(res.gz.year), month:map(res.gz.month), day:map(res.gz.day), hour:map(res.gz.hour) };
      }
      // elements
      if(res?.elements) out.elements = res.elements;
      else {
        // crude derive from stems only if available (fallback demo)
        const ids=['year','month','day','hour']; const cnt={ 'æœ¨':0,'ç«':0,'åœŸ':0,'é‡‘':0,'æ°´':0 };
        ids.forEach(k=>{ const s = out.pillars?.[k]?.stem; const e = s? stemElem(s): null; if(e && cnt[e]!=null) cnt[e]+=1; });
        const sum = Object.values(cnt).reduce((a,b)=>a+b,0)||1; Object.keys(cnt).forEach(k=> cnt[k] = cnt[k]*25 ); // rough 0-100 scale
        out.elements = cnt;
      }
      return out;
    }

    async function fetchBazi(ctx){
      const base = (window.API_BASE||'').replace(/\/$/, '');
      if(!base) return null;
      const payload = { name:ctx.name, gender:ctx.gender, calendar:ctx.calendar, date:ctx.date, time:ctx.time, timeUnknown:ctx.timeUnknown };
      const endpoints = [ '/api/bazi/quick', '/api/bazi' ];
      for(const ep of endpoints){
        try{
          const res = await fetch(base + ep, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), mode:'cors' });
          if(res.ok){ const json = await res.json(); return json; }
        }catch(e){ /* try next */ }
      }
      return null;
    }

    function renderFromCache(){ if(!state.lastCtx) return; const ctx=state.lastCtx; // re-apply texts only
      applyI18N(); // rebinding static labels
      if(ctx.rendered){ // re-render dynamic labels too
        $('bazi-date').textContent = birthSummary(ctx.y, ctx.m, ctx.d, ctx.timeText);
        renderPillars(ctx.data?.pillars||{});
        updateBars(ctx.data?.elements||{});
        renderReportSections(ctx.data||{});
      }
    }

    // Generate handler
    const genBtn = $('genBtn');
    if(genBtn){ genBtn.addEventListener('click', async ()=>{
      const dateVal = ($('birthdate')?.value||'').trim(); if(!dateVal){ return showErr( t('err.fillBirthdate')||'è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ' ); }
      // Validate YYYY-MM-DD
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateVal)){ return showErr( t('err.invalidDate')||'æ— æ•ˆçš„æ—¥æœŸ' ); }
      const name = ($('name')?.value||'').trim();
      const gender = ($('gender')?.value||'').trim();
      const calendar = ($('calendar')?.value||'gregorian').trim();
      const unknown = !!($('timeUnknown')?.checked);
      const timeVal = unknown ? '00:00' : ($('birthtime')?.value || '00:00');
      const [hh, mm] = (timeVal||'00:00').split(':');
      const lang = state.lang;
      const timeText = unknown ? (t('ui.timeUnknown')||'æ—¶é—´ä¸è¯¦') : (t('ui.hourSuffix')||'{hh}:{mm}').replace('{hh}', hh??'00').replace('{mm}', mm??'00');

      // summary
      const [Y,M,D] = dateVal.split('-');
      const bs = birthSummary(Y, M, D, timeText);
      const dateBox=$('bazi-date'); if(dateBox){ dateBox.textContent = bs; }

      setLoading(true);
      try{
        const ctx = { name, gender, calendar, date:dateVal, time:timeVal, timeUnknown:unknown, y:Y, m:M, d:D, timeText };
        let data = null;
        try{ const apiRes = await fetchBazi(ctx); if(apiRes) data = parseApiResult(apiRes); }catch(e){ /* ignore */ }
        if(!data){
          // Demo fallback so UI always renders
          data = parseApiResult({ gz:{ year:'ç”²å­', month:'ä¹™ä¸‘', day:'ä¸™å¯…', hour: unknown? 'ä¸å¯':'ä¸å¯' }, elements:{ 'æœ¨':30, 'ç«':25, 'åœŸ':15, 'é‡‘':20, 'æ°´':10 }, sections:[] });
        }
        // Render
        $('result').style.display='block';
        renderPillars(data.pillars||{});
        updateBars(data.elements||{});
        renderReportSections(data);
        state.lastCtx = { ...ctx, data, rendered:true };
      }catch(err){ showErr( t('err.generateFail')||'ç”Ÿæˆå¤±è´¥' ); }
      finally{ setLoading(false); }
    }); }

    // initial
    applyI18N(); tickNow(); setInterval(tickNow, 60000);
  })();
  </script>
</body>
</html>
