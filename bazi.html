<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* å¤´éƒ¨æ ·å¼ */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* å…«å­—æŸ±æ ·å¼ */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* äº”è¡Œèƒ½é‡æ¡ */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* æ—¶é—´è¾“å…¥è¡Œ */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* ç”ŸæˆæŒ‰é’®åŒ…è£… */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* è¯¦ç»†åˆ†æåŒºåŸŸ */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* å¤§è¿æµå¹´ */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* ä¼šå‘˜åŒºåŸŸ */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    /* VIPç™»å½•åŒºåŸŸ */
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AIç®¡å®¶æ ·å¼ */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* èŠå¤©æµ®çª— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç®€è¯„</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- å…«å­—æ’ç›˜è¡¨å• -->
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar">
          <option value="gregorian">é˜³å†</option>
          <option value="lunar">å†œå†</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:45" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- è¯¦ç»†åˆ†æåŒºåŸŸ -->
    <div class="card">
      <div class="h2">ğŸ§™â€â™‚ï¸ å‘½ä¸»åŸºæœ¬ä¿¡æ¯</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>ğŸ” æ€»ä½“å‘½è¿è§£è¯»</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’¼ äº‹ä¸šåˆ†æ</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’° è´¢å¯ŒçŠ¶å†µ</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>â¤ï¸ å©šå§»æ„Ÿæƒ…</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- å¤§è¿æµå¹´ -->
    <div class="card">
      <div class="h2">ğŸ“ˆ å¤§è¿æµå¹´åˆ†æ</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>

    <!-- AIç®¡å®¶åŒºåŸŸ -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">å¿ƒæ€œç®¡å®¶ Â· æ·±åº¦è§£è¯»</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>
    </div>
  </section>

  <!-- ä¼šå‘˜åŒºåŸŸ -->
  <section class="card section">
    <h2 class="group-title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li>äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li>è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li>å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li>å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
          <li>å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li>æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
        </ul>
      </div>
    </div>

    <!-- VIPç™»å½•åŒºåŸŸ -->
    <div class="group-title" style="margin-top:14px">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é‚®ç®± Email" required />
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>
            <div class="spacer"></div>
            <div class="muted">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- èŠå¤©æµ®çª— -->
<button class="ss-chat-fab" id="ssChatFab">é—®</button>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <div class="ss-chat-title">5X Â· æ™ºèƒ½åŠ©æ‰‹</div>
    <div class="ss-close" id="ssChatClose">âœ•</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" placeholder="è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ" />
    <button class="btn" id="ssChatSend">å‘é€</button>
  </div>
</div>

<script>
// ä¿®æ­£çš„å…«å­—è®¡ç®—ç±» - ç¡®ä¿1978-02-21 12:45å¾—åˆ°æ­£ç¡®ç»“æœï¼šæˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ
class AccurateBaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  // ä¿®æ­£å¹´æŸ±è®¡ç®— - 1978å¹´åº”è¯¥æ˜¯æˆŠåˆå¹´
  calculateYearPillar(year) {
    // ç”²å­å¹´å¼€å§‹äº1924å¹´ï¼Œæ¯60å¹´ä¸€ä¸ªå¾ªç¯
    const startYear = 1924;
    const cycleIndex = (year - startYear) % 60;
    const stemIndex = cycleIndex % 10;
    const branchIndex = cycleIndex % 12;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex]
    };
  }

  // ä¿®æ­£æœˆæŸ±è®¡ç®— - 1978å¹´2æœˆåº”è¯¥æ˜¯ç”²å¯…æœˆ
  calculateMonthPillar(year, month, day) {
    // æ ¹æ®èŠ‚æ°”ç¡®å®šæœˆä»½çš„åœ°æ”¯
    const jieqiMap = {
      1: 'å¯…', 2: 'å¯…', 3: 'å¯', 4: 'è¾°', 5: 'å·³', 6: 'åˆ',
      7: 'æœª', 8: 'ç”³', 9: 'é…‰', 10: 'æˆŒ', 11: 'äº¥', 12: 'å­'
    };
    
    const branch = jieqiMap[month] || 'å¯…';
    
    // æ ¹æ®å¹´å¹²ç¡®å®šæœˆå¹² - æˆŠå¹´åº”è¯¥æ˜¯ç”²å¯…æœˆ
    const yearStem = this.calculateYearPillar(year).stem;
    const yearStemIdx = this.HEAVENLY_STEMS.indexOf(yearStem);
    
    // äº”è™éè¯€ä¿®æ­£
    const monthStartMap = {
      0: 2, // ç”²å¹´ - ä¸™å¯…
      1: 4, // ä¹™å¹´ - æˆŠå¯…  
      2: 6, // ä¸™å¹´ - åºšå¯…
      3: 8, // ä¸å¹´ - å£¬å¯…
      4: 0, // æˆŠå¹´ - ç”²å¯…
      5: 2, // å·±å¹´ - ä¸™å¯…
      6: 4, // åºšå¹´ - æˆŠå¯…
      7: 6, // è¾›å¹´ - åºšå¯…
      8: 8, // å£¬å¹´ - å£¬å¯…
      9: 0  // ç™¸å¹´ - ç”²å¯…
    };
    
    const branchNum = this.EARTHLY_BRANCHES.indexOf(branch);
    const stemIdx = (monthStartMap[yearStemIdx] + branchNum) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  // ä¿®æ­£æ—¥æŸ±è®¡ç®— - 1978å¹´2æœˆ21æ—¥åº”è¯¥æ˜¯ç”²å¯…æ—¥
  calculateDayPillar(year, month, day) {
    // ä½¿ç”¨æ›´ç²¾ç¡®çš„åŸºå‡†æ—¥ï¼š1900å¹´1æœˆ31æ—¥ä¸ºç”²è¾°æ—¥
    const baseDate = new Date(1900, 0, 31); // 1900-01-31 ç”²è¾°æ—¥
    const targetDate = new Date(year, month - 1, day);
    const dayDiff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
    
    // ç”²å­åºå·è®¡ç®—
    const stemIdx = (dayDiff % 10 + 0) % 10; // ç”²ä¸º0
    const branchIdx = (dayDiff % 12 + 4) % 12; // è¾°ä¸º4
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: this.EARTHLY_BRANCHES[branchIdx]
    };
  }

  // ä¿®æ­£æ—¶æŸ±è®¡ç®— - ç”²å¯…æ—¥åˆæ—¶åº”è¯¥æ˜¯åºšåˆæ—¶
  calculateHourPillar(dayStem, hour) {
    const branchMap = {
      23: 'å­', 0: 'å­', 1: 'ä¸‘', 2: 'ä¸‘', 3: 'å¯…', 4: 'å¯…',
      5: 'å¯', 6: 'å¯', 7: 'è¾°', 8: 'è¾°', 9: 'å·³', 10: 'å·³',
      11: 'åˆ', 12: 'åˆ', 13: 'æœª', 14: 'æœª', 15: 'ç”³', 16: 'ç”³',
      17: 'é…‰', 18: 'é…‰', 19: 'æˆŒ', 20: 'æˆŒ', 21: 'äº¥', 22: 'äº¥'
    };
    
    // äº”é¼ éè¯€ä¿®æ­£
    const hourStartMap = {
      0: 0, // ç”²æ—¥ - ç”²å­
      1: 2, // ä¹™æ—¥ - ä¸™å­
      2: 4, // ä¸™æ—¥ - æˆŠå­
      3: 6, // ä¸æ—¥ - åºšå­
      4: 8, // æˆŠæ—¥ - å£¬å­
      5: 0, // å·±æ—¥ - ç”²å­
      6: 2, // åºšæ—¥ - ä¸™å­
      7: 4, // è¾›æ—¥ - æˆŠå­
      8: 6, // å£¬æ—¥ - åºšå­
      9: 8  // ç™¸æ—¥ - å£¬å­
    };
    
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (hourStartMap[dayIdx] + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getStemElement(stem) {
    const elementMap = {
      'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ',
      'åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'
    };
    return elementMap[stem] || '';
  }

  getBranchElement(branch) {
    const elementMap = {
      'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«',
      'åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'
    };
    return elementMap[branch] || '';
  }

  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length] || '';
  }

  // åˆ¤æ–­æ—¥ä¸»å¼ºå¼±å’Œæ ¼å±€
  analyzeDayMasterStrength(pillars, elements) {
    const dayStem = pillars.day.stem;
    const dayElement = this.getStemElement(dayStem);
    const monthBranch = pillars.month.branch;
    
    // å­£èŠ‚åˆ¤æ–­
    const seasonMap = {
      'å¯…':'æ˜¥','å¯':'æ˜¥','è¾°':'æ˜¥',
      'å·³':'å¤','åˆ':'å¤','æœª':'å¤', 
      'ç”³':'ç§‹','é…‰':'ç§‹','æˆŒ':'ç§‹',
      'äº¥':'å†¬','å­':'å†¬','ä¸‘':'å†¬'
    };
    
    const season = seasonMap[monthBranch] || 'ä¸­';
    
    // æ—¥ä¸»å¼ºå¼±åˆ¤æ–­
    let strengthScore = elements[dayElement] || 0;
    
    // å­£èŠ‚åŠ æˆ
    if ((season === 'æ˜¥' && dayElement === 'æœ¨') ||
        (season === 'å¤' && dayElement === 'ç«') ||
        (season === 'ç§‹' && dayElement === 'é‡‘') ||
        (season === 'å†¬' && dayElement === 'æ°´')) {
      strengthScore += 2;
    }
    
    let strength, pattern;
    if (strengthScore >= 4) {
      strength = 'ææ—º';
      pattern = 'å»ºç¦„æ ¼';
    } else if (strengthScore >= 3) {
      strength = 'åæ—º'; 
      pattern = 'èº«æ—ºæ ¼';
    } else if (strengthScore >= 2) {
      strength = 'ä¸­å’Œ';
      pattern = 'ä¸­å’Œæ ¼';
    } else {
      strength = 'åå¼±';
      pattern = 'èº«å¼±æ ¼';
    }
    
    return { strength, pattern, season };
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'ï¼Ÿ',branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // è®¡ç®—äº”è¡Œèƒ½é‡
    const elements = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(pillar => {
      if (pillar.stem && pillar.stem !== 'ï¼Ÿ') {
        const stemElement = this.getStemElement(pillar.stem);
        if (stemElement) elements[stemElement]++;
      }
      if (pillar.branch && pillar.branch !== 'ï¼Ÿ') {
        const branchElement = this.getBranchElement(pillar.branch);
        if (branchElement) elements[branchElement]++;
      }
    });

    const total = Object.values(elements).reduce((sum, count) => sum + count, 0) || 1;
    const percents = {
      wood: (elements['æœ¨'] / total) * 100,
      fire: (elements['ç«'] / total) * 100,
      earth: (elements['åœŸ'] / total) * 100,
      metal: (elements['é‡‘'] / total) * 100,
      water: (elements['æ°´'] / total) * 100
    };

    // åˆ†ææ—¥ä¸»å¼ºå¼±å’Œæ ¼å±€
    const strengthAnalysis = this.analyzeDayMasterStrength(pillars, elements);

    return { pillars, elements, percents, timeUnknown, strengthAnalysis };
  }
}

// å·¥å…·å‡½æ•°
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function showAuthErr(message) {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function hideAuthErr() {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
}

function lock(el, v) { if(el) el.disabled = v; }

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: 'å¹´æŸ±', pillar: pillars.year },
    { title: 'æœˆæŸ±', pillar: pillars.month },
    { title: 'æ—¥æŸ±', pillar: pillars.day },
    { title: 'æ—¶æŸ±', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === 'æ—¶æŸ±' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? 'ï¼Ÿ' : pillar.stem}${isUnknown ? 'ï¼Ÿ' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯è¡¨æ ¼
function displayDetailedInfo(pillars, timeUnknown = false) {
  const calculator = new AccurateBaziCalculator();
  
  // å¤©å¹²åœ°æ”¯
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : pillars.hour.branch);

  // äº”è¡Œ
  setText('year-element', `${calculator.getStemElement(pillars.year.stem)}${calculator.getBranchElement(pillars.year.branch)}`);
  setText('month-element', `${calculator.getStemElement(pillars.month.stem)}${calculator.getBranchElement(pillars.month.branch)}`);
  setText('day-element', `${calculator.getStemElement(pillars.day.stem)}${calculator.getBranchElement(pillars.day.branch)}`);
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : `${calculator.getStemElement(pillars.hour.stem)}${calculator.getBranchElement(pillars.hour.branch)}`);

  // çº³éŸ³
  setText('year-nayin', calculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', calculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', calculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : calculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// ç”Ÿæˆå…«å­—å‘½ç›˜
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const calculator = new AccurateBaziCalculator();
    const { pillars, elements, percents, timeUnknown: tu, strengthAnalysis } = calculator.calculateBazi(year, month, day, hour, timeUnknown);

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';

    // è®¾ç½®æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å…«å­—æŸ±å’Œè¯¦ç»†ä¿¡æ¯
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // æ›´æ–°äº”è¡Œèƒ½é‡æ¡
    setBar('bar-æœ¨', percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar('bar-ç«', percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar('bar-åœŸ', percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar('bar-é‡‘', percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar('bar-æ°´', percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡åˆ†æ
    const elementEntries = Object.entries(elements);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `äº”è¡Œä¸­${strongest}å…ƒç´ æœ€å¼ºï¼Œ${weakest}å…ƒç´ æœ€å¼±ã€‚`);

    // ç”Ÿæˆè¯¦ç»†åˆ†æ
    generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, tu);

    // ç”ŸæˆAIè§£è¯»
    generateAIInsight(pillars, percents, tu, strengthAnalysis);

    console.log('è®¡ç®—å‡ºçš„å…«å­—:', 
      pillars.year.stem + pillars.year.branch,
      pillars.month.stem + pillars.month.branch, 
      pillars.day.stem + pillars.day.branch,
      tu ? 'ï¼Ÿï¼Ÿ' : (pillars.hour.stem + pillars.hour.branch)
    );

  } catch (error) {
    console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
    showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// ç”Ÿæˆè¯¦ç»†åˆ†æ
function generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, timeUnknown) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  // åŸºæœ¬ä¿¡æ¯
  const name = $('name').value || 'æœªçŸ¥';
  const gender = $('gender').value === 'male' ? 'ç”·' : ($('gender').value === 'female' ? 'å¥³' : 'æœªé€éœ²');
  
  let basicInfo = `<p><strong>å§“åï¼š</strong>${name}</p>`;
  basicInfo += `<p><strong>æ€§åˆ«ï¼š</strong>${gender}</p>`;
  basicInfo += `<p><strong>æ—¥ä¸»ï¼š</strong>${dayStem}${dayElement}ï¼ˆ${strengthAnalysis.strength}ï¼‰</p>`;
  basicInfo += `<p><strong>æ ¼å±€ï¼š</strong>${strengthAnalysis.pattern}</p>`;
  basicInfo += `<p><strong>å­£èŠ‚ï¼š</strong>${strengthAnalysis.season}</p>`;
  
  $('basic-info').innerHTML = basicInfo;

  // æ€»ä½“å‘½è¿è§£è¯»
  let overallDestiny = '';
  if (strengthAnalysis.strength === 'åæ—º' || strengthAnalysis.strength === 'ææ—º') {
    overallDestiny = `<p>å‘½ä¸»${dayStem}${dayElement}ç”Ÿäº${strengthAnalysis.season}å­£ï¼Œèº«æ—ºæœ‰åŠ›ï¼Œæ€§æ ¼åšæ¯…æœæ–­ï¼Œæœ‰é¢†å¯¼æ‰èƒ½ã€‚</p>`;
  } else if (strengthAnalysis.strength === 'åå¼±') {
    overallDestiny = `<p>å‘½ä¸»${dayStem}${dayElement}ç”Ÿäº${strengthAnalysis.season}å­£ï¼Œèº«å¼±éœ€æ‰¶ï¼Œæ€§æ ¼æ¸©å’Œå†…æ•›ï¼Œå–„äºåˆä½œã€‚</p>`;
  } else {
    overallDestiny = `<p>å‘½ä¸»${dayStem}${dayElement}ç”Ÿäº${strengthAnalysis.season}å­£ï¼Œä¸­å’Œå¹³è¡¡ï¼Œæ€§æ ¼ç¨³é‡ï¼Œé€‚åº”åŠ›å¼ºã€‚</p>`;
  }
  
  $('overall-destiny').innerHTML = overallDestiny;

  // äº‹ä¸šåˆ†æ
  const careerAnalysis = `<p>${dayStem}${dayElement}æ—¥ä¸»ï¼Œé€‚åˆä»äº‹ä¸${getCareerAdvice(dayElement, elements)}ç›¸å…³çš„è¡Œä¸šã€‚${getCareerTrend(strengthAnalysis.strength)}</p>`;
  $('career-analysis').innerHTML = careerAnalysis;

  // è´¢å¯ŒçŠ¶å†µ
  const wealthAnalysis = `<p>${getWealthAnalysis(dayElement, elements, strengthAnalysis.strength)}</p>`;
  $('wealth-analysis').innerHTML = wealthAnalysis;

  // å©šå§»æ„Ÿæƒ…
  const marriageAnalysis = `<p>${getMarriageAnalysis(dayElement, gender, strengthAnalysis.strength)}</p>`;
  $('marriage-analysis').innerHTML = marriageAnalysis;

  // å¤§è¿æµå¹´
  generateLuckAnalysis(pillars, gender);
}

// èŒä¸šå»ºè®®
function getCareerAdvice(dayElement, elements) {
  const advice = {
    'æœ¨': 'æ•™è‚²ã€æ–‡åŒ–ã€è‰ºæœ¯ã€åŒ»ç–—',
    'ç«': 'ç§‘æŠ€ã€èƒ½æºã€å¨±ä¹ã€é¤é¥®',
    'åœŸ': 'æˆ¿åœ°äº§ã€å»ºç­‘ã€é‡‘èã€ç®¡ç†',
    'é‡‘': 'æ³•å¾‹ã€æœºæ¢°ã€é‡‘èã€æŠ€æœ¯',
    'æ°´': 'è´¸æ˜“ã€ç‰©æµã€æ—…æ¸¸ã€å’¨è¯¢'
  };
  return advice[dayElement] || 'å¤šå…ƒåŒ–é¢†åŸŸ';
}

// èŒä¸šè¶‹åŠ¿
function getCareerTrend(strength) {
  if (strength === 'åæ—º' || strength === 'ææ—º') {
    return 'é€‚åˆè‡ªä¸»åˆ›ä¸šæˆ–æ‹…ä»»é¢†å¯¼èŒä½ï¼Œä¸­å¹´åäº‹ä¸šæœ‰æˆã€‚';
  } else if (strength === 'åå¼±') {
    return 'é€‚åˆåœ¨ç¨³å®šç¯å¢ƒä¸­å‘å±•ï¼Œä¾é å›¢é˜Ÿåˆä½œè·å¾—æˆåŠŸã€‚';
  } else {
    return 'äº‹ä¸šå‘å±•å¹³ç¨³ï¼Œé€‚åˆåœ¨ä¸“ä¸šé¢†åŸŸæ·±è€•ã€‚';
  }
}

// è´¢å¯Œåˆ†æ
function getWealthAnalysis(dayElement, elements, strength) {
  const wealthElements = {
    'æœ¨': 'æœ¨æ—ºåˆ™è´¢æºå¹¿è¿›ï¼ŒåœŸä¸ºè´¢æ˜Ÿ',
    'ç«': 'ç«æ—ºåˆ™ååˆ©åŒæ”¶ï¼Œé‡‘ä¸ºè´¢æ˜Ÿ', 
    'åœŸ': 'åœŸæ—ºåˆ™ç§¯è“„ä¸°åšï¼Œæ°´ä¸ºè´¢æ˜Ÿ',
    'é‡‘': 'é‡‘æ—ºåˆ™è´¢è¿ç¨³å®šï¼Œæœ¨ä¸ºè´¢æ˜Ÿ',
    'æ°´': 'æ°´æ—ºåˆ™æµåŠ¨ç”Ÿè´¢ï¼Œç«ä¸ºè´¢æ˜Ÿ'
  };
  
  let analysis = wealthElements[dayElement] || '';
  
  if (strength === 'åæ—º' || strength === 'ææ—º') {
    analysis += ' èº«æ—ºèƒ½æ‹…è´¢ï¼Œä¸­å¹´åè´¢è¿äº¨é€šï¼Œä½†éœ€æ³¨æ„ç†è´¢è§„åˆ’ã€‚';
  } else if (strength === 'åå¼±') {
    analysis += ' èº«å¼±è´¢å¤šï¼Œéœ€å€ŸåŠ©ä»–äººåŠ›é‡æ±‚è´¢ï¼Œé€‚åˆç¨³å®šæ”¶å…¥ã€‚';
  } else {
    analysis += ' è´¢è¿å¹³ç¨³ï¼Œé€šè¿‡å‹¤å¥‹åŠªåŠ›å¯è·å¾—ç¨³å®šè´¢å¯Œã€‚';
  }
  
  return analysis;
}

// å©šå§»åˆ†æ
function getMarriageAnalysis(dayElement, gender, strength) {
  let analysis = '';
  
  if (gender === 'ç”·') {
    analysis = 'ç”·å‘½ä»¥è´¢ä¸ºå¦»ï¼Œ';
    if (strength === 'åæ—º' || strength === 'ææ—º') {
      analysis += 'èº«æ—ºèƒ½æ‹…è´¢ï¼Œå©šå§»ç¨³å®šï¼Œå¦»å­èƒ½å¹²ã€‚';
    } else {
      analysis += 'èº«å¼±éœ€æ‰¶ï¼Œæ™šå©šä¸ºå®œï¼Œå¦»å­å¤šä¸ºè´¤å†…åŠ©ã€‚';
    }
  } else if (gender === 'å¥³') {
    analysis = 'å¥³å‘½ä»¥å®˜ä¸ºå¤«ï¼Œ';
    if (strength === 'åæ—º' || strength === 'ææ—º') {
      analysis += 'èº«æ—ºå®˜æ˜Ÿæœ‰åˆ¶ï¼Œå©šå§»è‡ªä¸»ï¼Œä¸ˆå¤«æœ‰ä¸ºã€‚';
    } else {
      analysis += 'èº«å¼±å®˜æ˜Ÿä¸ºå¿Œï¼Œéœ€å¯»åŒ…å®¹ä¹‹ä¼´ä¾£ã€‚';
    }
  } else {
    analysis = 'å©šå§»æ„Ÿæƒ…éœ€ç»“åˆå…·ä½“å‘½å±€åˆ†æï¼Œä¸€èˆ¬æ¥è¯´' + (strength === 'åæ—º' ? 'èº«æ—ºè€…å©šå§»è‡ªä¸»' : 'èº«å¼±è€…éœ€å¯»æ‰¶æŒ') + 'ã€‚';
  }
  
  return analysis;
}

// ç”Ÿæˆå¤§è¿æµå¹´åˆ†æ
function generateLuckAnalysis(pillars, gender) {
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const baseAge = 5; // èµ·è¿å¹´é¾„
  const luckCycles = [
    { age: '5-14å²', desc: 'ç«¥å¹´è¿åŠ¿å¹³ç¨³ï¼Œå­¦ä¸šåŸºç¡€é˜¶æ®µ' },
    { age: '15-24å²', desc: 'é’å°‘å¹´æ—¶æœŸï¼Œæ€§æ ¼å½¢æˆå…³é”®æœŸ' },
    { age: '25-34å²', desc: 'äº‹ä¸šèµ·æ­¥é˜¶æ®µï¼Œç§¯ç´¯ç»éªŒæ—¶æœŸ' },
    { age: '35-44å²', desc: 'ä¸­å¹´å‘å±•æœŸï¼Œäº‹ä¸šä¸Šå‡é˜¶æ®µ' },
    { age: '45-54å²', desc: 'äººç”Ÿé»„é‡‘æœŸï¼Œæ”¶è·æˆæœä¹‹æ—¶' },
    { age: '55-64å²', desc: 'ç¨³å®šå‘å±•æœŸï¼Œè§„åˆ’æ™šå¹´ç”Ÿæ´»' }
  ];
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// ç”ŸæˆAIè§£è¯»
function generateAIInsight(pillars, percents, timeUnknown, strengthAnalysis) {
  const aiContent = $('aiContent');
  const aiChips = $('aiChips');
  
  // æ¨¡æ‹ŸAIåˆ†æåŠ è½½
  setTimeout(() => {
    const insight = `
      <p>æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œ${strengthAnalysis.strength}çš„${pillars.day.stem}${pillars.day.element}æ—¥ä¸»ï¼Œå‘½å±€ç‰¹ç‚¹é²œæ˜ï¼š</p>
      <p>â€¢ <strong>äº”è¡Œåˆ†å¸ƒï¼š</strong>æœ¨${Math.round(percents.wood)}%ã€ç«${Math.round(percents.fire)}%ã€åœŸ${Math.round(percents.earth)}%ã€é‡‘${Math.round(percents.metal)}%ã€æ°´${Math.round(percents.water)}%</p>
      <p>â€¢ <strong>æ ¼å±€ç‰¹ç‚¹ï¼š</strong>${strengthAnalysis.pattern}ï¼Œ${getPatternInsight(strengthAnalysis.pattern)}</p>
      <p>â€¢ <strong>å‘å±•å»ºè®®ï¼š</strong>${getDevelopmentAdvice(pillars.day.element, strengthAnalysis.strength)}</p>
    `;
    
    aiContent.innerHTML = insight;
    
    // ç”Ÿæˆäº¤äº’èŠ¯ç‰‡
    const chips = [
      'è¯¦ç»†äº‹ä¸šåˆ†æ',
      'è´¢è¿æŠ•èµ„å»ºè®®', 
      'å©šå§»æ„Ÿæƒ…è§£è¯»',
      'å¥åº·å…»ç”ŸæŒ‡å¯¼',
      'æµå¹´è¿åŠ¿é¢„æµ‹'
    ];
    
    aiChips.innerHTML = '';
    chips.forEach(chipText => {
      const chip = document.createElement('button');
      chip.className = 'chip';
      chip.textContent = chipText;
      chip.addEventListener('click', () => {
        showAuthErr('æ­¤åŠŸèƒ½éœ€è¦VIPä¼šå‘˜æƒé™');
      });
      aiChips.appendChild(chip);
    });
    
  }, 1500);
}

// æ ¼å±€æ´å¯Ÿ
function getPatternInsight(pattern) {
  const insights = {
    'å»ºç¦„æ ¼': 'è‡ªç«‹è‡ªå¼ºï¼Œæœ‰å¼€åˆ›ç²¾ç¥',
    'èº«æ—ºæ ¼': 'ç²¾åŠ›å……æ²›ï¼Œæ‰§è¡ŒåŠ›å¼º',
    'èº«å¼±æ ¼': 'å¿ƒæ€ç»†è…»ï¼Œå–„äºåˆä½œ', 
    'ä¸­å’Œæ ¼': 'å¹³è¡¡ç¨³å®šï¼Œé€‚åº”åŠ›å¼º'
  };
  return insights[pattern] || 'éœ€è¦å…·ä½“åˆ†æ';
}

// å‘å±•å»ºè®®
function getDevelopmentAdvice(dayElement, strength) {
  const baseAdvice = {
    'æœ¨': 'å®œå‘ä¸œå‘å±•ï¼Œä»äº‹æ–‡åŒ–æ•™è‚²è¡Œä¸š',
    'ç«': 'å®œå‘å—å‘å±•ï¼Œä»äº‹ç§‘æŠ€èƒ½æºé¢†åŸŸ',
    'åœŸ': 'å®œå±…ä¸­å‘å±•ï¼Œä»äº‹æˆ¿åœ°äº§é‡‘èä¸š', 
    'é‡‘': 'å®œå‘è¥¿å‘å±•ï¼Œä»äº‹æ³•å¾‹æŠ€æœ¯è¡Œä¸š',
    'æ°´': 'å®œå‘åŒ—å‘å±•ï¼Œä»äº‹è´¸æ˜“ç‰©æµé¢†åŸŸ'
  };
  
  const strengthAdvice = strength === 'åæ—º' ? 
    'æ³¨æ„æ§åˆ¶è„¾æ°”ï¼Œå¤šå¬å–ä»–äººæ„è§' : 
    'å¢å¼ºè‡ªä¿¡ï¼Œä¸»åŠ¨æŠŠæ¡æœºä¼š';
    
  return (baseAdvice[dayElement] || 'æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å‘å±•æ–¹å‘') + 'ã€‚' + strengthAdvice;
}

// åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');
  
  if (!chatFab || !chatPanel) return;
  
  chatFab.addEventListener('click', () => {
    chatPanel.style.display = 'block';
  });
  
  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });
  
  function addMessage(text, isUser = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    msgDiv.textContent = text;
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  
  chatSend.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (!text) return;
    
    addMessage(text, true);
    chatInput.value = '';
    
    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
      const replies = [
        'è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œè®©æˆ‘ä¸ºæ‚¨è¯¦ç»†åˆ†æ...',
        'æ ¹æ®æ‚¨çš„å…«å­—ç‰¹ç‚¹ï¼Œæˆ‘å»ºè®®...',
        'è¿™ä¸ªé—®é¢˜éœ€è¦ç»“åˆæ‚¨çš„å…·ä½“å‘½å±€æ¥çœ‹...',
        'ä»äº”è¡Œè§’åº¦æ¥çœ‹ï¼Œæ‚¨çš„å‘½å±€æ˜¾ç¤º...'
      ];
      addMessage(replies[Math.floor(Math.random() * replies.length)]);
    }, 1000);
  });
  
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      chatSend.click();
    }
  });
}

// åˆå§‹åŒ–æ—¶é—´æœªçŸ¥åŠŸèƒ½
function initTimeUnknown() {
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }
}

// åˆå§‹åŒ–è¯­è¨€æ”¯æŒ
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (langSelect) {
    langSelect.addEventListener('change', () => {
      // è¿™é‡Œå¯ä»¥æ·»åŠ å¤šè¯­è¨€åˆ‡æ¢é€»è¾‘
      console.log('åˆ‡æ¢è¯­è¨€:', langSelect.value);
    });
  }
}

// VIPç™»å½•ç³»ç»Ÿ
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){
    return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') };
  }finally{
    clearTimeout(timer);
  }
}

function strongPwd(pw){ 
  return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); 
}

// æ³¨å†ŒåŠŸèƒ½
$('registerForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');
  if(!strongPwd(password)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');
  lock($('registerBtn'),true);
  try{
    const res=await fetchJSON('/api/register',{email,password});
    if(res.ok===true){ 
      localStorage.setItem('vipEmail',email); 
      showAuthErr('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚');
      return; 
    }
    if((res.msg||"").toString().toLowerCase()==='exists'){ 
      await loginFlow(email,password); 
      return; 
    }
    return showAuthErr('æ³¨å†Œå¤±è´¥ï¼š' + (res.msg||''));
  }catch(err){ showAuthErr('æ³¨å†Œå¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('registerBtn'),false); }
});

// ç™»å½•åŠŸèƒ½
async function loginFlow(email,password){
  const res = await fetchJSON('/api/login', { email, password });
  const msg=(res.msg||"").toString().toLowerCase();
  let expired=false;
  if(res.expired===true) expired=true;
  else if(msg==='expired') expired=true;
  else if(res.expiresAt){
    const ts=Date.parse(res.expiresAt);
    if(!Number.isNaN(ts)&&ts<Date.now()) expired=true;
  }

  if(expired){
    const go=confirm('ä¼šå‘˜å·²è¿‡æœŸã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ');
    if(go){
      const a=document.createElement('a');
      a.href='https://yourshopifyshop.com/products/monthly-vip';
      a.target='_blank'; a.rel='noopener noreferrer';
      document.body.appendChild(a); a.click(); a.remove();
    }
    return;
  }

  if(res.ok===true){
    localStorage.setItem('vipEmail',res.email||email);
    localStorage.setItem('vipStatus', 'active');
    showAuthErr('ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥ã€‚');
    return;
  }

  if(msg==='no_account') return showAuthErr('è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
  if(msg==='wrong_pwd') return showAuthErr('å¯†ç é”™è¯¯');
  const extra = res.msg ? ` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}` : '';
  return showAuthErr('ç™»å…¥å¤±è´¥ï¼š' + extra);
}

$('loginForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');
  lock($('loginBtn'),true);
  try{ await loginFlow(email,password); }
  catch(err){ showAuthErr('ç™»å…¥å¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('loginBtn'),false); }
});

// é‡ç½®å¯†ç åŠŸèƒ½
$('resetBtn')?.addEventListener('click', async ()=>{
  hideAuthErr();
  let email=prompt('è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š'); 
  if(email===null) return; 
  email=email.trim(); 
  if(!email) return showAuthErr('é‚®ç®±ä¸èƒ½ä¸ºç©º');
  let newPassword=prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š'); 
  if(newPassword===null) return; 
  newPassword=newPassword.trim(); 
  if(!newPassword) return showAuthErr('å¯†ç ä¸èƒ½ä¸ºç©º');
  if(!strongPwd(newPassword)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');
  lock($('resetBtn'),true);
  try{
    const res=await fetchJSON('/api/reset',{email,newPassword});
    if(!res.ok){ const extra=res.msg?` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}`:''; return showAuthErr('é‡è®¾å¤±è´¥ï¼š' + extra); }
    alert('å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚');
  }catch(err){ showAuthErr('é‡è®¾å¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('resetBtn'),false); }
});

// åˆå§‹åŒ–å‡½æ•°
function init() {
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸º1978-02-21
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    birthdateInput.value = '1978-02-21';
  }

  // ç»‘å®šäº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // å›è½¦é”®å¿«é€Ÿç”Ÿæˆ
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('å…«å­—å‘½ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
