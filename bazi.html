
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* 保持你的原有样式，并修复/补全少量细节 */
:root{
  --bg:#0b0f14;
  --bg-accent:#0e1520;
  --card:#11161dcc;
  --surface:#0f1624;
  --line:#1f2a36;
  --text:#e8edf3;
  --muted:#98a7b7;

  --brand:#d4af37;
  --gold:#d4af37;
  --gold2:#f2d27a;
  --accent:#58b9ff;

  --radius:14px;
  --radius-sm:10px;
  --radius-lg:18px;

  --shadow:0 8px 30px rgba(0,0,0,.35);
  --shadow-sm:0 4px 14px rgba(0,0,0,.28);

  --container:1100px;
  --gap:12px;
  --pad:18px;

  /* 修复：添加正确的focus变量 */
  --focus: 0 0 0 2px rgba(212,175,55,0.2);

  /* 仅供注释说明：媒体查询仍用固定数值写 */
  --bp-s:520px;
  --bp-m:760px;
  --bp-l:900px;
}

/* Reset + base */
*,
*::before,
*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
    linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}

.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}

.site-header{
  position:sticky; top:0; z-index:10;
  background:rgba(11,15,20,.8);
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:var(--shadow-sm);
  font-weight:800; color:#ffe084
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}

.lang{display:flex; align-items:center; gap:8px}
.lang select{
  appearance:none; min-width:140px;
  border-radius:10px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:10px 34px 10px 12px; font-size:0.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

.section{margin-top:18px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  padding:var(--pad);
  margin:16px 0;
}
.h2{
  font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084;
  display:flex; gap:8px; align-items:center
}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}

.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width: 760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row.cols-2{grid-template-columns:1fr 1fr}
}

input,select{
  width:100%;
  border-radius:12px; border:1px solid #243244;
  background:var(--bg-accent); color:var(--text);
  padding:12px 12px; font-size:15px; outline:0;
}
input::placeholder{color:#6f8092}
input:focus, select:focus{box-shadow:var(--focus); border-color:#3a4c63}

.btn{
  display:inline-grid; place-items:center;
  padding:12px 16px; border-radius:12px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919; font-weight:800; cursor:pointer;
  transition:transform .2s ease, box-shadow .2s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}

.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width: 520px){
  .pillars{grid-template-columns:repeat(2,1fr)}
}

.bazi-table{
  width:100%; border-collapse:collapse; margin-top:12px;
  background:var(--surface); border-radius:8px; overflow:hidden
}
.bazi-table th,.bazi-table td{
  padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle
}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
/* 小屏表格可横向滚动：把 table 用 div 包一层 .bazi-table-wrap 即可 */
.bazi-table-wrap{overflow:auto}
@media (max-width: 420px){
  .bazi-table th,.bazi-table td{padding:8px 10px}
}

.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:60px 1fr 60px; gap:10px; align-items:center}

.error-message{
  background:rgba(255,90,95,.1);
  border:1px solid #ff5a5f; border-radius:8px;
  padding:10px; display:none; margin-top:10px
}
.badge-warn{display:inline-block; padding:2px 8px; margin-left:6px; border:1px solid #ffb84d; border-radius:999px; color:#ffb84d; font-size:0.82rem}
.muted{color:var(--muted)}

.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}

.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}

.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.rating{display:flex; align-items:center; gap:8px; margin:8px 0}
.rating-stars{color:var(--gold2)}
.tag{display:inline-block; background:rgba(212,175,55,.1); color:var(--gold2); padding:4px 8px; border-radius:6px; font-size:0.85rem; margin:2px}

.luck-grid{display:grid; gap:10px}
.luck-item{background:rgba(255,255,255,.05); border-radius:8px; padding:12px; border-left:3px solid var(--gold2)}
.luck-year{font-weight:700; color:var(--gold2)}
.luck-desc{font-size:0.9rem; margin-top:4px}

.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width: 900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px;
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
  border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)
}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

.ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0}
.ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px}
.ai-box-c{color:#e8edf3; line-height:1.7}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
.chip{padding:6px 10px; border-radius:999px; border:1px solid #2a3546; background:#0e1520; color:#e8edf3; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease}
.chip:hover{border-color:#f2d27a; box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
.chip:disabled{opacity:.6; cursor:not-allowed}

.skeleton{display:grid; gap:8px}
.skeleton div{height:12px; border-radius:6px; background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431); animation:sh 1.2s infinite}
@keyframes sh{0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5}}

.ai-lock-overlay{margin-top:10px; padding-top:10px; border-top:1px solid #1f2a36; text-align:center}
.ai-lock-overlay .tip{color:#ffd88a; font-weight:700; margin-bottom:4px}
.ai-lock-overlay .sub{color:var(--muted)}

.detail-view{display:none}
.detail-header{display:flex; align-items:center; gap:12px; margin-bottom:20px}
.back-btn{background:rgba(212,175,55,.1); border:1px solid rgba(212,175,55,.3); color:var(--gold2); padding:8px 16px; border-radius:8px; cursor:pointer}
.detail-content{line-height:1.8}
.detail-section{margin-bottom:24px}
.detail-section h4{color:var(--gold2); margin-bottom:12px; font-size:1.1rem}
.action-list{list-style:none; padding:0; margin:0}
.action-list li{margin-bottom:8px; padding-left:20px; position:relative}
.action-list li::before{content:"•"; color:var(--gold2); position:absolute; left:0; top:0}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}

/* Motion 优化 */
@media (prefers-reduced-motion: reduce){
  *{animation:none !important; transition:none !important}
}

/* Utilities */
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
.chips-container{display:flex; flex-wrap:wrap; gap:8px; margin:20px 0; justify-content:center}

/* VIP section demo 可见 */
.vip-section{display:block !important}

/* Butler 组件 */
.butler-professional{display:none; margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:20px}
.butler-header{display:flex; align-items:center; gap:10px; margin-bottom:20px; color:var(--gold2); font-size:1.2rem; font-weight:700}
.butler-content{line-height:1.8; max-height:600px; overflow-y:auto; padding:15px; background:var(--surface); border-radius:10px; border:1px solid #253245}
.butler-section{margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #253245}
.butler-section h4{color:var(--gold2); margin-bottom:10px; font-size:1.1rem}
.butler-chat{margin-top:20px; border-top:1px solid var(--line); padding-top:15px}
.chat-messages{height:200px; overflow-y:auto; margin-bottom:15px; padding:10px; background:var(--surface); border-radius:8px; border:1px solid #253245}
.chat-input-area{display:flex; gap:10px}
.chat-input-area input{flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3}
.chat-send-btn{padding:10px 20px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer}

/* ==== remove the brown/gold focus outline ==== */
input:focus,
select:focus,
textarea:focus{
  outline: none !important;
  box-shadow: none !important;
  border-color: #243244 !important;
}
button:focus,
.btn:focus,
a:focus{
  outline: none !important;
  box-shadow: none !important;
}

/* (optional) also remove tap highlight on mobile */
*{ -webkit-tap-highlight-color: transparent; }    
.chip:hover{ border-color:#2a3546; box-shadow:none; }

/* 浮窗聊天样式 */
.chat-float {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 350px;
  height: 500px;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  z-index: 1000;
  display: none;
  flex-direction: column;
}

.chat-float-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--line);
  background: rgba(212,175,55,.1);
  color: var(--gold2);
  font-weight: 700;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
}

.chat-float-close {
  background: none;
  border: none;
  color: var(--gold2);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
}

.chat-float-close:hover {
  background: rgba(212,175,55,.2);
}

.chat-float-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0;
}

.chat-float-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  background: var(--surface);
}

.chat-float-input-area {
  padding: 12px;
  border-top: 1px solid var(--line);
  background: var(--bg-accent);
}

.chat-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(180deg,#fff9e6,#e6c76e);
  border: 1px solid #e6c76e;
  color: #191919;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(230,199,110,.3);
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-toggle-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(230,199,110,.5);
}

/* 响应式调整 */
@media (max-width: 768px) {
  .chat-float {
    width: 300px;
    height: 400px;
    bottom: 10px;
    right: 10px;
  }
  
  .chat-toggle-btn {
    width: 50px;
    height: 50px;
    bottom: 10px;
    right: 10px;
  }
}    
</style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com/" target="_self">
        <span class="brand-badge">5X</span>
      <span class="title" data-i18n="brand.subtitle">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="nav.langLabel">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN" data-i18n="lang.zh-CN">简体中文</option>
        <option value="zh-TW" data-i18n="lang.zh-TW">繁體中文</option>
        <option value="en"    data-i18n="lang.en">English</option>
        <option value="ja"    data-i18n="lang.ja">日本語</option>
        <option value="th"    data-i18n="lang.th">ไทย</option>
        <option value="ms"    data-i18n="lang.ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2" data-i18n="app.title">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="form.nameLabel">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted" data-i18n="form.genderLabel">性别</label>
        <select id="gender">
          <option value=""        data-i18n="form.gender.hidden">不透露</option>
          <option value="male"    data-i18n="form.gender.male">男性</option>
          <option value="female"  data-i18n="form.gender.female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="form.calendarLabel">历法</label>
        <select id="calendar">
          <option value="gregorian" data-i18n="form.calendar.gregorian">阳历</option>
          <option value="lunar"     data-i18n="form.calendar.lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="form.birthdateLabel">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted" data-i18n="form.birthtimeLabel">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span data-i18n="form.timeUnknown">出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText" data-i18n="btn.generate">生成八字</span>
          <span id="genBtnLoading" style="display:none" data-i18n="btn.loading">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

<section id="result" style="display:none;">
    <div class="card">
      <div class="h2" data-i18n="result.title">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>
     
      <table class="bazi-table">
        <thead>
          <tr>
            <th></th>
            <th data-i18n="pillar.year">年柱</th>
            <th data-i18n="pillar.month">月柱</th>
            <th data-i18n="pillar.day">日柱</th>
            <th data-i18n="pillar.hour">时柱</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td data-i18n="table.row.stem">天干</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.branch">地支</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.fiveElem">五行</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.nayin">纳音</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2" data-i18n="energy.title">五行能量分析</div>
      <div class="bar-row"><span data-i18n="elem.wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span data-i18n="elem.water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted"></div>
    </div>
  </section>

  <section id="butlerProfessional" class="butler-professional">
    <div class="butler-header">
      <span data-i18n="pro.title">🧙‍♂️ 心怜管家 · 专业命理分析</span>
    </div>
    <div class="butler-content" id="professionalReport"></div>
</section>
    
<!-- 浮窗聊天按钮 -->
<button class="chat-toggle-btn" id="chatToggle" data-i18n="chat.toggle">问</button>

<!-- 浮窗聊天窗口 -->
<div class="chat-float" id="chatFloat">
  <div class="chat-float-header">
    <span data-i18n="pro.title">🧙‍♂️ 心怜管家 · 专业命理分析</span>
    <button class="chat-float-close" id="chatClose">×</button>
  </div>
  <div class="chat-float-body">
    <div class="chat-float-messages" id="chatMessages">
      <div class="ss-msg" data-i18n="pro.welcome">您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。</div>
    </div>
    <div class="chat-float-input-area">
      <div style="display: flex; gap: 8px;">
        <input type="text" id="chatInput" placeholder="请输入您的问题..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #253245; background: #0e1520; color: #e8edf3;">
        <button class="chat-send-btn" id="chatSend" data-i18n="chat.send" style="padding: 10px 16px; background: var(--gold); color: #191919; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">发送</button>
      </div>
    </div>
  </div>
</div>  

  <section class="card section vip-section">
    <h2 class="group-title" data-i18n="vip.title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip.group.astrology">🗝 命理空间专属内容</div>
        <ul>
          <li data-i18n="vip.astrology.match">姻缘方向：恋爱缘分、婚姻走势</li>
          <li data-i18n="vip.astrology.career">事业方向：职场发展、创业潜力</li>
          <li data-i18n="vip.astrology.wealth">财运方向：财位分析、理财时机</li>
          <li data-i18n="vip.astrology.pet">宠物命理：伴侣动物的性格与缘分</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip.group.spiritual">🌙 心怜空间专属内容</div>
        <ul>
          <li data-i18n="vip.spiritual.record">灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li data-i18n="vip.spiritual.courses">命理课程：八字 / 塔罗 / 占星 / 灵数</li>
          <li data-i18n="vip.spiritual.family">家族纪念系统：亲人灵性纪念 & 延续</li>
          <li data-i18n="vip.spiritual.practice">每周能量练习 / 神明仪式任务</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="vip.login.title">💎 登入 VIP 功能</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <div class="panel">
          <div class="head" data-i18n="auth.header">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="邮箱 Email">
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="密码 Password（至少8位，含大小写数字符号）">
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="auth.login">登入账户</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="auth.reset">🔑 重设密码</button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="auth.register">注册账户</button>
              <div class="muted" data-i18n="auth.freeTrialNote">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <div class="panel">
          <div class="head" data-i18n="vip.services.header">会员服务</div>
          <div class="body">
            <div class="row one">
              <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="vip.upgrade">💎 升级为 VIP（月费）</a>
            </div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="vip.back">← 返回命理商城</a>
            </div>
            <div class="muted" data-i18n="vip.priceNote">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer data-i18n="footer.copy">© 5XLiving • Astro Sanctuary</footer>
</main>
  
<script>window.API_BASE='https://throbbing-lab-1440.hello5xliving.workers.dev';</script>
<script>
(() => {
  'use strict';

  /* ===== Basic Config ===== */
  const CONFIG = { API_BASE: '' }; // local calc
  const SG_TZ  = 'Asia/Singapore';

  /* ===== I18N (fixed / syntax-clean) ===== */
const I18N = {
  'zh-CN': {
    // ... 您现有的简体中文翻译保持不变 ...
  },
  
  'zh-TW': {
    brand:{subtitle:'5xLiving · 八字簡評'}, nav:{langLabel:'語言'},
    lang:{'zh-CN':'簡體中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu'},
    app:{title:'八字命理 · 快速排盤'},
    form:{nameLabel:'姓名（可選）',namePlaceholder:'你的稱呼（用於個性化）',genderLabel:'性別',gender:{hidden:'不透露',male:'男性',female:'女性'},calendarLabel:'曆法',calendar:{gregorian:'陽曆',lunar:'農曆'},birthdateLabel:'出生日期',birthtimeLabel:'出生時間',timeUnknown:'出生時間不詳'},
    btn:{generate:'生成八字',loading:'計算中...'},
    result:{title:'您的生辰八字命盤'},
    pillar:{year:'年柱',month:'月柱',day:'日柱',hour:'時柱'},
    table:{row:{stem:'天干',branch:'地支',fiveElem:'五行',nayin:'納音'}},
    energy:{title:'五行能量分析'},
    elem:{wood:'木',fire:'火',earth:'土',metal:'金',water:'水'},
    pro:{title:'🧙‍♂️ 心憐管家 · 專業命理分析',welcome:'您好！我是您的專業命理顧問，已為您生成詳細分析報告。有什麼具體問題可以隨時問我。'},
    chat:{send:'發送',placeholder:'請輸入您的問題...',toggle:'問'},
    vip:{title:'🌙 會員區域 VIP Segment',group:{astrology:'🗝 命理空間專屬內容',spiritual:'🌙 心憐空間專屬內容'},
      astrology:{match:'姻緣方向：戀愛緣分、婚姻走勢',career:'事業方向：職場發展、創業潛力',wealth:'財運方向：財位分析、理財時機',pet:'寵物命理：伴侶動物的性格與緣分'},
      spiritual:{record:'靈性記錄：照片、夢境、聲音、願望祈禱',courses:'命理課程：八字 / 塔羅 / 占星 / 靈數',family:'家族紀念系統：親人靈性紀念 & 延續',practice:'每週能量練習 / 神明儀式任務'},
      login:{title:'💎 登入 VIP 功能'}, services:{header:'會員服務'},
      upgrade:'💎 升級為 VIP（月費）', back:'← 返回命理商城', priceNote:'$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）'
    },
    auth:{header:'賬戶登錄 / 註冊',login:'登入賬戶',reset:'🔑 重設密碼',register:'註冊賬戶',freeTrialNote:'註冊賬號贈送一次免費體驗',emailPlaceholder:'郵箱 Email',passwordPlaceholder:'密碼 Password（至少8位，含大小寫數字符號）'},
    footer:{copy:'© 5XLiving • Astro Sanctuary'},
    err:{fillBirthdate:'請填寫出生日期',invalidDate:'無效的日期格式，請用 YYYY-MM-DD',generateFail:'生成失敗，請稍後重試'},
    ui:{unknown:'未知',timeUnknown:'時間不詳',hourSuffix:'{hh}:{mm}',birthSummary:'出生日期: {y}年{m}月{d}日 {timeText}',balance:'五行中{strongest}最強，{weakest}最弱。'},
    badge:{noHour:'未納入時柱'},
    chatDyn:{autoReply:'收到：{q}。稍後可在專業報告相應章節找到要點。'},
    elemNames:{木:'木',火:'火',土:'土',金:'金',水:'水'},
    report:{hourUnknownTip:'⚠️ 提示：因出生時間不詳，部分分析僅供參考。',tipTitle:'提示',generating:'正在生成專業分析報告...',failed:'報告生成失敗，請稍後重試'},
    reportTitles:{overview:'📊 命盤總覽',fiveElements:'🌿 五行分析',tenGods:'⚡ 十神配置',useful:'🔑 喜用神',relationship:'💕 感情婚姻',career:'💼 事業發展',wealth:'💰 財運分析',health:'🌡️ 健康養生',nearTerm:'🔮 近期運勢',actions:'📝 行動清單'},
    reportLabels:{
      dayMaster:'日主命理',strength:'日主強弱',usefulSpirit:'喜用神',
      elementCount:'五行個數',elementStrength:'五行旺衰',supportElements:'幫扶五行',restrainElements:'克泄五行',missingElements:'五行所缺',
      traits:'感情特質',marriageAdvice:'婚姻建議',relationshipTips:'相處之道',
      suitableCareers:'適合行業',careerAdvice:'發展建議',favorableDirections:'有利方位',
      wealthCharacteristics:'財運特點',wealthDirections:'求財方向',financialAdvice:'理財建議',
      healthCharacteristics:'體質特點',healthTips:'注意事項',wellnessAdvice:'養生建議',
      overallFortune:'整體運勢',favorableTiming:'有利時機',cautions:'注意事項'
    },
    'report.dayMaster.jia':'甲木命：有積極性的開拓精神，精力旺盛',
    'report.dayMaster.yi':'乙木命：性格柔順，喜行善事，有同情心',
    'report.dayMaster.bing':'丙火命：熱情豪爽，自信好勝，善言健談',
    'report.dayMaster.ding':'丁火命：敦厚樸實，重信守義',
    'report.dayMaster.wu':'戊土命：有積極性，幹一行易於對事物熱衷',
    'report.dayMaster.ji':'己土命：和緩，謹慎，心靈手巧',
    'report.dayMaster.geng':'庚金命：積極進取，勇敢果決',
    'report.dayMaster.xin':'辛金命:沉著坦直無私，待人接物認真',
    'report.dayMaster.ren':'壬水命：心胸寬廣，機智靈敏，喜歡自由，討厭束縛',
    'report.dayMaster.gui':'癸水命：逞強頑固，是努力家',
    'report.marriage.stable':'婚姻較為穩定，適合建立長期關係',
    'report.marriage.experienced':'感情經歷可能較多，需要找到真正適合的伴侶',
    'report.marriage.default':'婚姻需要雙方共同努力經營',
    'report.career.leadership':'適合管理崗位或自主創業，有領導潛力',
    'report.career.business':'適合商業、金融領域，財運較好',
    'report.career.creative':'適合創意、藝術、技術類工作',
    'report.career.steady':'穩紮穩打，在專業領域深耕發展',
    'report.health.tips.jia':'定期檢查肝功能，保護視力',
    'report.health.tips.yi':'注意情緒調節，避免眼部疲勞',
    'report.health.tips.bing':'控制情緒，避免熬夜',
    'report.health.tips.ding':'保證充足睡眠，避免過度緊張',
    'report.health.tips.wu':'規律飲食，避免暴飲暴食',
    'report.health.tips.ji':'注意飲食衛生，避免潮濕環境',
    'report.health.tips.geng':'注意保暖，避免乾燥環境',
    'report.health.tips.xin':'保持空氣流通，避免煙塵',
    'report.health.tips.ren':'保持水分平衡，避免受涼，注意腎臟保養',
    'report.health.tips.gui':'適量飲水，避免過度勞累'
  },

  'en': {
    brand:{subtitle:'5xLiving · Bazi Analysis'}, nav:{langLabel:'Language'},
    lang:{'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'},
    app:{title:'Bazi Destiny · Quick Chart'},
    form:{nameLabel:'Name (Optional)',namePlaceholder:'Your name (for personalization)',genderLabel:'Gender',gender:{hidden:'Not specified',male:'Male',female:'Female'},calendarLabel:'Calendar',calendar:{gregorian:'Solar',lunar:'Lunar'},birthdateLabel:'Birth Date',birthtimeLabel:'Birth Time',timeUnknown:'Time unknown'},
    btn:{generate:'Generate Bazi',loading:'Calculating...'},
    result:{title:'Your Bazi Destiny Chart'},
    pillar:{year:'Year',month:'Month',day:'Day',hour:'Hour'},
    table:{row:{stem:'Heavenly Stem',branch:'Earthly Branch',fiveElem:'Five Elements',nayin:'Nayin'}},
    energy:{title:'Five Elements Analysis'},
    elem:{wood:'Wood',fire:'Fire',earth:'Earth',metal:'Metal',water:'Water'},
    pro:{title:'🧙‍♂️ Professional Destiny Analysis',welcome:'Hello! I am your professional destiny consultant. Feel free to ask me any questions.'},
    chat:{send:'Send',placeholder:'Enter your question...',toggle:'Ask'},
    vip:{title:'🌙 VIP Members Area',group:{astrology:'🗝 Destiny Space',spiritual:'🌙 Spiritual Space'},
      astrology:{match:'Relationship Direction: Love & Marriage',career:'Career Direction: Workplace & Entrepreneurship',wealth:'Wealth Direction: Financial Analysis',pet:'Pet Destiny: Animal Companions'},
      spiritual:{record:'Spiritual Records: Photos, Dreams, Wishes',courses:'Destiny Courses: Bazi / Tarot / Astrology',family:'Family Memorial System',practice:'Weekly Energy Practice'},
      login:{title:'💎 VIP Login'}, services:{header:'VIP Services'},
      upgrade:'💎 Upgrade to VIP (Monthly)', back:'← Back to Shop', priceNote:'$9.9 / month VIP (Destiny + Spiritual + Courses)'
    },
    auth:{header:'Login / Register',login:'Login',reset:'🔑 Reset Password',register:'Register',freeTrialNote:'Free trial with registration',emailPlaceholder:'Email',passwordPlaceholder:'Password (min 8 chars, mixed case)'},
    footer:{copy:'© 5XLiving • Astro Sanctuary'},
    err:{fillBirthdate:'Please enter birth date',invalidDate:'Invalid date format, use YYYY-MM-DD',generateFail:'Generation failed, please try again'},
    ui:{unknown:'Unknown',timeUnknown:'Time unknown',hourSuffix:'{hh}:{mm}',birthSummary:'Birth Date: {y}/{m}/{d} {timeText}',balance:'{strongest} is strongest, {weakest} is weakest.'},
    badge:{noHour:'Hour not included'},
    chatDyn:{autoReply:'Received: {q}. Check professional report for details.'},
    elemNames:{木:'Wood',火:'Fire',土:'Earth',金:'Metal',水:'Water'},
    report:{hourUnknownTip:'⚠️ Note: Analysis limited due to unknown birth time.',tipTitle:'Note',generating:'Generating professional report...',failed:'Report generation failed'},
    reportTitles:{overview:'📊 Chart Overview',fiveElements:'🌿 Elements Analysis',tenGods:'⚡ Ten Gods',useful:'🔑 Useful Elements',relationship:'💕 Relationships',career:'💼 Career',wealth:'💰 Wealth',health:'🌡️ Health',nearTerm:'🔮 Recent Fortune',actions:'📝 Action Plan'},
    reportLabels:{
      dayMaster:'Day Master',strength:'Strength',usefulSpirit:'Useful Elements',
      elementCount:'Elements Count',elementStrength:'Elements Strength',supportElements:'Supporting',restrainElements:'Restraining',missingElements:'Missing Elements',
      traits:'Relationship Traits',marriageAdvice:'Marriage Advice',relationshipTips:'Relationship Tips',
      suitableCareers:'Suitable Careers',careerAdvice:'Career Advice',favorableDirections:'Favorable Directions',
      wealthCharacteristics:'Wealth Traits',wealthDirections:'Wealth Directions',financialAdvice:'Financial Advice',
      healthCharacteristics:'Health Traits',healthTips:'Health Tips',wellnessAdvice:'Wellness Advice',
      overallFortune:'Overall Fortune',favorableTiming:'Good Timing',cautions:'Cautions'
    },
    'report.dayMaster.jia':'Jia Wood: Pioneering spirit, energetic',
    'report.dayMaster.yi':'Yi Wood: Gentle, compassionate',
    'report.dayMaster.bing':'Bing Fire: Passionate, confident',
    'report.dayMaster.ding':'Ding Fire: Honest, loyal',
    'report.dayMaster.wu':'Wu Earth: Active, dedicated',
    'report.dayMaster.ji':'Ji Earth: Careful, skillful',
    'report.dayMaster.geng':'Geng Metal: Determined, brave',
    'report.dayMaster.xin':'Xin Metal: Calm, sincere',
    'report.dayMaster.ren':'Ren Water: Broad-minded, free-spirited',
    'report.dayMaster.gui':'Gui Water: Persistent, hardworking',
    'report.marriage.stable':'Stable marriage, good for long-term',
    'report.marriage.experienced':'May have more relationship experience',
    'report.marriage.default':'Marriage requires mutual effort',
    'report.career.leadership':'Suitable for management or entrepreneurship',
    'report.career.business':'Good for business and finance',
    'report.career.creative':'Suitable for creative and technical work',
    'report.career.steady':'Steady development in professional field',
    'report.health.tips.jia':'Check liver function, protect eyesight',
    'report.health.tips.yi':'Manage emotions, avoid eye strain',
    'report.health.tips.bing':'Control emotions, avoid late nights',
    'report.health.tips.ding':'Ensure enough sleep, avoid stress',
    'report.health.tips.wu':'Regular diet, avoid overeating',
    'report.health.tips.ji':'Food hygiene, avoid damp environments',
    'report.health.tips.geng':'Keep warm, avoid dry environments',
    'report.health.tips.xin':'Good ventilation, avoid smoke',
    'report.health.tips.ren':'Stay hydrated, keep kidneys healthy',
    'report.health.tips.gui':'Drink moderately, avoid overwork'
  },

  'ja': {
    brand:{subtitle:'5xLiving · 八字診断'}, nav:{langLabel:'言語'},
    lang:{'zh-CN':'簡体字','zh-TW':'繁体字','en':'英語','ja':'日本語','th':'タイ語','ms':'マレー語'},
    app:{title:'八字命理 · チャート作成'},
    form:{nameLabel:'名前（任意）',namePlaceholder:'あなたの名前',genderLabel:'性別',gender:{hidden:'非公開',male:'男性',female:'女性'},calendarLabel:'暦',calendar:{gregorian:'太陽暦',lunar:'太陰暦'},birthdateLabel:'生年月日',birthtimeLabel:'出生時間',timeUnknown:'時間不明'},
    btn:{generate:'八字作成',loading:'計算中...'},
    result:{title:'あなたの八字命盤'},
    pillar:{year:'年柱',month:'月柱',day:'日柱',hour:'時柱'},
    table:{row:{stem:'天干',branch:'地支',fiveElem:'五行',nayin:'納音'}},
    energy:{title:'五行エネルギー分析'},
    elem:{wood:'木',fire:'火',earth:'土',metal:'金',water:'水'},
    pro:{title:'🧙‍♂️ 専門命理分析',welcome:'専門の命理コンサルタントです。ご質問があればお気軽にどうぞ。'},
    chat:{send:'送信',placeholder:'質問を入力...',toggle:'質問'},
    vip:{title:'🌙 VIP会員エリア',group:{astrology:'🗝 命理スペース',spiritual:'🌙 スピリチュアルスペース'},
      astrology:{match:'恋愛・結婚運',career:'キャリア・起業',wealth:'金運分析',pet:'ペット相性'},
      spiritual:{record:'スピリチュアル記録',courses:'命理コース',family:'家族記念システム',practice:'週間エネルギー練習'},
      login:{title:'💎 VIPログイン'}, services:{header:'VIPサービス'},
      upgrade:'💎 VIPアップグレード', back:'← ショップに戻る', priceNote:'$9.9/月 VIP（命理+スピリチュアル+コース）'
    },
    auth:{header:'ログイン/登録',login:'ログイン',reset:'🔑 パスワード再設定',register:'登録',freeTrialNote:'登録で無料体験',emailPlaceholder:'メール',passwordPlaceholder:'パスワード（8文字以上）'},
    footer:{copy:'© 5XLiving • Astro Sanctuary'},
    err:{fillBirthdate:'生年月日を入力',invalidDate:'日付形式が無効',generateFail:'生成失敗、再試行してください'},
    ui:{unknown:'不明',timeUnknown:'時間不明',hourSuffix:'{hh}:{mm}',birthSummary:'生年月日: {y}年{m}月{d}日 {timeText}',balance:'{strongest}が最も強く、{weakest}が最も弱い。'},
    badge:{noHour:'時柱なし'},
    chatDyn:{autoReply:'受信: {q}。詳細は専門レポートをご確認ください。'},
    elemNames:{木:'木',火:'火',土:'土',金:'金',水:'水'},
    report:{hourUnknownTip:'⚠️ 注意: 出生時間不明のため分析が限られています。',tipTitle:'注意',generating:'専門レポート作成中...',failed:'レポート生成失敗'},
    reportTitles:{overview:'📊 命盤概要',fiveElements:'🌿 五行分析',tenGods:'⚡ 十神',useful:'🔑 喜用神',relationship:'💕 恋愛結婚',career:'💼 キャリア',wealth:'💰 金運',health:'🌡️ 健康',nearTerm:'🔮 近期運勢',actions:'📝 アクションプラン'},
    reportLabels:{
      dayMaster:'日主',strength:'強弱',usefulSpirit:'喜用神',
      elementCount:'五行数',elementStrength:'五行強弱',supportElements:'支援五行',restrainElements:'抑制五行',missingElements:'不足五行',
      traits:'恋愛特性',marriageAdvice:'結婚アドバイス',relationshipTips:'関係のコツ',
      suitableCareers:'適職',careerAdvice:'キャリアアドバイス',favorableDirections:'有利な方位',
      wealthCharacteristics:'金運特性',wealthDirections:'財方位',financialAdvice:'財務アドバイス',
      healthCharacteristics:'体質',healthTips:'健康注意',wellnessAdvice:'養生アドバイス',
      overallFortune:'全体運',favorableTiming:'良い時期',cautions:'注意点'
    },
    'report.dayMaster.jia':'甲木：積極的な開拓精神、精力旺盛',
    'report.dayMaster.yi':'乙木：柔和、慈悲深い',
    'report.dayMaster.bing':'丙火 : 情熱的、自信家',
    'report.dayMaster.ding':'丁火 : 誠実、忠実',
    'report.dayMaster.wu':'戊土 : 活動的、献身的',
    'report.dayMaster.ji':'己土 : 慎重、器用',
    'report.dayMaster.geng':'庚金 : 決断力、勇敢',
    'report.dayMaster.xin':'辛金 : 冷静、誠実',
    'report.dayMaster.ren':'壬水 : 寛大、自由奔放',
    'report.dayMaster.gui':'癸水 : 粘り強く、努力家',
    'report.marriage.stable':'安定した結婚運',
    'report.marriage.experienced':'恋愛経験が多い可能性',
    'report.marriage.default':'結婚は相互努力が必要',
    'report.career.leadership':'管理職や起業向き',
    'report.career.business':'ビジネスや金融向き',
    'report.career.creative':'クリエイティブや技術職向き',
    'report.career.steady':'専門分野での着実な発展',
    'report.health.tips.jia':'肝機能検査、視力保護',
    'report.health.tips.yi':'感情管理、目の疲労回避',
    'report.health.tips.bing':'感情コントロール、夜更かし回避',
    'report.health.tips.ding':'十分な睡眠、ストレス回避',
    'report.health.tips.wu':'規則正しい食事、過食回避',
    'report.health.tips.ji':'食品衛生、湿気回避',
    'report.health.tips.geng':'保温、乾燥回避',
    'report.health.tips.xin':'換気、煙回避',
    'report.health.tips.ren':'水分補給、腎臓ケア',
    'report.health.tips.gui':'適度な水分、過労回避'
  },

  'th': {
    brand:{subtitle:'5xLiving · วิเคราะห์ปาจื้อ'}, nav:{langLabel:'ภาษา'},
    lang:{'zh-CN':'จีนตัวย่อ','zh-TW':'จีนตัวเต็ม','en':'อังกฤษ','ja':'ญี่ปุ่น','th':'ไทย','ms':'มลายู'},
    app:{title:'ปาจื้อ · สร้างดวงชะตา'},
    form:{nameLabel:'ชื่อ (ไม่บังคับ)',namePlaceholder:'ชื่อของคุณ',genderLabel:'เพศ',gender:{hidden:'ไม่ระบุ',male:'ชาย',female:'หญิง'},calendarLabel:'ปฏิทิน',calendar:{gregorian:'สุริยคติ',lunar:'จันทรคติ'},birthdateLabel:'วันเกิด',birthtimeLabel:'เวลาเกิด',timeUnknown:'เวลาเกิดไม่ทราบ'},
    btn:{generate:'สร้างปาจื้อ',loading:'กำลังคำนวณ...'},
    result:{title:'ดวงชะตาปาจื้อของคุณ'},
    pillar:{year:'ปี',month:'เดือน',day:'วัน',hour:'เวลา'},
    table:{row:{stem:'ธาตุฟ้า',branch:'ธาตุดิน',fiveElem:'ห้าธาตุ',nayin:'น่าอิ่น'}},
    energy:{title:'วิเคราะห์พลังห้าธาตุ'},
    elem:{wood:'ไม้',fire:'ไฟ',earth:'ดิน',metal:'ทอง',water:'น้ำ'},
    pro:{title:'🧙‍♂️ วิเคราะห์ดวงชะตาแบบมืออาชีพ',welcome:'สวัสดี! ผมเป็นที่ปรึกษาดวงชะตา มีคำถามอะไรถามได้เลย'},
    chat:{send:'ส่ง',placeholder:'พิมพ์คำถาม...',toggle:'ถาม'},
    vip:{title:'🌙 พื้นที่สมาชิก VIP',group:{astrology:'🗝 พื้นที่ดวงชะตา',spiritual:'🌙 พื้นที่จิตวิญญาณ'},
      astrology:{match:'ความรักและการแต่งงาน',career:'อาชีพและการธุรกิจ',wealth:'โชคลาภและการเงิน',pet:'ดวงชะตาสัตว์เลี้ยง'},
      spiritual:{record:'บันทึกจิตวิญญาณ',courses:'คอร์สดวงชะตา',family:'ระบบความทรงจำครอบครัว',practice:'ฝึกพลังงานรายสัปดาห์'},
      login:{title:'💎 เข้าสู่ระบบ VIP'}, services:{header:'บริการ VIP'},
      upgrade:'💎 อัพเกรดเป็น VIP', back:'← กลับไปร้านค้า', priceNote:'$9.9/เดือน VIP (ดวงชะตา+จิตวิญญาณ+คอร์ส)'
    },
    auth:{header:'เข้าสู่ระบบ/สมัครสมาชิก',login:'เข้าสู่ระบบ',reset:'🔑 รีเซ็ตรหัสผ่าน',register:'สมัครสมาชิก',freeTrialNote:'ทดลองใช้ฟรีเมื่อสมัคร',emailPlaceholder:'อีเมล',passwordPlaceholder:'รหัสผ่าน (8 ตัวขึ้นไป)'},
    footer:{copy:'© 5XLiving • Astro Sanctuary'},
    err:{fillBirthdate:'กรุณากรอกวันเกิด',invalidDate:'รูปแบบวันที่ไม่ถูกต้อง',generateFail:'สร้างไม่สำเร็จ กรุณาลองใหม่'},
    ui:{unknown:'ไม่ทราบ',timeUnknown:'เวลาไม่ทราบ',hourSuffix:'{hh}:{mm}',birthSummary:'วันเกิด: {d}/{m}/{y} {timeText}',balance:'{strongest} แข็งแรงที่สุด {weakest} อ่อนแอที่สุด'},
    badge:{noHour:'ไม่มีข้อมูลเวลา'},
    chatDyn:{autoReply:'ได้รับ: {q} ดูรายละเอียดในรายงานมืออาชีพ'},
    elemNames:{木:'ไม้',火:'ไฟ',土:'ดิน',金:'ทอง',น้ำ:'น้ำ'},
    report:{hourUnknownTip:'⚠️ หมายเหตุ: วิเคราะห์จำกัดเนื่องจากเวลาเกิดไม่ทราบ',tipTitle:'หมายเหตุ',generating:'กำลังสร้างรายงานมืออาชีพ...',failed:'สร้างรายงานไม่สำเร็จ'},
    reportTitles:{overview:'📊 ภาพรวมดวง',fiveElements:'🌿 วิเคราะห์ธาตุ',tenGods:'⚡ สิบเทพอสูร',useful:'🔑 ธาตุเสริม',relationship:'💕 ความสัมพันธ์',career:'💼 อาชีพ',wealth:'💰 การเงิน',health:'🌡️ สุขภาพ',nearTerm:'🔮 ดวงระยะใกล้',actions:'📝 แผนการ'},
    reportLabels:{
      dayMaster:'ธาตุวัน',strength:'ความแข็งแรง',usefulSpirit:'ธาตุเสริม',
      elementCount:'จำนวนธาตุ',elementStrength:'ความแข็งแรงธาตุ',supportElements:'ธาตุสนับสนุน',restrainElements:'ธาตุกดดัน',missingElements:'ธาตุขาด',
      traits:'ลักษณะความรัก',marriageAdvice:'คำแนะนำการแต่งงาน',relationshipTips:'เคล็ดลับความสัมพันธ์',
      suitableCareers:'อาชีพเหมาะ',careerAdvice:'คำแนะนำอาชีพ',favorableDirections:'ทิศทางดี',
      wealthCharacteristics:'ลักษณะการเงิน',wealthDirections:'ทิศทางโชคลาภ',financialAdvice:'คำแนะนำการเงิน',
      healthCharacteristics:'ลักษณะสุขภาพ',healthTips:'ข้อควรระวังสุขภาพ',wellnessAdvice:'คำแนะนำสุขภาพ',
      overallFortune:'ดวงรวม',favorableTiming:'ช่วงเวลาเหมาะ',cautions:'ข้อควรระวัง'
    },
    'report.dayMaster.jia':'เจี่ย: มีจิตวิญญาณผู้บุกเบิก',
    'report.dayMaster.yi':'อี้: อ่อนโยน ใจบุญ',
    'report.dayMaster.bing':'ปิ้ง: กระตือรือร้น มั่นใจ',
    'report.dayMaster.ding':'ติง: ซื่อสัตย์',
    'report.dayMaster.wu':'อู่: กระตือรือร้น',
    'report.dayMaster.ji':'จี: ระมัดระวัง',
    'report.dayMaster.geng':'เกิง: มุ่งมั่น กล้าหาญ',
    'report.dayMaster.xin':'ซิน: ใจเย็น',
    'report.dayMaster.ren':'เหริน: ใจกว้าง',
    'report.dayMaster.gui':'กุ้ย: อดทน',
    'report.marriage.stable':'การแต่งงานมั่นคง',
    'report.marriage.experienced':'อาจมีประสบการณ์ความรักมาก',
    'report.marriage.default':'การแต่งงานต้องการความพยายาม',
    'report.career.leadership':'เหมาะกับการจัดการหรือธุรกิจ',
    'report.career.business':'เหมาะกับธุรกิจและการเงิน',
    'report.career.creative':'เหมาะกับงานสร้างสรรค์',
    'report.career.steady':'พัฒนาอย่างมั่นคง',
    'report.health.tips.jia':'ตรวจตับ ปกป้องสายตา',
    'report.health.tips.yi':'จัดการอารมณ์',
    'report.health.tips.bing':'ควบคุมอารมณ์',
    'report.health.tips.ding':'นอนหลับพอ',
    'report.health.tips.wu':'กินอาหารเป็นเวลา',
    'report.health.tips.ji':'สุขอนามัยอาหาร',
    'report.health.tips.geng':'รักษาความอบอุ่น',
    'report.health.tips.xin':'ระบายอากาศ',
    'report.health.tips.ren':'ดื่มน้ำพอ',
    'report.health.tips.gui':'ดื่มน้ำพอ อย่าทำงานหนัก'
  },

  'ms': {
    brand:{subtitle:'5xLiving · Analisis Bazi'}, nav:{langLabel:'Bahasa'},
    lang:{'zh-CN':'Cina Ringkas','zh-TW':'Cina Tradisional','en':'Inggeris','ja':'Jepun','th':'Thai','ms':'Melayu'},
    app:{title:'Bazi Destiny · Carta Pantas'},
    form:{nameLabel:'Nama (Pilihan)',namePlaceholder:'Nama anda',genderLabel:'Jantina',gender:{hidden:'Tidak dinyatakan',male:'Lelaki',female:'Perempuan'},calendarLabel:'Kalendar',calendar:{gregorian:'Suria',lunar:'Qamari'},birthdateLabel:'Tarikh Lahir',birthtimeLabel:'Masa Lahir',timeUnknown:'Masa tidak diketahui'},
    btn:{generate:'Hasilkan Bazi',loading:'Mengira...'},
    result:{title:'Carta Bazi Anda'},
    pillar:{year:'Tahun',month:'Bulan',day:'Hari',hour:'Jam'},
    table:{row:{stem:'Batang Langit',branch:'Batang Bumi',fiveElem:'Lima Unsur',nayin:'Nayin'}},
    energy:{title:'Analisis Lima Unsur'},
    elem:{wood:'Kayu',fire:'Api',earth:'Tanah',metal:'Logam',water:'Air'},
    pro:{title:'🧙‍♂️ Analisis Profesional',welcome:'Hello! Saya perunding nasib profesional. Sila tanya soalan.'},
    chat:{send:'Hantar',placeholder:'Masukkan soalan...',toggle:'Tanya'},
    vip:{title:'🌙 Kawasan VIP',group:{astrology:'🗝 Ruang Nasib',spiritual:'🌙 Ruang Spiritual'},
      astrology:{match:'Arah Cinta & Perkahwinan',career:'Arah Kerjaya & Perniagaan',wealth:'Arah Kewangan',pet:'Nasib Haiwan Peliharaan'},
      spiritual:{record:'Rekod Spiritual',courses:'Kursus Nasib',family:'Sistem Memorial Keluarga',practice:'Latihan Tenaga Mingguan'},
      login:{title:'💎 Log Masuk VIP'}, services:{header:'Perkhidmatan VIP'},
      upgrade:'💎 Naik Taraf ke VIP', back:'← Kembali ke Kedai', priceNote:'$9.9/bulan VIP (Nasib+Spiritual+Kursus)'
    },
    auth:{header:'Log Masuk/Daftar',login:'Log Masuk',reset:'🔑 Reset Kata Laluan',register:'Daftar',freeTrialNote:'Percubaan percuma dengan pendaftaran',emailPlaceholder:'Email',passwordPlaceholder:'Kata Laluan (min 8 aksara)'},
    footer:{copy:'© 5XLiving • Astro Sanctuary'},
    err:{fillBirthdate:'Sila isi tarikh lahir',invalidDate:'Format tarikh tidak sah',generateFail:'Gagal menjana, cuba lagi'},
    ui:{unknown:'Tidak diketahui',timeUnknown:'Masa tidak diketahui',hourSuffix:'{hh}:{mm}',birthSummary:'Tarikh Lahir: {d}/{m}/{y} {timeText}',balance:'{strongest} paling kuat, {weakest} paling lemah.'},
    badge:{noHour:'Tiada jam'},
    chatDyn:{autoReply:'Diterima: {q}. Lihat laporan profesional untuk butiran.'},
    elemNames:{木:'Kayu',火:'Api',土:'Tanah',金:'Logam',水:'Air'},
    report:{hourUnknownTip:'⚠️ Nota: Analisis terhad kerana masa lahir tidak diketahui.',tipTitle:'Nota',generating:'Menjana laporan profesional...',failed:'Gagal menjana laporan'},
    reportTitles:{overview:'📊 Gambaran Carta',fiveElements:'🌿 Analisis Unsur',tenGods:'⚡ Sepuluh Dewa',useful:'🔑 Unsur Berguna',relationship:'💕 Hubungan',career:'💼 Kerjaya',wealth:'💰 Kewangan',health:'🌡️ Kesihatan',nearTerm:'🔮 Nasib Terkini',actions:'📝 Pelan Tindakan'},
    reportLabels:{
      dayMaster:'Tuan Hari',strength:'Kekuatan',usefulSpirit:'Unsur Berguna',
      elementCount:'Kiraan Unsur',elementStrength:'Kekuatan Unsur',supportElements:'Menyokong',restrainElements:'Menahan',missingElements:'Unsur Hilang',
      traits:'Ciri Hubungan',marriageAdvice:'Nasihat Perkahwinan',relationshipTips:'Tips Hubungan',
      suitableCareers:'Kerjaya Sesuai',careerAdvice:'Nasihat Kerjaya',favorableDirections:'Arah Menguntungkan',
      wealthCharacteristics:'Ciri Kewangan',wealthDirections:'Arah Kekayaan',financialAdvice:'Nasihat Kewangan',
      healthCharacteristics:'Ciri Kesihatan',healthTips:'Tips Kesihatan',wellnessAdvice:'Nasihat Kesihatan',
      overallFortune:'Nasib Keseluruhan',favorableTiming:'Masa Baik',cautions:'Langkah Berjaga-jaga'
    },
    'report.dayMaster.jia':'Jia Kayu: Semangat perintis',
    'report.dayMaster.yi':'Yi Kayu: Lembut',
    'report.dayMaster.bing':'Bing Api: Bersemangat',
    'report.dayMaster.ding':'Ding Api: Jujur',
    'report.dayMaster.wu':'Wu Tanah: Aktif',
    'report.dayMaster.ji':'Ji Tanah: Berhati-hati',
    'report.dayMaster.geng':'Geng Logam: Bertekad',
    'report.dayMaster.xin':'Xin Logam: Tenang',
    'report.dayMaster.ren':'Ren Air: Berpikiran luas',
    'report.dayMaster.gui':'Gui Air: Tekun',
    'report.marriage.stable':'Perkahwinan stabil',
    'report.marriage.experienced':'Mungkin banyak pengalaman cinta',
    'report.marriage.default':'Perkahwinan perlukan usaha',
    'report.career.leadership':'Sesuai pengurusan atau perniagaan',
    'report.career.business':'Baik untuk perniagaan dan kewangan',
    'report.career.creative':'Sesuai kerja kreatif',
    'report.career.steady':'Pembangunan stabil',
    'report.health.tips.jia':'Periksa hati, lindung penglihatan',
    'report.health.tips.yi':'Urus emosi',
    'report.health.tips.bing':'Kawal emosi',
    'report.health.tips.ding':'Tidur cukup',
    'report.health.tips.wu':'Makan teratur',
    'report.health.tips.ji':'Kebersihan makanan',
    'report.health.tips.geng':'Jaga kehangatan',
    'report.health.tips.xin':'Pengudaraan baik',
    'report.health.tips.ren':'Hidrat cukup',
    'report.health.tips.gui':'Minum sederhana'
  }
};

  /* ===== Helpers ===== */
  const $ = id => document.getElementById(id);
  const state = { lang: localStorage.getItem('5x_lang') || 'zh-CN' };

  function get(obj, path){ return path.split('.').reduce((o,k)=>(o&&o[k]!=null)?o[k]:undefined,obj); }
  function t(key){ const d=I18N[state.lang]||I18N['zh-CN']; const v=get(d,key); return (typeof v==='string')?v:key; }

  function applyI18n(){
    const dict = I18N[state.lang] || I18N['zh-CN'];
    document.documentElement.lang = state.lang;

    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key=el.getAttribute('data-i18n'); const val=get(dict,key);
      if(typeof val==='string' && val) el.textContent=val;
    });
    document.querySelectorAll('option[data-i18n]').forEach(opt=>{
      const key=opt.getAttribute('data-i18n'); const val=get(dict,key);
      if(typeof val==='string' && val) opt.textContent=val;
    });

    const ph = {
      name:get(dict,'form.namePlaceholder'),
      email:get(dict,'auth.emailPlaceholder'),
      password:get(dict,'auth.passwordPlaceholder'),
      chat:get(dict,'chat.placeholder')
    };
    if($('name')&&ph.name) $('name').placeholder=ph.name;
    if($('email')&&ph.email) $('email').placeholder=ph.email;
    if($('password')&&ph.password) $('password').placeholder=ph.password;
    if($('chatInput')&&ph.chat) $('chatInput').placeholder=ph.chat;

    if($('langSelect')) $('langSelect').value=state.lang;
  }

  function showErr(msg){
    const box=$('error'); if(!box) return;
    box.textContent = msg || t('err.generateFail');
    box.style.display='block'; setTimeout(()=>box.style.display='none',4000);
  }
  function setGenLoading(v){
    const btn=$('genBtn'), txt=$('genBtnText'), ld=$('genBtnLoading');
    if(btn) btn.disabled=!!v;
    if(txt) txt.style.display = v?'none':'inline';
    if(ld) ld.style.display = v?'inline':'none';
  }

  /* ===== Time (SG) ===== */
  function tickNow(){
    const box = $('nowBox'); if(!box) return;
    const dt = new Date();
    try{
      box.textContent = dt.toLocaleString(undefined,{ timeZone:SG_TZ, hour12:false });
    }catch{ box.textContent = dt.toISOString().replace('T',' ').slice(0,19); }
  }

  /* ===== Calculator ===== */
  class BaziCalculator {
    constructor(){
      this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
      this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
      this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
    }
    yearPillar(year){
      const s=(year-4)%10, b=(year-4)%12;
      return {stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]};
    }
    solarMonthIndex(y,m,d){
      const mmdd=m*100+d;
      const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
      let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
      const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
      return {index:idx, branch:branchBy[idx]};
    }
    monthPillar(year,month,day){
      const {index,branch}=this.solarMonthIndex(year,month,day);
      const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
      const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIdx=(startMap[yStemIdx]+(index-1))%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch};
    }
    dayPillar(year,month,day){
      const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
      const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
      const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
      return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
    }
    hourPillar(dayStem,hour){
      const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
      const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex=Math.floor((hour+1)/2)%12;
      const stemIdx=(startMap[dayIdx]+hourIndex)%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
    }
    stemElem(s){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[s]||'-'; }
    branchElem(b){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[b]||'-'; }
    nayin(s,b){
      const si=this.HEAVENLY_STEMS.indexOf(s), bi=this.EARTHLY_BRANCHES.indexOf(b);
      return this.NAYIN[(si*2+bi)%this.NAYIN.length];
    }
    tenGods(dayStem, stems){
      const map={
        '甲':{'甲':'比肩','乙':'劫财','丙':'食神','丁':'伤官','戊':'偏财','己':'正财','庚':'七杀','辛':'正官','壬':'偏印','癸':'正印'},
        '乙':{'甲':'劫财','乙':'比肩','丙':'伤官','丁':'食神','戊':'正财','己':'偏财','庚':'正官','辛':'七杀','壬':'正印','癸':'偏印'},
        '丙':{'甲':'偏印','乙':'正印','丙':'比肩','丁':'劫财','戊':'食神','己':'伤官','庚':'偏财','辛':'正财','壬':'七杀','癸':'正官'},
        '丁':{'甲':'正印','乙':'偏印','丙':'劫财','丁':'比肩','戊':'伤官','己':'食神','庚':'正财','辛':'偏财','壬':'正官','癸':'七杀'},
        '戊':{'甲':'七杀','乙':'正官','丙':'偏印','丁':'正印','戊':'比肩','己':'劫财','庚':'食神','辛':'伤官','壬':'偏财','癸':'正财'},
        '己':{'甲':'正官','乙':'七杀','丙':'正印','丁':'偏印','戊':'劫财','己':'比肩','庚':'伤官','辛':'食神','壬':'正财','癸':'偏财'},
        '庚':{'甲':'偏财','乙':'正财','丙':'七杀','丁':'正官','戊':'偏印','己':'正印','庚':'比肩','辛':'劫财','壬':'食神','癸':'伤官'},
        '辛':{'甲':'正财','乙':'偏财','丙':'正官','丁':'七杀','戊':'正印','己':'偏印','庚':'劫财','辛':'比肩','壬':'伤官','癸':'食神'},
        '壬':{'甲':'食神','乙':'伤官','丙':'偏财','丁':'正财','戊':'七杀','己':'正官','庚':'偏印','辛':'正印','壬':'比肩','癸':'劫财'},
        '癸':{'甲':'伤官','乙':'食神','丙':'正财','丁':'偏财','戊':'正官','己':'七杀','庚':'正印','辛':'偏印','壬':'劫财','癸':'比肩'}
      };
      const m=map[dayStem]||{}; return stems.map(s=>m[s]||'-');
    }
    
/* ===== Stem to Pinyin Mapping ===== */
function stemToPinyin(stem) {
  const map = {
    '甲': 'jia', '乙': 'yi', '丙': 'bing', '丁': 'ding',
    '戊': 'wu', '己': 'ji', '庚': 'geng', '辛': 'xin',
    '壬': 'ren', '癸': 'gui'
  };
  return map[stem] || stem.toLowerCase();
}
  
  /* ===== Analysis helpers ===== */
  const BaziAnalysis = {
    dayMasterLine(stem){ return t('report.dayMaster.'+stem.toLowerCase()) || t('report.dayMaster.default'); },
    relation(dayStem){
      const dict={
        '甲':{traits:'感情较为主动，喜欢掌握主导权，但要注意给对方空间',tips:'学会倾听对方意见，保持沟通平衡'},
        '乙':{traits:'感情细腻温柔，需要稳定的情感支持，但不要过度依赖对方',tips:'建立自信，明确表达自己的需求'},
        '丙':{traits:'感情热情奔放，但容易冲动，要控制情绪波动',tips:'控制情绪波动，避免冲动言行'},
        '丁':{traits:'感情专一执着，但容易猜疑，要避免过度猜疑',tips:'信任伴侣，减少不必要的猜疑'},
        '戊':{traits:'感情稳重务实，重视家庭稳定，但要学会表达情感',tips:'学会浪漫表达，增加情感交流'},
        '己':{traits:'感情细腻体贴，但容易缺乏安全感，要建立自信心',tips:'培养安全感，不要过度依赖'},
        '庚':{traits:'感情果断直接，不喜欢拖泥带水，但要考虑对方感受',tips:'考虑对方感受，适当放慢节奏'},
        '辛':{traits:'感情追求完美，对伴侣要求较高，但要接受对方缺点',tips:'接受不完美，降低对伴侣的要求'},
        '壬':{traits:'感情丰富多变，需要新鲜感，但要保持感情稳定',tips:'保持感情稳定，培养共同兴趣'},
        '癸':{traits:'感情细腻敏感，容易情绪化，但要学会情绪管理',tips:'学会情绪管理，理性处理矛盾'}
      };
      return dict[dayStem]||{traits:'感情运势平稳，需要用心经营',tips:'相互尊重，真诚沟通是关键'};
    },
    marriageAdvice(ten){ if(ten.includes('正官')||ten.includes('正财')) return t('report.marriage.stable');
                          if(ten.includes('七杀')||ten.includes('偏财')) return t('report.marriage.experienced');
                          return t('report.marriage.default'); },
    career(dayStem,ten){
      const map={甲:'管理岗位、创业开拓、建筑工程',乙:'教育文化、创意设计、咨询顾问',丙:'市场营销、娱乐产业、能源行业',丁:'技术研发、医疗服务、精密制造',戊:'金融投资、房地产、资源管理',己:'人力资源、服务行业、农业相关',庚:'法律行业、机械工程、军警职业',辛:'金融分析、精密仪器、珠宝行业',壬:'贸易物流、旅游行业、创意产业',癸:'研究机构、心理咨询、艺术创作'};
      let adv=t('report.career.steady');
      if(ten.includes('正官')||ten.includes('七杀')) adv=t('report.career.leadership');
      else if(ten.includes('正财')||ten.includes('偏财')) adv=t('report.career.business');
      else if(ten.includes('食神')||ten.includes('伤官')) adv=t('report.career.creative');
      return {suitable:map[dayStem]||t('report.career.default'), advice:adv};
    },
    wealthDirs(dayStem){
      const dirs={甲:'东方、东南方',乙:'东方、南方',丙:'南方',丁:'南方、西南方',戊:'中部、本地',己:'中部、西南方',庚:'西方、西北方',辛:'西方、北方',壬:'北方',癸:'北方、东方'}; 
      return dirs[dayStem]||'-';
    },
    financeAdvice(ten){ if(ten.includes('偏财')) return '适当投资理财，控制风险，见好就收'; 
                         if(ten.includes('正财')) return '稳扎稳打，通过专业与稳定收入积累财富';
                         return '量入为出，做好规划，避免不必要开支'; },
    health(dayStem){
      const c={甲:'肝胆、视力、筋骨',乙:'肝脏功能与情绪调节',丙:'心血管与眼睛，注意情绪',丁:'心脏与循环，保证睡眠',戊:'脾胃消化，规律饮食',己:'脾胃与皮肤，注意卫生',庚:'呼吸系统与大肠，避免干燥',辛:'肺部与呼吸，保持通风',壬:'肾脏泌尿，水分平衡',癸:'肾与膀胱，避免过劳'};
      return c[dayStem]||'体质较为平衡，注意作息';
    },
    healthTips(dayStem){ return t('report.health.tips.'+dayStem.toLowerCase()) || t('report.health.tips.default'); }
  };

  /* ===== Rendering ===== */
  function renderPillars(labels){
    const titles=[t('pillar.year'),t('pillar.month'),t('pillar.day'),t('pillar.hour')];
    $('bazi-pillars').innerHTML = labels.map((lab,i)=>`
      <div class="pillar"><div class="tit">${titles[i]}</div><div class="gz">${lab||'-'}</div></div>
    `).join('');
  }
  function renderTable(data){
    const keys=['year','month','day','hour'];
    ['stem','branch','element','nayin'].forEach(row=>{
      keys.forEach((k,i)=>{
        const cell=$(k+'-'+row); if(cell) cell.textContent = (data[row]&&data[row][i])?data[row][i]:'-';
      });
    });
  }
  function renderBars(pcts){
    ['木','火','土','金','水'].forEach(e=>{
      const pct=Math.max(0,Math.min(100,Math.round(pcts[e]||0)));
      const bar=$('bar-'+e), lab=$('pct-'+e);
      if(bar) bar.style.width=pct+'%';
      if(lab) lab.textContent=pct+'%';
    });
    // balance line
    const entries=Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
    if(entries.length){
      const strongest = entries[0][0], weakest = entries[entries.length-1][0];
      const mapName = {木:t('elem.wood'),火:t('elem.fire'),土:t('elem.earth'),金:t('elem.metal'),水:t('elem.water')};
      const txt = t('ui.balance').replace('{strongest}', mapName[strongest]).replace('{weakest}', mapName[weakest]);
      const el=$('bazi-elements-balance'); if(el) el.textContent=txt;
    }
  }
  function showResult(){
    const r=$('result'), b=$('butlerProfessional');
    if(r) r.style.display='block';
    if(b) b.style.display='block';
  }

  /* ===== Main generate ===== */
  function generate(){
    const birth = ($('birthdate')?.value||'').trim();
    if(!birth) return showErr(t('err.fillBirthdate'));
    if(!/^\d{4}-\d{2}-\d{2}$/.test(birth)) return showErr(t('err.invalidDate'));
    const [Y,M,D]=birth.split('-').map(n=>parseInt(n,10));
    const unknown = $('timeUnknown')?.checked;
    const timeVal = $('birthtime')?.value || '00:00';
    const hh = parseInt((timeVal.split(':')[0]||'0'),10);

    const calc = new BaziCalculator();
    const y = calc.yearPillar(Y);
    const m = calc.monthPillar(Y,M,D);
    const d = calc.dayPillar(Y,M,D);
    const h = unknown ? {stem:'-',branch:'-'} : calc.hourPillar(d.stem, isFinite(hh)?hh:0);

    // labels
    const labels=[y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, unknown? (t('badge.noHour')||'-') : (h.stem+h.branch)];
    renderPillars(labels);

    // table data
    const stems=[y.stem,m.stem,d.stem, unknown? '-' : h.stem];
    const branch=[y.branch,m.branch,d.branch, unknown? '-' : h.branch];
    const elements=[calc.stemElem(y.stem), calc.stemElem(m.stem), calc.stemElem(d.stem), unknown? '-' : calc.stemElem(h.stem)];
    const nayin=[calc.nayin(y.stem,y.branch),calc.nayin(m.stem,m.branch),calc.nayin(d.stem,d.branch), unknown? '-' : calc.nayin(h.stem,h.branch)];
    renderTable({stem:stems,branch:branch,element:elements,nayin});

    // element counts (stems + branches)
    const allElems = [calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem)]
      .concat(unknown?[]:[calc.stemElem(h.stem)])
      .concat([calc.branchElem(y.branch),calc.branchElem(m.branch),calc.branchElem(d.branch)])
      .concat(unknown?[]:[calc.branchElem(h.branch)]);
    const counts = {木:0,火:0,土:0,金:0,水:0};
    allElems.forEach(e=>{ if(counts[e]!=null) counts[e]++; });
    const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
    const pcts = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, 100*v/total]));
    renderBars(pcts);

    // date summary
    const timeText = unknown ? (t('ui.timeUnknown')||'') : (t('ui.hourSuffix')||'{hh}:{mm}').replace('{hh}', String(hh).padStart(2,'0')).replace('{mm}', (timeVal.split(':')[1]||'00').padStart(2,'0'));
    const btxt = (t('ui.birthSummary')||'').replace('{y}',Y).replace('{m}',M).replace('{d}',D).replace('{timeText}',timeText);
    if($('bazi-date')) $('bazi-date').textContent = btxt;
    if(unknown && $('professionalReport')){
      const tip = `<div class="ai-box"><div class="ai-box-h">${t('report.tipTitle')}</div><div class="ai-box-c">${t('report.hourUnknownTip')}</div></div>`;
      $('professionalReport').insertAdjacentHTML('afterbegin',tip);
    }

    // Ten Gods relative to day stem
    const ten = calc.tenGods(d.stem, stems);

    // build professional report (10 sections)
    buildProReport({Y,M,D,unknown, stems, branch, pcts, dayStem:d.stem, tenGods:ten});
    showResult();
  }

  function buildProReport(ctx){
    const {pcts, dayStem, tenGods, stems, branch} = ctx;
    const mapName = {木:t('elem.wood'),火:t('elem.fire'),土:t('elem.earth'),金:t('elem.metal'),水:t('elem.water')};
    const sortedElems = Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
    const strongest = sortedElems[0][0], weakest = sortedElems[sortedElems.length-1][0];
    const elemLine = `${mapName[strongest]}最旺，${mapName[weakest]}偏弱。`;

    const relation = BaziAnalysis.relation(dayStem);
    const career = BaziAnalysis.career(dayStem, tenGods);
    const wealthDirs = BaziAnalysis.wealthDirs(dayStem);

    const useful = computeUseful(dayStem, pcts); // naive balance-based

    const html = `
      <div class="butler-section">
        <h4>${t('reportTitles.overview')}</h4>
        <div>${t('reportLabels.dayMaster')}：${t('report.dayMaster.'+stemToPinyin(dayStem))}</div>
        <div>${t('reportLabels.elementCount')}：木${pctTxt('木')}｜火${pctTxt('火')}｜土${pctTxt('土')}｜金${pctTxt('金')}｜水${pctTxt('水')}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.fiveElements')}</h4>
        <div>${elemLine}</div>
        <div>${t('reportLabels.elementStrength')}：${Object.entries(pcts).map(([k,v])=>mapName[k]+Math.round(v)+'%').join('，')}</div>
        <div>${t('reportLabels.missingElements')}：${Object.entries(pcts).filter(([_,v])=>v===0).map(([k])=>mapName[k]).join('、') || '—'}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.tenGods')}</h4>
        <div>（年/月/日/时）十神：${tenGods.join(' / ')}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.useful')}</h4>
        <div>${t('reportLabels.usefulSpirit')}：${useful.join('、')}</div>
        <div>${t('reportLabels.supportElements')}：${supportElems(dayStem).join('、')}</div>
        <div>${t('reportLabels.restrainElements')}：${restrainElems(dayStem).join('、')}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.relationship')}</h4>
        <div>${t('reportLabels.traits')}：${relation.traits}</div>
        <div>${t('reportLabels.marriageAdvice')}：${BaziAnalysis.marriageAdvice(tenGods)}</div>
        <div>${t('reportLabels.relationshipTips')}：${relation.tips}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.career')}</h4>
        <div>${t('reportLabels.suitableCareers')}：${career.suitable}</div>
        <div>${t('reportLabels.careerAdvice')}：${career.advice}</div>
        <div>${t('reportLabels.favorableDirections')}：${wealthDirs}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.wealth')}</h4>
        <div>${t('reportLabels.wealthCharacteristics')}：${wealthTrait(tenGods)}</div>
        <div>${t('reportLabels.wealthDirections')}：${wealthDirs}</div>
        <div>${t('reportLabels.financialAdvice')}：${BaziAnalysis.financeAdvice(tenGods)}</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.health')}</h4>
        <div>${t('reportLabels.healthCharacteristics')}：${BaziAnalysis.health(dayStem)}</div>
        <div>${t('reportLabels.healthTips')}：${t('report.health.tips.'+stemToPinyin(dayStem))}</div>
        <div>${t('reportLabels.wellnessAdvice')}：规律作息、适量运动、情绪稳定、少熬夜</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.nearTerm')}</h4>
        <div>${t('reportLabels.overallFortune')}：${nearTermOverall(strongest, weakest)}</div>
        <div>${t('reportLabels.favorableTiming')}：逢${mapName[strongest]}月（同气），或${mapName[weakest]}月（补缺）重点布局</div>
        <div>${t('reportLabels.cautions')}：避开情绪决策，控制支出</div>
      </div>

      <div class="butler-section">
        <h4>${t('reportTitles.actions')}</h4>
        <ul class="action-list">
          <li>每周至少一次${mapName[weakest]}元素的“补能”行动（环境、食物、颜色、方向）。</li>
          <li>职业：根据“${career.advice}”调整下月行动清单（学习/项目/人脉）。</li>
          <li>感情：本周进行一次高质量沟通（30分钟），聚焦彼此需求。</li>
          <li>财富：设立“风险阈值”，偏财机会严格止盈。</li>
        </ul>
      </div>
    `;

    $('professionalReport').innerHTML = html;

    function pctTxt(e){ return Math.round(pcts[e]||0)+'%'; }
    function wealthTrait(ten){ 
      if(ten.includes('正财')) return '以稳定收入为主，适合积累式理财';
      if(ten.includes('偏财')) return '偏财机会多，注意节制风险';
      return '财运平稳，重在技能与口碑带动收入';
    }
    function nearTermOverall(strong,weak){
      if(strong===weak) return '平稳调整期';
      if(strong==='木'||strong==='火') return '势头向上，利推广/表达';
      if(strong==='金') return '收敛聚焦，利制度与执行';
      if(strong==='水') return '学习调研期，先蓄后发';
      return '打基础、稳节奏为主';
    }
    function supportElems(dm){
      const map={甲:['水','木'],乙:['水','木'],丙:['木','火'],丁:['木','火'],戊:['火','土'],己:['火','土'],庚:['土','金'],辛:['土','金'],壬:['金','水'],癸:['金','水']};
      return (map[dm]||[]).map(x=>mapName[x]);
    }
    function restrainElems(dm){
      const map={甲:['金'],乙:['金'],丙:['水'],丁:['水'],戊:['木'],己:['木'],庚:['火'],辛:['火'],壬:['土'],癸:['土']};
      return (map[dm]||[]).map(x=>mapName[x]);
    }
    function computeUseful(dm,pcts){
      // 简化：取最弱的1-2个为“喜用优先补”
      const arr=Object.entries(pcts).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k])=>mapName[k]);
      return arr.length?arr:[mapName['水']];
    }
  }

  /* ===== Chat Float ===== */
  function setupChat(){
    const btn=$('chatToggle'), box=$('chatFloat'), close=$('chatClose');
    if(btn) btn.onclick=()=>{ box.style.display='flex'; };
    if(close) close.onclick=()=>{ box.style.display='none'; };
    const send=$('chatSend'), input=$('chatInput'), msgs=$('chatMessages');
    function push(role, text){
      const div=document.createElement('div'); div.className='ss-msg';
      div.textContent=(role==='user'?'你： ':'')+text; msgs.appendChild(div); msgs.scrollTop=msgs.scrollHeight;
    }
    if(send) send.onclick=()=>{
      const q=(input.value||'').trim(); if(!q) return;
      push('user', q); input.value='';
      const reply=(t('chatDyn.autoReply')||'').replace('{q}', q);
      setTimeout(()=>push('assistant', reply), 200);
    };
  }

  /* ===== VIP Auth: Hide credentials by default ===== */
  function setupAuthReveal(){
    const fields=$('authFields'); if(!fields) return;
    fields.style.display='none'; fields.dataset.revealed='0';

    function ensureReveal(e){
      if(fields.dataset.revealed!=='1'){
        e.preventDefault();
        fields.style.display='grid';
        fields.dataset.revealed='1';
        // DO NOT log email/password anywhere
      }
    }
    const loginForm=$('loginForm'), registerForm=$('registerForm'), resetBtn=$('resetBtn');
    if(loginForm) loginForm.addEventListener('submit', ensureReveal);
    if(registerForm) registerForm.addEventListener('submit', ensureReveal);
    if(resetBtn) resetBtn.addEventListener('click', ()=>{ fields.style.display='grid'; fields.dataset.revealed='1'; });
  }

  /* ===== Lang & Events ===== */
  function setupEvents(){
    const langSel=$('langSelect');
    if(langSel) langSel.onchange=()=>{
      state.lang=langSel.value; localStorage.setItem('5x_lang', state.lang); applyI18n();
    };
    const gen=$('genBtn'); if(gen) gen.onclick=()=>{ try{ setGenLoading(true); generate(); } finally{ setTimeout(()=>setGenLoading(false), 300);} };
  }

  /* ===== Set Default Date & Time ===== */
function setDefaultDateTime() {
  const now = new Date();
  
  // 设置默认日期为当前日期
  const dateInput = $('birthdate');
  if (dateInput && !dateInput.value) {
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${year}-${month}-${day}`;
  }
  
  // 设置默认时间为当前时间
  const timeInput = $('birthtime');
  if (timeInput && !timeInput.value) {
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    timeInput.value = `${hours}:${minutes}`;
  }
}

function init(){
  applyI18n(); 
  setupEvents(); 
  setupChat(); 
  setupAuthReveal();
  setDefaultDateTime(); // 设置当前日期时间为默认值
  tickNow(); 
  setInterval(tickNow, 1000);
}
  document.addEventListener('DOMContentLoaded', init);
})();
</script> 
</body>
</html>
