<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
:root {
  --bg: #0b0f14;
  --card: #11161dcc;
  --line: #1f2a36;
  --text: #e8edf3;
  --muted: #9aa3b2;
  --brand: #d4af37;
  --gold: #d4af37;
  --gold2: #f2d27a;
  --radius: 14px;
  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --accent: #3a86ff;
  --success: #4cc9a7;
  --warning: #ff9e00;
  --danger: #ff5a5f;
}

html, body {
  height: 100%;
  margin: 0;
  color: var(--text);
  background: var(--bg);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(135deg, #0b0f14 0%, #1a2433 100%);
  filter: brightness(.8);
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px 16px 80px;
}

header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #0b0f14cc;
  border-bottom: 1px solid #0f1622;
  backdrop-filter: saturate(140%) blur(12px);
}

.head-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-badge {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(145deg, #273243, #0e141c);
  display: grid;
  place-items: center;
  color: var(--brand);
  font-weight: 700;
  box-shadow: var(--shadow);
}

.title {
  font-family: "Noto Serif SC", "Noto Serif", serif;
  font-weight: 600;
  letter-spacing: .02em;
  font-size: 1.4rem;
}

.subtitle {
  color: var(--muted);
  font-size: 0.9rem;
}

.card {
  background: var(--card);
  border: 1px solid #1f2a36;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 20px;
}

.section {
  margin-top: 18px;
}

.row {
  display: grid;
  gap: 12px;
}

@media (min-width: 760px) {
  .row.cols-3 {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .row.cols-2 {
    grid-template-columns: 1fr 1fr;
  }
}

input, select, textarea {
  width: 100%;
  box-sizing: border-box;
  border-radius: 12px;
  border: 1px solid #243244;
  background: #0e1520;
  color: var(--text);
  padding: 12px 12px;
  font-size: 15px;
  transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
}

button, .btn {
  width: auto;
  display: inline-grid;
  place-items: center;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid #e6c76e;
  background: linear-gradient(180deg, #fff9e6, #e6c76e);
  color: #191919;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}

.btn:disabled {
  opacity: .6;
  cursor: not-allowed;
  transform: none;
}

.h2 {
  font-size: 1.3rem;
  margin: 0 0 1rem;
  font-weight: 700;
  color: #ffe084;
  display: flex;
  align-items: center;
  gap: 10px;
}

.h2::before {
  content: "";
  display: block;
  width: 4px;
  height: 20px;
  background: var(--brand);
  border-radius: 2px;
}

.muted {
  color: #9aa3b2;
}

footer {
  color: #6c7b8c;
  font-size: .85rem;
  text-align: center;
  padding: 30px 0;
  margin-top: 30px;
}

/* 八字结果样式 */
.pillars {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 8px;
}

.pillar {
  background: #0f1624;
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 14px 10px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.pillar::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--brand);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.pillar:hover {
  transform: translateY(-3px);
  border-color: var(--brand);
}

.pillar:hover::before {
  opacity: 1;
}

.pillar .tit {
  color: #9aa3b2;
  font-size: .85rem;
  margin-bottom: 6px;
}

.pillar .gz {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: .05em;
  color: var(--gold2);
}

.bazi-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  background: #0f1624;
  border-radius: 8px;
  overflow: hidden;
}

.bazi-table th, .bazi-table td {
  padding: 12px 15px;
  border: 1px solid #253245;
  text-align: center;
}

.bazi-table th {
  background: rgba(212, 175, 55, 0.1);
  color: var(--gold2);
  font-weight: 600;
}

.bars {
  display: grid;
  gap: 8px;
  margin-top: 10px;
}

.bar {
  height: 10px;
  background: #0d1420;
  border: 1px solid #233146;
  border-radius: 999px;
  overflow: hidden;
  position: relative;
}

.bar i {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, #ffe084, #f2d27a);
  transition: width 1s ease;
}

.bar-label {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 0.85rem;
}

.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.analysis-card {
  background: rgba(15, 22, 36, 0.7);
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 20px;
}

.analysis-card-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--gold2);
  margin-bottom: 12px;
}

/* 时间不详选项样式 */
.time-unknown-container {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.time-unknown-checkbox {
  width: 16px;
  height: 16px;
}

.time-unknown-label {
  font-size: 0.9rem;
  color: var(--muted);
}

.time-input-container {
  transition: all 0.3s ease;
}

.time-input-container.disabled {
  opacity: 0.5;
  pointer-events: none;
}

/* ChatGPT 对话窗口样式 */
.chatgpt-window {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 380px;
  height: 500px;
  background: var(--card);
  border: 1px solid #1f2a36;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: none;
  flex-direction: column;
  z-index: 1000;
}

.chatgpt-header {
  padding: 15px;
  border-bottom: 1px solid #1f2a36;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 22, 36, 0.9);
}

.chatgpt-title {
  font-weight: 600;
  color: var(--gold2);
  display: flex;
  align-items: center;
  gap: 8px;
}

.chatgpt-close {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 5px;
}

.chatgpt-body {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-message {
  max-width: 85%;
  padding: 10px 15px;
  border-radius: 15px;
  line-height: 1.4;
}

.chat-message.user {
  align-self: flex-end;
  background: var(--accent);
  color: white;
}

.chat-message.bot {
  align-self: flex-start;
  background: rgba(15, 22, 36, 0.7);
  border: 1px solid #253245;
}

.chatgpt-input {
  padding: 15px;
  border-top: 1px solid #1f2a36;
  display: flex;
  gap: 10px;
}

.chatgpt-input input {
  flex: 1;
  padding: 10px 15px;
}

.chatgpt-send {
  padding: 10px 15px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.chatgpt-fab {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #10a37f, #1a7f64);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: var(--shadow);
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 登录区域样式 */
.astro-auth {
  margin-top: 30px;
}

.auth-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.panel {
  background: rgba(15, 22, 36, 0.7);
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 20px;
}

.panel .head {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--gold2);
  margin-bottom: 15px;
  text-align: center;
}

.btn.block {
  width: 100%;
  margin-bottom: 10px;
}

.btn.ghost {
  background: transparent;
  border: 1px solid var(--muted);
  color: var(--text);
}

.btn-gold {
  background: linear-gradient(180deg, #fff9e6, #e6c76e);
  color: #191919;
  border: 1px solid #e6c76e;
}

.spacer {
  height: 15px;
}

.error {
  color: var(--danger);
  background: rgba(255, 90, 95, 0.1);
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(255, 90, 95, 0.1);
  border: 1px solid var(--danger);
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
  color: #ffb4b4;
}

/* 会员服务容器样式修复 */
.membership-section {
  max-width: 100%;
  box-sizing: border-box;
  padding: 15px;
  margin: 10px 0;
}

.vip-pricing {
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  text-align: center;
  border: 1px solid #e6c76e;
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.vip-price {
  font-size: 2rem;
  font-weight: bold;
  color: #b8860b;
  margin: 10px 0;
}

.vip-features {
  list-style: none;
  padding: 0;
  margin: 15px 0;
}

.vip-features li {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* 响应式布局修复 */
@media (max-width: 768px) {
  .membership-section {
    padding: 10px;
    margin: 5px 0;
  }
  
  .vip-pricing {
    padding: 15px;
  }
  
  .vip-price {
    font-size: 1.5rem;
  }
}  
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="subtitle">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> 闰月
          </label>
        </div>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-input-container" id="timeInputContainer">
          <input type="time" id="birthtime" value="12:00">
        </div>
        <div class="time-unknown-container">
          <input type="checkbox" id="timeUnknown" class="time-unknown-checkbox">
          <label for="timeUnknown" class="time-unknown-label">出生时间不详</label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
<!-- 确保按钮有正确的ID -->
<button class="btn" id="genBtn">
  <span id="genBtnText">生成八字</span>
  <span id="genBtnLoading" class="loading" style="display:none"></span>
</button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div id="error" class="error-message" style="display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <!-- 八字命盘 -->
    <div class="card section">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      
      <table class="bazi-table">
        <thead>
          <tr>
            <th></th>
            <th>年柱</th>
            <th>月柱</th>
            <th>日柱</th>
            <th>时柱</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>天干</td>
            <td id="year-stem">-</td>
            <td id="month-stem">-</td>
            <td id="day-stem">-</td>
            <td id="hour-stem">-</td>
          </tr>
          <tr>
            <td>地支</td>
            <td id="year-branch">-</td>
            <td id="month-branch">-</td>
            <td id="day-branch">-</td>
            <td id="hour-branch">-</td>
          </tr>
          <tr>
            <td>五行</td>
            <td id="year-element">-</td>
            <td id="month-element">-</td>
            <td id="day-element">-</td>
            <td id="hour-element">-</td>
          </tr>
          <tr>
            <td>纳音</td>
            <td id="year-nayin">-</td>
            <td id="month-nayin">-</td>
            <td id="day-nayin">-</td>
            <td id="hour-nayin">-</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 五行分析 -->
    <div class="card section">
      <div class="h2">五行能量分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"></i></div>
        <div class="bar-label"><span>木</span><span id="pct-wood">0%</span></div>
        <div class="bar"><i id="bar-fire"></i></div>
        <div class="bar-label"><span>火</span><span id="pct-fire">0%</span></div>
        <div class="bar"><i id="bar-earth"></i></div>
        <div class="bar-label"><span>土</span><span id="pct-earth">0%</span></div>
        <div class="bar"><i id="bar-metal"></i></div>
        <div class="bar-label"><span>金</span><span id="pct-metal">0%</span></div>
        <div class="bar"><i id="bar-water"></i></div>
        <div class="bar-label"><span>水</span><span id="pct-water">0%</span></div>
      </div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- 详细分析 -->
    <div class="card section">
      <div class="h2">命理详细分析</div>
      <div class="analysis-grid">
        <div class="analysis-card">
          <div class="analysis-card-title">📅 日柱命理</div>
          <div id="day-pillar-analysis">根据您的八字日柱进行深度分析...</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-card-title">🐎 年命生肖</div>
          <div id="zodiac-analysis">根据您的出生年份分析生肖特性...</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-card-title">💼 事业财运</div>
          <div id="career-analysis">分析您的事业发展方向和财运趋势...</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-card-title">🤝 人际关系</div>
          <div id="relationship-analysis">分析您的姻缘和人际关系...</div>
        </div>
      </div>
    </div>

    <!-- VIP 区域 -->
    <div class="card section">
      <div class="h2">🌙 会员区域 VIP Segment</div>
      
      <div class="row cols-2">
        <div>
          <h4 style="color:var(--gold2); margin-bottom:10px;">🗝 命理空间专属内容</h4>
          <ul style="color:var(--muted); line-height:1.8; font-size:0.9rem;">
            <li>姻缘方向：恋爱缘分、婚姻走势</li>
            <li>事业方向：职场发展、创业潜力</li>
            <li>财运方向：财位分析、理财时机</li>
            <li>宠物命理：伴侣动物的性格与缘分</li>
            <li>合盘分析：婚期择日、新生择时</li>
            <li>测名分析：公司名、宝宝名、命名改运</li>
            <li>财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        
        <div>
          <h4 style="color:var(--gold2); margin-bottom:10px;">🌙 心怜空间专属内容</h4>
          <ul style="color:var(--muted); line-height:1.8; font-size:0.9rem;">
            <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li>命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li>家族纪念系统：亲人灵性纪念 & 延续</li>
            <li>每周能量练习 / 神明仪式任务</li>
            <li>能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- 登录/注册区域 -->
  <section class="astro-auth">
    <div class="auth-grid">
      <!-- 左侧：输入 + 注册/登录 -->
      <div class="panel">
        <div class="head">账户登录 / 注册</div>
        <div class="body">
          <!-- 独立输入区（登录/注册共享这些输入） -->
          <div class="row" id="authFields">
            <input
              id="email"
              type="email"
              inputmode="email"
              autocomplete="email"
              placeholder="邮箱 Email"
              required
            />

            <input
              id="password"
              type="password"
              autocomplete="new-password"
              placeholder="密码 Password（至少8位，含大小写数字符号）"
              required
            />
          </div>

          <div class="spacer"></div>

          <!-- 登录表单（复用上方两格输入） -->
          <form id="loginForm" class="row one">
            <button class="btn block" id="loginBtn" type="submit">登入账户</button>
          </form>

          <div class="spacer"></div>

          <!-- 重设密码（按钮非提交） -->
          <div class="row one">
            <button class="btn ghost block" id="resetBtn" type="button">🔑 重设密码</button>
          </div>

          <div class="spacer"></div>

          <!-- 注册表单（复用上方两格输入） -->
          <form class="row one" id="registerForm">
            <button class="btn block" id="registerBtn" type="submit">注册账户</button>
          
          <div class="muted">
          注册账号赠送一次免费体验
          </div>  

          <div class="spacer"></div>

          <div class="error" id="authError" style="display:none"></div>
        </div>
      </div>
      </form>
      
      <!-- 右侧：会员与返回 -->
      <div class="panel">
        <div class="head">会员服务</div>
        <div class="body">
          <div class="row one">
            <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">💎 升级为 VIP（月费）</a>
          </div>

          <div class="spacer"></div>

          <div class="row one">
            <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">← 返回命理商城</a>
          </div>

          <div class="spacer"></div>
          <div class="muted">
            $9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- ChatGPT 对话窗口 -->
<button class="chatgpt-fab" id="chatgptFab">💬</button>
<div class="chatgpt-window" id="chatgptWindow">
  <div class="chatgpt-header">
    <div class="chatgpt-title">
      <span>💬 心怜管家</span>
    </div>
    <button class="chatgpt-close" id="chatgptClose">×</button>
  </div>
  <div class="chatgpt-body" id="chatgptBody">
    <div class="chat-message bot">
      您好！我是心怜管家，可以为您解答八字命理相关问题。请问有什么可以帮您的？
    </div>
  </div>
  <div class="chatgpt-input">
    <input type="text" id="chatgptInput" placeholder="输入您的问题...">
    <button class="chatgpt-send" id="chatgptSend">发送</button>
  </div>
</div>

<script>
// 八字计算器类
// 八字计算器类 - 修复版本
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    this.EARTHLY_BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    this.ZODIAC = ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'];
    this.NAYIN = ['海中金', '炉中火', '大林木', '路旁土', '剑锋金', '山头火', '涧下水', '城头土', '白蜡金', '杨柳木', '泉中水', '屋上土', '霹雳火', '松柏木', '长流水', '砂石金', '山下火', '平地木', '壁上土', '金箔金', '佛灯火', '天河水', '大驿土', '钗钏金', '桑柘木', '大溪水', '沙中土', '天上火', '石榴木', '大海水'];
  }

  // 计算年柱 - 保持原样
  calculateYearPillar(year) {
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex],
      zodiac: this.ZODIAC[branchIndex]
    };
  }

  // 修复月柱计算 - 关键修复！
  calculateMonthPillar(year, month) {
    // 月支固定对应月份
    const branchMap = { 
      1: '寅', 2: '卯', 3: '辰', 4: '巳', 5: '午', 6: '未', 
      7: '申', 8: '酉', 9: '戌', 10: '亥', 11: '子', 12: '丑' 
    };
    const branch = branchMap[month];
    
    const yearStem = this.calculateYearPillar(year).stem;
    const yearStemIndex = this.HEAVENLY_STEMS.indexOf(yearStem);
    
    // 修正的月干起始表 - 关键修复！
    const monthStartMap = {
      0: 2,  // 甲年：丙作首
      1: 4,  // 乙年：戊为头
      2: 6,  // 丙年：寻庚起
      3: 8,  // 丁年：壬位顺行流
      4: 0,  // 戊年：甲寅之上好追求 ← 这里应该是0！
      5: 2,  // 己年：丙作首
      6: 4,  // 庚年：戊为头
      7: 6,  // 辛年：寻庚起
      8: 8,  // 壬年：壬位顺行流
      9: 0   // 癸年：甲寅之上好追求
    };
    
    const startIndex = monthStartMap[yearStemIndex];
    const stemIndex = (startIndex + month - 1) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: branch
    };
  }

  // 修复日柱计算 - 使用更准确的算法
  calculateDayPillar(year, month, day) {
    // 使用已知准确的基准日：1900年1月31日为甲午日
    const baseDate = new Date(1900, 0, 31); // 1900-01-31 甲午日
    const targetDate = new Date(year, month - 1, day);
    
    // 计算天数差
    const timeDiff = targetDate.getTime() - baseDate.getTime();
    const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    
    // 甲午日的索引：甲=0, 午=6
    const baseStemIndex = 0;
    const baseBranchIndex = 6;
    
    // 计算目标日的干支索引
    let stemIndex = (baseStemIndex + dayDiff) % 10;
    let branchIndex = (baseBranchIndex + dayDiff) % 12;
    
    // 处理负数
    if (stemIndex < 0) stemIndex += 10;
    if (branchIndex < 0) branchIndex += 12;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex]
    };
  }

  // 修复时柱计算
  calculateHourPillar(dayStem, hour) {
    const branchMap = { 
      23: '子', 0: '子', 1: '丑', 2: '丑', 3: '寅', 4: '寅', 
      5: '卯', 6: '卯', 7: '辰', 8: '辰', 9: '巳', 10: '巳', 
      11: '午', 12: '午', 13: '未', 14: '未', 15: '申', 16: '申', 
      17: '酉', 18: '酉', 19: '戌', 20: '戌', 21: '亥', 22: '亥'
    };
    
    const branch = branchMap[hour];
    const dayStemIndex = this.HEAVENLY_STEMS.indexOf(dayStem);
    
    // 修正的时干计算表
    const hourStartMap = {
      0: 0,  // 甲日：甲
      1: 2,  // 乙日：丙
      2: 4,  // 丙日：戊
      3: 6,  // 丁日：庚
      4: 8,  // 戊日：壬
      5: 0,  // 己日：甲
      6: 2,  // 庚日：丙
      7: 4,  // 辛日：戊
      8: 6,  // 壬日：庚
      9: 8   // 癸日：壬
    };
    
    const startIndex = hourStartMap[dayStemIndex];
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIndex = (startIndex + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: branch
    };
  }

  // 获取五行 - 保持原样
  getElement(stem, branch) {
    const stemElements = {
      '甲': '木', '乙': '木', '丙': '火', '丁': '火',
      '戊': '土', '己': '土', '庚': '金', '辛': '金',
      '壬': '水', '癸': '水'
    };
    
    const branchElements = {
      '子': '水', '丑': '土', '寅': '木', '卯': '木',
      '辰': '土', '巳': '火', '午': '火', '未': '土',
      '申': '金', '酉': '金', '戌': '土', '亥': '水'
    };
    
    return `${stemElements[stem]}${branchElements[branch]}`;
  }

  // 获取纳音 - 保持原样
  getNayin(stem, branch) {
    const stemIndex = this.HEAVENLY_STEMS.indexOf(stem);
    const branchIndex = this.EARTHLY_BRANCHES.indexOf(branch);
    const index = (stemIndex * 2 + branchIndex) % this.NAYIN.length;
    return this.NAYIN[index];
  }

  // 分析五行平衡 - 保持原样
  analyzeElements(bazi) {
    const elements = {
      '木': 0, '火': 0, '土': 0, '金': 0, '水': 0
    };
    
    // 统计天干五行
    for (let pillar of ['year', 'month', 'day', 'hour']) {
      const stem = bazi[pillar].stem;
      if (stem !== '？') {
        const element = this.getElement(stem, '子').charAt(0);
        elements[element]++;
      }
    }
    
    // 统计地支五行
    for (let pillar of ['year', 'month', 'day', 'hour']) {
      const branch = bazi[pillar].branch;
      if (branch !== '？') {
        const element = this.getElement('甲', branch).charAt(1);
        elements[element]++;
      }
    }
    
    return elements;
  }
}

// 初始化八字计算器
const baziCalculator = new BaziCalculator();

// 生成八字按钮点击事件
document.getElementById('genBtn').addEventListener('click', function() {
  const birthdate = document.getElementById('birthdate').value;
  const birthtime = document.getElementById('birthtime').value;
  const timeUnknown = document.getElementById('timeUnknown').checked;
  
  if (!birthdate) {
    showError('请选择出生日期');
    return;
  }
  
  // 显示加载状态
  document.getElementById('genBtnText').style.display = 'none';
  document.getElementById('genBtnLoading').style.display = 'inline-block';
  
  setTimeout(() => {
    try {
      // 解析日期和时间
      const date = new Date(birthdate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      let hour = 12;
      if (!timeUnknown && birthtime) {
        const timeParts = birthtime.split(':');
        hour = parseInt(timeParts[0]);
      }
      
      // 计算八字
      const yearPillar = baziCalculator.calculateYearPillar(year);
      const monthPillar = baziCalculator.calculateMonthPillar(year, month);
      const dayPillar = baziCalculator.calculateDayPillar(year, month, day);
      const hourPillar = timeUnknown ? 
        { stem: '？', branch: '？' } : 
        baziCalculator.calculateHourPillar(dayPillar.stem, hour);
      
      const bazi = {
        year: yearPillar,
        month: monthPillar,
        day: dayPillar,
        hour: hourPillar
      };
      
      // 显示结果
      displayBaziResult(bazi, year, month, day, hour, timeUnknown);
      
      // 隐藏加载状态
      document.getElementById('genBtnText').style.display = 'inline';
      document.getElementById('genBtnLoading').style.display = 'none';
      
    } catch (error) {
      console.error('计算八字时出错:', error);
      showError('计算八字时出现错误，请重试');
      document.getElementById('genBtnText').style.display = 'inline';
      document.getElementById('genBtnLoading').style.display = 'none';
    }
  }, 1000);
});

// 显示八字结果
function displayBaziResult(bazi, year, month, day, hour, timeUnknown) {
  // 显示结果区域
  document.getElementById('result').style.display = 'block';
  
  // 显示八字四柱
  const pillars = [
    { title: '年柱', stem: bazi.year.stem, branch: bazi.year.branch },
    { title: '月柱', stem: bazi.month.stem, branch: bazi.month.branch },
    { title: '日柱', stem: bazi.day.stem, branch: bazi.day.branch },
    { title: '时柱', stem: bazi.hour.stem, branch: bazi.hour.branch }
  ];
  
  const pillarsContainer = document.getElementById('bazi-pillars');
  pillarsContainer.innerHTML = '';
  
  pillars.forEach(pillar => {
    const pillarElement = document.createElement('div');
    pillarElement.className = 'pillar';
    pillarElement.innerHTML = `
      <div class="tit">${pillar.title}</div>
      <div class="gz">${pillar.stem}${pillar.branch}</div>
    `;
    pillarsContainer.appendChild(pillarElement);
  });
  
  // 显示详细表格
  document.getElementById('year-stem').textContent = bazi.year.stem;
  document.getElementById('year-branch').textContent = bazi.year.branch;
  document.getElementById('month-stem').textContent = bazi.month.stem;
  document.getElementById('month-branch').textContent = bazi.month.branch;
  document.getElementById('day-stem').textContent = bazi.day.stem;
  document.getElementById('day-branch').textContent = bazi.day.branch;
  document.getElementById('hour-stem').textContent = bazi.hour.stem;
  document.getElementById('hour-branch').textContent = bazi.hour.branch;
  
  // 显示五行和纳音
  document.getElementById('year-element').textContent = baziCalculator.getElement(bazi.year.stem, bazi.year.branch);
  document.getElementById('month-element').textContent = baziCalculator.getElement(bazi.month.stem, bazi.month.branch);
  document.getElementById('day-element').textContent = baziCalculator.getElement(bazi.day.stem, bazi.day.branch);
  document.getElementById('hour-element').textContent = timeUnknown ? '未知' : baziCalculator.getElement(bazi.hour.stem, bazi.hour.branch);
  
  document.getElementById('year-nayin').textContent = baziCalculator.getNayin(bazi.year.stem, bazi.year.branch);
  document.getElementById('month-nayin').textContent = baziCalculator.getNayin(bazi.month.stem, bazi.month.branch);
  document.getElementById('day-nayin').textContent = baziCalculator.getNayin(bazi.day.stem, bazi.day.branch);
  document.getElementById('hour-nayin').textContent = timeUnknown ? '未知' : baziCalculator.getNayin(bazi.hour.stem, bazi.hour.branch);
  
  // 显示日期
  document.getElementById('bazi-date').textContent = `出生日期: ${year}年${month}月${day}日 ${timeUnknown ? '时间不详' : hour + '时'}`;
  
  // 分析五行
  const elements = baziCalculator.analyzeElements(bazi);
  updateElementBars(elements);
  
  // 生成命理分析
  generateBaziAnalysis(bazi, elements, year);
  
  // 滚动到结果区域
  document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

// 更新五行柱状图
function updateElementBars(elements) {
  const total = Object.values(elements).reduce((a, b) => a + b, 0);
  
  for (const [element, count] of Object.entries(elements)) {
    const percentage = total > 0 ? (count / total) * 100 : 0;
    const barElement = document.getElementById(`bar-${element}`);
    const pctElement = document.getElementById(`pct-${element}`);
    
    if (barElement) barElement.style.width = `${percentage}%`;
    if (pctElement) pctElement.textContent = `${percentage.toFixed(1)}%`;
  }
  
  // 五行平衡分析
  const balanceElement = document.getElementById('bazi-elements-balance');
  const maxElement = Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
  const minElement = Object.keys(elements).reduce((a, b) => elements[a] < elements[b] ? a : b);
  
  balanceElement.textContent = `五行中${maxElement}元素最强，${minElement}元素最弱。`;
}

// 生成命理分析
function generateBaziAnalysis(bazi, elements, year) {
  const name = document.getElementById('name').value || '您';
  
  // 日柱分析
  const dayStemNames = {
    '甲': '甲木', '乙': '乙木', '丙': '丙火', '丁': '丁火',
    '戊': '戊土', '己': '己土', '庚': '庚金', '辛': '辛金',
    '壬': '壬水', '癸': '癸水'
  };
  
  document.getElementById('day-pillar-analysis').innerHTML = `
    <p>${name}的日主为<strong>${dayStemNames[bazi.day.stem]}</strong>，代表命主的本性和核心特质。</p>
    <p>日柱${bazi.day.stem}${bazi.day.branch}，纳音${baziCalculator.getNayin(bazi.day.stem, bazi.day.branch)}。</p>
  `;
  
  // 生肖分析
  document.getElementById('zodiac-analysis').innerHTML = `
    <p>${name}的生肖为<strong>${bazi.year.zodiac}</strong>，具有该生肖的典型特征。</p>
    <p>年柱${bazi.year.stem}${bazi.year.branch}，纳音${baziCalculator.getNayin(bazi.year.stem, bazi.year.branch)}。</p>
  `;
  
  // 事业财运分析
  document.getElementById('career-analysis').innerHTML = `
    <p>根据五行分析，${name}的命局中${getStrongestElement(elements)}元素较为突出。</p>
    <p>适合从事与${getCareerAdvice(elements)}相关的行业。</p>
    <p>财运方面，${getWealthAdvice(bazi.day.stem)}</p>
  `;
  
  // 人际关系分析
  document.getElementById('relationship-analysis').innerHTML = `
    <p>${name}在人际关系方面${getRelationshipAdvice(bazi.day.stem)}</p>
    <p>感情方面，${getLoveAdvice(bazi.day.stem, document.getElementById('gender').value)}</p>
  `;
}

// 辅助分析函数
function getStrongestElement(elements) {
  return Object.keys(elements).reduce((a, b) => elements[a] > elements[b] ? a : b);
}

function getCareerAdvice(elements) {
  const strongest = getStrongestElement(elements);
  const careers = {
    '木': '教育、文化、艺术、医疗',
    '火': '科技、能源、餐饮、娱乐',
    '土': '房地产、建筑、农业、金融',
    '金': '金属、机械、法律、管理',
    '水': '贸易、运输、旅游、服务'
  };
  return careers[strongest] || '多种行业';
}

function getWealthAdvice(dayStem) {
  const advice = {
    '甲': '财运稳定，适合长期投资',
    '乙': '财运起伏，需要谨慎理财',
    '丙': '财运旺盛，但需防破财',
    '丁': '财运平稳，适合稳健投资',
    '戊': '财运丰厚，但来得较慢',
    '己': '财运稳定，适合积累',
    '庚': '财运起伏，需要把握时机',
    '辛': '财运良好，适合精细经营',
    '壬': '财运流动，适合灵活投资',
    '癸': '财运隐秘，需要耐心等待'
  };
  return advice[dayStem] || '财运平稳，需要合理规划';
}

function getRelationshipAdvice(dayStem) {
  const advice = {
    '甲': '性格直爽，人际关系良好',
    '乙': '温和体贴，人缘不错',
    '丙': '热情开朗，交友广泛',
    '丁': '细腻敏感，需要更多信任',
    '戊': '稳重可靠，朋友忠诚',
    '己': '包容大度，人缘很好',
    '庚': '刚强果断，需要更多柔和',
    '辛': '精明细致，交友谨慎',
    '壬': '随和包容，人缘广泛',
    '癸': '内向敏感，需要主动社交'
  };
  return advice[dayStem] || '人际关系平稳，需要用心经营';
}

function getLoveAdvice(dayStem, gender) {
  const baseAdvice = {
    '甲': '感情专一，重视家庭',
    '乙': '感情细腻，需要安全感',
    '丙': '感情热烈，追求浪漫',
    '丁': '感情深沉，需要理解',
    '戊': '感情稳定，重视责任',
    '己': '感情包容，善于付出',
    '庚': '感情刚强，需要温柔',
    '辛': '感情精致，追求完美',
    '壬': '感情随和，适应性强',
    '癸': '感情敏感，需要呵护'
  };
  
  let advice = baseAdvice[dayStem] || '感情平稳，需要用心经营';
  
  if (gender === 'male') {
    advice += '，作为男性，在感情中应该主动承担责任。';
  } else if (gender === 'female') {
    advice += '，作为女性，在感情中应该保持独立自信。';
  }
  
  return advice;
}

// 错误显示函数
function showError(message) {
  const errorElement = document.getElementById('error');
  errorElement.textContent = message;
  errorElement.style.display = 'block';
  
  setTimeout(() => {
    errorElement.style.display = 'none';
  }, 5000);
}

// ChatGPT 对话窗口功能
document.getElementById('chatgptFab').addEventListener('click', function() {
  document.getElementById('chatgptWindow').style.display = 'flex';
});

document.getElementById('chatgptClose').addEventListener('click', function() {
  document.getElementById('chatgptWindow').style.display = 'none';
});

document.getElementById('chatgptSend').addEventListener('click', sendMessage);
document.getElementById('chatgptInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

function sendMessage() {
  const input = document.getElementById('chatgptInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  // 添加用户消息
  addChatMessage(message, 'user');
  input.value = '';
  
  // 模拟AI回复
  setTimeout(() => {
    const responses = [
      "根据八字分析，建议多关注事业发展和人际关系。",
      "从五行平衡来看，您需要加强水元素的能量。",
      "您的命理显示今年有较好的财运机会，可以把握。",
      "感情方面，今年有机会遇到合适的伴侣。",
      "健康方面需要注意脾胃问题，饮食要规律。",
      "建议多接触自然，平衡身心能量。",
      "事业发展方面，适合与团队合作共同进步。"
    ];
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    addChatMessage(randomResponse, 'bot');
  }, 1000);
}

function addChatMessage(message, sender) {
  const chatBody = document.getElementById('chatgptBody');
  const messageElement = document.createElement('div');
  messageElement.className = `chat-message ${sender}`;
  messageElement.textContent = message;
  chatBody.appendChild(messageElement);
  chatBody.scrollTop = chatBody.scrollHeight;
}

// 登录/注册功能
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  if (!email || !password) {
    showAuthError('请输入邮箱和密码');
    return;
  }
  
  // 模拟登录成功
  simulateLogin(email);
});

document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  
  if (!email || !password) {
    showAuthError('请输入邮箱和密码');
    return;
  }
  
  if (password.length < 8) {
    showAuthError('密码至少需要8位字符');
    return;
  }
  
  // 模拟注册成功并赠送VIP体验
  simulateRegistration(email);
});

document.getElementById('resetBtn').addEventListener('click', function() {
  const email = prompt('请输入您的邮箱地址：');
  if (email) {
    alert('密码重置链接已发送到您的邮箱，请查收。');
  }
});

function simulateLogin(email) {
  // 在实际应用中，这里应该调用后端API
  alert(`登录成功！欢迎回来，${email}`);
  // 这里可以设置登录状态，跳转页面等
}

function simulateRegistration(email) {
  // 在实际应用中，这里应该调用后端API
  alert(`注册成功！欢迎 ${email}，您已获得24小时VIP体验权限。`);
  // 这里可以设置登录状态，跳转页面等
}

function showAuthError(message) {
  const errorElement = document.getElementById('authError');
  errorElement.textContent = message;
  errorElement.style.display = 'block';
  
  setTimeout(() => {
    errorElement.style.display = 'none';
  }, 5000);
}

// ... 前面的所有代码保持不变 ...

// 时间不详复选框事件
document.getElementById('timeUnknown').addEventListener('change', function() {
  const timeInputContainer = document.getElementById('timeInputContainer');
  if (this.checked) {
    timeInputContainer.classList.add('disabled');
  } else {
    timeInputContainer.classList.remove('disabled');
  }
});

// 初始化 - 修复这个部分
document.addEventListener('DOMContentLoaded', function() {
  // 设置默认日期为今天
  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];
  document.getElementById('birthdate').value = formattedDate;
  
  // 重新绑定生成八字按钮事件
  const genBtn = document.getElementById('genBtn');
  if (genBtn) {
    // 移除可能存在的旧事件监听器
    genBtn.replaceWith(genBtn.cloneNode(true));
    
    // 重新获取按钮并绑定事件
    document.getElementById('genBtn').addEventListener('click', function() {
      console.log('生成八字按钮被点击');
      
      const birthdate = document.getElementById('birthdate').value;
      const birthtime = document.getElementById('birthtime').value;
      const timeUnknown = document.getElementById('timeUnknown').checked;
      
      if (!birthdate) {
        showError('请选择出生日期');
        return;
      }
      
      // 显示加载状态
      document.getElementById('genBtnText').style.display = 'none';
      document.getElementById('genBtnLoading').style.display = 'inline-block';
      
      setTimeout(() => {
        try {
          // 解析日期和时间
          const date = new Date(birthdate);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();
          
          let hour = 12;
          if (!timeUnknown && birthtime) {
            const timeParts = birthtime.split(':');
            hour = parseInt(timeParts[0]);
          }
          
          // 计算八字
          const yearPillar = baziCalculator.calculateYearPillar(year);
          const monthPillar = baziCalculator.calculateMonthPillar(year, month);
          const dayPillar = baziCalculator.calculateDayPillar(year, month, day);
          const hourPillar = timeUnknown ? 
            { stem: '？', branch: '？' } : 
            baziCalculator.calculateHourPillar(dayPillar.stem, hour);
          
          const bazi = {
            year: yearPillar,
            month: monthPillar,
            day: dayPillar,
            hour: hourPillar
          };
          
          // 显示结果
          displayBaziResult(bazi, year, month, day, hour, timeUnknown);
          
          // 隐藏加载状态
          document.getElementById('genBtnText').style.display = 'inline';
          document.getElementById('genBtnLoading').style.display = 'none';
          
        } catch (error) {
          console.error('计算八字时出错:', error);
          showError('计算八字时出现错误，请重试');
          document.getElementById('genBtnText').style.display = 'inline';
          document.getElementById('genBtnLoading').style.display = 'none';
        }
      }, 1000);
    });
  } else {
    console.error('找不到生成八字按钮');
  }
  
  // 运行八字计算测试
  testBaziCalculation();
});

// 验证八字计算是否正确
function testBaziCalculation() {
  const calculator = new BaziCalculator();
  
  // 测试1978年2月21日12:45
  const year = 1978, month = 2, day = 21, hour = 12;
  
  const yearPillar = calculator.calculateYearPillar(year);
  const monthPillar = calculator.calculateMonthPillar(year, month);
  const dayPillar = calculator.calculateDayPillar(year, month, day);
  const hourPillar = calculator.calculateHourPillar(dayPillar.stem, hour);
  
  console.log('修复后计算结果:');
  console.log('年柱:', yearPillar.stem + yearPillar.branch, '(应该是: 戊午)');
  console.log('月柱:', monthPillar.stem + monthPillar.branch, '(应该是: 甲寅)');
  console.log('日柱:', dayPillar.stem + dayPillar.branch, '(应该是: 甲寅)');
  console.log('时柱:', hourPillar.stem + hourPillar.branch, '(应该是: 庚午)');
  
  // 验证结果
  const isCorrect = 
    yearPillar.stem + yearPillar.branch === '戊午' &&
    monthPillar.stem + monthPillar.branch === '甲寅' &&
    dayPillar.stem + dayPillar.branch === '甲寅' &&
    hourPillar.stem + hourPillar.branch === '庚午';
  
  console.log('计算结果是否正确:', isCorrect);
  
  if (!isCorrect) {
    console.error('八字计算仍有问题，需要进一步调试');
  }
  
  return isCorrect;
}
</script>
</body>
</html>
