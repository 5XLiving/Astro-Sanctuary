<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + “不详”同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏“估时间”按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
/* 聊天输入行：输入框撑满、按钮按内容自适应 */
.ss-chat-input{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px; border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto; min-width:0;
}
.ss-chat-input .btn,
.ss-chat-input button{
  flex:0 0 auto;
  width:auto !important;
  white-space:nowrap;
  padding:10px 14px;
}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    /* 修复：Grid 子项允许收缩，避免内容把面板撑破 */
.auth-grid > * { min-width: 0; }
.panel .body .row.one > * { min-width: 0; }

/* 让会员按钮在窄宽度下能换行、居中且不溢出 */
.panel .body .btn {
  display: flex;               /* 改为 flex 更稳 */
  align-items: center;
  justify-content: center;
  text-align: center;
  white-space: normal;         /* 允许换行 */
  line-height: 1.2;
  word-break: break-word;      /* 多语言/长词可断行 */
}

/* 块级按钮确保占满容器且不超出 */
.btn.block { display:block; width:100%; box-sizing:border-box; }

/* 可选：如果仍有轻微位移，限制溢出 */
.panel .body { overflow: hidden; }

.panel .body .btn { padding: 10px 14px; }    
    /* === 表单网格：大屏 3 列，窄屏 1 列 === */
.row{display:grid;gap:12px;grid-template-columns:1fr;}        /* 默认 1 列 */
.row > *{min-width:0;}                                         /* 防止子项把容器撑爆 */
@media (min-width:760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr;}              /* 三列 */
}

/* 标签更紧凑 */
label.muted{display:block;margin-bottom:4px}

/* 按钮不要 100% 宽 */
#genBtn{width:auto !important}
.gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

/* 时间输入与“不详”并排、紧凑 */
.time-row{display:flex;align-items:center;gap:10px}
.time-row input[type="time"]{
  width:auto !important; flex:0 0 160px; min-width:140px;
}
.time-row .time-unknown{white-space:nowrap}
    .title a{ color: inherit; text-decoration: none; }
.title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    /* —— 统一头部 —— */
.site-header{
  position:sticky; top:0; z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

/* 品牌区：徽章 + 标题 */
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}

/* 语言选择：防止“语言”竖排、与第一张一致 */
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; min-width:170px;
  border-radius:10px; border:1px solid #243244;
  background:#0e1520; color:var(--text);
  padding:10px 34px 10px 12px; font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
/* 与 Index 保持一致的根字号（会影响 rem 计算） */
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }

/* 标题用 Noto Serif SC；字号/字重与 Index 完全一致 */
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}    

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}  

        /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <!-- 品牌：点击回到“八字简评”本页 -->
<a class="brand" href="https://astro.5xliving.com/" target="_self">
  <span class="brand-badge">5X</span>
  <span class="title">
    5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
  </span>
</a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
<div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

<div class="row cols-3">
  <div>
    <label class="muted" data-i18n="label_name">姓名（可选）</label>
    <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
  </div>
  <div>
    <label class="muted" data-i18n="gender_label">性别</label>
     <select id="gender">
     <option value="" data-i18n="opt_gender_confidential">不透露</option>
     <option value="male" data-i18n="opt_gender_male">男性</option>
     <option value="female" data-i18n="opt_gender_female">女性</option>
    </select>
  </div>
  <div>
    <label class="muted" data-i18n="label_calendar">历法</label>
     <select id="calendar">
     <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
     <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
    </select>
  </div>
</div>

<div class="row cols-3" style="margin-top:10px">
  <div>
    <label class="muted" data-i18n="label_birthdate">出生日期</label>
    <input type="date" id="birthdate" />
  </div>

  <div>
    <label class="muted" data-i18n="label_birthtime">出生时间</label>
    <div class="time-row">
     <input type="time" id="birthtime" value="12:00" />
     <label class="muted time-unknown">
     <input type="checkbox" id="timeUnknown" />
     <span data-i18n="cb_time_unknown">出生时间不详</span>
      </label>
    </div>
  </div>

  <div class="gen-wrap">
  <button class="btn" id="genBtn" type="button" aria-busy="false" aria-controls="result">
    <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
    <span id="genBtnLoading" data-i18n="btn_loading" style="display:none">计算中…</span>
  </button>
</div>    

      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">五行能量分析</div>
        <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username" />
                <!-- 登录/注册建议用 username，密码管理器更容易配对 -->

                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input 
                  id="password" 
                  type="password" 
                  autocomplete="new-password" 
                  placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>

            
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点“填入时间”，会用该时段的中位时间写到上方时间输入框，并自动取消“时间不详”。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

<script>
(function(){
'use strict';

/* =====================================
   Xinlian Butler + 八字排盘（整合版 · 完整）
   - 右下角 Butler Chat 完整实现
   - i18n：默认键兜底（五行/季节/按钮）
   - 语言切换：重渲报告 + 重新跑 Butler
   - 最小可用的 登录/注册/重置 处理
   ===================================== */

/* ================== 基础配置/工具 ================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const LANG_KEY = 'site_lang';

const $ = (id) => document.getElementById(id);
const qs = (s, root = document) => root.querySelector(s);

function showErr(msg){ const e=$('error'); if(!e) return; e.textContent=msg; e.style.display='block'; setTimeout(()=>{e.style.display='none';},5000); }
function hideErr(){ const e=$('error'); if(e){ e.style.display='none'; e.textContent=''; } }
function showAuthErr(msg){ const e=$('authError'); if(!e) return; e.textContent=msg; e.style.display='block'; setTimeout(()=>{ e.style.display='none'; },5000); }
function hideAuthErr(){ const e=$('authError'); if(e){ e.style.display='none'; e.textContent=''; } }
function lock(el, v){ if(el) el.disabled=v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id,v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ================== 多语言（含默认键） ================== */
// —— 默认键（兜底） ——
const DEFAULT_KEYS = {
  'zh-CN': {
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    btn_generate_chart:'生成八字', btn_loading:'计算中…'
  },
  'zh-TW': {
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    btn_generate_chart:'生成八字', btn_loading:'計算中…'
  },
  'en': {
    el_wood:'Wood', el_fire:'Fire', el_earth:'Earth', el_metal:'Metal', el_water:'Water',
    season_spring:'Spring', season_summer:'Summer', season_autumn:'Autumn', season_winter:'Winter',
    btn_generate_chart:'Generate Chart', btn_loading:'Calculating…'
  },
  'ja': {
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    btn_generate_chart:'命盤を生成', btn_loading:'計算中…'
  },
  'th': {
    el_wood:'ไม้', el_fire:'ไฟ', el_earth:'ดิน', el_metal:'ทอง', el_water:'น้ำ',
    season_spring:'ใบไม้ผลิ', season_summer:'ร้อน', season_autumn:'ใบไม้ร่วง', season_winter:'หนาว',
    btn_generate_chart:'สร้างดวง', btn_loading:'กำลังคำนวณ…'
  },
  'ms': {
    el_wood:'Kayu', el_fire:'Api', el_earth:'Tanah', el_metal:'Logam', el_water:'Air',
    season_spring:'Musim Bunga', season_summer:'Musim Panas', season_autumn:'Musim Luruh', season_winter:'Musim Sejuk',
    btn_generate_chart:'Jana Carta', btn_loading:'Mengira…'
  }
};

// —— 主翻译表（完整 zh-CN，其它语言回退到中文） ——
const translations = {
  'zh-CN': {
    // 顶部/表单
    lang_label: "语言",
    btn_register: "注册账户",
    btn_login: "登入账户",
    btn_reset: "🔑 重设密码",
    note_price: "注册账号赠送一次免费体验",
    note_price1: "$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",

    err_need_ep: "请输入邮箱与密码",
    err_pwd_rule: "密码至少8位，需包含大写/小写/数字/特殊符号",
    err_no_account: "账户不存在，请先注册",
    err_wrong_pwd: "密码错误",
    err_expired: "会员已过期，请续费",
    err_login_fail: "登入失败：",
    err_register_fail: "注册失败：",
    err_email_empty: "邮箱不能为空",
    err_pwd_empty: "密码不能为空",
    err_reset_fail: "重设密码失败：",

    prompt_email: "请输入注册邮箱：",
    prompt_newpwd: "请输入新密码（至少8位，含大小写、数字、符号）：",

    btn_upgrade: "💎 升级为 VIP（月费）",
    btn_backshop: "← 返回命理商城",

    vip_title: "🌙 会员区域 VIP Segment",
    vip_mingli: "🗝 命理空间专属内容",
    vip_xinlian: "🌙 心怜空间专属内容",
    vip_love: "姻缘方向：恋爱缘分、婚姻走势",
    vip_career: "事业方向：职场发展、创业潜力",
    vip_wealth: "财运方向：财位分析、理财时机",
    vip_pet: "宠物命理：伴侣动物的性格与缘分",
    vip_hepan: "合盘分析：婚期择日、新生择时",
    vip_name: "测名分析：公司名、宝宝名、命名改运",
    vip_fengshui: "财位合盘：住家 / 办公室动线配合",
    vip_record: "灵性记录：照片、梦境、声音、愿望祈祷",
    vip_course: "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    vip_memorial: "家族纪念系统：亲人灵性纪念 & 延续",
    vip_tasks: "每周能量练习 / 神明仪式任务",
    vip_shop: "能量商城专属折扣 & 御守订制",
    login_title: "💎 登入 VIP 功能",

    chat_fab: "问",
    chat_placeholder: "请问您想了解什么？（如：如何开始免费体验）",
    chat_send: "发送",
    msg_reset_ok: "密码已成功更新，请用新密码重新登入。",

    ph_email: "邮箱 Email",
    ph_password: "密码 Password（至少8位，含大小写数字符号）",
    ph_label_password: "密码 Password",

    title_quickcalc: "八字命理 · 快速排盘",
    title_bazi_brief: "八字简评",
    label_name: "姓名（可选）",
    ph_name: "你的称呼（用于个性化）",
    gender_label: "性别",
    label_calendar: "历法",
    label_birthdate: "出生日期",
    label_birthtime: "出生时间",
    cb_time_unknown: "出生时间不详",
    btn_generate_chart: "生成八字",
    panel_login_head: "账户登录 / 注册",
    panel_member_head: "会员服务",

    // 下拉项
    opt_gender_confidential: "不透露",
    opt_gender_male: "男性",
    opt_gender_female: "女性",
    opt_cal_gregorian: "阳历",
    opt_cal_lunar: "农历",

    elements_balance_tpl: "五行中{max}元素最强，{min}元素最弱。",

    // 报告/Butler
    butler_title: "心怜管家 · 解读",
    day_master: "日主",
    chart_strength: "命局",
    season: "季节",
    wuxing_distribution: "五行分布",
    note: "注意",
    time_unknown_checked: "已勾选“出生时间不详”",
    hour_pillar_excluded: "未纳入时柱",
    hint: "提示",
    no_hour_tip: "无时柱，建议仅作参考。",
    dev_strategy: "发展策略：",
    useful_elements: "喜用元素：",
    lucky_colors: "幸运颜色：",
    lucky_directions: "适合方位：",
    strength_strong: "偏强",
    strength_weak: "偏弱",
    strength_balanced: "平衡",
    desc_strong: "潜力足、抗压好",
    desc_weak: "需外援更能发挥",
    desc_balanced: "均衡、适应性强",
    desc_generic: "具有独特特点",
    season_spring: "木旺生发",
    season_summer: "火旺外放",
    season_autumn: "金旺收敛",
    season_winter: "水旺内藏",
    season_generic: "季节对命局有一定影响",
    el_wood: "木", el_fire: "火", el_earth: "土", el_metal: "金", el_water: "水",
    dir_wood: "东方", dir_fire: "南方", dir_earth: "中央/东北/西南", dir_metal: "西方", dir_water: "北方",
    color_wood: "绿色/青色", color_fire: "红色/紫色", color_earth: "黄色/棕色", color_metal: "白色/金色", color_water: "黑色/蓝色",

    // 报告分段
    rpt_free_title: "免费简报",
    rpt_pillars_label: "四柱",
    rpt_daymaster_label: "日主",
    rpt_season_label: "季节",
    rpt_chart_label: "命局",
    rpt_strategy_label: "策略",
    rpt_wuxing_label: "五行分布",
    rpt_strongest_word: "偏旺",
    rpt_weakest_word: "偏弱",
    rpt_absent_prefix: "缺：",
    rpt_fav_avoid_template: "喜用：{fav}｜忌：{avoid}",
    rpt_balance_focus_label: "调衡要点",
    rpt_time_hint: "提示：出生时间不详，未纳入时柱，仅供参考。",
    rpt_time_unknown: "时间不详",
    rpt_sec_overview_title: "一、命盘总览",
    rpt_sec_elements_title: "二、五行能量分析",
    rpt_sec_traits_title: "三、性格与天赋",
    rpt_traits_intro: "依据日主、季节与强弱给出核心性格标签（模板化占位）。",
    rpt_traits_adv: "优势能量：执行 / 创造 / 学习（模板化占位）。",
    rpt_traits_chal: "潜在挑战：节奏 / 边界 / 过犹不及（模板化占位）。",
    rpt_sec_structure_title: "四、格局与喜忌",
    rpt_structure_line_template: "喜用：{fav}；忌讳：{avoid}",
    rpt_sec_career_title: "五、事业与发展（免费试读）",
    rpt_career_fields_placeholder: "适合领域：结合喜用与气质（模板化占位）。",
    rpt_dev_strategy_prefix: "发展策略：",
    rpt_sec_love_title: "六、感情与关系（免费试读）",
    rpt_love_placeholder: "沟通节奏与边界建议（模板化占位）。",
    rpt_sec_wealth_title: "七、财富与理财（免费试读）",
    rpt_wealth_suggestion_template: "理财建议：以 {fav} 为主调，稳中求进。",
    rpt_sec_health_title: "八、健康与作息",
    rpt_health_placeholder_template: "围绕最弱五行（{weak}）做作息与环境优化（模板化占位）。",
    rpt_sec_env_title: "九、环境与色彩",
    rpt_env_placeholder: "有利方位与配色随喜用（模板化占位）。",
    rpt_strategy_drain: "泄秀/制化",
    rpt_strategy_support: "生扶/补助",
    rpt_strategy_balance: "调和",

    // —— Butler Chat & 快捷芯片 —— 
    butler_chat_title: "心怜管家 · Chat",
    chip_career: "事业建议",
    chip_love: "感情建议",
    chip_money: "财富建议",
    chip_list: "今日清单",
    chip_30d: "近30天运势",
    q_career: "结合我的命盘，给出 3–5 条职业/发展建议，并写出可执行步骤与优先级。",
    q_love: "结合我的命盘，给出沟通与相处建议（节奏、边界、注意事项），尽量可操作。",
    q_money: "结合我的命盘，给出近期理财/开源建议（风险提示、节奏与简单计划）。",
    q_list: "请给我今天/本周的可执行清单（分早/晚、工作/生活），量化并可在 30–60 分钟完成。",
    q_30d: "概述未来 30 天的能量主题、关键机会与避坑建议，附 3–5 条行动项。",

    vip_tip:"🔒 升级 VIP 以查看完整解读",
    vip_sub:"解锁全部章节与后续追问",
    btn_unlock:"立即解锁",
    err_network:"网络异常",
    err_busy:"服务繁忙，请稍后再试"
  },
  'en': {
  // Top/Form
  lang_label: "Language",
  btn_register: "Create account",
  btn_login: "Log in",
  btn_reset: "🔑 Reset password",
  note_price: "Sign up to get one free try",
  note_price1: "$9.9 / month VIP (Astro Space + Xinlian Space + Spiritual Courses)",

  err_need_ep: "Please enter email and password",
  err_pwd_rule: "Password must be at least 8 characters and include upper/lowercase, digits, and a symbol",
  err_no_account: "Account not found. Please register first",
  err_wrong_pwd: "Incorrect password",
  err_expired: "Membership expired. Please renew",
  err_login_fail: "Login failed: ",
  err_register_fail: "Registration failed: ",
  err_email_empty: "Email cannot be empty",
  err_pwd_empty: "Password cannot be empty",
  err_reset_fail: "Password reset failed: ",

  prompt_email: "Enter your registered email:",
  prompt_newpwd: "Enter a new password (≥ 8 chars, upper/lowercase, digits, symbol):",

  btn_upgrade: "💎 Upgrade to VIP (monthly)",
  btn_backshop: "← Back to Astro Shop",

  vip_title: "🌙 VIP Segment",
  vip_mingli: "🗝 Astro Space – Members-only",
  vip_xinlian: "🌙 Xinlian Space – Members-only",
  vip_love: "Love & marriage direction",
  vip_career: "Career growth & entrepreneurship",
  vip_wealth: "Wealth: positions & timing",
  vip_pet: "Pet destiny: companion animals",
  vip_hepan: "Synastry: wedding dates & newborn timing",
  vip_name: "Name analysis: company/baby/renaming",
  vip_fengshui: "Wealth position: home/office flow",
  vip_record: "Spiritual records: photos, dreams, voice, prayers",
  vip_course: "Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
  vip_memorial: "Family memorial system",
  vip_tasks: "Weekly energy practice / deity rituals",
  vip_shop: "Energy shop discounts & custom amulets",
  login_title: "💎 Log in to VIP",

  chat_fab: "Ask",
  chat_placeholder: "What would you like to know? (e.g., how to start the free try)",
  chat_send: "Send",
  msg_reset_ok: "Password updated. Please log in with the new one.",

  ph_email: "Email",
  ph_password: "Password (≥8, upper/lower/digits/symbol)",
  ph_label_password: "Password",

  title_quickcalc: "Bazi · Quick Chart",
  title_bazi_brief: "Bazi Brief",
  label_name: "Name (optional)",
  ph_name: "Your name (for personalization)",
  gender_label: "Gender",
  label_calendar: "Calendar",
  label_birthdate: "Birth date",
  label_birthtime: "Birth time",
  cb_time_unknown: "Birth time unknown",
  btn_generate_chart: "Generate Chart",
  panel_login_head: "Account Login / Register",
  panel_member_head: "Member Services",

  // Selects
  opt_gender_confidential: "Prefer not to say",
  opt_gender_male: "Male",
  opt_gender_female: "Female",
  opt_cal_gregorian: "Solar (Gregorian)",
  opt_cal_lunar: "Lunar",

  elements_balance_tpl: "Among the five elements, {max} is strongest and {min} is weakest.",

  // Report/Butler
  butler_title: "Xinlian Butler · Insight",
  day_master: "Day Master",
  chart_strength: "Chart Strength",
  season: "Season",
  wuxing_distribution: "Five Elements",
  note: "Note",
  time_unknown_checked: "“Birth time unknown” checked",
  hour_pillar_excluded: "Hour pillar excluded",
  hint: "Hint",
  no_hour_tip: "Without the hour pillar, treat the result as reference only.",
  dev_strategy: "Development Strategy:",
  useful_elements: "Favorable elements:",
  lucky_colors: "Lucky colors:",
  lucky_directions: "Auspicious directions:",
  strength_strong: "Strong",
  strength_weak: "Weak",
  strength_balanced: "Balanced",
  desc_strong: "High potential and resilience",
  desc_weak: "Needs support to shine",
  desc_balanced: "Balanced and adaptable",
  desc_generic: "Unique qualities",
  season_spring: "Wood rises (Spring)",
  season_summer: "Fire outward (Summer)",
  season_autumn: "Metal harvest (Autumn)",
  season_winter: "Water stores (Winter)",
  season_generic: "Season has certain influence",
  el_wood: "Wood", el_fire: "Fire", el_earth: "Earth", el_metal: "Metal", el_water: "Water",
  dir_wood: "East", dir_fire: "South", dir_earth: "Center/NE/SW", dir_metal: "West", dir_water: "North",
  color_wood: "Green/Teal", color_fire: "Red/Purple", color_earth: "Yellow/Brown", color_metal: "White/Gold", color_water: "Black/Blue",

  // Report sections
  rpt_free_title: "Free Brief",
  rpt_pillars_label: "Pillars",
  rpt_daymaster_label: "Day Master",
  rpt_season_label: "Season",
  rpt_chart_label: "Chart",
  rpt_strategy_label: "Strategy",
  rpt_wuxing_label: "Five Elements",
  rpt_strongest_word: "strongest",
  rpt_weakest_word: "weakest",
  rpt_absent_prefix: "Absent: ",
  rpt_fav_avoid_template: "Favorable: {fav} | Avoid: {avoid}",
  rpt_balance_focus_label: "Balancing Focus",
  rpt_time_hint: "Tip: Birth time unknown; hour pillar excluded; for reference only.",
  rpt_time_unknown: "Time unknown",
  rpt_sec_overview_title: "1) Overview",
  rpt_sec_elements_title: "2) Five-Element Analysis",
  rpt_sec_traits_title: "3) Traits & Talents",
  rpt_traits_intro: "Core traits based on Day Master, season, and strength (template placeholder).",
  rpt_traits_adv: "Strengths: execution / creativity / learning (template placeholder).",
  rpt_traits_chal: "Challenges: pacing / boundaries / excess (template placeholder).",
  rpt_sec_structure_title: "4) Structure & Favor/Avoid",
  rpt_structure_line_template: "Favorable: {fav}; Avoid: {avoid}",
  rpt_sec_career_title: "5) Career & Development (free preview)",
  rpt_career_fields_placeholder: "Suitable fields combining favorable elements and temperament (template).",
  rpt_dev_strategy_prefix: "Strategy: ",
  rpt_sec_love_title: "6) Relationships (free preview)",
  rpt_love_placeholder: "Communication rhythm & boundaries (template).",
  rpt_sec_wealth_title: "7) Wealth & Finance (free preview)",
  rpt_wealth_suggestion_template: "Finance: lead with {fav}, progress steadily.",
  rpt_sec_health_title: "8) Health & Routine",
  rpt_health_placeholder_template: "Optimize routine and space around the weakest element ({weak}).",
  rpt_sec_env_title: "9) Environment & Colors",
  rpt_env_placeholder: "Directions and colors follow the favorable elements (template).",
  rpt_strategy_drain: "Drain/Control",
  rpt_strategy_support: "Support/Nourish",
  rpt_strategy_balance: "Harmonize",

  // Butler Chat & chips
  butler_chat_title: "Xinlian Butler · Chat",
  chip_career: "Career Advice",
  chip_love: "Relationship Advice",
  chip_money: "Wealth Advice",
  chip_list: "Today’s To-Dos",
  chip_30d: "Next 30 Days",

  q_career: "Based on my chart, give 3–5 career/development suggestions with actionable steps and priorities.",
  q_love: "Based on my chart, give communication & relationship tips (rhythm, boundaries, cautions) with actionable points.",
  q_money: "Based on my chart, give near-term finance/income tips (risks, pacing, simple plan).",
  q_list: "Give me executable to-dos for today/this week (morning/evening, work/life), quantifiable and doable in 30–60 minutes.",
  q_30d: "Outline energy themes, key opportunities, and pitfalls for the next 30 days, with 3–5 actions.",

  vip_tip: "🔒 Upgrade to VIP to view the full insight",
  vip_sub: "Unlock all sections and follow-up questions",
  btn_unlock: "Unlock now",
  err_network: "Network error",
  err_busy: "Service busy, please try again later"
},

'ja': {
  // Top/Form
  lang_label: "言語",
  btn_register: "アカウント登録",
  btn_login: "ログイン",
  btn_reset: "🔑 パスワード再設定",
  note_price: "登録で1回の無料体験が付きます",
  note_price1: "$9.9 / 月額 VIP（Astro Space + Xinlian Space + スピリチュアル講座）",

  err_need_ep: "メールとパスワードを入力してください",
  err_pwd_rule: "パスワードは8文字以上、大小英字・数字・記号を含めてください",
  err_no_account: "アカウントが見つかりません。先に登録してください",
  err_wrong_pwd: "パスワードが正しくありません",
  err_expired: "会員期限が切れました。更新してください",
  err_login_fail: "ログインに失敗：",
  err_register_fail: "登録に失敗：",
  err_email_empty: "メールは必須です",
  err_pwd_empty: "パスワードは必須です",
  err_reset_fail: "再設定に失敗：",

  prompt_email: "登録メールを入力してください：",
  prompt_newpwd: "新しいパスワードを入力（8文字以上、大小英字・数字・記号）：",

  btn_upgrade: "💎 VIP にアップグレード（月額）",
  btn_backshop: "← 占いショップへ戻る",

  vip_title: "🌙 会員エリア（VIP）",
  vip_mingli: "🗝 Astro Space（会員限定）",
  vip_xinlian: "🌙 Xinlian Space（会員限定）",
  vip_love: "縁結び：恋愛・結婚の傾向",
  vip_career: "キャリア：職場成長・起業適性",
  vip_wealth: "金運：財位分析・タイミング",
  vip_pet: "ペットの命理：性格とご縁",
  vip_hepan: "合盤：結婚日取り・出産タイミング",
  vip_name: "命名分析：会社名・赤ちゃん名・改名",
  vip_fengshui: "財位合盤：住まい／オフィス動線",
  vip_record: "スピリチュアル記録：写真・夢・音声・祈り",
  vip_course: "講座：四柱推命／タロット／占星術／数秘／ヒューマンデザイン",
  vip_memorial: "家族メモリアル・システム",
  vip_tasks: "毎週のエナジーワーク／神事タスク",
  vip_shop: "エナジーショップ割引＆御守り制作",
  login_title: "💎 VIP 機能にログイン",

  chat_fab: "質問",
  chat_placeholder: "何を知りたいですか？（例：無料体験の始め方）",
  chat_send: "送信",
  msg_reset_ok: "パスワードを更新しました。新しいパスワードでログインしてください。",

  ph_email: "メール",
  ph_password: "パスワード（8文字以上・英大/小・数字・記号）",
  ph_label_password: "パスワード",

  title_quickcalc: "四柱推命・クイック作盤",
  title_bazi_brief: "四柱推命・簡易リーディング",
  label_name: "お名前（任意）",
  ph_name: "パーソナライズ用",
  gender_label: "性別",
  label_calendar: "暦",
  label_birthdate: "生年月日",
  label_birthtime: "出生時刻",
  cb_time_unknown: "出生時刻が不明",
  btn_generate_chart: "命盤を生成",
  panel_login_head: "ログイン / 新規登録",
  panel_member_head: "会員サービス",

  // Selects
  opt_gender_confidential: "回答しない",
  opt_gender_male: "男性",
  opt_gender_female: "女性",
  opt_cal_gregorian: "太陽暦（グレゴリオ）",
  opt_cal_lunar: "太陰暦",

  elements_balance_tpl: "五行のうち、{max}が最も強く、{min}が最も弱い。",

  // Report/Butler
  butler_title: "心怜バトラー・インサイト",
  day_master: "日主",
  chart_strength: "命式の強弱",
  season: "季節",
  wuxing_distribution: "五行分布",
  note: "注意",
  time_unknown_checked: "「出生時刻が不明」にチェック済み",
  hour_pillar_excluded: "時柱は含めません",
  hint: "ヒント",
  no_hour_tip: "時柱がないため、参考値として扱ってください。",
  dev_strategy: "発展戦略：",
  useful_elements: "有利な五行：",
  lucky_colors: "ラッキーカラー：",
  lucky_directions: "吉方位：",
  strength_strong: "強い",
  strength_weak: "弱い",
  strength_balanced: "バランス",
  desc_strong: "ポテンシャルが高く、打たれ強い",
  desc_weak: "支援があると力を発揮",
  desc_balanced: "均衡が取れ、適応力が高い",
  desc_generic: "独自の特徴を持つ",
  season_spring: "春：木が伸びる",
  season_summer: "夏：火が盛ん",
  season_autumn: "秋：金が収斂",
  season_winter: "冬：水が蓄える",
  season_generic: "季節の影響あり",
  el_wood: "木", el_fire: "火", el_earth: "土", el_metal: "金", el_water: "水",
  dir_wood: "東", dir_fire: "南", dir_earth: "中央/北東/南西", dir_metal: "西", dir_water: "北",
  color_wood: "緑/青緑", color_fire: "赤/紫", color_earth: "黄/茶", color_metal: "白/金", color_water: "黒/青",

  // Report sections
  rpt_free_title: "無料ブリーフ",
  rpt_pillars_label: "四柱",
  rpt_daymaster_label: "日主",
  rpt_season_label: "季節",
  rpt_chart_label: "命式",
  rpt_strategy_label: "戦略",
  rpt_wuxing_label: "五行",
  rpt_strongest_word: "強い",
  rpt_weakest_word: "弱い",
  rpt_absent_prefix: "欠如：",
  rpt_fav_avoid_template: "有利：{fav}｜不利：{avoid}",
  rpt_balance_focus_label: "調整ポイント",
  rpt_time_hint: "ヒント：出生時刻不明のため時柱なし。参考値です。",
  rpt_time_unknown: "時刻不明",
  rpt_sec_overview_title: "一、命盤の概観",
  rpt_sec_elements_title: "二、五行エネルギー分析",
  rpt_sec_traits_title: "三、性格と才能",
  rpt_traits_intro: "日主・季節・強弱に基づくコア特性（テンプレート）。",
  rpt_traits_adv: "強み：実行／創造／学習（テンプレート）。",
  rpt_traits_chal: "課題：ペース／境界／やり過ぎ（テンプレート）。",
  rpt_sec_structure_title: "四、格局と喜忌",
  rpt_structure_line_template: "有利：{fav}；不利：{avoid}",
  rpt_sec_career_title: "五、キャリア（無料プレビュー）",
  rpt_career_fields_placeholder: "喜用と気質を合わせた適職（テンプレ）。",
  rpt_dev_strategy_prefix: "戦略：",
  rpt_sec_love_title: "六、恋愛・人間関係（無料）",
  rpt_love_placeholder: "コミュニケーションのリズムと境界（テンプレ）。",
  rpt_sec_wealth_title: "七、金運・資産（無料）",
  rpt_wealth_suggestion_template: "資産運用：{fav}を主調に、堅実に進める。",
  rpt_sec_health_title: "八、健康と生活リズム",
  rpt_health_placeholder_template: "最も弱い五行（{weak}）に合わせて最適化。",
  rpt_sec_env_title: "九、環境と色彩",
  rpt_env_placeholder: "吉方位と配色は喜用に従う（テンプレ）。",
  rpt_strategy_drain: "洩らし/制御",
  rpt_strategy_support: "扶け/補強",
  rpt_strategy_balance: "調和",

  // Butler Chat & chips
  butler_chat_title: "心怜バトラー・チャット",
  chip_career: "キャリア提案",
  chip_love: "恋愛アドバイス",
  chip_money: "金運アドバイス",
  chip_list: "今日のタスクリスト",
  chip_30d: "今後30日",

  q_career: "私の命盤に基づき、実行手順と優先度つきで3〜5件のキャリア提案をください。",
  q_love: "命盤に基づき、コミュニケーションと関係のコツ（リズム・境界・注意点）を実行可能な形で。",
  q_money: "命盤に基づき、近い将来の資金計画/副収入の提案（リスク・ペース・簡単プラン）。",
  q_list: "今日/今週に実行できるタスク（朝/夜・仕事/生活）を、30〜60分で終えられる単位で提示。",
  q_30d: "今後30日のテーマ、チャンス、注意点を要約し、3〜5のアクションを付けてください。",

  vip_tip: "🔒 全文を見るには VIP へアップグレード",
  vip_sub: "全セクションと追質問を解放",
  btn_unlock: "今すぐ解放",
  err_network: "ネットワークエラー",
  err_busy: "混み合っています。しばらくして再試行してください"
},

'ms': {
  // Top/Form
  lang_label: "Bahasa",
  btn_register: "Daftar akaun",
  btn_login: "Log masuk",
  btn_reset: "🔑 Tetapkan semula kata laluan",
  note_price: "Daftar dan dapat satu percubaan percuma",
  note_price1: "$9.9 / bulan VIP (Ruang Astro + Ruang Xinlian + Kursus Kerohanian)",

  err_need_ep: "Sila masukkan emel dan kata laluan",
  err_pwd_rule: "Kata laluan sekurang-kurangnya 8 aksara, termasuk huruf besar/kecil, nombor dan simbol",
  err_no_account: "Akaun tidak ditemui. Sila daftar dahulu",
  err_wrong_pwd: "Kata laluan salah",
  err_expired: "Keahlian tamat tempoh. Sila perbaharui",
  err_login_fail: "Gagal log masuk: ",
  err_register_fail: "Gagal daftar: ",
  err_email_empty: "Emel tidak boleh kosong",
  err_pwd_empty: "Kata laluan tidak boleh kosong",
  err_reset_fail: "Gagal tetapkan semula: ",

  prompt_email: "Masukkan emel berdaftar:",
  prompt_newpwd: "Masukkan kata laluan baharu (≥8 aksara, huruf besar/kecil, nombor, simbol):",

  btn_upgrade: "💎 Naik taraf ke VIP (bulanan)",
  btn_backshop: "← Kembali ke Kedai Astro",

  vip_title: "🌙 Segmen VIP",
  vip_mingli: "🗝 Ruang Astro – Eksklusif Ahli",
  vip_xinlian: "🌙 Ruang Xinlian – Eksklusif Ahli",
  vip_love: "Arah jodoh: cinta & perkahwinan",
  vip_career: "Kerjaya: perkembangan & potensi usahawan",
  vip_wealth: "Kekayaan: kedudukan & masa",
  vip_pet: "Nasib haiwan peliharaan: personaliti & jodoh",
  vip_hepan: "Keserasian/合盤: tarikh kahwin & masa kelahiran",
  vip_name: "Analisis nama: syarikat/bayi/penamaan semula",
  vip_fengshui: "Posisi kekayaan: aliran rumah/pejabat",
  vip_record: "Rekod rohani: foto, mimpi, suara, doa",
  vip_course: "Kursus: Bazi / Tarot / Astrologi / Nombor / Human Design",
  vip_memorial: "Sistem memorial keluarga",
  vip_tasks: "Latihan tenaga mingguan / ritual",
  vip_shop: "Diskaun kedai tenaga & jimat tempahan",
  login_title: "💎 Log masuk VIP",

  chat_fab: "Tanya",
  chat_placeholder: "Apa yang ingin anda ketahui? (cth: cara mula percubaan percuma)",
  chat_send: "Hantar",
  msg_reset_ok: "Kata laluan berjaya dikemas kini. Sila log masuk semula.",

  ph_email: "Emel",
  ph_password: "Kata laluan (≥8, huruf besar/kecil, nombor, simbol)",
  ph_label_password: "Kata laluan",

  title_quickcalc: "Bazi · Carta Pantas",
  title_bazi_brief: "Ringkasan Bazi",
  label_name: "Nama (pilihan)",
  ph_name: "Nama anda (untuk personalisasi)",
  gender_label: "Jantina",
  label_calendar: "Kalendar",
  label_birthdate: "Tarikh lahir",
  label_birthtime: "Masa lahir",
  cb_time_unknown: "Masa lahir tidak diketahui",
  btn_generate_chart: "Jana Carta",
  panel_login_head: "Log Masuk / Daftar",
  panel_member_head: "Perkhidmatan Ahli",

  // Selects
  opt_gender_confidential: "Tidak mahu nyatakan",
  opt_gender_male: "Lelaki",
  opt_gender_female: "Perempuan",
  opt_cal_gregorian: "Suria (Gregorian)",
  opt_cal_lunar: "Lunar",

  elements_balance_tpl: "Dalam lima unsur, {max} paling kuat dan {min} paling lemah.",

  // Report/Butler
  butler_title: "Xinlian Butler · Insight",
  day_master: "Day Master",
  chart_strength: "Kekuatan Carta",
  season: "Musim",
  wuxing_distribution: "Agihan Lima Unsur",
  note: "Nota",
  time_unknown_checked: "“Masa lahir tidak diketahui” dipilih",
  hour_pillar_excluded: "Tiang jam dikecualikan",
  hint: "Petua",
  no_hour_tip: "Tanpa tiang jam, hasil hanya untuk rujukan.",
  dev_strategy: "Strategi Pembangunan:",
  useful_elements: "Unsur menguntungkan:",
  lucky_colors: "Warna bertuah:",
  lucky_directions: "Arah baik:",
  strength_strong: "Kuat",
  strength_weak: "Lemah",
  strength_balanced: "Seimbang",
  desc_strong: "Potensi tinggi dan tahan tekanan",
  desc_weak: "Perlu sokongan untuk menyerlah",
  desc_balanced: "Seimbang dan mudah menyesuaikan diri",
  desc_generic: "Ciri unik",
  season_spring: "Musim bunga: Kayu meningkat",
  season_summer: "Musim panas: Api memuncak",
  season_autumn: "Musim luruh: Logam menuai",
  season_winter: "Musim sejuk: Air menyimpan",
  season_generic: "Musim memberi pengaruh tertentu",
  el_wood: "Kayu", el_fire: "Api", el_earth: "Tanah", el_metal: "Logam", el_water: "Air",
  dir_wood: "Timur", dir_fire: "Selatan", dir_earth: "Tengah/NE/SW", dir_metal: "Barat", dir_water: "Utara",
  color_wood: "Hijau/Turkuois", color_fire: "Merah/Ungu", color_earth: "Kuning/Coklat", color_metal: "Putih/Emas", color_water: "Hitam/Biru",

  // Report sections
  rpt_free_title: "Ringkasan Percuma",
  rpt_pillars_label: "Tiang",
  rpt_daymaster_label: "Day Master",
  rpt_season_label: "Musim",
  rpt_chart_label: "Carta",
  rpt_strategy_label: "Strategi",
  rpt_wuxing_label: "Lima Unsur",
  rpt_strongest_word: "paling kuat",
  rpt_weakest_word: "paling lemah",
  rpt_absent_prefix: "Tiada: ",
  rpt_fav_avoid_template: "Menguntungkan: {fav} | Elak: {avoid}",
  rpt_balance_focus_label: "Fokus Keseimbangan",
  rpt_time_hint: "Petua: masa lahir tidak diketahui; tiang jam dikecualikan.",
  rpt_time_unknown: "Masa tidak diketahui",
  rpt_sec_overview_title: "1) Gambaran Keseluruhan",
  rpt_sec_elements_title: "2) Analisis Lima Unsur",
  rpt_sec_traits_title: "3) Sifat & Bakat",
  rpt_traits_intro: "Ciri teras berdasarkan Day Master, musim dan kekuatan (templat).",
  rpt_traits_adv: "Kekuatan: pelaksanaan / kreativiti / pembelajaran (templat).",
  rpt_traits_chal: "Cabaran: tempo / sempadan / berlebihan (templat).",
  rpt_sec_structure_title: "4) Struktur & Baik/Elak",
  rpt_structure_line_template: "Menguntungkan: {fav}; Elak: {avoid}",
  rpt_sec_career_title: "5) Kerjaya (pratonton percuma)",
  rpt_career_fields_placeholder: "Bidang sesuai mengikut unsur menguntungkan & perangai (templat).",
  rpt_dev_strategy_prefix: "Strategi: ",
  rpt_sec_love_title: "6) Hubungan (pratonton percuma)",
  rpt_love_placeholder: "Irama komunikasi & sempadan (templat).",
  rpt_sec_wealth_title: "7) Kekayaan & Kewangan (pratonton percuma)",
  rpt_wealth_suggestion_template: "Kewangan: utamakan {fav}, maju secara stabil.",
  rpt_sec_health_title: "8) Kesihatan & Rutin",
  rpt_health_placeholder_template: "Optimumkan rutin dan ruang sekitar unsur terlemah ({weak}).",
  rpt_sec_env_title: "9) Persekitaran & Warna",
  rpt_env_placeholder: "Arah & warna mengikut unsur menguntungkan (templat).",
  rpt_strategy_drain: "Alir/Kawal",
  rpt_strategy_support: "Sokong/Suap",
  rpt_strategy_balance: "Seimbangkan",

  // Butler Chat & chips
  butler_chat_title: "Xinlian Butler · Chat",
  chip_career: "Nasihat Kerjaya",
  chip_love: "Nasihat Hubungan",
  chip_money: "Nasihat Kewangan",
  chip_list: "Senarai Hari Ini",
  chip_30d: "30 Hari Akan Datang",

  q_career: "Berdasarkan carta saya, berikan 3–5 cadangan kerjaya/kemajuan dengan langkah boleh tindakan dan keutamaan.",
  q_love: "Berikan nasihat komunikasi & hubungan (irama, sempadan, perhatian) yang boleh dilaksana berdasarkan carta saya.",
  q_money: "Berdasarkan carta, berikan tip kewangan/pendapatan jangka dekat (risiko, tempo, pelan ringkas).",
  q_list: "Berikan tugasan hari ini/minggu ini (pagi/malam, kerja/hidup) yang boleh siap dalam 30–60 minit.",
  q_30d: "Huraikan tema tenaga 30 hari seterusnya, peluang & elak perangkap, dengan 3–5 tindakan.",

  vip_tip: "🔒 Naik taraf ke VIP untuk melihat penuh",
  vip_sub: "Buka semua bahagian dan soalan susulan",
  btn_unlock: "Buka kunci sekarang",
  err_network: "Ralat rangkaian",
  err_busy: "Perkhidmatan sibuk, cuba lagi nanti"
},

'th': {
  // Top/Form
  lang_label: "ภาษา",
  btn_register: "สมัครบัญชี",
  btn_login: "เข้าสู่ระบบ",
  btn_reset: "🔑 รีเซ็ตรหัสผ่าน",
  note_price: "สมัครแล้วรับสิทธิ์ทดลองใช้ฟรี 1 ครั้ง",
  note_price1: "$9.9 / เดือน VIP (Astro Space + Xinlian Space + คอร์สจิตวิญญาณ)",

  err_need_ep: "กรุณากรอกอีเมลและรหัสผ่าน",
  err_pwd_rule: "รหัสผ่านอย่างน้อย 8 ตัวอักษร มีตัวพิมพ์ใหญ่/เล็ก ตัวเลข และสัญลักษณ์",
  err_no_account: "ไม่พบบัญชี โปรดสมัครสมาชิกก่อน",
  err_wrong_pwd: "รหัสผ่านไม่ถูกต้อง",
  err_expired: "สมาชิกหมดอายุ โปรดต่ออายุ",
  err_login_fail: "เข้าสู่ระบบล้มเหลว: ",
  err_register_fail: "สมัครสมาชิกล้มเหลว: ",
  err_email_empty: "อีเมลห้ามเว้นว่าง",
  err_pwd_empty: "รหัสผ่านห้ามเว้นว่าง",
  err_reset_fail: "รีเซ็ตรหัสผ่านล้มเหลว: ",

  prompt_email: "กรุณากรอกอีเมลที่ลงทะเบียน:",
  prompt_newpwd: "ตั้งรหัสผ่านใหม่ (≥8 ตัวอักษร มีตัวใหญ่/เล็ก ตัวเลข สัญลักษณ์):",

  btn_upgrade: "💎 อัปเกรดเป็น VIP (รายเดือน)",
  btn_backshop: "← กลับสู่ร้าน Astro",

  vip_title: "🌙 พื้นที่สมาชิก VIP",
  vip_mingli: "🗝 Astro Space (เฉพาะสมาชิก)",
  vip_xinlian: "🌙 Xinlian Space (เฉพาะสมาชิก)",
  vip_love: "ความรัก/แต่งงาน",
  vip_career: "การงาน/ศักยภาพการเป็นผู้ประกอบการ",
  vip_wealth: "การเงิน: ตำแหน่งโชคลาภ & จังหวะเวลา",
  vip_pet: "ดวงสัตว์เลี้ยง: บุคลิก & ความผูกพัน",
  vip_hepan: "จับคู่/合盤: วันแต่งงาน & เวลาเกิดทารก",
  vip_name: "วิเคราะห์ชื่อ: บริษัท/ทารก/เปลี่ยนชื่อ",
  vip_fengshui: "ตำแหน่งโชคลาภ: บ้าน/ออฟฟิศ",
  vip_record: "บันทึกจิตวิญญาณ: รูปภาพ ความฝัน เสียง คำอธิษฐาน",
  vip_course: "คอร์ส: Bazi / ไพ่ทาโรต์ / โหราศาสตร์ / ตัวเลข / Human Design",
  vip_memorial: "ระบบระลึกถึงครอบครัว",
  vip_tasks: "แบบฝึกพลังงานประจำสัปดาห์ / พิธีกรรม",
  vip_shop: "ส่วนลดร้านพลังงาน & เครื่องรางสั่งทำ",
  login_title: "💎 เข้าสู่ระบบ VIP",

  chat_fab: "ถาม",
  chat_placeholder: "อยากรู้เรื่องอะไร? (เช่น วิธีเริ่มทดลองใช้ฟรี)",
  chat_send: "ส่ง",
  msg_reset_ok: "อัปเดตรหัสผ่านแล้ว กรุณาเข้าสู่ระบบอีกครั้ง",

  ph_email: "อีเมล",
  ph_password: "รหัสผ่าน (≥8 ตัวอักษร ตัวใหญ่/เล็ก ตัวเลข สัญลักษณ์)",
  ph_label_password: "รหัสผ่าน",

  title_quickcalc: "Bazi · จัดทำดวงแบบด่วน",
  title_bazi_brief: "สรุปดวง Bazi",
  label_name: "ชื่อ (ไม่บังคับ)",
  ph_name: "ชื่อของคุณ (เพื่อปรับให้เหมาะบุคคล)",
  gender_label: "เพศ",
  label_calendar: "ปฏิทิน",
  label_birthdate: "วันเกิด",
  label_birthtime: "เวลาเกิด",
  cb_time_unknown: "เวลาเกิดไม่ทราบ",
  btn_generate_chart: "สร้างดวง",
  panel_login_head: "เข้าสู่ระบบ / สมัครสมาชิก",
  panel_member_head: "บริการสมาชิก",

  // Selects
  opt_gender_confidential: "ไม่ระบุ",
  opt_gender_male: "ชาย",
  opt_gender_female: "หญิง",
  opt_cal_gregorian: "สุริยคติ (สากล)",
  opt_cal_lunar: "จันทรคติ",

  elements_balance_tpl: "ในห้าองค์ประกอบ {max} เด่นที่สุด และ {min} อ่อนที่สุด",

  // Report/Butler
  butler_title: "Xinlian Butler · Insight",
  day_master: "Day Master",
  chart_strength: "ความแข็งแกร่งดวง",
  season: "ฤดู",
  wuxing_distribution: "องค์ประกอบทั้งห้า",
  note: "หมายเหตุ",
  time_unknown_checked: "เลือก “ไม่ทราบเวลาเกิด”",
  hour_pillar_excluded: "ไม่รวมเสาเวลา (Hour Pillar)",
  hint: "เคล็ดลับ",
  no_hour_tip: "หากไม่มีเสาเวลา ผลควรใช้เพื่ออ้างอิงเท่านั้น",
  dev_strategy: "กลยุทธ์การพัฒนา:",
  useful_elements: "องค์ประกอบที่เกื้อหนุน:",
  lucky_colors: "สีมงคล:",
  lucky_directions: "ทิศมงคล:",
  strength_strong: "แข็งแรง",
  strength_weak: "อ่อน",
  strength_balanced: "สมดุล",
  desc_strong: "ศักยภาพสูง อดทนต่อแรงกดดัน",
  desc_weak: "ต้องการการสนับสนุนจึงจะโดดเด่น",
  desc_balanced: "สมดุลและปรับตัวได้ดี",
  desc_generic: "มีเอกลักษณ์เฉพาะตัว",
  season_spring: "ใบไม้ผลิ: ไม้เติบโต",
  season_summer: "ฤดูร้อน: ไฟเฟื่องฟู",
  season_autumn: "ฤดูใบไม้ร่วง: โลหะเก็บเกี่ยว",
  season_winter: "ฤดูหนาว: น้ำเก็บกัก",
  season_generic: "ฤดูกาลมีอิทธิพลต่อดวง",
  el_wood: "ไม้", el_fire: "ไฟ", el_earth: "ดิน", el_metal: "โลหะ", el_water: "น้ำ",
  dir_wood: "ตะวันออก", dir_fire: "ใต้", dir_earth: "กลาง/ตะวันออกเฉียงเหนือ/ตะวันตกเฉียงใต้", dir_metal: "ตะวันตก", dir_water: "เหนือ",
  color_wood: "เขียว/ฟ้าน้ำทะเล", color_fire: "แดง/ม่วง", color_earth: "เหลือง/น้ำตาล", color_metal: "ขาว/ทอง", color_water: "ดำ/น้ำเงิน",

  // Report sections
  rpt_free_title: "สรุปฟรี",
  rpt_pillars_label: "เสา (Pillars)",
  rpt_daymaster_label: "Day Master",
  rpt_season_label: "ฤดู",
  rpt_chart_label: "ดวง",
  rpt_strategy_label: "กลยุทธ์",
  rpt_wuxing_label: "ห้าองค์ประกอบ",
  rpt_strongest_word: "เด่น",
  rpt_weakest_word: "อ่อน",
  rpt_absent_prefix: "ขาด: ",
  rpt_fav_avoid_template: "เกื้อหนุน: {fav} | เลี่ยง: {avoid}",
  rpt_balance_focus_label: "จุดเน้นการปรับสมดุล",
  rpt_time_hint: "หมายเหตุ: ไม่ทราบเวลาเกิด จึงไม่รวมเสาเวลา ใช้อ้างอิงเท่านั้น",
  rpt_time_unknown: "ไม่ทราบเวลา",
  rpt_sec_overview_title: "1) ภาพรวม",
  rpt_sec_elements_title: "2) วิเคราะห์องค์ประกอบทั้งห้า",
  rpt_sec_traits_title: "3) บุคลิก & ความถนัด",
  rpt_traits_intro: "คุณลักษณะหลักจาก Day Master ฤดู และความแข็งแรง (แม่แบบ).",
  rpt_traits_adv: "พลังเด่น: ลงมือทำ / สร้างสรรค์ / เรียนรู้ (แม่แบบ).",
  rpt_traits_chal: "ความท้าทาย: จังหวะ / ขอบเขต / ทำมากเกิน (แม่แบบ).",
  rpt_sec_structure_title: "4) โครงสร้าง & สิ่งที่ควร/หลีกเลี่ยง",
  rpt_structure_line_template: "เกื้อหนุน: {fav}; เลี่ยง: {avoid}",
  rpt_sec_career_title: "5) การงาน (ตัวอย่างฟรี)",
  rpt_career_fields_placeholder: "สายงานที่เหมาะตามองค์ประกอบเกื้อหนุน & ธาตุใจ (แม่แบบ).",
  rpt_dev_strategy_prefix: "กลยุทธ์: ",
  rpt_sec_love_title: "6) ความรัก/ความสัมพันธ์ (ตัวอย่างฟรี)",
  rpt_love_placeholder: "จังหวะการสื่อสาร & ขอบเขต (แม่แบบ).",
  rpt_sec_wealth_title: "7) การเงิน (ตัวอย่างฟรี)",
  rpt_wealth_suggestion_template: "การเงิน: นำด้วย {fav} เดินหน้าอย่างมั่นคง",
  rpt_sec_health_title: "8) สุขภาพ & วิถีชีวิต",
  rpt_health_placeholder_template: "ปรับตารางชีวิต/สภาพแวดล้อมตามธาตุที่อ่อนที่สุด ({weak}).",
  rpt_sec_env_title: "9) สภาพแวดล้อม & สีสัน",
  rpt_env_placeholder: "ทิศและสีมงคลอิงองค์ประกอบเกื้อหนุน (แม่แบบ).",
  rpt_strategy_drain: "ระบาย/ควบคุม",
  rpt_strategy_support: "เสริม/เกื้อหนุน",
  rpt_strategy_balance: "ปรับสมดุล",

  // Butler Chat & chips
  butler_chat_title: "Xinlian Butler · แชต",
  chip_career: "แนะนำการงาน",
  chip_love: "แนะนำความรัก",
  chip_money: "แนะนำการเงิน",
  chip_list: "รายการวันนี้",
  chip_30d: "30 วันถัดไป",

  q_career: "จากดวงของฉัน ช่วยให้คำแนะนำอาชีพ 3–5 ข้อ พร้อมขั้นตอนปฏิบัติและลำดับความสำคัญ",
  q_love: "ตามดวงของฉัน ให้คำแนะนำการสื่อสาร/ความสัมพันธ์ (จังหวะ ขอบเขต ข้อควรระวัง) ที่ทำได้จริง",
  q_money: "ตามดวงของฉัน ให้คำแนะนำการเงิน/รายได้ระยะใกล้ (ความเสี่ยง จังหวะ แผนง่ายๆ)",
  q_list: "ให้รายการงานวันนี้/สัปดาห์นี้ (เช้า/เย็น งาน/ชีวิต) ที่ทำได้ใน 30–60 นาที",
  q_30d: "สรุปธีมพลังงาน 30 วันถัดไป โอกาสสำคัญ และข้อควรหลีกเลี่ยง พร้อม 3–5 การกระทำ",

  vip_tip: "🔒 อัปเกรดเป็น VIP เพื่อดูฉบับเต็ม",
  vip_sub: "ปลดล็อกทุกหัวข้อและคำถามต่อยอด",
  btn_unlock: "ปลดล็อกตอนนี้",
  err_network: "เครือข่ายผิดพลาด",
  err_busy: "ระบบงานแน่น กรุณาลองใหม่ภายหลัง"
},

'zh-TW': {
  // 頂部/表單
  lang_label: "語言",
  btn_register: "註冊帳戶",
  btn_login: "登入帳戶",
  btn_reset: "🔑 重設密碼",
  note_price: "註冊帳號贈送一次免費體驗",
  note_price1: "$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）",

  err_need_ep: "請輸入信箱與密碼",
  err_pwd_rule: "密碼至少 8 位，需包含大寫/小寫/數字/符號",
  err_no_account: "帳戶不存在，請先註冊",
  err_wrong_pwd: "密碼錯誤",
  err_expired: "會員已過期，請續費",
  err_login_fail: "登入失敗：",
  err_register_fail: "註冊失敗：",
  err_email_empty: "信箱不可為空",
  err_pwd_empty: "密碼不可為空",
  err_reset_fail: "重設密碼失敗：",

  prompt_email: "請輸入註冊信箱：",
  prompt_newpwd: "請輸入新密碼（至少 8 位，含大小寫、數字、符號）：",

  btn_upgrade: "💎 升級為 VIP（月費）",
  btn_backshop: "← 返回命理商城",

  vip_title: "🌙 會員區域 VIP Segment",
  vip_mingli: "🗝 命理空間專屬內容",
  vip_xinlian: "🌙 心憐空間專屬內容",
  vip_love: "姻緣方向：戀愛緣分、婚姻走勢",
  vip_career: "事業方向：職場發展、創業潛力",
  vip_wealth: "財運方向：財位分析、理財時機",
  vip_pet: "寵物命理：伴侶動物的性格與緣分",
  vip_hepan: "合盤分析：婚期擇日、新生擇時",
  vip_name: "測名分析：公司名、寶寶名、命名改運",
  vip_fengshui: "財位合盤：居家 / 辦公室動線配合",
  vip_record: "靈性記錄：照片、夢境、聲音、願望祈禱",
  vip_course: "命理課程：八字 / 塔羅 / 占星 / 靈數 / 人類圖",
  vip_memorial: "家族紀念系統：親人靈性紀念與延續",
  vip_tasks: "每週能量練習 / 神明儀式任務",
  vip_shop: "能量商城專屬折扣與御守訂製",
  login_title: "💎 登入 VIP 功能",

  chat_fab: "問",
  chat_placeholder: "想了解什麼？（例：如何開始免費體驗）",
  chat_send: "發送",
  msg_reset_ok: "密碼已更新，請使用新密碼重新登入。",

  ph_email: "信箱 Email",
  ph_password: "密碼 Password（至少8位，含大小寫數字符號）",
  ph_label_password: "密碼 Password",

  title_quickcalc: "八字命理 · 快速排盤",
  title_bazi_brief: "八字簡評",
  label_name: "姓名（可選）",
  ph_name: "你的稱呼（用於個性化）",
  gender_label: "性別",
  label_calendar: "曆法",
  label_birthdate: "出生日期",
  label_birthtime: "出生時間",
  cb_time_unknown: "出生時間不詳",
  btn_generate_chart: "生成八字",
  panel_login_head: "帳戶登入 / 註冊",
  panel_member_head: "會員服務",

  // 下拉項
  opt_gender_confidential: "不透露",
  opt_gender_male: "男性",
  opt_gender_female: "女性",
  opt_cal_gregorian: "陽曆",
  opt_cal_lunar: "農曆",

  elements_balance_tpl: "五行中{max}元素最強，{min}元素最弱。",

  // 報告/Butler
  butler_title: "心憐管家 · 解讀",
  day_master: "日主",
  chart_strength: "命局",
  season: "季節",
  wuxing_distribution: "五行分佈",
  note: "注意",
  time_unknown_checked: "已勾選「出生時間不詳」",
  hour_pillar_excluded: "未納入時柱",
  hint: "提示",
  no_hour_tip: "無時柱，建議僅作參考。",
  dev_strategy: "發展策略：",
  useful_elements: "喜用元素：",
  lucky_colors: "幸運顏色：",
  lucky_directions: "適合方位：",
  strength_strong: "偏強",
  strength_weak: "偏弱",
  strength_balanced: "平衡",
  desc_strong: "潛力足、抗壓好",
  desc_weak: "需外援更能發揮",
  desc_balanced: "均衡、適應性強",
  desc_generic: "具獨特特點",
  season_spring: "木旺生發",
  season_summer: "火旺外放",
  season_autumn: "金旺收斂",
  season_winter: "水旺內藏",
  season_generic: "季節對命局有一定影響",
  el_wood: "木", el_fire: "火", el_earth: "土", el_metal: "金", el_water: "水",
  dir_wood: "東方", dir_fire: "南方", dir_earth: "中央/東北/西南", dir_metal: "西方", dir_water: "北方",
  color_wood: "綠色/青色", color_fire: "紅色/紫色", color_earth: "黃色/棕色", color_metal: "白色/金色", color_water: "黑色/藍色",

  // 報告分段
  rpt_free_title: "免費簡報",
  rpt_pillars_label: "四柱",
  rpt_daymaster_label: "日主",
  rpt_season_label: "季節",
  rpt_chart_label: "命局",
  rpt_strategy_label: "策略",
  rpt_wuxing_label: "五行分佈",
  rpt_strongest_word: "偏旺",
  rpt_weakest_word: "偏弱",
  rpt_absent_prefix: "缺：",
  rpt_fav_avoid_template: "喜用：{fav}｜忌：{avoid}",
  rpt_balance_focus_label: "調衡要點",
  rpt_time_hint: "提示：出生時間不詳，未納入時柱，僅供參考。",
  rpt_time_unknown: "時間不詳",
  rpt_sec_overview_title: "一、命盤總覽",
  rpt_sec_elements_title: "二、五行能量分析",
  rpt_sec_traits_title: "三、性格與天賦",
  rpt_traits_intro: "依據日主、季節與強弱給出核心性格標籤（模板化占位）。",
  rpt_traits_adv: "優勢能量：執行 / 創造 / 學習（模板化占位）。",
  rpt_traits_chal: "潛在挑戰：節奏 / 邊界 / 過猶不及（模板化占位）。",
  rpt_sec_structure_title: "四、格局與喜忌",
  rpt_structure_line_template: "喜用：{fav}；忌諱：{avoid}",
  rpt_sec_career_title: "五、事業與發展（免費試讀）",
  rpt_career_fields_placeholder: "適合領域：結合喜用與氣質（模板化占位）。",
  rpt_dev_strategy_prefix: "發展策略：",
  rpt_sec_love_title: "六、感情與關係（免費試讀）",
  rpt_love_placeholder: "溝通節奏與邊界建議（模板化占位）。",
  rpt_sec_wealth_title: "七、財富與理財（免費試讀）",
  rpt_wealth_suggestion_template: "理財建議：以 {fav} 為主調，穩中求進。",
  rpt_sec_health_title: "八、健康與作息",
  rpt_health_placeholder_template: "圍繞最弱五行（{weak}）做作息與環境優化（模板化占位）。",
  rpt_sec_env_title: "九、環境與色彩",
  rpt_env_placeholder: "有利方位與配色隨喜用（模板化占位）。",
  rpt_strategy_drain: "洩秀/制化",
  rpt_strategy_support: "生扶/補助",
  rpt_strategy_balance: "調和",

  // Butler Chat & chips
  butler_chat_title: "心憐管家 · Chat",
  chip_career: "事業建議",
  chip_love: "感情建議",
  chip_money: "財富建議",
  chip_list: "今日清單",
  chip_30d: "近30天運勢",
  q_career: "結合我的命盤，給出 3–5 條職涯/發展建議，附可執行步驟與優先級。",
  q_love: "結合我的命盤，給出溝通與相處建議（節奏、邊界、注意事項），務必可操作。",
  q_money: "結合我的命盤，給出近期理財/開源建議（風險提示、節奏與簡單計畫）。",
  q_list: "請給我今天/本週的可執行清單（分早/晚、工作/生活），量化並可在 30–60 分鐘完成。",
  q_30d: "概述未來 30 天的能量主題、關鍵機會與避坑建議，附 3–5 條行動。",

  vip_tip: "🔒 升級 VIP 以查看完整解讀",
  vip_sub: "解鎖全部章節與後續追問",
  btn_unlock: "立即解鎖",
  err_network: "網路異常",
  err_busy: "服務繁忙，請稍後再試"
  },   
    'zh-TW': null, 'en': null, 'ja': null, 'th': null, 'ms': null
  };
};
// 回退：把 null 的语言置为空对象（让 t() 统一兜底到 zh-CN 或 DEFAULT_KEYS）
for (const k of Object.keys(translations)) {
  if (translations[k] === null) translations[k] = {};
}

/* —— t()：多层回退 —— */
function t(key){
  const lang = getLang();
  const pack = translations[lang] || {};
  const zh   = translations['zh-CN'] || {};
  const D    = DEFAULT_KEYS[lang] || {};
  const Dz   = DEFAULT_KEYS['zh-CN'] || {};
  // 顺序：当前语言翻译 → 当前语言默认键 → 中文翻译 → 中文默认键
  const val  = (pack[key] ?? D[key] ?? zh[key] ?? Dz[key]);
  if (val == null) {
    console.warn('[i18n missing]', lang, key);
    return ''; // 缺失时返回空串，避免覆盖原文
  }
  return val;
}

// —— 语言名映射 —— 
const BUTLER_LANG_NAME = {
  'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese',
  en:'English', ja:'Japanese', th:'Thai', ms:'Malay'
};

function getLang(){
  const saved = localStorage.getItem(LANG_KEY);
  if (saved && (translations[saved] || DEFAULT_KEYS[saved])) return saved;
  const raw = (navigator.language||'zh-CN').replace('_','-');
  const map = { zh:'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW',
                en:'en','en-US':'en','en-GB':'en','en-AU':'en', ja:'ja','ja-JP':'ja', th:'th', ms:'ms' };
  return map[raw] || 'zh-CN';
}
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if (val !== '' && val !== key) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    const val = t(key);
    if (val !== '' && val !== key) el.setAttribute('placeholder', val);
  });
}
function applyChatI18n(){
  const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend'), title=qs('.ss-chat-title');
  if(fab) fab.textContent=t('chat_fab');
  if(inp) inp.placeholder=t('chat_placeholder');
  if(btn) btn.textContent=t('chat_send');
  if(title) title.textContent=t('butler_chat_title');
}
function initLangUI(){
  const sel=$('langSelect'); if(!sel) return;
  const current=getLang(); sel.value=current; document.documentElement.lang=current;
  applyI18n(); applyChatI18n();
  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n(); applyChatI18n();
    rerenderReportsIfAny();
    rerunButlerIfAny();
  });
}

/* ================== 八字计算器（简化） ================== */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(y){ const s=(y-4)%10, b=(y-4)%12;
    return { stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12], zodiac:this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y,m,d){
    const mmdd=m*100+d, gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val;
    const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
    return {index:idx, branch:branchBy[idx]};
  }
  calculateMonthPillar(y,m,d){
    const {index,branch}=this.solarMonthIndex(y,m,d);
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(y).stem);
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx=(startMap[yStemIdx]+(index-1))%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(y,m,d){
    const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(y,m-1,d);
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
    const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
    return { stem:this.HEAVENLY_STEMS[(stemIdx+10)%10], branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour){
    const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex=Math.floor((hour+1)/2)%12;
    const stemIdx=(startMap[dayIdx]+hourIndex)%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour] };
  }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  getElement(stem,branch){ return this.getStemElement(stem)+this.getBranchElement(branch); }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  calculateBazi(y,m,d,h=12,timeUnknown=false){
    const year=this.calculateYearPillar(y), month=this.calculateMonthPillar(y,m,d), day=this.calculateDayPillar(y,m,d);
    const hour=timeUnknown?{stem:'？', branch:'？'}:this.calculateHourPillar(day.stem,h);
    const dayElement=this.getStemElement(day.stem);
    const pillars={ year, month, day:{...day, element:dayElement}, hour };
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[year,month,day]:[year,month,day,hour]).forEach(p=>{
      if(p.stem&&p.stem!=='？') cnt[this.getStemElement(p.stem)]+=1;
      if(p.branch&&p.branch!=='？') cnt[this.getBranchElement(p.branch)]+=1;
    });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={ wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return { pillars, counts:cnt, percents:pct, timeUnknown };
  }
}
const baziCalculator=new BaziCalculator();

/* ================== 渲染/规则 ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem, branch=u?'？':v.branch;
    const div=document.createElement('div'); div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch));
  setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch));
  setIf('hour-element',timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch));
  setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch));
  setIf('hour-nayin',timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'偏强':score<=1?'偏弱':'平衡';
  const focus=mark==='偏强'?'泄秀/制化':mark==='偏弱'?'生扶/补助':'调和';
  return { season, mark, focus };
}
function chooseUseful(strength, dmElem){
  if(strength==='偏强') return { strategy:'泄秀/制化',
    useful:{木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']}[dmElem], avoid:[dmElem] };
  if(strength==='偏弱') return { strategy:'生扶/补助',
    useful:{木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']}[dmElem], avoid:[] };
  return { strategy:'调和', useful:['木','火','土','金','水'], avoid:[] };
}

/* ================== 多语言辅助 ================== */
const EL_CHAR_TO_KEY={木:'wood',火:'fire',土:'earth',金:'metal',水:'water'};
function ELABEL(){ return {
  wood: t('el_wood')||'木', fire: t('el_fire')||'火', earth: t('el_earth')||'土', metal: t('el_metal')||'金', water: t('el_water')||'水'
};}
function elCharsToLocale(arr){ const L=ELABEL(); return (arr||[]).map(ch=>L[EL_CHAR_TO_KEY[ch]]||ch); }
function listJoin(arr){ const lang=(getLang()||'').toLowerCase(); const sep=lang.startsWith('zh')?'、':', '; return (arr||[]).filter(Boolean).join(sep); }
function seasonName(s){
  const map={ 春:t('season_spring')||'春', 夏:t('season_summer')||'夏', 秋:t('season_autumn')||'秋', 冬:t('season_winter')||'冬' };
  return map[s]||s||'—';
}
function strategyName(s){
  const map={ '泄秀/制化':t('rpt_strategy_drain')||'泄秀/制化', '生扶/补助':t('rpt_strategy_support')||'生扶/补助', '调和':t('rpt_strategy_balance')||'调和' };
  return map[s]||s;
}

/* ================== 报告构建（免费 + 富报告） ================== */
function buildFreeReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), entries=Object.entries(percents||{});
  const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'', weakest=E[weakestK]||'';
  const absents=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]).filter(Boolean);
  const lang=(getLang()||'').toLowerCase(), sep=lang.startsWith('zh')?'　':' · ';
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]} ${Math.round(percents[k]||0)}%`).join(sep);
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favText=favLoc.length?listJoin(favLoc):'—', avoidText=avoidLoc.length?listJoin(avoidLoc):'—';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  const favAvoidLine=(t('rpt_fav_avoid_template')||'喜用：{fav}｜忌：{avoid}').replace('{fav}',favText).replace('{avoid}',avoidText);
  const absStr=absents.length? (lang.startsWith('zh')? `（${t('rpt_absent_prefix')||'缺：'}${listJoin(absents)}）` : ` (${t('rpt_absent_prefix')||'Absent: '}${listJoin(absents)})`) : '';
  return `
    <div class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px;color:var(--brand)">${t('rpt_free_title')||'免费简报'}</h3>
      <p style="margin:6px 0;">${t('rpt_pillars_label')||'四柱'}：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">${t('rpt_daymaster_label')||'日主'}：<strong>${pillars.day.stem}</strong>（<strong>${dmElemName}</strong>）｜${t('rpt_season_label')||'季节'}：<strong>${seasonName(st.season)||'-'}</strong>｜${t('rpt_chart_label')||'命局'}：<strong>${t('strength_'+(st.mark==='偏强'?'strong':st.mark==='偏弱'?'weak':'balanced'))||st.mark}</strong> · <strong>${t('rpt_strategy_label')||'策略'}：${stName}</strong></p>
      <p style="margin:8px 0;">${t('rpt_wuxing_label')||'五行'}：${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')||'偏旺'}；<strong>${weakest}</strong>${t('rpt_weakest_word')||'偏弱'}。${absStr}</p>
      <ul style="margin:6px 0 0 18px;line-height:1.6">
        <li>${favAvoidLine}</li>
        <li>${t('rpt_balance_focus_label')||'调衡要点'}：${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">${t('rpt_time_hint')||'提示：出生时间不详，未纳入时柱，仅供参考。'}</p>`:''}
    </div>`;
}
function buildRichReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), lang=(getLang()||'').toLowerCase();
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]}${lang.startsWith('zh')?'':' '}${Math.round(percents[k]||0)}%`).join(lang.startsWith('zh')?' ':' · ');
  const entries=Object.entries(percents||{}); const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'—', weakest=E[weakestK]||'—';
  const absentsArr=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]);
  const absentsStr=absentsArr.length ? (lang.startsWith('zh')? `（${t('rpt_absent_prefix')||'缺：'}${listJoin(absentsArr)}）` : ` (${t('rpt_absent_prefix')||'Absent: '}${listJoin(absentsArr)})`) : '';
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favList=favLoc.length?listJoin(favLoc):'—', avoidList=avoidLoc.length?listJoin(avoidLoc):'—';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  return `
    <section class="card" style="padding:20px;">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_overview_title')||'一、命盘总览'}</h3>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
        <div>${t('rpt_pillars_label')||'四柱'}：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></div>
        <div>${t('rpt_daymaster_label')||'日主'}：<strong>${pillars.day.stem}</strong>（<strong>${dmElemName}</strong>）</div>
        <div>${t('rpt_season_label')||'季节'}：<strong>${seasonName(st.season)||'-'}</strong></div>
        <div>${t('rpt_chart_label')||'命局'}：<strong>${t('strength_'+(st.mark==='偏强'?'strong':st.mark==='偏弱'?'weak':'balanced'))||st.mark}</strong> · ${t('rpt_strategy_label')||'策略'}：<strong>${stName}</strong></div>
      </div>
    </section>
    <section class="card" style="padding:20px;">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_elements_title')||'二、五行能量分析'}</h3>
      <div style="font-size:14px;">${line}</div>
      <p style="margin:10px 0 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')||'偏旺'}；<strong>${weakest}</strong>${t('rpt_weakest_word')||'偏弱'}。${absentsStr}</p>
      <ul style="margin:10px 0 0 18px;line-height:1.6">
        <li>${t('useful_elements')||'喜用元素：'}${favList}</li>
        <li>${t('rpt_balance_focus_label')||'调衡要点'}：${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:8px;">${t('rpt_time_hint')||'提示：出生时间不详，未纳入时柱，仅供参考。'}</p>`:''}
    </section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_traits_title')||'三、性格与天赋'}</h3><p>${t('rpt_traits_intro')||''}</p><p>${t('rpt_traits_adv')||''}</p><p>${t('rpt_traits_chal')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_structure_title')||'四、格局与喜忌'}</h3><p>${(t('rpt_structure_line_template')||'喜用：{fav}；忌讳：{avoid}').replace('{fav}',favList).replace('{avoid}',avoidList)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_career_title')||'五、事业与发展（免费试读）'}</h3><p>${t('rpt_career_fields_placeholder')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_love_title')||'六、感情与关系（免费试读）'}</h3><p>${t('rpt_love_placeholder')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_wealth_title')||'七、财富与理财（免费试读）'}</h3><p>${(t('rpt_wealth_suggestion_template')||'理财建议：以 {fav} 为主调，稳中求进。').replace('{fav}',favList)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_health_title')||'八、健康与作息'}</h3><p>${(t('rpt_health_placeholder_template')||'围绕最弱五行（{weak}）做优化。').replace('{weak}',weakest)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_env_title')||'九、环境与色彩'}</h3><p>${t('rpt_env_placeholder')||''}</p></section>
    <div id="butler-anchor"></div>`;
}
function mountExtensionsIntoResult(ctx){
  const resultEl=$('result'); if(!resultEl) return;
  let freeNode=$('xl-free-report');
  if(!freeNode){ freeNode=document.createElement('div'); freeNode.id='xl-free-report'; resultEl.appendChild(freeNode); }
  freeNode.innerHTML=buildFreeReportHTML(ctx);
}
function mountRichReport(ctx){
  let host=$('rich-report'); if(!host){ host=document.createElement('div'); host.id='rich-report'; $('result')?.appendChild(host); }
  host.innerHTML=buildRichReportHTML(ctx);
}

/* ================== Butler AI 卡片（芯片/锁定/多语言） ================== */
(function injectAiStyle(){
  const old=$('ai-style'); if(old) old.remove();
  const style=document.createElement('style'); style.id='ai-style';
  style.textContent=`
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  `;
  document.head.appendChild(style);
})();
function mdToHtml(md){
  return (md||'')
    .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
    .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    .replace(/\n{2,}/g,'\n\n')
    .replace(/\n/g,'<br/>');
}
function isVIP(){ return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail'); }
function ensureAiCard(){
  if($('aiCard')) return;
  const wrap=$('rich-report')||$('result'); if(!wrap) return;
  const sec=document.createElement('div'); sec.className='sec'; sec.id='aiCard';
  sec.innerHTML=`
    <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')||'心怜管家 · 解读'}</h3>
    <div id="aiContent" class="ai-content">
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>
    </div>
    <div class="chips" id="aiChips"></div>`;
  wrap.appendChild(sec);
  renderChips();
}
function renderChips(){
  const wrap = $('aiChips');
  if (!wrap) return;
  wrap.innerHTML = '';
  const chips = [
    {k:'chip_career', q:'q_career'},
    {k:'chip_love',   q:'q_love'},
    {k:'chip_money',  q:'q_money'},
    {k:'chip_list',   q:'q_list'},
    {k:'chip_30d',    q:'q_30d'}
  ];
  chips.forEach(it=>{
    const btn=document.createElement('button');
    btn.className='chip';
    const label=t(it.k) || it.k;
    btn.textContent=label;
    const dq=t(it.q) || label;
    btn.setAttribute('data-q', dq);
    wrap.appendChild(btn);
  });
}

/* ===== Butler 对话提示生成 ===== */
function buildButlerSystemPrompt(lang){
  const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
  const HEADER_MAP={
    'zh-CN':['人物画像','关系与沟通','事业与自我实现','金钱与物质','今日/本周可执行清单','温柔提醒'],
    'zh-TW':['人物画像','關係與溝通','事業與自我實現','金錢與物質','今日/本週可執行清單','溫柔提醒'],
    en:['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
    ja:['人物像','関係とコミュニケーション','キャリアと自己実現','お金と物質','今日/今週の実行リスト','やさしいリマインド'],
    th:['ภาพบุคคล','ความสัมพันธ์ & การสื่อสาร','การงาน & การเติมเต็มตนเอง','การเงิน & วัตถุ','รายการปฏิบัติ (วันนี้/สัปดาห์นี้)','คำเตือนอ่อนโยน'],
    ms:['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
  };
  const headers=HEADER_MAP[lang]||HEADER_MAP['zh-CN'];
  return [
    `You are "Xinlian Butler". OUTPUT LANGUAGE: ${ln}. Reply strictly in ${ln} only.`,
    'Warm, practical, actionable. No medical/legal conclusions.',
    'Markdown structure:',
    `## ${headers[0]}`, `## ${headers[1]} (2–4 bullets)`, `## ${headers[2]} (2–4 bullets)`,
    `## ${headers[3]} (2–3 bullets)`, `## ${headers[4]} (3–5 bullets; start with verbs; quantify if possible)`, `## ${headers[5]}`
  ].join('\n');
}
function buildBaziUserPrompt(ctx){
  const {name,date,time,place,pillars,percents,st,adv,timeUnknown}=ctx;
  const fav=listJoin(elCharsToLocale(adv?.useful||[])), avoid=listJoin(elCharsToLocale(adv?.avoid||[]));
  const elementsLine=`wood ${Math.round(percents.wood)}% · fire ${Math.round(percents.fire)}% · earth ${Math.round(percents.earth)}% · metal ${Math.round(percents.metal)}% · water ${Math.round(percents.water)}%`;
  const hourTxt=timeUnknown ? t('rpt_time_unknown') : (pillars.hour.stem + pillars.hour.branch);
  return [
    `Name: ${name||'-'}`,
    `Birth: ${date||'-'} ${time||'—'}${place?(' @ '+place):''}`,
    `Bazi pillars: Year ${pillars.year.stem}${pillars.year.branch} · Month ${pillars.month.stem}${pillars.month.branch} · Day ${pillars.day.stem}${pillars.day.branch} · Hour ${hourTxt}`,
    `Day Master: ${pillars.day.stem} (${pillars.day.element})`,
    `Season: ${st.season}; Chart Strength: ${st.mark}; Strategy: ${st.focus}`,
    `Favorable elements: ${fav||'—'}; Avoid: ${avoid||'—'}`,
    `Five elements distribution: ${elementsLine}`,
    'Expectation: human, concrete, and immediately actionable advice.'
  ].join('\n');
}
async function runButlerAI(ctx){
  ensureAiCard(); const title=$('butlerTitle'); if(title) title.textContent=t('butler_title')||'心怜管家 · 解读';
  const elC=$('aiContent'); if(elC){ elC.innerHTML=`<div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div><div style="width:50%"></div></div>`; }
  const lang=getLang(), sys=buildButlerSystemPrompt(lang), usr=buildBaziUserPrompt(ctx);
  try{
    const r=await fetch(API_BASE+'/api/chat',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:usr}]}) });
    const data=await r.json().catch(()=>({})); const raw=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
    let html=mdToHtml(raw);
    if(!isVIP()){
      const parts=raw.split(/\n##\s+/); const header=parts.shift()||''; const kept=[header,...(parts.slice(0,2).map(p=>'## '+p))].join('\n\n');
      html = mdToHtml(kept) + `
        <div class="ai-lock-overlay" style="text-align:center;padding:14px 10px;border-top:1px solid #1f2a36;margin-top:10px">
          <div class="tip">${t('vip_tip')||'🔒 升级 VIP 以查看完整解读'}</div>
          <div class="sub" style="margin-top:4px">${t('vip_sub')||''}</div>
          <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">${t('btn_unlock')||'立即解锁'}</a>
        </div>`;
    }
    if(elC) elC.innerHTML=html; renderChips();
  }catch(e){ if(elC) elC.innerHTML=`<div style="color:#98a7b7">${t('err_network')||'网络异常'}</div>`; }
}
function rerunButlerIfAny(){ if(!window.__bazi_ctx__) return; runButlerAI(window.__bazi_ctx__); }

// 芯片追问
document.addEventListener('click',(e)=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  const q=chip.getAttribute('data-q') || chip.textContent;
  const el=$('aiContent'); if(!el) return;
  el.innerHTML += `<br/><br/><b>—</b> ${q}<br/>`;
  const sys=buildButlerSystemPrompt(getLang());
  fetch(API_BASE+'/api/chat',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys+'\n(Continue previous tone. Add concrete steps.)'},{role:'user',content:q}]}) })
    .then(r=>r.json()).then(data=>{
      const txt=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      el.innerHTML += mdToHtml('\n\n'+(txt || ('\n\n'+(t('err_busy')||'服务繁忙'))));
    }).catch(()=>{ el.innerHTML += `<div style="color:#98a7b7">${t('err_network')||'网络异常'}</div>`; });
});

/* ================== 生成命盘（整合 Butler） ================== */
async function genChart(){
  const birth=($('birthdate')?.value||'').trim();
  const timeUnknown=$('timeUnknown')?.checked || false;
  const name=$('name')?.value?.trim() || '';
  const place=$('place')?.value?.trim() || '';
  if(!birth){ showErr('请填写出生日期。'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D]=birth.split('-').map(Number);
    let hour=12;
    if(!timeUnknown){
      const tval=($('birthtime')?.value||'').trim();
      if(tval){ const h=parseInt(tval.split(':')[0],10); if(!Number.isNaN(h)) hour=h; }
    }
    const {pillars, counts, percents, timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    $('result')?.style.setProperty('display','block');
    const timeText=tu ? (t('rpt_time_unknown')||'时间不详') : (hour+'时');
    setText('bazi-date', `出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if(tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('bar-木'), percents.wood); setText('pct-木', Math.round(percents.wood)+'%');
    setBar($('bar-火'), percents.fire); setText('pct-火', Math.round(percents.fire)+'%');
    setBar($('bar-土'), percents.earth); setText('pct-土', Math.round(percents.earth)+'%');
    setBar($('bar-金'), percents.metal); setText('pct-金', Math.round(percents.metal)+'%');
    setBar($('bar-水'), percents.water); setText('pct-水', Math.round(percents.water)+'%');

    const st=judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv=chooseUseful(st.mark, pillars.day.element);

    // “最强/最弱”提示（本地化）
    const E=ELABEL(); const keys=Object.keys(counts);
    const maxK=keys.reduce((a,b)=> counts[a]>counts[b]?a:b), minK=keys.reduce((a,b)=> counts[a]<counts[b]?a:b);
    const char2Locale={木:E.wood,火:E.fire,土:E.earth,金:E.metal,水:E.water};
    setText('bazi-elements-balance', (t('elements_balance_tpl')||'五行中{max}元素最强，{min}元素最弱。').replace('{max}',char2Locale[maxK]).replace('{min}',char2Locale[minK]));

    // 缓存用于语言切换 & 追问
    window.__last_report__={pillars, percents, st, adv, tu};

    mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown:tu});
    mountRichReport({pillars, percents, st, adv, timeUnknown:tu});

    // Butler
    const ctx={ name, place, date:`${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`, time:tu?'—':`${String(hour).padStart(2,'0')}:00`, pillars, percents, st, adv, timeUnknown:tu };
    window.__bazi_ctx__=ctx; await runButlerAI(ctx);
  }catch(err){ console.error(err); showErr('计算八字时出现错误，请重试'); }
  finally{ if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none'; }
}
function rerenderReportsIfAny(){
  const ctx=window.__last_report__; if(!ctx) return;
  const {pillars, percents, st, adv, tu}=ctx;
  mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown:tu});
  mountRichReport({pillars, percents, st, adv, timeUnknown:tu});
}

/* ================== 右下角 Chat 悬浮球（完整） ================== */
function mountChat(){
  if($('ssChatFab')) return;
  const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title=t('butler_chat_title')||'心怜管家 · Chat';
  const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label', t('butler_chat_title')||'心怜管家 · Chat');
  chatPanel.innerHTML = `
    <div class="ss-chat-head"><div class="ss-chat-title">${t('butler_chat_title')||'心怜管家 · Chat'}</div><div class="ss-close" id="ssChatClose">✕</div></div>
    <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')||'请问您想了解什么？'}"/>
      <button id="ssChatSend" class="btn">${t('chat_send')||'发送'}</button>
    </div>`;
  document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
  applyChatI18n();

  const $body=$('ssChatBody'), $input=$('ssChatInput'), $send=$('ssChatSend'), $close=$('ssChatClose');
  const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); };
  const closePanel=()=>{ chatPanel.style.display='none'; };
  chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);

  function addMsg(text, me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
  async function askChat(prompt){
    addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
    const sys=[`You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()]||'Simplified Chinese'}.`,'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'].join('\n');
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:prompt}]}) });
      let data,reply=''; try{ data=await r.json(); }catch{ data={}; }
      reply=data?.reply??data?.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply || t('err_busy') || '服务繁忙');
    }catch(e){ addMsg(`${t('err_network')||'网络异常'} · ${t('err_busy')||'服务繁忙'}`); }
  }
  $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
  $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
}

/* ================== 登录/注册/重置（最小实现） ================== */
function wireAuth(){
  const loginForm=$('loginForm'), registerForm=$('registerForm'), resetBtn=$('resetBtn');
  const emailEl=$('email'), pwdEl=$('password');

  loginForm?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=emailEl?.value.trim(), pwd=pwdEl?.value||'';
    if(!email) return showAuthErr(t('err_email_empty')||'邮箱不能为空');
    if(!pwd) return showAuthErr(t('err_pwd_empty')||'密码不能为空');
    lock(loginForm,true);
    try{
      const r=await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){
        localStorage.setItem('vipEmail', email);
        if(data?.vip==='active' || data?.status==='active') localStorage.setItem('vipStatus','active');
        showAuthErr('✅ 登录成功'); setTimeout(()=>hideAuthErr(),2000);
      }else{
        showAuthErr((t('err_login_fail')||'登入失败：')+(data?.message||r.status));
      }
    }catch(err){ showAuthErr(t('err_network')||'网络异常'); }
    finally{ lock(loginForm,false); }
  });

  registerForm?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=emailEl?.value.trim(), pwd=pwdEl?.value||'';
    if(!email||!pwd) return showAuthErr(t('err_need_ep')||'请输入邮箱与密码');
    if(!strongPwd(pwd)) return showAuthErr(t('err_pwd_rule')||'密码不合规');
    lock(registerForm,true);
    try{
      const r=await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){
        localStorage.setItem('vipEmail', email);
        if(data?.vip==='active' || data?.status==='active') localStorage.setItem('vipStatus','active');
        showAuthErr('✅ 注册成功'); setTimeout(()=>hideAuthErr(),2000);
      }else{
        showAuthErr((t('err_register_fail')||'注册失败：')+(data?.message||r.status));
      }
    }catch(err){ showAuthErr(t('err_network')||'网络异常'); }
    finally{ lock(registerForm,false); }
  });

  resetBtn?.addEventListener('click', async ()=>{
    hideAuthErr();
    const email = prompt(t('prompt_email')||'请输入注册邮箱：'); if(!email) return;
    const pwd = prompt(t('prompt_newpwd')||'请输入新密码：'); if(!pwd) return;
    if(!strongPwd(pwd)) return showAuthErr(t('err_pwd_rule')||'密码不合规');
    lock(resetBtn,true);
    try{
      const r=await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){ alert(t('msg_reset_ok')||'已更新密码'); }
      else{ showAuthErr((t('err_reset_fail')||'重设失败：')+(data?.message||r.status)); }
    }catch(err){ showAuthErr(t('err_network')||'网络异常'); }
    finally{ lock(resetBtn,false); }
  });
}

/* ============== DOM Ready ============== */
document.addEventListener('DOMContentLoaded', ()=>{
  if($('birthdate') && !$('birthdate').value){ $('birthdate').value = new Date().toISOString().split('T')[0]; }
  initLangUI();
  $('genBtn')?.addEventListener('click', genChart);
  mountChat();
  wireAuth();
});

})(); 
</script>
</body>
</html>
  
