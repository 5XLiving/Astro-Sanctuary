<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>八字命理 · 专业排盘</title>
    <style>
        /* 现有CSS保持不变，只添加新样式 */
        
        /* 心怜管家专业窗口 */
        .butler-professional {
            display: none;
            margin-top: 20px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
        }
        
        .butler-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--gold2);
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .butler-content {
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            background: #0f1624;
            border-radius: 10px;
            border: 1px solid #253245;
        }
        
        .butler-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #253245;
        }
        
        .butler-section h4 {
            color: var(--gold2);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        /* 对话界面 */
        .butler-chat {
            margin-top: 20px;
            border-top: 1px solid var(--line);
            padding-top: 15px;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #0f1624;
            border-radius: 8px;
            border: 1px solid #253245;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #253245;
            background: #0e1520;
            color: var(--text);
        }
        
        .chat-send-btn {
            padding: 10px 20px;
            background: var(--gold);
            color: #191919;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 1. 现有排盘表单保持不变 -->
    <section class="card">
        <div class="h2">八字命理 · 快速排盘</div>
        <div class="row cols-3">
            <div>
                <label class="muted">姓名（可选）</label>
                <input id="name" placeholder="你的称呼（用于个性化）" />
            </div>
            <div>
                <label class="muted">性别</label>
                <select id="gender">
                    <option value="">不透露</option>
                    <option value="male">男性</option>
                    <option value="female">女性</option>
                </select>
            </div>
            <div>
                <label class="muted">历法</label>
                <select id="calendar">
                    <option value="gregorian">阳历</option>
                    <option value="lunar">农历</option>
                </select>
            </div>
        </div>
        <div class="row cols-3" style="margin-top:10px">
            <div>
                <label class="muted">出生日期</label>
                <input type="date" id="birthdate" />
            </div>
            <div>
                <label class="muted">出生时间</label>
                <div class="time-row">
                    <input type="time" id="birthtime" />
                    <label class="muted time-unknown">
                        <input type="checkbox" id="timeUnknown" />
                        <span>出生时间不详</span>
                    </label>
                </div>
            </div>
            <div class="gen-wrap">
                <button class="btn" id="genBtn" type="button">
                    <span id="genBtnText">生成八字</span>
                    <span id="genBtnLoading" style="display:none">计算中...</span>
                </button>
            </div>
        </div>
    </section>

    <!-- 2. 心怜管家专业窗口 -->
    <section id="butlerProfessional" class="butler-professional">
        <div class="butler-header">
            <span>🧙‍♂️ 心怜管家 · 专业命理分析</span>
        </div>
        
        <div class="butler-content" id="professionalReport">
            <!-- AI生成的专业报告将渲染在这里 -->
        </div>
        
        <div class="butler-chat">
            <div class="chat-messages" id="chatMessages">
                <div class="ss-msg">您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="请输入您的问题...">
                <button class="chat-send-btn" id="chatSend">发送</button>
            </div>
        </div>
    </section>

    <!-- 3. VIP区域保持不变 -->
    <section class="card section vip-section">
        <!-- 现有VIP代码 -->
    </section>

    <script>
        // 八字计算核心代码保持不变
        
        // 专业报告生成函数
        async function generateProfessionalReport(baziData) {
            const prompt = `
            作为40年经验的资深命理师，请为以下八字生成专业级分析报告：
            
            八字：${baziData.pillars.year.stem}${baziData.pillars.year.branch} 
                  ${baziData.pillars.month.stem}${baziData.pillars.month.branch}
                  ${baziData.pillars.day.stem}${baziData.pillars.day.branch} 
                  ${baziData.pillars.hour.stem}${baziData.pillars.hour.branch}
            
            性别：${baziData.gender || '未透露'}
            五行分布：木${baziData.counts.木}% 火${baziData.counts.火}% 土${baziData.counts.土}% 金${baziData.counts.金}% 水${baziData.counts.水}%
            
            请用专业命理术语生成完整报告，包含：
            
            🔮 一、格局层次
            - 识别所有适用格局（建禄格、木火通明等20+种格局）
            - 格局等级评定
            - 特殊格局说明
            
            ⚔️ 二、十神配置分析
            - 每个十神的实际影响
            - 十神组合分析
            - 十神对性格的影响
            
            💎 三、用神喜忌
            - 精确用神判断
            - 大运流年喜忌
            - 调候用神分析
            
            🎯 四、事业发展
            - 具体行业建议
            - 职业发展路径
            - 适合的岗位类型
            
            💰 五、财运分析  
            - 财运特点
            - 投资建议
            - 财富积累时机
            
            🔮 六、玄学缘分
            - 灵性特质
            - 适合的修行方向
            - 命理学习潜力
            
            📅 七、流年详批（未来3年）
            - 每年运势重点
            - 关键时间节点
            - 注意事项
            
            格式要求：专业深度，具体建议，避免泛泛而谈。
            `;

            // 调用AI生成报告
            const report = await callAIForProfessionalReport(prompt);
            return report;
        }

        // 显示专业报告
        async function showProfessionalReport(baziData) {
            const butlerSection = document.getElementById('butlerProfessional');
            const reportContainer = document.getElementById('professionalReport');
            
            // 显示加载状态
            reportContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="skeleton">
                        <div style="width: 80%"></div>
                        <div style="width: 60%"></div>
                        <div style="width: 70%"></div>
                    </div>
                    <div style="color: var(--muted); margin-top: 10px;">正在生成专业分析报告...</div>
                </div>
            `;
            
            butlerSection.style.display = 'block';
            
            try {
                const report = await generateProfessionalReport(baziData);
                reportContainer.innerHTML = report;
                
                // 滚动到报告区域
                butlerSection.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                reportContainer.innerHTML = `
                    <div style="color: #ff6b6b; text-align: center;">
                        报告生成失败，请重试
                    </div>
                `;
            }
        }

        // 修改现有的生成八字函数
        async function generateBaziChart() {
            // 现有八字计算逻辑...
            
            // 计算完成后显示专业报告
            const baziData = {
                pillars: pillars,
                counts: counts, 
                gender: document.getElementById('gender').value,
                // 其他必要数据
            };
            
            await showProfessionalReport(baziData);
        }

        // 初始化聊天功能
        function initButlerChat() {
            const chatSend = document.getElementById('chatSend');
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            
            chatSend.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // 添加用户消息
                const userMsg = document.createElement('div');
                userMsg.className = 'ss-msg me';
                userMsg.textContent = message;
                chatMessages.appendChild(userMsg);
                
                chatInput.value = '';
                
                // 模拟AI回复
                setTimeout(() => {
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'ss-msg';
                    aiMsg.textContent = '这是一个很好的问题，让我结合您的命盘为您详细分析...';
                    chatMessages.appendChild(aiMsg);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000);
            }
        }

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 现有初始化代码...
            initButlerChat();
        });
    </script>
</body>
</html>
