
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* —— 统一头部 —— */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + "不详"同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏"估时间"按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* —— 心怜管家样式 —— */
    .butler-section { margin-top: 20px; }
    .butler-card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 18px; margin: 16px 0; }
    .butler-title { font-size: 1.2rem; margin: 0 0 12px; font-weight: 800; color: var(--gold2); display: flex; gap: 8px; align-items: center; }
    .butler-title::before { content: ""; width: 4px; height: 18px; background: var(--brand); border-radius: 2px; }
    .butler-content { line-height: 1.7; white-space: pre-wrap; }
    .butler-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .butler-chip { padding: 6px 12px; border-radius: 999px; border: 1px solid #2a3546; background: #0e1520; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .butler-chip:hover { border-color: var(--gold2); background: rgba(212,175,55,0.1); }
    .butler-skeleton { display: grid; gap: 8px; }
    .butler-skeleton div { height: 12px; border-radius: 6px; background: linear-gradient(90deg, #1a2431, #1f2b3b, #1a2431); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { opacity: .5; } 50% { opacity: 1; } 100% { opacity: .5; } }
    .butler-lock { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--line); text-align: center; }
    .butler-lock .tip { color: #ffd88a; font-weight: 700; margin-bottom: 4px; }
    .butler-lock .sub { color: var(--muted); }

    /* 成长跟踪器样式 */
    .growth-tracker {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 20px;
    }

    .tracker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .progress-ring {
      position: relative;
      text-align: center;
    }

    .progress-ring span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--gold);
    }

    .mission-list {
      display: grid;
      gap: 10px;
    }

    .mission-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    .mission-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .energy-insight {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    /* 喜用神分析样式 */
    .useful-elements {
      display: grid;
      gap: 8px;
      margin-top: 12px;
    }

    .useful-elements div {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border-left: 3px solid var(--gold);
    }

    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:140px}
    }

    .btn-gold.block {
  box-sizing: border-box;
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.auth-grid .panel .body .row.one {
  width: 100%;
}

.btn.block {
  width: 100%;
  box-sizing: border-box;
}
    
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
    <section class="card">
      <div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="label_name">姓名（可选）</label>
          <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
        </div>
        <div>
          <label class="muted" data-i18n="gender_label">性别</label>
          <select id="gender">
            <option value="" data-i18n="opt_gender_confidential">不透露</option>
            <option value="male" data-i18n="opt_gender_male">男性</option>
            <option value="female" data-i18n="opt_gender_female">女性</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="label_calendar">历法</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
            <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="label_birthdate">出生日期</label>
          <input type="date" id="birthdate" />
        </div>

        <div>
          <label class="muted" data-i18n="label_birthtime">出生时间</label>
          <div class="time-row">
            <input type="time" id="birthtime" value="12:00" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="cb_time_unknown">出生时间不详</span>
            </label>
          </div>
        </div>

        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
            <span id="genBtnLoading" style="display:none">计算中...</span>
          </button>
        </div>

        <div id="error" class="error-message"></div>
      </div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 心怜管家 AI 解读区域 - 调整到五行能量分析之前 -->
      <div class="butler-section">
        <div class="butler-card">
          <div class="butler-title">🧠 心怜管家 · 命理解读</div>
          <div id="butler-content" class="butler-content">
            <div class="butler-skeleton">
              <div style="width:60%"></div>
              <div style="width:80%"></div>
              <div style="width:90%"></div>
              <div style="width:70%"></div>
              <div style="width:50%"></div>
            </div>
          </div>
          <div class="butler-chips">
            <button class="butler-chip" data-question="career">💼 事业方向</button>
            <button class="butler-chip" data-question="love">❤️ 感情婚姻</button>
            <button class="butler-chip" data-question="wealth">💰 财运分析</button>
            <button class="butler-chip" data-question="health">🌿 健康养生</button>
            <button class="butler-chip" data-question="personality">🌟 性格特质</button>
          </div>
        </div>
      </div>

<!-- 喜用神分析部分 - 修改为动态显示 -->
<div class="card" id="useful-elements-section" style="display:none;">
  <div class="h2">🎯 喜用神分析</div>
  
  <!-- 五行能量条 - 动态更新 -->
  <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-wood-dynamic"></i></div><span id="pct-wood-dynamic">0%</span></div>
  <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-fire-dynamic"></i></div><span id="pct-fire-dynamic">0%</span></div>
  <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-earth-dynamic"></i></div><span id="pct-earth-dynamic">0%</span></div>
  <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-metal-dynamic"></i></div><span id="pct-metal-dynamic">0%</span></div>
  <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-water-dynamic"></i></div><span id="pct-water-dynamic">0%</span></div>
  
  <div id="bazi-elements-balance-dynamic" class="muted" style="margin-top:8px" data-i18n="element_balance_desc">
    五行中火元素最强，金元素最弱。
  </div>

  <!-- 分析建议部分 - 动态更新 -->
  <div class="analysis-details" style="margin-top:16px;padding-top:16px;border-top:1px solid #eee;">
    <div class="analysis-row">
      <strong data-i18n="strategy_label">发展策略：</strong>
      <span id="strategy-value-dynamic">生扶补助</span>
    </div>
    <div class="analysis-row">
      <strong data-i18n="favorable_elements">喜用元素：</strong>
      <span id="favorable-value-dynamic">木、水</span>
    </div>
    <div class="analysis-row">
      <strong data-i18n="avoid_elements">忌避元素：</strong>
      <span id="avoid-value-dynamic">火、土、金</span>
    </div>
    <div class="analysis-row">
      <strong data-i18n="adjustment_key">调候要点：</strong>
      <span id="adjustment-value-dynamic">平衡为要</span>
    </div>
    <div class="analysis-row">
      <strong data-i18n="specific_suggestions">具体建议：</strong>
      <span id="suggestions-value-dynamic">需要生扶补助，增强自身能量</span>
    </div>
  </div>
</div>

      <!-- 成长跟踪器 -->
      <div class="growth-tracker" id="growthTracker" style="display:none;">
        <div class="tracker-header">
          <h3>🌱 您的成长旅程</h3>
          <div class="progress-ring">
            <svg width="60" height="60">
              <circle cx="30" cy="30" r="25" stroke="#2a3546" stroke-width="4" fill="none"/>
              <circle cx="30" cy="30" r="25" stroke="#d4af37" stroke-width="4" fill="none" 
                      stroke-dasharray="157" stroke-dashoffset="78.5" stroke-linecap="round"/>
            </svg>
            <span>50%</span>
          </div>
        </div>
        
        <div class="weekly-mission">
          <h4>📋 本周能量练习</h4>
          <div class="mission-list">
            <div class="mission-item">
              <input type="checkbox" id="mission1">
              <label for="mission1">晨间5分钟感恩冥想</label>
            </div>
            <div class="mission-item">
              <input type="checkbox" id="mission2">
              <label for="mission2">对3个人表达感谢</label>
            </div>
            <div class="mission-item">
              <input type="checkbox" id="mission3">
              <label for="mission3">完成一次创意输出</label>
            </div>
          </div>
        </div>
        
        <div class="energy-insight">
          <h4>💫 今日能量提醒</h4>
          <p id="dailyEnergyTip">根据您的命盘，今天适合：创意工作、与人合作、学习新技能</p>
        </div>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
<!-- 左侧：输入 + 注册/登录 -->
<div class="panel">
  <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
  <div class="body">
    <div class="row" id="authFields">
      <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
      <input
        id="email"
        name="email"
        type="email"
        inputmode="email"
        placeholder="请输入邮箱地址"
        data-i18n-ph="ph_email"
        required
      />
      <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
      <input
        id="password"
        name="password"
        type="password"
        placeholder="请输入密码"
        data-i18n-ph="ph_password"
        required
      />
    </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点"填入时间"，会用该时段的中位时间写到上方时间输入框，并自动取消"时间不详"。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

<script>  
// ================== 多语言系统 ==================
const translations = {
  "zh-CN": {
    // 通用
    "lang_label": "语言",
    "title_bazi_brief": "八字简评",
    "title_quickcalc": "八字命理 · 快速排盘",
    
    // 表单标签
    "label_name": "姓名（可选）",
    "ph_name": "你的称呼（用于个性化）",
    "gender_label": "性别",
    "label_calendar": "历法",
    "label_birthdate": "出生日期",
    "label_birthtime": "出生时间",
    "cb_time_unknown": "出生时间不详",
    "btn_generate_chart": "生成八字",
    
    // 性别选项
    "opt_gender_confidential": "不透露",
    "opt_gender_male": "男性",
    "opt_gender_female": "女性",
    
    // 历法选项
    "opt_cal_gregorian": "阳历",
    "opt_cal_lunar": "农历",
    
    // 错误信息
    "err_birthdate_required": "请填写出生日期",
    "err_calculation_failed": "计算八字时出现错误，请重试",
    
    // 五行标签
    "el_wood": "木",
    "el_fire": "火",
    "el_earth": "土",
    "el_metal": "金",
    "el_water": "水",
    
    // 心怜管家
    "butler_title": "心怜管家 · 命理解读",
    "butler_loading": "正在分析您的命盘...",
    "butler_chip_career": "💼 事业方向",
    "butler_chip_love": "❤️ 感情婚姻",
    "butler_chip_wealth": "💰 财运分析",
    "butler_chip_health": "🌿 健康养生",
    "butler_chip_personality": "🌟 性格特质",
    
    // 分析内容
    "analysis_strength_strong": "偏强",
    "analysis_strength_weak": "偏弱",
    "analysis_strength_balanced": "平衡",
    "analysis_strategy_drain": "泄秀/制化",
    "analysis_strategy_support": "补助/顺势",
    "analysis_strategy_balance": "守中/调和",

    "rpt_sec_elements_title": "五行能量分析",
    "vip_title": "🌙 会员区域 VIP Segment",
    "vip_mingli": "🗝 命理空间专属内容", 
    "vip_love": "姻缘方向：恋爱缘分、婚姻走势",
    "vip_career": "事业方向：职场发展、创业潜力",
    "vip_wealth": "财运方向：财位分析、理财时机",
    "vip_pet": "宠物命理：伴侣动物的性格与缘分",
    "vip_hepan": "合盘分析：婚期择日、新生择时",
    "vip_name": "测名分析：公司名、宝宝名、命名改运",
    "vip_fengshui": "财位合盘：住家 / 办公室动线配合",
    "vip_xinlian": "🌙 心怜空间专属内容",
    "vip_record": "灵性记录：照片、梦境、声音、愿望祈祷",
    "vip_course": "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    "vip_memorial": "家族纪念系统：亲人灵性纪念 & 延续",
    "vip_tasks": "每周能量练习 / 神明仪式任务",
    "vip_shop": "能量商城专属折扣 & 御守订制",

    "butler_overview_title": "心怜管家 · 快速总览",
    "ov_summary": "概览",
    "ov_elements": "五行画像",
    "ov_strategy": "策略",
    "ov_focus": "重点方向",
    "ov_actions": "本周三步行动",
    "growth_journey": "您的成长旅程",
    "weekly_energy_practice": "本周能量练习",
    "mission1": "晨间5分钟感恩冥想",
    "mission2": "对3个人表达感谢", 
    "mission3": "完成一次创意输出",
    "daily_energy_tip": "今日能量提醒",
    "energy_tip_content": "根据您的命盘，今天适合：学习充电、静心养性、建立习惯",

    // 登录相关
    "login_title": "💎 登入 VIP 功能",
    "panel_login_head": "账户登录 / 注册",
    "ph_email": "邮箱 Email",
    "ph_label_password": "密码 Password",
    "btn_login": "登入账户",
    "btn_reset": "🔑 重设密码",
    "btn_register": "注册账户",
    "note_price": "注册账号赠送一次免费体验",
    "panel_member_head": "会员服务",
    "btn_upgrade": "💎 升级为 VIP（月费）",
    "btn_backshop": "← 返回命理商城",
    "note_price1": "$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
    "ph_email": "请输入邮箱地址",
    "ph_password": "请输入密码",

    'el_wood': '木',
    'el_fire': '火', 
    'el_earth': '土',
    'el_metal': '金',
    'el_water': '水',
    'element_balance_desc': '五行中火元素最强，金元素最弱。',
    'strategy_label': '发展策略：',
    'strategy_value': '生扶补助',
    'favorable_elements': '喜用元素：',
    'favorable_value': '木、水',
    'avoid_elements': '忌避元素：',
    'avoid_value': '火、土、金',
    'adjustment_key': '调候要点：',
    'adjustment_value': '平衡为要',
    'specific_suggestions': '具体建议：',
    'suggestions_value': '需要生扶补助，增强自身能量'
  },
  "en": {
    // General
    "lang_label": "Language",
    "title_bazi_brief": "Bazi Brief Reading",
    "title_quickcalc": "Bazi Destiny · Quick Chart",
    
    // Form labels
    "label_name": "Name (optional)",
    "ph_name": "Your name (for personalization)",
    "gender_label": "Gender",
    "label_calendar": "Calendar",
    "label_birthdate": "Birth Date",
    "label_birthtime": "Birth Time",
    "cb_time_unknown": "Birth time unknown",
    "btn_generate_chart": "Generate Chart",
    
    // Gender options
    "opt_gender_confidential": "Confidential",
    "opt_gender_male": "Male",
    "opt_gender_female": "Female",
    
    // Calendar options
    "opt_cal_gregorian": "Gregorian",
    "opt_cal_lunar": "Lunar",
    
    // Error messages
    "err_birthdate_required": "Please enter birth date",
    "err_calculation_failed": "Error calculating Bazi, please try again",
    
    // Element labels
    "el_wood": "Wood",
    "el_fire": "Fire",
    "el_earth": "Earth",
    "el_metal": "Metal",
    "el_water": "Water",
    
    // Butler
    "butler_title": "Butler · Destiny Analysis",
    "butler_loading": "Analyzing your destiny chart...",
    "butler_chip_career": "💼 Career Direction",
    "butler_chip_love": "❤️ Love & Marriage",
    "butler_chip_wealth": "💰 Wealth Analysis",
    "butler_chip_health": "🌿 Health & Wellness",
    "butler_chip_personality": "🌟 Personality Traits",
    
    // Analysis content
    "analysis_strength_strong": "Strong",
    "analysis_strength_weak": "Weak",
    "analysis_strength_balanced": "Balanced",
    "analysis_strategy_drain": "Drain/Control",
    "analysis_strategy_support": "Support/Nourish",
    "analysis_strategy_balance": "Balance/Harmony",

    "rpt_sec_elements_title": "Five Elements Analysis",
    "vip_title": "🌙 VIP Member Area", 
    "vip_mingli": "🗝 Destiny Space Exclusive",
    "vip_love": "Love Direction: Relationships & Marriage Trends",
    "vip_career": "Career Path: Workplace & Entrepreneurship",
    "vip_wealth": "Wealth Analysis: Money Flow & Investment Timing",
    "vip_pet": "Pet Destiny: Companion Animal Compatibility",
    "vip_hepan": "Compatibility: Wedding Dates & Birth Timing",
    "vip_name": "Name Analysis: Business & Baby Names",
    "vip_fengshui": "Wealth Positions: Home/Office Layout",
    "vip_xinlian": "🌙 XinLian Space Exclusive",
    "vip_record": "Spiritual Records: Photos, Dreams, Prayers",
    "vip_course": "Courses: Bazi, Tarot, Astrology, Numerology",
    "vip_memorial": "Family Memorial System",
    "vip_tasks": "Weekly Energy Practices & Rituals",
    "vip_shop": "Energy Shop Discounts & Talismans",

    "butler_overview_title": "Butler · Quick Overview",
    "ov_summary": "Summary",
    "ov_elements": "Element Profile",
    "ov_strategy": "Strategy",
    "ov_focus": "Focus Areas",
    "ov_actions": "3 Actions This Week",
    "growth_journey": "Your Growth Journey",
    "weekly_energy_practice": "Weekly Energy Practice",
    "mission1": "5-minute morning gratitude meditation",
    "mission2": "Express gratitude to 3 people",
    "mission3": "Complete one creative output",
    "daily_energy_tip": "Today's Energy Reminder",
    "energy_tip_content": "According to your destiny chart, today is suitable for: learning, meditation, building habits",
    
    // Login related
    "login_title": "💎 Login to VIP Features",
    "panel_login_head": "Account Login / Register",
    "ph_email": "Email Address",
    "ph_label_password": "Password",
    "btn_login": "Login",
    "btn_reset": "🔑 Reset Password",
    "btn_register": "Register Account",
    "note_price": "Free trial with registration",
    "panel_member_head": "Member Services",
    "btn_upgrade": "💎 Upgrade to VIP (Monthly)",
    "btn_backshop": "← Back to Astro Shop",
    "note_price1": "$9.9 / Month VIP (Destiny + XinLian + Spiritual Courses)",
    "ph_email": "Please enter email address",
    "ph_password": "Please enter password",
    
    'el_wood': 'Wood',
    'el_fire': 'Fire', 
    'el_earth': 'Earth',
    'el_metal': 'Metal',
    'el_water': 'Water',
    'element_balance_desc': 'Fire element is strongest, Metal element is weakest.',
    'strategy_label': 'Development Strategy:',
    'strategy_value': 'Nourish and Support',
    'favorable_elements': 'Favorable Elements:',
    'favorable_value': 'Wood, Water',
    'avoid_elements': 'Avoid Elements:',
    'avoid_value': 'Fire, Earth, Metal',
    'adjustment_key': 'Adjustment Focus:',
    'adjustment_value': 'Balance is Key',
    'specific_suggestions': 'Specific Suggestions:',
    'suggestions_value': 'Need nourishment and support to enhance personal energy'
  },
  "ja": {
    // 一般
    "lang_label": "言語",
    "title_bazi_brief": "八字簡評",
    "title_quickcalc": "八字命理 · クイックチャート",
    
    // フォームラベル
    "label_name": "名前（任意）",
    "ph_name": "あなたの名前（個人用）",
    "gender_label": "性別",
    "label_calendar": "暦法",
    "label_birthdate": "生年月日",
    "label_birthtime": "出生時間",
    "cb_time_unknown": "出生時間不明",
    "btn_generate_chart": "八字を生成",
    
    // 性別オプション
    "opt_gender_confidential": "非公開",
    "opt_gender_male": "男性",
    "opt_gender_female": "女性",
    
    // 暦法オプション
    "opt_cal_gregorian": "太陽暦",
    "opt_cal_lunar": "旧暦",
    
    // エラーメッセージ
    "err_birthdate_required": "生年月日を入力してください",
    "err_calculation_failed": "八字計算中にエラーが発生しました",
    
    // 五行ラベル
    "el_wood": "木",
    "el_fire": "火",
    "el_earth": "土",
    "el_metal": "金",
    "el_water": "水",
    
    // バトラー
    "butler_title": "バトラー · 命理分析",
    "butler_loading": "命盤を分析中...",
    "butler_chip_career": "💼 キャリア方向",
    "butler_chip_love": "❤️ 恋愛結婚",
    "butler_chip_wealth": "💰 財運分析",
    "butler_chip_health": "🌿 健康養生",
    "butler_chip_personality": "🌟 性格特質",
    
    // 分析内容
    "analysis_strength_strong": "強め",
    "analysis_strength_weak": "弱め",
    "analysis_strength_balanced": "バランス",
    "analysis_strategy_drain": "泄秀/制化",
    "analysis_strategy_support": "補助/順勢",
    "analysis_strategy_balance": "守中/調和",

    // VIPセクション
    "rpt_sec_elements_title": "五行エネルギー分析",
    "vip_title": "🌙 会員エリア VIPセグメント",
    "vip_mingli": "🗝 命理スペース限定コンテンツ",
    "vip_love": "縁談方向：恋愛縁、結婚運",
    "vip_career": "キャリア方向：職場発展、起業可能性",
    "vip_wealth": "財運方向：財位分析、投資時期",
    "vip_pet": "ペット命理：伴侶動物の性格と縁",
    "vip_hepan": "相性分析：結婚日選び、出産時期",
    "vip_name": "名前分析：会社名、赤ちゃん名、命名",
    "vip_fengshui": "財位相性：自宅/オフィスの動線",
    "vip_xinlian": "🌙 心怜スペース限定",
    "vip_record": "スピリチュアル記録：写真、夢、音声、祈願",
    "vip_course": "命理コース：八字/タロット/占星術/数秘術/ヒューマンデザイン",
    "vip_memorial": "家族記念システム：先祖供養＆継承",
    "vip_tasks": "週間エネルギー練習/神事儀式",
    "vip_shop": "エネルギーショップ割引＆お守り定制",

    "butler_overview_title": "バトラー · 概要",
    "ov_summary": "概要",
    "ov_elements": "五行プロファイル",
    "ov_strategy": "戦略",
    "ov_focus": "重点分野",
    "ov_actions": "今週の3アクション",
    "growth_journey": "あなたの成長旅路",
    "weekly_energy_practice": "今週のエネルギー練習",
    "mission1": "朝5分間の感謝瞑想",
    "mission2": "3人に感謝を伝える",
    "mission3": "クリエイティブなアウトプットを1つ完了",
    "daily_energy_tip": "今日のエネルギーリマインダー",
    "energy_tip_content": "あなたの命盤によると、今日は以下のことに適しています：学習、静心、習慣作り",

    // ログイン関連
  "login_title": "💎 VIP機能にログイン",
  "panel_login_head": "アカウントログイン / 登録",
  "ph_email": "メールアドレス",
  "ph_label_password": "パスワード",
  "btn_login": "ログイン",
  "btn_reset": "🔑 パスワードリセット",
  "btn_register": "アカウント登録",
  "note_price": "登録で無料体験",
  "panel_member_head": "会員サービス",
  "btn_upgrade": "💎 VIPにアップグレード（月額）",
  "btn_backshop": "← 占いショップに戻る",
  "note_price1": "$9.9 / 月額VIP（命理+心怜+スピリチュアルコース）",
  "ph_email": "メールアドレスを入力してください",  // 添加这行
  "ph_password": "パスワードを入力してください",  // 添加这行

    'el_wood': '木',
    'el_fire': '火', 
    'el_earth': '土',
    'el_metal': '金',
    'el_water': '水',
    'element_balance_desc': '五行の中で火の気が最も強く、金の気が最も弱いです。',
    'strategy_label': '開運戦略：',
    'strategy_value': '補い育てる',
    'favorable_elements': '喜神・用神：',
    'favorable_value': '木、水',
    'avoid_elements': '忌神・仇神：',
    'avoid_value': '火、土、金',
    'adjustment_key': '調整の要点：',
    'adjustment_value': 'バランス重視',
    'specific_suggestions': '具体的なアドバイス：',
    'suggestions_value': '補い育てることで自身のエネルギーを高める必要があります'
  },
  "th": {
    // ทั่วไป
    "lang_label": "ภาษา",
    "title_bazi_brief": "การวิเคราะห์ปาจื้อแบบย่อ",
    "title_quickcalc": "โหราศาสตร์ปาจื้อ · การสร้างแผนภูมิด่วน",
    
    // ป้ายแบบฟอร์ม
    "label_name": "ชื่อ (ไม่จำเป็น)",
    "ph_name": "ชื่อของคุณ (สำหรับการปรับแต่ง)",
    "gender_label": "เพศ",
    "label_calendar": "ปฏิทิน",
    "label_birthdate": "วันเกิด",
    "label_birthtime": "เวลาเกิด",
    "cb_time_unknown": "ไม่ทราบเวลาเกิด",
    "btn_generate_chart": "สร้างปาจื้อ",
    
    // ตัวเลือกเพศ
    "opt_gender_confidential": "ไม่เปิดเผย",
    "opt_gender_male": "ชาย",
    "opt_gender_female": "หญิง",
    
    // ตัวเลือกปฏิทิน
    "opt_cal_gregorian": "สากล",
    "opt_cal_lunar": "จันทรคติ",
    
    // ข้อความผิดพลาด
    "err_birthdate_required": "กรุณากรอกวันเกิด",
    "err_calculation_failed": "เกิดข้อผิดพลาดในการคำนวณปาจื้อ",
    
    // ป้ายธาตุทั้งห้า
    "el_wood": "ไม้",
    "el_fire": "ไฟ",
    "el_earth": "ดิน",
    "el_metal": "ทอง",
    "el_water": "น้ำ",
    
    // บัตเลอร์
    "butler_title": "บัตเลอร์ · การวิเคราะห์โชคชะตา",
    "butler_loading": "กำลังวิเคราะห์แผนภูมิชะตา...",
    "butler_chip_career": "💼 ทิศทางอาชีพ",
    "butler_chip_love": "❤️ ความรักและการแต่งงาน",
    "butler_chip_wealth": "💰 การวิเคราะห์โชคลาภ",
    "butler_chip_health": "🌿 สุขภาพและการดูแล",
    "butler_chip_personality": "🌟 ลักษณะบุคลิกภาพ",
    
    // เนื้อหาการวิเคราะห์
    "analysis_strength_strong": "แข็งแรง",
    "analysis_strength_weak": "อ่อนแอ",
    "analysis_strength_balanced": "สมดุล",
    "analysis_strategy_drain": "ระบาย/ควบคุม",
    "analysis_strategy_support": "สนับสนุน/หล่อเลี้ยง",
    "analysis_strategy_balance": "สมดุล/ประสาน",

    // ส่วน VIP
    "rpt_sec_elements_title": "การวิเคราะห์ธาตุทั้งห้า",
    "vip_title": "🌙 พื้นที่สมาชิก VIP",
    "vip_mingli": "🗝 เนื้อหาเฉพาะพื้นที่โหราศาสตร์",
    "vip_love": "ทิศทางความรัก: โอกาสพบรัก, แนวโน้มการแต่งงาน",
    "vip_career": "ทิศทางอาชีพ: การพัฒนางาน, ศักยภาพธุรกิจ",
    "vip_wealth": "ทิศทางโชคลาภ: การวิเคราะห์ตำแหน่งเงิน, จังหวะการลงทุน",
    "vip_pet": "โหราศาสตร์สัตว์เลี้ยง: บุคลิกและความสัมพันธ์",
    "vip_hepan": "การวิเคราะห์ความเข้ากัน: ฤกษ์แต่งงาน, เวลาเกิด",
    "vip_name": "การวิเคราะห์ชื่อ: ชื่อบริษัท, ชื่อเด็ก, การตั้งชื่อ",
    "vip_fengshui": "ความเข้ากันของตำแหน่งเงิน: บ้าน/ที่ทำงาน",
    "vip_xinlian": "🌙 เนื้อหาเฉพาะพื้นที่ซินเหลียน",
    "vip_record": "บันทึกทางจิตวิญญาณ: รูปภาพ, ความฝัน, เสียง, การอธิษฐาน",
    "vip_course": "คอร์สโหราศาสตร์: ปาจื้อ/ทาโรต์/โหราศาสตร์/ตัวเลข/Human Design",
    "vip_memorial": "ระบบอนุสรณ์ครอบครัว: การรำลึกและสืบสาน",
    "vip_tasks": "แบบฝึกหัดพลังงานรายสัปดาห์/พิธีกรรม",
    "vip_shop": "ส่วนลดร้านพลังงาน & การสั่งทำเครื่องราง",

    "butler_overview_title": "บัตเลอร์ · ภาพรวม",
    "ov_summary": "สรุป",
    "ov_elements": "โปรไฟล์ธาตุ",
    "ov_strategy": "กลยุทธ์",
    "ov_focus": "พื้นที่โฟกัส",
    "ov_actions": "3 การดำเนินการสัปดาห์นี้",
    "growth_journey": "การเดินทางเติบโตของคุณ",
    "weekly_energy_practice": "แบบฝึกหัดพลังงานสัปดาห์นี้",
    "mission1": "นั่งสมาธิขอบคุณ 5 นาทีตอนเช้า",
    "mission2": "แสดงความขอบคุณต่อ 3 คน",
    "mission3": "ทำงานสร้างสรรค์ให้เสร็จ 1 ชิ้น",
    "daily_energy_tip": "คำเตือนพลังงานวันนี้",
    "energy_tip_content": "ตามแผนภูมิชะตาของคุณ วันนี้เหมาะสำหรับ: การเรียนรู้, การทำสมาธิ, การสร้างนิสัย",
    
    // ログイン関連
    "login_title": "💎 เข้าสู่ระบบคุณสมบัติ VIP",
    "panel_login_head": "เข้าสู่ระบบ / ลงทะเบียน",
    "ph_email": "อีเมล",
    "ph_label_password": "รหัสผ่าน",
    "btn_login": "เข้าสู่ระบบ",
    "btn_reset": "🔑 รีเซ็ตรหัสผ่าน",
    "btn_register": "ลงทะเบียนบัญชี",
    "note_price": "ทดลองใช้ฟรีเมื่อลงทะเบียน",
    "panel_member_head": "บริการสมาชิก",
    "btn_upgrade": "💎 อัปเกรดเป็น VIP (รายเดือน)",
    "btn_backshop": "← กลับสู่ร้านโหราศาสตร์",
    "note_price1": "$9.9 / เดือน VIP (พื้นที่โหราศาสตร์ + ซินเหลียน + คอร์สจิตวิญญาณ)",
    "ph_email": "กรุณากรอกอีเมล",
    "ph_password": "กรุณากรอกรหัสผ่าน",
  
    'el_wood': 'ไม้',
    'el_fire': 'ไฟ', 
    'el_earth': 'ดิน',
    'el_metal': 'โลหะ',
    'el_water': 'น้ำ',
    'element_balance_desc': 'ธาตุไฟแข็งแรงที่สุด ธาตุโลหะอ่อนแอที่สุด',
    'strategy_label': 'กลยุทธ์การพัฒนา:',
    'strategy_value': 'บำรุงและสนับสนุน',
    'favorable_elements': 'ธาตุที่เสริมดวง:',
    'favorable_value': 'ไม้, น้ำ',
    'avoid_elements': 'ธาตุที่ควรหลีกเลี่ยง:',
    'avoid_value': 'ไฟ, ดิน, โลหะ',
    'adjustment_key': 'จุดสำคัญในการปรับสมดุล:',
    'adjustment_value': 'ความสมดุลคือสิ่งสำคัญ',
    'specific_suggestions': 'คำแนะนำเฉพาะ:',
    'suggestions_value': 'ต้องการการบำรุงและสนับสนุนเพื่อเสริมพลังงานภายใน'
  },
  "ms": {
    // Umum
    "lang_label": "Bahasa",
    "title_bazi_brief": "Ulasan Bazi Ringkas",
    "title_quickcalc": "Nasib Bazi · Carta Pantas",
    
    // Label borang
    "label_name": "Nama (pilihan)",
    "ph_name": "Nama anda (untuk penyesuaian)",
    "gender_label": "Jantina",
    "label_calendar": "Kalendar",
    "label_birthdate": "Tarikh Lahir",
    "label_birthtime": "Masa Lahir",
    "cb_time_unknown": "Masa lahir tidak diketahui",
    "btn_generate_chart": "Hasilkan Bazi",
    
    // Pilihan jantina
    "opt_gender_confidential": "Rahsia",
    "opt_gender_male": "Lelaki",
    "opt_gender_female": "Perempuan",
    
    // Pilihan kalendar
    "opt_cal_gregorian": "Gregorian",
    "opt_cal_lunar": "Kalendar Cina",
    
    // Mesej ralat
    "err_birthdate_required": "Sila isi tarikh lahir",
    "err_calculation_failed": "Ralat mengira Bazi, sila cuba lagi",
    
    // Label lima unsur
    "el_wood": "Kayu",
    "el_fire": "Api",
    "el_earth": "Tanah",
    "el_metal": "Logam",
    "el_water": "Air",
    
    // Butler
    "butler_title": "Butler · Analisis Nasib",
    "butler_loading": "Menganalisis carta nasib anda...",
    "butler_chip_career": "💼 Hala Kerjaya",
    "butler_chip_love": "❤️ Cinta & Perkahwinan",
    "butler_chip_wealth": "💰 Analisis Kekayaan",
    "butler_chip_health": "🌿 Kesihatan & Penjagaan",
    "butler_chip_personality": "🌟 Ciri Personaliti",
    
    // Kandungan analisis
    "analysis_strength_strong": "Kuat",
    "analysis_strength_weak": "Lemah",
    "analysis_strength_balanced": "Seimbang",
    "analysis_strategy_drain": "Lepas/Kawal",
    "analysis_strategy_support": "Sokong/Menyubur",
    "analysis_strategy_balance": "Seimbang/Harmoni",

    // Bahagian VIP
    "rpt_sec_elements_title": "Analisis Lima Unsur",
    "vip_title": "🌙 Kawasan Ahli VIP",
    "vip_mingli": "🗝 Kandungan Eksklusif Ruang Nasib",
    "vip_love": "Arah Cinta: Jodoh, Tren Perkahwinan",
    "vip_career": "Arah Kerjaya: Pembangunan Kerjaya, Potensi Perniagaan",
    "vip_wealth": "Arah Kekayaan: Analisis Kedudukan Wang, Masa Pelaburan",
    "vip_pet": "Nasib Haiwan Peliharaan: Personaliti & Jodoh",
    "vip_hepan": "Analisis Keserasian: Tarikh Kahwin, Masa Kelahiran",
    "vip_name": "Analisis Nama: Nama Syarikat, Nama Bayi, Penamaan",
    "vip_fengshui": "Keserasian Kedudukan Wang: Rumah/Pejabat",
    "vip_xinlian": "🌙 Kandungan Eksklusif Ruang XinLian",
    "vip_record": "Rekod Kerohanian: Gambar, Mimpi, Suara, Doa",
    "vip_course": "Kursus Nasib: Bazi/Tarot/Astrologi/Numerologi/Human Design",
    "vip_memorial": "Sistem Memorial Keluarga: Kenangan & Warisan",
    "vip_tasks": "Latihan Tenaga Mingguan/Tugas Ritual",
    "vip_shop": "Diskaun Kedai Tenaga & Tempahan Azimat",

    "butler_overview_title": "Butler · Gambaran Ringkas",
    "ov_summary": "Ringkasan",
    "ov_elements": "Profil Unsur",
    "ov_strategy": "Strategi",
    "ov_focus": "Fokus",
    "ov_actions": "3 Tindakan Minggu Ini",
    "growth_journey": "Perjalanan Tumbuh Anda", 
    "weekly_energy_practice": "Latihan Tenaga Minggu Ini",
    "mission1": "Meditasi syukur 5 minit pagi",
    "mission2": "Ucapkan terima kasih kepada 3 orang",
    "mission3": "Selesaikan satu output kreatif",
    "daily_energy_tip": "Peringatan Tenaga Hari Ini",
    "energy_tip_content": "Menurut carta nasib anda, hari ini sesuai untuk: belajar, meditasi, membina tabiat",
    
    // Login related
    "login_title": "💎 Log Masuk ke Ciri VIP",
    "panel_login_head": "Log Masuk / Daftar Akaun",
    "ph_email": "Emel",
    "ph_label_password": "Kata Laluan",
    "btn_login": "Log Masuk",
    "btn_reset": "🔑 Set Semula Kata Laluan",
    "btn_register": "Daftar Akaun",
    "note_price": "Percubaan percuma dengan pendaftaran",
    "panel_member_head": "Perkhidmatan Ahli",
    "btn_upgrade": "💎 Naik Taraf ke VIP (Bulanan)",
    "btn_backshop": "← Kembali ke Kedai Astro",
    "note_price1": "$9.9 / Bulan VIP (Ruang Nasib + XinLian + Kursus Kerohanian)",
    "ph_email": "Sila masukkan alamat emel",
    "ph_password": "Sila masukkan kata laluan",
  
    'el_wood': 'Kayu',
    'el_fire': 'Api', 
    'el_earth': 'Tanah',
    'el_metal': 'Logam',
    'el_water': 'Air',
    'element_balance_desc': 'Unsur Api paling kuat, unsur Logam paling lemah.',
    'strategy_label': 'Strategi Pembangunan:',
    'strategy_value': 'Bantu dan Sokong',
    'favorable_elements': 'Unsur Menguntungkan:',
    'favorable_value': 'Kayu, Air',
    'avoid_elements': 'Unsur Dielakkan:',
    'avoid_value': 'Api, Tanah, Logam',
    'adjustment_key': 'Fokus Penyesuaian:',
    'adjustment_value': 'Keseimbangan Adalah Kunci',
    'specific_suggestions': 'Cadangan Spesifik:',
    'suggestions_value': 'Perlu bantuan dan sokongan untuk meningkatkan tenaga diri'
  }
};

// 语言管理
const LANG_KEY = "site_lang";

function getLang() {
  return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
}

function setLang(code) {
  localStorage.setItem(LANG_KEY, code);
  document.documentElement.lang = code;
  applyTranslations();
}

function t(key) {
  const lang = getLang();
  return translations[lang]?.[key] || translations["zh-CN"][key] || key;
}

function applyTranslations() {
  // 翻译所有带有 data-i18n 属性的元素
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  
  // 翻译占位符
  document.querySelectorAll("[data-i18n-ph]").forEach(el => {
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  
  // 更新心怜管家芯片
  updateButlerChips();
}

function updateButlerChips() {
  const chips = {
    'career': 'butler_chip_career',
    'love': 'butler_chip_love',
    'wealth': 'butler_chip_wealth',
    'health': 'butler_chip_health',
    'personality': 'butler_chip_personality'
  };
  
  Object.entries(chips).forEach(([type, key]) => {
    const chip = document.querySelector(`[data-question="${type}"]`);
    if (chip) {
      chip.textContent = t(key);
    }
  });
  
  // 更新管家标题
  const butlerTitle = document.querySelector('.butler-title');
  if (butlerTitle) {
    butlerTitle.textContent = t('butler_title');
  }
}

// ================== 配置 & 工具函数 ==================
const $ = id => document.getElementById(id);

function showErr(msg){ 
  const e = $("error"); 
  if(!e) return; 
  e.textContent = msg; 
  e.style.display = "block"; 
  setTimeout(() => { e.style.display = 'none' }, 5000); 
}

function hideErr(){ 
  const e = $("error"); 
  if(!e) return; 
  e.style.display = "none"; 
  e.textContent = ""; 
}

function lock(el, v){ 
  if(el) el.disabled = v; 
}

function setText(id, v){ 
  const el = $(id); 
  if(el) el.textContent = v; 
}

function setBar(el, pct){ 
  if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; 
}

// ================== 八字计算器核心 ==================
class BaziCalculator {
  constructor(){
    this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }

  calculateYearPillar(year){ 
    const s = (year - 4) % 10;
    const b = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(s + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(b + 12) % 12],
      zodiac: this.ZODIAC[(b + 12) % 12]
    }; 
  }

  solarMonthIndex(y, m, d){ 
    const mmdd = m * 100 + d;
    const gates = [
      [106,12], [204,1], [306,2], [405,3], [506,4], 
      [606,5], [707,6], [808,7], [908,8], [1008,9], 
      [1107,10], [1207,11]
    ];
    let idx = 11;
    for(const [thr, val] of gates) {
      if(mmdd >= thr) idx = val;
    }
    const branchBy = {
      1:'寅', 2:'卯', 3:'辰', 4:'巳', 5:'午', 
      6:'未', 7:'申', 8:'酉', 9:'戌', 10:'亥', 
      11:'子', 12:'丑'
    };
    return { index: idx, branch: branchBy[idx] };
  }

  calculateMonthPillar(year, month, day){ 
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0};
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  calculateDayPillar(year, month, day){ 
    const baseUTC = Date.UTC(1900, 0, 31);
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx = (0 + dayDiff) % 10;
    const branchIdx = (4 + dayDiff) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12]
    };
  }

  calculateHourPillar(dayStem, hour){ 
    const branchMap = {
      23:'子', 0:'子', 1:'丑', 2:'丑', 3:'寅', 4:'寅',
      5:'卯', 6:'卯', 7:'辰', 8:'辰', 9:'巳', 10:'巳',
      11:'午', 12:'午', 13:'未', 14:'未', 15:'申', 16:'申',
      17:'酉', 18:'酉', 19:'戌', 20:'戌', 21:'亥', 22:'亥'
    };
    const startMap = {0:0, 1:2, 2:4, 3:6, 4:8, 5:0, 6:2, 7:4, 8:6, 9:8};
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getElement(stem, branch){ 
    const s = {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    };
    const b = {
      '子':'水', '丑':'土', '寅':'木', '卯':'木', 
      '辰':'土', '巳':'火', '午':'火', '未':'土', 
      '申':'金', '酉':'金', '戌':'土', '亥':'水'
    };
    return `${s[stem]}${b[branch]}`;
  }

  getNayin(stem, branch){ 
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length];
  }

  getStemElement(stem){ 
    return {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    }[stem];
  }

  getBranchElement(branch){ 
    return {
      '子':'水', '丑':'土', '寅':'木', '卯':'木', 
      '辰':'土', '巳':'火', '午':'火', '未':'土', 
      '申':'金', '酉':'金', '戌':'土', '亥':'水'
    }[branch];
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false){
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'？', branch:'？'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // 计算五行分布
    const cnt = {木:0, 火:0, 土:0, 金:0, 水:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(p => {
      if(p.stem && p.stem !== '？') cnt[this.getStemElement(p.stem)] += 1;
      if(p.branch && p.branch !== '？') cnt[this.getBranchElement(p.branch)] += 1;
    });

    const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
    const pct = {
      wood: cnt['木'] / total * 100,
      fire: cnt['火'] / total * 100,
      earth: cnt['土'] / total * 100,
      metal: cnt['金'] / total * 100,
      water: cnt['水'] / total * 100
    };

    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}

const baziCalculator = new BaziCalculator();

// ================== 增强的AI陪伴成长管家 ==================
class GrowthAdvisor {
  constructor() {
    this.growthPaths = {
      '木旺': {
        challenge: "竞争压力大，易与人冲突",
        solution: "学习合作共赢，培养耐心",
        dailyPractice: ["晨间冥想", "团队运动", "学习倾听"],
        affirmation: "我像大树一样，既挺拔又包容"
      },
      '火弱': {
        challenge: "缺乏行动力，易犹豫不决",
        solution: "设定小目标，培养行动习惯",
        dailyPractice: ["每日运动15分钟", "公开表达想法", "尝试新事物"],
        affirmation: "我的内在火焰正在燃烧，带我向前"
      }
    };
  }
  
  generateGrowthPlan(baziAnalysis) {
    const plan = {
      weeklyFocus: this.getWeeklyFocus(baziAnalysis),
      energyManagement: this.getEnergyTips(baziAnalysis),
      relationshipAdvice: this.getRelationshipTips(baziAnalysis)
    };
    return plan;
  }

  getWeeklyFocus(analysis) {
    const { strength, usefulElements } = analysis;
    
    if (strength.mark === '偏强') {
      return {
        theme: "释放与转化",
        tasks: [
          "创作输出：写一篇文章或录制视频",
          "运动排解：高强度间歇训练",
          "社交分享：组织小型聚会"
        ]
      };
    } else {
      return {
        theme: "积累与滋养", 
        tasks: [
          "学习充电：完成一个在线课程",
          "静心养性：每日冥想10分钟",
          "建立习惯：规律作息"
        ]
      };
    }
  }

  getEnergyTips(analysis) {
    const { percents } = analysis;
    const tips = [];
    
    if (percents.wood > 40) tips.push("多接触水元素环境平衡木气");
    if (percents.fire < 15) tips.push("增加红色装饰物提升火能量");
    if (percents.water === 0) tips.push("多喝水，接触蓝色物品补充水元素");
    
    return tips.length > 0 ? tips : ["保持当前能量平衡状态"];
  }

  getRelationshipTips(analysis) {
    const { pillars } = analysis;
    
    if (pillars.day.stem === '甲' || pillars.day.stem === '乙') {
      return {
        communication: "直接表达，避免绕弯子",
        partnership: "寻找土元素强的伴侣平衡",
        conflict: "遇到冲突先冷静再沟通"
      };
    }
    
    return {
      communication: "温和表达，注重情感交流",
      partnership: "寻找互补性格的伴侣",
      conflict: "多倾听对方需求"
    };
  }
}

// ================== 增强的喜用神分析 ==================
class ButlerAI {
  constructor() {
    this.currentAnalysis = null;
    this.advancedKnowledge = this.initAdvancedKnowledge();
  }

  initAdvancedKnowledge() {
    return {
      stemTraits: {
        '甲': { nature: '阳木', image: '参天大树', traits: ['领导力', '正直', '开拓精神'], weakness: ['固执', '缺乏弹性'] },
        '乙': { nature: '阴木', image: '藤蔓花草', traits: ['灵活', '适应力强', '艺术性'], weakness: ['优柔寡断', '依赖性强'] },
        '丙': { nature: '阳火', image: '太阳', traits: ['热情', '光明', '感染力'], weakness: ['急躁', '冲动'] },
        '丁': { nature: '阴火', image: '灯烛', traits: ['细致', '专注', '智慧'], weakness: ['多疑', '计较'] },
        '戊': { nature: '阳土', image: '城墙厚土', traits: ['稳重', '诚信', '责任心'], weakness: ['固执', '缺乏变通'] },
        '己': { nature: '阴土', image: '田园之土', traits: ['包容', '细腻', '务实'], weakness: ['优柔寡断', '依赖性强'] },
        '庚': { nature: '阳金', image: '刀剑利器', traits: ['果断', '刚毅', '正义感'], weakness: ['固执', '缺乏柔情'] },
        '辛': { nature: '阴金', image: '珠宝首饰', traits: ['精致', '敏锐', '追求完美'], weakness: ['计较', '缺乏大气'] },
        '壬': { nature: '阳水', image: '江河湖海', traits: ['智慧', '包容', '适应力'], weakness: ['随波逐流', '缺乏原则'] },
        '癸': { nature: '阴水', image: '雨露之水', traits: ['细腻', '敏感', '洞察力'], weakness: ['多虑', '缺乏决断'] }
      }
    };
  }

  // 增强的喜用神分析
  analyzeUsefulElements(analysis) {
    const { pillars, counts, percents, strength } = analysis;
    const dayElement = pillars.day.element;
    
    // 1. 判断身强身弱
    const isStrong = strength.mark === '偏强';
    
    // 2. 计算各五行力量
    const elementPower = this.calculateElementPower(pillars, counts);
    
    // 3. 确定喜用神
    let useful = [];
    let avoid = [];
    
    if (isStrong) {
      // 身强：喜克泄耗
      useful = this.getWeakeningElements(dayElement);
      avoid = this.getStrengtheningElements(dayElement);
    } else {
      // 身弱：喜生扶
      useful = this.getStrengtheningElements(dayElement);
      avoid = this.getWeakeningElements(dayElement);
    }
    
    // 4. 调候用神（根据季节）
    const seasonElement = this.getSeasonElement(pillars.month.branch);
    const conditioningElements = this.getConditioningElements(dayElement, seasonElement);
    
    // 合并调候用神
    useful = [...new Set([...useful, ...conditioningElements.useful])];
    avoid = [...new Set([...avoid, ...conditioningElements.avoid])];
    
    return {
      strategy: isStrong ? '泄秀制化' : '生扶补助',
      useful,
      avoid,
      advice: isStrong ? '宜泄不宜补，寻求平衡发展' : '需要生扶补助，增强自身能量',
      elementPower,
      conditioning: conditioningElements.reason
    };
  }

  // 计算五行力量（考虑地支藏干）
  calculateElementPower(pillars, counts) {
    const power = {木:0, 火:0, 土:0, 金:0, 水:0};
    
    // 天干直接计数
    Object.values(pillars).forEach(pillar => {
      if (pillar.stem && pillar.stem !== '？') {
        const element = this.getStemElement(pillar.stem);
        power[element] += 1;
      }
    });
    
    // 地支藏干加权计算
    Object.values(pillars).forEach(pillar => {
      if (pillar.branch && pillar.branch !== '？') {
        const hiddenStems = this.getHiddenStems(pillar.branch);
        hiddenStems.forEach(stem => {
          const element = this.getStemElement(stem);
          power[element] += 0.3; // 地支藏干权重
        });
      }
    });
    
    return power;
  }

  // 地支藏干表
  getHiddenStems(branch) {
    const hiddenMap = {
      '子': ['癸'],
      '丑': ['己','癸','辛'],
      '寅': ['甲','丙','戊'],
      '卯': ['乙'],
      '辰': ['戊','乙','癸'],
      '巳': ['丙','庚','戊'],
      '午': ['丁','己'],
      '未': ['己','丁','乙'],
      '申': ['庚','壬','戊'],
      '酉': ['辛'],
      '戌': ['戊','辛','丁'],
      '亥': ['壬','甲']
    };
    return hiddenMap[branch] || [];
  }

  // 调候用神（根据季节）
  getSeasonElement(monthBranch) {
    const seasonMap = {
      '寅':'木', '卯':'木', '辰':'木',
      '巳':'火', '午':'火', '未':'火',
      '申':'金', '酉':'金', '戌':'金',
      '亥':'水', '子':'水', '丑':'水'
    };
    return seasonMap[monthBranch] || '土';
  }

  getConditioningElements(dayElement, seasonElement) {
    const conditioningRules = {
      // 春木旺，需金制木，火暖局，土培木
      '木': {
        '木': { useful: ['金','火','土'], avoid: ['水','木'], reason: '春木旺相，需金修剪，火暖局，土培根' },
        '火': { useful: ['水','金'], avoid: ['木','火'], reason: '春木生火，需水润局，金制木' },
        '土': { useful: ['火','金'], avoid: ['木','水'], reason: '春土虚，需火生土，金制木' },
        '金': { useful: ['土','水'], avoid: ['火','木'], reason: '春金休囚，需土生金，水泄木' },
        '水': { useful: ['金','火'], avoid: ['土','木'], reason: '春水休囚，需金生水，火调候' }
      },
      // 夏火旺，需水制火，土泄火，金生水
      '火': {
        '木': { useful: ['水','金'], avoid: ['木','火'], reason: '夏火炎，需水济火，金生水' },
        '火': { useful: ['水','土','金'], avoid: ['木','火'], reason: '夏火旺极，急需水制，土泄火' },
        '土': { useful: ['水','金'], avoid: ['火','木'], reason: '夏土焦，需水润土，金生水' },
        '金': { useful: ['水','土'], avoid: ['火','木'], reason: '夏金死，需水生扶，土晦火' },
        '水': { useful: ['金','木'], avoid: ['土','火'], reason: '夏水绝，需金生水，木泄火' }
      }
      // 其他季节规则类似，可以继续补充...
    };
    
    return conditioningRules[seasonElement]?.[dayElement] || 
           { useful: [], avoid: [], reason: '平衡为要' };
  }

  // 在analyzeBazi方法中整合喜用神分析
  analyzeBazi(baziData) {
    const { pillars, counts, percents, timeUnknown } = baziData;
    
    // 深度分析命局
    const strength = this.judgeAdvancedStrength(pillars, counts);
    const usefulElements = this.analyzeUsefulElements({
      pillars, counts, percents, strength
    });
    
    this.currentAnalysis = {
      pillars,
      strength,
      usefulElements, // 现在包含完整的喜用神分析
      percents,
      timeUnknown,
      comprehensive: this.generateAdvancedAnalysis(pillars, strength, usefulElements, percents, timeUnknown)
    };

    return this.currentAnalysis;
  }

  // 更新生成综合解读方法，显示喜用神
  generateAdvancedAnalysis(pillars, strength, usefulElements, percents, timeUnknown, lang = 'zh-CN') {
    const dayMaster = pillars.day.stem;
    const dayElement = pillars.day.element;
    
    let analysis = `🌳 命格深度解析\n\n`;
    analysis += `您的八字日主为${dayMaster}${dayElement}，命局${strength.mark}。\n\n`;
    
    analysis += `📊 五行能量分布\n`;
    analysis += `木 ${Math.round(percents.wood)}% | 火 ${Math.round(percents.fire)}% | 土 ${Math.round(percents.earth)}% | 金 ${Math.round(percents.metal)}% | 水 ${Math.round(percents.water)}%\n\n`;
    
    // 喜用神分析
    analysis += `🎯 喜用神分析\n`;
    analysis += `• 发展策略：${usefulElements.strategy}\n`;
    analysis += `• 喜用元素：${usefulElements.useful.join('、')}\n`;
    analysis += `• 忌避元素：${usefulElements.avoid.join('、')}\n`;
    analysis += `• 调候要点：${usefulElements.conditioning}\n`;
    analysis += `• 具体建议：${usefulElements.advice}\n\n`;
    
    // 五行力量详情
    analysis += `💪 五行力量详情\n`;
    Object.entries(usefulElements.elementPower).forEach(([element, power]) => {
      const stars = '★'.repeat(Math.round(power));
      analysis += `• ${element}：${stars} (${power.toFixed(1)})\n`;
    });
    
    if (timeUnknown) {
      analysis += `\n⚠️ 提示：由于出生时间不详，时柱未纳入分析，建议仅供参考。`;
    }
    
    return analysis;
  }

  // 快速总览方法
  getOverviewInCurrentLanguage() {
    if (!this.currentAnalysis) return t('butler_loading');
    const lang = getLang();
    return this._generateOverview(this.currentAnalysis, lang);
  }

  _generateOverview(analysis, lang) {
    const dm = analysis.pillars.day.stem + analysis.pillars.day.element;
    const strength = this.tStrength(analysis.strength.mark);
    const focus = this.tStrategy(analysis.strength.focus);
    const p = analysis.percents;

    const elements = [
      {k:'木', v: p.wood}, {k:'火', v:p.fire}, {k:'土', v:p.earth}, 
      {k:'金', v:p.metal}, {k:'水', v:p.water}
    ];
    const strongest = elements.reduce((a,b)=>a.v>b.v?a:b);
    const weakest = elements.reduce((a,b)=>a.v<b.v?a:b);

    const useful = analysis.usefulElements.useful.join(lang==='en'?', ':'、');
    const avoid = analysis.usefulElements.avoid.length ? 
      (lang==='en'?'Avoid: ':'注意：') + analysis.usefulElements.avoid.join(lang==='en'?', ':'、') : '';

    const head = (k) => ({
      'zh-CN':`【${t(k)}】`,
      'en':`[${t(k)}]`
    }[lang] || `[${t(k)}]`);

    let s = `${t('butler_overview_title')}\n\n`;

    s += `${head('ov_summary')}\n` +
         `日主 ${dm} · ${strength}\n\n`;

    s += `${head('ov_elements')}\n` +
         `强：${strongest.k} ${Math.round(strongest.v)}% · 弱：${weakest.k} ${Math.round(weakest.v)}%\n\n`;

    s += `${head('ov_strategy')}\n` +
         `用「${focus}」；增强：${useful}${avoid?` · ${avoid}`:''}\n\n`;

    // 重点方向
    const focusLines = [];
    if(this.hasWoodFireStructure(analysis.pillars)) 
      focusLines.push(lang==='en'?'Create/teach/brand via content':'内容/教学/品牌表达');
    if(analysis.pillars.hour.stem==='庚') 
      focusLines.push(lang==='en'?'Compete/build standards':'竞争/标准化');
    if(!focusLines.length) 
      focusLines.push(lang==='en'?'Stabilize offer → price → SOP':'固定产品 → 定价 → SOP');

    s += `${head('ov_focus')}\n` + '• ' + focusLines.join('\n• ') + `\n\n`;

    s += `${head('ov_actions')}\n` +
         (lang==='en'
          ? `1) Ship one piece of content\n2) Package & price one offer\n3) Add/upgrade one SOP`
          : `1）输出一篇内容\n2）打包并定价一个产品\n3）新增/升级一条SOP`);

    if(analysis.timeUnknown){
      s += (lang==='en'
        ? `\n\n⚠️ Note: hour pillar missing`
        : `\n\n⚠️ 提示：因出生时间不详，未纳入时柱`);
    }
    return s;
  }

  // 判断身强身弱
  judgeAdvancedStrength(pillars, counts) {
    const dayElement = pillars.day.element;
    const sameElementCount = counts[dayElement] || 0;
    
    let mark, focus;
    if (sameElementCount >= 3) {
      mark = '偏强';
      focus = '泄秀制化';
    } else if (sameElementCount <= 1) {
      mark = '偏弱';
      focus = '生扶补助';
    } else {
      mark = '平衡';
      focus = '守中调和';
    }
    
    return { mark, focus };
  }

  // 辅助方法
  tStrength(strength) {
    const map = {
      '偏强': t('analysis_strength_strong'),
      '偏弱': t('analysis_strength_weak'),
      '平衡': t('analysis_strength_balanced')
    };
    return map[strength] || strength;
  }

  tStrategy(strategy) {
    const map = {
      '泄秀/制化': t('analysis_strategy_drain'),
      '补助/顺势': t('analysis_strategy_support'),
      '守中/调和': t('analysis_strategy_balance')
    };
    return map[strategy] || strategy;
  }

  hasWoodFireStructure(pillars) {
    const woodCount = this.countElement(pillars, '木');
    const fireCount = this.countElement(pillars, '火');
    return woodCount >= 2 && fireCount >= 2;
  }

  countElement(pillars, element) {
    let count = 0;
    Object.values(pillars).forEach(pillar => {
      if (this.getStemElement(pillar.stem) === element) count++;
    });
    return count;
  }

  getStemElement(stem) {
    return {
      '甲':'木', '乙':'木', '丙':'火', '丁':'火', 
      '戊':'土', '己':'土', '庚':'金', '辛':'金', 
      '壬':'水', '癸':'水'
    }[stem];
  }

  getStrengtheningElements(element) {
    const map = {
      '木': ['木', '水'],
      '火': ['火', '木'],
      '土': ['土', '火'],
      '金': ['金', '土'],
      '水': ['水', '金']
    };
    return map[element] || [];
  }

  getWeakeningElements(element) {
    const map = {
      '木': ['火', '土', '金'],
      '火': ['土', '金', '水'],
      '土': ['金', '水', '木'],
      '金': ['水', '木', '火'],
      '水': ['木', '火', '土']
    };
    return map[element] || [];
  }

  // 深度指导方法
  getAdvancedCareerAdvice(analysis) {
    const lang = getLang();
    const lanes = this.hasWoodFireStructure(analysis.pillars)
      ? (lang==='en'
          ? ['Content/education/brand', 'Advisory & training', 'Creative commerce']
          : ['内容/教育/品牌', '咨询与培训', '创意型商业'])
      : (lang==='en'?['Management/ops','Specialist track']:['管理/运营','专业路线']);

    const playbook = (lang==='en'
      ? [
          'Quarter theme → monthly launch → weekly ship.',
          'One flagship offering; one evergreen lead magnet.',
          'Calendar blocks: create / monetize / systemize.'
        ]
      : [
          '季度主题 → 月度上新 → 每周交付。',
          '至少一个旗舰服务 + 一个长期引流品。',
          '日历分区：创作 / 变现 / 标准化。'
        ]);

    return (lang==='en'
      ? `💼 Career (Deep Guidance)\n\nSuggested paths:\n- `+lanes.join(`\n- `)+`\n\nGrowth Playbook:\n- `+playbook.join(`\n- `)
      : `💼 事业深度指导\n\n适配赛道：\n- `+lanes.join(`\n- `)+`\n\n成长路径：\n- `+playbook.join(`\n- `));
  }

  getAdvancedWealthAdvice(analysis) {
    const lang = getLang();
    const tips = (lang==='en')
      ? [
          'Build value ladder: entry → core → premium offers',
          'Weekly finance review: revenue · profit · receivables',
          'Package skills into sellable products & services',
          'Track key metrics: conversion rate & repeat business'
        ]
      : [
          '搭建价值阶梯：引流款 → 核心款 → 高客单',
          '每周财务复盘：营收、利润、应收账款',
          '将技能打包成可销售的产品服务',
          '关注核心指标：转化率与复购率'
        ];
    return (lang==='en'
      ? `💰 Wealth Building Strategy\n\n• Best offers: content/products, consulting, membership\n• Pricing: maintain 3 tiers (Good/Better/Best)\n\nAction Steps:\n- `+tips.join(`\n- `)
      : `💰 财富建设策略\n\n• 最佳产品：内容/课程、咨询服务、会员\n• 定价策略：保持三档（入门/标准/旗舰）\n\n执行步骤：\n- `+tips.join(`\n- `));
  }

  getAdvancedLoveAdvice(analysis) {
    const lang = getLang();
    return (lang==='en'
      ? `❤️ Relationship Guidance\n\nYour style: expressive + principled. Best matches respect boundaries and growth.\n\nWeekly Practices:\n- Check-in conversations (facts/feelings/needs)\n- Shared financial & time planning\n- Monthly appreciation celebrations`
      : `❤️ 感情关系指导\n\n您的风格：表达型 + 原则感。适合尊重边界、愿意共同成长的伴侣。\n\n每周练习：\n- 深度对话（事实/感受/需求）\n- 共同财务与时间规划\n- 每月感恩庆祝`);
  }

  getAdvancedHealthAdvice(analysis) {
    const lang = getLang();
    const weakest = Object.entries(analysis.percents).sort((a,b)=>a[1]-b[1])[0][0];
    const elementNames = {
      wood: lang==='en'?'Wood':'木', fire:lang==='en'?'Fire':'火', 
      earth:lang==='en'?'Earth':'土', metal:lang==='en'?'Metal':'金', 
      water:lang==='en'?'Water':'水'
    };
    const rec = (lang==='en'
      ? [
          'Prioritize sleep & daily rhythm; 90-min focus blocks',
          'Hydration & breathing exercises',
          'Light cardio + mobility; avoid late caffeine'
        ]
      : [
          '优先规律作息：固定睡眠与90分钟专注块',
          '充分补水与呼吸练习',
          '轻有氧+灵活度训练；晚间避免咖啡因'
        ]);
    return (lang==='en'
      ? `🌿 Wellness Plan\n\nWeaker element: ${elementNames[weakest]}\n\nDaily Practices:\n- `+rec.join(`\n- `)
      : `🌿 健康养生计划\n\n偏弱元素：${elementNames[weakest]}\n\n每日练习：\n- `+rec.join(`\n- `));
  }

  getAdvancedPersonalityDetail(analysis) {
    const lang = getLang();
    const traits = this.advancedKnowledge.stemTraits[analysis.pillars.day.stem].traits.join(lang==='en'?', ': '、');
    const watch = this.advancedKnowledge.stemTraits[analysis.pillars.day.stem].weakness.join(lang==='en'?', ': '、');
    return (lang==='en'
      ? `🌟 Personality Insights\n\nCore strengths: ${traits}\nGrowth areas: ${watch}`
      : `🌟 性格深度解析\n\n核心优势：${traits}\n成长方向：${watch}`);
  }

  answerQuestion(questionType) {
    if (!this.currentAnalysis) return '请先生成八字命盘';
    
    switch(questionType) {
      case 'career':
        return this.getAdvancedCareerAdvice(this.currentAnalysis);
      case 'love':
        return this.getAdvancedLoveAdvice(this.currentAnalysis);
      case 'wealth':
        return this.getAdvancedWealthAdvice(this.currentAnalysis);
      case 'health':
        return this.getAdvancedHealthAdvice(this.currentAnalysis);
      case 'personality':
        return this.getAdvancedPersonalityDetail(this.currentAnalysis);
      default:
        return this.getOverviewInCurrentLanguage();
    }
  }
}

const butlerAI = new ButlerAI();

// ================== 界面渲染函数 ==================
function renderPillars(root, p, timeUnknown = false) {
  if (!root) return;
  root.innerHTML = '';
  
  [['年柱', p.year], ['月柱', p.month], ['日柱', p.day], ['时柱', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === '时柱' && timeUnknown);
    const stem = isUnknown ? '？' : v.stem;
    const branch = isUnknown ? '？' : v.branch;
    
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `;
    root.appendChild(div);
  });
}

function displayClassicArea(p, timeUnknown) {
  const getElement = (s, b) => baziCalculator.getElement(s, b);
  const getNayin = (s, b) => baziCalculator.getNayin(s, b);
  
  setText('year-stem', p.year.stem);
  setText('month-stem', p.month.stem);
  setText('day-stem', p.day.stem);
  setText('hour-stem', timeUnknown ? '？' : p.hour.stem);
  
  setText('year-branch', p.year.branch);
  setText('month-branch', p.month.branch);
  setText('day-branch', p.day.branch);
  setText('hour-branch', timeUnknown ? '？' : p.hour.branch);
  
  setText('year-element', getElement(p.year.stem, p.year.branch));
  setText('month-element', getElement(p.month.stem, p.month.branch));
  setText('day-element', getElement(p.day.stem, p.day.branch));
  setText('hour-element', timeUnknown ? '未知' : getElement(p.hour.stem, p.hour.branch));
  
  setText('year-nayin', getNayin(p.year.stem, p.year.branch));
  setText('month-nayin', getNayin(p.month.stem, p.month.branch));
  setText('day-nayin', getNayin(p.day.stem, p.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : getNayin(p.hour.stem, p.hour.branch));
}

function updateButlerDisplay(content, questionType = 'overview') {
  const el = $('butler-content');
  if (!el) return;
  
  el.innerHTML = `<div style="white-space:pre-wrap;line-height:1.6;">${content}</div>`;
}

function showButlerLoading() {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  butlerContent.innerHTML = `
    <div style="text-align: center; padding: 20px; color: var(--muted);">
      ${t('butler_loading')}
    </div>
  `;
}

function showGrowthTracker(analysis) {
  const tracker = $('growthTracker');
  if (tracker) {
    tracker.style.display = 'block';
    
    // 根据分析结果更新每日能量提醒
    const energyTip = $('dailyEnergyTip');
    if (energyTip && analysis) {
      const { strength, usefulElements } = analysis;
      if (strength.mark === '偏强') {
        energyTip.textContent = '根据您的命盘，今天适合：创意输出、运动释放、社交分享';
      } else {
        energyTip.textContent = '根据您的命盘，今天适合：学习充电、静心养性、建立习惯';
      }
    }
  }
}

// 新增：显示喜用神分析
function displayUsefulElements(usefulElements) {
  const elementsDiv = document.createElement('div');
  elementsDiv.className = 'card';
  elementsDiv.innerHTML = `
    <div class="h2">🎯 喜用神分析</div>
    <div class="useful-elements">
      <div><strong>发展策略：</strong>${usefulElements.strategy}</div>
      <div><strong>喜用元素：</strong>${usefulElements.useful.join('、')}</div>
      <div><strong>忌避元素：</strong>${usefulElements.avoid.join('、')}</div>
      <div><strong>调候要点：</strong>${usefulElements.conditioning}</div>
      <div><strong>具体建议：</strong>${usefulElements.advice}</div>
    </div>
  `;
  
  // 插入到五行分析后面
  const elementsSection = $('bazi-elements-balance').closest('.card');
  elementsSection.after(elementsDiv);
}
 
// ================== 主逻辑函数 ==================
async function genChart() {
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  
  if (!birth) {
    showErr(t('err_birthdate_required'));
    return;
  }

  const btn = $('genBtn');
  const tx = $('genBtnText');
  const ld = $('genBtnLoading');
  
  if (btn) btn.disabled = true;
  if (tx) tx.style.display = 'none';
  if (ld) ld.style.display = 'inline-block';

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12;
    
    if (!timeUnknown) {
      const t = ($('birthtime')?.value || '').trim();
      if (t) {
        const h = parseInt(t.split(':')[0], 10);
        if (!Number.isNaN(h)) hour = h;
      }
    }

    // 计算八字
    const baziData = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    const { pillars, counts, percents, timeUnknown: tu } = baziData;

    // 显示结果区域
    $('result')?.style.setProperty('display', 'block');
    
    // 更新日期显示
    const timeText = tu ? t('cb_time_unknown') : (hour + '时');
    setText('bazi-date', `${t('label_birthdate')}: ${Y}年${M}月${D}日 ${timeText}`);
    if (tu) {
      const el = $('bazi-date');
      if (el) el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>';
    }

    // 渲染四柱
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    // 更新五行条
    setBar($('bar-木'), percents.wood);
    setText('pct-木', Math.round(percents.wood) + '%');
    setBar($('bar-火'), percents.fire);
    setText('pct-火', Math.round(percents.fire) + '%');
    setBar($('bar-土'), percents.earth);
    setText('pct-土', Math.round(percents.earth) + '%');
    setBar($('bar-金'), percents.metal);
    setText('pct-金', Math.round(percents.metal) + '%');
    setBar($('bar-水'), percents.water);
    setText('pct-水', Math.round(percents.water) + '%');

    // 五行平衡提示
    const elements = [
      { name: t('el_wood'), value: percents.wood },
      { name: t('el_fire'), value: percents.fire },
      { name: t('el_earth'), value: percents.earth },
      { name: t('el_metal'), value: percents.metal },
      { name: t('el_water'), value: percents.water }
    ];
    
    const strongest = elements.reduce((a, b) => a.value > b.value ? a : b);
    const weakest = elements.reduce((a, b) => a.value < b.value ? a : b);
    
    setText('bazi-elements-balance', 
      `五行中${strongest.name}元素最强，${weakest.name}元素最弱。`
    );

    // 心怜管家分析
    showButlerLoading();
    
    // 模拟分析时间
    setTimeout(() => {
      const analysis = butlerAI.analyzeBazi(baziData);
      // 显示快速总览
      updateButlerDisplay(butlerAI.getOverviewInCurrentLanguage(), 'overview');
      // 显示喜用神分析 - 使用新的动态显示函数
      updateUsefulElementsDisplay(analysis);
      // 显示成长跟踪器
      showGrowthTracker(analysis);
    }, 1000);

  } catch (err) {
    console.error(err);
    showErr(t('err_calculation_failed'));
  } finally {
    if (btn) btn.disabled = false;
    if (tx) tx.style.display = 'inline';
    if (ld) ld.style.display = 'none';
  }
}

// 新增：更新喜用神分析显示
function updateUsefulElementsDisplay(analysis) {
  const section = $('#useful-elements-section');
  if (section) {
    section.style.display = 'block';
  }
  
  const { percents, usefulElements } = analysis;
  
  // 更新五行条
  setBar($('bar-wood-dynamic'), percents.wood);
  setText('pct-wood-dynamic', Math.round(percents.wood) + '%');
  setBar($('bar-fire-dynamic'), percents.fire);
  setText('pct-fire-dynamic', Math.round(percents.fire) + '%');
  setBar($('bar-earth-dynamic'), percents.earth);
  setText('pct-earth-dynamic', Math.round(percents.earth) + '%');
  setBar($('bar-metal-dynamic'), percents.metal);
  setText('pct-metal-dynamic', Math.round(percents.metal) + '%');
  setBar($('bar-water-dynamic'), percents.water);
  setText('pct-water-dynamic', Math.round(percents.water) + '%');
  
  // 更新五行平衡提示
  const elements = [
    { name: t('el_wood'), value: percents.wood },
    { name: t('el_fire'), value: percents.fire },
    { name: t('el_earth'), value: percents.earth },
    { name: t('el_metal'), value: percents.metal },
    { name: t('el_water'), value: percents.water }
  ];
  
  const strongest = elements.reduce((a, b) => a.value > b.value ? a : b);
  const weakest = elements.reduce((a, b) => a.value < b.value ? a : b);
  
  setText('bazi-elements-balance-dynamic', 
    `五行中${strongest.name}元素最强，${weakest.name}元素最弱。`
  );
  
  // 更新分析建议
  setText('strategy-value-dynamic', usefulElements.strategy);
  setText('favorable-value-dynamic', usefulElements.useful.join('、'));
  setText('avoid-value-dynamic', usefulElements.avoid.join('、'));
  setText('adjustment-value-dynamic', usefulElements.conditioning);
  setText('suggestions-value-dynamic', usefulElements.advice);
}

// ================== 初始化语言系统 ==================
function initLanguageSystem() {
  const langSelect = $('langSelect');
  if (langSelect) {
    langSelect.value = getLang();
    langSelect.addEventListener('change', (e) => {
      setLang(e.target.value);
      // 重新生成当前内容
      if (butlerAI.currentAnalysis) {
        updateButlerDisplay(butlerAI.getOverviewInCurrentLanguage(), 'overview');
        // 同时更新喜用神分析的多语言
        updateUsefulElementsDisplay(butlerAI.currentAnalysis);
      }
    });
  }
  
  applyTranslations();
}
  
// ================== 事件监听 ==================
document.addEventListener('DOMContentLoaded', () => {
  // 初始化语言系统
  initLanguageSystem();
  
  // 生成按钮事件
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', genChart);
  }

  // 心怜管家芯片点击事件
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('butler-chip')) {
      const questionType = e.target.getAttribute('data-question');
      if (butlerAI.currentAnalysis) {
        const content = butlerAI.answerQuestion(questionType);
        updateButlerDisplay(content, questionType);
      } else {
        showErr('请先生成八字命盘');
      }
    }
  });

  // 出生时间不详复选框事件
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }

  // 设置默认日期为今天
  const birthdate = $('birthdate');
  if (birthdate && !birthdate.value) {
    birthdate.value = new Date().toISOString().split('T')[0];
  }

  // 输入框回车事件
  ['birthdate', 'birthtime'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          genChart();
        }
      });
    }
  });

  // 成长跟踪器任务完成事件
  document.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox' && e.target.closest('.mission-item')) {
      const completed = document.querySelectorAll('.mission-item input:checked').length;
      const total = document.querySelectorAll('.mission-item input').length;
      const progress = Math.round((completed / total) * 100);
      
      const progressCircle = document.querySelector('.progress-ring circle:last-child');
      const progressText = document.querySelector('.progress-ring span');
      
      if (progressCircle && progressText) {
        const circumference = 2 * Math.PI * 25;
        const offset = circumference - (progress / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
        progressText.textContent = progress + '%';
      }
    }
  });
});

console.log('AI陪伴成长管家系统已加载完成！');
</script>
</body>
</html>
