<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
/* —— 样式保持你的布局（略有精简） —— */
:root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#9aa3b2;--brand:#d4af37;--gold2:#f2d27a;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.35);--accent:#3a86ff}
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC",Arial,sans-serif;line-height:1.6}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em;font-size:1.4rem}
.subtitle{color:var(--muted);font-size:.9rem}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin-bottom:20px}
.row{display:grid;gap:12px}
@media (min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
button,.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.h2{font-size:1.3rem;margin:0 0 1rem;font-weight:700;color:#ffe084;display:flex;align-items:center;gap:10px}
.h2::before{content:"";display:block;width:4px;height:20px;background:var(--brand);border-radius:2px}
.muted{color:#9aa3b2}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:700;letter-spacing:.05em;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin:15px 0;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:12px 15px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2);font-weight:600}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.bar-label{display:flex;justify-content:space-between;margin-top:4px;font-size:.85rem}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:12px;margin:10px 0;color:#ffb4b4}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="subtitle">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div><label class="muted">姓名（可选）</label><input id="name" placeholder="你的称呼（用于个性化）"></div>
      <div><label class="muted">性别</label>
        <select id="gender"><option value="">不透露</option><option value="male">男性</option><option value="female">女性</option><option value="other">其他</option></select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar"><option value="gregorian">阳历 / Gregorian</option><option value="lunar">农历 / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div><label class="muted">出生日期</label><input type="date" id="birthdate"></div>
      <div>
        <label class="muted">出生时间</label>
        <div id="timeInputContainer"><input type="time" id="birthtime" value="12:00"></div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <input type="checkbox" id="timeUnknown"><label for="timeUnknown" class="muted">出生时间不详</label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn"><span id="genBtnText">生成八字</span><span id="genBtnLoading" class="loading" style="display:none"></span></button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div id="error" class="error-message" style="display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar"><i id="bar-木" style="width:0%"></i></div><div class="bar-label"><span>木</span><span id="pct-木">0%</span></div>
      <div class="bar"><i id="bar-火" style="width:0%"></i></div><div class="bar-label"><span>火</span><span id="pct-火">0%</span></div>
      <div class="bar"><i id="bar-土" style="width:0%"></i></div><div class="bar-label"><span>土</span><span id="pct-土">0%</span></div>
      <div class="bar"><i id="bar-金" style="width:0%"></i></div><div class="bar-label"><span>金</span><span id="pct-金">0%</span></div>
      <div class="bar"><i id="bar-水" style="width:0%"></i></div><div class="bar-label"><span>水</span><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</main>

<footer style="text-align:center;color:#6c7b8c;padding:30px 0;margin-top:30px;">© 5XLiving • Astro Sanctuary</footer>

<script>
/* ===========================
   核心：BaziCalculator（修正版）
   =========================== */
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  // 年柱
  calculateYearPillar(year) {
    const s = (year - 4) % 10, b = (year - 4) % 12;
    return { stem: this.HEAVENLY_STEMS[s], branch: this.EARTHLY_BRANCHES[b], zodiac: this.ZODIAC[b] };
  }
  // 用节气切月（寅=1…丑=12）
  solarMonthIndex(y, m, d) {
    const md = m * 100 + d;
    const gates = [
      [1207,'子',11],[106,'丑',12],[204,'寅',1],[306,'卯',2],[405,'辰',3],
      [506,'巳',4],[606,'午',5],[707,'未',6],[808,'申',7],[908,'酉',8],
      [1008,'戌',9],[1107,'亥',10],[1207,'子',11]
    ];
    let last = null;
    for (const [thr] of gates) if (thr <= md) last = thr;
    if (last === null) return { branch:'子', index:11 };
    const item = gates.find(g => g[0] === last);
    return { branch:item[1], index:item[2] };
  }
  // 月柱：寅起，年干定起点
  calculateMonthPillar(year, month, day) {
    const { branch, index } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; // 甲己丙，乙庚戊，丙辛庚，丁壬庚，戊癸甲
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }
  // 日柱：1900-01-31 为甲辰
  calculateDayPillar(year, month, day) {
    const base = new Date(1900,0,31);
    const target = new Date(year, month-1, day);
    const diff = Math.floor((target - base)/86400000);
    const stemIdx = (0 + diff) % 10, brIdx = (4 + diff) % 12; // 甲=0，辰=4
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10],
      branch: this.EARTHLY_BRANCHES[(brIdx+12)%12]
    };
  }
  // 时柱
  calculateHourPillar(dayStem, hour) {
    const branchMap = {23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
    const branch = branchMap[hour];
    const ds = this.HEAVENLY_STEMS.indexOf(dayStem);
    const start = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}[ds]; // 甲己起甲…
    const hourIdx = Math.floor((hour + 1)/2) % 12;
    const stemIdx = (start + hourIdx) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }
  getElement(stem, branch) {
    const se={'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
    const be={'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    return `${se[stem]}${be[branch]}`;
  }
  getNayin(stem, branch) {
    const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si*2+bi)%this.NAYIN.length];
  }
  analyzeElements(bazi){
    const e={'木':0,'火':0,'土':0,'金':0,'水':0};
    for (const k of ['year','month','day','hour']){
      const s=bazi[k].stem,b=bazi[k].branch;
      if(s&&s!=='？') e[this.getElement(s,'子')[0]]++;
      if(b&&b!=='？') e[this.getElement('甲',b)[1]]++;
    }
    return e;
  }
}
const baziCalculator = new BaziCalculator();

/* ===== 生成按钮 ===== */
document.getElementById('genBtn').addEventListener('click', () => {
  const birthdate = document.getElementById('birthdate').value;
  const birthtime = document.getElementById('birthtime').value;
  const timeUnknown = document.getElementById('timeUnknown').checked;

  if (!birthdate){ return showError('请选择出生日期'); }

  const d = new Date(birthdate);
  const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
  let h = 12;
  if (!timeUnknown && birthtime){ h = parseInt(birthtime.split(':')[0],10); }

  const yearPillar  = baziCalculator.calculateYearPillar(y);
  const monthPillar = baziCalculator.calculateMonthPillar(y, m, day); // 注意：带 day
  const dayPillar   = baziCalculator.calculateDayPillar(y, m, day);
  const hourPillar  = timeUnknown ? {stem:'？',branch:'？'} : baziCalculator.calculateHourPillar(dayPillar.stem, h);

  const bazi = {year:yearPillar, month:monthPillar, day:dayPillar, hour:hourPillar};
  displayBaziResult(bazi, y, m, day, h, timeUnknown);
});

/* ===== 展示函数 ===== */
function displayBaziResult(bazi, y, m, d, h, timeUnknown){
  document.getElementById('result').style.display = 'block';
  const pillars = [
    { title:'年柱', stem:bazi.year.stem,  branch:bazi.year.branch },
    { title:'月柱', stem:bazi.month.stem, branch:bazi.month.branch },
    { title:'日柱', stem:bazi.day.stem,   branch:bazi.day.branch },
    { title:'时柱', stem:bazi.hour.stem,  branch:bazi.hour.branch }
  ];
  const box = document.getElementById('bazi-pillars'); box.innerHTML='';
  for (const p of pillars){
    const el=document.createElement('div'); el.className='pillar';
    el.innerHTML=`<div class="tit">${p.title}</div><div class="gz">${p.stem}${p.branch}</div>`;
    box.appendChild(el);
  }
  // 表格
  document.getElementById('year-stem').textContent  = bazi.year.stem;
  document.getElementById('year-branch').textContent= bazi.year.branch;
  document.getElementById('month-stem').textContent = bazi.month.stem;
  document.getElementById('month-branch').textContent=bazi.month.branch;
  document.getElementById('day-stem').textContent   = bazi.day.stem;
  document.getElementById('day-branch').textContent = bazi.day.branch;
  document.getElementById('hour-stem').textContent  = bazi.hour.stem;
  document.getElementById('hour-branch').textContent= bazi.hour.branch;

  document.getElementById('year-element').textContent  = baziCalculator.getElement(bazi.year.stem,bazi.year.branch);
  document.getElementById('month-element').textContent = baziCalculator.getElement(bazi.month.stem,bazi.month.branch);
  document.getElementById('day-element').textContent   = baziCalculator.getElement(bazi.day.stem,bazi.day.branch);
  document.getElementById('hour-element').textContent  = timeUnknown ? '未知' : baziCalculator.getElement(bazi.hour.stem,bazi.hour.branch);

  document.getElementById('year-nayin').textContent  = baziCalculator.getNayin(bazi.year.stem,bazi.year.branch);
  document.getElementById('month-nayin').textContent = baziCalculator.getNayin(bazi.month.stem,bazi.month.branch);
  document.getElementById('day-nayin').textContent   = baziCalculator.getNayin(bazi.day.stem,bazi.day.branch);
  document.getElementById('hour-nayin').textContent  = timeUnknown ? '未知' : baziCalculator.getNayin(bazi.hour.stem,bazi.hour.branch);

  document.getElementById('bazi-date').textContent = `出生日期: ${y}年${m}月${d}日 ${timeUnknown ? '时间不详' : h + '时'}`;

  const elements = baziCalculator.analyzeElements(bazi);
  updateElementBars(elements);
}
function updateElementBars(e){
  const total = Object.values(e).reduce((a,b)=>a+b,0) || 1;
  for (const k of ['木','火','土','金','水']){
    const pct = (e[k]/total*100).toFixed(1)+'%';
    const bar = document.getElementById('bar-'+k), label = document.getElementById('pct-'+k);
    if (bar) bar.style.width = pct; if (label) label.textContent = pct;
  }
  const keys = Object.keys(e);
  const max = keys.reduce((a,b)=> e[a]>e[b]?a:b), min = keys.reduce((a,b)=> e[a]<e[b]?a:b);
  document.getElementById('bazi-elements-balance').textContent = `五行中${max}最强，${min}最弱。`;
}
function showError(msg){ const el=document.getElementById('error'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none'},4000); }

/* ===== 初始化 & 自测 ===== */
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date(); document.getElementById('birthdate').value = today.toISOString().slice(0,10);
  // 自测：打开控制台可见
  (function test(){
    const Y=1978,M=2,D=21,H=12;
    const y=baziCalculator.calculateYearPillar(Y);
    const m=baziCalculator.calculateMonthPillar(Y,M,D);
    const d=baziCalculator.calculateDayPillar(Y,M,D);
    const h=baziCalculator.calculateHourPillar(d.stem,H);
    console.log('自测应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
    console.log('实际 →', y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, h.stem+h.branch);
  })();
});
</script>
</body>
</html>
