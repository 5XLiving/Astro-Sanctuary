<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>命理供门 · 八字简评（免费版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --card:#11161dCC;
      --line:#1f2a36;
      --text:#e8edf3;
      --muted:#98a7b7;
      --brand:#d4af37;
      --accent:#58b9ff;
      --radius:14px;
      --shadow:0 8px 30px rgba(0,0,0,.35);
      --blur:10px;
    }
    html,body{height:100%}
    html{font-size:16px}
    @media(min-width:768px){ html{font-size:17px} }
    @media(min-width:1200px){ html{font-size:18px} }
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url('assets/images/gate.jpg') center/cover no-repeat;
      filter:brightness(.45) saturate(.9) blur(2px);
    }
    .glow{
      position:fixed; inset:auto auto 10% -10%;
      width:45vw; height:45vw; max-width:700px; max-height:700px;
      background:radial-gradient(closest-side, #2a98ff33, transparent 70%);
      filter:blur(30px); z-index:-1; pointer-events:none;
    }
    .container{width:100%; max-width:1000px; padding:24px 16px 80px; margin:0 auto;}
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(12px);
      background:#0b0f14cc; border-bottom:1px solid #0f1622;
    }
    .head-inner{display:flex; align-items:center; gap:14px; padding:16px}
    .brand-badge{
      width:36px; height:36px; border-radius:10px; background:linear-gradient(145deg,#273243,#0e141c);
      display:grid; place-items:center; color:var(--brand); font-weight:700; box-shadow:var(--shadow)
    }
    .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem}
    .subtitle{color:var(--muted); font-size:.9rem}

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;
    }
    .stack{display:grid; gap:12px}
    .row{display:grid; gap:10px}
    @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }

    input,select,button{
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
      background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
    }
    input::placeholder{color:#6f8092}
    select{appearance:none; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:calc(100% - 12px) 50%}

    .btn{
      background:linear-gradient(180deg,#1d2a3a,#101723); border:1px solid #28364a;
      font-weight:600; letter-spacing:.02em; cursor:pointer; transition:transform .05s ease, box-shadow .2s ease, border .2s ease;
    }
    .btn:hover{box-shadow:0 6px 18px rgba(88,185,255,.15), inset 0 1px 0 #2e3c50}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .section{margin-top:18px}
    .section h2{
      font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; font-size:1.2rem; margin:0 0 12px;
      display:flex; align-items:center; gap:10px
    }
    .section h2::before{
      content:""; width:8px; height:8px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 4px #58b9ff22
    }

    .pillars{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
    @media(min-width:900px){ .pillars{grid-template-columns:repeat(4,1fr)} }
    .pillar{border:1px solid #263448; border-radius:12px; padding:12px 12px 10px; background:#0d1420;}
    .pillar .tag{display:inline-block; font-size:.78rem; padding:4px 8px; border-radius:999px; border:1px solid #2b3a4f; color:#c7d5e6; background:#0b111b}
    .pillar .big{font-size:1.5rem; font-weight:700; margin:8px 0 2px}
    .pill-meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:.88rem}

    .bars{display:grid; gap:8px}
    .bar{background:#0e1622; border:1px solid #1e2a3a; height:10px; border-radius:999px; overflow:hidden}
    .bar>i{display:block; height:100%}
    .wood{background:#2e8b57} .fire{background:#ff5d3a} .earth{background:#caa563} .metal{background:#79a7ff} .water{background:#3aa9ff}

    .desc{color:#cfd9e6; line-height:1.8}
    .muted{color:var(--muted)}
    .ul{margin:.4rem 0 0; padding-left:1.1rem; text-align:left}
    .ul li{margin:.2rem 0}
    footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}
    .error{color:#ff8f8f}
  </style>
</head>
<body>
  <div class="glow"></div>
  <header>
    <div class="head-inner container">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="subtitle">免费版 · 全面不深 | VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 表单 -->
    <section class="card stack">
      <div class="row">
        <input id="name" placeholder="姓名（可选）">
        <select id="gender">
          <option value="" disabled selected>选择性别</option>
          <option value="male">男性</option><option value="female">女性</option>
        </select>
      </div>
      <div class="row">
        <input type="datetime-local" id="datetime">
        <select id="calendar">
          <option value="gregorian">阳历 / Gregorian</option>
          <option value="lunar" disabled>农历 / Lunar（即将支持）</option>
        </select>
      </div>
      <button class="btn" id="genBtn" onclick="showReport(event)">生成八字</button>
      <div class="muted">提示：当前默认东八区时间。若出生地非东八区，后续将支持时区换算。</div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <!-- 结果 -->
    <section id="result" style="display:none;" class="stack">
      <div class="card section">
        <h2>八字命理排盘</h2>
        <div class="pillars" id="bazi-pillars"><!-- JS填充 --></div>
        <div class="muted" id="bazi-date"></div>
        <div class="muted" id="bazi-day-master"></div>
        <div class="muted" id="bazi-element"></div>
      </div>

      <div class="card section">
        <h2>五行分析</h2>
        <div class="bars">
          <div class="bar"><i id="bar-wood"  class="wood"  style="width:0%"></i></div>
          <div class="bar"><i id="bar-fire"  class="fire"  style="width:0%"></i></div>
          <div class="bar"><i id="bar-earth" class="earth" style="width:0%"></i></div>
          <div class="bar"><i id="bar-metal" class="metal" style="width:0%"></i></div>
          <div class="bar"><i id="bar-water" class="water" style="width:0%"></i></div>
        </div>
        <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
        <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
      </div>

      <div class="card section">
        <h2>命格简评</h2>
        <div class="desc" id="bazi-advice"></div>
        <ul class="ul" id="fate-points"></ul>
      </div>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

  <script>
    // ---------- 渲染工具 ----------
    function renderPillars(pillars){
      const wrap = document.getElementById("bazi-pillars");
      if (!Array.isArray(pillars)) { wrap.innerHTML = "<div class='muted'>无四柱数据</div>"; return; }
      wrap.innerHTML = pillars.map(p=>{
        const se = p.stem_element || "—";
        const be = p.branch_element || "—";
        const el = p.element || "—";
        const colorClass = {木:"wood",火:"fire",土:"earth",金:"metal",水:"water"}[el] || "";
        return `
          <div class="pillar">
            <span class="tag">${p.title||"—"}</span>
            <div class="big">${p.heavenly_stem||"—"}${p.earthly_branch||"—"}</div>
            <div class="pill-meta">
              <span>天干：${p.heavenly_stem||"—"}（${se}）</span>
              <span>地支：${p.earthly_branch||"—"}（${be}）</span>
              <span class="tag ${colorClass}">五行：${el}</span>
            </div>
            <div class="muted" style="margin-top:6px">纳音：${p.nayin||"—"}</div>
          </div>`;
      }).join("");
    }
    function renderBars(counts){
      const total = Math.max(1, (counts["木"]||0)+(counts["火"]||0)+(counts["土"]||0)+(counts["金"]||0)+(counts["水"]||0));
      const pct = k => Math.round((counts[k]||0)*100/total);
      document.getElementById("bar-wood").style.width  = pct("木")+"%";
      document.getElementById("bar-fire").style.width  = pct("火")+"%";
      document.getElementById("bar-earth").style.width = pct("土")+"%";
      document.getElementById("bar-metal").style.width = pct("金")+"%";
      document.getElementById("bar-water").style.width = pct("水")+"%";
    }
    function applyPrettyLayout(data){
      renderPillars(data.pillars||[]);
      renderBars(data.elements_count_8||{});
      document.getElementById("bazi-date").textContent =
        `出生时间：${data.solar_date||"—"} ${data.birth_time||"—"}　生肖：${data.year_animal||"—"}`;
      document.getElementById("bazi-day-master").textContent =
        `日主：${data.day_master||"—"}（${data.day_master_element||"—"}）　格局：${data.structure||"—"}`;
      document.getElementById("bazi-element").textContent = `五行总结：${data.elements_balance||"—"}`;

      const desc = document.getElementById("bazi-advice");
      desc.innerHTML =
        `<strong>性格特点：</strong>${data.personality_traits||"—"}<br>`+
        `<strong>适合领域：</strong>${data.career_suggestions||"—"}<br>`+
        `<strong>人际建议：</strong>${data.relationships_advice||"—"}<br>`+
        `<strong>五行协调：</strong>${data.coordination_advice||"—"}<br>`+
        `<strong>日柱简评：</strong>${data.day_pillar_note||"—"}<br>`+
        `<strong>幸运：</strong>${data.lucky_colors||"—"} / ${data.lucky_directions||"—"} / ${data.lucky_numbers||"—"}`;

      document.getElementById("bazi-elements-balance").textContent = data.strength_description || "";
      document.getElementById("bazi-strengths").textContent = data.tips || "";

      const fp = document.getElementById("fate-points");
      fp.innerHTML = (data.fate_points||[]).map(s=>`<li>${s}</li>`).join("");

      document.getElementById("result").style.display = "grid";
    }

    // ---------- 交互 ----------
    async function showReport(e){
      const btn = document.getElementById("genBtn");
      const err = document.getElementById("error");
      err.style.display="none"; err.textContent="";
      const gender = document.getElementById("gender").value;
      const datetime = document.getElementById("datetime").value;

      if (!gender) { err.textContent="请选择性别"; err.style.display="block"; return; }
      if (!datetime){ err.textContent="请填写出生日期时间"; err.style.display="block"; return; }

      const [birth_date, birth_time] = datetime.split("T");
      const old = btn.textContent; btn.disabled = true; btn.textContent = "生成中…";

      try{
        const res = await fetch("https://api.5xliving.com/bazi", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ birth_date, birth_time, gender })
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`API错误（${res.status}）：${t}`);
        }
        const data = await res.json();
        applyPrettyLayout(data);
        window.scrollTo({ top: document.getElementById("result").offsetTop - 12, behavior: "smooth" });
      }catch(ex){
        err.textContent = "请求失败：" + ex.message;
        err.style.display="block";
      }finally{
        btn.disabled = false; btn.textContent = old;
      }
    }

    // 初始化默认时间
    window.addEventListener("DOMContentLoaded", ()=>{
      const el = document.getElementById("datetime");
      if (el) el.value = new Date().toISOString().slice(0,16);
    });
  </script>
</body>
</html>
