<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="icon" href="data:,"> <!-- 避免 favicon 404 -->
<style>
:root {
  --bg: #0b0f14; --card: #11161dcc; --text: #e8edf3; --muted: #9aa3b2;
  --brand: #d4af37; --gold2: #f2d27a; --radius: 14px; --shadow: 0 8px 30px rgba(0,0,0,.35);
  --accent:#3a86ff;
}
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6}
.container{max-width:1060px;margin:0 auto;padding:24px 16px 64px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
.h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
.h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
.muted{color:var(--muted)}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
.bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">命理供门 · 八字简评（修复版）</div>
    <div class="muted">免费区也要好懂 · 已修复按钮与月/日/时柱算法</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender"><option value="">不透露</option><option value="male">男性</option><option value="female">女性</option></select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar"><option value="gregorian">阳历 / Gregorian</option><option value="lunar">农历 / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> 出生时间不详</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">说明：暂以东八区（UTC+8）推算；后续将支持按出生地换算与农历输入。</div>
    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</main>

<script>
(() => {
  // —— 只绑定一次：生成按钮 ——
  document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    document.getElementById('birthdate').value = today.toISOString().split('T')[0];
    document.getElementById('genBtn').addEventListener('click', onGenerate);
  });

  // —— 八字计算器（校正：立春起年、节气起月；1900-01-31=甲辰；时干从子时起）
  class BaziCalculator {
    constructor() {
      this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
      this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
      this.ZODIAC = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
      this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
    }
    // 近似节气边界（mmdd），用于确定“节令月序”：寅月=1 → 丑月=12
    solarMonthIndex(y,m,d){
      const mmdd = m*100 + d;
      const gates = [
        [204,'寅',1],[306,'卯',2],[405,'辰',3],[506,'巳',4],[606,'午',5],[707,'未',6],
        [808,'申',7],[908,'酉',8],[1008,'戌',9],[1107,'亥',10],[1207,'子',11],[106,'丑',12]
      ];
      // 找到最后一个不大于当前 mmdd 的阈值
      let pick = gates[ gates.length-1 ];
      for(const g of gates){ if(mmdd >= g[0]) pick = g; }
      return { branch: pick[1], index: pick[2] };
    }
    // 年柱：若在立春(2/4)前，以前一年计（干支年从立春起）
    calculateYearPillar(year, month, day){
      const mmdd = month*100 + day;
      const useYear = (mmdd < 204) ? year - 1 : year;
      const stemIndex = (useYear - 4) % 10;
      const branchIndex = (useYear - 4) % 12;
      return {
        stem: this.HEAVENLY_STEMS[(stemIndex+10)%10],
        branch: this.EARTHLY_BRANCHES[(branchIndex+12)%12],
        zodiac: this.ZODIAC[(branchIndex+12)%12]
      };
    }
    // 月柱：寅月为 1，干从“甲己丙寅、乙庚戊寅、丙辛庚寅、丁壬壬寅、戊癸甲寅”推
    calculateMonthPillar(year, month, day){
      const {branch, index} = this.solarMonthIndex(year, month, day);
      const yearStem = this.calculateYearPillar(year, month, day).stem;
      const yIdx = this.HEAVENLY_STEMS.indexOf(yearStem);
      const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIndex = (startMap[yIdx] + (index-1)) % 10;
      return { stem: this.HEAVENLY_STEMS[stemIndex], branch };
    }
    // 日柱：以 1900-01-31 为甲辰日
    calculateDayPillar(year, month, day){
      const base = new Date(1900,0,31); // 甲辰
      const target = new Date(year, month-1, day);
      const diff = Math.floor((target - base)/(1000*60*60*24));
      const stem = this.HEAVENLY_STEMS[(0 + diff)%10];
      const branch = this.EARTHLY_BRANCHES[(4 + diff)%12];
      return { stem, branch };
    }
    // 时柱：按日干定起始，子时为第 0 段，每两小时一段
    calculateHourPillar(dayStem, hour){
      const branchMap = {23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
      const startMap = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex = Math.floor((hour + 1)/2) % 12; // 子=0 … 午=6 …
      const stem = this.HEAVENLY_STEMS[(startMap[dIdx] + hourIndex)%10];
      return { stem, branch: branchMap[hour] };
    }
    getElement(stem, branch){
      const se = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
      const be = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
      return `${se[stem]}${be[branch]}`;
    }
    getNayin(stem, branch){
      const si = this.HEAVENLY_STEMS.indexOf(stem);
      const bi = this.EARTHLY_BRANCHES.indexOf(branch);
      return this.NAYIN[(si*2 + bi) % this.NAYIN.length];
    }
    analyzeElements(b){
      const tally = {'木':0,'火':0,'土':0,'金':0,'水':0};
      for(const k of ['year','month','day','hour']){ const s=b[k].stem, br=b[k].branch; if(s!=='？'){tally[this.getElement(s,'子').charAt(0)]++;} if(br!=='？'){tally[this.getElement('甲',br).charAt(1)]++;} }
      return tally;
    }
  }
  const calc = new BaziCalculator();

  function onGenerate(){
    const birthdate = document.getElementById('birthdate').value;
    const birthtime = document.getElementById('birthtime').value;
    const timeUnknown = document.getElementById('timeUnknown').checked;
    if(!birthdate){ return showError('请选择出生日期'); }

    toggleLoading(true);
    try{
      const d = new Date(birthdate);
      const Y = d.getFullYear(), M = d.getMonth()+1, D = d.getDate();
      let H = 12; if(!timeUnknown && birthtime){ H = parseInt(birthtime.split(':')[0],10); }

      const yearP = calc.calculateYearPillar(Y,M,D);
      const monthP = calc.calculateMonthPillar(Y,M,D);
      const dayP = calc.calculateDayPillar(Y,M,D);
      const hourP = timeUnknown ? {stem:'？',branch:'？'} : calc.calculateHourPillar(dayP.stem,H);
      const bazi = {year:yearP, month:monthP, day:dayP, hour:hourP};

      // —— 渲染 ——
      renderBazi(bazi, Y,M,D,H, timeUnknown);

      // 控台校验：1978-02-21 12 应为 戊午 / 甲寅 / 甲寅 / 庚午
      console.log('校验样例 1978-02-21 12 =>', bazi);
    }catch(e){
      console.error(e); showError('计算八字时出现错误');
    }finally{ toggleLoading(false); }
  }

  function toggleLoading(loading){
    document.getElementById('genBtnText').style.display = loading ? 'none' : 'inline';
    document.getElementById('genBtnLoading').style.display = loading ? 'inline' : 'none';
  }
  function showError(msg){ const box=document.getElementById('error'); box.textContent=msg; box.style.display='block'; setTimeout(()=>box.style.display='none', 4000); }

  function renderBazi(b, Y,M,D,H, timeUnknown){
    document.getElementById('result').style.display='block';

    const pillars = [
      {title:'年柱',stem:b.year.stem,branch:b.year.branch},
      {title:'月柱',stem:b.month.stem,branch:b.month.branch},
      {title:'日柱',stem:b.day.stem,branch:b.day.branch},
      {title:'时柱',stem:b.hour.stem,branch:b.hour.branch}
    ];
    const box = document.getElementById('bazi-pillars');
    box.innerHTML = '';
    pillars.forEach(p => { const el=document.createElement('div'); el.className='pillar'; el.innerHTML=`<div class="tit">${p.title}</div><div class="gz">${p.stem}${p.branch}</div>`; box.appendChild(el); });

    // 表格
    document.getElementById('year-stem').textContent=b.year.stem;
    document.getElementById('year-branch').textContent=b.year.branch;
    document.getElementById('month-stem').textContent=b.month.stem;
    document.getElementById('month-branch').textContent=b.month.branch;
    document.getElementById('day-stem').textContent=b.day.stem;
    document.getElementById('day-branch').textContent=b.day.branch;
    document.getElementById('hour-stem').textContent=b.hour.stem;
    document.getElementById('hour-branch').textContent=b.hour.branch;

    document.getElementById('year-element').textContent = calc.getElement(b.year.stem,b.year.branch);
    document.getElementById('month-element').textContent = calc.getElement(b.month.stem,b.month.branch);
    document.getElementById('day-element').textContent = calc.getElement(b.day.stem,b.day.branch);
    document.getElementById('hour-element').textContent = (timeUnknown?'未知':calc.getElement(b.hour.stem,b.hour.branch));

    document.getElementById('year-nayin').textContent = calc.getNayin(b.year.stem,b.year.branch);
    document.getElementById('month-nayin').textContent = calc.getNayin(b.month.stem,b.month.branch);
    document.getElementById('day-nayin').textContent = calc.getNayin(b.day.stem,b.day.branch);
    document.getElementById('hour-nayin').textContent = (timeUnknown?'未知':calc.getNayin(b.hour.stem,b.hour.branch));

    document.getElementById('bazi-date').textContent = `出生：${Y}年${M}月${D}日 ${timeUnknown? '时间不详' : (H+'时')}（默认 UTC+8）`;

    // 五行条形
    const tally = calc.analyzeElements(b);
    const total = Object.values(tally).reduce((a,c)=>a+c,0) || 1;
    for(const k of ['木','火','土','金','水']){
      const pct = Math.round(tally[k]/total*100);
      const bar = document.getElementById('bar-'+k); if(bar) bar.style.width = pct+'%';
      const txt = document.getElementById('pct-'+k); if(txt) txt.textContent = pct+'%';
    }
    const maxK = Object.keys(tally).reduce((a,b)=>tally[a]>tally[b]?a:b);
    const minK = Object.keys(tally).reduce((a,b)=>tally[a]<tally[b]?a:b);
    document.getElementById('bazi-elements-balance').textContent = `五行中「${maxK}」较强，「${minK}」较弱（仅统计四柱干支）。`;
  }
})();
</script>
</body>
</html>
