<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* æ‰€æœ‰CSSæ ·å¼ä¿æŒä¸å˜ */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* å¤´éƒ¨æ ·å¼ */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* å…«å­—æŸ±æ ·å¼ */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* äº”è¡Œèƒ½é‡æ¡ */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* æ—¶é—´è¾“å…¥è¡Œ */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* ç”ŸæˆæŒ‰é’®åŒ…è£… */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* è¯¦ç»†åˆ†æåŒºåŸŸ */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* å¤§è¿æµå¹´ */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* ä¼šå‘˜åŒºåŸŸ */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    /* VIPç™»å½•åŒºåŸŸ */
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AIç®¡å®¶æ ·å¼ */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* è¯¦ç»†åˆ†æé¡µé¢æ ·å¼ */
    .detail-view {display: none;}
    .detail-header {display: flex; align-items: center; gap: 12px; margin-bottom: 20px;}
    .back-btn {background: rgba(212,175,55,.1); border: 1px solid rgba(212,175,55,.3); color: var(--gold2); padding: 8px 16px; border-radius: 8px; cursor: pointer;}
    .detail-content {line-height: 1.8;}
    .detail-section {margin-bottom: 24px;}
    .detail-section h4 {color: var(--gold2); margin-bottom: 12px; font-size: 1.1rem;}
    .action-list {list-style: none; padding: 0;}
    .action-list li {margin-bottom: 8px; padding-left: 20px; position: relative;}
    .action-list li:before {content: "â€¢"; color: var(--gold2); position: absolute; left: 0;}
    
    /* èŠå¤©æµ®çª— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
       position:absolute !important;
       width:1px;height:1px;padding:0;margin:-1px;
       overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* æ·»åŠ åˆ°CSSä¸­ */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
      justify-content: center;
    }

    /* åœ¨CSSéƒ¨åˆ†æ·»åŠ VIPåŒºåŸŸçš„ç‰¹æ®Šç±» */
     .vip-section {
      display: block !important; /* ç¡®ä¿VIPåŒºåŸŸå§‹ç»ˆæ˜¾ç¤º */
    }

  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç®€è¯„</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- å…«å­—æ’ç›˜è¡¨å• -->
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar">
          <option value="gregorian">é˜³å†</option>
          <option value="lunar">å†œå†</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <div class="time-row">
          <input type="time" id="birthtime" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- è¯¦ç»†åˆ†æåŒºåŸŸ -->
    <div class="card">
      <div class="h2">ğŸ§™â€â™‚ï¸ å‘½ä¸»åŸºæœ¬ä¿¡æ¯</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>ğŸ” æ€»ä½“å‘½è¿è§£è¯»</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’¼ äº‹ä¸šåˆ†æ</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’° è´¢å¯ŒçŠ¶å†µ</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>â¤ï¸ å©šå§»æ„Ÿæƒ…</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- å¤§è¿æµå¹´ -->
    <div class="card">
      <div class="h2">ğŸ“ˆ å¤§è¿æµå¹´åˆ†æ</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>

    <!-- AIç®¡å®¶åŒºåŸŸ -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">å¿ƒæ€œç®¡å®¶ Â· æ·±åº¦è§£è¯»</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>

          <!-- è¯¦ç»†åˆ†æé¡µé¢ -->
    <div id="detailView" class="card detail-view">
      <div class="detail-header">
        <button class="back-btn" id="backBtn">â† è¿”å›ä¸»åˆ†æ</button>
        <h2 id="detailTitle">è¯¦ç»†åˆ†æ</h2>
      </div>
      <div class="detail-content" id="detailContent"></div>
    </div>
  
      <!-- äº¤äº’èŠ¯ç‰‡åŒºåŸŸ -->
      <div class="chips" id="aiChips" style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
        <button class="chip" data-type="career">è¯¦ç»†äº‹ä¸šåˆ†æ</button>
        <button class="chip" data-type="wealth">è´¢è¿æŠ•èµ„å»ºè®®</button>
        <button class="chip" data-type="marriage">å©šå§»æ„Ÿæƒ…è§£è¯»</button>
        <button class="chip" data-type="health">å¥åº·å…»ç”ŸæŒ‡å¯¼</button>
        <button class="chip" data-type="luck">æµå¹´è¿åŠ¿é¢„æµ‹</button>
      </div>
    </div>

  </section>    
    
  <!-- ä¼šå‘˜åŒºåŸŸ - ç¡®ä¿è¿™ä¸ªåŒºåŸŸå­˜åœ¨ -->
  <section class="card section vip-section">
    <h2 class="group-title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li>äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li>è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li>å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li>å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
          <li>å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li>æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
        </ul>
      </div>
    </div>

    <!-- VIPç™»å½•åŒºåŸŸ -->
    <div class="group-title" style="margin-top:14px">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é‚®ç®± Email" required />
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

<!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
<div class="panel">
  <div class="head">ä¼šå‘˜æœåŠ¡</div>
  <div class="body">
    <div class="row one">
      <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
    </div>
    <div class="row one">
      <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">â† è¿”å›å‘½ç†å•†åŸ</a>
    </div>
    <div class="muted">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
  </div>
</div>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- èŠå¤©æµ®çª— -->
<div class="ss-chat-fab" id="ssChatFab">é—®</div>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <span>5X Â· æ™ºèƒ½åŠ©æ‰‹</span>
    <span class="ss-close" id="ssChatClose">âœ•</span>
  </div>
  <div class="ss-chat-body" id="ssChatBody">
    <div class="ss-msg">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å…«å­—å‘½ç†åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ</div>
  </div>
  <div class="ss-chat-input">
    <input type="text" id="ssChatInput" placeholder="è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ">
    <button class="btn" id="ssChatSend">å‘é€</button>
  </div>
</div>

<script>
// å…«å­—è®¡ç®—å™¨ç±»ä¿æŒä¸å˜
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC=['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'}; const b={å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; }
  getBranchElement(branch){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='ï¼Ÿ')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='ï¼Ÿ')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['æœ¨']/total*100,fire:cnt['ç«']/total*100,earth:cnt['åœŸ']/total*100,metal:cnt['é‡‘']/total*100,water:cnt['æ°´']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

// å·¥å…·å‡½æ•°
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function showAuthErr(message) {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function hideAuthErr() {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
}

function lock(el, v) { if(el) el.disabled = v; }

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: 'å¹´æŸ±', pillar: pillars.year },
    { title: 'æœˆæŸ±', pillar: pillars.month },
    { title: 'æ—¥æŸ±', pillar: pillars.day },
    { title: 'æ—¶æŸ±', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === 'æ—¶æŸ±' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? 'ï¼Ÿ' : pillar.stem}${isUnknown ? 'ï¼Ÿ' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯è¡¨æ ¼
function displayDetailedInfo(pillars, timeUnknown = false) {
  // å¤©å¹²åœ°æ”¯
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : pillars.hour.branch);

  // äº”è¡Œ
  setText('year-element', baziCalculator.getElement(pillars.year.stem, pillars.year.branch));
  setText('month-element', baziCalculator.getElement(pillars.month.stem, pillars.month.branch));
  setText('day-element', baziCalculator.getElement(pillars.day.stem, pillars.day.branch));
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : baziCalculator.getElement(pillars.hour.stem, pillars.hour.branch));

  // çº³éŸ³
  setText('year-nayin', baziCalculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', baziCalculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', baziCalculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : baziCalculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// åˆ†ææ—¥ä¸»å¼ºå¼±
function analyzeDayMasterStrength(pillars, counts) {
  const dayStem = pillars.day.stem;
  const dayElement = baziCalculator.getStemElement(dayStem);
  const monthBranch = pillars.month.branch;
  
  // å­£èŠ‚åˆ¤æ–­
  const seasonMap = {
    'å¯…':'æ˜¥','å¯':'æ˜¥','è¾°':'æ˜¥',
    'å·³':'å¤','åˆ':'å¤','æœª':'å¤', 
    'ç”³':'ç§‹','é…‰':'ç§‹','æˆŒ':'ç§‹',
    'äº¥':'å†¬','å­':'å†¬','ä¸‘':'å†¬'
  };
  
  const season = seasonMap[monthBranch] || 'ä¸­';
  
  // æ—¥ä¸»å¼ºå¼±åˆ¤æ–­
  let strengthScore = counts[dayElement] || 0;
  
  // å­£èŠ‚åŠ æˆ
  if ((season === 'æ˜¥' && dayElement === 'æœ¨') ||
      (season === 'å¤' && dayElement === 'ç«') ||
      (season === 'ç§‹' && dayElement === 'é‡‘') ||
      (season === 'å†¬' && dayElement === 'æ°´')) {
    strengthScore += 2;
  }
  
  let strength, pattern;
  if (strengthScore >= 4) {
    strength = 'ææ—º';
    pattern = 'å»ºç¦„æ ¼';
  } else if (strengthScore >= 3) {
    strength = 'åæ—º'; 
    pattern = 'èº«æ—ºæ ¼';
  } else if (strengthScore >= 2) {
    strength = 'ä¸­å’Œ';
    pattern = 'ä¸­å’Œæ ¼';
  } else {
    strength = 'åå¼±';
    pattern = 'èº«å¼±æ ¼';
  }
  
  return { strength, pattern, season };
}

// ç”Ÿæˆå…«å­—å‘½ç›˜
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';

    // è®¾ç½®æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å…«å­—æŸ±å’Œè¯¦ç»†ä¿¡æ¯
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // æ›´æ–°äº”è¡Œèƒ½é‡æ¡
    setBar('bar-æœ¨', percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar('bar-ç«', percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar('bar-åœŸ', percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar('bar-é‡‘', percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar('bar-æ°´', percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡åˆ†æ
    const elementEntries = Object.entries(counts);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `äº”è¡Œä¸­${strongest}å…ƒç´ æœ€å¼ºï¼Œ${weakest}å…ƒç´ æœ€å¼±ã€‚`);

    // åˆ†ææ—¥ä¸»å¼ºå¼±
    const strengthAnalysis = analyzeDayMasterStrength(pillars, counts);

    // ç”Ÿæˆè¯¦ç»†åˆ†æ
    generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, tu);

    // ç”ŸæˆAIè§£è¯»
    generateAIInsight(pillars, percents, tu, strengthAnalysis);

    console.log('è®¡ç®—å‡ºçš„å…«å­—:', 
      pillars.year.stem + pillars.year.branch,
      pillars.month.stem + pillars.month.branch, 
      pillars.day.stem + pillars.day.branch,
      tu ? 'ï¼Ÿï¼Ÿ' : (pillars.hour.stem + pillars.hour.branch)
    );

  } catch (error) {
    console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
    showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// ç”Ÿæˆè¯¦ç»†åˆ†æ
function generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, timeUnknown) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  // åŸºæœ¬ä¿¡æ¯
  const name = $('name').value || 'æœªçŸ¥';
  const gender = $('gender').value === 'male' ? 'ç”·' : ($('gender').value === 'female' ? 'å¥³' : 'æœªé€éœ²');
  
  let basicInfo = `<p><strong>å§“åï¼š</strong>${name}</p>`;
  basicInfo += `<p><strong>æ€§åˆ«ï¼š</strong>${gender}</p>`;
  basicInfo += `<p><strong>æ—¥ä¸»ï¼š</strong>${dayStem}${dayElement}ï¼ˆ${strengthAnalysis.strength}ï¼‰</p>`;
  basicInfo += `<p><strong>æ ¼å±€ï¼š</strong>${strengthAnalysis.pattern}</p>`;
  basicInfo += `<p><strong>å­£èŠ‚ï¼š</strong>${strengthAnalysis.season}</p>`;
  
  $('basic-info').innerHTML = basicInfo;

  // åŠ¨æ€ç”Ÿæˆåˆ†æå†…å®¹
  $('overall-destiny').innerHTML = generateOverallDestiny(pillars, counts, percents, strengthAnalysis);
  $('career-analysis').innerHTML = generateCareerAnalysis(pillars, counts, strengthAnalysis);
  $('wealth-analysis').innerHTML = generateWealthAnalysis(pillars, counts, percents, strengthAnalysis);
  $('marriage-analysis').innerHTML = generateMarriageAnalysis(pillars, gender, counts, strengthAnalysis);

  // å¤§è¿æµå¹´
  generateLuckAnalysis(pillars, gender);
}

// ç”Ÿæˆå¤§è¿æµå¹´åˆ†æ - åŠ¨æ€ç‰ˆæœ¬
function generateLuckAnalysis(pillars, gender, counts, percents) {
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const luckCycles = generateDynamicLuckCycles(pillars, gender, counts, percents);
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// åŠ¨æ€ç”Ÿæˆå¤§è¿å‘¨æœŸ
function generateDynamicLuckCycles(pillars, gender, counts, percents) {
  const dayElement = pillars.day.element;
  const strength = analyzeDayMasterStrength(pillars, counts).strength;
  const strongestElement = getStrongestElement(counts);
  
  const cycles = [
    { age: '5-14å²', stage: 'childhood' },
    { age: '15-24å²', stage: 'youth' },
    { age: '25-34å²', stage: 'earlyCareer' },
    { age: '35-44å²', stage: 'midCareer' },
    { age: '45-54å²', stage: 'peak' },
    { age: '55-64å²', stage: 'retirement' }
  ];
  
  return cycles.map(cycle => ({
    age: cycle.age,
    desc: generateLuckDescription(cycle.stage, dayElement, strength, strongestElement, gender)
  }));
}

function generateLuckDescription(stage, dayElement, strength, strongestElement, gender) {
  const stageDescriptions = {
    childhood: {
      'æœ¨': 'ç«¥å¹´æ—¶æœŸæ€ç»´æ´»è·ƒï¼Œå­¦ä¹ èƒ½åŠ›å¼ºï¼Œé€‚åˆåŸ¹å…»é˜…è¯»å’Œè‰ºæœ¯å…´è¶£',
      'ç«': 'ç«¥å¹´çƒ­æƒ…å¼€æœ—ï¼Œç¤¾äº¤èƒ½åŠ›å¼ºï¼Œé€‚åˆå‚ä¸å›¢ä½“æ´»åŠ¨å’Œè¿åŠ¨',
      'åœŸ': 'ç«¥å¹´ç¨³é‡è¸å®ï¼Œä¸“æ³¨åŠ›å¼ºï¼Œé€‚åˆåŸ¹å…»è€å¿ƒå’Œç»†è‡´ä¹ æƒ¯',
      'é‡‘': 'ç«¥å¹´è‡ªå¾‹æ€§å¼ºï¼Œç›®æ ‡æ˜ç¡®ï¼Œé€‚åˆåŸ¹å…»æŠ€èƒ½å’Œæ‰è‰º',
      'æ°´': 'ç«¥å¹´æƒ³è±¡åŠ›ä¸°å¯Œï¼Œå¥½å¥‡å¿ƒå¼ºï¼Œé€‚åˆæ¢ç´¢å¤šæ ·å…´è¶£'
    },
    youth: {
      'æœ¨': 'é’å°‘å¹´æ—¶æœŸé¢†å¯¼åŠ›åˆæ˜¾ï¼Œé€‚åˆæ‹…ä»»å­¦ç”Ÿå¹²éƒ¨ï¼ŒåŸ¹å…»è´£ä»»æ„Ÿ',
      'ç«': 'é’å°‘å¹´åˆ›é€ åŠ›çˆ†å‘ï¼Œé€‚åˆå‚ä¸åˆ›æ–°é¡¹ç›®å’Œç«èµ›æ´»åŠ¨',
      'åœŸ': 'é’å°‘å¹´å­¦ä¹ æ‰å®ï¼Œé€‚åˆæ·±å…¥ä¸“ä¸šé¢†åŸŸï¼Œå»ºç«‹çŸ¥è¯†ä½“ç³»',
      'é‡‘': 'é’å°‘å¹´æ‰§è¡ŒåŠ›å¼ºï¼Œé€‚åˆå‚ä¸å®è·µé¡¹ç›®ï¼Œç§¯ç´¯ç»éªŒ',
      'æ°´': 'é’å°‘å¹´é€‚åº”åŠ›å¼ºï¼Œé€‚åˆå¤šå…ƒå‘å±•ï¼Œæ¢ç´¢äººç”Ÿæ–¹å‘'
    },
    earlyCareer: {
      'æœ¨': 'äº‹ä¸šèµ·æ­¥é˜¶æ®µï¼Œå‘æŒ¥é¢†å¯¼æ‰èƒ½ï¼Œå»ºç«‹ä¸“ä¸šå½¢è±¡',
      'ç«': 'èŒåœºçƒ­æƒ…æŠ•å…¥ï¼Œé€‚åˆæŒ‘æˆ˜æ€§å·¥ä½œï¼Œå¿«é€Ÿæˆé•¿',
      'åœŸ': 'ç¨³æ­¥å‘å±•æ—¶æœŸï¼Œä¸“æ³¨ä¸“ä¸šæŠ€èƒ½ï¼Œç§¯ç´¯è¡Œä¸šç»éªŒ',
      'é‡‘': 'è¿½æ±‚å“è¶Šé˜¶æ®µï¼Œé€‚åˆæŠ€æœ¯å²—ä½ï¼Œå»ºç«‹ä¸“ä¸šæƒå¨',
      'æ°´': 'çµæ´»é€‚åº”æ—¶æœŸï¼Œé€‚åˆå¤šå˜ç¯å¢ƒï¼Œå¯»æ‰¾æœ€ä½³å®šä½'
    },
    midCareer: {
      'æœ¨': 'äº‹ä¸šä¸Šå‡æœŸï¼Œæ‰¿æ‹…æ›´å¤§è´£ä»»ï¼ŒåŸ¹å…»å›¢é˜Ÿç®¡ç†èƒ½åŠ›',
      'ç«': 'åˆ›é€ åŠ›é«˜å³°æœŸï¼Œé€‚åˆåˆ›æ–°é¡¹ç›®ï¼Œå‘æŒ¥å½±å“åŠ›',
      'åœŸ': 'ç¨³å®šå‘å±•æœŸï¼Œæ·±è€•ä¸“ä¸šé¢†åŸŸï¼Œå»ºç«‹ä¸ªäººå“ç‰Œ',
      'é‡‘': 'æŠ€æœ¯æˆç†ŸæœŸï¼Œé€‚åˆä¸“å®¶è§’è‰²ï¼Œä¼ æˆç»éªŒçŸ¥è¯†',
      'æ°´': 'è½¬å‹å…³é”®æœŸï¼Œé€‚åˆè·¨ç•Œå‘å±•ï¼Œå¼€æ‹“æ–°é¢†åŸŸ'
    },
    peak: {
      'æœ¨': 'äººç”Ÿé»„é‡‘æœŸï¼Œç»éªŒæ™ºæ…§ä¸°å¯Œï¼Œé€‚åˆæˆ˜ç•¥å†³ç­–è§’è‰²',
      'ç«': 'å½±å“åŠ›é«˜å³°æœŸï¼Œé€‚åˆé¢†å¯¼åˆ›æ–°ï¼Œæ¨åŠ¨å˜é©',
      'åœŸ': 'æ”¶è·ç¨³å®šæœŸï¼Œäº«å—æˆæœï¼ŒåŸ¹å…»æ¥ç­äºº',
      'é‡‘': 'ä¸“ä¸šæƒå¨æœŸï¼Œé€‚åˆé¡¾é—®æŒ‡å¯¼ï¼Œä¼ æ‰¿æŠ€è‰º',
      'æ°´': 'æ™ºæ…§æˆç†ŸæœŸï¼Œé€‚åˆæ•´åˆèµ„æºï¼Œåˆ›é€ æ–°ä»·å€¼'
    },
    retirement: {
      'æœ¨': 'æ™šå¹´å……å®æœŸï¼Œç»§ç»­å‘æŒ¥ä½™çƒ­ï¼Œå‚ä¸å…¬ç›Šæ•™è‚²',
      'ç«': 'æ™šå¹´æ´»è·ƒæœŸï¼Œä¿æŒç¤¾äº¤ï¼Œåˆ†äº«äººç”Ÿç»éªŒ',
      'åœŸ': 'æ™šå¹´ç¨³å®šæœŸï¼Œäº«å—å®¶åº­ç”Ÿæ´»ï¼Œæ³¨é‡å¥åº·å…»ç”Ÿ',
      'é‡‘': 'æ™šå¹´ç²¾è‡´æœŸï¼Œè¿½æ±‚ç”Ÿæ´»å“è´¨ï¼ŒåŸ¹å…»é«˜é›…çˆ±å¥½',
      'æ°´': 'æ™šå¹´æ™ºæ…§æœŸï¼Œåæ€äººç”Ÿï¼Œä¼ æ‰¿ç²¾ç¥è´¢å¯Œ'
    }
  };
  
  const baseDesc = stageDescriptions[stage]?.[dayElement] || 'æ­¤é˜¶æ®µè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆç¨³æ­¥å‘å±•';
  const strengthAdvice = strength === 'åæ—º' || strength === 'ææ—º' ? 
    'å……åˆ†å‘æŒ¥è‡ªèº«ä¼˜åŠ¿ï¼Œç§¯æè¿›å–' : 'æ³¨é‡ç§¯ç´¯ï¼Œç¨³æ‰ç¨³æ‰“';
  const elementAdvice = strongestElement !== dayElement ? 
    `åŒæ—¶åŠ å¼º${strongestElement}å…ƒç´ ç›¸å…³èƒ½åŠ›çš„åŸ¹å…»` : '';
  
  return `${baseDesc}ã€‚${strengthAdvice}${elementAdvice}ã€‚å¿ƒæ€œç®¡å®¶å»ºè®®ï¼š${generateButlerAdvice(stage, dayElement, gender)}`;
}

function generateButlerAdvice(stage, dayElement, gender) {
  const adviceMap = {
    childhood: 'åŸ¹å…»è‰¯å¥½ä¹ æƒ¯ï¼Œå»ºç«‹æ­£ç¡®ä»·å€¼è§‚ï¼Œæ¯å¤©åšæŒå­¦ä¹ 30åˆ†é’Ÿ',
    youth: 'å‹‡äºå°è¯•ï¼Œæ‰¾åˆ°å…´è¶£æ–¹å‘ï¼Œæ¯å‘¨è®°å½•æˆé•¿å¿ƒå¾—',
    earlyCareer: 'ä¸“æ³¨æŠ€èƒ½æå‡ï¼Œå»ºç«‹äººè„‰ç½‘ç»œï¼Œæ¯æœˆå‚åŠ ä¸“ä¸šåŸ¹è®­',
    midCareer: 'å¹³è¡¡å·¥ä½œç”Ÿæ´»ï¼Œæ³¨é‡å¥åº·ç®¡ç†ï¼Œæ¯å­£åº¦è®¾å®šæ˜ç¡®ç›®æ ‡',
    peak: 'åˆ†äº«ç»éªŒæ™ºæ…§ï¼ŒåŸ¹å…»æ¥ç­äººï¼Œå…³æ³¨èº«å¿ƒå¥åº·',
    retirement: 'åŸ¹å…»å…´è¶£çˆ±å¥½ï¼Œè§„åˆ’è´¢åŠ¡ï¼Œäº«å—äººç”Ÿæˆæœ'
  };
  
  return adviceMap[stage] || 'æ ¹æ®å®é™…æƒ…å†µçµæ´»è°ƒæ•´å‘å±•ç­–ç•¥';
}

// è¯¦ç»†äº‹ä¸šåˆ†æ - åŠ¨æ€ç‰ˆæœ¬
function getCareerDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const careerFields = calculateCareerFields(dayElement, counts);
  const careerStrategy = generateCareerStrategy(dayElement, strengthAnalysis.strength, counts);
  const dailyAdvice = generateCareerDailyAdvice(dayElement, percents);
  
  return `
    <div class="detail-section">
      <h4>ğŸ¯ èŒä¸šå‘å±•æ–¹å‘</h4>
      <p>åŸºäºæ‚¨çš„${pillars.day.stem}${dayElement}æ—¥ä¸»å’Œ${strengthAnalysis.strength}æ ¼å±€ï¼Œä¸ºæ‚¨é‡èº«å®šåˆ¶èŒä¸šè§„åˆ’ï¼š</p>
      
      <p><strong>æ ¸å¿ƒä¼˜åŠ¿è¡Œä¸šï¼š</strong></p>
      <ul class="action-list">
        ${careerFields.map(field => `<li><strong>${field.category}ï¼š</strong>${field.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ“Š èŒä¸šå‘å±•ç­–ç•¥</h4>
      <p><strong>${careerStrategy.period}ï¼š</strong></p>
      <ul class="action-list">
        ${careerStrategy.strategies.map(strategy => `<li>${strategy}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ’« ä¸ªæ€§åŒ–èŒä¸šå»ºè®®</h4>
      <ul class="action-list">
        ${dailyAdvice}
      </ul>
    </div>
  `;
}

function generateCareerStrategy(dayElement, strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  const isDiverse = elementCount >= 4;
  
  const strategies = {
    'æœ¨': {
      short: ['å»ºç«‹ä¸“ä¸šæƒå¨å½¢è±¡', 'å‘å±•é¢†å¯¼ç®¡ç†èƒ½åŠ›', 'æ„å»ºè¡Œä¸šäººè„‰ç½‘ç»œ'],
      long: ['å‘æˆ˜ç•¥ç®¡ç†å²—ä½å‘å±•', 'åŸ¹å…»å›¢é˜Ÿé¢†å¯¼åŠ›', 'å»ºç«‹ä¸ªäººå“ç‰Œå½±å“åŠ›']
    },
    'ç«': {
      short: ['å‘æŒ¥åˆ›æ„åˆ›æ–°èƒ½åŠ›', 'å‚ä¸å‰æ²¿é¡¹ç›®', 'å»ºç«‹ä¸ªäººä½œå“é›†'],
      long: ['å‘åˆ›æ„æ€»ç›‘å‘å±•', 'æ‰“é€ ä¸ªäººIP', 'æ‹“å±•è·¨ç•Œåˆä½œ']
    },
    'åœŸ': {
      short: ['æ·±è€•ä¸“ä¸šæŠ€æœ¯', 'å»ºç«‹ç³»ç»ŸçŸ¥è¯†', 'è·å¾—ä¸“ä¸šè®¤è¯'],
      long: ['æˆä¸ºé¢†åŸŸä¸“å®¶', 'å»ºç«‹åŸ¹è®­ä½“ç³»', 'å¼€å‘ä¸“ä¸šäº§å“']
    },
    'é‡‘': {
      short: ['æå‡æŠ€æœ¯ä¸“é•¿', 'å‚ä¸é‡å¤§é¡¹ç›®', 'å»ºç«‹è´¨é‡æ ‡æ†'],
      long: ['æˆä¸ºæŠ€æœ¯æƒå¨', 'åˆ¶å®šè¡Œä¸šæ ‡å‡†', 'åŸ¹å…»æŠ€æœ¯å›¢é˜Ÿ']
    },
    'æ°´': {
      short: ['å‘å±•å¤šå…ƒæŠ€èƒ½', 'é€‚åº”ä¸åŒç¯å¢ƒ', 'å»ºç«‹èµ„æºç½‘ç»œ'],
      long: ['å‘ç»¼åˆç®¡ç†å‘å±•', 'æ•´åˆå¤šæ–¹èµ„æº', 'å¼€æ‹“æ–°ä¸šåŠ¡é¢†åŸŸ']
    }
  };
  
  const strategySet = strategies[dayElement] || strategies['æœ¨'];
  const period = strength === 'åå¼±' ? 'é•¿æœŸè§„åˆ’ï¼ˆ5-8å¹´ï¼‰' : 'ä¸­æœŸè§„åˆ’ï¼ˆ3-5å¹´ï¼‰';
  const baseStrategies = strength === 'åå¼±' ? strategySet.long : strategySet.short;
  
  const additional = isDiverse ? ['è€ƒè™‘è·¨ç•Œå‘å±•æœºä¼š'] : ['ä¸“æ³¨æ ¸å¿ƒä¼˜åŠ¿é¢†åŸŸ'];
  
  return {
    period: period,
    strategies: [...baseStrategies, ...additional]
  };
}

function generateCareerDailyAdvice(dayElement, percents) {
  const adviceMap = {
    'æœ¨': [
      'æ¯å¤©æ—©ä¸Šè§„åˆ’é‡ç‚¹å·¥ä½œä¼˜å…ˆçº§',
      'æ¯å‘¨ä¸è¡Œä¸šä¸“å®¶äº¤æµå­¦ä¹ ',
      'æ¯æœˆé˜…è¯»ä¸“ä¸šä¹¦ç±æå‡è®¤çŸ¥',
      'æ¯å­£åº¦å‚åŠ è¡Œä¸šä¼šè®®æ‹“å±•è§†é‡'
    ],
    'ç«': [
      'æ¯å¤©ä¿æŒåˆ›æ„è®°å½•ä¹ æƒ¯',
      'æ¯å‘¨å°è¯•æ–°æ–¹æ³•è§£å†³é—®é¢˜',
      'æ¯æœˆå‚ä¸åˆ›æ–°é¡¹ç›®è®¨è®º',
      'æ¯å­£åº¦å­¦ä¹ å‰æ²¿æŠ€æœ¯è¶‹åŠ¿'
    ],
    'åœŸ': [
      'æ¯å¤©å®Œå–„å·¥ä½œæµç¨‹ç»†èŠ‚',
      'æ¯å‘¨æ€»ç»“ä¸“ä¸šæŠ€èƒ½æå‡',
      'æ¯æœˆè¿›è¡Œä¸“ä¸šçŸ¥è¯†æ›´æ–°',
      'æ¯å­£åº¦è¯„ä¼°èŒä¸šå‘å±•è¿›åº¦'
    ],
    'é‡‘': [
      'æ¯å¤©ä¸“æ³¨æ ¸å¿ƒæŠ€æœ¯é’»ç ”',
      'æ¯å‘¨è§£å†³æŠ€æœ¯éš¾é¢˜æŒ‘æˆ˜',
      'æ¯æœˆå­¦ä¹ æ–°æŠ€æœ¯å·¥å…·',
      'æ¯å­£åº¦è¿›è¡ŒæŠ€æœ¯æˆæœå±•ç¤º'
    ],
    'æ°´': [
      'æ¯å¤©å…³æ³¨è¡Œä¸šåŠ¨æ€å˜åŒ–',
      'æ¯å‘¨æ‹“å±•æ–°çš„äººè„‰å…³ç³»',
      'æ¯æœˆå­¦ä¹ è·¨é¢†åŸŸçŸ¥è¯†',
      'æ¯å­£åº¦è¯„ä¼°èŒä¸šè½¬å‹æœºä¼š'
    ]
  };
  
  const adviceList = adviceMap[dayElement] || adviceMap['æœ¨'];
  return adviceList.map(advice => `<li>${advice}</li>`).join('');
}

// è¯¦ç»†è´¢è¿åˆ†æ - åŠ¨æ€ç‰ˆæœ¬
function getWealthDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const wealthPattern = analyzeWealthPattern(dayElement, counts, percents);
  const investmentStrategy = generateDetailedInvestmentStrategy(dayElement, counts, percents);
  const wealthActionPlan = generateWealthActionPlan(strengthAnalysis.strength, percents);
  
  return `
    <div class="detail-section">
      <h4>ğŸ’° è´¢å¯Œæ ¼å±€æ·±åº¦åˆ†æ</h4>
      <p>æ‚¨çš„${strengthAnalysis.strength}${pillars.day.stem}${dayElement}å‘½å±€åœ¨è´¢å¯Œæ–¹é¢å‘ˆç°ä»¥ä¸‹ç‰¹å¾ï¼š</p>
      
      <p><strong>è´¢è¿ç‰¹è´¨åˆ†æï¼š</strong></p>
      <ul class="action-list">
        <li><strong>è´¢å¯Œæ¥æºï¼š</strong>${wealthPattern.sources}</li>
        <li><strong>ç§¯ç´¯æ¨¡å¼ï¼š</strong>${wealthPattern.accumulation}</li>
        <li><strong>é£é™©ç‰¹å¾ï¼š</strong>${wealthPattern.risks}</li>
        <li><strong>å¢é•¿æ—¶æœºï¼š</strong>${wealthPattern.timing}</li>
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ“ˆ ä¸ªæ€§åŒ–æŠ•èµ„ç­–ç•¥</h4>
      <p><strong>åŸºäºæ‚¨çš„äº”è¡Œé…ç½®ï¼š</strong></p>
      <ul class="action-list">
        ${investmentStrategy.map(item => `<li><strong>${item.type}ï¼š</strong>${item.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ’« è´¢å¯Œå¢é•¿æ‰§è¡Œè®¡åˆ’</h4>
      <ul class="action-list">
        ${wealthActionPlan}
      </ul>
    </div>
  `;
}

function generateDetailedInvestmentStrategy(dayElement, counts, percents) {
  const weakestElement = getWeakestElement(counts);
  
  const strategies = {
    'æœ¨': [
      { type: 'æ ¸å¿ƒæŠ•èµ„', description: 'æ•™è‚²æ–‡åŒ–ã€ç¯ä¿å¥åº·ã€æ–°å…´ç§‘æŠ€é¢†åŸŸ' },
      { type: 'è¾…åŠ©é…ç½®', description: 'æˆ¿åœ°äº§ä¿¡æ‰˜ã€åŸºç¡€è®¾æ–½åŸºé‡‘' },
      { type: 'é£é™©æ§åˆ¶', description: 'é¿å…è¿‡åº¦æ æ†ï¼Œæ³¨é‡é•¿æœŸä»·å€¼' }
    ],
    'ç«': [
      { type: 'æ ¸å¿ƒæŠ•èµ„', description: 'ç§‘æŠ€åˆ›æ–°ã€èƒ½æºè½¬å‹ã€æ•°å­—åª’ä½“' },
      { type: 'è¾…åŠ©é…ç½®', description: 'è´µé‡‘å±ã€å¤§å®—å•†å“' },
      { type: 'é£é™©æ§åˆ¶', description: 'æ§åˆ¶æŠ•æœºæ¯”ä¾‹ï¼Œè®¾ç½®æ­¢æŸç‚¹' }
    ],
    'åœŸ': [
      { type: 'æ ¸å¿ƒæŠ•èµ„', description: 'æˆ¿åœ°äº§ã€å»ºç­‘å·¥ç¨‹ã€å†œä¸šé£Ÿå“' },
      { type: 'è¾…åŠ©é…ç½®', description: 'å€ºåˆ¸ã€ç¨³å®šæ”¶ç›Šäº§å“' },
      { type: 'é£é™©æ§åˆ¶', description: 'æ³¨é‡ç°é‡‘æµï¼Œé¿å…æµåŠ¨æ€§é£é™©' }
    ],
    'é‡‘': [
      { type: 'æ ¸å¿ƒæŠ•èµ„', description: 'é‡‘èç§‘æŠ€ã€é«˜ç«¯åˆ¶é€ ã€ç²¾å¯†æŠ€æœ¯' },
      { type: 'è¾…åŠ©é…ç½®', description: 'å¤–æ±‡ã€æ•°å­—è´§å¸' },
      { type: 'é£é™©æ§åˆ¶', description: 'åˆ†æ•£æŠ•èµ„ï¼Œé¿å…æŠ€æœ¯é£é™©' }
    ],
    'æ°´': [
      { type: 'æ ¸å¿ƒæŠ•èµ„', description: 'ç‰©æµè´¸æ˜“ã€æ—…æ¸¸æœåŠ¡ã€å’¨è¯¢æœåŠ¡' },
      { type: 'è¾…åŠ©é…ç½®', description: 'æµ·å¤–èµ„äº§ã€è·¨å›½ä¼ä¸š' },
      { type: 'é£é™©æ§åˆ¶', description: 'å…³æ³¨æ±‡ç‡é£é™©ï¼Œä¿æŒçµæ´»æ€§' }
    ]
  };
  
  const baseStrategy = strategies[dayElement] || strategies['æœ¨'];
  
  // æ ¹æ®æœ€å¼±å…ƒç´ æ·»åŠ è¡¥å……å»ºè®®
  if (weakestElement && weakestElement !== dayElement) {
    const supplement = {
      'æœ¨': 'é€‚å½“é…ç½®æˆé•¿å‹èµ„äº§',
      'ç«': 'å¢åŠ ä¸€äº›è¿›å–å‹æŠ•èµ„',
      'åœŸ': 'åŠ å¼ºç¨³å®šæ”¶ç›Šé…ç½®',
      'é‡‘': 'æ³¨é‡ä»·å€¼æŠ•èµ„æœºä¼š',
      'æ°´': 'ä¿æŒæŠ•èµ„ç»„åˆæµåŠ¨æ€§'
    };
    baseStrategy.push({ type: 'å¹³è¡¡å»ºè®®', description: supplement[weakestElement] });
  }
  
  return baseStrategy;
}

function generateWealthActionPlan(strength, percents) {
  const elementCount = Object.values(percents).filter(p => p > 10).length;
  const isBalanced = elementCount >= 3;
  
  const basePlan = [
    'å»ºç«‹æœˆåº¦æ”¶æ”¯é¢„ç®—ä½“ç³»',
    'è®¾å®šæ˜ç¡®çš„è´¢åŠ¡ç›®æ ‡',
    'å®šæœŸè¿›è¡ŒæŠ•èµ„ç»„åˆè¯„ä¼°'
  ];
  
  const strengthPlan = strength === 'åæ—º' || strength === 'ææ—º' ? [
    'ç§¯æå¯»æ‰¾æŠ•èµ„æœºä¼š',
    'é€‚å½“æ‰¿æ‹…è®¡ç®—è¿‡çš„é£é™©',
    'å»ºç«‹å¤šå…ƒæ”¶å…¥æ¥æº'
  ] : [
    'æ³¨é‡å‚¨è“„ç§¯ç´¯',
    'é€‰æ‹©ç¨³å¥æŠ•èµ„äº§å“',
    'å»ºç«‹åº”æ€¥å‚¨å¤‡é‡‘'
  ];
  
  const balancePlan = isBalanced ? [
    'å‡è¡¡é…ç½®å„ç±»èµ„äº§',
    'å…³æ³¨æ•´ä½“æŠ•èµ„å›æŠ¥'
  ] : [
    'é‡ç‚¹åŠ å¼ºä¼˜åŠ¿é¢†åŸŸæŠ•èµ„',
    'é€‚å½“è¡¥å……å¼±åŠ¿å…ƒç´ ç›¸å…³é…ç½®'
  ];
  
  return [...basePlan, ...strengthPlan, ...balancePlan]
    .map(item => `<li>${item}</li>`)
    .join('');
}

// è¯¦ç»†å©šå§»åˆ†æ - åŠ¨æ€ç‰ˆæœ¬
function getMarriageDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const gender = $('gender').value;
  const relationshipAnalysis = analyzeRelationshipDynamics(dayElement, gender, counts);
  const partnerCompatibility = generatePartnerCompatibility(dayElement, counts);
  const relationshipAdvice = generateRelationshipAdvice(dayElement, strengthAnalysis.strength, gender);
  
  return `
    <div class="detail-section">
      <h4>â¤ï¸ æ„Ÿæƒ…å©šå§»æ·±åº¦è§£æ</h4>
      <p>æ‚¨çš„${pillars.day.stem}${dayElement}æ—¥ä¸»åœ¨æ„Ÿæƒ…æ–¹é¢å‘ˆç°ä»¥ä¸‹èƒ½é‡ç‰¹å¾ï¼š</p>
      
      <p><strong>æ„Ÿæƒ…æ¨¡å¼åˆ†æï¼š</strong></p>
      <ul class="action-list">
        <li><strong>æƒ…æ„Ÿè¡¨è¾¾ï¼š</strong>${relationshipAnalysis.expression}</li>
        <li><strong>å…³ç³»éœ€æ±‚ï¼š</strong>${relationshipAnalysis.needs}</li>
        <li><strong>ç›¸å¤„æ¨¡å¼ï¼š</strong>${relationshipAnalysis.pattern}</li>
        <li><strong>å‘å±•æ—¶æœºï¼š</strong>${relationshipAnalysis.timing}</li>
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ’‘ ç†æƒ³ä¼´ä¾£åŒ¹é…æŒ‡å—</h4>
      <p><strong>åŸºäºæ‚¨çš„å‘½å±€ç‰¹è´¨ï¼š</strong></p>
      <ul class="action-list">
        ${partnerCompatibility.map(item => `<li><strong>${item.aspect}ï¼š</strong>${item.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ’« æ„Ÿæƒ…å¹¸ç¦ä¿®è¡Œæ–¹æ¡ˆ</h4>
      <ul class="action-list">
        ${relationshipAdvice}
      </ul>
    </div>
  `;
}

function analyzeRelationshipDynamics(dayElement, gender, counts) {
  const stemRelationship = {
    'ç”²': { expression: 'ç›´æ¥å¦ç‡ï¼Œé‡è§†æ‰¿è¯º', needs: 'éœ€è¦å°Šé‡å’Œè®¤å¯', pattern: 'ä¸»åŠ¨å¼•å¯¼å‹' },
    'ä¹™': { expression: 'æ¸©å’Œç»†è…»ï¼Œæ³¨é‡ç»†èŠ‚', needs: 'éœ€è¦å®‰å…¨æ„Ÿå’Œå…³æ€€', pattern: 'åè°ƒé…åˆå‹' },
    'ä¸™': { expression: 'çƒ­æƒ…ä¸»åŠ¨ï¼Œè¿½æ±‚æµªæ¼«', needs: 'éœ€è¦æ¿€æƒ…å’Œæ–°é²œæ„Ÿ', pattern: 'æ¿€æƒ…æŠ•å…¥å‹' },
    'ä¸': { expression: 'ä¸“ä¸€æ‰§ç€ï¼Œå¿ƒæ€ç¼œå¯†', needs: 'éœ€è¦æ·±åº¦ç†è§£å’Œä¿¡ä»»', pattern: 'ä¸“æ³¨å®ˆæŠ¤å‹' },
    'æˆŠ': { expression: 'ç¨³é‡å¯é ï¼Œè´£ä»»å¿ƒå¼º', needs: 'éœ€è¦ç¨³å®šå’Œå½’å±æ„Ÿ', pattern: 'åŠ¡å®å»ºè®¾å‹' },
    'å·±': { expression: 'åŒ…å®¹ä½“è´´ï¼Œå–„è§£äººæ„', needs: 'éœ€è¦å’Œè°å’Œæ¸©æš–', pattern: 'æœåŠ¡æ”¯æŒå‹' },
    'åºš': { expression: 'åšæ¯…æœæ–­ï¼Œè¦æ±‚æ˜ç¡®', needs: 'éœ€è¦ç©ºé—´å’Œç‹¬ç«‹æ€§', pattern: 'ç†æ€§ä¸»å¯¼å‹' },
    'è¾›': { expression: 'è¿½æ±‚å®Œç¾ï¼Œæ³¨é‡å“è´¨', needs: 'éœ€è¦ç²¾è‡´å’Œç²¾ç¥å…±é¸£', pattern: 'ç²¾è‡´è¿½æ±‚å‹' },
    'å£¬': { expression: 'çµæ´»å¤šå˜ï¼Œé€‚åº”æ€§å¼º', needs: 'éœ€è¦è‡ªç”±å’Œå˜åŒ–', pattern: 'æµåŠ¨é€‚åº”å‹' },
    'ç™¸': { expression: 'æ¸©å’Œå†…æ•›ï¼Œå¿ƒæ€ç»†è…»', needs: 'éœ€è¦ç†è§£å’Œè€å¿ƒ', pattern: 'ç»†è…»æ„ŸçŸ¥å‹' }
  };
  
  const baseAnalysis = stemRelationship[dayElement] || stemRelationship['ç”²'];
  const genderAdjustment = gender === 'ç”·' ? 'å€¾å‘äºä¸»åŠ¨è¿½æ±‚' : gender === 'å¥³' ? 'å€¾å‘äºè°¨æ…é€‰æ‹©' : 'æ ¹æ®å®é™…æƒ…å†µå‘å±•';
  
  return {
    expression: `${baseAnalysis.expression}ï¼Œ${genderAdjustment}`,
    needs: baseAnalysis.needs,
    pattern: baseAnalysis.pattern,
    timing: calculateRelationshipTiming(counts)
  };
}

function calculateRelationshipTiming(counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  if (elementCount <= 2) return 'å»ºè®®28å²åè€ƒè™‘å©šå§»ï¼Œå…ˆå®Œå–„è‡ªæˆ‘';
  if (elementCount >= 4) return '25-30å²æ˜¯ç†æƒ³å©šæ‹æ—¶æœŸ';
  return '26-32å²æ„Ÿæƒ…å‘å±•è¾ƒä¸ºé¡ºåˆ©';
}

function generatePartnerCompatibility(dayElement, counts) {
  const weakestElement = getWeakestElement(counts);
  
  const compatibilityMap = {
    'æœ¨': [
      { aspect: 'æ€§æ ¼äº’è¡¥', description: 'é€‚åˆä¸ç¨³é‡è¸å®çš„ä¼´ä¾£ç›¸å¤„' },
      { aspect: 'èƒ½åŠ›åŒ¹é…', description: 'éœ€è¦æ‰§è¡ŒåŠ›å¼ºçš„åˆä½œä¼™ä¼´' },
      { aspect: 'æƒ…æ„Ÿæ”¯æŒ', description: 'å¯»æ±‚æ¸©æŸ”ä½“è´´çš„æƒ…æ„Ÿå…³æ€€' }
    ],
    'ç«': [
      { aspect: 'æ€§æ ¼äº’è¡¥', description: 'é€‚åˆä¸ç†æ€§å†·é™çš„ä¼´ä¾£ç›¸å¤„' },
      { aspect: 'èƒ½åŠ›åŒ¹é…', description: 'éœ€è¦ç»†è‡´å‘¨åˆ°çš„ç”Ÿæ´»ä¼™ä¼´' },
      { aspect: 'æƒ…æ„Ÿæ”¯æŒ', description: 'å¯»æ±‚ç¨³å®šå¯é çš„æƒ…æ„Ÿä¾æ‰˜' }
    ],
    'åœŸ': [
      { aspect: 'æ€§æ ¼äº’è¡¥', description: 'é€‚åˆä¸çµæ´»å˜é€šçš„ä¼´ä¾£ç›¸å¤„' },
      { aspect: 'èƒ½åŠ›åŒ¹é…', description: 'éœ€è¦åˆ›æ„ä¸°å¯Œçš„æ€ç»´ä¼™ä¼´' },
      { aspect: 'æƒ…æ„Ÿæ”¯æŒ', description: 'å¯»æ±‚æ¿€æƒ…æµªæ¼«çš„æƒ…æ„Ÿä½“éªŒ' }
    ],
    'é‡‘': [
      { aspect: 'æ€§æ ¼äº’è¡¥', description: 'é€‚åˆä¸æ¸©å’ŒåŒ…å®¹çš„ä¼´ä¾£ç›¸å¤„' },
      { aspect: 'èƒ½åŠ›åŒ¹é…', description: 'éœ€è¦æ„Ÿæ€§ç›´è§‰çš„æƒ…æ„Ÿä¼™ä¼´' },
      { aspect: 'æƒ…æ„Ÿæ”¯æŒ', description: 'å¯»æ±‚æ¸©æš–ä½“è´´çš„æƒ…æ„Ÿå…³æ€€' }
    ],
    'æ°´': [
      { aspect: 'æ€§æ ¼äº’è¡¥', description: 'é€‚åˆä¸åšå®šæœæ–­çš„ä¼´ä¾£ç›¸å¤„' },
      { aspect: 'èƒ½åŠ›åŒ¹é…', description: 'éœ€è¦ç›®æ ‡æ˜ç¡®çš„è¡ŒåŠ¨ä¼™ä¼´' },
      { aspect: 'æƒ…æ„Ÿæ”¯æŒ', description: 'å¯»æ±‚å®‰å…¨ç¨³å®šçš„æƒ…æ„ŸåŸºç¡€' }
    ]
  };
  
  const baseCompatibility = compatibilityMap[dayElement] || compatibilityMap['æœ¨'];
  
  // æ ¹æ®æœ€å¼±å…ƒç´ æ·»åŠ è¡¥å……å»ºè®®
  if (weakestElement && weakestElement !== dayElement) {
    const elementAdvice = {
      'æœ¨': 'ä¼´ä¾£æœ€å¥½å…·å¤‡å†³æ–­åŠ›å’Œè¡ŒåŠ¨åŠ›',
      'ç«': 'ä¼´ä¾£æœ€å¥½å…·å¤‡è€å¿ƒå’Œç¨³å®šæ€§',
      'åœŸ': 'ä¼´ä¾£æœ€å¥½å…·å¤‡çµæ´»æ€§å’Œåˆ›æ„',
      'é‡‘': 'ä¼´ä¾£æœ€å¥½å…·å¤‡åŒ…å®¹å¿ƒå’Œæ¸©æš–',
      'æ°´': 'ä¼´ä¾£æœ€å¥½å…·å¤‡ç›®æ ‡æ„Ÿå’Œåšå®šæ€§'
    };
    baseCompatibility.push({ aspect: 'äº”è¡Œå¹³è¡¡', description: elementAdvice[weakestElement] });
  }
  
  return baseCompatibility;
}

function generateRelationshipAdvice(dayElement, strength, gender) {
  const adviceMap = {
    'æœ¨': [
      'å­¦ä¹ å€¾å¬ä¼´ä¾£çš„æƒ³æ³•å’Œæ„Ÿå—',
      'åœ¨å…³ç³»ä¸­ä¿æŒé€‚å½“çš„çµæ´»æ€§',
      'å®šæœŸè¿›è¡Œæ·±åº¦æƒ…æ„Ÿäº¤æµ',
      'å…±åŒåˆ¶å®šäººç”Ÿå‘å±•è§„åˆ’'
    ],
    'ç«': [
      'åŸ¹å…»å…³ç³»ä¸­çš„è€å¿ƒå’Œç¨³å®šæ€§',
      'å­¦ä¹ ç†æ€§å¤„ç†æ„Ÿæƒ…é—®é¢˜',
      'ä¿æŒé€‚åº¦çš„ä¸ªäººç©ºé—´',
      'å»ºç«‹å…±åŒçš„ç”Ÿæ´»ä»ªå¼æ„Ÿ'
    ],
    'åœŸ': [
      'åœ¨å…³ç³»ä¸­å¢åŠ ä¸€äº›æµªæ¼«å…ƒç´ ',
      'å­¦ä¹ è¡¨è¾¾å†…å¿ƒçœŸå®æƒ…æ„Ÿ',
      'å°è¯•æ–°çš„ç›¸å¤„æ–¹å¼',
      'åŸ¹å…»å…±åŒçš„å…´è¶£çˆ±å¥½'
    ],
    'é‡‘': [
      'å­¦ä¹ è¡¨è¾¾æ¸©æŸ”å’Œå…³æ€€',
      'åœ¨å…³ç³»ä¸­ä¿æŒå¼€æ”¾çš„å¿ƒæ€',
      'æ³¨é‡æƒ…æ„Ÿç»†èŠ‚çš„è¡¨è¾¾',
      'åŸ¹å…»å…±åŒçš„ç²¾ç¥è¿½æ±‚'
    ],
    'æ°´': [
      'åœ¨å…³ç³»ä¸­ä¿æŒé€‚å½“çš„ç¨³å®šæ€§',
      'å­¦ä¹ åšå‡ºæ˜ç¡®çš„æ‰¿è¯º',
      'å»ºç«‹å¯é çš„æƒ…æ„ŸåŸºç¡€',
      'åŸ¹å…»å…±åŒçš„ç”Ÿæ´»ç›®æ ‡'
    ]
  };
  
  const baseAdvice = adviceMap[dayElement] || adviceMap['æœ¨'];
  const strengthAdvice = strength === 'åæ—º' ? [
    'æ³¨æ„æ§åˆ¶ä¸»å¯¼æ¬²æœ›ï¼Œå°Šé‡ä¼´ä¾£é€‰æ‹©',
    'å­¦ä¹ å¹³ç­‰åå•†ï¼Œé¿å…ç‹¬æ–­ä¸“è¡Œ'
  ] : [
    'å¢å¼ºè‡ªä¿¡ï¼Œä¸»åŠ¨è¡¨è¾¾éœ€æ±‚',
    'å»ºç«‹æ˜ç¡®çš„ä¸ªäººè¾¹ç•Œ'
  ];
  
  return [...baseAdvice, ...strengthAdvice]
    .map(item => `<li>${item}</li>`)
    .join('');
}

// è¯¦ç»†æµå¹´åˆ†æ - åŠ¨æ€ç‰ˆæœ¬
function getLuckDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const luckForecast = generateLuckForecast(dayElement, counts, percents);
  const criticalTiming = identifyCriticalTiming(dayElement, strengthAnalysis.strength);
  const luckEnhancement = generateLuckEnhancementPlan(dayElement, counts);
  
  return `
    <div class="detail-section">
      <h4>ğŸ“ˆ æµå¹´è¿åŠ¿æ·±åº¦é¢„æµ‹</h4>
      <p>åŸºäºæ‚¨çš„${pillars.day.stem}${dayElement}å‘½å±€èƒ½é‡é…ç½®ï¼Œæœªæ¥è¿åŠ¿èµ°å‘åˆ†æï¼š</p>
      
      <p><strong>è¿‘æœŸè¿åŠ¿è¶‹åŠ¿ï¼ˆ1-3å¹´ï¼‰ï¼š</strong></p>
      <ul class="action-list">
        ${luckForecast.map(item => `<li><strong>${item.area}ï¼š</strong>${item.trend}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ¯ å…³é”®æ—¶æœºæŠŠæ¡æŒ‡å—</h4>
      <p><strong>é‡è¦æ—¶é—´èŠ‚ç‚¹ï¼š</strong></p>
      <ul class="action-list">
        ${criticalTiming.map(item => `<li><strong>${item.period}ï¼š</strong>${item.opportunity}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>ğŸ’« è¿åŠ¿èƒ½é‡æå‡æ–¹æ¡ˆ</h4>
      <ul class="action-list">
        ${luckEnhancement}
      </ul>
    </div>
  `;
}

function generateLuckForecast(dayElement, counts, percents) {
  const weakestElement = getWeakestElement(counts);
  
  const forecastMap = {
    'æœ¨': [
      { area: 'äº‹ä¸šå‘å±•', trend: 'æœ‰æ–°çš„é¢†å¯¼æœºä¼šå‡ºç°ï¼Œéœ€è¦ä¸»åŠ¨æŠŠæ¡' },
      { area: 'è´¢å¯Œå¢é•¿', trend: 'æ­£è´¢ç¨³å®šä¸Šå‡ï¼Œåè´¢éœ€è¦è°¨æ…é€‰æ‹©' },
      { area: 'äººé™…å…³ç³»', trend: 'è´µäººè¿å¢å¼ºï¼Œåˆä½œæœºä¼šå¢å¤š' },
      { area: 'å¥åº·çŠ¶æ€', trend: 'éœ€è¦æ³¨æ„å·¥ä½œç”Ÿæ´»å¹³è¡¡' }
    ],
    'ç«': [
      { area: 'äº‹ä¸šå‘å±•', trend: 'åˆ›æ„é¡¹ç›®æœºä¼šå¢å¤šï¼Œé€‚åˆåˆ›æ–°çªç ´' },
      { area: 'è´¢å¯Œå¢é•¿', trend: 'æŠ•èµ„æœºä¼šå‡ºç°ï¼Œä½†éœ€æ§åˆ¶é£é™©' },
      { area: 'äººé™…å…³ç³»', trend: 'ç¤¾äº¤æ´»è·ƒï¼Œå½±å“åŠ›æå‡' },
      { area: 'å¥åº·çŠ¶æ€', trend: 'æ³¨æ„æƒ…ç»ªç®¡ç†å’Œå¿ƒè¡€ç®¡ä¿å¥' }
    ],
    'åœŸ': [
      { area: 'äº‹ä¸šå‘å±•', trend: 'ç¨³å®šä¸­æœ‰è¿›æ­¥ï¼Œé€‚åˆæ·±è€•ä¸“ä¸š' },
      { area: 'è´¢å¯Œå¢é•¿', trend: 'ç§¯ç´¯æ•ˆåº”æ˜¾ç°ï¼Œé€‚åˆé•¿æœŸæŠ•èµ„' },
      { area: 'äººé™…å…³ç³»', trend: 'å»ºç«‹å¯é åˆä½œå…³ç³»' },
      { area: 'å¥åº·çŠ¶æ€', trend: 'æ³¨é‡æ¶ˆåŒ–ç³»ç»Ÿä¿å…»' }
    ],
    'é‡‘': [
      { area: 'äº‹ä¸šå‘å±•', trend: 'æŠ€æœ¯èƒ½åŠ›è·å¾—è®¤å¯ï¼Œä¸“ä¸šåœ°ä½æå‡' },
      { area: 'è´¢å¯Œå¢é•¿', trend: 'é€šè¿‡ä¸“ä¸šæŠ€èƒ½è·å¾—é¢å¤–æ”¶å…¥' },
      { area: 'äººé™…å…³ç³»', trend: 'å»ºç«‹ä¸“ä¸šäººè„‰ç½‘ç»œ' },
      { area: 'å¥åº·çŠ¶æ€', trend: 'æ³¨æ„å‘¼å¸ç³»ç»Ÿå’Œçš®è‚¤ä¿å…»' }
    ],
    'æ°´': [
      { area: 'äº‹ä¸šå‘å±•', trend: 'è½¬å‹æœºä¼šå‡ºç°ï¼Œé€‚åˆå¤šå…ƒå‘å±•' },
      { area: 'è´¢å¯Œå¢é•¿', trend: 'æµåŠ¨æ±‚è´¢æœºä¼šå¢å¤š' },
      { area: 'äººé™…å…³ç³»', trend: 'æ‹“å±•æ–°çš„äººè„‰åœˆå±‚' },
      { area: 'å¥åº·çŠ¶æ€', trend: 'æ³¨æ„è‚¾è„å’Œæ³Œå°¿ç³»ç»Ÿ' }
    ]
  };
  
  const baseForecast = forecastMap[dayElement] || forecastMap['æœ¨'];
  
  // æ ¹æ®æœ€å¼±å…ƒç´ è°ƒæ•´é¢„æµ‹
  if (weakestElement) {
    const adjustment = {
      'æœ¨': 'éœ€è¦åŠ å¼ºå†³ç­–åŠ›å’Œè¡ŒåŠ¨åŠ›',
      'ç«': 'éœ€è¦ä¿æŒçƒ­æƒ…å’Œç§¯ææ€§',
      'åœŸ': 'éœ€è¦æ³¨é‡ç¨³å®šå’Œç§¯ç´¯',
      'é‡‘': 'éœ€è¦æå‡ä¸“ä¸šå’ŒæŠ€æœ¯',
      'æ°´': 'éœ€è¦å¢å¼ºé€‚åº”å’Œå˜é€š'
    };
    baseForecast.push({ area: 'æˆé•¿é‡ç‚¹', trend: adjustment[weakestElement] });
  }
  
  return baseForecast;
}

function identifyCriticalTiming(dayElement, strength) {
  const baseTiming = [
    { period: 'æ˜å¹´æ˜¥å­£', opportunity: 'äº‹ä¸šä¸Šæœ‰é‡è¦å‘å±•æœºé‡' },
    { period: 'åå¹´å¤å­£', opportunity: 'è´¢è¿è¾¾åˆ°é˜¶æ®µæ€§é«˜å³°' },
    { period: 'ä¸‰å¹´å', opportunity: 'äººç”Ÿè¿›å…¥æ–°çš„å‘å±•é˜¶æ®µ' }
  ];
  
  const elementTiming = {
    'æœ¨': { period: 'æ¯å¹´3-5æœˆ', opportunity: 'æœ€é€‚åˆå¯åŠ¨æ–°é¡¹ç›®' },
    'ç«': { period: 'æ¯å¹´6-8æœˆ', opportunity: 'åˆ›æ„èƒ½é‡æœ€æ—ºç››' },
    'åœŸ': { period: 'å­£èŠ‚äº¤æ›¿æ—¶æœŸ', opportunity: 'é€‚åˆè°ƒæ•´å’Œè§„åˆ’' },
    'é‡‘': { period: 'æ¯å¹´9-11æœˆ', opportunity: 'ä¸“ä¸šæŠ€èƒ½å‘æŒ¥æœ€ä½³' },
    'æ°´': { period: 'å†¬å­£æœŸé—´', opportunity: 'é€‚åˆåæ€å’Œè½¬å‹' }
  };
  
  const elementSpecific = elementTiming[dayElement];
  if (elementSpecific) {
    baseTiming.push(elementSpecific);
  }
  
  return baseTiming;
}

function generateLuckEnhancementPlan(dayElement, counts) {
  const weakestElement = getWeakestElement(counts);
  
  const enhancementMap = {
    'æœ¨': [
      'æ—©æ™¨é¢å‘ä¸œæ–¹è¿›è¡Œèƒ½é‡å†¥æƒ³',
      'å¤šæ¥è§¦è‡ªç„¶ç¯å¢ƒå’Œæ¤ç‰©',
      'ç©¿ç€ç»¿è‰²ç³»è¡£ç‰©å¢å¼ºæœ¨èƒ½é‡',
      'åŸ¹å…»å†³æ–­åŠ›å’Œé¢†å¯¼èƒ½åŠ›'
    ],
    'ç«': [
      'ä¸­åˆé¢å‘å—æ–¹å¸æ”¶é˜³å…‰èƒ½é‡',
      'å‚ä¸ç¤¾äº¤å’Œå›¢ä½“æ´»åŠ¨',
      'ç©¿ç€çº¢è‰²ç³»è¡£ç‰©å¢å¼ºç«èƒ½é‡',
      'ä¿æŒç§¯æçƒ­æƒ…çš„å¿ƒæ€'
    ],
    'åœŸ': [
      'åœ¨å±…ä¸­ä½ç½®è¿›è¡Œç¨³å®šå†¥æƒ³',
      'è¿›è¡Œå›­è‰ºå’ŒåœŸåœ°ç›¸å…³æ´»åŠ¨',
      'ç©¿ç€é»„è‰²ç³»è¡£ç‰©å¢å¼ºåœŸèƒ½é‡',
      'åŸ¹å…»è€å¿ƒå’Œè´£ä»»æ„Ÿ'
    ],
    'é‡‘': [
      'å‚æ™šé¢å‘è¥¿æ–¹è¿›è¡Œå‘¼å¸ç»ƒä¹ ',
      'æ¥è§¦é‡‘å±åˆ¶å“å’Œç²¾è‡´ç‰©å“',
      'ç©¿ç€ç™½è‰²ç³»è¡£ç‰©å¢å¼ºé‡‘èƒ½é‡',
      'æå‡ä¸“ä¸šæŠ€èƒ½å’Œå“è´¨æ ‡å‡†'
    ],
    'æ°´': [
      'æ™šä¸Šé¢å‘åŒ—æ–¹è¿›è¡Œé™å¿ƒå†¥æƒ³',
      'æ¥è§¦æ°´æºå’Œæ°´ç›¸å…³æ´»åŠ¨',
      'ç©¿ç€é»‘è‰²ç³»è¡£ç‰©å¢å¼ºæ°´èƒ½é‡',
      'åŸ¹å…»çµæ´»æ€§å’Œé€‚åº”èƒ½åŠ›'
    ]
  };
  
  const basePlan = enhancementMap[dayElement] || enhancementMap['æœ¨'];
  
  // æ ¹æ®æœ€å¼±å…ƒç´ æ·»åŠ è¡¥å……å»ºè®®
  if (weakestElement && weakestElement !== dayElement) {
    const supplement = enhancementMap[weakestElement]?.slice(0, 2) || [];
    return [...basePlan, ...supplement].map(item => `<li>${item}</li>`).join('');
  }
  
  return basePlan.map(item => `<li>${item}</li>`).join('');
}

// æ›´æ–° showDetailAnalysis å‡½æ•°è°ƒç”¨
function showDetailAnalysis(type, pillars, strengthAnalysis) {
  // éšè—ä¸»åˆ†æé¡µé¢ï¼Œä½†ä¿ç•™VIPåŒºåŸŸ
  const mainCards = document.querySelectorAll('.card:not(.detail-view):not(.vip-section)');
  mainCards.forEach(card => card.style.display = 'none');
  
  const detailView = $('detailView');
  detailView.style.display = 'block';
  
  // è®¾ç½®è¯¦ç»†åˆ†æå†…å®¹
  const detailTitle = $('detailTitle');
  const detailContent = $('detailContent');
  
  // è·å–å½“å‰å…«å­—æ•°æ®
  const currentData = window.currentBaziData || { counts: {}, percents: {} };
  
  switch(type) {
    case 'career':
      detailTitle.textContent = 'ğŸ’¼ è¯¦ç»†äº‹ä¸šåˆ†æ';
      detailContent.innerHTML = getCareerDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'wealth':
      detailTitle.textContent = 'ğŸ’° è´¢è¿æŠ•èµ„å»ºè®®';
      detailContent.innerHTML = getWealthDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'marriage':
      detailTitle.textContent = 'â¤ï¸ å©šå§»æ„Ÿæƒ…è§£è¯»';
      detailContent.innerHTML = getMarriageDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'health':
      detailTitle.textContent = 'ğŸŒ¿ å¥åº·å…»ç”ŸæŒ‡å¯¼';
      detailContent.innerHTML = getHealthDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'luck':
      detailTitle.textContent = 'ğŸ“ˆ æµå¹´è¿åŠ¿é¢„æµ‹';
      detailContent.innerHTML = getLuckDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
  }
}

// æ›´æ–° generateLuckAnalysis è°ƒç”¨
function generateLuckAnalysis(pillars, gender) {
  const currentData = window.currentBaziData || { counts: {}, percents: {} };
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const luckCycles = generateDynamicLuckCycles(pillars, gender, currentData.counts, currentData.percents);
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');
  
  if (!chatFab || !chatPanel) return;
  
  chatFab.addEventListener('click', () => {
    chatPanel.style.display = 'block';
  });
  
  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });
  
  function addMessage(text, isUser = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    msgDiv.textContent = text;
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  
  chatSend.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (!text) return;
    
    addMessage(text, true);
    chatInput.value = '';
    
    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
      const replies = [
        'è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œè®©æˆ‘ä¸ºæ‚¨è¯¦ç»†åˆ†æ...',
        'æ ¹æ®æ‚¨çš„å…«å­—ç‰¹ç‚¹ï¼Œæˆ‘å»ºè®®...',
        'è¿™ä¸ªé—®é¢˜éœ€è¦ç»“åˆæ‚¨çš„å…·ä½“å‘½å±€æ¥çœ‹...',
        'ä»äº”è¡Œè§’åº¦æ¥çœ‹ï¼Œæ‚¨çš„å‘½å±€æ˜¾ç¤º...'
      ];
      addMessage(replies[Math.floor(Math.random() * replies.length)]);
    }, 1000);
  });
  
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      chatSend.click();
    }
  });
}

// åˆå§‹åŒ–æ—¶é—´æœªçŸ¥åŠŸèƒ½
function initTimeUnknown() {
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }
}

// å¤šè¯­è¨€ç¿»è¯‘ç³»ç»Ÿ
const translations = {
  'zh-CN': {
    title: '5xLiving Â· å…«å­—ç®€è¯„',
    quickBazi: 'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜',
    namePlaceholder: 'ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰',
    gender: 'æ€§åˆ«',
    genderOptions: ['ä¸é€éœ²', 'ç”·æ€§', 'å¥³æ€§'],
    calendar: 'å†æ³•',
    calendarOptions: ['é˜³å†', 'å†œå†'],
    birthDate: 'å‡ºç”Ÿæ—¥æœŸ',
    birthTime: 'å‡ºç”Ÿæ—¶é—´',
    timeUnknown: 'å‡ºç”Ÿæ—¶é—´ä¸è¯¦',
    generateBazi: 'ç”Ÿæˆå…«å­—',
    calculating: 'è®¡ç®—ä¸­...',
    yourBazi: 'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜',
    birthDateText: 'å‡ºç”Ÿæ—¥æœŸ',
    elementsAnalysis: 'äº”è¡Œèƒ½é‡åˆ†æ',
    basicInfo: 'ğŸ§™â€â™‚ï¸ å‘½ä¸»åŸºæœ¬ä¿¡æ¯',
    overallDestiny: 'ğŸ” æ€»ä½“å‘½è¿è§£è¯»',
    careerAnalysis: 'ğŸ’¼ äº‹ä¸šåˆ†æ',
    wealthAnalysis: 'ğŸ’° è´¢å¯ŒçŠ¶å†µ',
    marriageAnalysis: 'â¤ï¸ å©šå§»æ„Ÿæƒ…',
    luckAnalysis: 'ğŸ“ˆ å¤§è¿æµå¹´åˆ†æ',
    aiButler: 'å¿ƒæ€œç®¡å®¶ Â· æ·±åº¦è§£è¯»',
    vipSection: 'ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment',
    vipContent1: 'ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹',
    vipContent2: 'ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹',
    loginTitle: 'è´¦æˆ·ç™»å½• / æ³¨å†Œ',
    emailPlaceholder: 'é‚®ç®± Email',
    passwordPlaceholder: 'å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰',
    loginBtn: 'ç™»å…¥è´¦æˆ·',
    resetPassword: 'ğŸ”‘ é‡è®¾å¯†ç ',
    registerBtn: 'æ³¨å†Œè´¦æˆ·',
    registerTip: 'æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ',
    vipService: 'ä¼šå‘˜æœåŠ¡',
    upgradeVip: 'ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰',
    backToShop: 'â† è¿”å›å‘½ç†å•†åŸ',
    vipPrice: '$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰',
    chatTitle: '5X Â· æ™ºèƒ½åŠ©æ‰‹',
    chatPlaceholder: 'è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ',
    send: 'å‘é€'
  },
  'zh-TW': {
    title: '5xLiving Â· å…«å­—ç°¡è©•',
    quickBazi: 'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤',
    namePlaceholder: 'ä½ çš„ç¨±å‘¼ï¼ˆç”¨æ–¼å€‹æ€§åŒ–ï¼‰',
    gender: 'æ€§åˆ¥',
    genderOptions: ['ä¸é€éœ²', 'ç”·æ€§', 'å¥³æ€§'],
    calendar: 'æ›†æ³•',
    calendarOptions: ['é™½æ›†', 'è¾²æ›†'],
    birthDate: 'å‡ºç”Ÿæ—¥æœŸ',
    birthTime: 'å‡ºç”Ÿæ™‚é–“',
    timeUnknown: 'å‡ºç”Ÿæ™‚é–“ä¸è©³',
    generateBazi: 'ç”Ÿæˆå…«å­—',
    calculating: 'è¨ˆç®—ä¸­...',
    yourBazi: 'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›¤',
    birthDateText: 'å‡ºç”Ÿæ—¥æœŸ',
    elementsAnalysis: 'äº”è¡Œèƒ½é‡åˆ†æ',
    basicInfo: 'ğŸ§™â€â™‚ï¸ å‘½ä¸»åŸºæœ¬ä¿¡æ¯',
    overallDestiny: 'ğŸ” ç¸½é«”å‘½é‹è§£è®€',
    careerAnalysis: 'ğŸ’¼ äº‹æ¥­åˆ†æ',
    wealthAnalysis: 'ğŸ’° è²¡å¯Œç‹€æ³',
    marriageAnalysis: 'â¤ï¸ å©šå§»æ„Ÿæƒ…',
    luckAnalysis: 'ğŸ“ˆ å¤§é‹æµå¹´åˆ†æ',
    aiButler: 'å¿ƒæ†ç®¡å®¶ Â· æ·±åº¦è§£è®€',
    vipSection: 'ğŸŒ™ æœƒå“¡å€åŸŸ VIP Segment',
    vipContent1: 'ğŸ— å‘½ç†ç©ºé–“å°ˆå±¬å…§å®¹',
    vipContent2: 'ğŸŒ™ å¿ƒæ†ç©ºé–“å°ˆå±¬å…§å®¹',
    loginTitle: 'è³¬æˆ¶ç™»éŒ„ / è¨»å†Š',
    emailPlaceholder: 'éƒµç®± Email',
    passwordPlaceholder: 'å¯†ç¢¼ Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«æ•¸å­—ç¬¦è™Ÿï¼‰',
    loginBtn: 'ç™»å…¥è³¬æˆ¶',
    resetPassword: 'ğŸ”‘ é‡è¨­å¯†ç¢¼',
    registerBtn: 'è¨»å†Šè³¬æˆ¶',
    registerTip: 'è¨»å†Šè³¬è™Ÿè´ˆé€ä¸€æ¬¡å…è²»é«”é©—',
    vipService: 'æœƒå“¡æœå‹™',
    upgradeVip: 'ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆè²»ï¼‰',
    backToShop: 'â† è¿”å›å‘½ç†å•†åŸ',
    vipPrice: '$9.9 / æœˆè²» VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ†ç©ºé–“ + éˆæ€§èª²ç¨‹ï¼‰',
    chatTitle: '5X Â· æ™ºèƒ½åŠ©æ‰‹',
    chatPlaceholder: 'è«‹å•æ‚¨æƒ³äº†è§£ä»€éº¼ï¼Ÿ',
    send: 'ç™¼é€'
  },
  'en': {
    title: '5xLiving Â· Bazi Analysis',
    quickBazi: 'Bazi Fortune Â· Quick Chart',
    namePlaceholder: 'Your name (for personalization)',
    gender: 'Gender',
    genderOptions: ['Not specified', 'Male', 'Female'],
    calendar: 'Calendar',
    calendarOptions: ['Gregorian', 'Lunar'],
    birthDate: 'Birth Date',
    birthTime: 'Birth Time',
    timeUnknown: 'Time unknown',
    generateBazi: 'Generate Bazi',
    calculating: 'Calculating...',
    yourBazi: 'Your Bazi Birth Chart',
    birthDateText: 'Birth Date',
    elementsAnalysis: 'Five Elements Analysis',
    basicInfo: 'ğŸ§™â€â™‚ï¸ Basic Information',
    overallDestiny: 'ğŸ” Overall Destiny',
    careerAnalysis: 'ğŸ’¼ Career Analysis',
    wealthAnalysis: 'ğŸ’° Wealth Status',
    marriageAnalysis: 'â¤ï¸ Marriage & Relationships',
    luckAnalysis: 'ğŸ“ˆ Luck Cycle Analysis',
    aiButler: 'AI Butler Â· Deep Insights',
    vipSection: 'ğŸŒ™ VIP Member Area',
    vipContent1: 'ğŸ— Destiny Space Exclusive',
    vipContent2: 'ğŸŒ™ Spiritual Space Exclusive',
    loginTitle: 'Login / Register',
    emailPlaceholder: 'Email Address',
    passwordPlaceholder: 'Password (min 8 chars, upper/lower/digit/symbol)',
    loginBtn: 'Login',
    resetPassword: 'ğŸ”‘ Reset Password',
    registerBtn: 'Register Account',
    registerTip: 'Free trial with registration',
    vipService: 'VIP Services',
    upgradeVip: 'ğŸ’ Upgrade to VIP (Monthly)',
    backToShop: 'â† Back to Shop',
    vipPrice: '$9.9 / Month VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X Â· AI Assistant',
    chatPlaceholder: 'What would you like to know?',
    send: 'Send'
  },
  'ja': {
    title: '5xLiving Â· å…«å­—è¨ºæ–­',
    quickBazi: 'å…«å­—å‘½ç† Â· ç°¡æ˜“è¨ˆç®—',
    namePlaceholder: 'ãŠåå‰ï¼ˆå€‹äººç”¨ï¼‰',
    gender: 'æ€§åˆ¥',
    genderOptions: ['æœªå›ç­”', 'ç”·æ€§', 'å¥³æ€§'],
    calendar: 'æš¦æ³•',
    calendarOptions: ['ã‚°ãƒ¬ã‚´ãƒªã‚ªæš¦', 'æ—§æš¦'],
    birthDate: 'ç”Ÿå¹´æœˆæ—¥',
    birthTime: 'å‡ºç”Ÿæ™‚é–“',
    timeUnknown: 'å‡ºç”Ÿæ™‚é–“ä¸æ˜',
    generateBazi: 'å…«å­—ã‚’è¨ˆç®—',
    calculating: 'è¨ˆç®—ä¸­...',
    yourBazi: 'ã‚ãªãŸã®å…«å­—å‘½ç›¤',
    birthDateText: 'ç”Ÿå¹´æœˆæ—¥',
    elementsAnalysis: 'äº”è¡Œã‚¨ãƒãƒ«ã‚®ãƒ¼åˆ†æ',
    basicInfo: 'ğŸ§™â€â™‚ï¸ åŸºæœ¬æƒ…å ±',
    overallDestiny: 'ğŸ” ç·åˆé‹å‹¢',
    careerAnalysis: 'ğŸ’¼ äº‹æ¥­é‹',
    wealthAnalysis: 'ğŸ’° è²¡é‹',
    marriageAnalysis: 'â¤ï¸ æ‹æ„›ãƒ»çµå©šé‹',
    luckAnalysis: 'ğŸ“ˆ å¤§é‹åˆ†æ',
    aiButler: 'AIç®¡å®¶ Â· è©³ç´°è¨ºæ–­',
    vipSection: 'ğŸŒ™ VIPä¼šå“¡ã‚¨ãƒªã‚¢',
    vipContent1: 'ğŸ— å‘½ç†ã‚¹ãƒšãƒ¼ã‚¹é™å®š',
    vipContent2: 'ğŸŒ™ ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ã‚¹ãƒšãƒ¼ã‚¹é™å®š',
    loginTitle: 'ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²',
    emailPlaceholder: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
    passwordPlaceholder: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ï¼‰',
    loginBtn: 'ãƒ­ã‚°ã‚¤ãƒ³',
    resetPassword: 'ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š',
    registerBtn: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²',
    registerTip: 'ç™»éŒ²ã§ç„¡æ–™ä½“é¨“',
    vipService: 'VIPã‚µãƒ¼ãƒ“ã‚¹',
    upgradeVip: 'ğŸ’ VIPã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆæœˆé¡ï¼‰',
    backToShop: 'â† ã‚·ãƒ§ãƒƒãƒ—ã«æˆ»ã‚‹',
    vipPrice: '$9.9 / æœˆé¡VIPï¼ˆå‘½ç†+ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«+è¬›åº§ï¼‰',
    chatTitle: '5X Â· AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
    chatPlaceholder: 'ä½•ã‹ãŠèãã—ãŸã„ã“ã¨ã¯ï¼Ÿ',
    send: 'é€ä¿¡'
  },
  'th': {
    title: '5xLiving Â· à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸²à¸ˆà¸·à¹‰à¸­',
    quickBazi: 'à¸›à¸²à¸ˆà¸·à¹‰à¸­ Â· à¸„à¸³à¸™à¸§à¸“à¸”à¹ˆà¸§à¸™',
    namePlaceholder: 'à¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“ (à¸ªà¸³à¸«à¸£à¸±à¸š personalize)',
    gender: 'à¹€à¸à¸¨',
    genderOptions: ['à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸', 'à¸Šà¸²à¸¢', 'à¸«à¸à¸´à¸‡'],
    calendar: 'à¸›à¸à¸´à¸—à¸´à¸™',
    calendarOptions: ['à¸ªà¸²à¸à¸¥', 'à¸ˆà¸±à¸™à¸—à¸£à¸„à¸•à¸´'],
    birthDate: 'à¸§à¸±à¸™à¹€à¸à¸´à¸”',
    birthTime: 'à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”',
    timeUnknown: 'à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”',
    generateBazi: 'à¸„à¸³à¸™à¸§à¸“à¸›à¸²à¸ˆà¸·à¹‰à¸­',
    calculating: 'à¸à¸³à¸¥à¸±à¸‡à¸„à¸³à¸™à¸§à¸“...',
    yourBazi: 'à¹à¸œà¸™à¸ à¸¹à¸¡à¸´à¸›à¸²à¸ˆà¸·à¹‰à¸­à¸‚à¸­à¸‡à¸„à¸¸à¸“',
    birthDateText: 'à¸§à¸±à¸™à¹€à¸à¸´à¸”',
    elementsAnalysis: 'à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸˜à¸²à¸•à¸¸à¸—à¸±à¹‰à¸‡à¸«à¹‰à¸²',
    basicInfo: 'ğŸ§™â€â™‚ï¸ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸·à¹‰à¸™à¸à¸²à¸™',
    overallDestiny: 'ğŸ” à¹‚à¸Šà¸„à¸Šà¸°à¸•à¸²à¸£à¸§à¸¡',
    careerAnalysis: 'ğŸ’¼ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸à¸²à¸£à¸‡à¸²à¸™',
    wealthAnalysis: 'ğŸ’° à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹€à¸‡à¸´à¸™',
    marriageAnalysis: 'â¤ï¸ à¸„à¸§à¸²à¸¡à¸£à¸±à¸à¹à¸¥à¸°à¸à¸²à¸£à¹à¸•à¹ˆà¸‡à¸‡à¸²à¸™',
    luckAnalysis: 'ğŸ“ˆ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸¢',
    aiButler: 'à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ AI Â· à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸¥à¸¶à¸',
    vipSection: 'ğŸŒ™ à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸¡à¸²à¸Šà¸´à¸ VIP',
    vipContent1: 'ğŸ— à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹€à¸‰à¸à¸²à¸° Destiny Space',
    vipContent2: 'ğŸŒ™ à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹€à¸‰à¸à¸²à¸° Spiritual Space',
    loginTitle: 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š / à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸',
    emailPlaceholder: 'à¸­à¸µà¹€à¸¡à¸¥',
    passwordPlaceholder: 'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 8 à¸•à¸±à¸§, à¹ƒà¸«à¸à¹ˆ/à¹€à¸¥à¹‡à¸/à¸•à¸±à¸§à¹€à¸¥à¸‚/à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ)',
    loginBtn: 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š',
    resetPassword: 'ğŸ”‘ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™',
    registerBtn: 'à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸',
    registerTip: 'à¸—à¸”à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰à¸Ÿà¸£à¸µà¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸¡à¸±à¸„à¸£',
    vipService: 'à¸šà¸£à¸´à¸à¸²à¸£ VIP',
    upgradeVip: 'ğŸ’ à¸­à¸±à¸›à¹€à¸à¸£à¸”à¹€à¸›à¹‡à¸™ VIP (à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™)',
    backToShop: 'â† à¸à¸¥à¸±à¸šà¹„à¸›à¸£à¹‰à¸²à¸™à¸„à¹‰à¸²',
    vipPrice: '$9.9 / à¹€à¸”à¸·à¸­à¸™ VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X Â· à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ AI',
    chatPlaceholder: 'à¸¡à¸µà¸­à¸°à¹„à¸£à¹ƒà¸«à¹‰à¸Šà¹ˆà¸§à¸¢à¹„à¸«à¸¡à¸„à¸°?',
    send: 'à¸ªà¹ˆà¸‡'
  },
  'ms': {
    title: '5xLiving Â· Analisis Bazi',
    quickBazi: 'Bazi Â· Carta Pantas',
    namePlaceholder: 'Nama anda (untuk personalisasi)',
    gender: 'Jantina',
    genderOptions: ['Tidak dinyatakan', 'Lelaki', 'Perempuan'],
    calendar: 'Kalendar',
    calendarOptions: ['Gregorian', 'Qamari'],
    birthDate: 'Tarikh Lahir',
    birthTime: 'Masa Lahir',
    timeUnknown: 'Masa lahir tidak diketahui',
    generateBazi: 'Hasilkan Bazi',
    calculating: 'Mengira...',
    yourBazi: 'Carta Kelahiran Bazi Anda',
    birthDateText: 'Tarikh Lahir',
    elementsAnalysis: 'Analisis Lima Unsur',
    basicInfo: 'ğŸ§™â€â™‚ï¸ Maklumat Asas',
    overallDestiny: 'ğŸ” Takdir Keseluruhan',
    careerAnalysis: 'ğŸ’¼ Analisis Kerjaya',
    wealthAnalysis: 'ğŸ’° Status Kekayaan',
    marriageAnalysis: 'â¤ï¸ Perkahwinan & Hubungan',
    luckAnalysis: 'ğŸ“ˆ Analisis Kitaran Nasib',
    aiButler: 'Pembantu AI Â· Analisis Mendalam',
    vipSection: 'ğŸŒ™ Kawasan Ahli VIP',
    vipContent1: 'ğŸ— Eksklusif Ruang Takdir',
    vipContent2: 'ğŸŒ™ Eksklusif Ruang Spiritual',
    loginTitle: 'Log Masuk / Daftar',
    emailPlaceholder: 'Emel',
    passwordPlaceholder: 'Kata Laluan (min 8 aksara, besar/kecil/nombor/simbol)',
    loginBtn: 'Log Masuk',
    resetPassword: 'ğŸ”‘ Set Semula Kata Laluan',
    registerBtn: 'Daftar Akaun',
    registerTip: 'Percubaan percuma dengan pendaftaran',
    vipService: 'Perkhidmatan VIP',
    upgradeVip: 'ğŸ’ Naik Taraf ke VIP (Bulanan)',
    backToShop: 'â† Kembali ke Kedai',
    vipPrice: '$9.9 / Bulan VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X Â· Pembantu AI',
    chatPlaceholder: 'Apa yang anda ingin tahu?',
    send: 'Hantar'
  }
};

// ç¿»è¯‘å‡½æ•°
function translatePage(lang) {
  const t = translations[lang] || translations['zh-CN'];
  
  // æ›´æ–°é¡µé¢æ–‡æœ¬
  document.querySelector('.title').textContent = t.title;
  document.querySelector('.h2').textContent = t.quickBazi;
  document.getElementById('name').placeholder = t.namePlaceholder;
  document.querySelector('label[for="gender"]').textContent = t.gender;
  document.querySelector('label[for="calendar"]').textContent = t.calendar;
  document.querySelector('label[for="birthdate"]').textContent = t.birthDate;
  document.querySelector('label[for="birthtime"]').textContent = t.birthTime;
  document.querySelector('.time-unknown span').textContent = t.timeUnknown;
  document.getElementById('genBtnText').textContent = t.generateBazi;
  
  // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
  const genderSelect = document.getElementById('gender');
  genderSelect.options[0].text = t.genderOptions[0];
  genderSelect.options[1].text = t.genderOptions[1];
  genderSelect.options[2].text = t.genderOptions[2];
  
  const calendarSelect = document.getElementById('calendar');
  calendarSelect.options[0].text = t.calendarOptions[0];
  calendarSelect.options[1].text = t.calendarOptions[1];
  
  // ä¿å­˜è¯­è¨€é€‰æ‹©
  localStorage.setItem('preferredLanguage', lang);
}

// VIPç™»å½•ç³»ç»Ÿ
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){
    return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') };
  }finally{
    clearTimeout(timer);
  }
}

function strongPwd(pw){ 
  return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); 
}

// æ³¨å†ŒåŠŸèƒ½
$('registerForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');
  if(!strongPwd(password)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');
  lock($('registerBtn'),true);
  try{
    const res=await fetchJSON('/api/register',{email,password});
    if(res.ok===true){ 
      localStorage.setItem('vipEmail',email); 
      showAuthErr('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚');
      return; 
    }
    if((res.msg||"").toString().toLowerCase()==='exists'){ 
      await loginFlow(email,password); 
      return; 
    }
    return showAuthErr('æ³¨å†Œå¤±è´¥ï¼š' + (res.msg||''));
  }catch(err){ showAuthErr('æ³¨å†Œå¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('registerBtn'),false); }
});

// ç™»å½•åŠŸèƒ½
async function loginFlow(email,password){
  const res = await fetchJSON('/api/login', { email, password });
  const msg=(res.msg||"").toString().toLowerCase();
  let expired=false;
  if(res.expired===true) expired=true;
  else if(msg==='expired') expired=true;
  else if(res.expiresAt){
    const ts=Date.parse(res.expiresAt);
    if(!Number.isNaN(ts)&&ts<Date.now()) expired=true;
  }

  if(expired){
    const go=confirm('ä¼šå‘˜å·²è¿‡æœŸã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ');
    if(go){
      const a=document.createElement('a');
      a.href='https://yourshopifyshop.com/products/monthly-vip';
      a.target='_blank'; a.rel='noopener noreferrer';
      document.body.appendChild(a); a.click(); a.remove();
    }
    return;
  }

  if(res.ok===true){
    localStorage.setItem('vipEmail',res.email||email);
    localStorage.setItem('vipStatus', 'active');
    showAuthErr('ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥ã€‚');
    return;
  }

  if(msg==='no_account') return showAuthErr('è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');
  if(msg==='wrong_pwd') return showAuthErr('å¯†ç é”™è¯¯');
  const extra = res.msg ? ` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}` : '';
  return showAuthErr('ç™»å…¥å¤±è´¥ï¼š' + extra);
}

$('loginForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');
  lock($('loginBtn'),true);
  try{ await loginFlow(email,password); }
  catch(err){ showAuthErr('ç™»å…¥å¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('loginBtn'),false); }
});

// é‡ç½®å¯†ç åŠŸèƒ½
$('resetBtn')?.addEventListener('click', async ()=>{
  hideAuthErr();
  let email=prompt('è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š'); 
  if(email===null) return; 
  email=email.trim(); 
  if(!email) return showAuthErr('é‚®ç®±ä¸èƒ½ä¸ºç©º');
  let newPassword=prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š'); 
  if(newPassword===null) return; 
  newPassword=newPassword.trim(); 
  if(!newPassword) return showAuthErr('å¯†ç ä¸èƒ½ä¸ºç©º');
  if(!strongPwd(newPassword)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');
  lock($('resetBtn'),true);
  try{
    const res=await fetchJSON('/api/reset',{email,newPassword});
    if(!res.ok){ const extra=res.msg?` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}`:''; return showAuthErr('é‡è®¾å¤±è´¥ï¼š' + extra); }
    alert('å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚');
  }catch(err){ showAuthErr('é‡è®¾å¤±è´¥ï¼š' + (err?.message||'')); }
  finally{ lock($('resetBtn'),false); }
});

// æ€»ä½“å‘½è¿è§£è¯»
function generateOverallDestiny(pillars, counts, percents, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  const strongestElement = getStrongestElement(counts);
  const weakestElement = getWeakestElement(counts);
  
  const personality = calculatePersonality(dayStem, counts);
  const seasonEffect = calculateSeasonEffect(strengthAnalysis.season, dayElement);
  const strengthEffect = calculateStrengthEffect(strengthAnalysis.strength);
  const elementAnalysis = analyzeElementDistribution(percents);
  
  return `
    <p>${personality} ${seasonEffect}</p>
    <p>${strengthEffect} ${elementAnalysis}</p>
    <p>${getElementInteractionAdvice(strongestElement, weakestElement)}</p>
  `;
}

// äº‹ä¸šåˆ†æ
function generateCareerAnalysis(pillars, counts, strengthAnalysis) {
  const dayElement = pillars.day.element;
  const suitableFields = calculateCareerFields(dayElement, counts);
  const careerPotential = analyzeCareerPotential(strengthAnalysis.strength, counts);
  const developmentAdvice = getCareerDevelopmentAdvice(dayElement, strengthAnalysis.strength);
  
  return `
    <p>${suitableFields}</p>
    <p>${careerPotential}</p>
    <p>${developmentAdvice}</p>
  `;
}

// è´¢å¯Œåˆ†æ
function generateWealthAnalysis(pillars, counts, percents, strengthAnalysis) {
  const wealthCapacity = analyzeWealthCapacity(strengthAnalysis.strength, counts);
  const wealthSources = identifyWealthSources(pillars.day.element, counts);
  const investmentStrategy = generateInvestmentStrategy(percents, counts);
  
  return `
    <p>${wealthCapacity}</p>
    <p>${wealthSources}</p>
    <p>${investmentStrategy}</p>
  `;
}

// å©šå§»åˆ†æ
function generateMarriageAnalysis(pillars, gender, counts, strengthAnalysis) {
  const relationshipPattern = analyzeRelationshipPattern(pillars.day.element, gender, counts);
  const marriageTiming = calculateMarriageTiming(strengthAnalysis.strength, counts);
  const partnerCompatibility = analyzePartnerCompatibility(pillars.day.element, counts);
  
  return `
    <p>${relationshipPattern}</p>
    <p>${marriageTiming}</p>
    <p>${partnerCompatibility}</p>
  `;
}

// AIæ·±åº¦è§£è¯»
function generateDynamicAIInsight(pillars, percents, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  const elementAnalysis = generateElementAnalysis(percents);
  const patternInsight = generatePatternInsight(strengthAnalysis.pattern, dayElement, percents);
  const dailyPractices = generateDailyPractices(dayElement, percents);
  
  return `
    <div class="detail-section">
      <h4>ğŸŒŸ å‘½å±€æ·±åº¦è§£æ</h4>
      <p>åŸºäºæ‚¨çš„${dayStem}${dayElement}æ—¥ä¸»å’Œ${strengthAnalysis.strength}æ ¼å±€ï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹æ·±åº¦åˆ†æï¼š</p>
      
      <p><strong>äº”è¡Œèƒ½é‡ç²¾å¯†åˆ†æï¼š</strong></p>
      ${elementAnalysis}
      
      <p><strong>æ ¼å±€ç‰¹è´¨æ·±åº¦è§£è¯»ï¼š</strong></p>
      <p>${patternInsight}</p>
      
      <p><strong>ä¸ªæ€§åŒ–ä¿®è¡Œå»ºè®®ï¼š</strong></p>
      ${dailyPractices}
    </div>
  `;
}

// ==================== æ ¸å¿ƒè®¡ç®—å‡½æ•° ====================

function calculatePersonality(dayStem, counts) {
  const stemTraits = {
    'ç”²': 'å…·æœ‰é¢†å¯¼æ°”è´¨ï¼Œè¡Œäº‹æœæ–­',
    'ä¹™': 'æ€§æ ¼æ¸©å’Œï¼Œé€‚åº”åŠ›å¼º',
    'ä¸™': 'çƒ­æƒ…å¼€æœ—ï¼Œå……æ»¡æ´»åŠ›',
    'ä¸': 'æ€ç»´ç»†è…»ï¼Œä¸“æ³¨åŠ›å¼º',
    'æˆŠ': 'ç¨³é‡å¯é ï¼Œè´£ä»»æ„Ÿå¼º',
    'å·±': 'åŒ…å®¹æ€§å¼ºï¼Œå–„äºåè°ƒ',
    'åºš': 'åšæ¯…æœæ–­ï¼Œæ‰§è¡ŒåŠ›å¼º',
    'è¾›': 'è¿½æ±‚å®Œç¾ï¼Œæ³¨é‡ç»†èŠ‚',
    'å£¬': 'æ™ºæ…§çµæ´»ï¼Œé€‚åº”æ€§å¼º',
    'ç™¸': 'æ¸©å’Œå†…æ•›ï¼Œå¿ƒæ€ç¼œå¯†'
  };
  
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  const diversity = elementCount >= 4 ? 'æ€§æ ¼è¾ƒä¸ºå…¨é¢' : elementCount <= 2 ? 'æ€§æ ¼ç‰¹ç‚¹é²œæ˜' : 'æ€§æ ¼å¹³è¡¡ç¨³å®š';
  
  return `å‘½ä¸»${dayStem}æ—¥ï¼Œ${stemTraits[dayStem]}ï¼Œ${diversity}ã€‚`;
}

function calculateSeasonEffect(season, dayElement) {
  const seasonElements = {
    'æ˜¥': 'æœ¨', 'å¤': 'ç«', 'ç§‹': 'é‡‘', 'å†¬': 'æ°´'
  };
  
  const seasonElement = seasonElements[season];
  if (seasonElement === dayElement) {
    return `ç”Ÿäº${season}å­£å¾—ä»¤ï¼Œèƒ½é‡å……æ²›ï¼Œå‘å±•é¡ºåˆ©ã€‚`;
  } else if (isElementSupportive(seasonElement, dayElement)) {
    return `ç”Ÿäº${season}å­£å¾—ç”Ÿï¼Œè·å¾—å¤–åœ¨æ”¯æŒã€‚`;
  } else if (isElementControlling(seasonElement, dayElement)) {
    return `ç”Ÿäº${season}å­£ä¸å¾—ä»¤ï¼Œéœ€è¦æ›´å¤šåŠªåŠ›ã€‚`;
  } else {
    return `ç”Ÿäº${season}å­£ï¼Œè¿åŠ¿å¹³ç¨³ã€‚`;
  }
}

function calculateStrengthEffect(strength) {
  const effects = {
    'ææ—º': 'å…·æœ‰å¼ºå¤§çš„è¡ŒåŠ¨åŠ›å’Œå†³ç­–èƒ½åŠ›ï¼Œä½†éœ€æ³¨æ„æ§åˆ¶è„¾æ°”',
    'åæ—º': 'æ‰§è¡ŒåŠ›å¼ºï¼Œé€‚åˆç§¯æè¿›å–ï¼Œä½†è¦æ³¨æ„å›¢é˜Ÿåˆä½œ',
    'ä¸­å’Œ': 'é€‚åº”åŠ›å¼ºï¼Œèƒ½å¤Ÿåœ¨å„ç§ç¯å¢ƒä¸­ç¨³æ­¥å‘å±•',
    'åå¼±': 'å–„äºåˆä½œï¼Œéœ€è¦å€ŸåŠ©å›¢é˜ŸåŠ›é‡ï¼Œæ³¨é‡ç§¯ç´¯'
  };
  return effects[strength] || 'å‘½å±€å¹³è¡¡ï¼Œå‘å±•ç¨³å®šã€‚';
}

function analyzeElementDistribution(percents) {
  const elements = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
  const strongElements = elements.filter(e => percents[e] > 20);
  const weakElements = elements.filter(e => percents[e] < 10);
  
  let analysis = '';
  if (strongElements.length > 0) {
    analysis += `${strongElements.join('ã€')}å…ƒç´ æ—ºç››ï¼Œ`;
  }
  if (weakElements.length > 0) {
    analysis += `${weakElements.join('ã€')}å…ƒç´ åå¼±ï¼Œ`;
  }
  
  analysis += 'éœ€è¦ç›¸åº”è°ƒæ•´ä»¥è¾¾å¹³è¡¡ã€‚';
  return analysis;
}

function calculateCareerFields(dayElement, counts) {
  const baseFields = {
    'æœ¨': ['æ•™è‚²æ–‡åŒ–', 'åˆ›æ„è®¾è®¡', 'ç¯ä¿å¥åº·', 'åŒ»ç–—å…»ç”Ÿ'],
    'ç«': ['ç§‘æŠ€åˆ›æ–°', 'èƒ½æºç”µåŠ›', 'å¨±ä¹ä¼ åª’', 'é¤é¥®æœåŠ¡'],
    'åœŸ': ['æˆ¿åœ°äº§', 'å»ºç­‘å·¥ç¨‹', 'é‡‘èæŠ•èµ„', 'å†œä¸šé£Ÿå“'],
    'é‡‘': ['æ³•å¾‹å’¨è¯¢', 'æœºæ¢°åˆ¶é€ ', 'é‡‘èè¯åˆ¸', 'æŠ€æœ¯ç ”å‘'],
    'æ°´': ['è´¸æ˜“ç‰©æµ', 'æ—…æ¸¸æœåŠ¡', 'å’¨è¯¢é¡¾é—®', 'åª’ä½“ä¼ æ’­']
  };
  
  const strongestElement = getStrongestElement(counts);
  let fields = baseFields[dayElement] || ['å¤šå…ƒåŒ–é¢†åŸŸ'];
  
  // å¦‚æœæœ€å¼ºå…ƒç´ ä¸æ—¥ä¸»ä¸åŒï¼Œè¡¥å……ç›¸å…³é¢†åŸŸ
  if (strongestElement !== dayElement && baseFields[strongestElement]) {
    fields = [...new Set([...fields, ...baseFields[strongestElement]])];
  }
  
  return `é€‚åˆä»äº‹${fields.slice(0, 4).join('ã€')}ç­‰ç›¸å…³é¢†åŸŸ`;
}

function analyzeCareerPotential(strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  
  let potential = '';
  if (strength === 'ææ—º' || strength === 'åæ—º') {
    potential = 'å…·æœ‰é¢†å¯¼æ½œåŠ›ï¼Œé€‚åˆè‡ªä¸»åˆ›ä¸šæˆ–ç®¡ç†èŒä½';
  } else {
    potential = 'é€‚åˆä¸“ä¸šå‘å±•ï¼Œåœ¨ç¨³å®šç¯å¢ƒä¸­å‘æŒ¥ä¸“é•¿';
  }
  
  if (elementCount >= 4) {
    potential += 'ï¼Œå¯è€ƒè™‘å¤šå…ƒåŒ–å‘å±•';
  } else if (elementCount <= 2) {
    potential += 'ï¼Œå»ºè®®ä¸“æ³¨æ ¸å¿ƒä¼˜åŠ¿é¢†åŸŸ';
  }
  
  return potential + 'ã€‚';
}

function getCareerDevelopmentAdvice(dayElement, strength) {
  const timing = strength === 'åå¼±' ? 'æ³¨é‡å‰æœŸç§¯ç´¯ï¼Œä¸­å¹´åå‘åŠ›' : 'å¯æ—©æœŸè§„åˆ’ï¼Œç¨³æ­¥æ¨è¿›';
  const approach = strength === 'ææ—º' ? 'ä½†è¦å­¦ä¼šæˆæƒï¼Œé¿å…äº‹å¿…èº¬äº²' : 'æ³¨é‡å›¢é˜Ÿåä½œï¼Œå‘æŒ¥é›†ä½“æ™ºæ…§';
  
  return `å‘å±•ç­–ç•¥ï¼š${timing}ã€‚${approach}ã€‚`;
}

function analyzeWealthCapacity(strength, counts) {
  const wealthElements = Object.values(counts).reduce((a, b) => a + b, 0);
  const capacityScore = strength === 'ææ—º' ? 9 : strength === 'åæ—º' ? 7 : strength === 'ä¸­å’Œ' ? 6 : 4;
  
  if (capacityScore >= 8) return 'è´¢è¿æ½œåŠ›å·¨å¤§ï¼Œæ­£åè´¢çš†æœ‰æœºä¼š';
  if (capacityScore >= 6) return 'è´¢è¿è‰¯å¥½ï¼Œæ­£è´¢ç¨³å®šï¼Œåè´¢éœ€æŠŠæ¡';
  if (capacityScore >= 4) return 'è´¢è¿å¹³ç¨³ï¼Œé€‚åˆç¨³å®šæ”¶å…¥æ¥æº';
  return 'è´¢è¿éœ€è¦åŠªåŠ›å¼€æ‹“ï¼Œæ³¨é‡ç§¯ç´¯';
}

function identifyWealthSources(dayElement, counts) {
  const wealthMap = {
    'æœ¨': counts['åœŸ'], // æœ¨å…‹åœŸä¸ºè´¢
    'ç«': counts['é‡‘'], // ç«å…‹é‡‘ä¸ºè´¢
    'åœŸ': counts['æ°´'], // åœŸå…‹æ°´ä¸ºè´¢
    'é‡‘': counts['æœ¨'], // é‡‘å…‹æœ¨ä¸ºè´¢
    'æ°´': counts['ç«']  // æ°´å…‹ç«ä¸ºè´¢
  };
  
  const wealthCount = wealthMap[dayElement] || 0;
  
  if (wealthCount >= 2) return 'å¤šå…ƒè´¢æºï¼ŒæŠ•èµ„ç†è´¢æœºä¼šè¾ƒå¤š';
  if (wealthCount >= 1) return 'ç¨³å®šè´¢æºä¸ºä¸»ï¼Œé€‚å½“æ‹“å±•å‰¯ä¸š';
  return 'ä»¥æ­£èŒæ”¶å…¥ä¸ºä¸»ï¼Œæ³¨é‡ä¸“ä¸šæŠ€èƒ½æå‡';
}

function generateInvestmentStrategy(percents, counts) {
  const weakest = getWeakestElement(counts);
  const strategies = {
    'æœ¨': 'å¯å…³æ³¨æ•™è‚²ã€ç¯ä¿ã€å¥åº·äº§ä¸šæŠ•èµ„',
    'ç«': 'é€‚åˆç§‘æŠ€ã€èƒ½æºã€åˆ›æ–°é¢†åŸŸæŠ•èµ„',
    'åœŸ': 'æˆ¿åœ°äº§ã€åŸºå»ºç±»æŠ•èµ„è¾ƒä¸ºæœ‰åˆ©',
    'é‡‘': 'é‡‘èã€è´µé‡‘å±ã€æŠ€æœ¯æŠ•èµ„æœºä¼šå¤š',
    'æ°´': 'ç‰©æµã€è´¸æ˜“ã€æœåŠ¡è¡Œä¸šå€¼å¾—å…³æ³¨'
  };
  
  return `æŠ•èµ„å»ºè®®ï¼š${strategies[weakest] || 'å¤šå…ƒåŒ–èµ„äº§é…ç½®ï¼Œåˆ†æ•£é£é™©'}ã€‚`;
}

function analyzeRelationshipPattern(dayElement, gender, counts) {
  let pattern = '';
  
  if (gender === 'ç”·') {
    const wealthCount = counts[getWealthElement(dayElement)] || 0;
    pattern = wealthCount >= 2 ? 'æ„Ÿæƒ…è¿åŠ¿é¡ºç•…ï¼Œå®¹æ˜“é‡åˆ°ç†æƒ³ä¼´ä¾£' : 
              wealthCount >= 1 ? 'æ„Ÿæƒ…éœ€è¦ä¸»åŠ¨ç»è¥ï¼ŒçœŸè¯šç›¸å¾…' : 'æ„Ÿæƒ…éœ€è¦è€å¿ƒç­‰å¾…ï¼Œæ³¨é‡å†…åœ¨ä¿®å…»';
  } else {
    const officerCount = counts[getOfficerElement(dayElement)] || 0;
    pattern = officerCount >= 2 ? 'æ„Ÿæƒ…è‡ªä¸»ï¼Œé€‚åˆå¯»æ‰¾èƒ½åŠ›ç›¸å½“çš„ä¼´ä¾£' : 
              officerCount >= 1 ? 'æ„Ÿæƒ…ç¨³å®šï¼Œéœ€è¦äº’ç›¸ç†è§£æ”¯æŒ' : 'æ„Ÿæƒ…éœ€è¦æ›´å¤šåŒ…å®¹ï¼Œæ™šå©šè¾ƒä½³';
  }
  
  return pattern;
}

function calculateMarriageTiming(strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  let timing = '';
  
  if (strength === 'ææ—º') timing = '28å²å';
  else if (strength === 'åæ—º') timing = '25-30å²';
  else if (strength === 'ä¸­å’Œ') timing = '24-28å²';
  else timing = '26å²å';
  
  return `å©šå§»æ—¶æœºï¼š${timing}è¾ƒä¸ºç†æƒ³${elementCount <= 2 ? 'ï¼Œå»ºè®®å¤šäº†è§£å†å†³å®š' : ''}ã€‚`;
}

function analyzePartnerCompatibility(dayElement, counts) {
  const compatibleElements = {
    'æœ¨': ['åœŸ', 'é‡‘'], // æœ¨éœ€è¦åœŸåŸ¹ã€é‡‘ä¿®
    'ç«': ['æ°´', 'é‡‘'], // ç«éœ€è¦æ°´æµã€é‡‘è´¢
    'åœŸ': ['æœ¨', 'æ°´'], // åœŸéœ€è¦æœ¨ç–ã€æ°´æ¶¦
    'é‡‘': ['ç«', 'æœ¨'], // é‡‘éœ€è¦ç«ç‚¼ã€æœ¨è´¢
    'æ°´': ['åœŸ', 'ç«']  // æ°´éœ€è¦åœŸå ¤ã€ç«æš–
  };
  
  const elements = compatibleElements[dayElement] || ['åœŸ', 'é‡‘'];
  return `ç†æƒ³ä¼´ä¾£ï¼šä¸${elements.join('ã€')}å…ƒç´ è¾ƒå¼ºçš„äººäº’è¡¥æ€§ä½³ã€‚`;
}

function generateElementAnalysis(percents) {
  let analysis = '';
  const elements = [
    { name: 'æœ¨', value: percents.wood },
    { name: 'ç«', value: percents.fire },
    { name: 'åœŸ', value: percents.earth },
    { name: 'é‡‘', value: percents.metal },
    { name: 'æ°´', value: percents.water }
  ];
  
  elements.forEach(elem => {
    let desc = '';
    if (elem.value > 25) desc = 'èƒ½é‡å……æ²›ï¼Œä¼˜åŠ¿æ˜æ˜¾';
    else if (elem.value > 15) desc = 'èƒ½é‡é€‚ä¸­ï¼Œå‘å±•å¹³ç¨³';
    else if (elem.value > 5) desc = 'èƒ½é‡åå¼±ï¼Œéœ€è¦åŠ å¼º';
    else desc = 'èƒ½é‡ä¸è¶³ï¼Œé‡ç‚¹è¡¥å……';
    
    analysis += `<p>â€¢ ${elem.name}å…ƒç´ ï¼š${Math.round(elem.value)}% - ${desc}</p>`;
  });
  
  return analysis;
}

function generatePatternInsight(pattern, dayElement, percents) {
  const insights = {
    'å»ºç¦„æ ¼': `è‡ªç«‹è‡ªå¼ºï¼Œ${dayElement === 'é‡‘' ? 'æŠ€æœ¯é¢†å¯¼åŠ›å¼º' : dayElement === 'æœ¨' ? 'æ•™è‚²æ–‡åŒ–é¢†åŸŸæœ‰ä¼˜åŠ¿' : 'é€‚åˆåˆ›ä¸šå‘å±•'}`,
    'èº«æ—ºæ ¼': `ç²¾åŠ›å……æ²›ï¼Œ${percents[dayElement] > 25 ? 'ä¼˜åŠ¿æ˜æ˜¾ä½†éœ€æ³¨æ„å¹³è¡¡' : 'æ‰§è¡ŒåŠ›å¼ºé€‚åˆè¿›å–'}`,
    'èº«å¼±æ ¼': `å–„äºåˆä½œï¼Œ${getWeakestElementFromPercents(percents) === dayElement ? 'éœ€è¦é‡ç‚¹åŠ å¼ºè‡ªèº«èƒ½é‡' : 'å€ŸåŠ©å¤–åŠ›å¯è·æˆåŠŸ'}`,
    'ä¸­å’Œæ ¼': `å¹³è¡¡ç¨³å®šï¼Œ${Object.values(percents).filter(p => p > 15).length >= 3 ? 'å…¨é¢å‘å±•æœºä¼šå¤š' : 'ä¸“æ³¨ä¼˜åŠ¿é¢†åŸŸ'}`
  };
  
  return insights[pattern] || 'éœ€è¦ç»“åˆå…·ä½“å‘½å±€æ·±å…¥åˆ†æ';
}

function generateDailyPractices(dayElement, percents) {
  const practices = {
    'æœ¨': {
      morning: 'æ¸…æ™¨å…¬å›­æ•£æ­¥ï¼Œå‘¼å¸æ–°é²œç©ºæ°”',
      work: 'å·¥ä½œä¸­å¤šæ²Ÿé€šåä½œï¼ŒåŸ¹å…»å›¢é˜Ÿç²¾ç¥',
      health: 'å¤šåƒç»¿è‰²è”¬èœï¼Œä¿æŠ¤è‚èƒ†å¥åº·',
      evening: 'é˜…è¯»åŠ±å¿—ä¹¦ç±ï¼Œè§„åˆ’æ˜æ—¥ç›®æ ‡'
    },
    'ç«': {
      morning: 'æ™¨é—´æœ‰æ°§è¿åŠ¨ï¼Œæ¿€æ´»èº«ä½“èƒ½é‡',
      work: 'ä¿æŒå·¥ä½œçƒ­æƒ…ï¼Œä¸»åŠ¨è¿æ¥æŒ‘æˆ˜',
      health: 'æ³¨æ„å¿ƒè„ä¿å¥ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯',
      evening: 'ä¸æœ‹å‹äº¤æµï¼Œåˆ†äº«æ¯æ—¥æ”¶è·'
    },
    'åœŸ': {
      morning: 'æ¸…æ™¨å†¥æƒ³ï¼Œç¨³å®šå¿ƒç»ª',
      work: 'æ³¨é‡å·¥ä½œç»†èŠ‚ï¼Œå»ºç«‹ç³»ç»Ÿæµç¨‹',
      health: 'è§„å¾‹é¥®é£Ÿï¼Œæ³¨æ„è„¾èƒƒä¿å…»',
      evening: 'æ•´ç†å®¶å±…ç¯å¢ƒï¼Œåˆ›é€ èˆ’é€‚ç©ºé—´'
    },
    'é‡‘': {
      morning: 'åˆ¶å®šè¯¦ç»†è®¡åˆ’ï¼Œæ˜ç¡®ç›®æ ‡',
      work: 'è¿½æ±‚ä¸“ä¸šå“è¶Šï¼Œæå‡æŠ€èƒ½',
      health: 'æ³¨æ„å‘¼å¸ç³»ç»Ÿï¼Œå¤šå–æ¸©æ°´',
      evening: 'å­¦ä¹ æ–°çŸ¥è¯†ï¼Œæå‡è‡ªæˆ‘'
    },
    'æ°´': {
      morning: 'æ¸…æ™¨æ¸©æ°´ï¼Œå¯åŠ¨èº«ä½“ä»£è°¢',
      work: 'çµæ´»åº”å˜ï¼Œå–„äºæŠ“ä½æœºä¼š',
      health: 'æ³¨æ„è‚¾è„ä¿å¥ï¼Œé€‚å½“è¡¥æ°´',
      evening: 'åæ€æ€»ç»“ï¼Œç§¯ç´¯æ™ºæ…§'
    }
  };
  
  const practice = practices[dayElement] || practices['æœ¨'];
  return `
    <ul class="action-list">
      <li>æ—©æ™¨ï¼š${practice.morning}</li>
      <li>å·¥ä½œï¼š${practice.work}</li>
      <li>å¥åº·ï¼š${practice.health}</li>
      <li>æ™šé—´ï¼š${practice.evening}</li>
    </ul>
  `;
}

// ==================== è¾…åŠ©å‡½æ•° ====================

function getStrongestElement(counts) {
  let maxCount = 0;
  let strongest = '';
  for (const [element, count] of Object.entries(counts)) {
    if (count > maxCount) {
      maxCount = count;
      strongest = element;
    }
  }
  return strongest;
}

function getWeakestElement(counts) {
  let minCount = Infinity;
  let weakest = '';
  for (const [element, count] of Object.entries(counts)) {
    if (count < minCount && count > 0) {
      minCount = count;
      weakest = element;
    }
  }
  return weakest || 'æœ¨';
}

function getWeakestElementFromPercents(percents) {
  let minPercent = 100;
  let weakest = '';
  for (const [element, percent] of Object.entries(percents)) {
    if (percent < minPercent) {
      minPercent = percent;
      weakest = element;
    }
  }
  return weakest;
}

function isElementSupportive(element1, element2) {
  // ç›¸ç”Ÿå…³ç³»ï¼šæœ¨ç”Ÿç«ï¼Œç«ç”ŸåœŸï¼ŒåœŸç”Ÿé‡‘ï¼Œé‡‘ç”Ÿæ°´ï¼Œæ°´ç”Ÿæœ¨
  const supportivePairs = {
    'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘', 'é‡‘': 'æ°´', 'æ°´': 'æœ¨'
  };
  return supportivePairs[element1] === element2;
}

function isElementControlling(element1, element2) {
  // ç›¸å…‹å…³ç³»ï¼šæœ¨å…‹åœŸï¼ŒåœŸå…‹æ°´ï¼Œæ°´å…‹ç«ï¼Œç«å…‹é‡‘ï¼Œé‡‘å…‹æœ¨
  const controllingPairs = {
    'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘', 'é‡‘': 'æœ¨'
  };
  return controllingPairs[element1] === element2;
}

function getWealthElement(dayElement) {
  const wealthMap = { 'æœ¨': 'åœŸ', 'ç«': 'é‡‘', 'åœŸ': 'æ°´', 'é‡‘': 'æœ¨', 'æ°´': 'ç«' };
  return wealthMap[dayElement];
}

function getOfficerElement(dayElement) {
  const officerMap = { 'æœ¨': 'é‡‘', 'ç«': 'æ°´', 'åœŸ': 'æœ¨', 'é‡‘': 'ç«', 'æ°´': 'åœŸ' };
  return officerMap[dayElement];
}

function getElementInteractionAdvice(strongest, weakest) {
  const adviceMap = {
    'æœ¨': 'åŠ å¼ºå†³æ–­åŠ›ï¼Œä½†è¦æ³¨æ„è€å¿ƒ',
    'ç«': 'ä¿æŒçƒ­æƒ…ï¼Œä½†éœ€æ§åˆ¶å†²åŠ¨',
    'åœŸ': 'ç¨³é‡å¯é ï¼Œä½†è¦é¿å…å›ºæ‰§',
    'é‡‘': 'åšæ¯…æœæ–­ï¼Œä½†éœ€æ³¨æ„çµæ´»æ€§',
    'æ°´': 'æ™ºæ…§çµæ´»ï¼Œä½†è¦å¢å¼ºè¡ŒåŠ¨åŠ›'
  };
  
  return `å»ºè®®ï¼šå‘æŒ¥${strongest}å…ƒç´ ä¼˜åŠ¿${adviceMap[strongest] ? `ï¼Œ${adviceMap[strongest]}` : ''}ï¼ŒåŒæ—¶åŠ å¼º${weakest}å…ƒç´ èƒ½é‡ã€‚`;
}

// VIPç™»å½•ç³»ç»Ÿ
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';  
  
// åˆå§‹åŒ–å‡½æ•°
function init() {
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    birthdateInput.value = `${year}-${month}-${day}`;
  }

  // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
  const birthtimeInput = $('birthtime');
  if (birthtimeInput && !birthtimeInput.value) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    birthtimeInput.value = `${hours}:${minutes}`;
  }

  // ç»‘å®šäº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // ç»‘å®šè¿”å›æŒ‰é’®
  const backBtn = $('backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', backToMainAnalysis);
  }
  // ä¸ºè¯¦ç»†åˆ†ææŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('chip') && e.target.dataset.type) {
      const type = e.target.dataset.type;
      if (window.currentBaziData) {
        showDetailAnalysis(type, window.currentBaziData.pillars, window.currentBaziData.strengthAnalysis);
      } else {
        showAuthErr('è¯·å…ˆç”Ÿæˆå…«å­—åˆ†æ');
      }
    }
  });

  // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // å›è½¦é”®å¿«é€Ÿç”Ÿæˆ
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('å…«å­—å‘½ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}

// åˆå§‹åŒ–è¯­è¨€æ”¯æŒ
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (langSelect) {
    // æ¢å¤ç”¨æˆ·çš„è¯­è¨€é€‰æ‹©
    const savedLang = localStorage.getItem('preferredLanguage') || 'zh-CN';
    langSelect.value = savedLang;
    translatePage(savedLang);
    
    langSelect.addEventListener('change', () => {
      translatePage(langSelect.value);
    });
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
