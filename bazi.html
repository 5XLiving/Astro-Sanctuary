<script>
'use strict';

/* ========= i18n 词典（静态 + 动态） ========= */
const I18N = {
  'zh-CN': {
    brand: { subtitle: '5xLiving · 八字简评' },
    nav: { langLabel: '语言' },
    lang: { 'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu' },

    app: { title: '八字命理 · 快速排盘' },

    form: {
      nameLabel: '姓名（可选）',
      namePlaceholder: '你的称呼（用于个性化）',
      genderLabel: '性别',
      gender: { hidden:'不透露', male:'男性', female:'女性' },
      calendarLabel: '历法',
      calendar: { gregorian:'阳历', lunar:'农历' },
      birthdateLabel: '出生日期',
      birthtimeLabel: '出生时间',
      timeUnknown: '出生时间不详'
    },

    btn: { generate:'生成八字', loading:'计算中...' },

    result: { title:'您的生辰八字命盘' },
    pillar: { year:'年柱', month:'月柱', day:'日柱', hour:'时柱' },
    table: { row: { stem:'天干', branch:'地支', fiveElem:'五行', nayin:'纳音' } },

    energy: { title:'五行能量分析' },
    elem: { wood:'木', fire:'火', earth:'土', metal:'金', water:'水' },

    pro: { title:'🧙‍♂️ 心怜管家 · 专业命理分析', welcome:'您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。' },
    chat: { send:'发送', placeholder:'请输入您的问题...' },

    vip: {
      title:'🌙 会员区域 VIP Segment',
      group: { astrology:'🗝 命理空间专属内容', spiritual:'🌙 心怜空间专属内容' },
      astrology: { match:'姻缘方向：恋爱缘分、婚姻走势', career:'事业方向：职场发展、创业潜力', wealth:'财运方向：财位分析、理财时机', pet:'宠物命理：伴侣动物的性格与缘分' },
      spiritual: { record:'灵性记录：照片、梦境、声音、愿望祈祷', courses:'命理课程：八字 / 塔罗 / 占星 / 灵数', family:'家族纪念系统：亲人灵性纪念 & 延续', practice:'每周能量练习 / 神明仪式任务' },
      login: { title:'💎 登入 VIP 功能' },
      services: { header:'会员服务' },
      upgrade:'💎 升级为 VIP（月费）',
      back:'← 返回命理商城',
      priceNote:'$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）'
    },

    auth: {
      header:'账户登录 / 注册',
      login:'登入账户',
      reset:'🔑 重设密码',
      register:'注册账户',
      freeTrialNote:'注册账号赠送一次免费体验',
      emailPlaceholder:'邮箱 Email',
      passwordPlaceholder:'密码 Password（至少8位，含大小写数字符号）'
    },

    footer: { copy:'© 5XLiving • Astro Sanctuary' },

    // 动态文案
    err: {
      fillBirthdate: '请填写出生日期',
      invalidDate:   '无效的日期格式，请用 YYYY-MM-DD',
      generateFail:  '生成失败，请稍后重试'
    },
    ui: {
      unknown:      '未知',
      timeUnknown:  '时间不详',
      hourSuffix:   '{h}时',
      birthSummary: '出生日期: {y}年{m}月{d}日 {timeText}',
      balance:      '五行中{strongest}最强，{weakest}最弱。'
    },
    badge: { noHour: '未纳入时柱' },
    chatDyn:  { autoReply: '收到：{q}。稍后可在专业报告相应章节找到要点。' },
    elemNames: { 木:'木', 火:'火', 土:'土', 金:'金', 水:'水' },
    report: { hourUnknownTip: '⚠️ 提示：因出生时间不详，部分分析仅供参考。' }
  },

  'en': {
    brand: { subtitle: '5xLiving · Bazi Brief' },
    nav: { langLabel: 'Language' },
    lang: { 'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu' },

    app: { title: 'Bazi · Quick Chart' },

    form: {
      nameLabel: 'Name (optional)',
      namePlaceholder: 'Your name (for personalization)',
      genderLabel: 'Gender',
      gender: { hidden:'Prefer not to say', male:'Male', female:'Female' },
      calendarLabel: 'Calendar',
      calendar: { gregorian:'Gregorian', lunar:'Lunar' },
      birthdateLabel: 'Birth Date',
      birthtimeLabel: 'Birth Time',
      timeUnknown: 'Time unknown'
    },

    btn: { generate:'Generate', loading:'Calculating...' },

    result: { title:'Your Bazi Chart' },
    pillar: { year:'Year', month:'Month', day:'Day', hour:'Hour' },
    table: { row: { stem:'Heavenly Stem', branch:'Earthly Branch', fiveElem:'Five Elements', nayin:'Nayin' } },

    energy: { title:'Five-Element Energy Analysis' },
    elem: { wood:'Wood', fire:'Fire', earth:'Earth', metal:'Metal', water:'Water' },

    pro: { title:'🧙‍♂️ Butler · Professional Analysis', welcome:'Hi! I\'ve generated your detailed analysis. Ask me anything.' },
    chat: { send:'Send', placeholder:'Type your question...' },

    vip: {
      title:'🌙 VIP Segment',
      group: { astrology:'🗝 Exclusive Astrology Content', spiritual:'🌙 Spiritual Space Exclusives' },
      astrology: { match:'Relationships: love & marriage', career:'Career: workplace & entrepreneurship', wealth:'Wealth: positions & timing', pet:'Pet astrology: personality & bond' },
      spiritual: { record:'Spiritual records: photos, dreams, voice, prayers', courses:'Courses: Bazi / Tarot / Astrology / Numerology', family:'Family memorial system', practice:'Weekly practices / rituals' },
      login: { title:'💎 Sign in for VIP' },
      services: { header:'Membership' },
      upgrade:'💎 Upgrade to VIP (Monthly)',
      back:'← Back to Store',
      priceNote:'$9.9 / month (Astro + Spiritual + Courses)'
    },

    auth: {
      header:'Sign In / Register',
      login:'Sign In',
      reset:'🔑 Reset Password',
      register:'Register',
      freeTrialNote:'New accounts get one free trial',
      emailPlaceholder:'Email',
      passwordPlaceholder:'Password (min 8 chars, mixed case & symbols)'
    },

    footer: { copy:'© 5XLiving • Astro Sanctuary' },

    // dynamic
    err: {
      fillBirthdate: 'Please enter your birth date',
      invalidDate:   'Invalid date. Use YYYY-MM-DD.',
      generateFail:  'Failed to generate. Please try again later.'
    },
    ui: {
      unknown:      'Unknown',
      timeUnknown:  'time unknown',
      hourSuffix:   '{h}:00',
      birthSummary: 'Birth date: {y}-{m}-{d} {timeText}',
      balance:      'Among the Five Elements, {strongest} is strongest and {weakest} is weakest.'
    },
    badge: { noHour: 'Hour not included' },
    chatDyn:  { autoReply: 'Got it: {q}. Find key points in the relevant sections.' },
    elemNames: { 木:'Wood', 火:'Fire', 土:'Earth', 金:'Metal', 水:'Water' },
    report: { hourUnknownTip: '⚠️ Note: Birth time unknown, some analysis is for reference only.' }
  }
};

/* ========= i18n 工具 ========= */
function getLang(){
  const sel = document.getElementById('langSelect');
  return (localStorage.getItem('lang') || (sel && sel.value) || 'zh-CN');
}
function setLang(lang){
  try{ localStorage.setItem('lang', lang) }catch(e){}
}
function t(key, vars={}){
  const dict = I18N[getLang()] || I18N['zh-CN'];
  const base = key.split('.').reduce((o,k)=>o && o[k], dict);
  const fallback = key.split('.').reduce((o,k)=>o && o[k], I18N['zh-CN']);
  let s = (base || fallback || String(key));
  return s.replace(/\{(\w+)\}/g, (_,k)=> (vars[k] ?? ''));
}
function elName(cn){ const dict = I18N[getLang()] || I18N['zh-CN']; return (dict.elemNames && dict.elemNames[cn]) || cn; }

/* 将所有 [data-i18n] 文本 & 常用 placeholder 同步到当前语言 */
function applyI18n(){
  const lang = getLang();
  document.documentElement.lang = lang;

  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });

  // 常用 placeholder（无需在 HTML 上加 data-i18n-placeholder）
  const placeholders = [
    ['name',      'form.namePlaceholder'],
    ['chatInput', 'chat.placeholder'],
    ['email',     'auth.emailPlaceholder'],
    ['password',  'auth.passwordPlaceholder']
  ];
  placeholders.forEach(([id,key])=>{
    const el = document.getElementById(id);
    if(el) el.setAttribute('placeholder', t(key));
  });
}

// 监听语言切换
(function bindLangSelect(){
  const sel = document.getElementById('langSelect');
  if(!sel) return;
  const saved = getLang();
  sel.value = saved;
  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n();
    try{ rerenderDynamicTexts(); }catch(e){}
  });
})();

/* ========= 工具 ========= */
const $ = id => document.getElementById(id);
function showError(message){const e=$('error'); if(!e) return; e.textContent=message; e.style.display='block'; setTimeout(()=>{e.style.display='none'},5000)}
function showAuthErr(message){const e=$('authError'); if(!e) return; e.textContent=message; e.style.display='block'; setTimeout(()=>{e.style.display='none'},5000)}
function hideAuthErr(){const e=$('authError'); if(!e) return; e.style.display='none'; e.textContent=''}
function lock(el,v){ if(el) el.disabled=v }
function setText(id, text){ const el=$(id); if(el) el.textContent=text }
function setBar(elementId, percentage){ const bar=$(elementId); if(bar){ requestAnimationFrame(()=>{ bar.style.width=Math.max(0,Math.min(100,percentage))+'%' }) } }

/* ========= 八字计算 ========= */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year){const s=(year-4)%10,b=(year-4)%12; return {stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}}
  solarMonthIndex(y,m,d){const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return {index:idx, branch:branchBy[idx]}}
  calculateMonthPillar(year,month,day){const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return {stem:this.HEAVENLY_STEMS[stemIdx], branch} }
  calculateDayPillar(year,month,day){const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10], branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}}
  calculateHourPillar(dayStem,hour){const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]} }
  getElement(stem,branch){const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`}
  getNayin(stem,branch){const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]}
  getStemElement(stem){return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]}
  getBranchElement(branch){return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]}
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？') cnt[this.getStemElement(p.stem)]++; if(p.branch&&p.branch!=='？') cnt[this.getBranchElement(p.branch)]++ })
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={ wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return {pillars, counts:cnt, percents:pct, timeUnknown}
  }
}
const baziCalculator=new BaziCalculator();

/* ========= 显示渲染 ========= */
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  const items = [
    { t: t('pillar.year'),  p: pillars.year  },
    { t: t('pillar.month'), p: pillars.month },
    { t: t('pillar.day'),   p: pillars.day   },
    { t: t('pillar.hour'),  p: pillars.hour  }
  ];

  items.forEach(({ t, p }) => {
    const u = timeUnknown && (t === t('pillar.hour'));
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${t}</div>
      <div class="gz">${u ? '？' : p.stem}${u ? '？' : p.branch}</div>
    `;
    container.appendChild(div);
  });
}

function displayDetailedInfo(pillars, timeUnknown=false){
  setText('year-stem', pillars.year.stem); setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem); setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem); setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown?'？':pillars.hour.stem); setText('hour-branch', timeUnknown?'？':pillars.hour.branch);
  setText('year-element', baziCalculator.getElement(pillars.year.stem, pillars.year.branch));
  setText('month-element', baziCalculator.getElement(pillars.month.stem, pillars.month.branch));
  setText('day-element', baziCalculator.getElement(pillars.day.stem, pillars.day.branch));
  setText('hour-element', timeUnknown?t('ui.unknown'):baziCalculator.getElement(pillars.hour.stem, pillars.hour.branch));
  setText('year-nayin', baziCalculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', baziCalculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', baziCalculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown?t('ui.unknown'):baziCalculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

/* ========= 十神映射 ========= */
const TEN_GODS_MAP={
  '甲':{'甲':'比肩','乙':'劫财','丙':'食神','丁':'伤官','戊':'偏财','己':'正财','庚':'七杀','辛':'正官','壬':'偏印','癸':'正印'},
  '乙':{'甲':'劫财','乙':'比肩','丙':'伤官','丁':'食神','戊':'正财','己':'偏财','庚':'正官','辛':'七杀','壬':'正印','癸':'偏印'},
  '丙':{'甲':'偏印','乙':'正印','丙':'比肩','丁':'劫财','戊':'食神','己':'伤官','庚':'偏财','辛':'正财','壬':'七杀','癸':'正官'},
  '丁':{'甲':'正印','乙':'偏印','丙':'劫财','丁':'比肩','戊':'伤官','己':'食神','庚':'正财','辛':'偏财','壬':'正官','癸':'七杀'},
  '戊':{'甲':'七杀','乙':'正官','丙':'偏印','丁':'正印','戊':'比肩','己':'劫财','庚':'食神','辛':'伤官','壬':'偏财','癸':'正财'},
  '己':{'甲':'正官','乙':'七杀','丙':'正印','丁':'偏印','戊':'劫财','己':'比肩','庚':'伤官','辛':'食神','壬':'正财','癸':'偏财'},
  '庚':{'甲':'偏财','乙':'正财','丙':'七杀','丁':'正官','戊':'偏印','己':'正印','庚':'比肩','辛':'劫财','壬':'食神','癸':'伤官'},
  '辛':{'甲':'正财','乙':'偏财','丙':'正官','丁':'七杀','戊':'正印','己':'偏印','庚':'劫财','辛':'比肩','壬':'伤官','癸':'食神'},
  '壬':{'甲':'食神','乙':'伤官','丙':'偏财','丁':'正财','戊':'七杀','己':'正官','庚':'偏印','辛':'正印','壬':'比肩','癸':'劫财'},
  '癸':{'甲':'伤官','乙':'食神','丙':'正财','丁':'偏财','戊':'正官','己':'七杀','庚':'正印','辛':'偏印','壬':'劫财','癸':'比肩'}
};

/* ========= 报告生成（保持你原逻辑不变） ========= */
function analyzeElementsDynamic(counts, dayElement){
  const elements=['木','火','土','金','水'];
  return elements.map(el=>{
    const c=counts[el]||0; const relation=getElementRelation(dayElement,el);
    return `<p><strong>${el}元素：</strong>${c}个 - ${relation}</p>`
  }).join('')
}
function getElementRelation(dayEl,target){
  const r={
    '木':{'木':'同我','火':'我生','土':'我克','金':'克我','水':'生我'},
    '火':{'木':'生我','火':'同我','土':'我生','金':'我克','水':'克我'},
    '土':{'木':'克我','火':'我生','土':'同我','金':'我克','水':'我生'},
    '金':{'木':'我克','火':'克我','土':'生我','金':'同我','水':'我生'},
    '水':{'木':'我生','火':'我克','土':'克我','金':'生我','水':'同我'}
  }; return r[dayEl]?.[target]||'未知关系'
}
function analyzeTenGodsDynamic(pillars, dayStem){
  const pos=['年柱','月柱','日柱','时柱']; const keys=['year','month','day','hour'];
  return keys.map((k,i)=>{ const st=pillars[k].stem; if(!st||st==='？') return '';
    const tg=TEN_GODS_MAP[dayStem]?.[st]||'未知'; return `<p><strong>${pos[i]}：</strong>${tg}（${st}）</p>`
  }).join('')
}
function getSupportingElements(el){return ({'木':['水','木'],'火':['木','火'],'土':['火','土'],'金':['土','金'],'水':['金','水']})[el]||[]}
function getControllingElements(el){return ({'木':['金','火','土'],'火':['水','土','金'],'土':['木','金','水'],'金':['火','水','木'],'水':['土','木','火']})[el]||[]}
function getSeasonalAdvice(monthBranch){
  const m={ '寅':'春木旺，宜金制木', '卯':'春木旺，宜金制木', '辰':'春末土旺，宜木疏土',
            '巳':'夏火旺，宜水济火', '午':'夏火旺，宜水济火', '未':'夏末土旺，宜水润土',
            '申':'秋金旺，宜火炼金', '酉':'秋金旺，宜火炼金', '戌':'秋末土旺，宜木疏土',
            '亥':'冬水旺，宜火暖局', '子':'冬水旺，宜火暖局', '丑':'冬末土旺，宜火暖土' };
  return m[monthBranch]||'四时调候，以衡平为先'
}
function getLuckyColors(useful){const map={'木':'绿色、青色','火':'红色、紫色','土':'黄色、棕色','金':'白色、金色','水':'黑色、蓝色'}; return useful.map(x=>map[x]).filter(Boolean).join('、')}
function getLuckyDirections(useful){const map={'木':'东方','火':'南方','土':'中央','金':'西方','水':'北方'}; return useful.map(x=>map[x]).filter(Boolean).join('、')}
function getCareerReason(dayStem){const r={'甲':'领导力强，擅开拓','乙':'适应协调佳','丙':'热情创意强','丁':'细致策划优','戊':'稳健管理强','己':'务实服务稳','庚':'果断执行强','辛':'审美与质感强','壬':'流动与整合强','癸':'洞察与研究强'}; return r[dayStem]||'综合能力均衡'}
function getSuitableCareers(dayStem){
  const m={'甲':['管理','领导','开拓'],'乙':['艺术','教育','服务'],'丙':['创意','传媒','娱乐'],'丁':['技术','研究','策划'],'戊':['金融','地产','管理'],'己':['教育','医疗','服务'],'庚':['法律','军警','技术'],'辛':['金融','珠宝','艺术'],'壬':['贸易','物流','咨询'],'癸':['文化','艺术','心理学']};
  const arr=m[dayStem]||['综合发展'];
  return arr.map(field=>({field,reason:getCareerReason(dayStem)}))
}
function getSuitableIndustries(dayStem){
  const el=baziCalculator.getStemElement(dayStem);
  const map={
    '木':'林木/教育/文创/设计/医疗/生物',
    '火':'能源/餐饮/电商/传媒/演出',
    '土':'不动产/农业/土木/中介/仓储',
    '金':'金融/金属/法律/安保/精密制造',
    '水':'航运/物流/旅游/咨询/数据/软件'
  };
  return map[el]||'综合行业均可'
}
function getWorkplaceStrengths(dayStem){
  const m={'甲':'直率担当、执行力强','乙':'人和力强、润物细无声','丙':'感染力强、善点燃团队','丁':'策略细腻、稳扎稳打','戊':'可靠可信、能扛重责','己':'服务意识强、稳定协同','庚':'规则意识强、快速决断','辛':'品质感高、细节控','壬':'视野大、跨界整合','癸':'洞察深、学习快'};return m[dayStem]||'稳健务实'}
function getCareerAdvice(pillars,counts){
  const weak = Object.entries(counts).sort((a,b)=>a[1]-b[1])[0][0];
  return `聚焦${getSuitableIndustries(pillars.day.stem)}方向，发挥${getWorkplaceStrengths(pillars.day.stem)}；适度补${weak}之不足，形成闭环优势。`
}
function countWealthGods(pillars, dayStem){
  const stems=[pillars.year.stem,pillars.month.stem,pillars.hour.stem].filter(s=>s&&s!=='？');
  return stems.reduce((n,s)=>{const g=TEN_GODS_MAP[dayStem]?.[s]; return n+((g==='正财'||g==='偏财')?1:0)},0)
}
function countOfficerGods(pillars, dayStem){
  const stems=[pillars.year.stem,pillars.month.stem,pillars.hour.stem].filter(s=>s&&s!=='？');
  return stems.reduce((n,s)=>{const g=TEN_GODS_MAP[dayStem]?.[s]; return n+((g==='正官'||g==='七杀')?1:0)},0)
}
function analyzeWealthPattern(pillars, dayStem){
  const w=countWealthGods(pillars,dayStem); const o=countOfficerGods(pillars,dayStem);
  let level='中等'; if(w>=2&&o>=1) level='较好'; if(w>=2&&o>=2) level='上等';
  const desc=(w>0?`见财星${w}处`:'财星弱')+'；'+(o>0?`官星${o}助规范`:'少官星，宜自由职业');
  const dirs=['正东方','东南方','南方'];
  const advice='重视现金流与复利，少做高杠杆；以主业现金奶牛+副业成长为双轮。';
  const invest='宜：指数基金/现金流型标的；忌：短线重仓、情绪化追涨杀跌。';
  return {level, description:desc, directions:dirs, advice, investmentTips:invest}
}
function getLoveAnalysis(dayStem, counts){
  const el=baziCalculator.getStemElement(dayStem); const water=counts['水']||0; const fire=counts['火']||0;
  let pattern='重情理性并重'; if(fire>=3) pattern='热烈直接、先情后理'; if(water>=3) pattern='感受细腻、先理后情';
  const ideal={'木':'温柔体贴、价值观契合','火':'欣赏与鼓励、节奏相近','土':'稳定可靠、务实共建','金':'规则边界清晰、彼此尊重','水':'沟通顺滑、心智同频'}[el];
  const advice='先定节奏与边界，再谈深度；以共同目标为牵引，少用试探。';
  const timing='逢桃花与财官透出之年更易定局（参考流年支与十神）。';
  const notes='避免情绪拉扯与长期不确定，保持“反馈—修正”两周一循环。';
  return {pattern, idealPartner:ideal, advice, timing, notes}
}
function getHealthAnalysis(dayElement, counts){
  const tips={'木':'肝胆/筋，宜拉伸与早睡','火':'心小肠/血压，宜有氧与冥想','土':'脾胃/代谢，宜清淡规律','金':'肺大肠/皮肤，宜呼吸练习','水':'肾膀胱/腰膝，宜补水与早寝'};
  const diet={'木':'多绿叶蔬果，少油炸','火':'多高纤低糖，少辛辣','土':'少甜少油，多粗粮','金':'多白色蔬果，戒烟尘','水':'多水与黑色食材，少熬夜'};
  const exercise={'木':'瑜伽/普拉提/拉伸','火':'跑步/舞动/球类','土':'快走/徒步/力量','金':'呼吸操/骑行','水':'游泳/太极/核心稳定'};
  const weak=Object.entries(counts).sort((a,b)=>a[1]-b[1])[0][0];
  return {constitution:tips[dayElement]||'平衡体质', vulnerabilities:[weak+'相关系统'], healthTips:'围绕作息、补短板元素做干预', dietAdvice:diet[dayElement]||'清淡均衡', exercise:exercise[dayElement]||'中等强度有氧'}
}
function getSpiritualAnalysis(dayStem){
  const trait={'甲':'使命驱动、适合“修身立业”并行','乙':'感知细腻、适合疗愈与艺术修行','丙':'光亮外放、适合带领社群','丁':'烛照细火、适合心性与经典研修','戊':'山岳定力、适合长期纪律修行','己':'厚德载物、适合服务型修行','庚':'斩断果决、适合戒律与武修','辛':'匠心纯粹、适合精微之学','壬':'包容流动、适合水法/禅修','癸':'深潜静定、适合观想内修'};
  return {traits:trait[dayStem]||'综合型', talents:['冥想','祈愿','记录'], practices:'晨静坐+晚复盘，周一固定“净心日”', advice:'以“日课10分钟”打底，月度做一次小闭关'}
}
function getYearlyLuck(year, pillars){
  const br=pillars.month.branch; const hint={'寅':'木风起，宜开新局','卯':'谋定后动','辰':'稳健推进','巳':'声量提升','午':'人气活跃','未':'收束沉淀','申':'结构调整','酉':'品牌打磨','戌':'资源整合','亥':'蓄势学习','子':'现金流优先','丑':'稳步积累'}[br]||'平衡为先';
  return `${year}：${hint}`
}
function getCareerOpportunities(){return 'Q2-Q3 外缘更旺，宜立项/签约；Q4 收口交付。'}
function getWealthTrend(){return '现金流先行，做“强收款+弱投机”；重点看复购与口碑。'}
function getLoveTrend(){return '沟通效率提升，宜明确“关系节奏表”。'}
function getHealthWarning(){return '注意睡眠与消化，别连轴转；每周至少2次中强度运动。'}

function getLifeStrategy(dayStem, bodyStrength, counts){
  const weak=Object.entries(counts).sort((a,b)=>a[1]-b[1])[0][0];
  return {
    stages:[
      {period:'0-35', focus:'打基础/验赛道，做一技之长'},
      {period:'35-50', focus:'形成产品化/品牌化，扩大现金流'},
      {period:'50+', focus:'知识沉淀/版权化/传承'}
    ],
    coreStrategy:`以“强项×场景”打造可复制产品；每季修正一次路线。`,
    keyDecisions:`围绕 ${getSuitableIndustries(dayStem)} 做聚焦，弱化${weak}相关的短板业务。`,
    growthTips:'使用OKR与周复盘，建立数据看板与复盘节律。'
  }
}

/* ========= 综合报告装配 ========= */
function generateDynamicReport(baziData){
  const {pillars, counts, percents, timeUnknown}=baziData; const dayStem=pillars.day.stem; const dayElement=pillars.day.element;
  const total=Object.values(counts).reduce((a,b)=>a+b,0); const selfStrength=((counts[dayElement]/(total||1))*100).toFixed(1); const bodyStrength=parseFloat(selfStrength)>=30?'身强':'身弱';
  const useful = (parseFloat(selfStrength)>=30) ? getControllingElements(dayElement) : getSupportingElements(dayElement);
  const avoid  = (parseFloat(selfStrength)>=30) ? getSupportingElements(dayElement) : getControllingElements(dayElement);

  const wealthPattern=analyzeWealthPattern(pillars, dayStem);
  const love=getLoveAnalysis(dayStem, counts);
  const health=getHealthAnalysis(dayElement, counts);
  const spirit=getSpiritualAnalysis(dayStem);
  const year=new Date().getFullYear();

  return `
    <div class="butler-section">
      <h4>🔮 一、命盘总览</h4>
      <p><strong>八字：</strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${pillars.hour.stem}${pillars.hour.branch}</p>
      <p><strong>日主：</strong>${dayStem}${dayElement}（${bodyStrength}，占比${selfStrength}%）</p>
      <p><strong>五行分布：</strong>木${Math.round(percents.wood)}% 火${Math.round(percents.fire)}% 土${Math.round(percents.earth)}% 金${Math.round(percents.metal)}% 水${Math.round(percents.water)}%</p>
    </div>
    <div class="butler-section"><h4>📊 二、五行能量分析</h4>${analyzeElementsDynamic(counts, dayElement)}</div>
    <div class="butler-section"><h4>⚔️ 三、十神配置分析</h4>${analyzeTenGodsDynamic(pillars, dayStem)}</div>
    <div class="butler-section"><h4>💎 四、用神喜忌分析</h4>
      <p><strong>身强判定：</strong>${bodyStrength}</p>
      <p><strong>喜用神：</strong>${useful.join('、')}　<strong>忌神：</strong>${avoid.join('、')}</p>
      <p><strong>调候建议：</strong>${getSeasonalAdvice(pillars.month.branch)}</p>
      <p><strong>幸运颜色：</strong>${getLuckyColors(useful)}　<strong>有利方位：</strong>${getLuckyDirections(useful)}</p>
    </div>
    <div class="butler-section"><h4>🎯 五、事业发展分析</h4>
      <p><strong>天赋领域：</strong></p>
      <ul>${getSuitableCareers(dayStem).map(c=>`<li><strong>${c.field}</strong> - ${c.reason}</li>`).join('')}</ul>
      <p><strong>适合行业：</strong>${getSuitableIndustries(dayStem)}</p>
      <p><strong>职场优势：</strong>${getWorkplaceStrengths(dayStem)}</p>
      <p><strong>发展建议：</strong>${getCareerAdvice(pillars, counts)}</p>
    </div>
    <div class="butler-section"><h4>💰 六、财运走势分析</h4>
      <p><strong>财运格局：</strong>${wealthPattern.level}</p>
      <p><strong>财富特征：</strong>${wealthPattern.description}</p>
      <p><strong>求财方向：</strong>${wealthPattern.directions.join('、')}</p>
      <p><strong>理财建议：</strong>${wealthPattern.advice}</p>
      <p><strong>投资宜忌：</strong>${wealthPattern.investmentTips}</p>
    </div>
    <div class="butler-section"><h4>❤️ 七、感情婚姻分析</h4>
      <p><strong>感情模式：</strong>${love.pattern}</p>
      <p><strong>理想伴侣：</strong>${love.idealPartner}</p>
      <p><strong>相处建议：</strong>${love.advice}</p>
      <p><strong>婚恋时机：</strong>${love.timing}</p>
      <p><strong>注意事项：</strong>${love.notes}</p>
    </div>
    <div class="butler-section"><h4>🌿 八、健康养生分析</h4>
      <p><strong>体质特点：</strong>${health.constitution}</p>
      <p><strong>易患倾向：</strong>${health.vulnerabilities.join('、')}</p>
      <p><strong>养生重点：</strong>${health.healthTips}</p>
      <p><strong>饮食建议：</strong>${health.dietAdvice}</p>
      <p><strong>运动推荐：</strong>${health.exercise}</p>
    </div>
    <div class="butler-section"><h4>🔮 九、玄学缘分</h4>
      <p><strong>灵性特质：</strong>${spirit.traits}</p>
      <p><strong>玄学天赋：</strong>${spirit.talents.join('、')}</p>
      <p><strong>适合法门：</strong>${spirit.practices}</p>
      <p><strong>修行建议：</strong>${spirit.advice}</p>
    </div>
    <div class="butler-section"><h4>📅 十、近期运势建议</h4>
      <p><strong>当前流年：</strong>${getYearlyLuck(year, pillars)}</p>
      <p><strong>事业机遇：</strong>${getCareerOpportunities()}</p>
      <p><strong>财运走势：</strong>${getWealthTrend()}</p>
      <p><strong>感情发展：</strong>${getLoveTrend()}</p>
      <p><strong>健康注意：</strong>${getHealthWarning()}</p>
    </div>
    <div class="butler-section"><h4>🌟 十一、人生发展策略</h4>
      ${(()=>{const s=getLifeStrategy(pillars.day.stem, '', counts); return `<p><strong>核心策略：</strong>${s.coreStrategy}</p><p><strong>关键决策：</strong>${s.keyDecisions}</p><p><strong>成长建议：</strong>${s.growthTips}</p><ul>${s.stages.map(x=>`<li><strong>${x.period}</strong> - ${x.focus}</li>`).join('')}</ul>`})()}
    </div>
    ${timeUnknown?`<div class="butler-section"><p class="badge-warn">${t('report.hourUnknownTip')}</p></div>`:''}
  `
}

/* ========= Butler 聊天（本地模拟） ========= */
function initButlerChat(){
  const send=$('chatSend'), input=$('chatInput'), box=$('chatMessages'); if(!send||!input||!box) return;
  const post=(cls,txt)=>{ const d=document.createElement('div'); d.className=cls; d.textContent=txt; box.appendChild(d); box.scrollTop=box.scrollHeight };
  const reply=(q)=>{ post('ss-msg', t('chatDyn.autoReply', {q})) };
  function act(){ const msg=input.value.trim(); if(!msg) return; post('ss-msg me', msg); input.value=''; setTimeout(()=>reply(msg), 300) }
  send.addEventListener('click', act); input.addEventListener('keypress', e=>{ if(e.key==='Enter') act() })
}

/* ========= 入口函数 ========= */
async function generateBaziChart(){
  let birthdate=$('birthdate')?.value; const birthtime=$('birthtime')?.value; const timeUnknown=$('timeUnknown')?.checked;
  if(!birthdate){ showError(t('err.fillBirthdate')); return }
  if(birthdate.includes('/')){ const parts=birthdate.split('/'); if(parts.length===3){ const [d,m,y]=parts; birthdate=`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}` } }

  const btn=$('genBtn'), btnText=$('genBtnText'), btnLoading=$('genBtnLoading');
  lock(btn,true); if(btnText) btnText.style.display='none'; if(btnLoading) btnLoading.style.display='inline-block';

  try{
    const [year,month,day]=birthdate.split('-').map(Number);
    if(!year||!month||!day||year<1900||year>2100) throw new Error(t('err.invalidDate'));

    let hour = 12;
    if (!timeUnknown && birthtime) {
      let h = parseInt(birthtime.split(':')[0], 10);
      const isPM = /pm/i.test(birthtime) || /下午|晚/i.test(birthtime);
      const isAM = /am/i.test(birthtime) || /上午|早/i.test(birthtime);
      if (isPM && h < 12) h += 12;
      if (isAM && h === 12) h = 0;
      if (!isNaN(h)) hour = h;
    }

    const data=baziCalculator.calculateBazi(year,month,day,hour,timeUnknown); 
    const {pillars, percents, timeUnknown:tu}=data;

    const result=$('result'); if(result) result.style.display='block';

    // 日期行（多语言）
    const timeText = tu ? t('ui.timeUnknown') : t('ui.hourSuffix',{h:hour});
    const dateLine = t('ui.birthSummary', { y:year, m:month, d:day, timeText });
    setText('bazi-date', dateLine);

    // 记录到 data-*，供切换语言时重绘
    const dateEl=$('bazi-date');
    if(dateEl){
      dateEl.dataset.y=String(year);
      dateEl.dataset.m=String(month);
      dateEl.dataset.d=String(day);
      dateEl.dataset.hour=String(hour);
      dateEl.dataset.tu=String(!!tu);
    }
    if(tu && dateEl){ dateEl.innerHTML += ` <span class="badge-warn">${t('badge.noHour')}</span>` }

    renderPillars(pillars, tu); 
    displayDetailedInfo(pillars, tu);

    setBar('bar-木', percents.wood); setText('pct-木', Math.round(percents.wood)+'%');
    setBar('bar-火', percents.fire); setText('pct-火', Math.round(percents.fire)+'%');
    setBar('bar-土', percents.earth); setText('pct-土', Math.round(percents.earth)+'%');
    setBar('bar-金', percents.metal); setText('pct-金', Math.round(percents.metal)+'%');
    setBar('bar-水', percents.water); setText('pct-水', Math.round(percents.water)+'%');

    const arr=[{n:'木',v:percents.wood},{n:'火',v:percents.fire},{n:'土',v:percents.earth},{n:'金',v:percents.metal},{n:'水',v:percents.water}];
    const strongest=arr.reduce((a,b)=>a.v>b.v?a:b), weakest=arr.reduce((a,b)=>a.v<b.v?a:b);
    setText('bazi-elements-balance', t('ui.balance',{ strongest: elName(strongest.n), weakest: elName(weakest.n) }));

    const wrap=$('butlerProfessional'); 
    if(wrap){ 
      wrap.style.display='block'; 
      const target=$('professionalReport'); 
      if(target){ target.innerHTML = generateDynamicReport(data) } 
    }

    window.__baziData = data;

  }catch(err){ console.error(err); showError(err.message||t('err.generateFail')) }
  finally{ lock(btn,false); if(btnText) btnText.style.display='inline-block'; if(btnLoading) btnLoading.style.display='none' }
}

/* 语言切换时重绘动态文本 */
function rerenderDynamicTexts(){
  const data = window.__baziData;
  const dateEl = $('bazi-date');
  if(!data || !dateEl) { applyI18n(); return; }

  const y=Number(dateEl.dataset.y), m=Number(dateEl.dataset.m), d=Number(dateEl.dataset.d), h=Number(dateEl.dataset.hour);
  const tu = dateEl.dataset.tu === 'true';

  const timeText = tu ? t('ui.timeUnknown') : t('ui.hourSuffix',{h:h});
  const line = t('ui.birthSummary', {y, m, d, timeText});
  setText('bazi-date', line);
  if(tu){ dateEl.innerHTML += ` <span class="badge-warn">${t('badge.noHour')}</span>` }

  const { percents } = data;
  const arr=[{n:'木',v:percents.wood},{n:'火',v:percents.fire},{n:'土',v:percents.earth},{n:'金',v:percents.metal},{n:'水',v:percents.water}];
  const strongest=arr.reduce((a,b)=>a.v>b.v?a:b), weakest=arr.reduce((a,b)=>a.v<b.v?a:b);
  setText('bazi-elements-balance', t('ui.balance',{ strongest: elName(strongest.n), weakest: elName(weakest.n) }));

  // 同步全部静态 data-i18n
  applyI18n();
}

/* ========= 初始化 ========= */
function init(){
  applyI18n();

  const d=$('birthdate'); if(d){ const t0=new Date(); const y=t0.getFullYear(), m=String(t0.getMonth()+1).padStart(2,'0'), dd=String(t0.getDate()).padStart(2,'0'); d.value=`${y}-${m}-${dd}` }
  const tm=$('birthtime'); if(tm){ const n=new Date(); const hh=String(n.getHours()).padStart(2,'0'), mm=String(n.getMinutes()).padStart(2,'0'); tm.value=`${hh}:${mm}` }

  const gen=$('genBtn'); if(gen) gen.addEventListener('click', generateBaziChart);
  const chk=$('timeUnknown'), ti=$('birthtime'); if(chk && ti){ chk.addEventListener('change',()=>{ ti.disabled=chk.checked; if(chk.checked) ti.value='' }) }

  initButlerChat();
}
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
</script>
