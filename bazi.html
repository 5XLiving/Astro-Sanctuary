<script>
/* ========== 轻量 i18n ========== */
const LANG_KEY="site_lang";
const $=id=>document.getElementById(id);
const getLang=()=>localStorage.getItem(LANG_KEY)||document.documentElement.lang||"zh-CN";
const I18N={
  "zh-CN":{need_birth:"请完善出生日期与时间（若选农历，将自动换算为阳历）。",generating:"正在生成排盘…",neterr:"网络异常，请稍后再试。",used_solar:(d,t)=>`用于计算（UTC+8，阳历）：${d} ${t}`},
  "en":{need_birth:"Please provide both date and time. If Lunar is chosen, it will be converted to Solar first.",generating:"Generating chart…",neterr:"Network error. Try again later.",used_solar:(d,t)=>`Used for calculation (UTC+8, Solar): ${d} ${t}`}
};
const t=(k,...a)=>{const L=I18N[getLang()]||I18N["zh-CN"];const v=L[k];return typeof v==="function"?v(...a):(v||k);};

/* ========== 动态加载（多源回退） ========== */
function loadScriptOnce(src,timeoutMs=8000){
  return new Promise((resolve,reject)=>{
    if([...document.scripts].some(s=>(s.src||"").includes(src))) return resolve();
    const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous';
    const timer=setTimeout(()=>reject(new Error('timeout:'+src)),timeoutMs);
    s.onload=()=>{clearTimeout(timer);resolve();};
    s.onerror=()=>{clearTimeout(timer);reject(new Error('load failed:'+src));};
    document.head.appendChild(s);
  });
}
async function ensureLunarJS(strict=true){
  if(window.Lunar && window.Solar) return true;
  const list=[
    '/assets/vendor/lunar.min.js',
    'https://unpkg.com/lunar-javascript@1.6.15/lunar.min.js',
    'https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js',
    'https://fastly.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js'
  ];
  let ok=false; for(const u of list){ try{ await loadScriptOnce(u,7000); if(window.Lunar&&window.Solar){ ok=true; break; } }catch{} }
  if(strict && !ok) throw new Error('命理计算组件加载失败（网络/CDN/本地文件）。');
  return ok;
}
async function ensureSolarLunar(strict){
  if(window.solarlunar) return true;
  const list=[
    '/assets/vendor/solarlunar.min.js',
    'https://cdn.staticfile.org/solarlunar/2.0.6/solarlunar.min.js',
    'https://unpkg.com/solarlunar@2.0.6/solarlunar.min.js',
    'https://cdn.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js',
    'https://fastly.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js'
  ];
  let ok=false; for(const u of list){ try{ await loadScriptOnce(u,7000); if(window.solarlunar){ ok=true; break; } }catch{} }
  if(strict && !ok) throw new Error('农历换算组件加载失败（网络/CDN/本地文件）。');
  return ok;
}

/* ========== 输入 & 校验 ========== */
function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  const m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){ const[_,d,mo,y]=m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTimeTo24h(t){
  if(!t) return '00:00';
  const s=t.trim().toLowerCase().replace(/\s+/g,''); const m=s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t;
  let hh=parseInt(m[1],10), mm=parseInt(m[2]||'0',10), ap=m[3];
  if(ap==='am'){ if(hh===12) hh=0; } else if(ap==='pm'){ if(hh!==12) hh+=12; }
  return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
}
function lunarToSolarChecked(y,m,d,isLeap){
  const s=solarlunar.lunar2solar(y,m,d,!!isLeap);
  const Y=s.cYear||s.year, M=s.cMonth||s.month, D=s.cDay||s.day;
  const back=solarlunar.solar2lunar(Y,M,D);
  const pass=back.lYear===y && back.lMonth===m && back.lDay===d && (!!back.isLeap)===!!isLeap;
  if(!pass) throw new Error('农历/阳历交叉校验失败：请确认闰月与日期是否有效。');
  return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
}
function solarRoundtripOrSkip(y,m,d){
  try{
    const l=solarlunar.solar2lunar(y,m,d);
    const r=solarlunar.lunar2solar(l.lYear,l.lMonth,l.lDay,!!l.isLeap);
    const Y2=r.cYear||r.year, M2=r.cMonth||r.month, D2=r.cDay||r.day;
    return (y===Y2 && m===M2 && d===D2);
  }catch{ return true; }
}

/* ========== 五行 & 描述（简化） ========== */
const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const BRANCH_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const DM_DESC={甲:'外向生发，宜先破土后固化；重长期节奏。',乙:'柔和渗透，稳步推进。',丙:'外放明朗，重速度曝光。',丁:'内燃定向，重垂直深耕。',戊:'承载定盘，重规则壁垒。',己:'滋养落地，重整合服务。',庚:'果断执行，重标准效率。',辛:'精致审慎，重品质风控。',壬:'弹性适配，重信息与势能。',癸:'润物无声，重耐力与隐形资源。'};
function countElementsFromGZ(gzList){
  const cnt={木:0,火:0,土:0,金:0,水:0};
  gzList.forEach(gz=>{ if(!gz) return; const gan=gz[0], zhi=gz[1]; const e1=STEM_ELEM[gan], e2=BRANCH_ELEM[zhi];
    if(e1) cnt[e1]+=1; if(e2) cnt[e2]+=1; });
  const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
  return {cnt,pct:{wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100}};
}
function strengthsFromBalance(cnt,dmElem){
  const order=['木','火','土','金','水']; const sorted=order.map(k=>[k,cnt[k]]).sort((a,b)=>b[1]-a[1]);
  const top=sorted[0][0], low=sorted[4][0];
  return [`当前偏${top}，${low}偏弱；优先用好「${top}」，补上「${low}」短板。`,`以日主「${dmElem}」为锚：先顺势，再用相生帮扶；少做相克硬抗。`,`节奏：强项快进，弱项设边界与外包。`];
}

/* ========== 渲染 ========== */
const pillarsEl=$('bazi-pillars'), dmEl=$('bazi-day-master');
const bars={wood:$('bar-wood'),fire:$('bar-fire'),earth:$('bar-earth'),metal:$('bar-metal'),water:$('bar-water')};
function setBar(el,pct){ if(el) el.style.width=Math.max(0,Math.min(100,pct))+'%'; }
function renderPillars(p){
  pillarsEl.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const div=document.createElement('div'); div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${(v&&v.gz)||'--'}</div>`;
    pillarsEl.appendChild(div);
  });
}

/* ========== 主流程 ========== */
(function(){
  const calendarSel=$('calendar'), leapWrap=$('leapWrap'), calendarHint=$('calendarHint');
  const toggle=()=>{const isLunar=calendarSel.value==='lunar'; leapWrap.style.display=isLunar?'inline-flex':'none'; calendarHint.style.display=isLunar?'block':'none';};
  calendarSel.addEventListener('change',toggle); toggle();

  $('genBtn').addEventListener('click', async ()=>{
    const err=$('error'); err.style.display='none'; err.textContent='';
    const rawDate=($('birthdate').value||'').trim();
    const rawTime=($('birthtime').value||'').trim();
    const isLunar=(calendarSel.value==='lunar'); const isLeap=!!($('isLeap')&&$('isLeap').checked);
    if(!rawDate||!rawTime){ err.textContent=t('need_birth'); err.style.display='block'; return; }
    const time24=normalizeTimeTo24h(rawTime);

    try{
      /* 关键修复：无论是否农历，**先严格加载 lunar-javascript**（提供 Solar/Lunar） */
      await ensureLunarJS(true);
      /* 只有当选择农历时，才严格加载 solarlunar 做换算与交叉校验 */
      if(isLunar) await ensureSolarLunar(true); else await ensureSolarLunar(false);

      // 统一转阳历
      let solarDateStr='';
      if(isLunar){
        const [y,m,d]=normalizeDate(rawDate).split('-').map(Number);
        solarDateStr=lunarToSolarChecked(y,m,d,isLeap);
      }else{
        const dstr=normalizeDate(rawDate); const [Y,M,D]=dstr.split('-').map(Number);
        if(window.solarlunar && !solarRoundtripOrSkip(Y,M,D)) throw new Error('阳历往返校验失败：请检查日期有效性。');
        solarDateStr=dstr;
      }

      // 四柱计算（UTC+8）
      const [Y,M,D]=solarDateStr.split('-').map(Number); const [hh,mm]=time24.split(':').map(Number);
      const solar=Solar.fromYmdHms(Y,M,D,hh,mm||0,0), lunar=solar.getLunar(), ec=lunar.getEightChar();
      const gzYear=ec.getYear(), gzMonth=ec.getMonth(), gzDay=ec.getDay(), gzHour=ec.getTime();
      const dayGan=ec.getDayGan(), dmElem=STEM_ELEM[dayGan]||'', dmDesc=DM_DESC[dayGan]||'';

      const {cnt,pct}=countElementsFromGZ([gzYear,gzMonth,gzDay,gzHour]);

      $('result').style.display='block';
      $('bazi-date').textContent=t('used_solar', solarDateStr, time24);
      renderPillars({year:{gz:gzYear},month:{gz:gzMonth},day:{gz:gzDay},hour:{gz:gzHour}});
      dmEl.textContent=`日主：${dayGan}（${dmElem}） ${dmDesc}`;
      setBar(bars.wood,pct.wood); setBar(bars.fire,pct.fire); setBar(bars.earth,pct.earth); setBar(bars.metal,pct.metal); setBar(bars.water,pct.water);
      $('bazi-elements-balance').textContent=`五行占比：木${Math.round(pct.wood)} 火${Math.round(pct.fire)} 土${Math.round(pct.earth)} 金${Math.round(pct.metal)} 水${Math.round(pct.water)}`;
      const strengths=strengthsFromBalance(cnt,dmElem);
      $('bazi-strengths').textContent='亮点：'+strengths[0];
      $('bazi-advice').textContent=['核心判断：围绕日主特性与五行偏向，先顺势再补位；强项快、弱项稳。','现在要做的事：定 1 个强项目标；把 1 个弱项外包；本周排 2 次复盘。'].join('\n');
      $('fate-points').innerHTML=strengths.map(s=>`<li>${s}</li>`).join('');
    }catch(e){
      err.textContent=(e&&e.message)||t('neterr'); err.style.display='block';
      $('result').style.display='block';
    }
  });

  // 预热（静默）：先把 lunar-javascript 拉好，避免首次点按延迟
  ensureLunarJS(true).catch(()=>{});
  // solarlunar 非必需（仅农历），不强制
  ensureSolarLunar(false).catch(()=>{});
})();
</script>
