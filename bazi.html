<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* â€”â€” ç»Ÿä¸€å¤´éƒ¨ â€”â€” */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* â€”â€” å‡ºç”Ÿæ—¶é—´ï¼šæ—¶é—´è¾“å…¥ + "ä¸è¯¦"åŒä¸€è¡Œ â€”â€” */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* â€”â€” éšè—"ä¼°æ—¶é—´"æŒ‰é’®ï¼šä»…å‹¾é€‰ä¸è¯¦æ—¶å¼¹çª— â€”â€” */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* â€”â€” ä¼šå‘˜åŒºå¸ƒå±€ â€”â€” */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* â€”â€” ä¼°æ—¶é—´å¼¹çª— â€”â€” */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* â€”â€” ç®€æ˜“æŠ¥å‘Šæ ·å¼ â€”â€” */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* â€”â€” å¿ƒæ€œç®¡å®¶æ ·å¼ â€”â€” */
    .butler-section { margin-top: 20px; }
    .butler-card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 18px; margin: 16px 0; }
    .butler-title { font-size: 1.2rem; margin: 0 0 12px; font-weight: 800; color: var(--gold2); display: flex; gap: 8px; align-items: center; }
    .butler-title::before { content: ""; width: 4px; height: 18px; background: var(--brand); border-radius: 2px; }
    .butler-content { line-height: 1.7; white-space: pre-wrap; }
    .butler-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .butler-chip { padding: 6px 12px; border-radius: 999px; border: 1px solid #2a3546; background: #0e1520; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .butler-chip:hover { border-color: var(--gold2); background: rgba(212,175,55,0.1); }
    .butler-skeleton { display: grid; gap: 8px; }
    .butler-skeleton div { height: 12px; border-radius: 6px; background: linear-gradient(90deg, #1a2431, #1f2b3b, #1a2431); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { opacity: .5; } 50% { opacity: 1; } 100% { opacity: .5; } }
    .butler-lock { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--line); text-align: center; }
    .butler-lock .tip { color: #ffd88a; font-weight: 700; margin-bottom: 4px; }
    .butler-lock .sub { color: var(--muted); }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:140px}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving Â· <span data-i18n="title_bazi_brief">å…«å­—ç®€è¯„</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
      <div class="h2" data-i18n="title_quickcalc">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>

      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="label_name">å§“åï¼ˆå¯é€‰ï¼‰</label>
          <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" data-i18n-ph="ph_name" />
        </div>
        <div>
          <label class="muted" data-i18n="gender_label">æ€§åˆ«</label>
          <select id="gender">
            <option value="" data-i18n="opt_gender_confidential">ä¸é€éœ²</option>
            <option value="male" data-i18n="opt_gender_male">ç”·æ€§</option>
            <option value="female" data-i18n="opt_gender_female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="label_calendar">å†æ³•</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_cal_gregorian">é˜³å†</option>
            <option value="lunar" data-i18n="opt_cal_lunar">å†œå†</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="label_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>

        <div>
          <label class="muted" data-i18n="label_birthtime">å‡ºç”Ÿæ—¶é—´</label>
          <div class="time-row">
            <input type="time" id="birthtime" value="12:00" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="cb_time_unknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
            </label>
          </div>
        </div>

        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn_generate_chart">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
          </button>
        </div>

        <div id="error" class="error-message"></div>
      </div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
          <tbody>
            <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span data-i18n="el_wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- å¿ƒæ€œç®¡å®¶ AI è§£è¯»åŒºåŸŸ -->
      <div class="butler-section">
        <div class="butler-card">
          <div class="butler-title">ğŸ§  å¿ƒæ€œç®¡å®¶ Â· å‘½ç†è§£è¯»</div>
          <div id="butler-content" class="butler-content">
            <div class="butler-skeleton">
              <div style="width:60%"></div>
              <div style="width:80%"></div>
              <div style="width:90%"></div>
              <div style="width:70%"></div>
              <div style="width:50%"></div>
            </div>
          </div>
          <div class="butler-chips">
            <button class="butler-chip" data-question="career">ğŸ’¼ äº‹ä¸šæ–¹å‘</button>
            <button class="butler-chip" data-question="love">â¤ï¸ æ„Ÿæƒ…å©šå§»</button>
            <button class="butler-chip" data-question="wealth">ğŸ’° è´¢è¿åˆ†æ</button>
            <button class="butler-chip" data-question="health">ğŸŒ¿ å¥åº·å…»ç”Ÿ</button>
            <button class="butler-chip" data-question="personality">ğŸŒŸ æ€§æ ¼ç‰¹è´¨</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username"
                  placeholder=""
                  data-i18n-ph="ph_email"
                  required
                />
                <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
                  data-i18n-ph="ph_password"
                  required
                />
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <!-- ä¼°æ—¶é—´å¼¹çª— -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">ğŸ§­ ä¼°ä¸€ä¸ªå¤§è‡´å‡ºç”Ÿæ—¶é—´</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">é€‰æ‹©ä½ è®°å¾—çš„<strong>å¤§æ¦‚æ—¶æ®µ</strong>ï¼ˆåœ°æ”¯åŒå°æ—¶æ®µï¼‰</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          é€‰æ‹©åç‚¹"å¡«å…¥æ—¶é—´"ï¼Œä¼šç”¨è¯¥æ—¶æ®µçš„ä¸­ä½æ—¶é—´å†™åˆ°ä¸Šæ–¹æ—¶é—´è¾“å…¥æ¡†ï¼Œå¹¶è‡ªåŠ¨å–æ¶ˆ"æ—¶é—´ä¸è¯¦"ã€‚
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">å–æ¶ˆ</button>
        <button class="btn" id="twApply" type="button" disabled>å¡«å…¥æ—¶é—´</button>
      </div>
    </div>
  </div>

<script>  
// ================== å¤šè¯­è¨€ç³»ç»Ÿ ==================
const translations = {
  "zh-CN": {
    // é€šç”¨
    "lang_label": "è¯­è¨€",
    "title_bazi_brief": "å…«å­—ç®€è¯„",
    "title_quickcalc": "å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜",
    
    // è¡¨å•æ ‡ç­¾
    "label_name": "å§“åï¼ˆå¯é€‰ï¼‰",
    "ph_name": "ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰",
    "gender_label": "æ€§åˆ«",
    "label_calendar": "å†æ³•",
    "label_birthdate": "å‡ºç”Ÿæ—¥æœŸ",
    "label_birthtime": "å‡ºç”Ÿæ—¶é—´",
    "cb_time_unknown": "å‡ºç”Ÿæ—¶é—´ä¸è¯¦",
    "btn_generate_chart": "ç”Ÿæˆå…«å­—",
    
    // æ€§åˆ«é€‰é¡¹
    "opt_gender_confidential": "ä¸é€éœ²",
    "opt_gender_male": "ç”·æ€§",
    "opt_gender_female": "å¥³æ€§",
    
    // å†æ³•é€‰é¡¹
    "opt_cal_gregorian": "é˜³å†",
    "opt_cal_lunar": "å†œå†",
    
    // é”™è¯¯ä¿¡æ¯
    "err_birthdate_required": "è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ",
    "err_calculation_failed": "è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•",
    
    // äº”è¡Œæ ‡ç­¾
    "el_wood": "æœ¨",
    "el_fire": "ç«",
    "el_earth": "åœŸ",
    "el_metal": "é‡‘",
    "el_water": "æ°´",
    
    // å¿ƒæ€œç®¡å®¶
    "butler_title": "å¿ƒæ€œç®¡å®¶ Â· å‘½ç†è§£è¯»",
    "butler_loading": "æ­£åœ¨åˆ†ææ‚¨çš„å‘½ç›˜...",
    "butler_chip_career": "ğŸ’¼ äº‹ä¸šæ–¹å‘",
    "butler_chip_love": "â¤ï¸ æ„Ÿæƒ…å©šå§»",
    "butler_chip_wealth": "ğŸ’° è´¢è¿åˆ†æ",
    "butler_chip_health": "ğŸŒ¿ å¥åº·å…»ç”Ÿ",
    "butler_chip_personality": "ğŸŒŸ æ€§æ ¼ç‰¹è´¨",
    
    // åˆ†æå†…å®¹
    "analysis_strength_strong": "åå¼º",
    "analysis_strength_weak": "åå¼±",
    "analysis_strength_balanced": "å¹³è¡¡",
    "analysis_strategy_drain": "æ³„ç§€/åˆ¶åŒ–",
    "analysis_strategy_support": "è¡¥åŠ©/é¡ºåŠ¿",
    "analysis_strategy_balance": "å®ˆä¸­/è°ƒå’Œ"
  },
  "en": {
    // General
    "lang_label": "Language",
    "title_bazi_brief": "Bazi Brief Reading",
    "title_quickcalc": "Bazi Destiny Â· Quick Chart",
    
    // Form labels
    "label_name": "Name (optional)",
    "ph_name": "Your name (for personalization)",
    "gender_label": "Gender",
    "label_calendar": "Calendar",
    "label_birthdate": "Birth Date",
    "label_birthtime": "Birth Time",
    "cb_time_unknown": "Birth time unknown",
    "btn_generate_chart": "Generate Chart",
    
    // Gender options
    "opt_gender_confidential": "Confidential",
    "opt_gender_male": "Male",
    "opt_gender_female": "Female",
    
    // Calendar options
    "opt_cal_gregorian": "Gregorian",
    "opt_cal_lunar": "Lunar",
    
    // Error messages
    "err_birthdate_required": "Please enter birth date",
    "err_calculation_failed": "Error calculating Bazi, please try again",
    
    // Element labels
    "el_wood": "Wood",
    "el_fire": "Fire",
    "el_earth": "Earth",
    "el_metal": "Metal",
    "el_water": "Water",
    
    // Butler
    "butler_title": "Butler Â· Destiny Analysis",
    "butler_loading": "Analyzing your destiny chart...",
    "butler_chip_career": "ğŸ’¼ Career Direction",
    "butler_chip_love": "â¤ï¸ Love & Marriage",
    "butler_chip_wealth": "ğŸ’° Wealth Analysis",
    "butler_chip_health": "ğŸŒ¿ Health & Wellness",
    "butler_chip_personality": "ğŸŒŸ Personality Traits",
    
    // Analysis content
    "analysis_strength_strong": "Strong",
    "analysis_strength_weak": "Weak",
    "analysis_strength_balanced": "Balanced",
    "analysis_strategy_drain": "Drain/Control",
    "analysis_strategy_support": "Support/Nourish",
    "analysis_strategy_balance": "Balance/Harmony"
  },
  "ja": {
    // ä¸€èˆ¬
    "lang_label": "è¨€èª",
    "title_bazi_brief": "å…«å­—ç°¡è©•",
    "title_quickcalc": "å…«å­—å‘½ç† Â· ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒ£ãƒ¼ãƒˆ",
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒ™ãƒ«
    "label_name": "åå‰ï¼ˆä»»æ„ï¼‰",
    "ph_name": "ã‚ãªãŸã®åå‰ï¼ˆå€‹äººç”¨ï¼‰",
    "gender_label": "æ€§åˆ¥",
    "label_calendar": "æš¦æ³•",
    "label_birthdate": "ç”Ÿå¹´æœˆæ—¥",
    "label_birthtime": "å‡ºç”Ÿæ™‚é–“",
    "cb_time_unknown": "å‡ºç”Ÿæ™‚é–“ä¸æ˜",
    "btn_generate_chart": "å…«å­—ã‚’ç”Ÿæˆ",
    
    // æ€§åˆ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    "opt_gender_confidential": "éå…¬é–‹",
    "opt_gender_male": "ç”·æ€§",
    "opt_gender_female": "å¥³æ€§",
    
    // æš¦æ³•ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    "opt_cal_gregorian": "å¤ªé™½æš¦",
    "opt_cal_lunar": "æ—§æš¦",
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    "err_birthdate_required": "ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    "err_calculation_failed": "å…«å­—è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
    
    // äº”è¡Œãƒ©ãƒ™ãƒ«
    "el_wood": "æœ¨",
    "el_fire": "ç«",
    "el_earth": "åœŸ",
    "el_metal": "é‡‘",
    "el_water": "æ°´",
    
    // ãƒãƒˆãƒ©ãƒ¼
    "butler_title": "ãƒãƒˆãƒ©ãƒ¼ Â· å‘½ç†åˆ†æ",
    "butler_loading": "å‘½ç›¤ã‚’åˆ†æä¸­...",
    "butler_chip_career": "ğŸ’¼ ã‚­ãƒ£ãƒªã‚¢æ–¹å‘",
    "butler_chip_love": "â¤ï¸ æ‹æ„›çµå©š",
    "butler_chip_wealth": "ğŸ’° è²¡é‹åˆ†æ",
    "butler_chip_health": "ğŸŒ¿ å¥åº·é¤Šç”Ÿ",
    "butler_chip_personality": "ğŸŒŸ æ€§æ ¼ç‰¹è³ª",
    
    // åˆ†æå†…å®¹
    "analysis_strength_strong": "å¼·ã‚",
    "analysis_strength_weak": "å¼±ã‚",
    "analysis_strength_balanced": "ãƒãƒ©ãƒ³ã‚¹",
    "analysis_strategy_drain": "æ³„ç§€/åˆ¶åŒ–",
    "analysis_strategy_support": "è£œåŠ©/é †å‹¢",
    "analysis_strategy_balance": "å®ˆä¸­/èª¿å’Œ"
  }
};

// è¯­è¨€ç®¡ç†
const LANG_KEY = "site_lang";

function getLang() {
  return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
}

function setLang(code) {
  localStorage.setItem(LANG_KEY, code);
  document.documentElement.lang = code;
  applyTranslations();
}

function t(key) {
  const lang = getLang();
  return translations[lang]?.[key] || translations["zh-CN"][key] || key;
}

function applyTranslations() {
  // ç¿»è¯‘æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  
  // ç¿»è¯‘å ä½ç¬¦
  document.querySelectorAll("[data-i18n-ph]").forEach(el => {
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  
  // æ›´æ–°å¿ƒæ€œç®¡å®¶èŠ¯ç‰‡
  updateButlerChips();
}

function updateButlerChips() {
  const chips = {
    'career': 'butler_chip_career',
    'love': 'butler_chip_love',
    'wealth': 'butler_chip_wealth',
    'health': 'butler_chip_health',
    'personality': 'butler_chip_personality'
  };
  
  Object.entries(chips).forEach(([type, key]) => {
    const chip = document.querySelector(`[data-question="${type}"]`);
    if (chip) {
      chip.textContent = t(key);
    }
  });
  
  // æ›´æ–°ç®¡å®¶æ ‡é¢˜
  const butlerTitle = document.querySelector('.butler-title');
  if (butlerTitle) {
    butlerTitle.textContent = t('butler_title');
  }
}

// è¯­è¨€ç®¡ç†å‡½æ•°ï¼ˆä¿æŒæ‚¨æä¾›çš„ï¼‰
const LANG_KEY = "site_lang";
function getLang() { /* ... */ }
function setLang(code) { /* ... */ }
function t(key) { /* ... */ }
function applyTranslations() { /* ... */ }
function updateButlerChips() { /* ... */ }

// ================== é…ç½® & å·¥å…·å‡½æ•° ==================
const $ = id => document.getElementById(id);

function showErr(msg){ 
  const e = $("error"); 
  if(!e) return; 
  e.textContent = msg; 
  e.style.display = "block"; 
  setTimeout(() => { e.style.display = 'none' }, 5000); 
}

function hideErr(){ 
  const e = $("error"); 
  if(!e) return; 
  e.style.display = "none"; 
  e.textContent = ""; 
}

function lock(el, v){ 
  if(el) el.disabled = v; 
}

function setText(id, v){ 
  const el = $(id); 
  if(el) el.textContent = v; 
}

function setBar(el, pct){ 
  if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; 
}

// ================== å…«å­—è®¡ç®—å™¨æ ¸å¿ƒ ==================
class BaziCalculator {
  constructor(){
    this.HEAVENLY_STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC = ['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  calculateYearPillar(year){ 
    const s = (year - 4) % 10;
    const b = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(s + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(b + 12) % 12],
      zodiac: this.ZODIAC[(b + 12) % 12]
    }; 
  }

  solarMonthIndex(y, m, d){ 
    const mmdd = m * 100 + d;
    const gates = [
      [106,12], [204,1], [306,2], [405,3], [506,4], 
      [606,5], [707,6], [808,7], [908,8], [1008,9], 
      [1107,10], [1207,11]
    ];
    let idx = 11;
    for(const [thr, val] of gates) {
      if(mmdd >= thr) idx = val;
    }
    const branchBy = {
      1:'å¯…', 2:'å¯', 3:'è¾°', 4:'å·³', 5:'åˆ', 
      6:'æœª', 7:'ç”³', 8:'é…‰', 9:'æˆŒ', 10:'äº¥', 
      11:'å­', 12:'ä¸‘'
    };
    return { index: idx, branch: branchBy[idx] };
  }

  calculateMonthPillar(year, month, day){ 
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0};
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  calculateDayPillar(year, month, day){ 
    const baseUTC = Date.UTC(1900, 0, 31);
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx = (0 + dayDiff) % 10;
    const branchIdx = (4 + dayDiff) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12]
    };
  }

  calculateHourPillar(dayStem, hour){ 
    const branchMap = {
      23:'å­', 0:'å­', 1:'ä¸‘', 2:'ä¸‘', 3:'å¯…', 4:'å¯…',
      5:'å¯', 6:'å¯', 7:'è¾°', 8:'è¾°', 9:'å·³', 10:'å·³',
      11:'åˆ', 12:'åˆ', 13:'æœª', 14:'æœª', 15:'ç”³', 16:'ç”³',
      17:'é…‰', 18:'é…‰', 19:'æˆŒ', 20:'æˆŒ', 21:'äº¥', 22:'äº¥'
    };
    const startMap = {0:0, 1:2, 2:4, 3:6, 4:8, 5:0, 6:2, 7:4, 8:6, 9:8};
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getElement(stem, branch){ 
    const s = {
      'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 
      'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 
      'å£¬':'æ°´', 'ç™¸':'æ°´'
    };
    const b = {
      'å­':'æ°´', 'ä¸‘':'åœŸ', 'å¯…':'æœ¨', 'å¯':'æœ¨', 
      'è¾°':'åœŸ', 'å·³':'ç«', 'åˆ':'ç«', 'æœª':'åœŸ', 
      'ç”³':'é‡‘', 'é…‰':'é‡‘', 'æˆŒ':'åœŸ', 'äº¥':'æ°´'
    };
    return `${s[stem]}${b[branch]}`;
  }

  getNayin(stem, branch){ 
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length];
  }

  getStemElement(stem){ 
    return {
      'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 
      'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 
      'å£¬':'æ°´', 'ç™¸':'æ°´'
    }[stem];
  }

  getBranchElement(branch){ 
    return {
      'å­':'æ°´', 'ä¸‘':'åœŸ', 'å¯…':'æœ¨', 'å¯':'æœ¨', 
      'è¾°':'åœŸ', 'å·³':'ç«', 'åˆ':'ç«', 'æœª':'åœŸ', 
      'ç”³':'é‡‘', 'é…‰':'é‡‘', 'æˆŒ':'åœŸ', 'äº¥':'æ°´'
    }[branch];
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false){
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'ï¼Ÿ', branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // è®¡ç®—äº”è¡Œåˆ†å¸ƒ
    const cnt = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(p => {
      if(p.stem && p.stem !== 'ï¼Ÿ') cnt[this.getStemElement(p.stem)] += 1;
      if(p.branch && p.branch !== 'ï¼Ÿ') cnt[this.getBranchElement(p.branch)] += 1;
    });

    const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
    const pct = {
      wood: cnt['æœ¨'] / total * 100,
      fire: cnt['ç«'] / total * 100,
      earth: cnt['åœŸ'] / total * 100,
      metal: cnt['é‡‘'] / total * 100,
      water: cnt['æ°´'] / total * 100
    };

    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}

const baziCalculator = new BaziCalculator();

// ================== å®Œæ•´çš„ ButlerAI ç±» ==================
class ButlerAI {
  constructor() {
    this.currentAnalysis = null;
  }

  // åˆ†æå…«å­—æ•°æ®
  analyzeBazi(baziData) {
    const { pillars, counts, percents, timeUnknown } = baziData;
    
    // åˆ¤æ–­å‘½å±€å¼ºå¼±
    const strength = this.judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    
    // åˆ†æå–œç”¨ç¥
    const usefulElements = this.analyzeUsefulElements(strength.mark, pillars.day.element);
    
    // ç”Ÿæˆä¸ªæ€§åˆ†æ
    const personality = this.analyzePersonality(pillars.day.stem, strength.mark);
    
    // ç”Ÿæˆç»¼åˆè§£è¯»
    const comprehensive = this.generateComprehensiveAnalysis(pillars, strength, usefulElements, percents, timeUnknown);

    this.currentAnalysis = {
      pillars,
      strength,
      usefulElements,
      personality,
      comprehensive,
      percents,
      timeUnknown
    };

    return this.currentAnalysis;
  }

  judgeStrength(dayGan, monthZhi, counts) {
    const STEM_ELEM = {
      'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 
      'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 
      'å£¬':'æ°´', 'ç™¸':'æ°´'
    };
    
    const SEASON_BY_MONTH_BRANCH = {
      'å¯…':'æ˜¥', 'å¯':'æ˜¥', 'è¾°':'æ˜¥', 
      'å·³':'å¤', 'åˆ':'å¤', 'æœª':'å¤', 
      'ç”³':'ç§‹', 'é…‰':'ç§‹', 'æˆŒ':'ç§‹', 
      'äº¥':'å†¬', 'å­':'å†¬', 'ä¸‘':'å†¬'
    };

    const dmEl = STEM_ELEM[dayGan];
    const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
    
    let score = 0;
    
    // å­£èŠ‚å¾—åˆ†
    if ((season === 'æ˜¥' && 'æœ¨ç«'.includes(dmEl)) ||
        (season === 'å¤' && 'ç«åœŸ'.includes(dmEl)) ||
        (season === 'ç§‹' && dmEl === 'é‡‘') ||
        (season === 'å†¬' && dmEl === 'æ°´')) {
      score += 2;
    }
    
    // åŒç±»äº”è¡Œå¾—åˆ†
    score += (counts[dmEl] || 0) * 1.2;
    
    const mark = score >= 3 ? 'åå¼º' : (score <= 1 ? 'åå¼±' : 'å¹³è¡¡');
    const focus = mark === 'åå¼º' ? 'æ³„ç§€/åˆ¶åŒ–' : (mark === 'åå¼±' ? 'è¡¥åŠ©/é¡ºåŠ¿' : 'å®ˆä¸­/è°ƒå’Œ');
    
    return { season, mark, focus, score };
  }

  analyzeUsefulElements(strength, dmElem) {
    if (strength === 'åå¼º') {
      return {
        strategy: 'æ³„ç§€/åˆ¶åŒ–',
        useful: this.getWeakeningElements(dmElem),
        avoid: [dmElem],
        advice: 'å®œæ³„ä¸å®œè¡¥ï¼Œå¯»æ±‚å¹³è¡¡å‘å±•'
      };
    } else if (strength === 'åå¼±') {
      return {
        strategy: 'ç”Ÿæ‰¶/è¡¥åŠ©',
        useful: this.getStrengtheningElements(dmElem),
        avoid: this.getWeakeningElements(dmElem),
        advice: 'éœ€è¦ç”Ÿæ‰¶è¡¥åŠ©ï¼Œå¢å¼ºè‡ªèº«èƒ½é‡'
      };
    } else {
      return {
        strategy: 'è°ƒå’Œ',
        useful: ['æœ¨','ç«','åœŸ','é‡‘','æ°´'],
        avoid: [],
        advice: 'ä¿æŒå¹³è¡¡ï¼Œé¡ºåŠ¿è€Œä¸º'
      };
    }
  }

  getStrengtheningElements(element) {
    const map = {
      'æœ¨': ['æœ¨', 'æ°´'],
      'ç«': ['ç«', 'æœ¨'],
      'åœŸ': ['åœŸ', 'ç«'],
      'é‡‘': ['é‡‘', 'åœŸ'],
      'æ°´': ['æ°´', 'é‡‘']
    };
    return map[element] || [];
  }

  getWeakeningElements(element) {
    const map = {
      'æœ¨': ['ç«', 'åœŸ', 'é‡‘'],
      'ç«': ['åœŸ', 'é‡‘', 'æ°´'],
      'åœŸ': ['é‡‘', 'æ°´', 'æœ¨'],
      'é‡‘': ['æ°´', 'æœ¨', 'ç«'],
      'æ°´': ['æœ¨', 'ç«', 'åœŸ']
    };
    return map[element] || [];
  }

  analyzePersonality(dayStem, strength) {
    const personalityMap = {
      'ç”²': { strong: 'é¢†å¯¼åŠ›å¼ºï¼Œæ­£ç›´æœæ–­', weak: 'æ¸©å’ŒåŒ…å®¹ï¼Œæœ‰éŸ§æ€§', balanced: 'ç¨³é‡å¯é ï¼Œæœ‰æ‹…å½“' },
      'ä¹™': { strong: 'çµæ´»å˜é€šï¼Œå–„äºäº¤é™…', weak: 'æ¸©æŸ”ä½“è´´ï¼Œæœ‰è‰ºæœ¯æ°”è´¨', balanced: 'ç»†è…»å‘¨åˆ°ï¼Œå–„è§£äººæ„' },
      'ä¸™': { strong: 'çƒ­æƒ…å¼€æœ—ï¼Œå……æ»¡æ´»åŠ›', weak: 'æ¸©å’Œå–„è‰¯ï¼Œé‡æƒ…é‡ä¹‰', balanced: 'ä¹è§‚ç§¯æï¼Œæ„ŸæŸ“åŠ›å¼º' },
      'ä¸': { strong: 'ç»†è‡´è®¤çœŸï¼Œè¿½æ±‚å®Œç¾', weak: 'æ¸©å’Œä½“è´´ï¼Œå–„è§£äººæ„', balanced: 'èªæ…§æ•é”ï¼Œæœ‰åˆ›é€ åŠ›' },
      'æˆŠ': { strong: 'ç¨³é‡å¯é ï¼Œè´£ä»»å¿ƒå¼º', weak: 'æ¸©å’ŒåŒ…å®¹ï¼Œæœ‰è€å¿ƒ', balanced: 'è¸å®åŠ¡å®ï¼Œå€¼å¾—ä¿¡èµ–' },
      'å·±': { strong: 'ç»†è‡´å‘¨åˆ°ï¼Œå–„äºè§„åˆ’', weak: 'æ¸©å’Œè°¦é€Šï¼Œæœ‰åŒ…å®¹å¿ƒ', balanced: 'åŠ¡å®ç¨³é‡ï¼Œæ³¨é‡å®é™…' },
      'åºš': { strong: 'æœæ–­åšå†³ï¼Œæœ‰é­„åŠ›', weak: 'æ¸©å’Œæ­£ç›´ï¼Œé‡åŸåˆ™', balanced: 'åˆšæ¯…æœæ–­ï¼Œæœ‰æ­£ä¹‰æ„Ÿ' },
      'è¾›': { strong: 'ç²¾æ˜å¹²ç»ƒï¼Œè¿½æ±‚å®Œç¾', weak: 'æ¸©å’Œç»†è…»ï¼Œæœ‰å“å‘³', balanced: 'èªæ…§æ•é”ï¼Œå–„äºåˆ†æ' },
      'å£¬': { strong: 'èƒ¸æ€€å®½å¹¿ï¼Œæœ‰è¿œè§', weak: 'æ¸©å’ŒåŒ…å®¹ï¼Œå–„è§£äººæ„', balanced: 'æ™ºæ…§é€šè¾¾ï¼Œé€‚åº”åŠ›å¼º' },
      'ç™¸': { strong: 'èªæ…§æ•é”ï¼Œæ´å¯ŸåŠ›å¼º', weak: 'æ¸©å’Œç»†è…»ï¼Œæœ‰åŒæƒ…å¿ƒ', balanced: 'æ™ºæ…§å†…æ•›ï¼Œå–„äºæ€è€ƒ' }
    };

    return personalityMap[dayStem]?.[strength === 'åå¼º' ? 'strong' : (strength === 'åå¼±' ? 'weak' : 'balanced')] || 'å…·æœ‰ç‹¬ç‰¹çš„ä¸ªæ€§ç‰¹è´¨';
  }

  // è¿™é‡Œç»§ç»­æ·»åŠ æ‚¨ä¹‹å‰æä¾›çš„å¤šè¯­è¨€ç›¸å…³æ–¹æ³•...
  // getAnalysisInCurrentLanguage(), localizeAnalysis(), tStrength(), tStrategy(), tAdvice()
  // generateComprehensiveAnalysis(), answerQuestion(), getCareerAdvice(), getLoveAdvice() ç­‰
  
  // ... [ä¿æŒæ‚¨æä¾›çš„æ‰€æœ‰å¤šè¯­è¨€æ–¹æ³•]
}

const butlerAI = new ButlerAI();

// ================== ç•Œé¢æ¸²æŸ“å‡½æ•° ==================
function renderPillars(root, p, timeUnknown = false) {
  if (!root) return;
  root.innerHTML = '';
  
  [['å¹´æŸ±', p.year], ['æœˆæŸ±', p.month], ['æ—¥æŸ±', p.day], ['æ—¶æŸ±', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === 'æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;
    
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `;
    root.appendChild(div);
  });
}

function displayClassicArea(p, timeUnknown) {
  const getElement = (s, b) => baziCalculator.getElement(s, b);
  const getNayin = (s, b) => baziCalculator.getNayin(s, b);
  
  // å¤©å¹²
  setText('year-stem', p.year.stem);
  setText('month-stem', p.month.stem);
  setText('day-stem', p.day.stem);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : p.hour.stem);
  
  // åœ°æ”¯
  setText('year-branch', p.year.branch);
  setText('month-branch', p.month.branch);
  setText('day-branch', p.day.branch);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : p.hour.branch);
  
  // äº”è¡Œ
  setText('year-element', getElement(p.year.stem, p.year.branch));
  setText('month-element', getElement(p.month.stem, p.month.branch));
  setText('day-element', getElement(p.day.stem, p.day.branch));
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : getElement(p.hour.stem, p.hour.branch));
  
  // çº³éŸ³
  setText('year-nayin', getNayin(p.year.stem, p.year.branch));
  setText('month-nayin', getNayin(p.month.stem, p.month.branch));
  setText('day-nayin', getNayin(p.day.stem, p.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : getNayin(p.hour.stem, p.hour.branch));
}

// ================== ä¸»é€»è¾‘å‡½æ•° ==================
async function genChart() {
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  
  if (!birth) {
    showErr(t('err_birthdate_required'));
    return;
  }

  const btn = $('genBtn');
  const tx = $('genBtnText');
  const ld = $('genBtnLoading');
  
  if (btn) btn.disabled = true;
  if (tx) tx.style.display = 'none';
  if (ld) ld.style.display = 'inline-block';

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12;
    
    if (!timeUnknown) {
      const t = ($('birthtime')?.value || '').trim();
      if (t) {
        const h = parseInt(t.split(':')[0], 10);
        if (!Number.isNaN(h)) hour = h;
      }
    }

    // è®¡ç®—å…«å­—
    const baziData = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    const { pillars, counts, percents, timeUnknown: tu } = baziData;

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result')?.style.setProperty('display', 'block');
    
    // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? t('cb_time_unknown') : (hour + 'æ—¶');
    setText('bazi-date', `${t('label_birthdate')}: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if (tu) {
      const el = $('bazi-date');
      if (el) el.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å››æŸ±
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    // æ›´æ–°äº”è¡Œæ¡
    setBar($('bar-æœ¨'), percents.wood);
    setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar($('bar-ç«'), percents.fire);
    setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar($('bar-åœŸ'), percents.earth);
    setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar($('bar-é‡‘'), percents.metal);
    setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar($('bar-æ°´'), percents.water);
    setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡æç¤º
    const elements = [
      { name: t('el_wood'), value: percents.wood },
      { name: t('el_fire'), value: percents.fire },
      { name: t('el_earth'), value: percents.earth },
      { name: t('el_metal'), value: percents.metal },
      { name: t('el_water'), value: percents.water }
    ];
    
    const strongest = elements.reduce((a, b) => a.value > b.value ? a : b);
    const weakest = elements.reduce((a, b) => a.value < b.value ? a : b);
    
    setText('bazi-elements-balance', 
      `äº”è¡Œä¸­${strongest.name}å…ƒç´ æœ€å¼ºï¼Œ${weakest.name}å…ƒç´ æœ€å¼±ã€‚`
    );

    // å¿ƒæ€œç®¡å®¶åˆ†æ
    showButlerLoading();
    
    // æ¨¡æ‹Ÿåˆ†ææ—¶é—´
    setTimeout(() => {
      const analysis = butlerAI.analyzeBazi(baziData);
      updateButlerDisplay(butlerAI.getAnalysisInCurrentLanguage(), 'comprehensive');
    }, 1000);

  } catch (err) {
    console.error(err);
    showErr(t('err_calculation_failed'));
  } finally {
    if (btn) btn.disabled = false;
    if (tx) tx.style.display = 'inline';
    if (ld) ld.style.display = 'none';
  }
}

// ================== äº‹ä»¶ç›‘å¬ ==================
document.addEventListener('DOMContentLoaded', () => {
  // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
  initLanguageSystem();
  
  // ç”ŸæˆæŒ‰é’®äº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', genChart);
  }

  // å¿ƒæ€œç®¡å®¶èŠ¯ç‰‡ç‚¹å‡»äº‹ä»¶
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('butler-chip')) {
      const questionType = e.target.getAttribute('data-question');
      if (butlerAI.currentAnalysis) {
        updateButlerDisplay(butlerAI.getAnalysisInCurrentLanguage(), questionType);
      } else {
        showErr('è¯·å…ˆç”Ÿæˆå…«å­—å‘½ç›˜');
      }
    }
  });

  // å‡ºç”Ÿæ—¶é—´ä¸è¯¦å¤é€‰æ¡†äº‹ä»¶
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }

  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const birthdate = $('birthdate');
  if (birthdate && !birthdate.value) {
    birthdate.value = new Date().toISOString().split('T')[0];
  }

  // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
  ['birthdate', 'birthtime'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          genChart();
        }
      });
    }
  });
});
  
// ================== æ›´æ–° ButlerAI ç±»æ”¯æŒå¤šè¯­è¨€ ==================
class ButlerAI {
  constructor() {
    this.currentAnalysis = null;
  }

  // è·å–å½“å‰è¯­è¨€çš„åˆ†æå†…å®¹
  getAnalysisInCurrentLanguage() {
    if (!this.currentAnalysis) return null;
    
    const lang = getLang();
    return this.localizeAnalysis(this.currentAnalysis, lang);
  }

  localizeAnalysis(analysis, lang) {
    const localized = { ...analysis };
    
    // æœ¬åœ°åŒ–å¼ºåº¦æè¿°
    localized.strength.mark = this.tStrength(localized.strength.mark);
    localized.strength.focus = this.tStrategy(localized.strength.focus);
    
    // æœ¬åœ°åŒ–å»ºè®®
    localized.usefulElements.strategy = this.tStrategy(localized.usefulElements.strategy);
    localized.usefulElements.advice = this.tAdvice(localized.usefulElements.advice, lang);
    
    // é‡æ–°ç”Ÿæˆç»¼åˆè§£è¯»
    localized.comprehensive = this.generateComprehensiveAnalysis(
      localized.pillars, 
      localized.strength, 
      localized.usefulElements, 
      localized.percents, 
      localized.timeUnknown,
      lang
    );
    
    return localized;
  }

  tStrength(strength) {
    const map = {
      'åå¼º': t('analysis_strength_strong'),
      'åå¼±': t('analysis_strength_weak'),
      'å¹³è¡¡': t('analysis_strength_balanced')
    };
    return map[strength] || strength;
  }

  tStrategy(strategy) {
    const map = {
      'æ³„ç§€/åˆ¶åŒ–': t('analysis_strategy_drain'),
      'è¡¥åŠ©/é¡ºåŠ¿': t('analysis_strategy_support'),
      'å®ˆä¸­/è°ƒå’Œ': t('analysis_strategy_balance')
    };
    return map[strategy] || strategy;
  }

  tAdvice(advice, lang) {
    const adviceMap = {
      'zh-CN': {
        'å®œæ³„ä¸å®œè¡¥ï¼Œå¯»æ±‚å¹³è¡¡å‘å±•': 'å®œæ³„ä¸å®œè¡¥ï¼Œå¯»æ±‚å¹³è¡¡å‘å±•',
        'éœ€è¦ç”Ÿæ‰¶è¡¥åŠ©ï¼Œå¢å¼ºè‡ªèº«èƒ½é‡': 'éœ€è¦ç”Ÿæ‰¶è¡¥åŠ©ï¼Œå¢å¼ºè‡ªèº«èƒ½é‡',
        'ä¿æŒå¹³è¡¡ï¼Œé¡ºåŠ¿è€Œä¸º': 'ä¿æŒå¹³è¡¡ï¼Œé¡ºåŠ¿è€Œä¸º'
      },
      'en': {
        'å®œæ³„ä¸å®œè¡¥ï¼Œå¯»æ±‚å¹³è¡¡å‘å±•': 'Better to drain than to supplement, seek balanced development',
        'éœ€è¦ç”Ÿæ‰¶è¡¥åŠ©ï¼Œå¢å¼ºè‡ªèº«èƒ½é‡': 'Need support and nourishment to enhance personal energy',
        'ä¿æŒå¹³è¡¡ï¼Œé¡ºåŠ¿è€Œä¸º': 'Maintain balance, go with the flow'
      },
      'ja': {
        'å®œæ³„ä¸å®œè¡¥ï¼Œå¯»æ±‚å¹³è¡¡å‘å±•': 'è£œã†ã‚ˆã‚Šæ³„ã‚‰ã™æ–¹ãŒè‰¯ãã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç™ºå±•ã‚’æ±‚ã‚ã‚‹',
        'éœ€è¦ç”Ÿæ‰¶è¡¥åŠ©ï¼Œå¢å¼ºè‡ªèº«èƒ½é‡': 'ã‚µãƒãƒ¼ãƒˆã¨æ „é¤ŠãŒå¿…è¦ã§ã€è‡ªèº«ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’é«˜ã‚ã‚‹',
        'ä¿æŒå¹³è¡¡ï¼Œé¡ºåŠ¿è€Œä¸º': 'ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¡ã€æµã‚Œã«èº«ã‚’ä»»ã›ã‚‹'
      }
    };
    
    return adviceMap[lang]?.[advice] || advice;
  }

  // æ›´æ–°ç”Ÿæˆç»¼åˆè§£è¯»æ–¹æ³•ï¼Œæ”¯æŒå¤šè¯­è¨€
  generateComprehensiveAnalysis(pillars, strength, usefulElements, percents, timeUnknown, lang = 'zh-CN') {
    const dayMaster = pillars.day.stem;
    const dayElement = pillars.day.element;
    
    let analysis = '';
    
    if (lang === 'zh-CN') {
      analysis = `æ‚¨çš„å…«å­—æ—¥ä¸»ä¸º${dayMaster}${dayElement}ï¼Œå‘½å±€${strength.mark}ã€‚\n\n`;
      analysis += `ğŸ“Š äº”è¡Œåˆ†å¸ƒï¼š\n`;
      analysis += `æœ¨ ${Math.round(percents.wood)}% | ç« ${Math.round(percents.fire)}% | åœŸ ${Math.round(percents.earth)}% | é‡‘ ${Math.round(percents.metal)}% | æ°´ ${Math.round(percents.water)}%\n\n`;
      analysis += `ğŸ¯ å‘å±•ç­–ç•¥ï¼š\n`;
      analysis += `å®œé‡‡ç”¨"${strength.focus}"çš„ç­–ç•¥ï¼Œ${usefulElements.advice}\n\n`;
      analysis += `ğŸ’ å–œç”¨å…ƒç´ ï¼š\n`;
      analysis += `å¢å¼ºï¼š${usefulElements.useful.join('ã€')}\n`;
      if (usefulElements.avoid.length > 0) {
        analysis += `æ³¨æ„ï¼š${usefulElements.avoid.join('ã€')}\n`;
      }
    } else if (lang === 'en') {
      analysis = `Your Bazi Day Master is ${dayMaster}${dayElement}, chart is ${strength.mark}.\n\n`;
      analysis += `ğŸ“Š Five Elements:\n`;
      analysis += `Wood ${Math.round(percents.wood)}% | Fire ${Math.round(percents.fire)}% | Earth ${Math.round(percents.earth)}% | Metal ${Math.round(percents.metal)}% | Water ${Math.round(percents.water)}%\n\n`;
      analysis += `ğŸ¯ Development Strategy:\n`;
      analysis += `Use "${strength.focus}" strategy, ${usefulElements.advice}\n\n`;
      analysis += `ğŸ’ Favorable Elements:\n`;
      analysis += `Enhance: ${usefulElements.useful.join(', ')}\n`;
      if (usefulElements.avoid.length > 0) {
        analysis += `Avoid: ${usefulElements.avoid.join(', ')}\n`;
      }
    } else if (lang === 'ja') {
      analysis = `ã‚ãªãŸã®å…«å­—æ—¥ä¸»ã¯${dayMaster}${dayElement}ã€å‘½å±€ã¯${strength.mark}ã§ã™ã€‚\n\n`;
      analysis += `ğŸ“Š äº”è¡Œåˆ†å¸ƒï¼š\n`;
      analysis += `æœ¨ ${Math.round(percents.wood)}% | ç« ${Math.round(percents.fire)}% | åœŸ ${Math.round(percents.earth)}% | é‡‘ ${Math.round(percents.metal)}% | æ°´ ${Math.round(percents.water)}%\n\n`;
      analysis += `ğŸ¯ ç™ºå±•æˆ¦ç•¥ï¼š\n`;
      analysis += `"${strength.focus}"ã®æˆ¦ç•¥ã‚’æ¡ç”¨ã—ã€${usefulElements.advice}\n\n`;
      analysis += `ğŸ’ æœ‰åˆ©ãªè¦ç´ ï¼š\n`;
      analysis += `å¼·åŒ–ï¼š${usefulElements.useful.join('ã€')}\n`;
      if (usefulElements.avoid.length > 0) {
        analysis += `æ³¨æ„ï¼š${usefulElements.avoid.join('ã€')}\n`;
      }
    }
    
    if (timeUnknown) {
      const timeWarning = {
        'zh-CN': `\nâš ï¸ æç¤ºï¼šç”±äºå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥åˆ†æï¼Œå»ºè®®ä»…ä¾›å‚è€ƒã€‚`,
        'en': `\nâš ï¸ Note: Birth time unknown, hour pillar excluded from analysis. Use as reference only.`,
        'ja': `\nâš ï¸ æ³¨æ„ï¼šå‡ºç”Ÿæ™‚é–“ä¸æ˜ã®ãŸã‚ã€æ™‚æŸ±ã¯åˆ†æã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‚è€ƒã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚`
      };
      analysis += timeWarning[lang] || timeWarning['zh-CN'];
    }
    
    return analysis;
  }

  // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ï¼Œä½†ä¼šåœ¨å›ç­”é—®é¢˜æ—¶ä½¿ç”¨æœ¬åœ°åŒ–åˆ†æ
  answerQuestion(questionType) {
    if (!this.currentAnalysis) return t('butler_loading');
    
    const localizedAnalysis = this.getAnalysisInCurrentLanguage();
    const lang = getLang();
    
    const questionAnswers = {
      career: this.getCareerAdvice(localizedAnalysis, lang),
      love: this.getLoveAdvice(localizedAnalysis, lang),
      wealth: this.getWealthAdvice(localizedAnalysis, lang),
      health: this.getHealthAdvice(localizedAnalysis, lang),
      personality: this.getPersonalityDetail(localizedAnalysis, lang)
    };
    
    return questionAnswers[questionType] || "I'm still learning about this...";
  }

  // æ›´æ–°å»ºè®®æ–¹æ³•ä»¥æ”¯æŒå¤šè¯­è¨€
  getCareerAdvice(analysis, lang) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å¤šè¯­è¨€çš„èŒä¸šå»ºè®®
    // ä¸ºäº†ç®€æ´ï¼Œæˆ‘å…ˆè¿”å›ä¸­æ–‡ç‰ˆæœ¬
    return this.getCareerAdvice_zh(analysis);
  }

  getCareerAdvice_zh(analysis) {
    const { pillars, strength, usefulElements, percents } = analysis;
    
    const elementCareers = {
      'æœ¨': ['æ•™è‚²æ–‡åŒ–', 'åˆ›æ„è®¾è®¡', 'åŒ»ç–—å¥åº·', 'ç¯ä¿å†œä¸š', 'å‡ºç‰ˆä¼ åª’'],
      'ç«': ['æ¼”è‰ºå¨±ä¹', 'é¤é¥®æ—…æ¸¸', 'èƒ½æºç”µåŠ›', 'å¸‚åœºè¥é”€', 'å¿ƒç†å’¨è¯¢'],
      'åœŸ': ['æˆ¿åœ°äº§', 'å»ºç­‘å·¥ç¨‹', 'é‡‘èæŠ•èµ„', 'è¡Œæ”¿ç®¡ç†', 'çŸ¿äº§èµ„æº'],
      'é‡‘': ['ç§‘æŠ€IT', 'æœºæ¢°åˆ¶é€ ', 'æ³•å¾‹å¸æ³•', 'é‡‘èé“¶è¡Œ', 'ç²¾å¯†ä»ªå™¨'],
      'æ°´': ['ç‰©æµè¿è¾“', 'è´¸æ˜“å•†åŠ¡', 'æ—…æ¸¸æœåŠ¡', 'å’¨è¯¢é¡¾é—®', 'æ–‡åŒ–è‰ºæœ¯']
    };
    
    let advice = `ğŸ’¼ äº‹ä¸šæ–¹å‘å»ºè®®ï¼š\n\n`;
    
    usefulElements.useful.forEach(element => {
      const careers = elementCareers[element] || [];
      if (careers.length > 0) {
        advice += `åŸºäº${element}å…ƒç´ ï¼Œé€‚åˆï¼š${careers.slice(0, 3).join('ã€')}\n`;
      }
    });
    
    advice += `\n${strength.mark === 'åå¼º' ? 
      'æ‚¨å‘½å±€åå¼ºï¼Œé€‚åˆæŒ‘æˆ˜æ€§å·¥ä½œï¼Œå¯ä»¥æ‰¿æ‹…æ›´å¤šè´£ä»»ã€‚' : 
      strength.mark === 'åå¼±' ? 
      'æ‚¨å‘½å±€åå¼±ï¼Œé€‚åˆç¨³å®šæ€§å·¥ä½œï¼Œå›¢é˜Ÿåˆä½œæ›´èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚' : 
      'æ‚¨å‘½å±€å¹³è¡¡ï¼Œé€‚åº”æ€§å¼ºï¼Œå¤šç§é¢†åŸŸéƒ½æœ‰å‘å±•æ½œåŠ›ã€‚'
    }\n\n`;
    
    advice += `ğŸŒŸ å‘å±•å»ºè®®ï¼š\n`;
    advice += `â€¢ å¤šæ¥è§¦${usefulElements.useful.join('ã€')}ç›¸å…³çš„ç¯å¢ƒå’Œäººç¾¤\n`;
    advice += `â€¢ ${strength.focus}çš„ç­–ç•¥æ›´é€‚åˆæ‚¨çš„èŒä¸šå‘å±•\n`;
    advice += `â€¢ å…³æ³¨äº”è¡Œå¹³è¡¡ï¼Œé¿å…æç«¯é€‰æ‹©`;
    
    return advice;
  }

  // å…¶ä»–å»ºè®®æ–¹æ³•ç±»ä¼¼...
  getLoveAdvice(analysis, lang) {
    return this.getLoveAdvice_zh(analysis);
  }

  getLoveAdvice_zh(analysis) {
    const { pillars, strength, usefulElements } = analysis;
    
    let advice = `â¤ï¸ æ„Ÿæƒ…å©šå§»å»ºè®®ï¼š\n\n`;
    advice += `æ‚¨çš„æ—¥ä¸»${pillars.day.stem}${pillars.day.element}ï¼Œåœ¨æ„Ÿæƒ…ä¸­ï¼š\n`;
    advice += `${this.analyzePersonality(pillars.day.stem, strength.mark)}\n\n`;
    
    advice += `ğŸ’ ç›¸å¤„å»ºè®®ï¼š\n`;
    advice += `â€¢ ${strength.mark === 'åå¼º' ? 'å­¦ä¼šå€¾å¬å’ŒåŒ…å®¹' : 'å¢å¼ºè‡ªä¿¡ï¼Œè¡¨è¾¾çœŸå®æ„Ÿå—'}\n`;
    advice += `â€¢ å¤šå‚ä¸${usefulElements.useful.join('ã€')}ç›¸å…³çš„ç¤¾äº¤æ´»åŠ¨\n`;
    advice += `â€¢ æ³¨é‡æ²Ÿé€šï¼Œç†è§£å½¼æ­¤çš„äº”è¡Œç‰¹è´¨`;
    
    return advice;
  }

  // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜...
  // ... [ä¿æŒåŸæœ‰çš„ analyzeBazi, judgeStrength, analyzeUsefulElements ç­‰æ–¹æ³•]
}

// ================== æ›´æ–°ç•Œé¢æ¸²æŸ“å‡½æ•° ==================
function updateButlerDisplay(analysis, questionType = 'comprehensive') {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  let content = '';
  
  if (questionType === 'comprehensive') {
    content = analysis.comprehensive;
  } else {
    content = butlerAI.answerQuestion(questionType);
  }
  
  butlerContent.innerHTML = `
    <div style="white-space: pre-wrap; line-height: 1.6;">${content}</div>
  `;
}

function showButlerLoading() {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  butlerContent.innerHTML = `
    <div style="text-align: center; padding: 20px; color: var(--muted);">
      ${t('butler_loading')}
    </div>
  `;
}

// ================== æ›´æ–°é”™è¯¯æ¶ˆæ¯å‡½æ•° ==================
function showErr(msgKey) {
  const e = $("error");
  if (!e) return;
  e.textContent = t(msgKey);
  e.style.display = "block";
  setTimeout(() => { e.style.display = 'none' }, 5000);
}

// ================== åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ ==================
function initLanguageSystem() {
  const langSelect = $('langSelect');
  if (langSelect) {
    langSelect.value = getLang();
    langSelect.addEventListener('change', (e) => {
      setLang(e.target.value);
    });
  }
  
  applyTranslations();
}

// ================== æ›´æ–°ä¸»äº‹ä»¶ç›‘å¬ ==================
document.addEventListener('DOMContentLoaded', () => {
  // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
  initLanguageSystem();
  
  // ç”ŸæˆæŒ‰é’®äº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', genChart);
  }

  // å¿ƒæ€œç®¡å®¶èŠ¯ç‰‡ç‚¹å‡»äº‹ä»¶
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('butler-chip')) {
      const questionType = e.target.getAttribute('data-question');
      if (butlerAI.currentAnalysis) {
        updateButlerDisplay(butlerAI.getAnalysisInCurrentLanguage(), questionType);
      } else {
        showErr('è¯·å…ˆç”Ÿæˆå…«å­—å‘½ç›˜');
      }
    }
  });

  // å…¶ä»–äº‹ä»¶ç›‘å¬ä¿æŒä¸å˜...
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }

  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const birthdate = $('birthdate');
  if (birthdate && !birthdate.value) {
    birthdate.value = new Date().toISOString().split('T')[0];
  }

  // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
  ['birthdate', 'birthtime'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          genChart();
        }
      });
    }
  });
});

// æ›´æ–° genChart å‡½æ•°ä¸­çš„é”™è¯¯æç¤º
async function genChart() {
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  
  if (!birth) {
    showErr('err_birthdate_required');
    return;
  }

  // ... å…¶ä½™ genChart å‡½æ•°ä»£ç ä¿æŒä¸å˜
  // åªéœ€è¦å°† showErr('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•') æ”¹ä¸ºï¼š
  // showErr('err_calculation_failed');
}

console.log('å¤šè¯­è¨€å¿ƒæ€œç®¡å®¶ç³»ç»Ÿå·²åŠ è½½å®Œæˆï¼');
console.log('æ”¯æŒè¯­è¨€ï¼šç®€ä½“ä¸­æ–‡ã€Englishã€æ—¥æœ¬èª');
</script>
</body>
</html>
