<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* å¤´éƒ¨æ ·å¼ */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* å…«å­—æŸ±æ ·å¼ */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* äº”è¡Œèƒ½é‡æ¡ */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* æ—¶é—´è¾“å…¥è¡Œ */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* ç”ŸæˆæŒ‰é’®åŒ…è£… */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* ä¼šå‘˜åŒºåŸŸ */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* ç®€æ˜“æŠ¥å‘Šæ ·å¼ */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
    
    /* AIç®¡å®¶æ ·å¼ */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* èŠå¤©æµ®çª— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
    }
    
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç®€è¯„</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- å…«å­—æ’ç›˜è¡¨å• -->
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar">
          <option value="gregorian">é˜³å†</option>
          <option value="lunar">å†œå†</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:00" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- AIç®¡å®¶åŒºåŸŸ -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">å¿ƒæ€œç®¡å®¶ Â· è§£è¯»</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>
    </div>
  </section>

  <!-- ä¼šå‘˜åŒºåŸŸ -->
  <section class="card section">
    <h2 class="group-title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li>äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li>è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li>å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li>å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
          <li>å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li>æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- èŠå¤©æµ®çª— -->
<button class="ss-chat-fab" id="ssChatFab">é—®</button>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <div class="ss-chat-title">5X Â· æ™ºèƒ½åŠ©æ‰‹</div>
    <div class="ss-close" id="ssChatClose">âœ•</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" placeholder="è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ" />
    <button class="btn" id="ssChatSend">å‘é€</button>
  </div>
</div>

<script>
// æ ¸å¿ƒå…«å­—è®¡ç®—ç±»
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  calculateYearPillar(year) {
    const s = (year - 4) % 10;
    const b = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(s + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(b + 12) % 12]
    };
  }

  calculateMonthPillar(year, month, day) {
    const monthBranchMap = {
      1: 'å¯…', 2: 'å¯', 3: 'è¾°', 4: 'å·³', 5: 'åˆ', 
      6: 'æœª', 7: 'ç”³', 8: 'é…‰', 9: 'æˆŒ', 10: 'äº¥', 
      11: 'å­', 12: 'ä¸‘'
    };
    
    const branch = monthBranchMap[month] || 'å¯…';
    const yearStem = this.calculateYearPillar(year).stem;
    const yearStemIdx = this.HEAVENLY_STEMS.indexOf(yearStem);
    
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const monthNum = Object.keys(monthBranchMap).findIndex(k => parseInt(k) === month) + 1;
    const stemIdx = (startMap[yearStemIdx] + (monthNum - 1)) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  calculateDayPillar(year, month, day) {
    const baseDate = new Date(1900, 0, 31);
    const targetDate = new Date(year, month - 1, day);
    const dayDiff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
    
    const stemIdx = (0 + dayDiff) % 10;
    const branchIdx = (4 + dayDiff) % 12;
    
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12]
    };
  }

  calculateHourPillar(dayStem, hour) {
    const branchMap = {
      23: 'å­', 0: 'å­', 1: 'ä¸‘', 2: 'ä¸‘', 3: 'å¯…', 4: 'å¯…',
      5: 'å¯', 6: 'å¯', 7: 'è¾°', 8: 'è¾°', 9: 'å·³', 10: 'å·³',
      11: 'åˆ', 12: 'åˆ', 13: 'æœª', 14: 'æœª', 15: 'ç”³', 16: 'ç”³',
      17: 'é…‰', 18: 'é…‰', 19: 'æˆŒ', 20: 'æˆŒ', 21: 'äº¥', 22: 'äº¥'
    };
    
    const startMap = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getStemElement(stem) {
    const elementMap = {
      'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ',
      'åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'
    };
    return elementMap[stem] || '';
  }

  getBranchElement(branch) {
    const elementMap = {
      'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«',
      'åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'
    };
    return elementMap[branch] || '';
  }

  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length] || '';
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'ï¼Ÿ',branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // è®¡ç®—äº”è¡Œèƒ½é‡
    const elements = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(pillar => {
      if (pillar.stem && pillar.stem !== 'ï¼Ÿ') {
        const stemElement = this.getStemElement(pillar.stem);
        if (stemElement) elements[stemElement]++;
      }
      if (pillar.branch && pillar.branch !== 'ï¼Ÿ') {
        const branchElement = this.getBranchElement(pillar.branch);
        if (branchElement) elements[branchElement]++;
      }
    });

    const total = Object.values(elements).reduce((sum, count) => sum + count, 0) || 1;
    const percents = {
      wood: (elements['æœ¨'] / total) * 100,
      fire: (elements['ç«'] / total) * 100,
      earth: (elements['åœŸ'] / total) * 100,
      metal: (elements['é‡‘'] / total) * 100,
      water: (elements['æ°´'] / total) * 100
    };

    return { pillars, elements, percents, timeUnknown };
  }
}

// å·¥å…·å‡½æ•°
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: 'å¹´æŸ±', pillar: pillars.year },
    { title: 'æœˆæŸ±', pillar: pillars.month },
    { title: 'æ—¥æŸ±', pillar: pillars.day },
    { title: 'æ—¶æŸ±', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === 'æ—¶æŸ±' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? 'ï¼Ÿ' : pillar.stem}${isUnknown ? 'ï¼Ÿ' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯è¡¨æ ¼
function displayDetailedInfo(pillars, timeUnknown = false) {
  const calculator = new BaziCalculator();
  
  // å¤©å¹²åœ°æ”¯
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : pillars.hour.branch);

  // äº”è¡Œ
  setText('year-element', `${calculator.getStemElement(pillars.year.stem)}${calculator.getBranchElement(pillars.year.branch)}`);
  setText('month-element', `${calculator.getStemElement(pillars.month.stem)}${calculator.getBranchElement(pillars.month.branch)}`);
  setText('day-element', `${calculator.getStemElement(pillars.day.stem)}${calculator.getBranchElement(pillars.day.branch)}`);
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : `${calculator.getStemElement(pillars.hour.stem)}${calculator.getBranchElement(pillars.hour.branch)}`);

  // çº³éŸ³
  setText('year-nayin', calculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', calculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', calculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : calculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// ç”Ÿæˆå…«å­—å‘½ç›˜
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const calculator = new BaziCalculator();
    const { pillars, elements, percents, timeUnknown: tu } = calculator.calculateBazi(year, month, day, hour, timeUnknown);

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';

    // è®¾ç½®æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å…«å­—æŸ±å’Œè¯¦ç»†ä¿¡æ¯
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // æ›´æ–°äº”è¡Œèƒ½é‡æ¡
    setBar('bar-æœ¨', percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar('bar-ç«', percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar('bar-åœŸ', percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar('bar-é‡‘', percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar('bar-æ°´', percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡åˆ†æ
    const elementEntries = Object.entries(elements);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `äº”è¡Œä¸­${strongest}å…ƒç´ æœ€å¼ºï¼Œ${weakest}å…ƒç´ æœ€å¼±ã€‚`);

    // ç”ŸæˆAIè§£è¯»
    generateAIInsight(pillars, percents, tu);

  } catch (error) {
    console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
    showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// AIè§£è¯»ç”Ÿæˆ
function generateAIInsight(pillars, percents, timeUnknown) {
  const aiContent = $('aiContent');
  const aiChips = $('aiChips');
  
  if (!aiContent || !aiChips) return;

  // æ˜¾ç¤ºåŠ è½½éª¨æ¶å±
  aiContent.innerHTML = `
    <div class="skeleton">
      <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
      <div style="width:70%"></div><div style="width:50%"></div>
    </div>
  `;

  // æ¨¡æ‹ŸAIåˆ†æå»¶è¿Ÿ
  setTimeout(() => {
    const elements = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
    const strongest = elements.reduce((a, b) => percents[a] > percents[b] ? a : b);
    const weakest = elements.reduce((a, b) => percents[a] < percents[b] ? a : b);
    
    const insight = `
      <p><strong>å‘½ç›˜æ€»è§ˆï¼š</strong>æ‚¨çš„å…«å­—ä¸º ${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${timeUnknown ? 'ï¼Ÿï¼Ÿ' : pillars.hour.stem + pillars.hour.branch}</p>
      <p><strong>äº”è¡Œåˆ†æï¼š</strong>${strongest}å…ƒç´ åæ—ºï¼Œ${weakest}å…ƒç´ åå¼±ï¼Œæ•´ä½“å‘½å±€éœ€è¦è°ƒå’Œå¹³è¡¡ã€‚</p>
      <p><strong>å‘å±•å»ºè®®ï¼š</strong>å»ºè®®å¤šæ¥è§¦ä¸${weakest}å…ƒç´ ç›¸å…³çš„ç¯å¢ƒè‰²å½©ï¼Œå¦‚${getElementColor(weakest)}ç­‰ï¼Œæœ‰åŠ©äºå¹³è¡¡èƒ½é‡ã€‚</p>
      ${timeUnknown ? '<p class="muted">æç¤ºï¼šç”±äºå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥åˆ†æï¼Œç»“æœä»…ä¾›å‚è€ƒã€‚</p>' : ''}
    `;
    
    aiContent.innerHTML = insight;
    
    // ç”Ÿæˆè¯é¢˜èŠ¯ç‰‡
    const topics = [
      { label: 'äº‹ä¸šå»ºè®®', emoji: 'ğŸ’¼' },
      { label: 'æ„Ÿæƒ…è¿åŠ¿', emoji: 'â¤ï¸' },
      { label: 'è´¢è¿åˆ†æ', emoji: 'ğŸ’°' },
      { label: 'å¥åº·æé†’', emoji: 'ğŸŒ¿' }
    ];
    
    aiChips.innerHTML = topics.map(topic => `
      <button class="chip" onclick="showTopicInsight('${topic.label}')">
        ${topic.emoji} ${topic.label}
      </button>
    `).join('');
  }, 1500);
}

function getElementColor(element) {
  const colors = {
    'æœ¨': 'ç»¿è‰²ã€é’è‰²',
    'ç«': 'çº¢è‰²ã€ç´«è‰²', 
    'åœŸ': 'é»„è‰²ã€æ£•è‰²',
    'é‡‘': 'ç™½è‰²ã€é‡‘è‰²',
    'æ°´': 'é»‘è‰²ã€è“è‰²'
  };
  return colors[element] || 'ç›¸åº”è‰²ç³»';
}

function showTopicInsight(topic) {
  const insights = {
    'äº‹ä¸šå»ºè®®': 'åŸºäºæ‚¨çš„å‘½ç›˜ï¼Œå»ºè®®åœ¨åˆ›æ„ã€æ•™è‚²æˆ–æœåŠ¡è¡Œä¸šå‘å±•ï¼Œé¿å…è¿‡äºæœºæ¢°é‡å¤çš„å·¥ä½œã€‚',
    'æ„Ÿæƒ…è¿åŠ¿': 'æ„Ÿæƒ…æ–¹é¢éœ€è¦ä¸»åŠ¨æ²Ÿé€šï¼Œå»ºç«‹ä¿¡ä»»åŸºç¡€ï¼Œé€‚åˆå¯»æ‰¾æ€§æ ¼äº’è¡¥çš„ä¼´ä¾£ã€‚',
    'è´¢è¿åˆ†æ': 'è´¢è¿ç¨³æ­¥ä¸Šå‡ï¼Œå»ºè®®åšå¥½è´¢åŠ¡è§„åˆ’ï¼Œé¿å…å†²åŠ¨æŠ•èµ„ã€‚',
    'å¥åº·æé†’': 'æ³¨æ„ä½œæ¯è§„å¾‹ï¼Œå¤šè¿›è¡Œæˆ·å¤–æ´»åŠ¨ï¼Œä¿æŒå¿ƒæƒ…æ„‰æ‚¦ã€‚'
  };
  
  const aiContent = $('aiContent');
  if (aiContent) {
    aiContent.innerHTML = `<p><strong>${topic}ï¼š</strong>${insights[topic]}</p>`;
  }
}

// èŠå¤©åŠŸèƒ½
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');

  if (!chatFab || !chatPanel) return;

  chatFab.addEventListener('click', () => {
    chatPanel.style.display = chatPanel.style.display === 'block' ? 'none' : 'block';
    if (chatPanel.style.display === 'block') {
      chatInput.focus();
    }
  });

  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });

  function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    messageDiv.textContent = text;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = '';
    chatSend.disabled = true;

    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
      const responses = [
        'æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œå»ºè®®å¤šå…³æ³¨äº”è¡Œå¹³è¡¡ã€‚',
        'å‘½ç†æ˜¾ç¤ºæ‚¨è¿‘æœŸè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆåˆ¶å®šé•¿æœŸè®¡åˆ’ã€‚',
        'ä»äº”è¡Œè§’åº¦çœ‹ï¼Œæ‚¨éœ€è¦åŠ å¼ºç›¸åº”å…ƒç´ çš„èƒ½é‡ã€‚',
        'å»ºè®®ç»“åˆå…·ä½“é—®é¢˜ï¼Œæˆ‘å¯ä»¥ç»™å‡ºæ›´ç²¾å‡†çš„å»ºè®®ã€‚'
      ];
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      addMessage(randomResponse, false);
      chatSend.disabled = false;
    }, 1000 + Math.random() * 2000);
  }
}

// æ—¶é—´æœªçŸ¥åŠŸèƒ½
function initTimeUnknown() {
  const timeCheckbox = $('timeUnknown');
  const timeInput = $('birthtime');
  
  if (!timeCheckbox || !timeInput) return;
  
  timeCheckbox.addEventListener('change', () => {
    timeInput.disabled = timeCheckbox.checked;
    if (timeCheckbox.checked) {
      showTimeEstimateDialog();
    }
  });
}

function showTimeEstimateDialog() {
  const periods = [
    { name: 'å­æ—¶', time: '23:00-01:00', value: '00:00' },
    { name: 'ä¸‘æ—¶', time: '01:00-03:00', value: '02:00' },
    { name: 'å¯…æ—¶', time: '03:00-05:00', value: '04:00' },
    { name: 'å¯æ—¶', time: '05:00-07:00', value: '06:00' },
    { name: 'è¾°æ—¶', time: '07:00-09:00', value: '08:00' },
    { name: 'å·³æ—¶', time: '09:00-11:00', value: '10:00' },
    { name: 'åˆæ—¶', time: '11:00-13:00', value: '12:00' },
    { name: 'æœªæ—¶', time: '13:00-15:00', value: '14:00' },
    { name: 'ç”³æ—¶', time: '15:00-17:00', value: '16:00' },
    { name: 'é…‰æ—¶', time: '17:00-19:00', value: '18:00' },
    { name: 'æˆŒæ—¶', time: '19:00-21:00', value: '20:00' },
    { name: 'äº¥æ—¶', time: '21:00-23:00', value: '22:00' }
  ];

  const selected = prompt(`è¯·é€‰æ‹©å¤§æ¦‚çš„å‡ºç”Ÿæ—¶æ®µï¼š\n${periods.map(p => `${p.name}ï¼ˆ${p.time}ï¼‰`).join('\n')}\n\nè¯·è¾“å…¥æ—¶æ®µåç§°ï¼ˆå¦‚ï¼šå­æ—¶ï¼‰`);
  
  if (selected) {
    const period = periods.find(p => p.name === selected);
    if (period) {
      $('birthtime').value = period.value;
      $('timeUnknown').checked = false;
      $('birthtime').disabled = false;
    }
  }
}

// å¤šè¯­è¨€æ”¯æŒï¼ˆç®€åŒ–ç‰ˆï¼‰
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (!langSelect) return;

  // è®¾ç½®é»˜è®¤è¯­è¨€
  const savedLang = localStorage.getItem('bazi_lang') || 'zh-CN';
  langSelect.value = savedLang;
  document.documentElement.lang = savedLang;

  langSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    localStorage.setItem('bazi_lang', lang);
    document.documentElement.lang = lang;
    applyLanguage(lang);
  });
}

function applyLanguage(lang) {
  // ç®€åŒ–ç‰ˆå¤šè¯­è¨€ - å®é™…é¡¹ç›®ä¸­åº”è¯¥æœ‰å®Œæ•´çš„ç¿»è¯‘æ–‡ä»¶
  const translations = {
    'zh-CN': {
      title: 'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜',
      generate: 'ç”Ÿæˆå…«å­—',
      calculating: 'è®¡ç®—ä¸­...'
    },
    'en': {
      title: 'Bazi Fortune Â· Quick Analysis',
      generate: 'Generate Chart', 
      calculating: 'Calculating...'
    }
  };

  const t = translations[lang] || translations['zh-CN'];
  
  const titleEl = document.querySelector('.h2');
  if (titleEl) titleEl.textContent = t.title;
  
  const genBtn = $('genBtnText');
  if (genBtn) genBtn.textContent = t.generate;
}

// åˆå§‹åŒ–å‡½æ•°
function init() {
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const today = new Date().toISOString().split('T')[0];
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    birthdateInput.value = today;
  }

  // ç»‘å®šäº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // å›è½¦é”®å¿«é€Ÿç”Ÿæˆ
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('å…«å­—å‘½ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
