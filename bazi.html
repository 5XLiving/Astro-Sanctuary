<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- 农历 <-> 阳历 可靠转换（成熟库） -->
<script src="https://unpkg.com/solarlunar@2.0.6/solarlunar.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#0b0f14;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid:#1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 结果样式 */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.3rem;font-weight:700;letter-spacing:.05em}
.bars{display:grid;gap:8px;margin-top:10px}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.ul{margin:.4rem 0 0 .9rem;line-height:1.8}

/* Chat */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:95%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}

/* Chat 字号微调 */
.ss-chat-panel{font-size:15.5px}.ss-chat-head{font-size:16.5px}.ss-chat-body{gap:10px}
.ss-msg{font-size:15.5px;line-height:1.65;padding:10px 12px;border-radius:12px;max-width:95%}
.ss-msg.me{font-size:15.5px;line-height:1.65;padding:10px 12px;border-radius:12px}
.ss-chat-input input{font-size:15.5px;height:44px;padding:10px 12px}
.ss-chat-input button{font-size:15.5px;height:44px;padding:0 14px}
@media (max-width: 480px){
  .ss-chat-panel{font-size:16px}
  .ss-msg,.ss-msg.me{font-size:16px;line-height:1.7}
  .ss-chat-input input,.ss-chat-input button{height:46px;font-size:16px}
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title" data-i18n="site_title">命理供门 · 八字简评</div>
        <div class="muted" data-i18n="site_subtitle">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <section class="card">
    <div class="h2" data-i18n="form_title">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="name_label">姓名（可选）</label>
        <input id="name" data-i18n-ph="ph_name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">性别</label>
        <select id="gender">
          <option value="" data-i18n="gender_unknown">不透露</option>
          <option value="male" data-i18n="gender_male">男性</option>
          <option value="female" data-i18n="gender_female">女性</option>
          <option value="other" data-i18n="gender_other">其他</option>
        </select>
      </div>

      <!-- 历法 + 闰月 -->
      <div>
        <label class="muted" data-i18n="calendar_label">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_gregorian">阳历 / Gregorian</option>
            <option value="lunar" data-i18n="opt_lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none;font-size:.9rem;color:#cbd6e2;">
            <input type="checkbox" id="isLeap" /> 闰月
          </label>
        </div>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" id="calendarHint" style="display:none;margin-top:6px">
          当前为农历输入。若遇闰月请勾选“闰月”。系统将自动转换为阳历再计算。
        </div>
      </div>
      <div>
        <label class="muted" data-i18n="birth_time_label">出生时间</label>
        <input type="time" id="birthtime">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn" data-i18n="btn_generate">生成八字</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px" data-i18n="tip_tz">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div class="muted" id="error" style="color:#ffb4b4;display:none"></div>
  </section>

  <!-- 结果 -->
  <section id="result" style="display:none;">
    <div class="card section">
      <div class="h2" data-i18n="sec_bazi">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2" data-i18n="sec_wuxing">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-fire"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-earth" style="width:0%"></i></div>
        <div class="bar"><i id="bar-metal" style="width:0%"></i></div>
        <div class="bar"><i id="bar-water" style="width:0%"></i></div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <div class="card section">
      <div class="h2" data-i18n="sec_summary">命格简评</div>
      <div class="desc" id="bazi-advice" style="white-space:pre-wrap;line-height:1.7"></div>
      <ul class="ul" id="fate-points"></ul>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle" data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
/* ------------ 轻量 i18n ------------ */
const LANG_KEY = "site_lang";
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const i18n = {
  "zh-CN": {
    need_birth:"请完善出生日期与时间（若选农历，将自动换算为阳历）。",
    generating:"正在生成排盘…",
    neterr:"网络异常，请稍后再试。",
    used_solar:(d,t)=>`用于计算（UTC+8，阳历）：${d} ${t}`,
  },
  "en": {
    need_birth:"Please provide both date and time. If Lunar is chosen, it will be converted to Solar first.",
    generating:"Generating chart…",
    neterr:"Network error. Try again later.",
    used_solar:(d,t)=>`Used for calculation (UTC+8, Solar): ${d} ${t}`,
  }
};
const t = (k,...a) => { const L=i18n[getLang()]||i18n["zh-CN"]; const v=L[k]; return (typeof v==="function")?v(...a):(v||k); };

/* ------------ 动态加载依赖库（多 CDN 回退） ------------ */
async function loadScriptOnce(urls){
  for(const src of urls){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous';
        s.onload=()=>res(); s.onerror=()=>rej(new Error('load failed '+src)); document.head.appendChild(s);
      });
      return true;
    }catch(e){}
  }
  return false;
}
async function ensureDeps(){
  // solarlunar：农历<->阳历互转（做交叉校验）
  if(!window.solarlunar){
    const ok = await loadScriptOnce([
      'https://unpkg.com/solarlunar@2.0.6/solarlunar.min.js',
      'https://cdn.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js',
      'https://fastly.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js'
    ]);
    if(!ok) throw new Error('农历换算组件加载失败（网络/CDN）。');
  }
  // lunar-javascript：四柱/干支计算
  if(!window.Lunar || !window.Solar){
    const ok = await loadScriptOnce([
      'https://unpkg.com/lunar-javascript@1.6.15/lunar.min.js',
      'https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js',
      'https://fastly.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js'
    ]);
    if(!ok) throw new Error('命理计算组件加载失败（网络/CDN）。');
  }
}

/* ------------ 输入规范化 & 农历<->阳历 交叉校验 ------------ */
function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;                // yyyy-mm-dd
  const m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);          // dd/mm/yyyy
  if(m){ const [_,d,mo,y]=m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTimeTo24h(t){
  if(!t) return '00:00';
  const s=t.trim().toLowerCase().replace(/\s+/g,'');
  const m=s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t; // 原生 <input type="time"> 已是 HH:MM
  let hh=parseInt(m[1],10), mm=parseInt(m[2]||'0',10), ap=m[3];
  if(ap==='am'){ if(hh===12) hh=0; } else if(ap==='pm'){ if(hh!==12) hh+=12; }
  return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
}
function lunarToSolarChecked(y,m,d,isLeap){
  const s = solarlunar.lunar2solar(y,m,d,!!isLeap);
  const Y = s.cYear || s.gregorianYear || s.year;
  const M = s.cMonth|| s.gregorianMonth|| s.month;
  const D = s.cDay  || s.gregorianDay  || s.day;
  // 反向校验
  const back = solarlunar.solar2lunar(Y,M,D);
  const ok = back.lYear===y && back.lMonth===m && back.lDay===d && (!!back.isLeap)===!!isLeap;
  if(!ok) throw new Error('农历/阳历交叉校验失败：请核对闰月与日期。');
  return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
}
function solarRoundtripOrSkip(y,m,d){
  try{
    const l=solarlunar.solar2lunar(y,m,d);
    const r=solarlunar.lunar2solar(l.lYear,l.lMonth,l.lDay,!!l.isLeap);
    const Y2=r.cYear||r.year, M2=r.cMonth||r.month, D2=r.cDay||r.day;
    return (y===Y2 && m===M2 && d===D2);
  }catch{ return true; } // 库异常时不阻塞
}

/* ------------ 五行与描述（简化） ------------ */
const STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const BRANCH_ELEM = {子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const ELEM_KEYS = ['木','火','土','金','水'];
const DM_DESC = {
  甲:'外向生发，宜先破土后固化；重长期与成长节奏。',
  乙:'柔和渗透，善连结与修饰；宜稳步推进，重韧性。',
  丙:'外放明朗，宜先声夺人；重曝光与速度，忌拖延。',
  丁:'内燃定向，宜点到为止；重垂直深耕与口碑。',
  戊:'定盘承载，宜构建规则与壁垒；重长期信誉。',
  己:'滋养落地，宜做整合与服务；重复利与耐心。',
  庚:'果断执行，宜定目标强推进；重标准与效率。',
  辛:'精致审慎，宜做品质与风控；重细节与选择权。',
  壬:'弹性适配，宜大框架与流动；重信息与势能。',
  癸:'滋润渗透，宜暗线铺垫；重隐形资源与耐力。'
};

/* ------------ 渲染工具（沿用你页面结构） ------------ */
const pillarsEl = $('bazi-pillars');
const dmEl = $('bazi-day-master');
const bars = { wood:$('bar-wood'), fire:$('bar-fire'), earth:$('bar-earth'), metal:$('bar-metal'), water:$('bar-water') };
function setBar(el, pct){ if(el) el.style.width = Math.max(0,Math.min(100,pct))+'%'; }
function renderPillars(p){
  pillarsEl.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const div=document.createElement('div');
    div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${(v&&v.gz)||'--'}</div>`;
    pillarsEl.appendChild(div);
  });
}

/* ------------ 核心：本地计算四柱 & 五行 ------------ */
function countElementsFromGZ(gzList){
  const cnt = {木:0,火:0,土:0,金:0,水:0};
  gzList.forEach(gz=>{
    if(!gz) return;
    const gan=gz[0], zhi=gz[1];
    const e1=STEM_ELEM[gan], e2=BRANCH_ELEM[zhi];
    if(e1) cnt[e1]+=1;
    if(e2) cnt[e2]+=1;
  });
  // 归一化成百分比
  const total = Object.values(cnt).reduce((a,b)=>a+b,0) || 1;
  const pct = { wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
  return {cnt, pct};
}
function strengthsFromBalance(cnt, dmElem){
  const tips=[];
  const order=['木','火','土','金','水'];
  const sorted=order.map(k=>[k,cnt[k]]).sort((a,b)=>b[1]-a[1]);
  const top = sorted[0][0], low = sorted[4][0];
  tips.push(`当前偏${top}，${low}偏弱；执行时优先用好「${top}」的资源与方法，补上「${low}」的短板。`);
  tips.push(`以日主「${dmElem}」为锚：做事先顺势，再用相生帮扶，少做相克硬抗。`);
  tips.push(`节奏建议：强项场景快进，弱项场景设边界与外包。`);
  return tips;
}

/* ------------ 主流程：点击生成 ------------ */
(async function main(){
  // 历法切换时（若存在闰月 UI）做显隐
  const calendarSel = $('calendar'), leapWrap=$('leapWrap'), calendarHint=$('calendarHint');
  if(calendarSel){
    const toggle=()=>{ const isLunar=calendarSel.value==='lunar'; if(leapWrap) leapWrap.style.display=isLunar?'inline-flex':'none'; if(calendarHint) calendarHint.style.display=isLunar?'block':'none'; };
    calendarSel.addEventListener('change',toggle); toggle();
  }

  $('genBtn').addEventListener('click', async ()=>{
    const err=$('error'); err.style.display='none'; err.textContent='';
    const rawDate=($('birthdate').value||'').trim();
    const rawTime=($('birthtime').value||'').trim();
    const cal = (calendarSel&&calendarSel.value) || 'gregorian';
    const isLeap = !!(($('isLeap')&&$('isLeap').checked));

    if(!rawDate || !rawTime){ err.textContent=t('need_birth'); err.style.display='block'; return; }
    const time24 = normalizeTimeTo24h(rawTime);

    try{
      await ensureDeps();
      // 统一得到阳历
      let solarDateStr='';
      if(cal==='lunar'){
        const [y,m,d]=normalizeDate(rawDate).split('-').map(Number);
        solarDateStr = lunarToSolarChecked(y,m,d,isLeap);
      }else{
        const dstr=normalizeDate(rawDate); const [Y,M,D]=dstr.split('-').map(Number);
        if(!solarRoundtripOrSkip(Y,M,D)) throw new Error('阳历往返校验失败：请检查日期是否有效。');
        solarDateStr=dstr;
      }

      // 用阳历 + 时间（默认 UTC+8）计算四柱
      const [Y,M,D] = solarDateStr.split('-').map(Number);
      const [hh,mm] = time24.split(':').map(Number);
      const solar = Solar.fromYmdHms(Y,M,D,hh,mm||0,0);
      const lunar = solar.getLunar();
      const ec = lunar.getEightChar();

      const gzYear = ec.getYear();   // 例：戊午
      const gzMonth= ec.getMonth();  // 甲寅
      const gzDay  = ec.getDay();    // 甲寅
      const gzHour = ec.getTime();   // 庚午

      // 日主
      const dayGan = ec.getDayGan();         // 例：甲
      const dmElem = STEM_ELEM[dayGan] || '';
      const dmDesc = DM_DESC[dayGan] || '';

      // 五行
      const {cnt,pct} = countElementsFromGZ([gzYear,gzMonth,gzDay,gzHour]);

      // 渲染
      $('result').style.display='block';
      $('bazi-date').textContent = t('used_solar', solarDateStr, time24);
      renderPillars({year:{gz:gzYear}, month:{gz:gzMonth}, day:{gz:gzDay}, hour:{gz:gzHour}});
      dmEl.textContent = `日主：${dayGan}（${dmElem}） ${dmDesc}`;

      setBar(bars.wood, pct.wood); setBar(bars.fire, pct.fire); setBar(bars.earth, pct.earth);
      setBar(bars.metal, pct.metal); setBar(bars.water, pct.water);
      $('bazi-elements-balance').textContent =
        `五行占比：木${Math.round(pct.wood)} 火${Math.round(pct.fire)} 土${Math.round(pct.earth)} 金${Math.round(pct.metal)} 水${Math.round(pct.water)}`;

      const strengths = strengthsFromBalance(cnt, dmElem);
      $('bazi-strengths').textContent = '亮点：' + strengths[0];
      $('bazi-advice').textContent =
        ['核心判断：围绕日主特性与五行偏向，先顺势再补位；强项就快、弱项就稳。',
         '现在要做的事：聚焦 1 个强势场景定目标；把 1 个弱项交给外部/流程化；本周排 2 次复盘。'
        ].join('\n');

      $('fate-points').innerHTML = strengths.map(s=>`<li>${s}</li>`).join('');

    }catch(e){
      const msg = e && e.message ? e.message : t('neterr');
      err.textContent = msg; err.style.display='block';
      $('result').style.display='block';
    }
  });
})();
</script>

</body>
</html>
