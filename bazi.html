<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f14;
  --card: #11161dcc;
  --line: #1f2a36;
  --text: #e8edf3;
  --muted: #9aa3b2;
  --brand: #d4af37;
  --gold: #d4af37;
  --gold2: #f2d27a;
  --radius: 14px;
  --shadow: 0 8px 30px rgba(0,0,0,.35);
  --accent: #3a86ff;
  --success: #4cc9a7;
  --warning: #ff9e00;
  --danger: #ff5a5f;
}

html, body {
  height: 100%;
  margin: 0;
  color: var(--text);
  background: var(--bg);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -2;
  background: linear-gradient(135deg, #0b0f14 0%, #1a2433 100%);
  filter: brightness(.8);
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px 16px 80px;
}

header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #0b0f14cc;
  border-bottom: 1px solid #0f1622;
  backdrop-filter: saturate(140%) blur(12px);
}

.head-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-badge {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: linear-gradient(145deg, #273243, #0e141c);
  display: grid;
  place-items: center;
  color: var(--brand);
  font-weight: 700;
  box-shadow: var(--shadow);
}

.title {
  font-family: "Noto Serif SC", "Noto Serif", serif;
  font-weight: 600;
  letter-spacing: .02em;
  font-size: 1.4rem;
}

.subtitle {
  color: var(--muted);
  font-size: 0.9rem;
}

.lang {
  display: flex;
  align-items: center;
  gap: 8px;
}

.lang label {
  color: var(--muted);
  font-size: .9rem;
}

.lang select {
  appearance: none;
  border-radius: 10px;
  border: 1px solid #243244;
  background: #0e1520;
  color: var(--text);
  padding: 10px 34px 10px 12px;
  font-size: 0.9rem;
}

.card {
  background: var(--card);
  border: 1px solid #1f2a36;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 20px;
}

.section {
  margin-top: 18px;
}

.row {
  display: grid;
  gap: 12px;
}

@media (min-width: 760px) {
  .row.cols-3 {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .row.cols-2 {
    grid-template-columns: 1fr 1fr;
  }
}

input, select, textarea {
  width: 100%;
  box-sizing: border-box;
  border-radius: 12px;
  border: 1px solid #243244;
  background: #0e1520;
  color: var(--text);
  padding: 12px 12px;
  font-size: 15px;
  transition: all 0.2s ease;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
}

button, .btn {
  width: auto;
  display: inline-grid;
  place-items: center;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid #e6c76e;
  background: linear-gradient(180deg, #fff9e6, #e6c76e);
  color: #191919;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}

.btn:disabled {
  opacity: .6;
  cursor: not-allowed;
  transform: none;
}

.h2 {
  font-size: 1.3rem;
  margin: 0 0 1rem;
  font-weight: 700;
  color: #ffe084;
  display: flex;
  align-items: center;
  gap: 10px;
}

.h2::before {
  content: "";
  display: block;
  width: 4px;
  height: 20px;
  background: var(--brand);
  border-radius: 2px;
}

.muted {
  color: #9aa3b2;
}

footer {
  color: #6c7b8c;
  font-size: .85rem;
  text-align: center;
  padding: 30px 0;
  margin-top: 30px;
}

/* 结果样式 */
.pillars {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-top: 8px;
}

.pillar {
  background: #0f1624;
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 14px 10px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.pillar::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--brand);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.pillar:hover {
  transform: translateY(-3px);
  border-color: var(--brand);
}

.pillar:hover::before {
  opacity: 1;
}

.pillar .tit {
  color: #9aa3b2;
  font-size: .85rem;
  margin-bottom: 6px;
}

.pillar .gz {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: .05em;
  color: var(--gold2);
}

.bars {
  display: grid;
  gap: 8px;
  margin-top: 10px;
}

.bar {
  height: 10px;
  background: #0d1420;
  border: 1px solid #233146;
  border-radius: 999px;
  overflow: hidden;
  position: relative;
}

.bar i {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, #ffe084, #f2d27a);
  transition: width 1s ease;
}

.bar-label {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
  font-size: 0.85rem;
}

.ul {
  margin: .4rem 0 0 .9rem;
  line-height: 1.8;
}

/* 心怜管家样式 */
.assistant-container {
  margin-top: 30px;
  border-top: 1px solid #1f2a36;
  padding-top: 20px;
}

.assistant-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 15px;
}

.assistant-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #191919;
  font-weight: 700;
  font-size: 1.2rem;
}

.assistant-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--gold2);
}

.assistant-subtitle {
  color: var(--muted);
  font-size: 0.9rem;
}

.assistant-message {
  background: rgba(15, 22, 36, 0.7);
  border: 1px solid #253245;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 15px;
  position: relative;
  animation: fadeIn 0.5s ease;
}

.assistant-message::before {
  content: "";
  position: absolute;
  top: -6px;
  left: 20px;
  width: 12px;
  height: 12px;
  background: inherit;
  border-top: 1px solid #253245;
  border-left: 1px solid #253245;
  transform: rotate(45deg);
}

.assistant-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.action-btn {
  padding: 8px 16px;
  border-radius: 20px;
  background: rgba(212, 175, 55, 0.1);
  border: 1px solid rgba(212, 175, 55, 0.3);
  color: var(--gold2);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.action-btn:hover {
  background: rgba(212, 175, 55, 0.2);
  transform: translateY(-2px);
}

.vip-promo {
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(76, 201, 167, 0.1));
  border: 1px solid rgba(212, 175, 55, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
  position: relative;
  overflow: hidden;
}

.vip-promo::before {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), transparent);
  border-radius: 0 0 0 80px;
}

.vip-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.vip-badge {
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  color: #191919;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
}

.vip-title {
  font-weight: 600;
  color: var(--gold2);
}

.vip-features {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.vip-feature {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
}

.vip-feature::before {
  content: "✓";
  color: var(--success);
  font-weight: 700;
}

.vip-cta {
  display: inline-block;
  padding: 10px 20px;
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  color: #191919;
  border-radius: 8px;
  font-weight: 700;
  text-decoration: none;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.vip-cta:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-message {
  background: rgba(255, 90, 95, 0.1);
  border: 1px solid var(--danger);
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
  color: #ffb4b4;
}

/* 时间不详选项样式 */
.time-unknown-container {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.time-unknown-checkbox {
  width: 16px;
  height: 16px;
}

.time-unknown-label {
  font-size: 0.9rem;
  color: var(--muted);
}

.time-input-container {
  transition: all 0.3s ease;
}

.time-input-container.disabled {
  opacity: 0.5;
  pointer-events: none;
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="subtitle">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> 闰月
          </label>
        </div>
        <div id="calendarHint" class="muted" style="display:none; margin-top:6px;">
          选择农历时，请确认是否为闰月；若为闰月请勾选"闰月"。系统会自动换算为阳历后计算。
        </div>
      </div>
    </div>

    <div id="depsRow" class="muted" style="display:flex;align-items:center;gap:10px;margin-top:8px">
      <span>依赖状态：</span>
      <span id="depsStatus" style="color:#ffdf8a">未加载</span>
      <button id="depsReload" class="btn" style="padding:6px 10px;border-radius:10px">重新加载</button>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" value="1978-02-21">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-input-container" id="timeInputContainer">
          <input type="time" id="birthtime" value="12:45">
        </div>
        <div class="time-unknown-container">
          <input type="checkbox" id="timeUnknown" class="time-unknown-checkbox">
          <label for="timeUnknown" class="time-unknown-label">出生时间不详</label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" class="loading" style="display:none"></span>
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div id="error" class="error-message" style="display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <!-- 八字结果显示部分 -->
    <div class="card section">
      <div class="h2">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
      <div class="muted" id="bazi-time-note" style="color: var(--warning);"></div>
    </div>

    <div class="card section">
      <div class="h2">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"></i></div>
        <div class="bar-label">
          <span>木</span>
          <span id="pct-wood">0%</span>
        </div>
        <div class="bar"><i id="bar-fire"></i></div>
        <div class="bar-label">
          <span>火</span>
          <span id="pct-fire">0%</span>
        </div>
        <div class="bar"><i id="bar-earth"></i></div>
        <div class="bar-label">
          <span>土</span>
          <span id="pct-earth">0%</span>
        </div>
        <div class="bar"><i id="bar-metal"></i></div>
        <div class="bar-label">
          <span>金</span>
          <span id="pct-metal">0%</span>
        </div>
        <div class="bar"><i id="bar-water"></i></div>
        <div class="bar-label">
          <span>水</span>
          <span id="pct-water">0%</span>
        </div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <!-- 心怜管家 AI 助手 -->
    <div class="assistant-container">
      <div class="assistant-header">
        <div class="assistant-avatar">心</div>
        <div>
          <div class="assistant-title">心怜管家 · AI 命理助手</div>
          <div class="assistant-subtitle">基于您的八字分析，为您提供个性化建议</div>
        </div>
      </div>
      
      <div class="assistant-message" id="assistant-initial">
        <p>您好！我是心怜管家，基于您的八字分析，我注意到：</p>
        <div id="assistant-analysis"></div>
        <p>以下是根据您的命理特点提供的建议：</p>
        <div id="assistant-advice"></div>
        
        <div class="assistant-actions">
          <div class="action-btn" data-action="career">事业建议</div>
          <div class="action-btn" data-action="wealth">财运分析</div>
          <div class="action-btn" data-action="relationship">感情指导</div>
          <div class="action-btn" data-action="health">健康提醒</div>
          <div class="action-btn" data-action="lucky">幸运方向</div>
        </div>
      </div>

      <!-- VIP 服务推荐 -->
      <div class="vip-promo">
        <div class="vip-header">
          <div class="vip-badge">VIP</div>
          <div class="vip-title">解锁深度命理分析</div>
        </div>
        <p>免费版仅提供基础分析，VIP服务包含：</p>
        <div class="vip-features">
          <div class="vip-feature">详细流年运势分析</div>
          <div class="vip-feature">十年大运精准预测</div>
          <div class="vip-feature">个性化择日服务</div>
          <div class="vip-feature">专业命名建议</div>
          <div class="vip-feature">全年运势月历</div>
          <div class="vip-feature">一对一命理咨询</div>
        </div>
        <p>立即升级VIP，获取专属命理指导！</p>
        <a href="#" class="vip-cta">了解VIP服务详情</a>
      </div>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<script>
// 工具函数
function $(id) { return document.getElementById(id); }
function setBar(el, pct) { if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function el(tag, attrs = {}, html = "") { 
  const d = document.createElement(tag); 
  Object.entries(attrs).forEach(([k, v]) => d.setAttribute(k, v)); 
  d.innerHTML = html; 
  return d; 
}

// 依赖加载函数
async function loadScript(src, timeout = 15000) {
  if ([...document.scripts].some(s => (s.src || '').includes(src))) return;
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    script.crossOrigin = 'anonymous';
    
    const timer = setTimeout(() => {
      reject(new Error(`加载超时: ${src}`));
    }, timeout);
    
    script.onload = () => {
      clearTimeout(timer);
      resolve();
    };
    
    script.onerror = () => {
      clearTimeout(timer);
      reject(new Error(`加载失败: ${src}`));
    };
    
    document.head.appendChild(script);
  });
}

// 加载农历库
async function ensureLunarJS() {
  if (window.Lunar && window.Solar) {
    $('depsStatus').textContent = 'lunar 已就绪';
    $('depsStatus').style.color = '#9aa3b2';
    return true;
  }

  $('depsStatus').textContent = '加载中...';
  $('depsStatus').style.color = '#ffdf8a';

  const candidates = [
    'assets/vendor/lunar.min.js',
    '/assets/vendor/lunar.min.js',
    'assets/vendor/solarlunar.min.js',
    '/assets/vendor/solarlunar.min.js'
  ];

  for (const url of candidates) {
    try {
      await loadScript(url, 8000);
      
      // 检查是否加载成功
      if (window.Lunar && window.Solar) {
        $('depsStatus').textContent = 'lunar 已就绪';
        $('depsStatus').style.color = '#9aa3b2';
        return true;
      }
      
      // 检查 solarlunar
      if (window.solarlunar) {
        // 如果使用 solarlunar，创建兼容接口
        window.Lunar = {
          fromYmd: (year, month, day) => {
            const lunar = solarlunar.solar2lunar(year, month, day);
            return {
              getEightChar: () => ({
                getYear: () => lunar.gzYear,
                getMonth: () => lunar.gzMonth,
                getDay: () => lunar.gzDay,
                getTime: (hour) => {
                  // 简化时柱计算
                  const timeBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                  const branchIndex = Math.floor((hour + 1) / 2) % 12;
                  const branch = timeBranches[branchIndex];
                  
                  // 日干计算时干
                  const dayStem = lunar.gzDay[0];
                  const stemStarts = {
                    '甲': 0, '乙': 2, '丙': 4, '丁': 6, '戊': 8,
                    '己': 0, '庚': 2, '辛': 4, '壬': 6, '癸': 8
                  };
                  const stemStart = stemStarts[dayStem] || 0;
                  const stemIndex = (stemStart + branchIndex) % 10;
                  const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                  const stem = stems[stemIndex];
                  
                  return stem + branch;
                }
              })
            };
          }
        };
        $('depsStatus').textContent = 'solarlunar 已就绪';
        $('depsStatus').style.color = '#9aa3b2';
        return true;
      }
    } catch (error) {
      console.log(`尝试加载 ${url} 失败:`, error);
    }
  }

  $('depsStatus').textContent = '加载失败';
  $('depsStatus').style.color = '#ffb4b4';
  return false;
}

// 使用专业库的八字计算
class AccurateBaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    this.EARTHLY_BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    this.STEM_ELEMENTS = { '甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土', '己': '土', '庚': '金', '辛': '金', '壬': '水', '癸': '水' };
    this.BRANCH_ELEMENTS = { '子': '水', '丑': '土', '寅': '木', '卯': '木', '辰': '土', '巳': '火', '午': '火', '未': '土', '申': '金', '酉': '金', '戌': '土', '亥': '水' };
  }

  // 使用专业库计算八字
  calculateBazi(year, month, day, hour, timeUnknown = false) {
    if (!window.Lunar) {
      throw new Error('农历库未加载');
    }

    try {
      const solar = window.Lunar.fromYmd(year, month, day);
      const eightChar = solar.getEightChar();
      
      const yearPillar = eightChar.getYear();
      const monthPillar = eightChar.getMonth();
      const dayPillar = eightChar.getDay();
      const hourPillar = timeUnknown ? '？？' : eightChar.getTime(hour);

      return {
        year: {
          stem: yearPillar[0],
          branch: yearPillar[1],
          element: this.STEM_ELEMENTS[yearPillar[0]]
        },
        month: {
          stem: monthPillar[0],
          branch: monthPillar[1],
          element: this.STEM_ELEMENTS[monthPillar[0]]
        },
        day: {
          stem: dayPillar[0],
          branch: dayPillar[1],
          element: this.STEM_ELEMENTS[dayPillar[0]]
        },
        hour: timeUnknown ? {
          stem: '？',
          branch: '？',
          element: '未知'
        } : {
          stem: hourPillar[0],
          branch: hourPillar[1],
          element: this.STEM_ELEMENTS[hourPillar[0]]
        },
        timeUnknown: timeUnknown
      };
    } catch (error) {
      console.error('八字计算错误:', error);
      throw new Error('八字计算失败，请检查输入数据');
    }
  }
}

// 心怜管家 AI 功能
class XinLianAssistant {
  constructor() {
    this.currentContext = null;
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('action-btn')) {
        const action = e.target.getAttribute('data-action');
        this.handleAction(action);
      }
    });
  }

  generateAnalysis(baziData) {
    this.currentContext = baziData;
    
    const analysis = this.analyzeBazi(baziData);
    const advice = this.generateAdvice(baziData);
    
    document.getElementById('assistant-analysis').innerHTML = analysis;
    document.getElementById('assistant-advice').innerHTML = advice;
  }

  analyzeBazi(baziData) {
    const { dayMaster, elements, strength, season, timeUnknown } = baziData;
    
    let timeNote = '';
    if (timeUnknown) {
      timeNote = '<li><strong>注意：</strong>由于出生时间不详，时柱无法确定，此分析仅基于年月日三柱</li>';
    }
    
    let analysis = `
      <ul class="ul">
        <li>您的日主为 <strong>${dayMaster.stem}（${dayMaster.element}）</strong></li>
        <li>命局整体<strong>${strength.mark}</strong>，${this.getStrengthDescription(strength.mark)}</li>
        <li>出生于<strong>${season}</strong>季节，${this.getSeasonInfluence(season, dayMaster.element)}</li>
        <li>五行分布：${this.getElementDistribution(elements)}</li>
        ${timeNote}
      </ul>
    `;
    
    return analysis;
  }

  generateAdvice(baziData) {
    const { strength, useful, timeUnknown } = baziData;
    
    let timeWarning = '';
    if (timeUnknown) {
      timeWarning = '<li><strong>重要提示：</strong>由于缺少时柱信息，此分析仅供参考。建议提供准确出生时间以获得更精准的命理分析。</li>';
    }
    
    let advice = `
      <ul class="ul">
        <li><strong>发展策略：</strong>${strength.focus}</li>
        <li><strong>喜用元素：</strong>${useful.useful.join('、')}</li>
        <li><strong>幸运颜色：</strong>${this.getLuckyColors(useful.useful)}</li>
        <li><strong>适合方位：</strong>${this.getLuckyDirections(useful.useful)}</li>
        ${timeWarning}
      </ul>
    `;
    
    return advice;
  }

  handleAction(action) {
    if (!this.currentContext) return;
    
    let response = '';
    
    switch(action) {
      case 'career':
        response = this.getCareerAdvice();
        break;
      case 'wealth':
        response = this.getWealthAdvice();
        break;
      case 'relationship':
        response = this.getRelationshipAdvice();
        break;
      case 'health':
        response = this.getHealthAdvice();
        break;
      case 'lucky':
        response = this.getLuckyDirectionsAdvice();
        break;
    }
    
    this.showActionResponse(action, response);
  }

  getCareerAdvice() {
    const { dayMaster, strength, timeUnknown } = this.currentContext;
    const careers = {
      '木': ['教育行业', '创意设计', '出版传媒', '环保产业'],
      '火': ['互联网科技', '市场营销', '娱乐产业', '餐饮行业'],
      '土': ['房地产', '建筑工程', '金融投资', '管理咨询'],
      '金': ['法律行业', '精密制造', '金融分析', '技术研发'],
      '水': ['物流运输', '旅游行业', '心理咨询', '国际贸易']
    };
    
    const suitableCareers = careers[dayMaster.element] || ['多元化发展'];
    const strengthText = strength.mark === '偏强' ? '适合挑战性工作' : '适合稳定性工作';
    const timeNote = timeUnknown ? '（注：时柱信息缺失，建议仅供参考）' : '';
    
    return `基于您的${dayMaster.element}属性日主，${strengthText}。推荐职业方向：${suitableCareers.join('、')}。${timeNote}`;
  }

  getWealthAdvice() {
    const { elements, useful, timeUnknown } = this.currentContext;
    const strongElement = this.getStrongestElement(elements);
    const weakElement = this.getWeakestElement(elements);
    const timeNote = timeUnknown ? ' 由于时柱信息不完整，财运分析可能不够精确。' : '';
    
    return `您的财运${strongElement === '金' || strongElement === '土' ? '较佳' : '需努力'}。建议加强${useful.useful.join('、')}元素的运用，避免${weakElement}相关的高风险投资。${timeNote}`;
  }

  getRelationshipAdvice() {
    const { dayMaster, elements, timeUnknown } = this.currentContext;
    const compatibleElements = this.getCompatibleElements(dayMaster.element);
    const timeNote = timeUnknown ? ' 时柱信息缺失可能影响感情分析的准确性。' : '';
    
    return `感情方面，您与${compatibleElements.join('、')}属性的人较为投缘。建议多参与社交活动，扩大交际圈。${timeNote}`;
  }

  getHealthAdvice() {
    const { elements, timeUnknown } = this.currentContext;
    const weakElement = this.getWeakestElement(elements);
    const healthMap = {
      '木': '肝胆、眼睛',
      '火': '心脏、血液循环',
      '土': '脾胃、消化系统',
      '金': '肺、呼吸系统',
      '水': '肾、泌尿系统'
    };
    const timeNote = timeUnknown ? ' 健康分析基于现有信息，建议结合实际情况。' : '';
    
    return `健康方面需特别注意${healthMap[weakElement]}的保养。建议定期体检，保持规律作息。${timeNote}`;
  }

  getLuckyDirectionsAdvice() {
    const { useful, timeUnknown } = this.currentContext;
    const directionMap = {
      '木': '东方',
      '火': '南方',
      '土': '中央、东北、西南',
      '金': '西方',
      '水': '北方'
    };
    
    const directions = useful.useful.map(el => directionMap[el]).filter(Boolean);
    const timeNote = timeUnknown ? ' 方位建议基于现有信息。' : '';
    
    return `您的幸运方位是：${directions.join('、')}。在这些方向工作、生活或旅行会带来好运。${timeNote}`;
  }

  showActionResponse(action, response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'assistant-message';
    messageDiv.innerHTML = `
      <p><strong>${this.getActionTitle(action)}：</strong>${response}</p>
      <p class="muted" style="margin-top: 10px; font-size: 0.9em;">
        💡 想要更精准的指导？<a href="#" style="color: var(--gold2);">升级VIP获取专属分析</a>
      </p>
    `;
    
    document.querySelector('.assistant-container').insertBefore(messageDiv, document.querySelector('.vip-promo'));
    messageDiv.scrollIntoView({ behavior: 'smooth' });
  }

  // 辅助方法
  getStrengthDescription(strength) {
    const descriptions = {
      '偏强': '具有较好的发展潜力和抗压能力',
      '偏弱': '需要更多的支持和帮助才能发挥潜力',
      '平衡': '各方面发展较为均衡，适应性强'
    };
    return descriptions[strength] || '具有独特的发展特点';
  }

  getSeasonInfluence(season, element) {
    const influences = {
      '春': '木气旺盛，生机勃勃',
      '夏': '火气旺盛，热情洋溢',
      '秋': '金气旺盛，收获时节',
      '冬': '水气旺盛，内敛沉静'
    };
    return influences[season] || '季节特点对命局有一定影响';
  }

  getElementDistribution(elements) {
    const sorted = Object.entries(elements)
      .sort((a, b) => b[1] - a[1])
      .map(([el, val]) => `${el}${Math.round(val)}%`)
      .join('、');
    return sorted;
  }

  getLuckyColors(elements) {
    const colorMap = {
      '木': '绿色、青色',
      '火': '红色、紫色',
      '土': '黄色、棕色',
      '金': '白色、金色',
      '水': '黑色、蓝色'
    };
    return elements.map(el => colorMap[el]).join('、');
  }

  getLuckyDirections(elements) {
    const directionMap = {
      '木': '东方',
      '火': '南方',
      '土': '中央',
      '金': '西方',
      '水': '北方'
    };
    return elements.map(el => directionMap[el]).join('、');
  }

  getStrongestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] > b[1] ? a : b)[0];
  }

  getWeakestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  }

  getCompatibleElements(element) {
    const compatibility = {
      '木': ['火', '水'],
      '火': ['木', '土'],
      '土': ['火', '金'],
      '金': ['土', '水'],
      '水': ['金', '木']
    };
    return compatibility[element] || ['多样化'];
  }

  getActionTitle(action) {
    const titles = {
      'career': '事业建议',
      'wealth': '财运分析',
      'relationship': '感情指导',
      'health': '健康提醒',
      'lucky': '幸运方向'
    };
    return titles[action] || '专业建议';
  }
}

// 初始化
const baziCalculator = new AccurateBaziCalculator();
const assistant = new XinLianAssistant();

// 五行分析
function countElements(pillars, timeUnknown = false) {
  const cnt = {木:0, 火:0, 土:0, 金:0, 水:0};
  const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const BRANCH_ELEM = {子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
  
  const pillarsToCount = timeUnknown ? 
    [pillars.year, pillars.month, pillars.day] : 
    [pillars.year, pillars.month, pillars.day, pillars.hour];
  
  pillarsToCount.forEach(pillar => {
    if(pillar.stem && STEM_ELEM[pillar.stem] && pillar.stem !== '？') 
      cnt[STEM_ELEM[pillar.stem]] += 1;
    if(pillar.branch && BRANCH_ELEM[pillar.branch] && pillar.branch !== '？') 
      cnt[BRANCH_ELEM[pillar.branch]] += 1;
  });
  
  const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
  return {
    cnt, 
    pct: {
      wood: cnt['木'] / total * 100,
      fire: cnt['火'] / total * 100,
      earth: cnt['土'] / total * 100,
      metal: cnt['金'] / total * 100,
      water: cnt['水'] / total * 100
    }
  };
}

// 判断命局强弱
function judgeStrength(dayGan, monthZhi, cnt) {
  const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH = {寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  
  const dmEl = STEM_ELEM[dayGan];
  const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  
  let score = 0;
  if((season === '春' && '木火'.includes(dmEl)) || (season === '夏' && '火土'.includes(dmEl)) || 
     (season === '秋' && dmEl === '金') || (season === '冬' && dmEl === '水')) score += 2;
  
  score += (cnt[dmEl] || 0) * 1.2;
  
  const mark = score >= 3 ? '偏强' : (score <= 1 ? '偏弱' : '平衡');
  const focus = mark === '偏强' ? '泄秀/制化' : (mark === '偏弱' ? '补助/顺势' : '守中/调和');
  
  return {season, mark, focus};
}

// 选择喜用神
function chooseUseful(strength, dmElem) {
  if (strength === '偏强') {
    const useful = ({木:['火','土','金'], 火:['土','金','水'], 土:['金','水','木'], 金:['水','木','火'], 水:['木','火','土']})[dmElem];
    return {strategy:'泄秀/制化', useful, avoid:[dmElem]};
  } else if (strength === '偏弱') {
    const helper = ({木:['木','水'], 火:['火','木'], 土:['土','火'], 金:['金','土'], 水:['水','金']})[dmElem];
    return {strategy:'生扶/补助', useful:helper, avoid:[]};
  }
  return {strategy:'守中/调和', useful:['木','火','土','金','水'], avoid:[]};
}

// 渲染四柱
function renderPillars(root, p, timeUnknown = false) {
  root.innerHTML = '';
  [['年柱', p.year], ['月柱', p.month], ['日柱', p.day], ['时柱', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === '时柱' && timeUnknown);
    const stem = isUnknown ? '？' : v.stem;
    const branch = isUnknown ? '？' : v.branch;
    
    const div = el('div', {class: 'pillar'}, `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `);
    root.appendChild(div);
  });
}

// 生成八字
async function genChart() {
  const err = $('error');
  err.style.display = 'none';
  err.textContent = '';
  
  const birth = ($('birthdate').value || '').trim();
  const timeUnknown = $('timeUnknown').checked;
  
  if(!birth) {
    err.textContent = '请填写出生日期。';
    err.style.display = 'block';
    return;
  }

  // 检查依赖
  const depsOk = await ensureLunarJS();
  if (!depsOk) {
    err.textContent = '命理计算组件加载失败，请点击"重新加载"或检查网络连接';
    err.style.display = 'block';
    return;
  }

  // 显示加载状态
  $('genBtnText').style.display = 'none';
  $('genBtnLoading').style.display = 'inline-block';
  $('genBtn').disabled = true;

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12;
    
    if (!timeUnknown) {
      const time = ($('birthtime').value || '').trim();
      if (time) {
        const [hh, mm] = time.split(':').map(Number);
        hour = hh;
      }
    }
    
    // 使用专业库计算八字
    const pillars = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    
    // 显示结果区域
    $('result').style.display = 'block';
    
    let timeDisplay = timeUnknown ? '时间不详（使用默认时间计算日柱）' : $('birthtime').value;
    $('bazi-date').textContent = `用于计算（UTC+8，阳历）：${birth} ${timeDisplay}`;
    
    // 渲染四柱
    renderPillars($('bazi-pillars'), pillars, timeUnknown);
    $('bazi-day-master').textContent = `日主：${pillars.day.stem}（${pillars.day.element}）`;
    
    // 时间不详提示
    if (timeUnknown) {
      $('bazi-time-note').textContent = '⚠️ 注意：出生时间不详，时柱无法确定。此分析仅基于年月日三柱，准确性有限。';
    } else {
      $('bazi-time-note').textContent = '';
    }
    
    // 五行分析
    const {cnt, pct} = countElements(pillars, timeUnknown);
    setBar($('bar-wood'), pct.wood);
    setBar($('bar-fire'), pct.fire);
    setBar($('bar-earth'), pct.earth);
    setBar($('bar-metal'), pct.metal);
    setBar($('bar-water'), pct.water);
    
    // 更新百分比显示
    $('pct-wood').textContent = Math.round(pct.wood) + '%';
    $('pct-fire').textContent = Math.round(pct.fire) + '%';
    $('pct-earth').textContent = Math.round(pct.earth) + '%';
    $('pct-metal').textContent = Math.round(pct.metal) + '%';
    $('pct-water').textContent = Math.round(pct.water) + '%';
    
    $('bazi-elements-balance').textContent = `五行占比：木${Math.round(pct.wood)}% 火${Math.round(pct.fire)}% 土${Math.round(pct.earth)}% 金${Math.round(pct.metal)}% 水${Math.round(pct.water)}%`;
    
    // 命局分析
    const st = judgeStrength(pillars.day.stem, pillars.month.branch, cnt);
    const adv = chooseUseful(st.mark, pillars.day.element);
    
    $('bazi-strengths').textContent = `命局${st.mark}，建议策略：${st.focus}`;
    
    // 调用AI助手
    const baziData = {
      dayMaster: pillars.day,
      elements: {
        wood: pct.wood,
        fire: pct.fire,
        earth: pct.earth,
        metal: pct.metal,
        water: pct.water
      },
      strength: st,
      season: st.season,
      useful: adv,
      timeUnknown: timeUnknown
    };
    
    assistant.generateAnalysis(baziData);
    
  } catch(e) {
    err.textContent = '计算失败：' + (e?.message || '请检查输入数据');
    err.style.display = 'block';
    console.error('八字计算错误:', e);
  } finally {
    // 恢复按钮状态
    $('genBtnText').style.display = 'inline-block';
    $('genBtnLoading').style.display = 'none';
    $('genBtn').disabled = false;
  }
}

// 页面加载
document.addEventListener('DOMContentLoaded', function() {
  // 设置默认日期
  $('birthdate').value = '1978-02-21';
  $('birthtime').value = '12:45';
  
  // 绑定事件
  $('genBtn').addEventListener('click', genChart);
  
  // 重新加载按钮
  $('depsReload').addEventListener('click', async () => {
    const ok = await ensureLunarJS();
    if (ok) {
      const err = $('error');
      err.style.display = 'none';
    }
  });
  
  // 时间不详复选框事件
  $('timeUnknown').addEventListener('change', function() {
    const timeInputContainer = $('timeInputContainer');
    if (this.checked) {
      timeInputContainer.classList.add('disabled');
    } else {
      timeInputContainer.classList.remove('disabled');
    }
  });
  
  // 历法提示显隐
  const cal = $('calendar'), leap = $('leapWrap'), hint = document.querySelector('#calendarHint');
  const toggle = () => {
    const isLunar = cal?.value === 'lunar';
    if (leap) leap.style.display = isLunar ? 'inline-flex' : 'none';
    if (hint) hint.style.display = isLunar ? 'block' : 'none';
  };
  cal?.addEventListener('change', toggle);
  
  // 初始化加载依赖
  ensureLunarJS();
  
  console.log('八字命理系统已初始化');
});
</script>
</body>
</html>
