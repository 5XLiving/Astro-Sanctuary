<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* 所有CSS样式保持不变 */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* 头部样式 */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* 主要内容区域 */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* 八字柱样式 */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* 五行能量条 */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* 时间输入行 */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* 生成按钮包装 */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* 详细分析区域 */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* 大运流年 */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* 会员区域 */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    /* VIP登录区域 */
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AI管家样式 */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* 详细分析页面样式 */
    .detail-view {display: none;}
    .detail-header {display: flex; align-items: center; gap: 12px; margin-bottom: 20px;}
    .back-btn {background: rgba(212,175,55,.1); border: 1px solid rgba(212,175,55,.3); color: var(--gold2); padding: 8px 16px; border-radius: 8px; cursor: pointer;}
    .detail-content {line-height: 1.8;}
    .detail-section {margin-bottom: 24px;}
    .detail-section h4 {color: var(--gold2); margin-bottom: 12px; font-size: 1.1rem;}
    .action-list {list-style: none; padding: 0;}
    .action-list li {margin-bottom: 8px; padding-left: 20px; position: relative;}
    .action-list li:before {content: "•"; color: var(--gold2); position: absolute; left: 0;}
    
    /* 聊天浮窗 */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
       position:absolute !important;
       width:1px;height:1px;padding:0;margin:-1px;
       overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* 添加到CSS中 */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
      justify-content: center;
    }

    /* 在CSS部分添加VIP区域的特殊类 */
     .vip-section {
      display: block !important; /* 确保VIP区域始终显示 */
    }

  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 八字排盘表单 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar">
          <option value="gregorian">阳历</option>
          <option value="lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果显示区域 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- 详细分析区域 -->
    <div class="card">
      <div class="h2">🧙‍♂️ 命主基本信息</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>🔍 总体命运解读</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💼 事业分析</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>💰 财富状况</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>❤️ 婚姻感情</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- 大运流年 -->
    <div class="card">
      <div class="h2">📈 大运流年分析</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>

    <!-- AI管家区域 -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">心怜管家 · 深度解读</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>

          <!-- 详细分析页面 -->
    <div id="detailView" class="card detail-view">
      <div class="detail-header">
        <button class="back-btn" id="backBtn">← 返回主分析</button>
        <h2 id="detailTitle">详细分析</h2>
      </div>
      <div class="detail-content" id="detailContent"></div>
    </div>
  
      <!-- 交互芯片区域 -->
      <div class="chips" id="aiChips" style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
        <button class="chip" data-type="career">详细事业分析</button>
        <button class="chip" data-type="wealth">财运投资建议</button>
        <button class="chip" data-type="marriage">婚姻感情解读</button>
        <button class="chip" data-type="health">健康养生指导</button>
        <button class="chip" data-type="luck">流年运势预测</button>
      </div>
    </div>

  </section>    
    
  <!-- 会员区域 - 确保这个区域存在 -->
  <section class="card section vip-section">
    <h2 class="group-title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">🗝 命理空间专属内容</div>
        <ul>
          <li>姻缘方向：恋爱缘分、婚姻走势</li>
          <li>事业方向：职场发展、创业潜力</li>
          <li>财运方向：财位分析、理财时机</li>
          <li>宠物命理：伴侣动物的性格与缘分</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">🌙 心怜空间专属内容</div>
        <ul>
          <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li>命理课程：八字 / 塔罗 / 占星 / 灵数</li>
          <li>家族纪念系统：亲人灵性纪念 & 延续</li>
          <li>每周能量练习 / 神明仪式任务</li>
        </ul>
      </div>
    </div>

    <!-- VIP登录区域 -->
    <div class="group-title" style="margin-top:14px">💎 登入 VIP 功能</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <!-- 左侧：输入 + 注册/登录 -->
        <div class="panel">
          <div class="head">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="邮箱 Email" required />
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="密码 Password（至少8位，含大小写数字符号）" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit">登入账户</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button">🔑 重设密码</button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit">注册账户</button>
              <div class="muted">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

<!-- 右侧：会员与返回 -->
<div class="panel">
  <div class="head">会员服务</div>
  <div class="body">
    <div class="row one">
      <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">💎 升级为 VIP（月费）</a>
    </div>
    <div class="row one">
      <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">← 返回命理商城</a>
    </div>
    <div class="muted">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
  </div>
</div>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<!-- 聊天浮窗 -->
<div class="ss-chat-fab" id="ssChatFab">问</div>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <span>5X · 智能助手</span>
    <span class="ss-close" id="ssChatClose">✕</span>
  </div>
  <div class="ss-chat-body" id="ssChatBody">
    <div class="ss-msg">您好！我是您的八字命理助手，有什么可以帮您的？</div>
  </div>
  <div class="ss-chat-input">
    <input type="text" id="ssChatInput" placeholder="请问您想了解什么？">
    <button class="btn" id="ssChatSend">发送</button>
  </div>
</div>

<script>
// 八字计算器类保持不变
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='？')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

// 工具函数
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function showAuthErr(message) {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function hideAuthErr() {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
}

function lock(el, v) { if(el) el.disabled = v; }

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// 渲染八字柱
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: '年柱', pillar: pillars.year },
    { title: '月柱', pillar: pillars.month },
    { title: '日柱', pillar: pillars.day },
    { title: '时柱', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === '时柱' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? '？' : pillar.stem}${isUnknown ? '？' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// 显示详细信息表格
function displayDetailedInfo(pillars, timeUnknown = false) {
  // 天干地支
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? '？' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? '？' : pillars.hour.branch);

  // 五行
  setText('year-element', baziCalculator.getElement(pillars.year.stem, pillars.year.branch));
  setText('month-element', baziCalculator.getElement(pillars.month.stem, pillars.month.branch));
  setText('day-element', baziCalculator.getElement(pillars.day.stem, pillars.day.branch));
  setText('hour-element', timeUnknown ? '未知' : baziCalculator.getElement(pillars.hour.stem, pillars.hour.branch));

  // 纳音
  setText('year-nayin', baziCalculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', baziCalculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', baziCalculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : baziCalculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// 分析日主强弱
function analyzeDayMasterStrength(pillars, counts) {
  const dayStem = pillars.day.stem;
  const dayElement = baziCalculator.getStemElement(dayStem);
  const monthBranch = pillars.month.branch;
  
  // 季节判断
  const seasonMap = {
    '寅':'春','卯':'春','辰':'春',
    '巳':'夏','午':'夏','未':'夏', 
    '申':'秋','酉':'秋','戌':'秋',
    '亥':'冬','子':'冬','丑':'冬'
  };
  
  const season = seasonMap[monthBranch] || '中';
  
  // 日主强弱判断
  let strengthScore = counts[dayElement] || 0;
  
  // 季节加成
  if ((season === '春' && dayElement === '木') ||
      (season === '夏' && dayElement === '火') ||
      (season === '秋' && dayElement === '金') ||
      (season === '冬' && dayElement === '水')) {
    strengthScore += 2;
  }
  
  let strength, pattern;
  if (strengthScore >= 4) {
    strength = '极旺';
    pattern = '建禄格';
  } else if (strengthScore >= 3) {
    strength = '偏旺'; 
    pattern = '身旺格';
  } else if (strengthScore >= 2) {
    strength = '中和';
    pattern = '中和格';
  } else {
    strength = '偏弱';
    pattern = '身弱格';
  }
  
  return { strength, pattern, season };
}

// 生成八字命盘
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('请填写出生日期');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // 显示加载状态
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);

    // 显示结果区域
    $('result').style.display = 'block';

    // 设置日期显示
    const timeText = tu ? '时间不详' : `${hour}时`;
    setText('bazi-date', `出生日期: ${year}年${month}月${day}日 ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">未纳入时柱</span>';
    }

    // 渲染八字柱和详细信息
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // 更新五行能量条
    setBar('bar-木', percents.wood); setText('pct-木', Math.round(percents.wood) + '%');
    setBar('bar-火', percents.fire); setText('pct-火', Math.round(percents.fire) + '%');
    setBar('bar-土', percents.earth); setText('pct-土', Math.round(percents.earth) + '%');
    setBar('bar-金', percents.metal); setText('pct-金', Math.round(percents.metal) + '%');
    setBar('bar-水', percents.water); setText('pct-水', Math.round(percents.water) + '%');

    // 五行平衡分析
    const elementEntries = Object.entries(counts);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `五行中${strongest}元素最强，${weakest}元素最弱。`);

    // 分析日主强弱
    const strengthAnalysis = analyzeDayMasterStrength(pillars, counts);

    // 生成详细分析
    generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, tu);

    // 生成AI解读
    generateAIInsight(pillars, percents, tu, strengthAnalysis);

    console.log('计算出的八字:', 
      pillars.year.stem + pillars.year.branch,
      pillars.month.stem + pillars.month.branch, 
      pillars.day.stem + pillars.day.branch,
      tu ? '？？' : (pillars.hour.stem + pillars.hour.branch)
    );

  } catch (error) {
    console.error('八字计算错误:', error);
    showError('计算八字时出现错误，请重试');
  } finally {
    // 恢复按钮状态
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// 生成详细分析
function generateDetailedAnalysis(pillars, counts, percents, strengthAnalysis, timeUnknown) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  // 基本信息
  const name = $('name').value || '未知';
  const gender = $('gender').value === 'male' ? '男' : ($('gender').value === 'female' ? '女' : '未透露');
  
  let basicInfo = `<p><strong>姓名：</strong>${name}</p>`;
  basicInfo += `<p><strong>性别：</strong>${gender}</p>`;
  basicInfo += `<p><strong>日主：</strong>${dayStem}${dayElement}（${strengthAnalysis.strength}）</p>`;
  basicInfo += `<p><strong>格局：</strong>${strengthAnalysis.pattern}</p>`;
  basicInfo += `<p><strong>季节：</strong>${strengthAnalysis.season}</p>`;
  
  $('basic-info').innerHTML = basicInfo;

  // 动态生成分析内容
  $('overall-destiny').innerHTML = generateOverallDestiny(pillars, counts, percents, strengthAnalysis);
  $('career-analysis').innerHTML = generateCareerAnalysis(pillars, counts, strengthAnalysis);
  $('wealth-analysis').innerHTML = generateWealthAnalysis(pillars, counts, percents, strengthAnalysis);
  $('marriage-analysis').innerHTML = generateMarriageAnalysis(pillars, gender, counts, strengthAnalysis);

  // 大运流年
  generateLuckAnalysis(pillars, gender);
}

// 生成大运流年分析 - 动态版本
function generateLuckAnalysis(pillars, gender, counts, percents) {
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const luckCycles = generateDynamicLuckCycles(pillars, gender, counts, percents);
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// 动态生成大运周期
function generateDynamicLuckCycles(pillars, gender, counts, percents) {
  const dayElement = pillars.day.element;
  const strength = analyzeDayMasterStrength(pillars, counts).strength;
  const strongestElement = getStrongestElement(counts);
  
  const cycles = [
    { age: '5-14岁', stage: 'childhood' },
    { age: '15-24岁', stage: 'youth' },
    { age: '25-34岁', stage: 'earlyCareer' },
    { age: '35-44岁', stage: 'midCareer' },
    { age: '45-54岁', stage: 'peak' },
    { age: '55-64岁', stage: 'retirement' }
  ];
  
  return cycles.map(cycle => ({
    age: cycle.age,
    desc: generateLuckDescription(cycle.stage, dayElement, strength, strongestElement, gender)
  }));
}

function generateLuckDescription(stage, dayElement, strength, strongestElement, gender) {
  const stageDescriptions = {
    childhood: {
      '木': '童年时期思维活跃，学习能力强，适合培养阅读和艺术兴趣',
      '火': '童年热情开朗，社交能力强，适合参与团体活动和运动',
      '土': '童年稳重踏实，专注力强，适合培养耐心和细致习惯',
      '金': '童年自律性强，目标明确，适合培养技能和才艺',
      '水': '童年想象力丰富，好奇心强，适合探索多样兴趣'
    },
    youth: {
      '木': '青少年时期领导力初显，适合担任学生干部，培养责任感',
      '火': '青少年创造力爆发，适合参与创新项目和竞赛活动',
      '土': '青少年学习扎实，适合深入专业领域，建立知识体系',
      '金': '青少年执行力强，适合参与实践项目，积累经验',
      '水': '青少年适应力强，适合多元发展，探索人生方向'
    },
    earlyCareer: {
      '木': '事业起步阶段，发挥领导才能，建立专业形象',
      '火': '职场热情投入，适合挑战性工作，快速成长',
      '土': '稳步发展时期，专注专业技能，积累行业经验',
      '金': '追求卓越阶段，适合技术岗位，建立专业权威',
      '水': '灵活适应时期，适合多变环境，寻找最佳定位'
    },
    midCareer: {
      '木': '事业上升期，承担更大责任，培养团队管理能力',
      '火': '创造力高峰期，适合创新项目，发挥影响力',
      '土': '稳定发展期，深耕专业领域，建立个人品牌',
      '金': '技术成熟期，适合专家角色，传授经验知识',
      '水': '转型关键期，适合跨界发展，开拓新领域'
    },
    peak: {
      '木': '人生黄金期，经验智慧丰富，适合战略决策角色',
      '火': '影响力高峰期，适合领导创新，推动变革',
      '土': '收获稳定期，享受成果，培养接班人',
      '金': '专业权威期，适合顾问指导，传承技艺',
      '水': '智慧成熟期，适合整合资源，创造新价值'
    },
    retirement: {
      '木': '晚年充实期，继续发挥余热，参与公益教育',
      '火': '晚年活跃期，保持社交，分享人生经验',
      '土': '晚年稳定期，享受家庭生活，注重健康养生',
      '金': '晚年精致期，追求生活品质，培养高雅爱好',
      '水': '晚年智慧期，反思人生，传承精神财富'
    }
  };
  
  const baseDesc = stageDescriptions[stage]?.[dayElement] || '此阶段运势平稳，适合稳步发展';
  const strengthAdvice = strength === '偏旺' || strength === '极旺' ? 
    '充分发挥自身优势，积极进取' : '注重积累，稳扎稳打';
  const elementAdvice = strongestElement !== dayElement ? 
    `同时加强${strongestElement}元素相关能力的培养` : '';
  
  return `${baseDesc}。${strengthAdvice}${elementAdvice}。心怜管家建议：${generateButlerAdvice(stage, dayElement, gender)}`;
}

function generateButlerAdvice(stage, dayElement, gender) {
  const adviceMap = {
    childhood: '培养良好习惯，建立正确价值观，每天坚持学习30分钟',
    youth: '勇于尝试，找到兴趣方向，每周记录成长心得',
    earlyCareer: '专注技能提升，建立人脉网络，每月参加专业培训',
    midCareer: '平衡工作生活，注重健康管理，每季度设定明确目标',
    peak: '分享经验智慧，培养接班人，关注身心健康',
    retirement: '培养兴趣爱好，规划财务，享受人生成果'
  };
  
  return adviceMap[stage] || '根据实际情况灵活调整发展策略';
}

// 详细事业分析 - 动态版本
function getCareerDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const careerFields = calculateCareerFields(dayElement, counts);
  const careerStrategy = generateCareerStrategy(dayElement, strengthAnalysis.strength, counts);
  const dailyAdvice = generateCareerDailyAdvice(dayElement, percents);
  
  return `
    <div class="detail-section">
      <h4>🎯 职业发展方向</h4>
      <p>基于您的${pillars.day.stem}${dayElement}日主和${strengthAnalysis.strength}格局，为您量身定制职业规划：</p>
      
      <p><strong>核心优势行业：</strong></p>
      <ul class="action-list">
        ${careerFields.map(field => `<li><strong>${field.category}：</strong>${field.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>📊 职业发展策略</h4>
      <p><strong>${careerStrategy.period}：</strong></p>
      <ul class="action-list">
        ${careerStrategy.strategies.map(strategy => `<li>${strategy}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>💫 个性化职业建议</h4>
      <ul class="action-list">
        ${dailyAdvice}
      </ul>
    </div>
  `;
}

function generateCareerStrategy(dayElement, strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  const isDiverse = elementCount >= 4;
  
  const strategies = {
    '木': {
      short: ['建立专业权威形象', '发展领导管理能力', '构建行业人脉网络'],
      long: ['向战略管理岗位发展', '培养团队领导力', '建立个人品牌影响力']
    },
    '火': {
      short: ['发挥创意创新能力', '参与前沿项目', '建立个人作品集'],
      long: ['向创意总监发展', '打造个人IP', '拓展跨界合作']
    },
    '土': {
      short: ['深耕专业技术', '建立系统知识', '获得专业认证'],
      long: ['成为领域专家', '建立培训体系', '开发专业产品']
    },
    '金': {
      short: ['提升技术专长', '参与重大项目', '建立质量标杆'],
      long: ['成为技术权威', '制定行业标准', '培养技术团队']
    },
    '水': {
      short: ['发展多元技能', '适应不同环境', '建立资源网络'],
      long: ['向综合管理发展', '整合多方资源', '开拓新业务领域']
    }
  };
  
  const strategySet = strategies[dayElement] || strategies['木'];
  const period = strength === '偏弱' ? '长期规划（5-8年）' : '中期规划（3-5年）';
  const baseStrategies = strength === '偏弱' ? strategySet.long : strategySet.short;
  
  const additional = isDiverse ? ['考虑跨界发展机会'] : ['专注核心优势领域'];
  
  return {
    period: period,
    strategies: [...baseStrategies, ...additional]
  };
}

function generateCareerDailyAdvice(dayElement, percents) {
  const adviceMap = {
    '木': [
      '每天早上规划重点工作优先级',
      '每周与行业专家交流学习',
      '每月阅读专业书籍提升认知',
      '每季度参加行业会议拓展视野'
    ],
    '火': [
      '每天保持创意记录习惯',
      '每周尝试新方法解决问题',
      '每月参与创新项目讨论',
      '每季度学习前沿技术趋势'
    ],
    '土': [
      '每天完善工作流程细节',
      '每周总结专业技能提升',
      '每月进行专业知识更新',
      '每季度评估职业发展进度'
    ],
    '金': [
      '每天专注核心技术钻研',
      '每周解决技术难题挑战',
      '每月学习新技术工具',
      '每季度进行技术成果展示'
    ],
    '水': [
      '每天关注行业动态变化',
      '每周拓展新的人脉关系',
      '每月学习跨领域知识',
      '每季度评估职业转型机会'
    ]
  };
  
  const adviceList = adviceMap[dayElement] || adviceMap['木'];
  return adviceList.map(advice => `<li>${advice}</li>`).join('');
}

// 详细财运分析 - 动态版本
function getWealthDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const wealthPattern = analyzeWealthPattern(dayElement, counts, percents);
  const investmentStrategy = generateDetailedInvestmentStrategy(dayElement, counts, percents);
  const wealthActionPlan = generateWealthActionPlan(strengthAnalysis.strength, percents);
  
  return `
    <div class="detail-section">
      <h4>💰 财富格局深度分析</h4>
      <p>您的${strengthAnalysis.strength}${pillars.day.stem}${dayElement}命局在财富方面呈现以下特征：</p>
      
      <p><strong>财运特质分析：</strong></p>
      <ul class="action-list">
        <li><strong>财富来源：</strong>${wealthPattern.sources}</li>
        <li><strong>积累模式：</strong>${wealthPattern.accumulation}</li>
        <li><strong>风险特征：</strong>${wealthPattern.risks}</li>
        <li><strong>增长时机：</strong>${wealthPattern.timing}</li>
      </ul>
    </div>

    <div class="detail-section">
      <h4>📈 个性化投资策略</h4>
      <p><strong>基于您的五行配置：</strong></p>
      <ul class="action-list">
        ${investmentStrategy.map(item => `<li><strong>${item.type}：</strong>${item.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>💫 财富增长执行计划</h4>
      <ul class="action-list">
        ${wealthActionPlan}
      </ul>
    </div>
  `;
}

function generateDetailedInvestmentStrategy(dayElement, counts, percents) {
  const weakestElement = getWeakestElement(counts);
  
  const strategies = {
    '木': [
      { type: '核心投资', description: '教育文化、环保健康、新兴科技领域' },
      { type: '辅助配置', description: '房地产信托、基础设施基金' },
      { type: '风险控制', description: '避免过度杠杆，注重长期价值' }
    ],
    '火': [
      { type: '核心投资', description: '科技创新、能源转型、数字媒体' },
      { type: '辅助配置', description: '贵金属、大宗商品' },
      { type: '风险控制', description: '控制投机比例，设置止损点' }
    ],
    '土': [
      { type: '核心投资', description: '房地产、建筑工程、农业食品' },
      { type: '辅助配置', description: '债券、稳定收益产品' },
      { type: '风险控制', description: '注重现金流，避免流动性风险' }
    ],
    '金': [
      { type: '核心投资', description: '金融科技、高端制造、精密技术' },
      { type: '辅助配置', description: '外汇、数字货币' },
      { type: '风险控制', description: '分散投资，避免技术风险' }
    ],
    '水': [
      { type: '核心投资', description: '物流贸易、旅游服务、咨询服务' },
      { type: '辅助配置', description: '海外资产、跨国企业' },
      { type: '风险控制', description: '关注汇率风险，保持灵活性' }
    ]
  };
  
  const baseStrategy = strategies[dayElement] || strategies['木'];
  
  // 根据最弱元素添加补充建议
  if (weakestElement && weakestElement !== dayElement) {
    const supplement = {
      '木': '适当配置成长型资产',
      '火': '增加一些进取型投资',
      '土': '加强稳定收益配置',
      '金': '注重价值投资机会',
      '水': '保持投资组合流动性'
    };
    baseStrategy.push({ type: '平衡建议', description: supplement[weakestElement] });
  }
  
  return baseStrategy;
}

function generateWealthActionPlan(strength, percents) {
  const elementCount = Object.values(percents).filter(p => p > 10).length;
  const isBalanced = elementCount >= 3;
  
  const basePlan = [
    '建立月度收支预算体系',
    '设定明确的财务目标',
    '定期进行投资组合评估'
  ];
  
  const strengthPlan = strength === '偏旺' || strength === '极旺' ? [
    '积极寻找投资机会',
    '适当承担计算过的风险',
    '建立多元收入来源'
  ] : [
    '注重储蓄积累',
    '选择稳健投资产品',
    '建立应急储备金'
  ];
  
  const balancePlan = isBalanced ? [
    '均衡配置各类资产',
    '关注整体投资回报'
  ] : [
    '重点加强优势领域投资',
    '适当补充弱势元素相关配置'
  ];
  
  return [...basePlan, ...strengthPlan, ...balancePlan]
    .map(item => `<li>${item}</li>`)
    .join('');
}

// 详细婚姻分析 - 动态版本
function getMarriageDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const gender = $('gender').value;
  const relationshipAnalysis = analyzeRelationshipDynamics(dayElement, gender, counts);
  const partnerCompatibility = generatePartnerCompatibility(dayElement, counts);
  const relationshipAdvice = generateRelationshipAdvice(dayElement, strengthAnalysis.strength, gender);
  
  return `
    <div class="detail-section">
      <h4>❤️ 感情婚姻深度解析</h4>
      <p>您的${pillars.day.stem}${dayElement}日主在感情方面呈现以下能量特征：</p>
      
      <p><strong>感情模式分析：</strong></p>
      <ul class="action-list">
        <li><strong>情感表达：</strong>${relationshipAnalysis.expression}</li>
        <li><strong>关系需求：</strong>${relationshipAnalysis.needs}</li>
        <li><strong>相处模式：</strong>${relationshipAnalysis.pattern}</li>
        <li><strong>发展时机：</strong>${relationshipAnalysis.timing}</li>
      </ul>
    </div>

    <div class="detail-section">
      <h4>💑 理想伴侣匹配指南</h4>
      <p><strong>基于您的命局特质：</strong></p>
      <ul class="action-list">
        ${partnerCompatibility.map(item => `<li><strong>${item.aspect}：</strong>${item.description}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>💫 感情幸福修行方案</h4>
      <ul class="action-list">
        ${relationshipAdvice}
      </ul>
    </div>
  `;
}

function analyzeRelationshipDynamics(dayElement, gender, counts) {
  const stemRelationship = {
    '甲': { expression: '直接坦率，重视承诺', needs: '需要尊重和认可', pattern: '主动引导型' },
    '乙': { expression: '温和细腻，注重细节', needs: '需要安全感和关怀', pattern: '协调配合型' },
    '丙': { expression: '热情主动，追求浪漫', needs: '需要激情和新鲜感', pattern: '激情投入型' },
    '丁': { expression: '专一执着，心思缜密', needs: '需要深度理解和信任', pattern: '专注守护型' },
    '戊': { expression: '稳重可靠，责任心强', needs: '需要稳定和归属感', pattern: '务实建设型' },
    '己': { expression: '包容体贴，善解人意', needs: '需要和谐和温暖', pattern: '服务支持型' },
    '庚': { expression: '坚毅果断，要求明确', needs: '需要空间和独立性', pattern: '理性主导型' },
    '辛': { expression: '追求完美，注重品质', needs: '需要精致和精神共鸣', pattern: '精致追求型' },
    '壬': { expression: '灵活多变，适应性强', needs: '需要自由和变化', pattern: '流动适应型' },
    '癸': { expression: '温和内敛，心思细腻', needs: '需要理解和耐心', pattern: '细腻感知型' }
  };
  
  const baseAnalysis = stemRelationship[dayElement] || stemRelationship['甲'];
  const genderAdjustment = gender === '男' ? '倾向于主动追求' : gender === '女' ? '倾向于谨慎选择' : '根据实际情况发展';
  
  return {
    expression: `${baseAnalysis.expression}，${genderAdjustment}`,
    needs: baseAnalysis.needs,
    pattern: baseAnalysis.pattern,
    timing: calculateRelationshipTiming(counts)
  };
}

function calculateRelationshipTiming(counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  if (elementCount <= 2) return '建议28岁后考虑婚姻，先完善自我';
  if (elementCount >= 4) return '25-30岁是理想婚恋时期';
  return '26-32岁感情发展较为顺利';
}

function generatePartnerCompatibility(dayElement, counts) {
  const weakestElement = getWeakestElement(counts);
  
  const compatibilityMap = {
    '木': [
      { aspect: '性格互补', description: '适合与稳重踏实的伴侣相处' },
      { aspect: '能力匹配', description: '需要执行力强的合作伙伴' },
      { aspect: '情感支持', description: '寻求温柔体贴的情感关怀' }
    ],
    '火': [
      { aspect: '性格互补', description: '适合与理性冷静的伴侣相处' },
      { aspect: '能力匹配', description: '需要细致周到的生活伙伴' },
      { aspect: '情感支持', description: '寻求稳定可靠的情感依托' }
    ],
    '土': [
      { aspect: '性格互补', description: '适合与灵活变通的伴侣相处' },
      { aspect: '能力匹配', description: '需要创意丰富的思维伙伴' },
      { aspect: '情感支持', description: '寻求激情浪漫的情感体验' }
    ],
    '金': [
      { aspect: '性格互补', description: '适合与温和包容的伴侣相处' },
      { aspect: '能力匹配', description: '需要感性直觉的情感伙伴' },
      { aspect: '情感支持', description: '寻求温暖体贴的情感关怀' }
    ],
    '水': [
      { aspect: '性格互补', description: '适合与坚定果断的伴侣相处' },
      { aspect: '能力匹配', description: '需要目标明确的行动伙伴' },
      { aspect: '情感支持', description: '寻求安全稳定的情感基础' }
    ]
  };
  
  const baseCompatibility = compatibilityMap[dayElement] || compatibilityMap['木'];
  
  // 根据最弱元素添加补充建议
  if (weakestElement && weakestElement !== dayElement) {
    const elementAdvice = {
      '木': '伴侣最好具备决断力和行动力',
      '火': '伴侣最好具备耐心和稳定性',
      '土': '伴侣最好具备灵活性和创意',
      '金': '伴侣最好具备包容心和温暖',
      '水': '伴侣最好具备目标感和坚定性'
    };
    baseCompatibility.push({ aspect: '五行平衡', description: elementAdvice[weakestElement] });
  }
  
  return baseCompatibility;
}

function generateRelationshipAdvice(dayElement, strength, gender) {
  const adviceMap = {
    '木': [
      '学习倾听伴侣的想法和感受',
      '在关系中保持适当的灵活性',
      '定期进行深度情感交流',
      '共同制定人生发展规划'
    ],
    '火': [
      '培养关系中的耐心和稳定性',
      '学习理性处理感情问题',
      '保持适度的个人空间',
      '建立共同的生活仪式感'
    ],
    '土': [
      '在关系中增加一些浪漫元素',
      '学习表达内心真实情感',
      '尝试新的相处方式',
      '培养共同的兴趣爱好'
    ],
    '金': [
      '学习表达温柔和关怀',
      '在关系中保持开放的心态',
      '注重情感细节的表达',
      '培养共同的精神追求'
    ],
    '水': [
      '在关系中保持适当的稳定性',
      '学习做出明确的承诺',
      '建立可靠的情感基础',
      '培养共同的生活目标'
    ]
  };
  
  const baseAdvice = adviceMap[dayElement] || adviceMap['木'];
  const strengthAdvice = strength === '偏旺' ? [
    '注意控制主导欲望，尊重伴侣选择',
    '学习平等协商，避免独断专行'
  ] : [
    '增强自信，主动表达需求',
    '建立明确的个人边界'
  ];
  
  return [...baseAdvice, ...strengthAdvice]
    .map(item => `<li>${item}</li>`)
    .join('');
}

// 详细流年分析 - 动态版本
function getLuckDetail(pillars, strengthAnalysis, counts, percents) {
  const dayElement = pillars.day.element;
  const luckForecast = generateLuckForecast(dayElement, counts, percents);
  const criticalTiming = identifyCriticalTiming(dayElement, strengthAnalysis.strength);
  const luckEnhancement = generateLuckEnhancementPlan(dayElement, counts);
  
  return `
    <div class="detail-section">
      <h4>📈 流年运势深度预测</h4>
      <p>基于您的${pillars.day.stem}${dayElement}命局能量配置，未来运势走向分析：</p>
      
      <p><strong>近期运势趋势（1-3年）：</strong></p>
      <ul class="action-list">
        ${luckForecast.map(item => `<li><strong>${item.area}：</strong>${item.trend}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>🎯 关键时机把握指南</h4>
      <p><strong>重要时间节点：</strong></p>
      <ul class="action-list">
        ${criticalTiming.map(item => `<li><strong>${item.period}：</strong>${item.opportunity}</li>`).join('')}
      </ul>
    </div>

    <div class="detail-section">
      <h4>💫 运势能量提升方案</h4>
      <ul class="action-list">
        ${luckEnhancement}
      </ul>
    </div>
  `;
}

function generateLuckForecast(dayElement, counts, percents) {
  const weakestElement = getWeakestElement(counts);
  
  const forecastMap = {
    '木': [
      { area: '事业发展', trend: '有新的领导机会出现，需要主动把握' },
      { area: '财富增长', trend: '正财稳定上升，偏财需要谨慎选择' },
      { area: '人际关系', trend: '贵人运增强，合作机会增多' },
      { area: '健康状态', trend: '需要注意工作生活平衡' }
    ],
    '火': [
      { area: '事业发展', trend: '创意项目机会增多，适合创新突破' },
      { area: '财富增长', trend: '投资机会出现，但需控制风险' },
      { area: '人际关系', trend: '社交活跃，影响力提升' },
      { area: '健康状态', trend: '注意情绪管理和心血管保健' }
    ],
    '土': [
      { area: '事业发展', trend: '稳定中有进步，适合深耕专业' },
      { area: '财富增长', trend: '积累效应显现，适合长期投资' },
      { area: '人际关系', trend: '建立可靠合作关系' },
      { area: '健康状态', trend: '注重消化系统保养' }
    ],
    '金': [
      { area: '事业发展', trend: '技术能力获得认可，专业地位提升' },
      { area: '财富增长', trend: '通过专业技能获得额外收入' },
      { area: '人际关系', trend: '建立专业人脉网络' },
      { area: '健康状态', trend: '注意呼吸系统和皮肤保养' }
    ],
    '水': [
      { area: '事业发展', trend: '转型机会出现，适合多元发展' },
      { area: '财富增长', trend: '流动求财机会增多' },
      { area: '人际关系', trend: '拓展新的人脉圈层' },
      { area: '健康状态', trend: '注意肾脏和泌尿系统' }
    ]
  };
  
  const baseForecast = forecastMap[dayElement] || forecastMap['木'];
  
  // 根据最弱元素调整预测
  if (weakestElement) {
    const adjustment = {
      '木': '需要加强决策力和行动力',
      '火': '需要保持热情和积极性',
      '土': '需要注重稳定和积累',
      '金': '需要提升专业和技术',
      '水': '需要增强适应和变通'
    };
    baseForecast.push({ area: '成长重点', trend: adjustment[weakestElement] });
  }
  
  return baseForecast;
}

function identifyCriticalTiming(dayElement, strength) {
  const baseTiming = [
    { period: '明年春季', opportunity: '事业上有重要发展机遇' },
    { period: '后年夏季', opportunity: '财运达到阶段性高峰' },
    { period: '三年后', opportunity: '人生进入新的发展阶段' }
  ];
  
  const elementTiming = {
    '木': { period: '每年3-5月', opportunity: '最适合启动新项目' },
    '火': { period: '每年6-8月', opportunity: '创意能量最旺盛' },
    '土': { period: '季节交替时期', opportunity: '适合调整和规划' },
    '金': { period: '每年9-11月', opportunity: '专业技能发挥最佳' },
    '水': { period: '冬季期间', opportunity: '适合反思和转型' }
  };
  
  const elementSpecific = elementTiming[dayElement];
  if (elementSpecific) {
    baseTiming.push(elementSpecific);
  }
  
  return baseTiming;
}

function generateLuckEnhancementPlan(dayElement, counts) {
  const weakestElement = getWeakestElement(counts);
  
  const enhancementMap = {
    '木': [
      '早晨面向东方进行能量冥想',
      '多接触自然环境和植物',
      '穿着绿色系衣物增强木能量',
      '培养决断力和领导能力'
    ],
    '火': [
      '中午面向南方吸收阳光能量',
      '参与社交和团体活动',
      '穿着红色系衣物增强火能量',
      '保持积极热情的心态'
    ],
    '土': [
      '在居中位置进行稳定冥想',
      '进行园艺和土地相关活动',
      '穿着黄色系衣物增强土能量',
      '培养耐心和责任感'
    ],
    '金': [
      '傍晚面向西方进行呼吸练习',
      '接触金属制品和精致物品',
      '穿着白色系衣物增强金能量',
      '提升专业技能和品质标准'
    ],
    '水': [
      '晚上面向北方进行静心冥想',
      '接触水源和水相关活动',
      '穿着黑色系衣物增强水能量',
      '培养灵活性和适应能力'
    ]
  };
  
  const basePlan = enhancementMap[dayElement] || enhancementMap['木'];
  
  // 根据最弱元素添加补充建议
  if (weakestElement && weakestElement !== dayElement) {
    const supplement = enhancementMap[weakestElement]?.slice(0, 2) || [];
    return [...basePlan, ...supplement].map(item => `<li>${item}</li>`).join('');
  }
  
  return basePlan.map(item => `<li>${item}</li>`).join('');
}

// 更新 showDetailAnalysis 函数调用
function showDetailAnalysis(type, pillars, strengthAnalysis) {
  // 隐藏主分析页面，但保留VIP区域
  const mainCards = document.querySelectorAll('.card:not(.detail-view):not(.vip-section)');
  mainCards.forEach(card => card.style.display = 'none');
  
  const detailView = $('detailView');
  detailView.style.display = 'block';
  
  // 设置详细分析内容
  const detailTitle = $('detailTitle');
  const detailContent = $('detailContent');
  
  // 获取当前八字数据
  const currentData = window.currentBaziData || { counts: {}, percents: {} };
  
  switch(type) {
    case 'career':
      detailTitle.textContent = '💼 详细事业分析';
      detailContent.innerHTML = getCareerDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'wealth':
      detailTitle.textContent = '💰 财运投资建议';
      detailContent.innerHTML = getWealthDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'marriage':
      detailTitle.textContent = '❤️ 婚姻感情解读';
      detailContent.innerHTML = getMarriageDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'health':
      detailTitle.textContent = '🌿 健康养生指导';
      detailContent.innerHTML = getHealthDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
    case 'luck':
      detailTitle.textContent = '📈 流年运势预测';
      detailContent.innerHTML = getLuckDetail(pillars, strengthAnalysis, currentData.counts, currentData.percents);
      break;
  }
}

// 更新 generateLuckAnalysis 调用
function generateLuckAnalysis(pillars, gender) {
  const currentData = window.currentBaziData || { counts: {}, percents: {} };
  const luckGrid = $('luck-analysis');
  luckGrid.innerHTML = '';
  
  const luckCycles = generateDynamicLuckCycles(pillars, gender, currentData.counts, currentData.percents);
  
  luckCycles.forEach(cycle => {
    const div = document.createElement('div');
    div.className = 'luck-item';
    div.innerHTML = `
      <div class="luck-year">${cycle.age}</div>
      <div class="luck-desc">${cycle.desc}</div>
    `;
    luckGrid.appendChild(div);
  });
}

// 初始化聊天功能
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');
  
  if (!chatFab || !chatPanel) return;
  
  chatFab.addEventListener('click', () => {
    chatPanel.style.display = 'block';
  });
  
  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });
  
  function addMessage(text, isUser = false) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    msgDiv.textContent = text;
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
  
  chatSend.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (!text) return;
    
    addMessage(text, true);
    chatInput.value = '';
    
    // 模拟AI回复
    setTimeout(() => {
      const replies = [
        '这是一个很好的问题，让我为您详细分析...',
        '根据您的八字特点，我建议...',
        '这个问题需要结合您的具体命局来看...',
        '从五行角度来看，您的命局显示...'
      ];
      addMessage(replies[Math.floor(Math.random() * replies.length)]);
    }, 1000);
  });
  
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      chatSend.click();
    }
  });
}

// 初始化时间未知功能
function initTimeUnknown() {
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }
}

// 多语言翻译系统
const translations = {
  'zh-CN': {
    title: '5xLiving · 八字简评',
    quickBazi: '八字命理 · 快速排盘',
    namePlaceholder: '你的称呼（用于个性化）',
    gender: '性别',
    genderOptions: ['不透露', '男性', '女性'],
    calendar: '历法',
    calendarOptions: ['阳历', '农历'],
    birthDate: '出生日期',
    birthTime: '出生时间',
    timeUnknown: '出生时间不详',
    generateBazi: '生成八字',
    calculating: '计算中...',
    yourBazi: '您的生辰八字命盘',
    birthDateText: '出生日期',
    elementsAnalysis: '五行能量分析',
    basicInfo: '🧙‍♂️ 命主基本信息',
    overallDestiny: '🔍 总体命运解读',
    careerAnalysis: '💼 事业分析',
    wealthAnalysis: '💰 财富状况',
    marriageAnalysis: '❤️ 婚姻感情',
    luckAnalysis: '📈 大运流年分析',
    aiButler: '心怜管家 · 深度解读',
    vipSection: '🌙 会员区域 VIP Segment',
    vipContent1: '🗝 命理空间专属内容',
    vipContent2: '🌙 心怜空间专属内容',
    loginTitle: '账户登录 / 注册',
    emailPlaceholder: '邮箱 Email',
    passwordPlaceholder: '密码 Password（至少8位，含大小写数字符号）',
    loginBtn: '登入账户',
    resetPassword: '🔑 重设密码',
    registerBtn: '注册账户',
    registerTip: '注册账号赠送一次免费体验',
    vipService: '会员服务',
    upgradeVip: '💎 升级为 VIP（月费）',
    backToShop: '← 返回命理商城',
    vipPrice: '$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）',
    chatTitle: '5X · 智能助手',
    chatPlaceholder: '请问您想了解什么？',
    send: '发送'
  },
  'zh-TW': {
    title: '5xLiving · 八字簡評',
    quickBazi: '八字命理 · 快速排盤',
    namePlaceholder: '你的稱呼（用於個性化）',
    gender: '性別',
    genderOptions: ['不透露', '男性', '女性'],
    calendar: '曆法',
    calendarOptions: ['陽曆', '農曆'],
    birthDate: '出生日期',
    birthTime: '出生時間',
    timeUnknown: '出生時間不詳',
    generateBazi: '生成八字',
    calculating: '計算中...',
    yourBazi: '您的生辰八字命盤',
    birthDateText: '出生日期',
    elementsAnalysis: '五行能量分析',
    basicInfo: '🧙‍♂️ 命主基本信息',
    overallDestiny: '🔍 總體命運解讀',
    careerAnalysis: '💼 事業分析',
    wealthAnalysis: '💰 財富狀況',
    marriageAnalysis: '❤️ 婚姻感情',
    luckAnalysis: '📈 大運流年分析',
    aiButler: '心憐管家 · 深度解讀',
    vipSection: '🌙 會員區域 VIP Segment',
    vipContent1: '🗝 命理空間專屬內容',
    vipContent2: '🌙 心憐空間專屬內容',
    loginTitle: '賬戶登錄 / 註冊',
    emailPlaceholder: '郵箱 Email',
    passwordPlaceholder: '密碼 Password（至少8位，含大小寫數字符號）',
    loginBtn: '登入賬戶',
    resetPassword: '🔑 重設密碼',
    registerBtn: '註冊賬戶',
    registerTip: '註冊賬號贈送一次免費體驗',
    vipService: '會員服務',
    upgradeVip: '💎 升級為 VIP（月費）',
    backToShop: '← 返回命理商城',
    vipPrice: '$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）',
    chatTitle: '5X · 智能助手',
    chatPlaceholder: '請問您想了解什麼？',
    send: '發送'
  },
  'en': {
    title: '5xLiving · Bazi Analysis',
    quickBazi: 'Bazi Fortune · Quick Chart',
    namePlaceholder: 'Your name (for personalization)',
    gender: 'Gender',
    genderOptions: ['Not specified', 'Male', 'Female'],
    calendar: 'Calendar',
    calendarOptions: ['Gregorian', 'Lunar'],
    birthDate: 'Birth Date',
    birthTime: 'Birth Time',
    timeUnknown: 'Time unknown',
    generateBazi: 'Generate Bazi',
    calculating: 'Calculating...',
    yourBazi: 'Your Bazi Birth Chart',
    birthDateText: 'Birth Date',
    elementsAnalysis: 'Five Elements Analysis',
    basicInfo: '🧙‍♂️ Basic Information',
    overallDestiny: '🔍 Overall Destiny',
    careerAnalysis: '💼 Career Analysis',
    wealthAnalysis: '💰 Wealth Status',
    marriageAnalysis: '❤️ Marriage & Relationships',
    luckAnalysis: '📈 Luck Cycle Analysis',
    aiButler: 'AI Butler · Deep Insights',
    vipSection: '🌙 VIP Member Area',
    vipContent1: '🗝 Destiny Space Exclusive',
    vipContent2: '🌙 Spiritual Space Exclusive',
    loginTitle: 'Login / Register',
    emailPlaceholder: 'Email Address',
    passwordPlaceholder: 'Password (min 8 chars, upper/lower/digit/symbol)',
    loginBtn: 'Login',
    resetPassword: '🔑 Reset Password',
    registerBtn: 'Register Account',
    registerTip: 'Free trial with registration',
    vipService: 'VIP Services',
    upgradeVip: '💎 Upgrade to VIP (Monthly)',
    backToShop: '← Back to Shop',
    vipPrice: '$9.9 / Month VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X · AI Assistant',
    chatPlaceholder: 'What would you like to know?',
    send: 'Send'
  },
  'ja': {
    title: '5xLiving · 八字診断',
    quickBazi: '八字命理 · 簡易計算',
    namePlaceholder: 'お名前（個人用）',
    gender: '性別',
    genderOptions: ['未回答', '男性', '女性'],
    calendar: '暦法',
    calendarOptions: ['グレゴリオ暦', '旧暦'],
    birthDate: '生年月日',
    birthTime: '出生時間',
    timeUnknown: '出生時間不明',
    generateBazi: '八字を計算',
    calculating: '計算中...',
    yourBazi: 'あなたの八字命盤',
    birthDateText: '生年月日',
    elementsAnalysis: '五行エネルギー分析',
    basicInfo: '🧙‍♂️ 基本情報',
    overallDestiny: '🔍 総合運勢',
    careerAnalysis: '💼 事業運',
    wealthAnalysis: '💰 財運',
    marriageAnalysis: '❤️ 恋愛・結婚運',
    luckAnalysis: '📈 大運分析',
    aiButler: 'AI管家 · 詳細診断',
    vipSection: '🌙 VIP会員エリア',
    vipContent1: '🗝 命理スペース限定',
    vipContent2: '🌙 スピリチュアルスペース限定',
    loginTitle: 'ログイン / 登録',
    emailPlaceholder: 'メールアドレス',
    passwordPlaceholder: 'パスワード（8文字以上、大文字・小文字・数字・記号）',
    loginBtn: 'ログイン',
    resetPassword: '🔑 パスワード再設定',
    registerBtn: 'アカウント登録',
    registerTip: '登録で無料体験',
    vipService: 'VIPサービス',
    upgradeVip: '💎 VIPアップグレード（月額）',
    backToShop: '← ショップに戻る',
    vipPrice: '$9.9 / 月額VIP（命理+スピリチュアル+講座）',
    chatTitle: '5X · AIアシスタント',
    chatPlaceholder: '何かお聞きしたいことは？',
    send: '送信'
  },
  'th': {
    title: '5xLiving · วิเคราะห์ปาจื้อ',
    quickBazi: 'ปาจื้อ · คำนวณด่วน',
    namePlaceholder: 'ชื่อของคุณ (สำหรับ personalize)',
    gender: 'เพศ',
    genderOptions: ['ไม่ระบุ', 'ชาย', 'หญิง'],
    calendar: 'ปฏิทิน',
    calendarOptions: ['สากล', 'จันทรคติ'],
    birthDate: 'วันเกิด',
    birthTime: 'เวลาเกิด',
    timeUnknown: 'ไม่ทราบเวลาเกิด',
    generateBazi: 'คำนวณปาจื้อ',
    calculating: 'กำลังคำนวณ...',
    yourBazi: 'แผนภูมิปาจื้อของคุณ',
    birthDateText: 'วันเกิด',
    elementsAnalysis: 'วิเคราะห์ธาตุทั้งห้า',
    basicInfo: '🧙‍♂️ ข้อมูลพื้นฐาน',
    overallDestiny: '🔍 โชคชะตารวม',
    careerAnalysis: '💼 วิเคราะห์หน้าที่การงาน',
    wealthAnalysis: '💰 สถานะการเงิน',
    marriageAnalysis: '❤️ ความรักและการแต่งงาน',
    luckAnalysis: '📈 วิเคราะห์ช่วงวัย',
    aiButler: 'ผู้ช่วย AI · วิเคราะห์ลึก',
    vipSection: '🌙 พื้นที่สมาชิก VIP',
    vipContent1: '🗝 เนื้อหาเฉพาะ Destiny Space',
    vipContent2: '🌙 เนื้อหาเฉพาะ Spiritual Space',
    loginTitle: 'เข้าสู่ระบบ / สมัครสมาชิก',
    emailPlaceholder: 'อีเมล',
    passwordPlaceholder: 'รหัสผ่าน (อย่างน้อย 8 ตัว, ใหญ่/เล็ก/ตัวเลข/สัญลักษณ์)',
    loginBtn: 'เข้าสู่ระบบ',
    resetPassword: '🔑 รีเซ็ตรหัสผ่าน',
    registerBtn: 'สมัครสมาชิก',
    registerTip: 'ทดลองใช้ฟรีเมื่อสมัคร',
    vipService: 'บริการ VIP',
    upgradeVip: '💎 อัปเกรดเป็น VIP (รายเดือน)',
    backToShop: '← กลับไปร้านค้า',
    vipPrice: '$9.9 / เดือน VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X · ผู้ช่วย AI',
    chatPlaceholder: 'มีอะไรให้ช่วยไหมคะ?',
    send: 'ส่ง'
  },
  'ms': {
    title: '5xLiving · Analisis Bazi',
    quickBazi: 'Bazi · Carta Pantas',
    namePlaceholder: 'Nama anda (untuk personalisasi)',
    gender: 'Jantina',
    genderOptions: ['Tidak dinyatakan', 'Lelaki', 'Perempuan'],
    calendar: 'Kalendar',
    calendarOptions: ['Gregorian', 'Qamari'],
    birthDate: 'Tarikh Lahir',
    birthTime: 'Masa Lahir',
    timeUnknown: 'Masa lahir tidak diketahui',
    generateBazi: 'Hasilkan Bazi',
    calculating: 'Mengira...',
    yourBazi: 'Carta Kelahiran Bazi Anda',
    birthDateText: 'Tarikh Lahir',
    elementsAnalysis: 'Analisis Lima Unsur',
    basicInfo: '🧙‍♂️ Maklumat Asas',
    overallDestiny: '🔍 Takdir Keseluruhan',
    careerAnalysis: '💼 Analisis Kerjaya',
    wealthAnalysis: '💰 Status Kekayaan',
    marriageAnalysis: '❤️ Perkahwinan & Hubungan',
    luckAnalysis: '📈 Analisis Kitaran Nasib',
    aiButler: 'Pembantu AI · Analisis Mendalam',
    vipSection: '🌙 Kawasan Ahli VIP',
    vipContent1: '🗝 Eksklusif Ruang Takdir',
    vipContent2: '🌙 Eksklusif Ruang Spiritual',
    loginTitle: 'Log Masuk / Daftar',
    emailPlaceholder: 'Emel',
    passwordPlaceholder: 'Kata Laluan (min 8 aksara, besar/kecil/nombor/simbol)',
    loginBtn: 'Log Masuk',
    resetPassword: '🔑 Set Semula Kata Laluan',
    registerBtn: 'Daftar Akaun',
    registerTip: 'Percubaan percuma dengan pendaftaran',
    vipService: 'Perkhidmatan VIP',
    upgradeVip: '💎 Naik Taraf ke VIP (Bulanan)',
    backToShop: '← Kembali ke Kedai',
    vipPrice: '$9.9 / Bulan VIP (Destiny + Spiritual + Courses)',
    chatTitle: '5X · Pembantu AI',
    chatPlaceholder: 'Apa yang anda ingin tahu?',
    send: 'Hantar'
  }
};

// 翻译函数
function translatePage(lang) {
  const t = translations[lang] || translations['zh-CN'];
  
  // 更新页面文本
  document.querySelector('.title').textContent = t.title;
  document.querySelector('.h2').textContent = t.quickBazi;
  document.getElementById('name').placeholder = t.namePlaceholder;
  document.querySelector('label[for="gender"]').textContent = t.gender;
  document.querySelector('label[for="calendar"]').textContent = t.calendar;
  document.querySelector('label[for="birthdate"]').textContent = t.birthDate;
  document.querySelector('label[for="birthtime"]').textContent = t.birthTime;
  document.querySelector('.time-unknown span').textContent = t.timeUnknown;
  document.getElementById('genBtnText').textContent = t.generateBazi;
  
  // 更新下拉选项
  const genderSelect = document.getElementById('gender');
  genderSelect.options[0].text = t.genderOptions[0];
  genderSelect.options[1].text = t.genderOptions[1];
  genderSelect.options[2].text = t.genderOptions[2];
  
  const calendarSelect = document.getElementById('calendar');
  calendarSelect.options[0].text = t.calendarOptions[0];
  calendarSelect.options[1].text = t.calendarOptions[1];
  
  // 保存语言选择
  localStorage.setItem('preferredLanguage', lang);
}

// VIP登录系统
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){
    return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') };
  }finally{
    clearTimeout(timer);
  }
}

function strongPwd(pw){ 
  return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); 
}

// 注册功能
$('registerForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('请输入邮箱与密码');
  if(!strongPwd(password)) return showAuthErr('密码至少8位，需包含大写/小写/数字/特殊符号');
  lock($('registerBtn'),true);
  try{
    const res=await fetchJSON('/api/register',{email,password});
    if(res.ok===true){ 
      localStorage.setItem('vipEmail',email); 
      showAuthErr('注册成功！请登录。');
      return; 
    }
    if((res.msg||"").toString().toLowerCase()==='exists'){ 
      await loginFlow(email,password); 
      return; 
    }
    return showAuthErr('注册失败：' + (res.msg||''));
  }catch(err){ showAuthErr('注册失败：' + (err?.message||'')); }
  finally{ lock($('registerBtn'),false); }
});

// 登录功能
async function loginFlow(email,password){
  const res = await fetchJSON('/api/login', { email, password });
  const msg=(res.msg||"").toString().toLowerCase();
  let expired=false;
  if(res.expired===true) expired=true;
  else if(msg==='expired') expired=true;
  else if(res.expiresAt){
    const ts=Date.parse(res.expiresAt);
    if(!Number.isNaN(ts)&&ts<Date.now()) expired=true;
  }

  if(expired){
    const go=confirm('会员已过期。是否前往续费？');
    if(go){
      const a=document.createElement('a');
      a.href='https://yourshopifyshop.com/products/monthly-vip';
      a.target='_blank'; a.rel='noopener noreferrer';
      document.body.appendChild(a); a.click(); a.remove();
    }
    return;
  }

  if(res.ok===true){
    localStorage.setItem('vipEmail',res.email||email);
    localStorage.setItem('vipStatus', 'active');
    showAuthErr('登录成功！欢迎回来。');
    return;
  }

  if(msg==='no_account') return showAuthErr('账户不存在，请先注册');
  if(msg==='wrong_pwd') return showAuthErr('密码错误');
  const extra = res.msg ? ` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}` : '';
  return showAuthErr('登入失败：' + extra);
}

$('loginForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); 
  hideAuthErr();
  const email=$('email')?.value.trim(); 
  const password=$('password')?.value.trim();
  if(!email||!password) return showAuthErr('请输入邮箱与密码');
  lock($('loginBtn'),true);
  try{ await loginFlow(email,password); }
  catch(err){ showAuthErr('登入失败：' + (err?.message||'')); }
  finally{ lock($('loginBtn'),false); }
});

// 重置密码功能
$('resetBtn')?.addEventListener('click', async ()=>{
  hideAuthErr();
  let email=prompt('请输入注册邮箱：'); 
  if(email===null) return; 
  email=email.trim(); 
  if(!email) return showAuthErr('邮箱不能为空');
  let newPassword=prompt('请输入新密码（至少8位，含大小写、数字、符号）：'); 
  if(newPassword===null) return; 
  newPassword=newPassword.trim(); 
  if(!newPassword) return showAuthErr('密码不能为空');
  if(!strongPwd(newPassword)) return showAuthErr('密码至少8位，需包含大写/小写/数字/特殊符号');
  lock($('resetBtn'),true);
  try{
    const res=await fetchJSON('/api/reset',{email,newPassword});
    if(!res.ok){ const extra=res.msg?` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}`:''; return showAuthErr('重设失败：' + extra); }
    alert('密码已成功更新，请用新密码重新登入。');
  }catch(err){ showAuthErr('重设失败：' + (err?.message||'')); }
  finally{ lock($('resetBtn'),false); }
});

// 总体命运解读
function generateOverallDestiny(pillars, counts, percents, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  const strongestElement = getStrongestElement(counts);
  const weakestElement = getWeakestElement(counts);
  
  const personality = calculatePersonality(dayStem, counts);
  const seasonEffect = calculateSeasonEffect(strengthAnalysis.season, dayElement);
  const strengthEffect = calculateStrengthEffect(strengthAnalysis.strength);
  const elementAnalysis = analyzeElementDistribution(percents);
  
  return `
    <p>${personality} ${seasonEffect}</p>
    <p>${strengthEffect} ${elementAnalysis}</p>
    <p>${getElementInteractionAdvice(strongestElement, weakestElement)}</p>
  `;
}

// 事业分析
function generateCareerAnalysis(pillars, counts, strengthAnalysis) {
  const dayElement = pillars.day.element;
  const suitableFields = calculateCareerFields(dayElement, counts);
  const careerPotential = analyzeCareerPotential(strengthAnalysis.strength, counts);
  const developmentAdvice = getCareerDevelopmentAdvice(dayElement, strengthAnalysis.strength);
  
  return `
    <p>${suitableFields}</p>
    <p>${careerPotential}</p>
    <p>${developmentAdvice}</p>
  `;
}

// 财富分析
function generateWealthAnalysis(pillars, counts, percents, strengthAnalysis) {
  const wealthCapacity = analyzeWealthCapacity(strengthAnalysis.strength, counts);
  const wealthSources = identifyWealthSources(pillars.day.element, counts);
  const investmentStrategy = generateInvestmentStrategy(percents, counts);
  
  return `
    <p>${wealthCapacity}</p>
    <p>${wealthSources}</p>
    <p>${investmentStrategy}</p>
  `;
}

// 婚姻分析
function generateMarriageAnalysis(pillars, gender, counts, strengthAnalysis) {
  const relationshipPattern = analyzeRelationshipPattern(pillars.day.element, gender, counts);
  const marriageTiming = calculateMarriageTiming(strengthAnalysis.strength, counts);
  const partnerCompatibility = analyzePartnerCompatibility(pillars.day.element, counts);
  
  return `
    <p>${relationshipPattern}</p>
    <p>${marriageTiming}</p>
    <p>${partnerCompatibility}</p>
  `;
}

// AI深度解读
function generateDynamicAIInsight(pillars, percents, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const dayElement = pillars.day.element;
  
  const elementAnalysis = generateElementAnalysis(percents);
  const patternInsight = generatePatternInsight(strengthAnalysis.pattern, dayElement, percents);
  const dailyPractices = generateDailyPractices(dayElement, percents);
  
  return `
    <div class="detail-section">
      <h4>🌟 命局深度解析</h4>
      <p>基于您的${dayStem}${dayElement}日主和${strengthAnalysis.strength}格局，为您提供以下深度分析：</p>
      
      <p><strong>五行能量精密分析：</strong></p>
      ${elementAnalysis}
      
      <p><strong>格局特质深度解读：</strong></p>
      <p>${patternInsight}</p>
      
      <p><strong>个性化修行建议：</strong></p>
      ${dailyPractices}
    </div>
  `;
}

// ==================== 核心计算函数 ====================

function calculatePersonality(dayStem, counts) {
  const stemTraits = {
    '甲': '具有领导气质，行事果断',
    '乙': '性格温和，适应力强',
    '丙': '热情开朗，充满活力',
    '丁': '思维细腻，专注力强',
    '戊': '稳重可靠，责任感强',
    '己': '包容性强，善于协调',
    '庚': '坚毅果断，执行力强',
    '辛': '追求完美，注重细节',
    '壬': '智慧灵活，适应性强',
    '癸': '温和内敛，心思缜密'
  };
  
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  const diversity = elementCount >= 4 ? '性格较为全面' : elementCount <= 2 ? '性格特点鲜明' : '性格平衡稳定';
  
  return `命主${dayStem}日，${stemTraits[dayStem]}，${diversity}。`;
}

function calculateSeasonEffect(season, dayElement) {
  const seasonElements = {
    '春': '木', '夏': '火', '秋': '金', '冬': '水'
  };
  
  const seasonElement = seasonElements[season];
  if (seasonElement === dayElement) {
    return `生于${season}季得令，能量充沛，发展顺利。`;
  } else if (isElementSupportive(seasonElement, dayElement)) {
    return `生于${season}季得生，获得外在支持。`;
  } else if (isElementControlling(seasonElement, dayElement)) {
    return `生于${season}季不得令，需要更多努力。`;
  } else {
    return `生于${season}季，运势平稳。`;
  }
}

function calculateStrengthEffect(strength) {
  const effects = {
    '极旺': '具有强大的行动力和决策能力，但需注意控制脾气',
    '偏旺': '执行力强，适合积极进取，但要注意团队合作',
    '中和': '适应力强，能够在各种环境中稳步发展',
    '偏弱': '善于合作，需要借助团队力量，注重积累'
  };
  return effects[strength] || '命局平衡，发展稳定。';
}

function analyzeElementDistribution(percents) {
  const elements = ['木', '火', '土', '金', '水'];
  const strongElements = elements.filter(e => percents[e] > 20);
  const weakElements = elements.filter(e => percents[e] < 10);
  
  let analysis = '';
  if (strongElements.length > 0) {
    analysis += `${strongElements.join('、')}元素旺盛，`;
  }
  if (weakElements.length > 0) {
    analysis += `${weakElements.join('、')}元素偏弱，`;
  }
  
  analysis += '需要相应调整以达平衡。';
  return analysis;
}

function calculateCareerFields(dayElement, counts) {
  const baseFields = {
    '木': ['教育文化', '创意设计', '环保健康', '医疗养生'],
    '火': ['科技创新', '能源电力', '娱乐传媒', '餐饮服务'],
    '土': ['房地产', '建筑工程', '金融投资', '农业食品'],
    '金': ['法律咨询', '机械制造', '金融证券', '技术研发'],
    '水': ['贸易物流', '旅游服务', '咨询顾问', '媒体传播']
  };
  
  const strongestElement = getStrongestElement(counts);
  let fields = baseFields[dayElement] || ['多元化领域'];
  
  // 如果最强元素与日主不同，补充相关领域
  if (strongestElement !== dayElement && baseFields[strongestElement]) {
    fields = [...new Set([...fields, ...baseFields[strongestElement]])];
  }
  
  return `适合从事${fields.slice(0, 4).join('、')}等相关领域`;
}

function analyzeCareerPotential(strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  
  let potential = '';
  if (strength === '极旺' || strength === '偏旺') {
    potential = '具有领导潜力，适合自主创业或管理职位';
  } else {
    potential = '适合专业发展，在稳定环境中发挥专长';
  }
  
  if (elementCount >= 4) {
    potential += '，可考虑多元化发展';
  } else if (elementCount <= 2) {
    potential += '，建议专注核心优势领域';
  }
  
  return potential + '。';
}

function getCareerDevelopmentAdvice(dayElement, strength) {
  const timing = strength === '偏弱' ? '注重前期积累，中年后发力' : '可早期规划，稳步推进';
  const approach = strength === '极旺' ? '但要学会授权，避免事必躬亲' : '注重团队协作，发挥集体智慧';
  
  return `发展策略：${timing}。${approach}。`;
}

function analyzeWealthCapacity(strength, counts) {
  const wealthElements = Object.values(counts).reduce((a, b) => a + b, 0);
  const capacityScore = strength === '极旺' ? 9 : strength === '偏旺' ? 7 : strength === '中和' ? 6 : 4;
  
  if (capacityScore >= 8) return '财运潜力巨大，正偏财皆有机会';
  if (capacityScore >= 6) return '财运良好，正财稳定，偏财需把握';
  if (capacityScore >= 4) return '财运平稳，适合稳定收入来源';
  return '财运需要努力开拓，注重积累';
}

function identifyWealthSources(dayElement, counts) {
  const wealthMap = {
    '木': counts['土'], // 木克土为财
    '火': counts['金'], // 火克金为财
    '土': counts['水'], // 土克水为财
    '金': counts['木'], // 金克木为财
    '水': counts['火']  // 水克火为财
  };
  
  const wealthCount = wealthMap[dayElement] || 0;
  
  if (wealthCount >= 2) return '多元财源，投资理财机会较多';
  if (wealthCount >= 1) return '稳定财源为主，适当拓展副业';
  return '以正职收入为主，注重专业技能提升';
}

function generateInvestmentStrategy(percents, counts) {
  const weakest = getWeakestElement(counts);
  const strategies = {
    '木': '可关注教育、环保、健康产业投资',
    '火': '适合科技、能源、创新领域投资',
    '土': '房地产、基建类投资较为有利',
    '金': '金融、贵金属、技术投资机会多',
    '水': '物流、贸易、服务行业值得关注'
  };
  
  return `投资建议：${strategies[weakest] || '多元化资产配置，分散风险'}。`;
}

function analyzeRelationshipPattern(dayElement, gender, counts) {
  let pattern = '';
  
  if (gender === '男') {
    const wealthCount = counts[getWealthElement(dayElement)] || 0;
    pattern = wealthCount >= 2 ? '感情运势顺畅，容易遇到理想伴侣' : 
              wealthCount >= 1 ? '感情需要主动经营，真诚相待' : '感情需要耐心等待，注重内在修养';
  } else {
    const officerCount = counts[getOfficerElement(dayElement)] || 0;
    pattern = officerCount >= 2 ? '感情自主，适合寻找能力相当的伴侣' : 
              officerCount >= 1 ? '感情稳定，需要互相理解支持' : '感情需要更多包容，晚婚较佳';
  }
  
  return pattern;
}

function calculateMarriageTiming(strength, counts) {
  const elementCount = Object.values(counts).filter(c => c > 0).length;
  let timing = '';
  
  if (strength === '极旺') timing = '28岁后';
  else if (strength === '偏旺') timing = '25-30岁';
  else if (strength === '中和') timing = '24-28岁';
  else timing = '26岁后';
  
  return `婚姻时机：${timing}较为理想${elementCount <= 2 ? '，建议多了解再决定' : ''}。`;
}

function analyzePartnerCompatibility(dayElement, counts) {
  const compatibleElements = {
    '木': ['土', '金'], // 木需要土培、金修
    '火': ['水', '金'], // 火需要水济、金财
    '土': ['木', '水'], // 土需要木疏、水润
    '金': ['火', '木'], // 金需要火炼、木财
    '水': ['土', '火']  // 水需要土堤、火暖
  };
  
  const elements = compatibleElements[dayElement] || ['土', '金'];
  return `理想伴侣：与${elements.join('、')}元素较强的人互补性佳。`;
}

function generateElementAnalysis(percents) {
  let analysis = '';
  const elements = [
    { name: '木', value: percents.wood },
    { name: '火', value: percents.fire },
    { name: '土', value: percents.earth },
    { name: '金', value: percents.metal },
    { name: '水', value: percents.water }
  ];
  
  elements.forEach(elem => {
    let desc = '';
    if (elem.value > 25) desc = '能量充沛，优势明显';
    else if (elem.value > 15) desc = '能量适中，发展平稳';
    else if (elem.value > 5) desc = '能量偏弱，需要加强';
    else desc = '能量不足，重点补充';
    
    analysis += `<p>• ${elem.name}元素：${Math.round(elem.value)}% - ${desc}</p>`;
  });
  
  return analysis;
}

function generatePatternInsight(pattern, dayElement, percents) {
  const insights = {
    '建禄格': `自立自强，${dayElement === '金' ? '技术领导力强' : dayElement === '木' ? '教育文化领域有优势' : '适合创业发展'}`,
    '身旺格': `精力充沛，${percents[dayElement] > 25 ? '优势明显但需注意平衡' : '执行力强适合进取'}`,
    '身弱格': `善于合作，${getWeakestElementFromPercents(percents) === dayElement ? '需要重点加强自身能量' : '借助外力可获成功'}`,
    '中和格': `平衡稳定，${Object.values(percents).filter(p => p > 15).length >= 3 ? '全面发展机会多' : '专注优势领域'}`
  };
  
  return insights[pattern] || '需要结合具体命局深入分析';
}

function generateDailyPractices(dayElement, percents) {
  const practices = {
    '木': {
      morning: '清晨公园散步，呼吸新鲜空气',
      work: '工作中多沟通协作，培养团队精神',
      health: '多吃绿色蔬菜，保护肝胆健康',
      evening: '阅读励志书籍，规划明日目标'
    },
    '火': {
      morning: '晨间有氧运动，激活身体能量',
      work: '保持工作热情，主动迎接挑战',
      health: '注意心脏保健，避免过度劳累',
      evening: '与朋友交流，分享每日收获'
    },
    '土': {
      morning: '清晨冥想，稳定心绪',
      work: '注重工作细节，建立系统流程',
      health: '规律饮食，注意脾胃保养',
      evening: '整理家居环境，创造舒适空间'
    },
    '金': {
      morning: '制定详细计划，明确目标',
      work: '追求专业卓越，提升技能',
      health: '注意呼吸系统，多喝温水',
      evening: '学习新知识，提升自我'
    },
    '水': {
      morning: '清晨温水，启动身体代谢',
      work: '灵活应变，善于抓住机会',
      health: '注意肾脏保健，适当补水',
      evening: '反思总结，积累智慧'
    }
  };
  
  const practice = practices[dayElement] || practices['木'];
  return `
    <ul class="action-list">
      <li>早晨：${practice.morning}</li>
      <li>工作：${practice.work}</li>
      <li>健康：${practice.health}</li>
      <li>晚间：${practice.evening}</li>
    </ul>
  `;
}

// ==================== 辅助函数 ====================

function getStrongestElement(counts) {
  let maxCount = 0;
  let strongest = '';
  for (const [element, count] of Object.entries(counts)) {
    if (count > maxCount) {
      maxCount = count;
      strongest = element;
    }
  }
  return strongest;
}

function getWeakestElement(counts) {
  let minCount = Infinity;
  let weakest = '';
  for (const [element, count] of Object.entries(counts)) {
    if (count < minCount && count > 0) {
      minCount = count;
      weakest = element;
    }
  }
  return weakest || '木';
}

function getWeakestElementFromPercents(percents) {
  let minPercent = 100;
  let weakest = '';
  for (const [element, percent] of Object.entries(percents)) {
    if (percent < minPercent) {
      minPercent = percent;
      weakest = element;
    }
  }
  return weakest;
}

function isElementSupportive(element1, element2) {
  // 相生关系：木生火，火生土，土生金，金生水，水生木
  const supportivePairs = {
    '木': '火', '火': '土', '土': '金', '金': '水', '水': '木'
  };
  return supportivePairs[element1] === element2;
}

function isElementControlling(element1, element2) {
  // 相克关系：木克土，土克水，水克火，火克金，金克木
  const controllingPairs = {
    '木': '土', '土': '水', '水': '火', '火': '金', '金': '木'
  };
  return controllingPairs[element1] === element2;
}

function getWealthElement(dayElement) {
  const wealthMap = { '木': '土', '火': '金', '土': '水', '金': '木', '水': '火' };
  return wealthMap[dayElement];
}

function getOfficerElement(dayElement) {
  const officerMap = { '木': '金', '火': '水', '土': '木', '金': '火', '水': '土' };
  return officerMap[dayElement];
}

function getElementInteractionAdvice(strongest, weakest) {
  const adviceMap = {
    '木': '加强决断力，但要注意耐心',
    '火': '保持热情，但需控制冲动',
    '土': '稳重可靠，但要避免固执',
    '金': '坚毅果断，但需注意灵活性',
    '水': '智慧灵活，但要增强行动力'
  };
  
  return `建议：发挥${strongest}元素优势${adviceMap[strongest] ? `，${adviceMap[strongest]}` : ''}，同时加强${weakest}元素能量。`;
}

// VIP登录系统
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';  
  
// 初始化函数
function init() {
  // 设置默认日期为今天
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    birthdateInput.value = `${year}-${month}-${day}`;
  }

  // 设置默认时间为当前时间
  const birthtimeInput = $('birthtime');
  if (birthtimeInput && !birthtimeInput.value) {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    birthtimeInput.value = `${hours}:${minutes}`;
  }

  // 绑定事件
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // 绑定返回按钮
  const backBtn = $('backBtn');
  if (backBtn) {
    backBtn.addEventListener('click', backToMainAnalysis);
  }
  // 为详细分析按钮添加事件监听
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('chip') && e.target.dataset.type) {
      const type = e.target.dataset.type;
      if (window.currentBaziData) {
        showDetailAnalysis(type, window.currentBaziData.pillars, window.currentBaziData.strengthAnalysis);
      } else {
        showAuthErr('请先生成八字分析');
      }
    }
  });

  // 初始化各个模块
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // 回车键快速生成
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('八字命理系统初始化完成');
}

// 初始化语言支持
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (langSelect) {
    // 恢复用户的语言选择
    const savedLang = localStorage.getItem('preferredLanguage') || 'zh-CN';
    langSelect.value = savedLang;
    translatePage(savedLang);
    
    langSelect.addEventListener('change', () => {
      translatePage(langSelect.value);
    });
  }
}

// 页面加载完成后初始化
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
