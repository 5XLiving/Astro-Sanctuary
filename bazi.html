<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>八字排盘 · 免费报告</title>
<style>
  :root{
    --bg:#0b0f14; --text:#e6edf3; --muted:#8b949e;
    --brand:#ffd466; --card:#0f1520; --radius:14px;
    --shadow:0 6px 18px rgba(0,0,0,.28);
    --gold2:#ffdc80;
  }
  html,body{background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif; margin:0}
  .container{max-width:960px; margin:0 auto; padding:18px}
  h1,h2,h3{letter-spacing:.3px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
  .btn{padding:10px 16px; border-radius:10px; background:var(--brand); color:#111; font-weight:700; border:none; cursor:pointer}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .input, select{background:#0d1117; color:var(--text); border:1px solid #263241; border-radius:10px; padding:10px 12px}
  .muted{color:var(--muted)}
  /* 经典区 */
  #result{display:none}
  .pillars{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
  .pillar{background:#0d1117; border:1px solid #1b2430; border-radius:12px; padding:10px; text-align:center}
  .pillar .tit{font-size:12px; color:var(--muted)}
  .pillar .gz{font-size:20px; margin-top:4px}
  .grid2{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px}
  .wuxing-row{display:flex; align-items:center; gap:10px; margin:6px 0}
  .wuxing-bar{flex:1; height:10px; background:#111723; border-radius:999px; overflow:hidden}
  .wuxing-bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#ffe08a,#ffd466)}
  .footer-note{font-size:13px; color:var(--muted)}
  /* 免费报告 */
  #bazi-free-report .card{margin-bottom:12px}
  #bazi-free-report h3{margin:0 0 6px}
  #bazi-free-report p{margin:8px 0}
  #bazi-free-report .muted{color:var(--muted)}
  /* 心怜管家卡片 */
  #assistant-panel.card{margin-top:12px}
  #assistant-panel h3{margin:0 0 6px; color:var(--brand)}
  #assistant-panel .ul{margin:6px 0 0 18px; line-height:1.6}
  /* Chatbox */
  #gpt-chatbox{position:fixed; right:20px; bottom:20px; width:320px; background:var(--card); border-radius:14px; box-shadow:var(--shadow); overflow:hidden; display:none; z-index:999}
  #gpt-chatbox header{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#0d1117}
  #gpt-chatbox header h4{margin:0; color:var(--brand)}
  #gpt-chatbox .body{max-height:380px; overflow:auto; padding:10px 12px; font-size:14px}
  #gpt-chatbox .msg{margin:6px 0}
  #gpt-chatbox .msg.me{text-align:right}
  #gpt-chatbox footer{display:flex; gap:6px; padding:10px; background:#0d1117}
  #gpt-fab{position:fixed; right:20px; bottom:20px; padding:12px 16px; border-radius:999px; background:var(--brand); color:#111; font-weight:700; cursor:pointer; z-index:998}
</style>
</head>
<body>

<div class="container">
  <h2 style="margin:0 0 12px;"><span style="color:var(--brand)">八字排盘</span> · 免费报告</h2>

  <!-- 输入 -->
  <div class="card">
    <div class="row">
      <label>公历生日：
        <input id="birthdate" type="date" class="input" />
      </label>
      <label id="timeInputContainer">出生时分：
        <input id="birthtime" type="time" class="input" value="12:00" />
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="timeUnknown" type="checkbox" /> 时间不详
      </label>
      <select id="gender" class="input">
        <option value="">性别（可选）</option>
        <option value="男">男</option><option value="女">女</option>
      </select>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="genBtn" class="btn">
        <span id="genBtnText">生成命盘</span>
        <span id="genBtnLoading" style="display:none">计算中…</span>
      </button>
      <span id="error" class="muted" style="display:none; margin-left:8px;"></span>
    </div>
  </div>

  <!-- 结果区（经典区 + 报告/管家会插在这里后面） -->
  <div id="result" class="card">
    <div id="bazi-date" class="muted"></div>

    <!-- 四柱 -->
    <div class="pillars" id="bazi-pillars" style="margin-top:10px"></div>

    <!-- 经典表格（干支/五行/纳音） -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px; color:var(--brand)">经典信息</h3>
      <div class="grid2">
        <div>年柱：<b id="year-stem"></b><b id="year-branch"></b> ｜ 五行：<span id="year-element"></span> ｜ 纳音：<span id="year-nayin"></span></div>
        <div>月柱：<b id="month-stem"></b><b id="month-branch"></b> ｜ 五行：<span id="month-element"></span> ｜ 纳音：<span id="month-nayin"></span></div>
        <div>日柱：<b id="day-stem"></b><b id="day-branch"></b> ｜ 五行：<span id="day-element"></span> ｜ 纳音：<span id="day-nayin"></span></div>
        <div>时柱：<b id="hour-stem"></b><b id="hour-branch"></b> ｜ 五行：<span id="hour-element"></span> ｜ 纳音：<span id="hour-nayin"></span></div>
      </div>
    </div>

    <!-- 五行能量条 -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px; color:var(--brand)">五行能量分析</h3>
      <div class="wuxing-row"><span style="width:28px">木</span><div class="wuxing-bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="wuxing-row"><span style="width:28px">火</span><div class="wuxing-bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="wuxing-row"><span style="width:28px">土</span><div class="wuxing-bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="wuxing-row"><span style="width:28px">金</span><div class="wuxing-bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="wuxing-row"><span style="width:28px">水</span><div class="wuxing-bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div class="footer-note" id="bazi-elements-balance" style="margin-top:6px"></div>
    </div>

    <!-- 强弱/喜用一句话 -->
    <div class="card" style="margin-top:12px">
      <div id="bazi-day-master"><b>日主：</b></div>
      <div id="bazi-strengths" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- 报告、管家会自动插入到 #result 后面 -->
</div>

<!-- Chatbox 按钮 + 抽屉 -->
<button id="gpt-fab">GPT 问答</button>
<div id="gpt-chatbox">
  <header><h4>GPT 问答</h4><button id="gpt-close" style="background:none;border:none;color:#fff;font-size:18px">×</button></header>
  <div class="body" id="gpt-body"></div>
  <footer>
    <input id="gpt-input" placeholder="问点什么…" style="flex:1; padding:8px; border-radius:8px; border:1px solid #222; background:#0b0f14; color:var(--text)">
    <button id="gpt-send" class="btn" style="padding:8px 12px">发送</button>
  </footer>
</div>

<script>
/* ======================= 八字计算器（算法原封不动） ======================= */
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS   = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC           = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year){ const s=(year-4)%10, b=(year-4)%12; return { stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12], zodiac:this.ZODIAC[(b+12)%12] }; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return {index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return {stem:this.HEAVENLY_STEMS[stemIdx], branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return { stem:this.HEAVENLY_STEMS[(stemIdx+10)%10], branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12] }; }
  calculateHourPillar(dayStem, hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return { stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour] }; }
  getElement(stem,branch){ const s={'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'}; const b={'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year);
    const monthP=this.calculateMonthPillar(year,month,day);
    const dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP, month:monthP, day:{...dayP, element:dayElement}, hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    const list=timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP];
    list.forEach(p=>{ if(p.stem && p.stem!=='？') cnt[this.getStemElement(p.stem)]++; if(p.branch && p.branch!=='？') cnt[this.getBranchElement(p.branch)]++; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={ wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return { pillars, counts:cnt, percents:pct, timeUnknown };
  }
}
window.baziCalculator = window.baziCalculator || new BaziCalculator();

/* ======================= 心怜管家（渲染器，不动算法） ======================= */
class XinLianAssistant{
  constructor(){ this.currentContext=null; }
  generateAnalysis(baziData){
    this.currentContext=baziData;
    const a=document.getElementById('assistant-analysis');
    const b=document.getElementById('assistant-advice');
    if(a) a.innerHTML=this.analyzeBazi(baziData);
    if(b) b.innerHTML=this.generateAdvice(baziData);
  }
  analyzeBazi({dayMaster,elements,strength,season,timeUnknown}){
    const timeNote=timeUnknown?'<li><strong>注意：</strong>因出生时间不详，时柱缺失，仅基于年月日三柱。</li>':'';
    return `<ul class="ul">
      <li>您的日主为 <strong>${dayMaster.stem}（${dayMaster.element}）</strong></li>
      <li>命局整体<strong>${strength.mark}</strong>，${this.getStrengthDescription(strength.mark)}</li>
      <li>出生于<strong>${season}</strong>季，${this.getSeasonInfluence(season)}</li>
      <li>五行分布：${this.getElementDistribution(elements)}</li>
      ${timeNote}
    </ul>`;
  }
  generateAdvice({strength,useful,timeUnknown}){
    const timeWarn=timeUnknown?'<li><strong>提示：</strong>无时柱，建议仅作参考。</li>':'';
    return `<ul class="ul">
      <li><strong>发展策略：</strong>${strength.focus}</li>
      <li><strong>喜用元素：</strong>${(useful.useful||[]).join('、')}</li>
      <li><strong>幸运颜色：</strong>${this.getLuckyColors(useful.useful||[])}</li>
      <li><strong>适合方位：</strong>${this.getLuckyDirections(useful.useful||[])}</li>
      ${timeWarn}
    </ul>`;
  }
  getStrengthDescription(m){ return {偏强:'潜力足、抗压好',偏弱:'需外援更能发挥',平衡:'各面均衡、适应性强'}[m]||'具有独特特点'; }
  getSeasonInfluence(s){ const m={春:'木旺生发',夏:'火旺外放',秋:'金旺收敛',冬:'水旺内藏'}; return m[s]||'季节对命局有一定影响'; }
  getLuckyColors(list){ const m={木:'绿色/青色',火:'红色/紫色',土:'黄色/棕色',金:'白色/金色',水:'黑色/蓝色'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
  getLuckyDirections(list){ const m={木:'东方',火:'南方',土:'中央/东北/西南',金:'西方',水:'北方'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
  ELABEL(){ return {wood:'木',fire:'火',earth:'土',metal:'金',water:'水'}; }
  getElementDistribution(elements){ const L=this.ELABEL(); return Object.entries(elements).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${L[k]||k}${Math.round(v)}%`).join('、'); }
  getStrongestElement(elements){ const L=this.ELABEL(); const [k]=Object.entries(elements).reduce((a,b)=>a[1]>b[1]?a:b); return L[k]||k; }
  getWeakestElement(elements){ const L=this.ELABEL(); const [k]=Object.entries(elements).reduce((a,b)=>a[1]<b[1]?a:b); return L[k]||k; }
}
const assistant = new XinLianAssistant();

/* ======================= 工具 & 规则函数 ======================= */
function $(id){ return document.getElementById(id); }
function setText(id,v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el,pct){ if(el) el.style.width=Math.max(0,Math.min(100,pct))+'%'; }
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl=STEM_ELEM[dayGan]; const season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score += (cnt[dmEl]||0)*1.2;
  const mark = score>=3?'偏强':(score<=1?'偏弱':'平衡');
  const focus= mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和');
  return {season, mark, focus};
}
function chooseUseful(strength, dmElem){
  if(strength==='偏强'){ return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]}; }
  if(strength==='偏弱'){ return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]}; }
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown);
    const stem=u?'？':v.stem, branch=u?'？':v.branch;
    const div=document.createElement('div'); div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b);
  const ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem);   setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem);     setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem);
  setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
  setIf('year-element', ge(p.year.stem,p.year.branch));
  setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',  ge(p.day.stem,p.day.branch));
  setIf('hour-element', timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',  ny(p.year.stem,p.year.branch));
  setIf('month-nayin', ny(p.month.stem,p.month.branch));
  setIf('day-nayin',   ny(p.day.stem,p.day.branch));
  setIf('hour-nayin',  timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
}

/* ======================= 免费报告（自动插入到结果后） ======================= */
function buildFreeReportHTML({pillars, percents, st, adv, timeUnknown}){
  const L={wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
  const entries=Object.entries(percents);
  const strongest=L[entries.reduce((a,b)=>a[1]>b[1]?a:b)[0]];
  const weakest  =L[entries.reduce((a,b)=>a[1]<b[1]?a:b)[0]];
  const absents=Object.keys(percents).filter(k=>Math.round(percents[k])===0).map(k=>L[k]).join('、');
  const pctLine=['wood','fire','earth','metal','water'].map(k=>`${L[k]} ${Math.round(percents[k])}%`).join('　');
  const fav=(adv?.useful||[]).join('、');
  const avoid=(adv?.avoid||[]).join('、')||'—';
  const hourTxt=timeUnknown?'？？':(pillars.hour.stem+pillars.hour.branch);

  return `
  <div id="bazi-free-report" class="container" style="padding-top:12px">
    <div class="card"><h3 style="color:var(--brand)">一、命盘总览</h3>
      <p>四柱：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p>日主：<strong>${pillars.day.stem}</strong>（<strong>${pillars.day.element}</strong>）｜季节：<strong>${st.season||'-'}</strong>｜命局：<strong>${st.mark}</strong> · 策略：<strong>${st.focus}</strong></p>
    </div>

    <div class="card"><h3 style="color:var(--brand)">二、五行能量分析</h3>
      <p>${pctLine}</p>
      <p><strong>${strongest}</strong>偏旺；<strong>${weakest}</strong>偏弱。${absents?`<span class="muted">（缺：${absents}）</span>`:''}</p>
      <ul style="margin:6px 0 0 18px; line-height:1.6">
        <li>喜用优先：<strong>${fav||'—'}</strong></li>
        <li>调衡要点：${st.focus}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">提示：时间不详，时柱未纳入。</p>`:''}
    </div>

    <div class="card"><h3 style="color:var(--brand)">三、格局与喜忌</h3>
      <p>格局要点：依据四柱模板化输出（坐禄/比劫/伤官/七杀等）。</p>
      <p>喜用：${fav||'—'}　忌讳：${avoid}</p>
    </div>

    <div class="card"><h3 style="color:var(--brand)">四、事业 / 感情 / 财运 / 健康（免费试读）</h3>
      <p>事业：结合喜用给出适合领域 + 策略 + 风险（模板化）。</p>
      <p>感情：吸引类型 + 关系课题 + 相处建议（模板化）。</p>
      <p>财运：${fav||'—'}为主调，稳中求进；避免短线情绪化。</p>
      <p>健康：按最弱五行提示易感系统与作息建议。</p>
    </div>

    <div class="card"><h3 style="color:var(--brand)">五、流年 / 流月（预告）</h3>
      <p>年度一句话提示 + 当月关注点（模板化）。</p>
      <div style="margin-top:8px">
        <a href="/vip" class="btn" style="text-decoration:none">升级 VIP</a>
      </div>
    </div>

    <!-- 心怜管家卡片 -->
    <div id="assistant-panel" class="card">
      <h3>心怜管家 · 智能解读</h3>
      <div id="assistant-analysis"></div>
      <div id="assistant-advice" style="margin-top:8px"></div>
    </div>
  </div>`;
}

/* ======================= 主流程 ======================= */
async function genChart(){
  const birth=($('#birthdate')?.value||'').trim();
  const timeUnknown=$('#timeUnknown')?.checked||false;
  if(!birth){ showError('请填写出生日期。'); return; }
  const btn=$('#genBtn'), tx=$('#genBtnText'), ld=$('#genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D]=birth.split('-').map(Number);
    let hour=12;
    if(!timeUnknown){ const t=($('#birthtime')?.value||'').trim(); if(t) hour=parseInt(t.split(':')[0],10); }
    const { pillars, counts, percents, timeUnknown:tu } = baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    $('#result')?.style.setProperty('display','block');
    const timeText=tu?'时间不详':(hour+'时');
    setText('bazi-date',`出生日期: ${Y}年${M}月${D}日 ${timeText}`);

    renderPillars($('#bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('#bar-木'),percents.wood); setText('pct-木',Math.round(percents.wood)+'%');
    setBar($('#bar-火'),percents.fire); setText('pct-火',Math.round(percents.fire)+'%');
    setBar($('#bar-土'),percents.earth); setText('pct-土',Math.round(percents.earth)+'%');
    setBar($('#bar-金'),percents.metal); setText('pct-金',Math.round(percents.metal)+'%');
    setBar($('#bar-水'),percents.water); setText('pct-水',Math.round(percents.water)+'%');

    const keys=Object.keys(counts);
    const maxK=keys.reduce((a,b)=>counts[a]>counts[b]?a:b);
    const minK=keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance',`五行中${maxK}元素最强，${minK}元素最弱。`);

    const st = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv= chooseUseful(st.mark, pillars.day.element);
    setText('bazi-day-master',`日主：${pillars.day.stem}（${pillars.day.element}）`);
    setText('bazi-strengths',`命局${st.mark}，建议策略：${st.focus}`);

    // 报告卡片
    const reportHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown:tu});
    const anchor = document.getElementById('bazi-free-report');
    if(anchor){ anchor.outerHTML = reportHTML; } else { $('#result').insertAdjacentHTML('afterend', reportHTML); }

    // 心怜管家渲染
    assistant.generateAnalysis({
      dayMaster:{stem:pillars.day.stem, element:pillars.day.element},
      elements:{wood:percents.wood, fire:percents.fire, earth:percents.earth, metal:percents.metal, water:percents.water},
      strength:st, season:st.season, useful:adv, timeUnknown:tu
    });

    // GPT chatbox 上下文（可用于提示工程）
    window.__bazi_ctx__ = { pillars, percents, season:st.season, strength:st.mark, useful: adv?.useful||[] };

  } catch(err){
    console.error(err);
    showError('计算八字时出现错误，请重试');
  } finally {
    if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none';
  }
}

/* ======================= 事件绑定 & Chatbox ======================= */
function showError(msg){ const el=$('#error'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 4000); }

document.addEventListener('DOMContentLoaded', ()=>{
  const today=new Date(); const def=today.toISOString().split('T')[0];
  if($('#birthdate') && !$('#birthdate').value) $('#birthdate').value=def;
  const tChk=$('#timeUnknown'), tBox=$('#timeInputContainer');
  if(tChk){ tChk.addEventListener('change', function(){ tBox && tBox.classList.toggle('disabled', this.checked); }); }
  $('#genBtn')?.addEventListener('click', genChart);

  // Chatbox
  const fab=$('#gpt-fab'), box=$('#gpt-chatbox');
  const closeBtn=$('#gpt-close'), sendBtn=$('#gpt-send');
  const input=$('#gpt-input'), body=$('#gpt-body');
  fab.onclick=()=>{ box.style.display='block'; fab.style.display='none'; };
  closeBtn.onclick=()=>{ box.style.display='none'; fab.style.display='inline-block'; };
  sendBtn.onclick=async ()=>{
    const text=(input.value||'').trim(); if(!text) return;
    body.insertAdjacentHTML('beforeend', `<div class="msg me">${text}</div>`); input.value='';
    const ctx=window.__bazi_ctx__||{};
    const reply=await callChatAPI(text, ctx).catch(()=> '（暂时无法连接到服务端）');
    body.insertAdjacentHTML('beforeend', `<div class="msg">${reply}</div>`); body.scrollTop=body.scrollHeight;
  };
});

// 你自己的后端接口（按需替换）
async function callChatAPI(userText, ctx){
  const r = await fetch('/api/chat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ prompt:userText, context:ctx })
  }).then(r=>r.ok?r.text():'');
  return r || '（无响应）';
}

// 自测（控制台）
(function(){
  const c=new BaziCalculator();
  const Y=c.calculateYearPillar(1978);
  const M=c.calculateMonthPillar(1978,2,21);
  const D=c.calculateDayPillar(1978,2,21);
  const H=c.calculateHourPillar(D.stem,12);
  console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
  console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
