
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + “不详”同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏“估时间”按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
/* 聊天输入行：输入框撑满、按钮按内容自适应 */
.ss-chat-input{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px; border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto; min-width:0;
}
.ss-chat-input .btn,
.ss-chat-input button{
  flex:0 0 auto;
  width:auto !important;
  white-space:nowrap;
  padding:10px 14px;
}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    /* 修复：Grid 子项允许收缩，避免内容把面板撑破 */
.auth-grid > * { min-width: 0; }
.panel .body .row.one > * { min-width: 0; }

/* 让会员按钮在窄宽度下能换行、居中且不溢出 */
.panel .body .btn {
  display: flex;               /* 改为 flex 更稳 */
  align-items: center;
  justify-content: center;
  text-align: center;
  white-space: normal;         /* 允许换行 */
  line-height: 1.2;
  word-break: break-word;      /* 多语言/长词可断行 */
}

/* 块级按钮确保占满容器且不超出 */
.btn.block { display:block; width:100%; box-sizing:border-box; }

/* 可选：如果仍有轻微位移，限制溢出 */
.panel .body { overflow: hidden; }

.panel .body .btn { padding: 10px 14px; }    
    /* === 表单网格：大屏 3 列，窄屏 1 列 === */
.row{display:grid;gap:12px;grid-template-columns:1fr;}        /* 默认 1 列 */
.row > *{min-width:0;}                                         /* 防止子项把容器撑爆 */
@media (min-width:760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr;}              /* 三列 */
}

/* 标签更紧凑 */
label.muted{display:block;margin-bottom:4px}

/* 按钮不要 100% 宽 */
#genBtn{width:auto !important}
.gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

/* 时间输入与“不详”并排、紧凑 */
.time-row{display:flex;align-items:center;gap:10px}
.time-row input[type="time"]{
  width:auto !important; flex:0 0 160px; min-width:140px;
}
.time-row .time-unknown{white-space:nowrap}
    .title a{ color: inherit; text-decoration: none; }
.title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    /* —— 统一头部 —— */
.site-header{
  position:sticky; top:0; z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

/* 品牌区：徽章 + 标题 */
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}

/* 语言选择：防止“语言”竖排、与第一张一致 */
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; min-width:170px;
  border-radius:10px; border:1px solid #243244;
  background:#0e1520; color:var(--text);
  padding:10px 34px 10px 12px; font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
/* 与 Index 保持一致的根字号（会影响 rem 计算） */
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }

/* 标题用 Noto Serif SC；字号/字重与 Index 完全一致 */
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}    

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}  

        /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }        
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <!-- 品牌：点击回到“八字简评”本页 -->
<a class="brand" href="https://astro.5xliving.com/" target="_self">
  <span class="brand-badge">5X</span>
  <span class="title">
    5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
  </span>
</a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
<div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

<div class="row cols-3">
  <div>
    <label class="muted" data-i18n="label_name">姓名（可选）</label>
    <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
  </div>
  <div>
    <label class="muted" data-i18n="gender_label">性别</label>
     <select id="gender">
     <option value="" data-i18n="opt_gender_confidential">不透露</option>
     <option value="male" data-i18n="opt_gender_male">男性</option>
     <option value="female" data-i18n="opt_gender_female">女性</option>
    </select>
  </div>
  <div>
    <label class="muted" data-i18n="label_calendar">历法</label>
     <select id="calendar">
     <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
     <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
    </select>
  </div>
</div>

<div class="row cols-3" style="margin-top:10px">
  <div>
    <label class="muted" data-i18n="label_birthdate">出生日期</label>
    <input type="date" id="birthdate" />
  </div>

  <div>
    <label class="muted" data-i18n="label_birthtime">出生时间</label>
    <div class="time-row">
     <input type="time" id="birthtime" value="12:00" />
     <label class="muted time-unknown">
     <input type="checkbox" id="timeUnknown" />
     <span data-i18n="cb_time_unknown">出生时间不详</span>
      </label>
    </div>
  </div>

  <div class="gen-wrap">
  <button class="btn" id="genBtn" type="button">
    <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
    <span id="genBtnLoading" style="display:none">计算中...</span>
  </button>
</div>

      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">五行能量分析</div>
        <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
       <div class="row" id="authFields">
         <!-- 登录/注册建议用 username，密码管理器更容易配对 -->
         <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
         <input
            id="email"
            name="email"
            type="email"
            inputmode="email"
            autocomplete="username"
            placeholder=""
            data-i18n-ph="ph_email"
            required
         />
         <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
         <input
            id="password"
            name="password"
            type="password"
            autocomplete="current-password"
            placeholder="密码 Password（至少8位，含大小写数字符号）"
            data-i18n-ph="ph_password"
            required
         />
       </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点“填入时间”，会用该时段的中位时间写到上方时间输入框，并自动取消“时间不详”。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

<script>
'use strict';

/* ================== 配置 & 工具 ================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

const $ = id => document.getElementById(id);
function showErr(msg){ const e=$("error"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
function showAuthErr(msg){ const e=$("authError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
function hideAuthErr(){ const e=$("authError"); if(!e) return; e.style.display="none"; e.textContent=""; }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ---------- 更稳的网络助手：状态码/超时/非 JSON ---------- */
async function fetchJSON(path, payload, { timeout = 12000 } = {}) {
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const resp = await fetch(`${API_BASE}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      // credentials: 'include',
      mode: 'cors',
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
    const raw = await resp.text();
    let data; try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok:false, msg:'invalid_json', raw }; }
    if(!resp.ok) return { ok:false, status:resp.status, ...data };
    return data;
  }catch(e){
    return { ok:false, msg: e?.name==='AbortError' ? 'timeout' : (e?.message || 'network_error') };
  }finally{
    clearTimeout(timer);
  }
}

/* ================== 多语言（仅 zh-CN / en / ja / th / ms） ================== */
const LANG_KEY="site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

const translations = {
  "zh-CN": {
    // —— 通用 / 顶部与表单 ——
    lang_label: "语言",
    btn_register: "注册账户",
    btn_login: "登入账户",
    btn_reset: "🔑 重设密码",
    note_price: "注册账号赠送一次免费体验",
    note_price1: "$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",

    err_need_ep: "请输入邮箱与密码",
    err_pwd_rule: "密码至少8位，需包含大写/小写/数字/特殊符号",
    err_no_account: "账户不存在，请先注册",
    err_wrong_pwd: "密码错误",
    err_expired: "会员已过期，请续费",
    err_login_fail: "登入失败：",
    err_register_fail: "注册失败：",
    err_email_empty: "邮箱不能为空",
    err_pwd_empty: "密码不能为空",
    err_reset_fail: "重设密码失败：",

    prompt_email: "请输入注册邮箱：",
    prompt_newpwd: "请输入新密码（至少8位，含大小写、数字、符号）：",

    btn_upgrade: "💎 升级为 VIP（月费）",
    btn_backshop: "← 返回命理商城",

    vip_title: "🌙 会员区域 VIP Segment",
    vip_mingli: "🗝 命理空间专属内容",
    vip_xinlian: "🌙 心怜空间专属内容",
    vip_love: "姻缘方向：恋爱缘分、婚姻走势",
    vip_career: "事业方向：职场发展、创业潜力",
    vip_wealth: "财运方向：财位分析、理财时机",
    vip_pet: "宠物命理：伴侣动物的性格与缘分",
    vip_hepan: "合盘分析：婚期择日、新生择时",
    vip_name: "测名分析：公司名、宝宝名、命名改运",
    vip_fengshui: "财位合盘：住家 / 办公室动线配合",
    vip_record: "灵性记录：照片、梦境、声音、愿望祈祷",
    vip_course: "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    vip_memorial: "家族纪念系统：亲人灵性纪念 & 延续",
    vip_tasks: "每周能量练习 / 神明仪式任务",
    vip_shop: "能量商城专属折扣 & 御守订制",
    login_title: "💎 登入 VIP 功能",

    chat_fab: "问",
    chat_placeholder: "请问您想了解什么？（如：如何开始免费体验）",
    chat_send: "发送",
    msg_reset_ok: "密码已成功更新，请用新密码重新登入。",

    ph_email: "邮箱 Email",
    ph_password: "密码 Password（至少8位，含大小写数字符号）",
    ph_label_password: "密码 Password",

    title_quickcalc: "八字命理 · 快速排盘",
    title_bazi_brief: "八字简评",
    label_name: "姓名（可选）",
    ph_name: "你的称呼（用于个性化）",
    gender_label: "性别",
    label_calendar: "历法",
    label_birthdate: "出生日期",
    label_birthtime: "出生时间",
    cb_time_unknown: "出生时间不详",
    btn_generate_chart: "生成八字",
    panel_login_head: "账户登录 / 注册",
    panel_member_head: "会员服务",

    // 下拉项
    opt_gender_confidential: "不透露",
    opt_gender_male: "男性",
    opt_gender_female: "女性",
    opt_cal_gregorian: "阳历",
    opt_cal_lunar: "农历",

    elements_balance_tpl: "五行中{max}元素最强，{min}元素最弱。",

    // —— Butler / Report keys（中文） ——
    butler_title: "心怜管家 · 解读",
    day_master: "日主",
    chart_strength: "命局",
    season: "季节",
    wuxing_distribution: "五行分布",
    note: "注意",
    time_unknown_checked: "已勾选“出生时间不详”",
    hour_pillar_excluded: "未纳入时柱",
    hint: "提示",
    no_hour_tip: "无时柱，建议仅作参考。",
    dev_strategy: "发展策略：",
    useful_elements: "喜用元素：",
    lucky_colors: "幸运颜色：",
    lucky_directions: "适合方位：",
    strength_strong: "偏强",
    strength_weak: "偏弱",
    strength_balanced: "平衡",
    desc_strong: "潜力足、抗压好",
    desc_weak: "需外援更能发挥",
    desc_balanced: "均衡、适应性强",
    desc_generic: "具有独特特点",
    season_spring: "木旺生发",
    season_summer: "火旺外放",
    season_autumn: "金旺收敛",
    season_winter: "水旺内藏",
    season_generic: "季节对命局有一定影响",
    el_wood: "木",
    el_fire: "火",
    el_earth: "土",
    el_metal: "金",
    el_water: "水",
    dir_wood: "东方",
    dir_fire: "南方",
    dir_earth: "中央/东北/西南",
    dir_metal: "西方",
    dir_water: "北方",
    color_wood: "绿色/青色",
    color_fire: "红色/紫色",
    color_earth: "黄色/棕色",
    color_metal: "白色/金色",
    color_water: "黑色/蓝色",

    // 报告分段
    rpt_free_title: "免费简报",
    rpt_pillars_label: "四柱",
    rpt_daymaster_label: "日主",
    rpt_season_label: "季节",
    rpt_chart_label: "命局",
    rpt_strategy_label: "策略",
    rpt_wuxing_label: "五行分布",
    rpt_strongest_word: "偏旺",
    rpt_weakest_word: "偏弱",
    rpt_absent_prefix: "缺：",
    rpt_fav_avoid_template: "喜用：{fav}｜忌：{avoid}",
    rpt_balance_focus_label: "调衡要点",
    rpt_time_hint: "提示：出生时间不详，未纳入时柱，仅供参考。",
    rpt_time_unknown: "时间不详",
    rpt_sec_overview_title: "一、命盘总览",
    rpt_sec_elements_title: "二、五行能量分析",
    rpt_sec_traits_title: "三、性格与天赋",
    rpt_traits_intro: "依据日主、季节与强弱给出核心性格标签（模板化占位）。",
    rpt_traits_adv: "优势能量：执行 / 创造 / 学习（模板化占位）。",
    rpt_traits_chal: "潜在挑战：节奏 / 边界 / 过犹不及（模板化占位）。",
    rpt_sec_structure_title: "四、格局与喜忌",
    rpt_structure_line_template: "喜用：{fav}；忌讳：{avoid}",
    rpt_sec_career_title: "五、事业与发展（免费试读）",
    rpt_career_fields_placeholder: "适合领域：结合喜用与气质（模板化占位）。",
    rpt_dev_strategy_prefix: "发展策略：",
    rpt_sec_love_title: "六、感情与关系（免费试读）",
    rpt_love_placeholder: "沟通节奏与边界建议（模板化占位）。",
    rpt_sec_wealth_title: "七、财富与理财（免费试读）",
    rpt_wealth_suggestion_template: "理财建议：以 {fav} 为主调，稳中求进。",
    rpt_sec_health_title: "八、健康与作息",
    rpt_health_placeholder_template: "围绕最弱五行（{weak}）做作息与环境优化（模板化占位）。",
    rpt_sec_env_title: "九、环境与色彩",
    rpt_env_placeholder: "有利方位与配色随喜用（模板化占位）。",
    rpt_strategy_drain: "泄秀/制化",
    rpt_strategy_support: "生扶/补助",
    rpt_strategy_balance: "调和",

    // AI 芯片 & 任务
    chip_career: "事业",
    chip_love: "感情",
    chip_money: "财运",
    chip_list: "今日待办",
    chip_30d: "30天建议",

    q_career: "请结合我的八字日主、季节、强弱与五行比例，给我职业发展建议：适合行业、岗位风格、短期突破点，尽量落地、可执行。",
    q_love: "请结合八字信息，给出恋爱/婚姻建议：择偶倾向、相处节奏、沟通边界、容易踩的坑与修正办法。",
    q_money: "请结合八字信息，给出未来半年财运与理财建议：现金流、风险与稳健比例、开支结构优化，列出具体行动清单。",
    q_list: "基于我的八字结构，生成“今日待办”的3-5条具体行动，要求可执行、可量化，附小提醒与时间建议。",
    q_30d: "结合我的弱项五行，给我一份连续30天的小练习清单（每天1条），用于调衡/巩固，尽量简单且可坚持。"
  },

  "en": {
    // —— Common / Form ——
    lang_label: "Language",
    btn_register: "Create Account",
    btn_login: "Log in",
    btn_reset: "🔑 Reset Password",
    note_price: "New account gets one free trial.",
    note_price1: "$9.9 / month · VIP (Astro + Soul + Courses)",

    err_need_ep: "Enter email and password",
    err_pwd_rule: "Password must be 8+ and include upper/lowercase, number, symbol",
    err_no_account: "Account not found. Please register first.",
    err_wrong_pwd: "Incorrect password",
    err_expired: "Membership expired. Please renew.",
    err_login_fail: "Login failed: ",
    err_register_fail: "Registration failed: ",
    err_email_empty: "Email cannot be empty",
    err_pwd_empty: "Password cannot be empty",
    err_reset_fail: "Password reset failed: ",

    prompt_email: "Enter your registered email:",
    prompt_newpwd: "Enter a new password (8+, upper/lower/digit/symbol):",

    btn_upgrade: "💎 Upgrade to VIP (Monthly)",
    btn_backshop: "← Back to Store",

    vip_title: "🌙 VIP Segment",
    vip_mingli: "🗝 Astro Sanctuary · Exclusive",
    vip_xinlian: "🌙 Soul Sanctuary · Exclusive",
    vip_love: "Love: Dating Fate, Marriage Trend",
    vip_career: "Career: Workplace, Entrepreneurship",
    vip_wealth: "Wealth: Wealth Position, Timing",
    vip_pet: "Pet Destiny: Temperament & Bond",
    vip_hepan: "Synastry: Wedding Dates, Birthtime",
    vip_name: "Name Reading: Company/Baby/Renaming",
    vip_fengshui: "Wealth & Layout: Home / Office",
    vip_record: "Spiritual Logs: Photos, Dreams, Voice, Prayers",
    vip_course: "Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
    vip_memorial: "Family Memorial: Spiritual Archive & Legacy",
    vip_tasks: "Weekly Energy Practices / Divine Ritual Tasks",
    vip_shop: "Store Discounts & Omamori",
    login_title: "💎 VIP Login",

    chat_fab: "Chat",
    chat_placeholder: "What would you like to know? (e.g., how to start the free trial)",
    chat_send: "Send",
    msg_reset_ok: "Password updated. Please log in with the new one.",

    ph_email: "Email",
    ph_password: "Password (8+, upper/lower/digit/symbol)",
    ph_label_password:"Password",

    title_quickcalc: "Bazi · Quick Chart",
    title_bazi_brief: "Bazi Quick Reading",
    label_name: "Name (optional)",
    ph_name: "Your name (for personalization)",
    gender_label: "Gender",
    label_calendar: "Calendar",
    label_birthdate: "Birth Date",
    label_birthtime: "Birth Time",
    cb_time_unknown: "Birth time unknown",
    btn_generate_chart: "Generate Chart",
    panel_login_head: "Account Login / Sign-up",
    panel_member_head: "Membership Services",

    opt_gender_confidential: "Confidential",
    opt_gender_male: "Male",
    opt_gender_female: "Female",
    opt_cal_gregorian: "Gregorian",
    opt_cal_lunar: "Lunar",

    elements_balance_tpl: "Strongest: {max} · Weakest: {min}",

    // —— Butler / Report keys（English） ——
    butler_title: "Xinlian Butler · Insight",
    day_master: "Day Master",
    chart_strength: "Chart Strength",
    season: "Season",
    wuxing_distribution: "Five Elements",
    note: "Note",
    time_unknown_checked: "“Birth time unknown” is checked",
    hour_pillar_excluded: "Hour pillar not included",
    hint: "Hint",
    no_hour_tip: "No hour pillar — treat as reference only.",
    dev_strategy: "Development strategy: ",
    useful_elements: "Favorable elements: ",
    lucky_colors: "Lucky colors: ",
    lucky_directions: "Lucky directions: ",
    strength_strong: "Strong-leaning",
    strength_weak: "Weak-leaning",
    strength_balanced: "Balanced",
    desc_strong: "High potential and stress-tolerant",
    desc_weak: "Works better with external support",
    desc_balanced: "Well-balanced and adaptable",
    desc_generic: "Has unique characteristics",
    season_spring: "Wood thrives; outward growth",
    season_summer: "Fire thrives; expression/outflow",
    season_autumn: "Metal thrives; organize/refine",
    season_winter: "Water thrives; conserve/reflect",
    season_generic: "Seasonal qi has some influence",
    el_wood: "Wood",
    el_fire: "Fire",
    el_earth: "Earth",
    el_metal: "Metal",
    el_water: "Water",
    dir_wood: "East",
    dir_fire: "South",
    dir_earth: "Center/NE/SW",
    dir_metal: "West",
    dir_water: "North",
    color_wood: "Green/Teal",
    color_fire: "Red/Purple",
    color_earth: "Yellow/Brown",
    color_metal: "White/Gold",
    color_water: "Black/Blue",

    rpt_free_title: "Free Summary",
    rpt_pillars_label: "Pillars",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "Season",
    rpt_chart_label: "Chart",
    rpt_strategy_label: "Strategy",
    rpt_wuxing_label: "Five Elements",
    rpt_strongest_word: "strongest",
    rpt_weakest_word: "weakest",
    rpt_absent_prefix: "Absent: ",
    rpt_fav_avoid_template: "Favorable: {fav} | Avoid: {avoid}",
    rpt_balance_focus_label: "Balance focus",
    rpt_time_hint: "Note: birth time unknown; hour pillar excluded—use as reference only.",
    rpt_time_unknown: "Unknown time",
    rpt_sec_overview_title: "1) Overview",
    rpt_sec_elements_title: "2) Element Analysis",
    rpt_sec_traits_title: "3) Traits & Talents",
    rpt_traits_intro: "Core trait tags based on DM, season, and strength (placeholder).",
    rpt_traits_adv: "Advantages: Execution / Creativity / Learning (placeholder).",
    rpt_traits_chal: "Challenges: Pace / Boundaries (placeholder).",
    rpt_sec_structure_title: "4) Structure & Preferences",
    rpt_structure_line_template: "Favorable: {fav}; Avoid: {avoid}",
    rpt_sec_career_title: "5) Career (sample)",
    rpt_career_fields_placeholder: "Suitable fields (placeholder).",
    rpt_dev_strategy_prefix: "Development strategy: ",
    rpt_sec_love_title: "6) Love (sample)",
    rpt_love_placeholder: "Communication pace & boundaries (placeholder).",
    rpt_sec_wealth_title: "7) Wealth (sample)",
    rpt_wealth_suggestion_template: "Wealth tip: prefer flows aligned with {fav}.",
    rpt_sec_health_title: "8) Health",
    rpt_health_placeholder_template: "Care for weakest element: {weak}.",
    rpt_sec_env_title: "9) Environment & Colors",
    rpt_env_placeholder: "Favorable directions & palette follow your favorable elements.",
    rpt_strategy_drain: "Drain/Control",
    rpt_strategy_support: "Support/Nourish",
    rpt_strategy_balance: "Balance",

    chip_career: "Career",
    chip_love: "Love",
    chip_money: "Wealth",
    chip_list: "Today's To-Dos",
    chip_30d: "30-Day Plan",

    q_career: "Using my Bazi day master, season, strength, and element ratios, give practical career advice: suitable industries/roles and near-term breakthroughs.",
    q_love: "Using my Bazi info, give relationship/marriage advice: partner tendencies, communication pace, boundaries, pitfalls and fixes.",
    q_money: "Using my Bazi info, give wealth advice for the next 6 months: cashflow, risk vs. safety mix, and concrete budget/expense actions.",
    q_list: "Based on my Bazi structure, create 3–5 actionable, measurable to-dos for today, with small reminders and time suggestions.",
    q_30d: "Using my weakest element, design a 30-day micro-habit plan (1 item/day) for balance; keep it simple and sustainable."
  },

  "ja": {
    lang_label: "言語",
    btn_register: "アカウント登録",
    btn_login: "ログイン",
    btn_reset: "🔑 パスワードをリセット",
    note_price: "新規登録で無料体験を1回プレゼント",
    note_price1: "$9.9 / 月 · VIP（命理スペース + 心怜スペース + スピリチュアル講座）",

    err_need_ep: "メールとパスワードを入力してください",
    err_pwd_rule: "パスワードは8文字以上で、大文字/小文字/数字/記号を含めてください",
    err_no_account: "アカウントが見つかりません。先に登録してください",
    err_wrong_pwd: "パスワードが正しくありません",
    err_expired: "会員期限が切れました。更新してください",
    err_login_fail: "ログイン失敗：",
    err_register_fail: "登録に失敗しました：",
    err_email_empty: "メールアドレスを入力してください",
    err_pwd_empty: "パスワードを入力してください",
    err_reset_fail: "リセットに失敗：",

    prompt_email: "登録メールアドレスを入力してください：",
    prompt_newpwd: "新しいパスワードを入力（8文字以上・大/小/数字/記号）：",

    btn_upgrade: "💎 VIP（月額）にアップグレード",
    btn_backshop: "← ストアに戻る",

    vip_title: "🌙 VIP セグメント",
    vip_mingli: "🗝 命理スペース（会員専用）",
    vip_xinlian: "🌙 心怜スペース（会員専用）",
    vip_love: "縁結び：恋愛運・結婚運",
    vip_career: "キャリア：職場発展・起業ポテンシャル",
    vip_wealth: "財運：財位分析・タイミング",
    vip_pet: "ペット命理：性格とご縁",
    vip_hepan: "合盤：結婚日・出生時刻",
    vip_name: "命名鑑定：社名・赤ちゃん名・改名",
    vip_fengshui: "財位とレイアウト：住居 / オフィス",
    vip_record: "スピリチュアル記録：写真・夢・声・祈り",
    vip_course: "講座：八字 / タロット / 占星 / 数秘 / ヒューマンデザイン",
    vip_memorial: "家族メモリアル：霊的アーカイブ & 継承",
    vip_tasks: "毎週のエナジーワーク / 神事タスク",
    vip_shop: "ストア割引 & 御守り",
    login_title: "💎 VIP ログイン",

    chat_fab: "問",
    chat_placeholder: "何を知りたいですか？（例：無料体験の始め方）",
    chat_send: "送信",
    msg_reset_ok: "パスワードを更新しました。新しいパスワードでログインしてください。",

    ph_email: "メールアドレス",
    ph_password: "パスワード（8文字以上・大/小/数字/記号）",
    ph_label_password: "パスワード",

    title_quickcalc: "八字 · クイックチャート",
    title_bazi_brief: "八字簡評",
    label_name: "名前（任意）",
    ph_name: "あなたの呼称（パーソナライズ用）",
    gender_label: "性別",
    label_calendar: "暦法",
    label_birthdate: "生年月日",
    label_birthtime: "出生時間",
    cb_time_unknown: "出生時間が不明",
    btn_generate_chart: "命盤を生成",
    panel_login_head: "アカウント ログイン / 登録",
    panel_member_head: "会員サービス",

    opt_gender_confidential: "非公開",
    opt_gender_male: "男性",
    opt_gender_female: "女性",
    opt_cal_gregorian: "太陽暦",
    opt_cal_lunar: "旧暦",

    elements_balance_tpl: "{max}が最も強く、{min}が最も弱い。",

    butler_title: "心怜バトラー · インサイト",
    day_master: "日主",
    chart_strength: "チャートの強さ",
    season: "季節",
    wuxing_distribution: "五行分布",
    note: "注意",
    time_unknown_checked: "「出生時間が不明」を選択",
    hour_pillar_excluded: "時柱は含まれていません",
    hint: "ヒント",
    no_hour_tip: "時柱なし—参考情報としてご利用ください。",
    dev_strategy: "発展戦略：",
    useful_elements: "有利な要素：",
    lucky_colors: "ラッキーカラー：",
    lucky_directions: "吉方位：",
    strength_strong: "強め",
    strength_weak: "弱め",
    strength_balanced: "バランス",
    desc_strong: "潜在力が高く、ストレス耐性が強い",
    desc_weak: "外部支援があるとより力を発揮",
    desc_balanced: "均衡が取れ、適応力が高い",
    desc_generic: "独自の特性を持つ",
    season_spring: "木が旺盛・生発",
    season_summer: "火が旺盛・表出",
    season_autumn: "金が旺盛・収斂",
    season_winter: "水が旺盛・内蔵",
    season_generic: "季節の気は一定の影響を与えます",
    el_wood: "木",
    el_fire: "火",
    el_earth: "土",
    el_metal: "金",
    el_water: "水",
    dir_wood: "東",
    dir_fire: "南",
    dir_earth: "中央/北東/南西",
    dir_metal: "西",
    dir_water: "北",
    color_wood: "緑/青緑",
    color_fire: "赤/紫",
    color_earth: "黄/茶",
    color_metal: "白/金",
    color_water: "黒/青",

    rpt_free_title: "無料サマリー",
    rpt_pillars_label: "四柱",
    rpt_daymaster_label: "日主",
    rpt_season_label: "季節",
    rpt_chart_label: "チャート",
    rpt_strategy_label: "戦略",
    rpt_wuxing_label: "五行",
    rpt_strongest_word: "が最強",
    rpt_weakest_word: "が最弱",
    rpt_absent_prefix: "欠：",
    rpt_fav_avoid_template: "有利：{fav}｜不利：{avoid}",
    rpt_balance_focus_label: "バランスの焦点",
    rpt_time_hint: "注：出生時間不明のため時柱は除外。参考としてご利用ください。",
    rpt_time_unknown: "時間不明",
    rpt_sec_overview_title: "1）概要",
    rpt_sec_elements_title: "2）五行の分析",
    rpt_sec_traits_title: "3）性質と才能",
    rpt_traits_intro: "日主・季節・強弱に基づくコア特性タグ（プレースホルダ）。",
    rpt_traits_adv: "強み：実行 / クリエイティビティ / 学習（プレースホルダ）。",
    rpt_traits_chal: "課題：ペース / 境界 / 行き過ぎ（プレースホルダ）。",
    rpt_sec_structure_title: "4）格局と喜忌",
    rpt_structure_line_template: "有利：{fav}；不利：{avoid}",
    rpt_sec_career_title: "5）キャリア（試読）",
    rpt_career_fields_placeholder: "適性分野（プレースホルダ）。",
    rpt_dev_strategy_prefix: "発展戦略：",
    rpt_sec_love_title: "6）恋愛（試読）",
    rpt_love_placeholder: "コミュニケーションのテンポと境界（プレースホルダ）。",
    rpt_sec_wealth_title: "7）財運（試読）",
    rpt_wealth_suggestion_template: "資産アドバイス：{fav}を基調に、堅実に。",
    rpt_sec_health_title: "8）健康と生活",
    rpt_health_placeholder_template: "最弱の五行（{weak}）を意識した生活と环境最適化（プレースホルダ）。",
    rpt_sec_env_title: "9）環境と色彩",
    rpt_env_placeholder: "吉方位と配色は喜用に従います。",
    rpt_strategy_drain: "洩らす/制御",
    rpt_strategy_support: "扶ける/補助",
    rpt_strategy_balance: "調和",

    chip_career: "キャリア",
    chip_love: "恋愛",
    chip_money: "財運",
    chip_list: "今日のToDo",
    chip_30d: "30日プラン",

    q_career: "日主・季節・強弱・五行比率に基づき、実践的なキャリア助言（適職/役割/直近の突破口）をください。",
    q_love: "八字を踏まえ、恋愛/結婚のアドバイス（傾向、テンポ、境界線、落とし穴と修正）をください。",
    q_money: "今後半年の財運・資産管理について、現金流/リスク配分/支出最適化を具体行動で提示してください。",
    q_list: "八字構造に基づく、今日の実行可能で測定可能なToDoを3〜5つ作ってください。",
    q_30d: "弱い五行を補う30日間のミクロ習慣（1日1つ）を簡潔に提示してください。"
  },

  "th": {
    lang_label: "ภาษา",
    btn_register: "สมัครบัญชี",
    btn_login: "เข้าสู่ระบบ",
    btn_reset: "🔑 รีเซ็ตรหัสผ่าน",
    note_price: "สมัครใหม่รับสิทธิ์ทดลองฟรี 1 ครั้ง",
    note_price1: "$9.9 / เดือน · VIP (โหราศาสตร์ + จิตวิญญาณ + คอร์สเรียน)",

    err_need_ep: "กรุณากรอกอีเมลและรหัสผ่าน",
    err_pwd_rule: "รหัสผ่านอย่างน้อย 8 ตัว ต้องมีตัวพิมพ์ใหญ่/เล็ก ตัวเลข และสัญลักษณ์",
    err_no_account: "ไม่พบบัญชี กรุณาสมัครก่อน",
    err_wrong_pwd: "รหัสผ่านไม่ถูกต้อง",
    err_expired: "สมาชิกหมดอายุ กรุณาต่ออายุ",
    err_login_fail: "เข้าสู่ระบบล้มเหลว: ",
    err_register_fail: "สมัครสมาชิกไม่สำเร็จ: ",
    err_email_empty: "อีเมลห้ามว่าง",
    err_pwd_empty: "รหัสผ่านห้ามว่าง",
    err_reset_fail: "รีเซ็ตรหัสผ่านไม่สำเร็จ: ",

    prompt_email: "กรุณากรอกอีเมลที่สมัครไว้:",
    prompt_newpwd: "กรอกรหัสผ่านใหม่ (อย่างน้อย 8 ตัว มีตัวพิมพ์ใหญ่/เล็ก ตัวเลข และสัญลักษณ์):",

    btn_upgrade: "💎 อัปเกรดเป็น VIP (รายเดือน)",
    btn_backshop: "← กลับไปยังร้านค้า",

    vip_title: "🌙 โซนสมาชิก VIP",
    vip_mingli: "🗝 ห้องโหราศาสตร์ · เฉพาะสมาชิก",
    vip_xinlian: "🌙 ห้องจิตวิญญาณ · เฉพาะสมาชิก",
    vip_love: "ความรัก: ดวงความรัก แนวโน้มการแต่งงาน",
    vip_career: "การงาน: เส้นทางอาชีพ/ผู้ประกอบการ",
    vip_wealth: "การเงิน: ทำเลทรัพย์ เวลาเหมาะสม",
    vip_pet: "ดวงสัตว์เลี้ยง: นิสัย & ความผูกพัน",
    vip_hepan: "ดวงคู่/ฤกษ์: วันแต่งงาน เวลาเกิดทารก",
    vip_name: "ตั้งชื่อ: บริษัท/ทารก/เปลี่ยนชื่อ",
    vip_fengshui: "ฮวงจุ้ยทรัพย์: บ้าน / สำนักงาน",
    vip_record: "บันทึกทางจิตวิญญาณ: รูป ฝัน เสียง คำอธิษฐาน",
    vip_course: "คอร์สเรียน: ปาจื่อ / ทาโรต์ / โหราศาสตร์ / ตัวเลข / ฮิวแมนดีไซน์",
    vip_memorial: "บันทึกครอบครัว: อนุสรณ์วิญญาณ & มรดกใจ",
    vip_tasks: "การฝึกพลังรายสัปดาห์ / พิธีกรรมเทพ",
    vip_shop: "ส่วนลดร้านค้า & เครื่องรางสั่งทำ",
    login_title: "💎 เข้าสู่ระบบ VIP",

    chat_fab: "ถาม",
    chat_placeholder: "อยากทราบเรื่องใด? (เช่น เริ่มทดลองฟรีอย่างไร)",
    chat_send: "ส่ง",
    msg_reset_ok: "อัปเดตรหัสผ่านแล้ว กรุณาเข้าสู่ระบบด้วยรหัสใหม่",

    ph_email: "อีเมล",
    ph_password: "รหัสผ่าน (≥8 ตัว รวมตัวพิมพ์ใหญ่/เล็ก ตัวเลข สัญลักษณ์)",
    ph_label_password: "รหัสผ่าน",

    title_quickcalc: "ปาจื่อ · คำนวณด่วน",
    title_bazi_brief: "ปาจื่อแบบย่อ",
    label_name: "ชื่อ (ไม่บังคับ)",
    ph_name: "ชื่อคุณ (เพื่อปรับให้เหมาะส่วนบุคคล)",
    gender_label: "เพศ",
    label_calendar: "ปฏิทิน",
    label_birthdate: "วันเกิด",
    label_birthtime: "เวลาเกิด",
    cb_time_unknown: "ไม่ทราบเวลาเกิด",
    btn_generate_chart: "สร้างดวง",
    panel_login_head: "เข้าสู่ระบบ / สมัครสมาชิก",
    panel_member_head: "บริการสมาชิก",

    opt_gender_confidential: "ไม่ระบุ",
    opt_gender_male: "ชาย",
    opt_gender_female: "หญิง",
    opt_cal_gregorian: "สุริยคติ",
    opt_cal_lunar: "จันทรคติ",

    elements_balance_tpl: "เด่นสุด: {max} · อ่อนสุด: {min}",

    butler_title: "ผู้ช่วยซินเหลียน · วิเคราะห์",
    day_master: "Day Master",
    chart_strength: "ความแข็งแรงของดวง",
    season: "ฤดูกาล",
    wuxing_distribution: "ธาตุทั้งห้า",
    note: "หมายเหตุ",
    time_unknown_checked: "เลือก “ไม่ทราบเวลาเกิด”",
    hour_pillar_excluded: "ไม่รวมเสาเวลา",
    hint: "คำแนะนำ",
    no_hour_tip: "ไม่มีเสาเวลา — ใช้เพื่ออ้างอิงเท่านั้น",
    dev_strategy: "กลยุทธ์พัฒนา: ",
    useful_elements: "ธาตุเกื้อหนุน: ",
    lucky_colors: "สีมงคล: ",
    lucky_directions: "ทิศที่เหมาะ: ",
    strength_strong: "ค่อนข้างแข็งแรง",
    strength_weak: "ค่อนข้างอ่อน",
    strength_balanced: "สมดุล",
    desc_strong: "ศักยภาพสูง ทนแรงกดดันได้ดี",
    desc_weak: "ทำได้ดีเมื่อมีการสนับสนุนภายนอก",
    desc_balanced: "สมดุลและปรับตัวได้ดี",
    desc_generic: "มีเอกลักษณ์เฉพาะตัว",
    season_spring: "ไม้เด่น งอกงาม",
    season_summer: "ไฟเด่น การแสดงออก",
    season_autumn: "โลหะเด่น จัดระเบียบ/ขัดเกลา",
    season_winter: "น้ำเด่น สงบ/สะท้อน",
    season_generic: "ฤดูกาลมีอิทธิพลต่อดวงระดับหนึ่ง",
    el_wood: "ไม้",
    el_fire: "ไฟ",
    el_earth: "ดิน",
    el_metal: "โลหะ",
    el_water: "น้ำ",
    dir_wood: "ตะวันออก",
    dir_fire: "ใต้",
    dir_earth: "กึ่งกลาง/ตอ.เฉียงเหนือ/ตต.เฉียงใต้",
    dir_metal: "ตะวันตก",
    dir_water: "เหนือ",
    color_wood: "เขียว/เขียวอมฟ้า",
    color_fire: "แดง/ม่วง",
    color_earth: "เหลือง/น้ำตาล",
    color_metal: "ขาว/ทอง",
    color_water: "ดำ/น้ำเงิน",

    rpt_free_title: "สรุปฟรี",
    rpt_pillars_label: "เสา",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "ฤดูกาล",
    rpt_chart_label: "ดวงชะตา",
    rpt_strategy_label: "กลยุทธ์",
    rpt_wuxing_label: "ธาตุทั้งห้า",
    rpt_strongest_word: "เด่นสุด",
    rpt_weakest_word: "อ่อนสุด",
    rpt_absent_prefix: "ขาด: ",
    rpt_fav_avoid_template: "เกื้อหนุน: {fav} | หลีกเลี่ยง: {avoid}",
    rpt_balance_focus_label: "จุดโฟกัสการถ่วงดุล",
    rpt_time_hint: "หมายเหตุ: ไม่ทราบเวลาเกิด ไม่รวมเสาเวลา — ใช้อ้างอิงเท่านั้น",
    rpt_time_unknown: "ไม่ทราบเวลา",
    rpt_sec_overview_title: "1) ภาพรวม",
    rpt_sec_elements_title: "2) วิเคราะห์ธาตุ",
    rpt_sec_traits_title: "3) บุคลิก & ความถนัด",
    rpt_traits_intro: "แท็กบุคลิกหลักจาก DM ฤดูกาล และความแข็งแรง (ตัวอย่าง).",
    rpt_traits_adv: "พลังเด่น: ลงมือทำ / สร้างสรรค์ / เรียนรู้ (ตัวอย่าง).",
    rpt_traits_chal: "ความท้าทาย: จังหวะ / ขอบเขต (ตัวอย่าง).",
    rpt_sec_structure_title: "4) โครงสร้าง & ความชอบ",
    rpt_structure_line_template: "เกื้อหนุน: {fav}; หลีกเลี่ยง: {avoid}",
    rpt_sec_career_title: "5) การงาน (ตัวอย่าง)",
    rpt_career_fields_placeholder: "สายงานที่เหมาะ (ตัวอย่าง).",
    rpt_dev_strategy_prefix: "กลยุทธ์พัฒนา: ",
    rpt_sec_love_title: "6) ความรัก (ตัวอย่าง)",
    rpt_love_placeholder: "จังหวะการสื่อสาร & ขอบเขต (ตัวอย่าง).",
    rpt_sec_wealth_title: "7) การเงิน (ตัวอย่าง)",
    rpt_wealth_suggestion_template: "ทิปการเงิน: เอนเอียงตาม {fav}.",
    rpt_sec_health_title: "8) สุขภาพ",
    rpt_health_placeholder_template: "ดูแลธาตุที่อ่อนที่สุด: {weak}.",
    rpt_sec_env_title: "9) สิ่งแวดล้อม & สีสัน",
    rpt_env_placeholder: "ทิศและโทนสีที่ส่งเสริมสอดคล้องกับธาตุเกื้อหนุน.",
    rpt_strategy_drain: "ระบาย/ควบคุม",
    rpt_strategy_support: "เสริม/เกื้อหนุน",
    rpt_strategy_balance: "ถ่วงดุล",

    chip_career: "การงาน",
    chip_love: "ความรัก",
    chip_money: "การเงิน",
    chip_list: "สิ่งต้องทำวันนี้",
    chip_30d: "แผน 30 วัน",

    q_career: "อ้างอิง Day Master ฤดูกาล ความแข็งแรง และสัดส่วนธาตุ ให้คำแนะนำอาชีพที่ปฏิบัติได้จริง",
    q_love: "อ้างอิงดวงปาจื่อ ให้คำแนะนำความรัก/แต่งงาน จังหวะการสื่อสาร ขอบเขต และจุดพลาด",
    q_money: "อ้างอิงดวงปาจื่อ ให้คำแนะนำการเงิน 6 เดือนหน้า กระแสเงินสด สัดส่วนเสี่ยง-ปลอดภัย และรายการปรับรายจ่าย",
    q_list: "สร้างสิ่งต้องทำวันนี้ 3–5 ข้อ ให้ปฏิบัติได้ วัดผลได้ พร้อมเวลาแนะนำ",
    q_30d: "ใช้ธาตุที่อ่อน ออกแบบแผน 30 วัน (วันละ 1 อย่าง) เพื่อถ่วงดุล"
  },

  "ms": {
    lang_label: "Bahasa",
    btn_register: "Daftar Akaun",
    btn_login: "Log Masuk",
    btn_reset: "🔑 Tetapkan Semula Kata Laluan",
    note_price: "Daftar akaun baharu untuk satu percubaan percuma",
    note_price1: "$9.9 / bulan · VIP (Ruang Astro + Soul Sanctuary + Kursus)",

    err_need_ep: "Masukkan emel dan kata laluan",
    err_pwd_rule: "Kata laluan mestilah 8+ aksara serta ada huruf besar/kecil, nombor, simbol",
    err_no_account: "Akaun tidak ditemui. Sila daftar dahulu.",
    err_wrong_pwd: "Kata laluan tidak sah",
    err_expired: "Keahlian tamat tempoh. Sila perbaharui.",
    err_login_fail: "Gagal log masuk: ",
    err_register_fail: "Gagal mendaftar: ",
    err_email_empty: "Emel tidak boleh kosong",
    err_pwd_empty: "Kata laluan tidak boleh kosong",
    err_reset_fail: "Tetapan semula gagal: ",

    prompt_email: "Masukkan emel berdaftar anda:",
    prompt_newpwd: "Masukkan kata laluan baharu (8+, huruf besar/kecil/nombor/simbol):",

    btn_upgrade: "💎 Naik Taraf ke VIP (Bulanan)",
    btn_backshop: "← Kembali ke Kedai",

    vip_title: "🌙 Segmen VIP",
    vip_mingli: "🗝 Ruang Astro · Eksklusif",
    vip_xinlian: "🌙 Soul Sanctuary · Eksklusif",
    vip_love: "Cinta: Jodoh & Arah Perkahwinan",
    vip_career: "Kerjaya: Perkembangan & Usahawan",
    vip_wealth: "Kekayaan: Kedudukan Harta & Masa",
    vip_pet: "Nasib Haiwan: Perangai & Ikatan",
    vip_hepan: "Keserasian: Tarikh Nikah, Waktu Lahir",
    vip_name: "Analisis Nama: Syarikat/Bayi/Penamaan Semula",
    vip_fengshui: "Kedudukan Harta & Susun Atur: Rumah / Pejabat",
    vip_record: "Log Spiritual: Foto, Mimpi, Suara, Doa",
    vip_course: "Kursus: Bazi / Tarot / Astrologi / Nombor / Human Design",
    vip_memorial: "Peringatan Keluarga: Arkib Rohani & Legasi",
    vip_tasks: "Amalan Tenaga Mingguan / Tugas Ritual",
    vip_shop: "Diskaun Kedai & Omamori",
    login_title: "💎 Log Masuk VIP",

    chat_fab: "Chat",
    chat_placeholder: "Apa yang anda mahu tahu? (cth: cara mula percubaan percuma)",
    chat_send: "Hantar",
    msg_reset_ok: "Kata laluan dikemas kini. Log masuk dengan yang baharu.",

    ph_email: "Emel",
    ph_password: "Kata Laluan (8+, huruf besar/kecil/nombor/simbol)",
    ph_label_password: "Kata Laluan",

    title_quickcalc: "Bazi · Carta Pantas",
    title_bazi_brief: "Bazi · Ringkasan",
    label_name: "Nama (pilihan)",
    ph_name: "Nama anda (untuk personalisasi)",
    gender_label: "Jantina",
    label_calendar: "Kalendar",
    label_birthdate: "Tarikh Lahir",
    label_birthtime: "Masa Lahir",
    cb_time_unknown: "Masa lahir tidak diketahui",
    btn_generate_chart: "Jana Carta",
    panel_login_head: "Log Masuk / Daftar Akaun",
    panel_member_head: "Perkhidmatan Keahlian",

    opt_gender_confidential: "Rahsia",
    opt_gender_male: "Lelaki",
    opt_gender_female: "Perempuan",
    opt_cal_gregorian: "Gregorian",
    opt_cal_lunar: "Lunar",

    elements_balance_tpl: "Terkuat: {max} · Terlemah: {min}",

    butler_title: "Xinlian Butler · Insight",
    day_master: "Day Master",
    chart_strength: "Kekuatan Carta",
    season: "Musim",
    wuxing_distribution: "Lima Unsur",
    note: "Nota",
    time_unknown_checked: "“Masa lahir tidak diketahui” dipilih",
    hour_pillar_excluded: "Tiang jam tidak disertakan",
    hint: "Petua",
    no_hour_tip: "Tiada tiang jam — rujukan sahaja.",
    dev_strategy: "Strategi pembangunan: ",
    useful_elements: "Unsur baik: ",
    lucky_colors: "Warna bertuah: ",
    lucky_directions: "Arah bertuah: ",
    strength_strong: "Cenderung kuat",
    strength_weak: "Cenderung lemah",
    strength_balanced: "Seimbang",
    desc_strong: "Potensi tinggi, tahan tekanan",
    desc_weak: "Lebih baik dengan sokongan luar",
    desc_balanced: "Seimbang dan mudah menyesuaikan",
    desc_generic: "Mempunyai ciri tersendiri",
    season_spring: "Kayu kuat; pertumbuhan",
    season_summer: "Api kuat; ekspresi",
    season_autumn: "Logam kuat; pengumpulan/penyusunan",
    season_winter: "Air kuat; penjimatan/refleksi",
    season_generic: "Tenaga musim memberi sedikit pengaruh",
    el_wood: "Kayu",
    el_fire: "Api",
    el_earth: "Tanah",
    el_metal: "Logam",
    el_water: "Air",
    dir_wood: "Timur",
    dir_fire: "Selatan",
    dir_earth: "Tengah/Timur Laut/Barat Daya",
    dir_metal: "Barat",
    dir_water: "Utara",
    color_wood: "Hijau/Teal",
    color_fire: "Merah/Ungu",
    color_earth: "Kuning/Coklat",
    color_metal: "Putih/Emas",
    color_water: "Hitam/Biru",

    rpt_free_title: "Ringkasan Percuma",
    rpt_pillars_label: "Empat Tiang",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "Musim",
    rpt_chart_label: "Carta",
    rpt_strategy_label: "Strategi",
    rpt_wuxing_label: "Lima Unsur",
    rpt_strongest_word: "paling kuat",
    rpt_weakest_word: "paling lemah",
    rpt_absent_prefix: "Tiada: ",
    rpt_fav_avoid_template: "Unsur baik: {fav} | Elak: {avoid}",
    rpt_balance_focus_label: "Fokus keseimbangan",
    rpt_time_hint: "Nota: masa lahir tidak diketahui; tiang jam dikecualikan — rujukan sahaja.",
    rpt_time_unknown: "Masa tidak diketahui",
    rpt_sec_overview_title: "1) Gambaran Umum",
    rpt_sec_elements_title: "2) Analisis Unsur",
    rpt_sec_traits_title: "3) Sifat & Bakat",
    rpt_traits_intro: "Tag sifat teras berdasarkan DM, musim, dan kekuatan (placeholder).",
    rpt_traits_adv: "Kelebihan: Pelaksanaan / Kreativiti / Pembelajaran (placeholder).",
    rpt_traits_chal: "Cabaran: Tempo / Sempadan / Berlebihan (placeholder).",
    rpt_sec_structure_title: "4) Struktur & Kecenderungan",
    rpt_structure_line_template: "Baik: {fav}; Elak: {avoid}",
    rpt_sec_career_title: "5) Kerjaya (contoh)",
    rpt_career_fields_placeholder: "Bidang yang sesuai (placeholder).",
    rpt_dev_strategy_prefix: "Strategi pembangunan: ",
    rpt_sec_love_title: "6) Cinta (contoh)",
    rpt_love_placeholder: "Tempo komunikasi & sempadan (placeholder).",
    rpt_sec_wealth_title: "7) Kekayaan (contoh)",
    rpt_wealth_suggestion_template: "Tip kekayaan: utamakan aliran yang sejajar dengan {fav}.",
    rpt_sec_health_title: "8) Kesihatan",
    rpt_health_placeholder_template: "Jaga unsur paling lemah: {weak}.",
    rpt_sec_env_title: "9) Persekitaran & Warna",
    rpt_env_placeholder: "Arah & palet yang baik mengikuti unsur pilihan anda.",
    rpt_strategy_drain: "Leraikan/Kawal",
    rpt_strategy_support: "Sokong/Perkuat",
    rpt_strategy_balance: "Seimbangkan",

    chip_career: "Kerjaya",
    chip_love: "Cinta",
    chip_money: "Kewangan",
    chip_list: "Tugas Hari Ini",
    chip_30d: "Pelan 30 Hari",

    q_career: "Guna day master, musim, kekuatan & nisbah unsur saya untuk nasihat kerjaya yang praktikal.",
    q_love: "Berdasar Bazi, beri nasihat hubungan/perkahwinan: tempo komunikasi, sempadan, perangkap & pembaikan.",
    q_money: "Berdasar Bazi, nasihat kewangan 6 bulan akan datang: aliran tunai, nisbah risiko/selamat, tindakan bajet.",
    q_list: "Berdasar struktur Bazi saya, buat 3–5 tugasan harian yang boleh dilaksana & diukur.",
    q_30d: "Guna unsur paling lemah, reka pelan mikro 30 hari (1/hari) untuk imbangan."
  }
};

function t(key){
  const L = translations[getLang()] || translations["zh-CN"];
  return L[key] || (translations["zh-CN"][key] || key);
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
function ELABEL(){
  return {
    wood:  t('el_wood'),
    fire:  t('el_fire'),
    earth: t('el_earth'),
    metal: t('el_metal'),
    water: t('el_water'),
  };
}

<!-- ============ 浮窗 Chat UI（DOM） ============ -->
<div class="ss-chat-fab" id="chatFab" aria-label="Chat" title="Chat">
  <span data-i18n="chat_fab">问</span>
</div>
<div class="ss-chat-panel" id="chatPanel" role="dialog" aria-modal="true" aria-labelledby="chatTitle">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="butler_title">心怜管家 · 解读</div>
    <div class="ss-close" id="chatClose" aria-label="Close">✕</div>
  </div>
  <div class="ss-chat-body" id="chatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="chatInput" placeholder="" data-i18n-ph="chat_placeholder" />
    <button class="btn" id="chatSend" type="button" data-i18n="chat_send">发送</button>
  </div>
</div>

<!-- ============ Butler AI 卡片（芯片/锁定/多语言） ============ -->
<script>
/* ——— 说明 ———
   - 自包含；直接替换到文件末尾即可
   - 依赖已存在：t()/getLang()/setLang()/applyI18n()/ELABEL()/API_BASE
   - 支持 VIP 预览锁；多语言；语言切换自动重渲染
*/
(() => {
  'use strict';

  const BUTLER_LANG_NAME = {
    'zh-CN': 'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };
  const qs = (sel)=>document.querySelector(sel);
  const isVIP = () => (localStorage.getItem('vipStatus') === 'active') || !!localStorage.getItem('vipEmail');
  const nowLang = () => (typeof getLang==='function'?getLang(): (document.documentElement.lang||'zh-CN'));
  const LNAME = () => BUTLER_LANG_NAME[nowLang()] || BUTLER_LANG_NAME['zh-CN'];

  function mdToHtml(md=''){
    return String(md)
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n').replace(/\n/g,'<br/>');
  }
  function safeCtx(){
    const ctx = (window.__last_report__ && typeof window.__last_report__==='object') ? window.__last_report__ : {};
    const def = { pillars:{}, percents:{}, st:{}, adv:{}, timeUnknown:false };
    return Object.assign(def, ctx);
  }
  function strongWeak(percents={}){
    const arr = [['wood',percents.wood??0],['fire',percents.fire??0],['earth',percents.earth??0],['metal',percents.metal??0],['water',percents.water??0]];
    const strongest = arr.reduce((a,b)=> a[1]>=b[1]?a:b)[0];
    const weakest   = arr.reduce((a,b)=> a[1]<=b[1]?a:b)[0];
    return { strongest, weakest };
  }

  // 样式（只注一次）
  (function injectStyle(){
    if (document.getElementById('ai-style')) return;
    const s=document.createElement('style'); s.id='ai-style';
    s.textContent = `
      .ai-card .ai-content{white-space:pre-wrap;line-height:1.7}
      .ai-card .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
      .ai-card .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
      .ai-card .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
      .ai-card .skeleton{display:grid;gap:8px}
      .ai-card .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
      @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
      .ai-lock-overlay{position:static;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
      .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
      .ai-lock-overlay .sub{color:var(--muted)}
    `;
    document.head.appendChild(s);
  })();

  // 卡片渲染
  function ensureAiCard(){
    const host = document.getElementById('result') || document.body;
    let card = document.getElementById('aiCard');
    if (card && card.parentElement !== host) host.appendChild(card);
    if (card) return card;
    card = document.createElement('div');
    card.className='sec ai-card'; card.id='aiCard';
    card.innerHTML = `
      <h3 id="butlerTitle">${t('butler_title') || '心怜管家 · 解读'}</h3>
      <div id="aiContent" class="ai-content">
        <div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div></div>
      </div>
      <div class="chips" id="aiChips"></div>`;
    host.appendChild(card); renderChips(); return card;
  }
  function mainLabel(){
    const L = nowLang();
    if (L.startsWith('zh')) return '主（当前渲染资料）';
    if (L==='en') return 'Main (Current Data)';
    if (L==='ja') return '主（現在のデータ）';
    if (L==='th') return 'หลัก (ข้อมูลปัจจุบัน)';
    if (L==='ms') return 'Utama (Data Semasa)';
    return 'Main';
  }
  function renderChips(){
    const wrap = document.getElementById('aiChips'); if(!wrap) return; wrap.innerHTML='';
    const items = [
      { label: mainLabel(), topic:'current' },
      { label: t('chip_career'), topic:'career', q:t('q_career') },
      { label: t('chip_love'),   topic:'love',   q:t('q_love')   },
      { label: t('chip_money'),  topic:'money',  q:t('q_money')  },
      { label: t('chip_list'),   topic:'list',   q:t('q_list')   },
      { label: t('chip_30d'),    topic:'30d',    q:t('q_30d')    },
    ];
    items.forEach(it=>{
      const b=document.createElement('button'); b.className='chip'; b.textContent=it.label||'';
      if (it.q) b.dataset.q = it.q; b.dataset.topic = it.topic; wrap.appendChild(b);
    });
  }

  // 构建提示
  function buildSystemPrompt(){
    return [
      `You are a concise Bazi assistant. Reply in ${LNAME()}.`,
      `- Use short paragraphs/bullets; be concrete & actionable.`,
      `- If hour pillar is missing, include a brief caution.`,
      `- Avoid deterministic predictions; describe tendencies + tips.`,
      `- Mirror the user's language tone.`
    ].join('\n');
  }
  function buildUserPrompt(taskText, topicType, ctx){
    const { pillars={}, percents={}, st={}, adv={}, timeUnknown } = ctx;
    const E = ELABEL ? ELABEL() : {wood:'Wood',fire:'Fire',earth:'Earth',metal:'Metal',water:'Water'};
    const elemLine = [
      `${E.wood} ${Math.round(percents.wood||0)}%`,
      `${E.fire} ${Math.round(percents.fire||0)}%`,
      `${E.earth} ${Math.round(percents.earth||0)}%`,
      `${E.metal} ${Math.round(percents.metal||0)}%`,
      `${E.water} ${Math.round(percents.water||0)}%`,
    ].join(' · ');
    const fav=(adv?.useful||[]).join('/'); const avoid=(adv?.avoid||[]).join('/');
    const hourTxt = timeUnknown ? (t('rpt_time_unknown') || '时间不详')
      : `${pillars?.hour?.stem||''}${pillars?.hour?.branch||''}`;
    return [
      `Bazi summary:`,
      `Year ${pillars?.year?.stem||''}${pillars?.year?.branch||''} · Month ${pillars?.month?.stem||''}${pillars?.month?.branch||''} · Day ${pillars?.day?.stem||''}${pillars?.day?.branch||''} · Hour ${hourTxt||''}`,
      `Day Master: ${pillars?.day?.stem||''} (${pillars?.day?.element||''})`,
      `Season: ${st?.season||''}; Strength: ${st?.mark||''}; Strategy: ${st?.focus||''}`,
      `Elements: ${elemLine}`,
      `Favorable: ${fav||'-'}; Avoid: ${avoid||'-'}`,
      timeUnknown ? `Caution: hour pillar excluded.` : ``,
      ``,
      `TaskType: ${topicType||'generic'}`,
      `Task: ${taskText||topicType||'overview'}`,
      `Language: ${LNAME()}. Reply ONLY in ${LNAME()}.`
    ].filter(Boolean).join('\n');
  }

  // AI 调用
  let aiAbort=null;
  async function aiChat(messages,{timeout=15000}={}){
    if (aiAbort) aiAbort.abort(); aiAbort=new AbortController();
    const url=`${(typeof API_BASE!=='undefined'?API_BASE:'')}/api/chat`;
    const to=setTimeout(()=>aiAbort.abort(),timeout);
    try{
      const resp=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},mode:'cors',body:JSON.stringify({messages})});
      const raw=await resp.text(); clearTimeout(to);
      let data; try{ data = raw ? JSON.parse(raw) : {}; }catch{ data={ok:false,raw}; }
      return { ok:resp.ok, data };
    }catch(e){ clearTimeout(to); return { ok:false, data:{ msg:e?.name==='AbortError'?'timeout':(e?.message||'network_error') } }; }
  }
  function extractAIText(data){
    if (!data) return ''; if (typeof data==='string') return data.trim();
    if (data.reply) return String(data.reply).trim();
    if (data.text) return String(data.text).trim();
    if (data.output) return String(data.output).trim();
    if (Array.isArray(data.choices) && data.choices[0]){
      const c=data.choices[0];
      if (c.message?.content) return String(c.message.content).trim();
      if (c.delta?.content) return String(c.delta.content).trim();
    }
    if (Array.isArray(data.candidates) && data.candidates[0]){
      const parts=data.candidates[0].content?.parts || data.candidates[0].content || [];
      const txt=(Array.isArray(parts)?parts.map(p=>p.text||'').join('\n'):'');
      if (txt.trim()) return txt.trim();
    }
    return '';
  }

  // 兜底
  function localFallback(topicType, ctx){
    const { percents={}, timeUnknown }=ctx;
    const label = ELABEL ? ELABEL() : {wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
    const { strongest, weakest } = strongWeak(percents);
    const kv=[[label.wood,Math.round(percents.wood||0)],[label.fire,Math.round(percents.fire||0)],[label.earth,Math.round(percents.earth||0)],[label.metal,Math.round(percents.metal||0)],[label.water,Math.round(percents.water||0)]];
    const caution = timeUnknown ? (t('rpt_time_hint') || '提示：出生时间不详，未纳入时柱，仅供参考。') : '';
    const head=`**${t('butler_title')||'心怜管家 · 解读'}**`;
    const five=`- ${t('rpt_wuxing_label')||'五行分布'}：`+kv.map(([k,v])=>`${k} ${v}%`).join(' · ');
    const bal=`- ${t('rpt_balance_focus_label')||'调衡要点'}：${label[strongest]||strongest} ${t('rpt_strongest_word')||'偏旺'}；${label[weakest]||weakest} ${t('rpt_weakest_word')||'偏弱'}`;
    const strategy=['',`${t('rpt_strategy_label')||'策略'}`,`- ${t('rpt_strategy_support')||'生扶/补助'}：围绕“${label[weakest]||weakest}”做环境与作息补强。`,`- ${t('rpt_strategy_drain')||'泄秀/制化'}：适度分配“${label[strongest]||strongest}”相关活动，避免过犹不及。`].join('\n');
    if (topicType==='career') return [head,five,bal,caution,'','**事业 · 快速建议**','- 方向：围绕喜用展开，避开忌。','- 角色：强项用于开拓/交付；弱项以流程/SOP 守护。','- 突破：2周内可交付的小项目，用强项切入，沉淀2条 SOP。',strategy].join('\n');
    if (topicType==='love')   return [head,five,bal,caution,'','**感情 · 快速建议**','- 节奏：沟通前先肯定强项；谈边界时照顾弱项需求。','- 场景：约会选择有利“喜用”的环境，减少“忌”的触发。',strategy].join('\n');
    if (topicType==='money')  return [head,five,bal,caution,'','**财运 · 快速建议**','- 安全垫：3–6个月现金流。','- 配比：进取 : 稳健 ≈ 7:3（按自身调整）。','- 变现：强项赛道做优势变现；弱项用规则控风控。',strategy].join('\n');
    if (topicType==='list')   return [head,five,bal,caution,'','**今日待办 · 3–5条**','1) 用强项完成一个30分钟可交付成果。','2) 针对弱项做10分钟补强（学习/整理/复盘）。','3) 清理一个遗留小坑（≤15分钟）。','4) 晚间复盘：记录1条可复用 SOP。',strategy].join('\n');
    if (topicType==='30d')    return [head,five,bal,caution,'','**30天建议 · 纲要**','- 第1周：围绕弱项做5–10分钟日练。','- 第2周：强项产出，每天一个小成果。','- 第3周：建立2条守弱项的 SOP。','- 第4周：复盘优化 + 小结展示。',strategy].join('\n');
    return [head,five,bal,caution,'',`${t('dev_strategy')||'发展策略'}：`,`- ${t('chip_career')||'事业'}：强项发力，流程守弱项。`,`- ${t('chip_money')||'财运'}：把控现金流；预留机动。`,`- ${t('chip_love')||'感情'}：先肯定强项，再谈节奏与边界。`].join('\n');
  }

  // 主视图
  function renderCurrent(){
    ensureAiCard(); const out=document.getElementById('aiContent'); if(!out) return;
    const ctx=safeCtx(); const { pillars={}, percents={}, st={}, adv={}, timeUnknown }=ctx;
    const E= ELABEL?ELABEL():{wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
    const elemLine=[`${E.wood} ${Math.round(percents.wood||0)}%`,`${E.fire} ${Math.round(percents.fire||0)}%`,`${E.earth} ${Math.round(percents.earth||0)}%`,`${E.metal} ${Math.round(percents.metal||0)}%`,`${E.water} ${Math.round(percents.water||0)}%`].join(' · ');
    const hourTxt=timeUnknown ? (t('rpt_time_unknown')||'时间不详') : `${pillars?.hour?.stem||''}${pillars?.hour?.branch||''}`;
    const md=[`### ${nowLang().startsWith('zh')?'当前渲染资料':'Current Context'}`,`- 年柱：${(pillars?.year?.stem||'')}${(pillars?.year?.branch||'')}`,`- 月柱：${(pillars?.month?.stem||'')}${(pillars?.month?.branch||'')}`,`- 日柱：${(pillars?.day?.stem||'')}${(pillars?.day?.branch||'')}`,`- 时柱：${hourTxt}`,`- 季节/强弱：${st?.season||''} / ${st?.mark||''}`,`- 策略：${st?.focus||''}`,`- 五行：${elemLine}`,(adv?.useful?.length || adv?.avoid?.length)?`- 喜用/忌：${(adv.useful||[]).join('/') || '-'} / ${(adv.avoid||[]).join('/') || '-'}`:'' ].filter(Boolean).join('\n');
    out.innerHTML = mdToHtml(md);
    const aiCard=document.getElementById('aiCard');
    aiCard.dataset.lastTopic='current'; aiCard.dataset.lastQ='__current__'; aiCard.dataset.lang=nowLang();
  }

  // 专题渲染
  async function renderTopic(topicType,qText){
    ensureAiCard();
    const out=document.getElementById('aiContent'); if(!out) return;
    const chips=document.getElementById('aiChips');
    out.innerHTML=`<div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div></div>`;
    chips?.querySelectorAll('.chip').forEach(c=>{ c.disabled=true; c.style.opacity=.6; });
    const ctx=safeCtx(); const sys=buildSystemPrompt(); const user=buildUserPrompt(qText||topicType,topicType,ctx);
    try{
      const {ok,data}=await aiChat([{role:'system',content:sys},{role:'user',content:user}],{timeout:15000});
      let text= ok?extractAIText(data):''; if(!text) text=localFallback(topicType,ctx);
      if (!isVIP() && topicType!=='current'){
        const teaser=text.split('\n').slice(0,6).join('\n');
        out.innerHTML = mdToHtml(teaser)+`<div class="ai-lock-overlay"><div class="tip">💎 ${t('vip_title')||'VIP Segment'}</div><div class="sub">${nowLang().startsWith('zh')?'登录/升级后解锁完整解读':'Log in / upgrade to unlock the full guidance.'}</div></div>`;
      }else{
        out.innerHTML = mdToHtml(text);
      }
    }catch{
      out.innerHTML = mdToHtml(localFallback(topicType, ctx));
    }finally{
      chips?.querySelectorAll('.chip').forEach(c=>{ c.disabled=false; c.style.opacity=1; });
      const aiCard=document.getElementById('aiCard');
      aiCard.dataset.lastTopic = topicType||'generic';
      aiCard.dataset.lastQ = qText||'';
      aiCard.dataset.lang = nowLang();
    }
  }

  // 免费区块
  function buildFreeReportHTML(ctx){
    const label = ELABEL?ELABEL():{wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
    const { percents={}, timeUnknown }=ctx||{};
    const { weakest }=strongWeak(percents);
    const hint=timeUnknown ? (t('rpt_time_hint') || '提示：出生时间不详，未纳入时柱，仅供参考。') : '';
    return `<div class="report"><div class="sec"><h3>${t('rpt_free_title')||'免费简报'}</h3>${hint?`<p class="muted">${hint}</p>`:''}<p>${(t('rpt_health_placeholder_template')||'围绕最弱五行（{weak}）做作息与环境优化').replace('{weak}',label[weakest]||weakest||'-')}</p></div></div>`;
  }
  window.mountExtensionsIntoResult=function(ctx){
    const r=document.getElementById('result'); if(!r) return;
    let free=document.getElementById('xl-free-report');
    if (!free){ free=document.createElement('div'); free.id='xl-free-report'; r.appendChild(free); }
    free.innerHTML = buildFreeReportHTML(ctx||safeCtx());
  };

  // 首屏挂载
  window.mountButlerCard=function(){ ensureAiCard(); renderCurrent(); };

  // 事件
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.chip'); if(!btn) return;
    const topic=btn.dataset.topic||'current';
    if (topic==='current'){ renderCurrent(); return; }
    const q=btn.dataset.q||topic; renderTopic(topic,q);
  });
  document.addEventListener('DOMContentLoaded',()=>{
    const sel=document.getElementById('langSelect');
    if (sel){
      try{ sel.value = nowLang(); }catch{}
      sel.addEventListener('change',(e)=>{
        if (typeof setLang==='function') setLang(e.target.value);
        if (typeof applyI18n==='function') applyI18n();
        if (typeof window.rerenderReportsIfAny==='function') window.rerenderReportsIfAny();
      });
    }
    try{ if (typeof applyI18n==='function') applyI18n(); }catch{}
    try{ window.mountButlerCard(); }catch{}
  });
  window.rerenderReportsIfAny=function(){
    const titleEl=document.getElementById('butlerTitle'); if (titleEl) titleEl.textContent = t('butler_title') || '心怜管家 · 解读';
    renderChips();
    const aiCard=document.getElementById('aiCard'); if(!aiCard) return;
    const lastTopic=aiCard.dataset.lastTopic||'current'; const lastQ=aiCard.dataset.lastQ||'';
    const prevLang=aiCard.dataset.lang||''; const curLang=nowLang();
    if (prevLang!==curLang){
      aiCard.dataset.lang=curLang;
      if (lastTopic==='current' || !lastQ) renderCurrent(); else renderTopic(lastTopic,lastQ);
    }
  };

  // 给浮窗复用的轻量 API
  window.ButlerAPI = {
    chat: aiChat,
    extract: extractAIText,
    sysPrompt: buildSystemPrompt,
    userPrompt: (text, topic, ctx)=>buildUserPrompt(text, topic, ctx),
    safeCtx, mdToHtml
  };
})();
</script>

<!-- ============ 浮窗 Chat 控制脚本 ============ -->
<script>
(function(){
  const fab   = document.getElementById('chatFab');
  const panel = document.getElementById('chatPanel');
  const close = document.getElementById('chatClose');
  const body  = document.getElementById('chatBody');
  const input = document.getElementById('chatInput');
  const send  = document.getElementById('chatSend');

  function toggle(open){ panel.style.display = open ? 'block' : 'none'; if (open) setTimeout(()=>input.focus(), 50); }
  function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  function append(role, html){
    const div=document.createElement('div');
    div.className='ss-msg'+(role==='me'?' me':'');
    div.innerHTML=html;
    body.appendChild(div);
    body.scrollTop=body.scrollHeight;
    return div;
  }

  async function doSend(){
    const text = input.value.trim(); if (!text) return;
    append('me', escHtml(text).replace(/\n/g,'<br/>'));
    input.value='';

    const thinking = append('bot', '…');
    try{
      const ctx = (window.ButlerAPI && ButlerAPI.safeCtx) ? ButlerAPI.safeCtx() : {};
      const sys = (window.ButlerAPI && ButlerAPI.sysPrompt) ? ButlerAPI.sysPrompt() : 'You are a concise Bazi assistant.';
      const user= (window.ButlerAPI && ButlerAPI.userPrompt) ? ButlerAPI.userPrompt(text, 'ask', ctx) : text;

      const out = await window.ButlerAPI.chat([{role:'system',content:sys},{role:'user',content:user}], { timeout:15000 });
      let reply = out.ok ? window.ButlerAPI.extract(out.data) : '';
      if (!reply) reply = '（网络异常，请稍后再试）';
      thinking.innerHTML = window.ButlerAPI.mdToHtml ? window.ButlerAPI.mdToHtml(reply) : escHtml(reply).replace(/\n/g,'<br/>');
    }catch(e){
      thinking.textContent = '（发送失败）';
    }
  }

  fab?.addEventListener('click', ()=>toggle(true));
  close?.addEventListener('click', ()=>toggle(false));
  send?.addEventListener('click', doSend);
  input?.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }});

  // 多语言占位更新
  document.addEventListener('DOMContentLoaded', ()=>{ try{ applyI18n(); }catch{} });
})();
</script>

</body>
</html>
