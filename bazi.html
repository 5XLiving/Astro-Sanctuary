<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* å¤´éƒ¨æ ·å¼ */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* å…«å­—æŸ±æ ·å¼ */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* äº”è¡Œèƒ½é‡æ¡ */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* æ—¶é—´è¾“å…¥è¡Œ */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* ç”ŸæˆæŒ‰é’®åŒ…è£… */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* è¯¦ç»†åˆ†æåŒºåŸŸ */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* å¤§è¿æµå¹´ */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* ä¼šå‘˜åŒºåŸŸ */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AIç®¡å®¶æ ·å¼ */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* èŠå¤©æµ®çª— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:9999;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e; transition:all 0.2s ease
    }
    .ss-chat-fab:hover{transform:scale(1.05); box-shadow:0 12px 35px rgba(230,199,110,.6)}
    
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:10000;width:min(360px,90vw);display:none;
      background:#0b111a;border:1px solid #1f2a36;border-radius:14px;box-shadow:var(--shadow); overflow:hidden
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2a36; color:#ffd88a; font-weight:700}
    .ss-close{cursor:pointer;opacity:.8; padding:5px;}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px; min-height:200px;}
    .ss-msg{padding:8px 10px;background:#0f1824;border:1px solid #1f2a36;border-radius:10px;margin:6px 0;max-width:85%; word-break:break-word;}
    .ss-msg.me{margin-left:auto;background:#132033; border-color:#263244}
    .ss-chat-input{display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid #1f2a36; background:#0e1520;}
    .ss-chat-input input{flex:1; min-width:0; background:#0b111a; border:1px solid #1f2a36; border-radius:8px; padding:8px; color:#e8edf3;}
    .ss-chat-input .btn{padding:8px 12px; white-space:nowrap;}
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .ss-chat-panel{width:90vw; right:5vw;}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç®€è¯„</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- å…«å­—æ’ç›˜è¡¨å• -->
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender">
          <option value="">ä¸é€éœ²</option>
          <option value="male">ç”·æ€§</option>
          <option value="female">å¥³æ€§</option>
        </select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar">
          <option value="gregorian">é˜³å†</option>
          <option value="lunar">å†œå†</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <div class="time-row">
          <input type="time" id="birthtime" value="12:00" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- è¯¦ç»†åˆ†æåŒºåŸŸ -->
    <div class="card">
      <div class="h2">ğŸ§™â€â™‚ï¸ å‘½ä¸»åŸºæœ¬ä¿¡æ¯</div>
      <div id="basic-info" class="analysis-content"></div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>ğŸ” æ€»ä½“å‘½è¿è§£è¯»</h3>
        <div id="overall-destiny" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’¼ äº‹ä¸šåˆ†æ</h3>
        <div id="career-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>ğŸ’° è´¢å¯ŒçŠ¶å†µ</h3>
        <div id="wealth-analysis" class="analysis-content"></div>
      </div>
      
      <div class="analysis-card">
        <h3>â¤ï¸ å©šå§»æ„Ÿæƒ…</h3>
        <div id="marriage-analysis" class="analysis-content"></div>
      </div>
    </div>

    <!-- å¤§è¿æµå¹´ -->
    <div class="card">
      <div class="h2">ğŸ“ˆ å¤§è¿æµå¹´åˆ†æ</div>
      <div class="luck-grid" id="luck-analysis"></div>
    </div>

    <!-- AIç®¡å®¶åŒºåŸŸ -->
    <div id="aiCard" class="ai-box">
      <div class="ai-box-h" id="butlerTitle">å¿ƒæ€œç®¡å®¶ Â· æ·±åº¦è§£è¯»</div>
      <div class="ai-box-c" id="aiContent">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>
    </div>
  </section>

  <!-- ä¼šå‘˜åŒºåŸŸ -->
  <section class="card section">
    <h2 class="group-title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li>äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li>è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li>å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li>çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li>å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
          <li>å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li>æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- èŠå¤©æµ®çª— -->
<button class="ss-chat-fab" id="ssChatFab">é—®</button>
<div class="ss-chat-panel" id="ssChatPanel">
  <div class="ss-chat-head">
    <div class="ss-chat-title">5X Â· æ™ºèƒ½åŠ©æ‰‹</div>
    <div class="ss-close" id="ssChatClose">âœ•</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" placeholder="è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ" />
    <button class="btn" id="ssChatSend">å‘é€</button>
  </div>
</div>

<script>
// ä¸“ä¸šå…«å­—è®¡ç®—ç±» - ä¿®æ­£ç®—æ³•
class ProfessionalBaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  // ä¿®æ­£å¹´æŸ±è®¡ç®—
  calculateYearPillar(year) {
    // ç”²å­å¹´å¼€å§‹äº1924å¹´ï¼Œæ¯60å¹´ä¸€ä¸ªå¾ªç¯
    const startYear = 1924;
    const cycleIndex = (year - startYear) % 60;
    const stemIndex = cycleIndex % 10;
    const branchIndex = cycleIndex % 12;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIndex],
      branch: this.EARTHLY_BRANCHES[branchIndex]
    };
  }

  // ä¿®æ­£æœˆæŸ±è®¡ç®—
  calculateMonthPillar(year, month, day) {
    // æ ¹æ®èŠ‚æ°”ç¡®å®šæœˆä»½çš„åœ°æ”¯
    const jieqiMap = {
      1: 'å¯…', 2: 'å¯', 3: 'è¾°', 4: 'å·³', 5: 'åˆ', 6: 'æœª',
      7: 'ç”³', 8: 'é…‰', 9: 'æˆŒ', 10: 'äº¥', 11: 'å­', 12: 'ä¸‘'
    };
    
    const branch = jieqiMap[month] || 'å¯…';
    
    // æ ¹æ®å¹´å¹²ç¡®å®šæœˆå¹²
    const yearStem = this.calculateYearPillar(year).stem;
    const yearStemIdx = this.HEAVENLY_STEMS.indexOf(yearStem);
    
    // äº”è™éè¯€ï¼šç”²å·±ä¹‹å¹´ä¸™ä½œé¦–ï¼Œä¹™åºšä¹‹å²æˆŠä¸ºå¤´...
    const monthStartMap = {
      0: 2, // ç”²å¹´ - ä¸™å¯…
      1: 4, // ä¹™å¹´ - æˆŠå¯…  
      2: 6, // ä¸™å¹´ - åºšå¯…
      3: 8, // ä¸å¹´ - å£¬å¯…
      4: 0, // æˆŠå¹´ - ç”²å¯…
      5: 2, // å·±å¹´ - ä¸™å¯…
      6: 4, // åºšå¹´ - æˆŠå¯…
      7: 6, // è¾›å¹´ - åºšå¯…
      8: 8, // å£¬å¹´ - å£¬å¯…
      9: 0  // ç™¸å¹´ - ç”²å¯…
    };
    
    const branchNum = this.EARTHLY_BRANCHES.indexOf(branch);
    const stemIdx = (monthStartMap[yearStemIdx] + branchNum) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  // ä¿®æ­£æ—¥æŸ±è®¡ç®— - ä½¿ç”¨æ›´ç²¾ç¡®çš„ç®—æ³•
  calculateDayPillar(year, month, day) {
    // ç®€åŒ–ç‰ˆï¼šä½¿ç”¨1900å¹´1æœˆ31æ—¥ä¸ºåŸºå‡†æ—¥ï¼ˆç”²è¾°æ—¥ï¼‰
    const baseDate = new Date(1900, 0, 31); // 1900-01-31 ç”²è¾°æ—¥
    const targetDate = new Date(year, month - 1, day);
    const dayDiff = Math.floor((targetDate - baseDate) / (1000 * 60 * 60 * 24));
    
    // ç”²å­åºå·è®¡ç®—
    const stemIdx = (dayDiff % 10 + 0) % 10; // ç”²ä¸º0
    const branchIdx = (dayDiff % 12 + 4) % 12; // è¾°ä¸º4
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: this.EARTHLY_BRANCHES[branchIdx]
    };
  }

  // ä¿®æ­£æ—¶æŸ±è®¡ç®—
  calculateHourPillar(dayStem, hour) {
    const branchMap = {
      23: 'å­', 0: 'å­', 1: 'ä¸‘', 2: 'ä¸‘', 3: 'å¯…', 4: 'å¯…',
      5: 'å¯', 6: 'å¯', 7: 'è¾°', 8: 'è¾°', 9: 'å·³', 10: 'å·³',
      11: 'åˆ', 12: 'åˆ', 13: 'æœª', 14: 'æœª', 15: 'ç”³', 16: 'ç”³',
      17: 'é…‰', 18: 'é…‰', 19: 'æˆŒ', 20: 'æˆŒ', 21: 'äº¥', 22: 'äº¥'
    };
    
    // äº”é¼ éè¯€ï¼šç”²å·±è¿˜åŠ ç”²ï¼Œä¹™åºšä¸™ä½œåˆ...
    const hourStartMap = {
      0: 0, // ç”²æ—¥ - ç”²å­
      1: 2, // ä¹™æ—¥ - ä¸™å­
      2: 4, // ä¸™æ—¥ - æˆŠå­
      3: 6, // ä¸æ—¥ - åºšå­
      4: 8, // æˆŠæ—¥ - å£¬å­
      5: 0, // å·±æ—¥ - ç”²å­
      6: 2, // åºšæ—¥ - ä¸™å­
      7: 4, // è¾›æ—¥ - æˆŠå­
      8: 6, // å£¬æ—¥ - åºšå­
      9: 8  // ç™¸æ—¥ - å£¬å­
    };
    
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (hourStartMap[dayIdx] + hourIndex) % 10;
    
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getStemElement(stem) {
    const elementMap = {
      'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ',
      'åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'
    };
    return elementMap[stem] || '';
  }

  getBranchElement(branch) {
    const elementMap = {
      'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«',
      'åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'
    };
    return elementMap[branch] || '';
  }

  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length] || '';
  }

  // åˆ¤æ–­æ—¥ä¸»å¼ºå¼±å’Œæ ¼å±€
  analyzeDayMasterStrength(pillars, elements) {
    const dayStem = pillars.day.stem;
    const dayElement = this.getStemElement(dayStem);
    const monthBranch = pillars.month.branch;
    
    // å­£èŠ‚åˆ¤æ–­
    const seasonMap = {
      'å¯…':'æ˜¥','å¯':'æ˜¥','è¾°':'æ˜¥',
      'å·³':'å¤','åˆ':'å¤','æœª':'å¤', 
      'ç”³':'ç§‹','é…‰':'ç§‹','æˆŒ':'ç§‹',
      'äº¥':'å†¬','å­':'å†¬','ä¸‘':'å†¬'
    };
    
    const season = seasonMap[monthBranch] || 'ä¸­';
    
    // æ—¥ä¸»å¼ºå¼±åˆ¤æ–­
    let strengthScore = elements[dayElement] || 0;
    
    // å­£èŠ‚åŠ æˆ
    if ((season === 'æ˜¥' && dayElement === 'æœ¨') ||
        (season === 'å¤' && dayElement === 'ç«') ||
        (season === 'ç§‹' && dayElement === 'é‡‘') ||
        (season === 'å†¬' && dayElement === 'æ°´')) {
      strengthScore += 2;
    }
    
    let strength, pattern;
    if (strengthScore >= 4) {
      strength = 'ææ—º';
      pattern = 'å»ºç¦„æ ¼';
    } else if (strengthScore >= 3) {
      strength = 'åæ—º'; 
      pattern = 'èº«æ—ºæ ¼';
    } else if (strengthScore >= 2) {
      strength = 'ä¸­å’Œ';
      pattern = 'ä¸­å’Œæ ¼';
    } else {
      strength = 'åå¼±';
      pattern = 'èº«å¼±æ ¼';
    }
    
    return { strength, pattern, season };
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'ï¼Ÿ',branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // è®¡ç®—äº”è¡Œèƒ½é‡
    const elements = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(pillar => {
      if (pillar.stem && pillar.stem !== 'ï¼Ÿ') {
        const stemElement = this.getStemElement(pillar.stem);
        if (stemElement) elements[stemElement]++;
      }
      if (pillar.branch && pillar.branch !== 'ï¼Ÿ') {
        const branchElement = this.getBranchElement(pillar.branch);
        if (branchElement) elements[branchElement]++;
      }
    });

    const total = Object.values(elements).reduce((sum, count) => sum + count, 0) || 1;
    const percents = {
      wood: (elements['æœ¨'] / total) * 100,
      fire: (elements['ç«'] / total) * 100,
      earth: (elements['åœŸ'] / total) * 100,
      metal: (elements['é‡‘'] / total) * 100,
      water: (elements['æ°´'] / total) * 100
    };

    // åˆ†ææ—¥ä¸»å¼ºå¼±å’Œæ ¼å±€
    const strengthAnalysis = this.analyzeDayMasterStrength(pillars, elements);

    return { pillars, elements, percents, timeUnknown, strengthAnalysis };
  }
}

// å·¥å…·å‡½æ•°
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: 'å¹´æŸ±', pillar: pillars.year },
    { title: 'æœˆæŸ±', pillar: pillars.month },
    { title: 'æ—¥æŸ±', pillar: pillars.day },
    { title: 'æ—¶æŸ±', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === 'æ—¶æŸ±' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? 'ï¼Ÿ' : pillar.stem}${isUnknown ? 'ï¼Ÿ' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯è¡¨æ ¼
function displayDetailedInfo(pillars, timeUnknown = false) {
  const calculator = new ProfessionalBaziCalculator();
  
  // å¤©å¹²åœ°æ”¯
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : pillars.hour.branch);

  // äº”è¡Œ
  setText('year-element', `${calculator.getStemElement(pillars.year.stem)}${calculator.getBranchElement(pillars.year.branch)}`);
  setText('month-element', `${calculator.getStemElement(pillars.month.stem)}${calculator.getBranchElement(pillars.month.branch)}`);
  setText('day-element', `${calculator.getStemElement(pillars.day.stem)}${calculator.getBranchElement(pillars.day.branch)}`);
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : `${calculator.getStemElement(pillars.hour.stem)}${calculator.getBranchElement(pillars.hour.branch)}`);

  // çº³éŸ³
  setText('year-nayin', calculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', calculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', calculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : calculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// ç”Ÿæˆè¯¦ç»†åˆ†æå†…å®¹
function generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, timeUnknown) {
  const calculator = new ProfessionalBaziCalculator();
  
  // åŸºæœ¬ä¿¡æ¯
  const basicInfo = `
    <p><strong>å…«å­—ï¼š</strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${timeUnknown ? 'ï¼Ÿï¼Ÿ' : pillars.hour.stem + pillars.hour.branch}</p>
    <p><strong>æ—¥ä¸»äº”è¡Œï¼š</strong>${pillars.day.stem}${pillars.day.element}ï¼ˆ${pillars.day.element}ï¼‰</p>
    <p><strong>å‡ºç”Ÿå­£èŠ‚ï¼š</strong>${strengthAnalysis.season}ï¼ˆ${getSeasonCharacter(strengthAnalysis.season)}ï¼‰</p>
    <p><strong>æ—¥ä¸»çŠ¶æ€ï¼š</strong>${strengthAnalysis.strength}</p>
    <p><strong>æ ¼å±€ï¼š</strong><span class="tag">${strengthAnalysis.pattern}</span></p>
  `;
  
  $('basic-info').innerHTML = basicInfo;

  // æ€»ä½“å‘½è¿è§£è¯»
  const overallDestiny = generateOverallDestiny(pillars, strengthAnalysis, elements);
  $('overall-destiny').innerHTML = overallDestiny;

  // äº‹ä¸šåˆ†æ
  const careerAnalysis = generateCareerAnalysis(pillars, strengthAnalysis);
  $('career-analysis').innerHTML = careerAnalysis;

  // è´¢å¯Œåˆ†æ
  const wealthAnalysis = generateWealthAnalysis(pillars, elements);
  $('wealth-analysis').innerHTML = wealthAnalysis;

  // å©šå§»åˆ†æ
  const marriageAnalysis = generateMarriageAnalysis(pillars);
  $('marriage-analysis').innerHTML = marriageAnalysis;

  // å¤§è¿æµå¹´
  const luckAnalysis = generateLuckAnalysis(pillars, strengthAnalysis);
  $('luck-analysis').innerHTML = luckAnalysis;
}

function getSeasonCharacter(season) {
  const chars = {
    'æ˜¥': 'æœ¨æ—ºç”Ÿå‘',
    'å¤': 'ç«æ—ºå¤–æ”¾', 
    'ç§‹': 'é‡‘æ—ºæ”¶æ•›',
    'å†¬': 'æ°´æ—ºå†…è—',
    'ä¸­': 'åœŸæ—ºæ‰¿è½½'
  };
  return chars[season] || '';
}

function generateOverallDestiny(pillars, strengthAnalysis, elements) {
  const dayElement = pillars.day.element;
  const elementEntries = Object.entries(elements);
  const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
  const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
  
  let destinyLevel, description;
  
  if (strengthAnalysis.strength === 'ææ—º' && strengthAnalysis.pattern === 'å»ºç¦„æ ¼') {
    destinyLevel = 'â˜…â˜…â˜…â˜…â˜…';
    description = `æ‚¨å±<strong>"${strengthAnalysis.pattern}"</strong>ï¼Œä¸ºæå¼ºçš„è‡ªä¸»åˆ›ä¸šæ ¼å±€ã€‚æ—¥ä¸»${pillars.day.stem}${dayElement}${strengthAnalysis.strength}ï¼Œèƒ½åŠ›å¼ºï¼Œå±äºç™½æ‰‹èµ·å®¶çš„æ ¼å±€ã€‚`;
  } else if (strengthAnalysis.strength === 'åæ—º') {
    destinyLevel = 'â˜…â˜…â˜…â˜…â˜†';
    description = `æ‚¨å±<strong>"${strengthAnalysis.pattern}"</strong>ï¼Œæ—¥ä¸»${strengthAnalysis.strength}ï¼Œæœ‰è¾ƒå¼ºçš„æ‰§è¡ŒåŠ›å’Œé¢†å¯¼èƒ½åŠ›ã€‚`;
  } else {
    destinyLevel = 'â˜…â˜…â˜…â˜†â˜†';
    description = `æ‚¨å±<strong>"${strengthAnalysis.pattern}"</strong>ï¼Œæ—¥ä¸»${strengthAnalysis.strength}ï¼Œéœ€è¦å€ŸåŠ©å¤–åŠ›å‘å±•ã€‚`;
  }
  
  return `
    <div class="rating">
      <span>å‘½æ ¼ç­‰çº§ï¼š</span>
      <span class="rating-stars">${destinyLevel}</span>
    </div>
    <p>${description}</p>
    <p><strong>æ€§æ ¼ç‰¹å¾ï¼š</strong>${getPersonalityTraits(pillars.day.stem, strengthAnalysis.strength)}</p>
    <p><strong>äº”è¡Œæƒ…å†µï¼š</strong>${getElementSituation(elements)}</p>
    <p><strong>å–œç”¨ç¥ï¼š</strong>${getFavorableElements(dayElement, strengthAnalysis.strength)}</p>
  `;
}

function getPersonalityTraits(dayStem, strength) {
  const traits = {
    'ç”²': 'è‡ªä¿¡ã€æœæ–­ã€æœ‰é¢†å¯¼åŠ›',
    'ä¹™': 'æ¸©å’Œã€çµæ´»ã€é€‚åº”åŠ›å¼º', 
    'ä¸™': 'çƒ­æƒ…ã€å¼€æœ—ã€åˆ›é€ åŠ›å¼º',
    'ä¸': 'ç»†è‡´ã€ä¸“æ³¨ã€æ‰§è¡ŒåŠ›å¥½',
    'æˆŠ': 'ç¨³é‡ã€åŠ¡å®ã€è´£ä»»æ„Ÿå¼º',
    'å·±': 'åŒ…å®¹ã€è€å¿ƒã€åè°ƒæ€§å¥½',
    'åºš': 'åˆšæ¯…ã€æœæ–­ã€åŸåˆ™æ€§å¼º',
    'è¾›': 'ç²¾è‡´ã€æ•é”ã€è¿½æ±‚å®Œç¾',
    'å£¬': 'æ™ºæ…§ã€åŒ…å®¹ã€é€‚åº”åŠ›å¼º',
    'ç™¸': 'æ¸©æŸ”ã€ç»†è…»ã€ç›´è§‰åŠ›å¼º'
  };
  
  const baseTrait = traits[dayStem] || 'æ€§æ ¼ç‹¬ç‰¹æœ‰é­…åŠ›';
  const strengthTrait = strength === 'ææ—º' ? 'è¡Œäº‹æœå†³ï¼Œèƒ½ç‹¬å½“ä¸€é¢' : 
                       strength === 'åæ—º' ? 'è‡ªä¿¡æœ‰ä¸»è§' : 'æ¸©å’ŒåŒ…å®¹';
  
  return `${baseTrait}ã€‚${strengthTrait}`;
}

function getElementSituation(elements) {
  const present = Object.entries(elements)
    .filter(([_, count]) => count > 0)
    .map(([element]) => element)
    .join('ã€');
    
  const absent = Object.entries(elements)
    .filter(([_, count]) => count === 0)
    .map(([element]) => element)
    .join('ã€');
    
  let situation = `${present}å¼º`;
  if (absent) {
    situation += `ï¼Œ${absent}å¼±`;
  }
  
  return situation + ' â†’ ' + getBalanceAdvice(elements);
}

function getBalanceAdvice(elements) {
  const weakest = Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  const advice = {
    'æœ¨': 'é€‚åˆä½©æˆ´é‡‘å±é…é¥°æˆ–äº²è¿‘æ°´ç³»ç¯å¢ƒ',
    'ç«': 'é€‚åˆæ¥è§¦æ°´å…ƒç´ æˆ–å†·é™æ€è€ƒ', 
    'åœŸ': 'é€‚åˆæœ¨å…ƒç´ æ´»åŠ¨æˆ–ç»¿è‰²ç¯å¢ƒ',
    'é‡‘': 'é€‚åˆç«å…ƒç´ æˆ–æ¸©æš–ç¯å¢ƒ',
    'æ°´': 'é€‚åˆåœŸå…ƒç´ æˆ–ç¨³å®šç¯å¢ƒ'
  };
  return advice[weakest] || 'æ³¨æ„äº”è¡Œå¹³è¡¡è°ƒå’Œ';
}

function getFavorableElements(dayElement, strength) {
  if (strength === 'ææ—º' || strength === 'åæ—º') {
    // æ—ºåˆ™å–œå…‹ã€æ³„ã€è€—
    const favorable = {
      'æœ¨': 'é‡‘ã€ç«ã€åœŸ',
      'ç«': 'æ°´ã€é‡‘ã€åœŸ',
      'åœŸ': 'æœ¨ã€é‡‘ã€æ°´', 
      'é‡‘': 'ç«ã€æœ¨ã€æ°´',
      'æ°´': 'åœŸã€æœ¨ã€ç«'
    };
    return `å–œ${favorable[dayElement]}ï¼Œå¿Œ${dayElement}`;
  } else {
    // å¼±åˆ™å–œç”Ÿã€æ‰¶
    const favorable = {
      'æœ¨': 'æ°´ã€æœ¨',
      'ç«': 'æœ¨ã€ç«',
      'åœŸ': 'ç«ã€åœŸ',
      'é‡‘': 'åœŸã€é‡‘', 
      'æ°´': 'é‡‘ã€æ°´'
    };
    return `å–œ${favorable[dayElement]}ï¼Œå¿Œå…‹${dayElement}çš„å…ƒç´ `;
  }
}

function generateCareerAnalysis(pillars, strengthAnalysis) {
  const dayStem = pillars.day.stem;
  const suitableIndustries = getSuitableIndustries(dayStem, strengthAnalysis.strength);
  
  return `
    <p>${getCareerDescription(strengthAnalysis)}</p>
    <p><strong>é€‚åˆè¡Œä¸šï¼š</strong>${suitableIndustries}</p>
    <p><strong>å‘å±•å»ºè®®ï¼š</strong>${getCareerAdvice(strengthAnalysis)}</p>
  `;
}

function getCareerDescription(strengthAnalysis) {
  if (strengthAnalysis.strength === 'ææ—º') {
    return 'äº‹ä¸šä¸Šæœ‰è¶…å¼ºæ‰§è¡ŒåŠ›ä¸é¢†å¯¼åŠ›ï¼Œé€‚åˆè‡ªä¸»åˆ›ä¸šã€ç®¡ç†èŒä½ã€æŠ•èµ„ç†è´¢ç­‰è¡Œä¸šã€‚';
  } else if (strengthAnalysis.strength === 'åæ—º') {
    return 'å…·å¤‡è‰¯å¥½çš„æ‰§è¡ŒåŠ›å’Œç®¡ç†èƒ½åŠ›ï¼Œé€‚åˆæŠ€æœ¯ä¸“å®¶ã€é¡¹ç›®è´Ÿè´£äººç­‰èŒä½ã€‚';
  } else {
    return 'é€‚åˆå›¢é˜Ÿåˆä½œæˆ–ä¸“ä¸šæŠ€æœ¯è·¯çº¿ï¼Œåœ¨ç¨³å®šç¯å¢ƒä¸­èƒ½å‘æŒ¥æœ€ä½³çŠ¶æ€ã€‚';
  }
}

function getSuitableIndustries(dayStem, strength) {
  const baseIndustries = {
    'ç”²': 'æ—ä¸šã€æ•™è‚²ã€å‡ºç‰ˆ',
    'ä¹™': 'è‰ºæœ¯ã€è®¾è®¡ã€å’¨è¯¢',
    'ä¸™': 'èƒ½æºã€å¨±ä¹ã€é¤é¥®',
    'ä¸': 'ç§‘æŠ€ã€ç ”å‘ã€ç²¾å¯†åˆ¶é€ ',
    'æˆŠ': 'å»ºç­‘ã€åœ°äº§ã€é‡‘è',
    'å·±': 'å†œä¸šã€é£Ÿå“ã€æœåŠ¡',
    'åºš': 'é‡‘å±ã€æœºæ¢°ã€å†›è­¦',
    'è¾›': 'ç å®ã€é‡‘èã€æ³•å¾‹',
    'å£¬': 'ç‰©æµã€è´¸æ˜“ã€å’¨è¯¢',
    'ç™¸': 'ç ”ç©¶ã€ç­–åˆ’ã€è‰ºæœ¯'
  };
  
  const strengthIndustries = strength === 'ææ—º' ? 'åˆ›ä¸šã€æŠ•èµ„ã€ç®¡ç†' : 'ä¸“ä¸šæŠ€æœ¯ã€ç¨³å®šèŒä¸š';
  
  return `${baseIndustries[dayStem]}ã€${strengthIndustries}`;
}

function getCareerAdvice(strengthAnalysis) {
  if (strengthAnalysis.strength === 'ææ—º') {
    return 'å½“å‰é€‚åˆç§¯ç´¯ç»éªŒï¼Œ2032å¹´èµ·è¿›å…¥é»„é‡‘å‘å±•é˜¶æ®µï¼Œå»ºè®®æå‰å¸ƒå±€ã€‚';
  } else {
    return 'ç¨³æ­¥å‘å±•ï¼Œæ³¨é‡ä¸“ä¸šæŠ€èƒ½çš„æå‡å’Œäººè„‰èµ„æºçš„ç§¯ç´¯ã€‚';
  }
}

function generateWealthAnalysis(pillars, elements) {
  const wealthLevel = calculateWealthLevel(elements);
  const wealthDescription = getWealthDescription(wealthLevel);
  
  return `
    <div class="rating">
      <span>è´¢å¯Œç­‰çº§ï¼š</span>
      <span class="rating-stars">${wealthLevel}</span>
    </div>
    <p>${wealthDescription}</p>
    <p><strong>è´¢è¿ç‰¹ç‚¹ï¼š</strong>${getWealthCharacteristics(pillars)}</p>
    <p><strong>æŠ•èµ„å»ºè®®ï¼š</strong>${getInvestmentAdvice(elements)}</p>
  `;
}

function calculateWealthLevel(elements) {
  const wealthElements = ['é‡‘', 'åœŸ']; // é‡‘ä¸»è´¢ï¼ŒåœŸä¸»åº“
  const wealthScore = wealthElements.reduce((score, element) => score + (elements[element] || 0), 0);
  
  if (wealthScore >= 3) return 'â˜…â˜…â˜…â˜…â˜…';
  if (wealthScore >= 2) return 'â˜…â˜…â˜…â˜…â˜†';
  if (wealthScore >= 1) return 'â˜…â˜…â˜…â˜†â˜†';
  return 'â˜…â˜…â˜†â˜†â˜†';
}

function getWealthDescription(level) {
  const descriptions = {
    'â˜…â˜…â˜…â˜…â˜…': 'è´¢æ˜Ÿåˆ†å¸ƒå¹¿æ³›ï¼Œæœ‰è¶…å¼ºçš„èµšé’±èƒ½åŠ›å’Œè´¢å¯Œæ™ºæ…§ï¼Œå¯è¾¾"åƒä¸‡ä¸­å¯Œ"ä»¥ä¸Šçº§åˆ«ã€‚',
    'â˜…â˜…â˜…â˜…â˜†': 'å…·å¤‡è‰¯å¥½çš„è´¢å¯Œç§¯ç´¯èƒ½åŠ›ï¼Œé€šè¿‡åŠªåŠ›å¯è¾¾åˆ°å¯Œè£•æ°´å¹³ã€‚', 
    'â˜…â˜…â˜…â˜†â˜†': 'è´¢è¿å¹³ç¨³ï¼Œéœ€è¦é€šè¿‡ä¸“ä¸šæŠ€èƒ½å’Œç¨³å®šæŠ•èµ„ç§¯ç´¯è´¢å¯Œã€‚',
    'â˜…â˜…â˜†â˜†â˜†': 'éœ€è¦æ›´åŠ æ³¨é‡è´¢åŠ¡è§„åˆ’å’Œç†è´¢æŠ€å·§ã€‚'
  };
  return descriptions[level] || 'è´¢è¿æœ‰å¾…å¼€å‘ã€‚';
}

function getWealthCharacteristics(pillars) {
  const hasWealth = pillars.month.stem === 'æˆŠ' || pillars.month.stem === 'å·±' || 
                   pillars.year.stem === 'æˆŠ' || pillars.year.stem === 'å·±';
  
  return hasWealth ? 'æ­£åè´¢çš†æœ‰ï¼Œé€‚åˆå¤šå…ƒåŒ–æŠ•èµ„' : 'ä»¥æ­£è´¢ä¸ºä¸»ï¼Œé€‚åˆç¨³å®šæ”¶å…¥';
}

function getInvestmentAdvice(elements) {
  const weakest = Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  const advice = {
    'æœ¨': 'é€‚åˆæ–‡åŒ–ã€æ•™è‚²ã€ç¯ä¿ç±»æŠ•èµ„',
    'ç«': 'é€‚åˆèƒ½æºã€ç§‘æŠ€ã€å¨±ä¹ç±»æŠ•èµ„',
    'åœŸ': 'é€‚åˆåœ°äº§ã€å»ºç­‘ã€èµ„æºç±»æŠ•èµ„',
    'é‡‘': 'é€‚åˆé‡‘èã€é‡‘å±ã€æœºæ¢°ç±»æŠ•èµ„', 
    'æ°´': 'é€‚åˆç‰©æµã€è´¸æ˜“ã€å’¨è¯¢ç±»æŠ•èµ„'
  };
  return advice[weakest] || 'åˆ†æ•£æŠ•èµ„ï¼Œæ§åˆ¶é£é™©';
}

function generateMarriageAnalysis(pillars) {
  const marriageStability = assessMarriageStability(pillars);
  
  return `
    <div class="rating">
      <span>å©šå§»ç¨³å®šåº¦ï¼š</span>
      <span class="rating-stars">${marriageStability.stars}</span>
    </div>
    <p>${marriageStability.description}</p>
    <p><strong>é…å¶ç‰¹å¾ï¼š</strong>${getSpouseCharacteristics(pillars)}</p>
    <p><strong>æ„Ÿæƒ…å»ºè®®ï¼š</strong>${getRelationshipAdvice(pillars)}</p>
  `;
}

function assessMarriageStability(pillars) {
  // ç®€å•çš„å©šå§»ç¨³å®šæ€§è¯„ä¼°
  const dayBranch = pillars.day.branch;
  const monthBranch = pillars.month.branch;
  
  let stability, stars;
  
  if (dayBranch === monthBranch) {
    stability = 'æœˆæ—¥ä¼åŸï¼Œæ„Ÿæƒ…èµ·ä¼è¾ƒå¤§ï¼Œéœ€è¦æ›´å¤šæ²Ÿé€šç†è§£';
    stars = 'â˜…â˜…â˜…â˜†â˜†';
  } else if (['å­', 'åˆ', 'å¯', 'é…‰'].includes(dayBranch)) {
    stability = 'å¤«å¦»å®«ä¸ºæ¡ƒèŠ±ä½ï¼Œæ„Ÿæƒ…ä¸°å¯Œä½†éœ€ä¸“ä¸€';
    stars = 'â˜…â˜…â˜…â˜†â˜†';
  } else {
    stability = 'å©šå§»ç›¸å¯¹ç¨³å®šï¼Œæ³¨é‡å®¶åº­è´£ä»»';
    stars = 'â˜…â˜…â˜…â˜…â˜†';
  }
  
  return { stars, description: stability };
}

function getSpouseCharacteristics(pillars) {
  const spouseElements = {
    'ç”²': 'èƒ½åŠ›å¼ºï¼Œæœ‰ä¸»è§',
    'ä¹™': 'æ¸©æŸ”ä½“è´´ï¼Œå–„è§£äººæ„',
    'ä¸™': 'çƒ­æƒ…å¼€æœ—ï¼Œæ´»åŠ›å……æ²›',
    'ä¸': 'ç»†è‡´å‘¨åˆ°ï¼Œæ³¨é‡ç»†èŠ‚',
    'æˆŠ': 'ç¨³é‡åŠ¡å®ï¼Œè´£ä»»æ„Ÿå¼º',
    'å·±': 'åŒ…å®¹è€å¿ƒï¼Œå®¶åº­è§‚å¿µé‡',
    'åºš': 'åŸåˆ™æ€§å¼ºï¼Œæ­£ç›´å¯é ',
    'è¾›': 'è¿½æ±‚å®Œç¾ï¼Œæ³¨é‡å“è´¨',
    'å£¬': 'æ™ºæ…§åŒ…å®¹ï¼Œé€‚åº”åŠ›å¼º',
    'ç™¸': 'æ¸©æŸ”ç»†è…»ï¼Œæƒ…æ„Ÿä¸°å¯Œ'
  };
  
  return spouseElements[pillars.day.stem] || 'è¸å®å¯é ï¼Œé‡å®¶åº­è´£ä»»';
}

function getRelationshipAdvice(pillars) {
  const dayStem = pillars.day.stem;
  const advice = {
    'ç”²': 'å¤šå€¾å¬å¯¹æ–¹æƒ³æ³•ï¼Œæ”¶æ•›æ§åˆ¶æ¬²',
    'ä¹™': 'ä¿æŒç‹¬ç«‹ç©ºé—´ï¼Œå¢å¼ºè‡ªä¿¡å¿ƒ',
    'ä¸™': 'æ§åˆ¶æƒ…ç»ªæ³¢åŠ¨ï¼Œå¤šäº›è€å¿ƒ',
    'ä¸': 'é¿å…è¿‡åº¦æŒ‘å‰”ï¼Œå¤šäº›åŒ…å®¹',
    'æˆŠ': 'å¤šè¡¨è¾¾æƒ…æ„Ÿï¼Œå¢å¼ºæµªæ¼«',
    'å·±': 'åšæŒåŸåˆ™ï¼Œé¿å…è¿‡åº¦å¦¥å',
    'åºš': 'æŸ”å’Œæ²Ÿé€šæ–¹å¼ï¼Œå‡å°‘å›ºæ‰§',
    'è¾›': 'é™ä½æ ‡å‡†ï¼Œäº«å—ç®€å•å¿«ä¹',
    'å£¬': 'ä¸“æ³¨å½“ä¸‹ï¼Œå‡å°‘ç†æƒ³åŒ–',
    'ç™¸': 'ä¸»åŠ¨æ²Ÿé€šï¼Œé¿å…è¿‡åº¦æ•æ„Ÿ'
  };
  
  return advice[dayStem] || 'ç›¸äº’å°Šé‡ï¼Œç”¨å¿ƒç»è¥';
}

function generateLuckAnalysis(pillars, strengthAnalysis) {
  const baseYear = new Date().getFullYear();
  const luckYears = [
    { year: baseYear, desc: 'å¹³ç¨³å‘å±•ï¼Œç§¯ç´¯ç»éªŒ' },
    { year: baseYear + 2, desc: 'è´¢è¿ä¸Šå‡ï¼Œæœºä¼šå¢å¤š' },
    { year: baseYear + 5, desc: 'äº‹ä¸šçªç ´ï¼Œè´µäººç›¸åŠ©' },
    { year: baseYear + 8, desc: 'é‡è¦è½¬æŠ˜ï¼ŒæŠŠæ¡æœºé‡' }
  ];
  
  return luckYears.map(luck => `
    <div class="luck-item">
      <div class="luck-year">${luck.year}å¹´</div>
      <div class="luck-desc">${luck.desc}</div>
    </div>
  `).join('');
}

// ç”Ÿæˆå…«å­—å‘½ç›˜
async function generateBaziChart() {
  const birthdate = $('birthdate').value;
  if (!birthdate) {
    showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ');
    return;
  }

  const timeUnknown = $('timeUnknown').checked;
  const [year, month, day] = birthdate.split('-').map(Number);
  
  let hour = 12;
  if (!timeUnknown) {
    const timeValue = $('birthtime').value;
    if (timeValue) {
      hour = parseInt(timeValue.split(':')[0], 10);
    }
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const genBtn = $('genBtn');
  const genBtnText = $('genBtnText');
  const genBtnLoading = $('genBtnLoading');
  
  genBtn.disabled = true;
  genBtnText.style.display = 'none';
  genBtnLoading.style.display = 'inline-block';

  try {
    const calculator = new ProfessionalBaziCalculator();
    const { pillars, elements, percents, timeUnknown: tu, strengthAnalysis } = calculator.calculateBazi(year, month, day, hour, timeUnknown);

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';

    // è®¾ç½®æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
    if (tu) {
      const dateEl = $('bazi-date');
      dateEl.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å…«å­—æŸ±å’Œè¯¦ç»†ä¿¡æ¯
    renderPillars(pillars, tu);
    displayDetailedInfo(pillars, tu);

    // æ›´æ–°äº”è¡Œèƒ½é‡æ¡
    setBar('bar-æœ¨', percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar('bar-ç«', percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar('bar-åœŸ', percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar('bar-é‡‘', percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar('bar-æ°´', percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡åˆ†æ
    const elementEntries = Object.entries(elements);
    const strongest = elementEntries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = elementEntries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    setText('bazi-elements-balance', `äº”è¡Œä¸­${strongest}å…ƒç´ æœ€å¼ºï¼Œ${weakest}å…ƒç´ æœ€å¼±ã€‚`);

    // ç”Ÿæˆè¯¦ç»†åˆ†æ
    generateDetailedAnalysis(pillars, elements, percents, strengthAnalysis, tu);

    // ç”ŸæˆAIè§£è¯»
    generateAIInsight(pillars, percents, tu, strengthAnalysis);

  } catch (error) {
    console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
    showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    genBtn.disabled = false;
    genBtnText.style.display = 'inline';
    genBtnLoading.style.display = 'none';
  }
}

// AIè§£è¯»ç”Ÿæˆ
function generateAIInsight(pillars, percents, timeUnknown, strengthAnalysis) {
  const aiContent = $('aiContent');
  const aiChips = $('aiChips');
  
  if (!aiContent || !aiChips) return;

  // æ˜¾ç¤ºåŠ è½½éª¨æ¶å±
  aiContent.innerHTML = `
    <div class="skeleton">
      <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
      <div style="width:70%"></div><div style="width:50%"></div>
    </div>
  `;

  // æ¨¡æ‹ŸAIåˆ†æå»¶è¿Ÿ
  setTimeout(() => {
    const elements = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
    const strongest = elements.reduce((a, b) => percents[a] > percents[b] ? a : b);
    const weakest = elements.reduce((a, b) => percents[a] < percents[b] ? a : b);
    
    const insight = `
      <p><strong>æ·±åº¦å‘½ç†è§£è¯»ï¼š</strong></p>
      <p>æ‚¨çš„<strong>${strengthAnalysis.pattern}</strong>æ˜¾ç¤ºå‡º${getPatternInsight(strengthAnalysis.pattern)}ã€‚æ—¥ä¸»${pillars.day.stem}${pillars.day.element}${strengthAnalysis.strength}ï¼Œåœ¨${strengthAnalysis.season}å­£èŠ‚ä¸­${getSeasonInsight(strengthAnalysis.season, pillars.day.element)}ã€‚</p>
      <p><strong>æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong>${getCoreStrengths(pillars.day.stem, strengthAnalysis.strength)}</p>
      <p><strong>å‘å±•å»ºè®®ï¼š</strong>${getDevelopmentAdvice(weakest, strongest)}</p>
      ${timeUnknown ? '<p class="muted">ğŸ’¡ æç¤ºï¼šç”±äºå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥åˆ†æï¼Œå®Œæ•´è§£è¯»å»ºè®®æä¾›å‡†ç¡®å‡ºç”Ÿæ—¶é—´ã€‚</p>' : ''}
    `;
    
    aiContent.innerHTML = insight;
    
    // ç”Ÿæˆè¯é¢˜èŠ¯ç‰‡
    const topics = [
      { label: 'äº‹ä¸šè§„åˆ’', emoji: 'ğŸ’¼' },
      { label: 'è´¢è¿åˆ†æ', emoji: 'ğŸ’°' },
      { label: 'æ„Ÿæƒ…å©šå§»', emoji: 'â¤ï¸' },
      { label: 'å¥åº·å…»ç”Ÿ', emoji: 'ğŸŒ¿' },
      { label: 'æµå¹´è¿åŠ¿', emoji: 'ğŸ“…' }
    ];
    
    aiChips.innerHTML = topics.map(topic => `
      <button class="chip" onclick="showTopicInsight('${topic.label}', '${pillars.day.stem}', '${strengthAnalysis.strength}')">
        ${topic.emoji} ${topic.label}
      </button>
    `).join('');
  }, 1500);
}

function getPatternInsight(pattern) {
  const insights = {
    'å»ºç¦„æ ¼': 'æå¼ºçš„è‡ªä¸»èƒ½åŠ›å’Œé¢†å¯¼æ°”è´¨ï¼Œé€‚åˆåˆ›ä¸šå‘å±•',
    'èº«æ—ºæ ¼': 'è‰¯å¥½çš„æ‰§è¡ŒåŠ›å’Œå†³ç­–èƒ½åŠ›ï¼Œèƒ½åœ¨ç«äº‰ä¸­è„±é¢–è€Œå‡º',
    'ä¸­å’Œæ ¼': 'å¹³è¡¡ç¨³å®šçš„å‘å±•æ€åŠ¿ï¼Œé€‚åˆç¨³æ­¥å‰è¿›',
    'èº«å¼±æ ¼': 'éœ€è¦å€ŸåŠ©å›¢é˜Ÿå’Œå¤–éƒ¨åŠ›é‡å…±åŒå‘å±•'
  };
  return insights[pattern] || 'ç‹¬ç‰¹çš„å‘å±•è·¯å¾„';
}

function getSeasonInsight(season, element) {
  const insights = {
    'æ˜¥': 'æœ¨æ°”æ—ºç››ï¼Œç”Ÿæœºå‹ƒå‹ƒï¼Œé€‚åˆå¼€æ‹“åˆ›æ–°',
    'å¤': 'ç«æ°”ç‚ä¸Šï¼Œçƒ­æƒ…å¤–æ”¾ï¼Œé€‚åˆå±•ç°æ‰å',
    'ç§‹': 'é‡‘æ°”è‚ƒæ€ï¼Œæ”¶æ•›æ²‰æ·€ï¼Œé€‚åˆè§„åˆ’æ•´ç†',
    'å†¬': 'æ°´æ°”å¯’å‡ï¼Œå†…æ•›ç§¯è“„ï¼Œé€‚åˆå­¦ä¹ æ€è€ƒ'
  };
  return insights[season] || 'æœ‰ç‹¬ç‰¹çš„å‘å±•æ—¶æœº';
}

function getCoreStrengths(dayStem, strength) {
  const strengths = {
    'ç”²': 'é¢†å¯¼èƒ½åŠ›ã€å¼€æ‹“ç²¾ç¥',
    'ä¹™': 'é€‚åº”èƒ½åŠ›ã€åè°ƒæŠ€å·§',
    'ä¸™': 'åˆ›é€ åŠ›ã€æ„ŸæŸ“åŠ›',
    'ä¸': 'ä¸“æ³¨åŠ›ã€æ‰§è¡ŒåŠ›',
    'æˆŠ': 'è´£ä»»æ„Ÿã€ç¨³å®šæ€§',
    'å·±': 'åŒ…å®¹æ€§ã€è€å¿ƒ',
    'åºš': 'å†³æ–­åŠ›ã€åŸåˆ™æ€§',
    'è¾›': 'å®Œç¾ä¸»ä¹‰ã€ç²¾è‡´å“å‘³',
    'å£¬': 'æ™ºæ…§ã€åŒ…å®¹åŠ›',
    'ç™¸': 'ç›´è§‰åŠ›ã€ç»†è…»æƒ…æ„Ÿ'
  };
  
  const strengthDesc = strength === 'ææ—º' ? 'æä¸ºçªå‡º' : 
                      strength === 'åæ—º' ? 'æ¯”è¾ƒæ˜æ˜¾' : 'éœ€è¦å‘æ˜';
  
  return `${strengths[dayStem]}${strengthDesc}`;
}

function getDevelopmentAdvice(weakest, strongest) {
  return `åŠ å¼º${weakest}å…ƒç´ çš„èƒ½é‡ï¼ˆå¦‚${getElementColor(weakest)}ç­‰ï¼‰ï¼Œé€‚åº¦å¹³è¡¡${strongest}å…ƒç´ çš„è¿‡åº¦å½±å“ï¼Œå®ç°äº”è¡Œè°ƒå’Œã€‚`;
}

function getElementColor(element) {
  const colors = {
    'æœ¨': 'ç»¿è‰²ã€é’è‰²',
    'ç«': 'çº¢è‰²ã€ç´«è‰²', 
    'åœŸ': 'é»„è‰²ã€æ£•è‰²',
    'é‡‘': 'ç™½è‰²ã€é‡‘è‰²',
    'æ°´': 'é»‘è‰²ã€è“è‰²'
  };
  return colors[element] || 'ç›¸åº”è‰²ç³»';
}

function showTopicInsight(topic, dayStem, strength) {
  const insights = {
    'äº‹ä¸šè§„åˆ’': getCareerInsight(dayStem, strength),
    'è´¢è¿åˆ†æ': getWealthInsight(dayStem, strength),
    'æ„Ÿæƒ…å©šå§»': getRelationshipInsight(dayStem, strength),
    'å¥åº·å…»ç”Ÿ': getHealthInsight(dayStem, strength),
    'æµå¹´è¿åŠ¿': getYearlyLuckInsight(dayStem)
  };
  
  const aiContent = $('aiContent');
  if (aiContent) {
    aiContent.innerHTML = `
      <p><strong>${topic}ï¼š</strong></p>
      <p>${insights[topic]}</p>
      <p class="muted">ğŸ’« ä»¥ä¸Šä¸ºAIæ™ºèƒ½åˆ†æï¼Œå…·ä½“è¿åŠ¿è¿˜éœ€ç»“åˆå¤§è¿æµå¹´ç»¼åˆåˆ¤æ–­ã€‚</p>
    `;
  }
}

function getCareerInsight(dayStem, strength) {
  const insights = {
    'ç”²': 'é€‚åˆé¢†å¯¼å²—ä½æˆ–è‡ªä¸»åˆ›ä¸šï¼Œå‘æŒ¥å¼€æ‹“ç²¾ç¥',
    'ä¹™': 'é€‚åˆåè°ƒç±»å·¥ä½œæˆ–åˆ›æ„äº§ä¸šï¼Œå‘æŒ¥çµæ´»æ€§',
    'ä¸™': 'é€‚åˆéœ€è¦çƒ­æƒ…å’Œåˆ›é€ åŠ›çš„è¡Œä¸šï¼Œå¦‚å¨±ä¹ã€æ•™è‚²',
    'ä¸': 'é€‚åˆæŠ€æœ¯ç ”å‘æˆ–ç²¾å¯†å·¥ä½œï¼Œå‘æŒ¥ä¸“æ³¨ä¼˜åŠ¿',
    'æˆŠ': 'é€‚åˆç¨³å®šå‘å±•çš„è¡Œä¸šï¼Œå¦‚é‡‘èã€åœ°äº§',
    'å·±': 'é€‚åˆæœåŠ¡ç±»æˆ–æ•™è‚²ç±»å·¥ä½œï¼Œå‘æŒ¥è€å¿ƒç‰¹è´¨',
    'åºš': 'é€‚åˆéœ€è¦å†³æ–­åŠ›çš„å²—ä½ï¼Œå¦‚ç®¡ç†ã€å†›è­¦',
    'è¾›': 'é€‚åˆè¿½æ±‚å®Œç¾çš„å·¥ä½œï¼Œå¦‚è®¾è®¡ã€æ³•å¾‹',
    'å£¬': 'é€‚åˆéœ€è¦æ™ºæ…§çš„è¡Œä¸šï¼Œå¦‚å’¨è¯¢ã€ç­–åˆ’',
    'ç™¸': 'é€‚åˆéœ€è¦ç»†è…»æƒ…æ„Ÿçš„å·¥ä½œï¼Œå¦‚è‰ºæœ¯ã€æŠ¤ç†'
  };
  
  const strengthAdvice = strength === 'ææ—º' ? 'å¯å¤§èƒ†å°è¯•é«˜é£é™©é«˜å›æŠ¥é¢†åŸŸ' :
                        strength === 'åæ—º' ? 'ç¨³æ­¥å‘å±•ï¼Œé€‚æ—¶çªç ´' : 'é€‚åˆå›¢é˜Ÿåˆä½œï¼Œç§¯ç´¯ç»éªŒ';
  
  return `${insights[dayStem]}ã€‚${strengthAdvice}`;
}

function getWealthInsight(dayStem, strength) {
  const baseInsight = {
    'ç”²': 'è´¢è¿æ¥è‡ªåˆ›æ–°å’Œé¢†å¯¼åŠ›',
    'ä¹™': 'è´¢è¿æ¥è‡ªçµæ´»åº”å˜å’Œäººè„‰',
    'ä¸™': 'è´¢è¿æ¥è‡ªçƒ­æƒ…å’Œåˆ›é€ åŠ›',
    'ä¸': 'è´¢è¿æ¥è‡ªä¸“ä¸šæŠ€èƒ½',
    'æˆŠ': 'è´¢è¿æ¥è‡ªç¨³å®šç§¯ç´¯',
    'å·±': 'è´¢è¿æ¥è‡ªæœåŠ¡å’Œè€å¿ƒ',
    'åºš': 'è´¢è¿æ¥è‡ªå†³æ–­å’Œæ‰§è¡Œ',
    'è¾›': 'è´¢è¿æ¥è‡ªç²¾è‡´å’Œä¸“ä¸š',
    'å£¬': 'è´¢è¿æ¥è‡ªæ™ºæ…§å’Œç­–ç•¥',
    'ç™¸': 'è´¢è¿æ¥è‡ªç›´è§‰å’Œæƒ…æ„Ÿ'
  };
  
  return `${baseInsight[dayStem]}ã€‚${strength === 'ææ—º' ? 'åè´¢è¿ä½³ï¼Œå¯é€‚åº¦æŠ•èµ„' : 'æ­£è´¢è¿ç¨³ï¼Œå»ºè®®ç¨³å¥ç†è´¢'}`;
}

function getRelationshipInsight(dayStem, strength) {
  const insights = {
    'ç”²': 'æ„Ÿæƒ…ä¸­éœ€è¦å­¦ä¼šæŸ”å’Œæ²Ÿé€š',
    'ä¹™': 'ä¿æŒæƒ…æ„Ÿç‹¬ç«‹ï¼Œå¢å¼ºè‡ªä¿¡',
    'ä¸™': 'æ§åˆ¶æƒ…ç»ªï¼Œå¤šäº›è€å¿ƒ',
    'ä¸': 'é¿å…è¿‡åº¦æŒ‘å‰”ï¼Œå­¦ä¼šåŒ…å®¹',
    'æˆŠ': 'å¤šè¡¨è¾¾æƒ…æ„Ÿï¼Œå¢åŠ æµªæ¼«',
    'å·±': 'åšæŒåŸåˆ™ï¼Œé¿å…è¿‡åº¦å¦¥å',
    'åºš': 'æŸ”å’Œæ²Ÿé€šï¼Œå‡å°‘å›ºæ‰§',
    'è¾›': 'é™ä½æ ‡å‡†ï¼Œäº«å—ç®€å•',
    'å£¬': 'ä¸“æ³¨å½“ä¸‹ï¼Œå‡å°‘ç†æƒ³åŒ–',
    'ç™¸': 'ä¸»åŠ¨æ²Ÿé€šï¼Œé¿å…æ•æ„Ÿ'
  };
  
  return `${insights[dayStem]}ã€‚${strength === 'ææ—º' ? 'æ™šå©šæ›´ä½³ï¼Œéœ€è¦æ›´å¤šç£¨åˆ' : 'æ„Ÿæƒ…ç¨³å®šï¼Œéœ€è¦ç”¨å¿ƒç»è¥'}`;
}

function getHealthInsight(dayStem, strength) {
  const healthMap = {
    'ç”²': 'æ³¨æ„è‚èƒ†å¥åº·ï¼Œå¤šè¿›è¡Œæˆ·å¤–è¿åŠ¨',
    'ä¹™': 'æ³¨æ„ç¥ç»ç³»ç»Ÿï¼Œä¿æŒå¿ƒæƒ…æ„‰æ‚¦',
    'ä¸™': 'æ³¨æ„å¿ƒè¡€ç®¡ç³»ç»Ÿï¼Œé¿å…è¿‡åº¦åŠ³ç´¯',
    'ä¸': 'æ³¨æ„å¿ƒè„å’Œçœ¼ç›ï¼Œé€‚å½“ä¼‘æ¯',
    'æˆŠ': 'æ³¨æ„è„¾èƒƒåŠŸèƒ½ï¼Œé¥®é£Ÿè§„å¾‹',
    'å·±': 'æ³¨æ„æ¶ˆåŒ–ç³»ç»Ÿï¼Œé¿å…å‹åŠ›',
    'åºš': 'æ³¨æ„å‘¼å¸ç³»ç»Ÿï¼ŒåŠ å¼ºé”»ç‚¼',
    'è¾›': 'æ³¨æ„çš®è‚¤å’Œè‚ºéƒ¨ï¼Œä¿æŒæ¸…æ´',
    'å£¬': 'æ³¨æ„è‚¾è„å’Œæ³Œå°¿ç³»ç»Ÿï¼Œå¤šå–æ°´',
    'ç™¸': 'æ³¨æ„ç”Ÿæ®–ç³»ç»Ÿï¼Œä¿æŒæ¸©æš–'
  };
  
  return `${healthMap[dayStem]}ã€‚${strength === 'ææ—º' ? 'ä½“è´¨å¼ºå¥ï¼Œä½†ä»éœ€æ³¨æ„ä½œæ¯' : 'éœ€è¦åŠ å¼ºé”»ç‚¼ï¼Œå¢å¼ºä½“è´¨'}`;
}

function getYearlyLuckInsight(dayStem) {
  const currentYear = new Date().getFullYear();
  const insights = {
    'ç”²': `${currentYear}å¹´æœ‰æ–°çš„å¼€å§‹ï¼Œ${currentYear+1}å¹´è´¢è¿ä¸Šå‡`,
    'ä¹™': `${currentYear}å¹´å¹³ç¨³å‘å±•ï¼Œ${currentYear+2}å¹´æœ‰æœºä¼šçªç ´`,
    'ä¸™': `${currentYear}å¹´çƒ­æƒ…é«˜æ¶¨ï¼Œ${currentYear+1}å¹´äº‹ä¸šè¿›å±•`,
    'ä¸': `${currentYear}å¹´ä¸“æ³¨ç§¯ç´¯ï¼Œ${currentYear+3}å¹´æ”¶è·æˆæœ`,
    'æˆŠ': `${currentYear}å¹´ç¨³å®šå‘å±•ï¼Œ${currentYear+2}å¹´è´¢å¯Œå¢é•¿`,
    'å·±': `${currentYear}å¹´è€å¿ƒç»è¥ï¼Œ${currentYear+4}å¹´è§åˆ°æˆæ•ˆ`,
    'åºš': `${currentYear}å¹´æœæ–­å†³ç­–ï¼Œ${currentYear+1}å¹´æƒåŠ›æå‡`,
    'è¾›': `${currentYear}å¹´è¿½æ±‚å®Œç¾ï¼Œ${currentYear+2}å¹´å“è´¨æå‡`,
    'å£¬': `${currentYear}å¹´æ™ºæ…§å±•ç°ï¼Œ${currentYear+3}å¹´ç­–ç•¥æˆåŠŸ`,
    'ç™¸': `${currentYear}å¹´ç›´è§‰æ•é”ï¼Œ${currentYear+1}å¹´æƒ…æ„Ÿä¸°å¯Œ`
  };
  
  return insights[dayStem] || 'æœªæ¥å‡ å¹´ç¨³æ­¥å‘å±•ï¼Œæœºé‡ä¸æŒ‘æˆ˜å¹¶å­˜';
}

// èŠå¤©åŠŸèƒ½
function initChat() {
  const chatFab = $('ssChatFab');
  const chatPanel = $('ssChatPanel');
  const chatClose = $('ssChatClose');
  const chatSend = $('ssChatSend');
  const chatInput = $('ssChatInput');
  const chatBody = $('ssChatBody');

  if (!chatFab || !chatPanel) return;

  chatFab.addEventListener('click', () => {
    chatPanel.style.display = chatPanel.style.display === 'block' ? 'none' : 'block';
    if (chatPanel.style.display === 'block') {
      chatInput.focus();
    }
  });

  chatClose.addEventListener('click', () => {
    chatPanel.style.display = 'none';
  });

  function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ss-msg ${isUser ? 'me' : ''}`;
    messageDiv.textContent = text;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = '';
    chatSend.disabled = true;

// æ¨¡æ‹ŸAIå›å¤
function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = '';
    chatSend.disabled = true;

    // æ¨¡æ‹ŸAIå›å¤
    setTimeout(() => {
        // æ ¹æ®ç”¨æˆ·é—®é¢˜ç±»å‹é€‰æ‹©æ™ºèƒ½å›å¤
        let response;
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('äº‹ä¸š') || lowerMessage.includes('å·¥ä½œ') || lowerMessage.includes('èŒä¸š') || lowerMessage.includes('åˆ›ä¸š')) {
            response = 'å…³äºäº‹ä¸šæ–¹é¢ï¼Œæ‚¨çš„å…«å­—æ˜¾ç¤ºé€‚åˆå‘æŒ¥é¢†å¯¼æ‰èƒ½å’Œåˆ›æ–°æ€ç»´ã€‚å»ºè®®å…³æ³¨ç®¡ç†å²—ä½æˆ–è‡ªä¸»åˆ›ä¸šï¼Œç‰¹åˆ«æ˜¯åœ¨æŠ€æœ¯å’ŒæœåŠ¡é¢†åŸŸæœ‰è¾ƒå¤§å‘å±•ç©ºé—´ã€‚æœªæ¥3-5å¹´æœ‰é‡è¦çš„äº‹ä¸šè½¬æŠ˜ç‚¹ï¼Œå»ºè®®æå‰åšå¥½è§„åˆ’å‡†å¤‡ã€‚';
        } else if (lowerMessage.includes('è´¢è¿') || lowerMessage.includes('é‡‘é’±') || lowerMessage.includes('æŠ•èµ„') || lowerMessage.includes('èµšé’±')) {
            response = 'è´¢è¿åˆ†ææ˜¾ç¤ºæ‚¨æœ‰ç¨³å®šçš„æ­£è´¢æ”¶å…¥ï¼Œåè´¢è¿åœ¨ä¸­å¹´æ—¶æœŸä¼šé€æ¸æ˜¾ç°ã€‚å»ºè®®é‡‡å–ç¨³å¥æŠ•èµ„ç­–ç•¥ï¼Œæˆ¿åœ°äº§å’Œç§‘æŠ€ç±»èµ„äº§å€¼å¾—å…³æ³¨ã€‚2025-2027å¹´æ˜¯è´¢è¿ä¸Šå‡æœŸï¼Œå¯æŠŠæ¡ç›¸å…³æœºä¼šã€‚';
        } else if (lowerMessage.includes('æ„Ÿæƒ…') || lowerMessage.includes('å©šå§»') || lowerMessage.includes('æ‹çˆ±') || lowerMessage.includes('é…å¶')) {
            response = 'æ„Ÿæƒ…è¿åŠ¿éœ€è¦æ›´å¤šçš„æ²Ÿé€šå’Œç†è§£ï¼Œå»ºè®®å¤šå…³æ³¨ä¼´ä¾£çš„æƒ…æ„Ÿéœ€æ±‚ã€‚æ‚¨çš„å‘½æ ¼æ˜¾ç¤ºæ™šå©šæ›´æœ‰åˆ©ï¼Œé…å¶å¯èƒ½åœ¨äº‹ä¸šæˆ–ç”Ÿæ´»ä¸Šå¯¹æ‚¨æœ‰é‡è¦å¸®åŠ©ã€‚æ³¨é‡åŸ¹å…»å…±åŒå…´è¶£ï¼Œå¢å¼ºæƒ…æ„Ÿçº½å¸¦ã€‚';
        } else if (lowerMessage.includes('å¥åº·') || lowerMessage.includes('èº«ä½“') || lowerMessage.includes('å…»ç”Ÿ') || lowerMessage.includes('ç–¾ç—…')) {
            response = 'å¥åº·æ–¹é¢è¦æ³¨æ„ä½œæ¯è§„å¾‹ï¼Œé€‚å½“è¿›è¡Œæˆ·å¤–è¿åŠ¨ã€‚æ ¹æ®äº”è¡Œåˆ†æï¼Œå»ºè®®å¤šå…³æ³¨è‚èƒ†å’Œå¿ƒè¡€ç®¡ç³»ç»Ÿçš„ä¿å…»ã€‚å®šæœŸä½“æ£€ï¼Œä¿æŒè‰¯å¥½å¿ƒæ€å¯¹å¥åº·è‡³å…³é‡è¦ã€‚';
        } else if (lowerMessage.includes('äº”è¡Œ') || lowerMessage.includes('å…ƒç´ ') || lowerMessage.includes('å¹³è¡¡')) {
            response = 'äº”è¡Œå¹³è¡¡æ˜¯å‘½ç†è°ƒå’Œçš„é—œéµã€‚æ‚¨çš„å‘½å±€æ˜¾ç¤ºéœ€è¦åŠ å¼ºé‡‘æ°´å…ƒç´ çš„èƒ½é‡ï¼Œå¯ä»¥é€šè¿‡ä½©æˆ´ç›¸åº”é¥°å“ã€é€‰æ‹©æœ‰åˆ©æ–¹ä½ã€è°ƒæ•´å±…ä½ç¯å¢ƒè‰²å½©ç­‰æ–¹å¼æ¥æ”¹å–„è¿åŠ¿ã€‚';
        } else if (lowerMessage.includes('å¤§è¿') || lowerMessage.includes('æµå¹´') || lowerMessage.includes('è¿åŠ¿')) {
            response = 'å¤§è¿åˆ†ææ˜¾ç¤ºæ‚¨ç›®å‰å¤„äºé‡è¦çš„è½¬å‹æœŸã€‚æœªæ¥åå¹´è¿åŠ¿ç¨³æ­¥ä¸Šå‡ï¼Œç‰¹åˆ«æ˜¯åœ¨äº‹ä¸šå’Œè´¢è¿æ–¹é¢ã€‚2025å¹´å¼€å§‹è¿›å…¥æ–°çš„è¿åŠ¿å‘¨æœŸï¼Œå»ºè®®æŠŠæ¡æœºé‡ï¼Œç§¯æè¿›å–ã€‚';
        } else if (lowerMessage.includes('å…«å­—') || lowerMessage.includes('å‘½ç†') || lowerMessage.includes('å‘½ç›˜')) {
            response = 'æ‚¨çš„å…«å­—æ ¼å±€ç‹¬ç‰¹ï¼Œå…·æœ‰å¾ˆå¥½çš„å‘å±•æ½œåŠ›ã€‚æ—¥ä¸»å¼ºæ—ºï¼Œé€‚åˆåœ¨ç«äº‰ç¯å¢ƒä¸­å‘å±•ã€‚å»ºè®®ç»“åˆå…·ä½“å¹´ä»½å’Œå¤§è¿èµ°åŠ¿ï¼Œåˆ¶å®šä¸ªæ€§åŒ–çš„å‘å±•ç­–ç•¥ã€‚';
        } else if (lowerMessage.includes('å­å¥³') || lowerMessage.includes('å­©å­') || lowerMessage.includes('åä»£')) {
            response = 'å­å¥³è¿åŠ¿æ˜¾ç¤ºæ‚¨ä¸å­å¥³ç¼˜åˆ†æ·±åšï¼Œå­å¥³åœ¨è‰ºæœ¯æˆ–æŠ€æœ¯é¢†åŸŸå¯èƒ½æœ‰ç‰¹æ®Šå¤©èµ‹ã€‚æ•™è‚²æ–¹é¢å»ºè®®å› ææ–½æ•™ï¼ŒåŸ¹å…»ç‹¬ç«‹æ€è€ƒå’Œåˆ›æ–°èƒ½åŠ›ã€‚';
        } else if (lowerMessage.includes('è´µäºº') || lowerMessage.includes('äººè„‰') || lowerMessage.includes('åˆä½œ')) {
            response = 'è´µäººè¿åŠ¿åˆ†ææ˜¾ç¤ºï¼Œæ‚¨çš„è´µäººå¤šå‡ºç°åœ¨è¥¿åŒ—å’Œè¥¿å—æ–¹ä½ã€‚åˆä½œä¼™ä¼´å®œé€‰æ‹©å‘½ç†äº’è¡¥ä¹‹äººï¼Œåœ¨é‡‘å±ã€ç§‘æŠ€ã€æ–‡åŒ–é¢†åŸŸå®¹æ˜“é‡åˆ°é‡è¦è´µäººã€‚';
        } else {
            // é€šç”¨å›å¤
            const genericResponses = [
                'æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œå»ºè®®å¤šå…³æ³¨äº”è¡Œå¹³è¡¡ï¼Œç‰¹åˆ«æ˜¯åœ¨é‡è¦å†³ç­–æ—¶è€ƒè™‘å‘½ç†å› ç´ ã€‚',
                'å‘½ç†æ˜¾ç¤ºæ‚¨è¿‘æœŸè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆåˆ¶å®šé•¿æœŸè®¡åˆ’å’ŒæŠ€èƒ½æå‡ï¼Œä¸ºæœªæ¥å‘å±•æ‰“å¥½åŸºç¡€ã€‚',
                'ä»äº”è¡Œè§’åº¦çœ‹ï¼Œæ‚¨éœ€è¦åŠ å¼ºç›¸åº”å…ƒç´ çš„èƒ½é‡æ¥æå‡æ•´ä½“è¿åŠ¿ï¼Œå…·ä½“å»ºè®®å¯å’¨è¯¢è¯¦ç»†å‘½ç†åˆ†æã€‚',
                'æ‚¨çš„å‘½æ ¼æ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„å‘å±•æ½œåŠ›ï¼Œå…³é”®åœ¨äºæ—¶æœºçš„æŠŠæ¡å’Œæ–¹å‘çš„é€‰æ‹©ï¼Œå»ºè®®ç»“åˆå¤§è¿èµ°åŠ¿åˆ¶å®šç­–ç•¥ã€‚',
                'åŸºäºæ‚¨çš„å…«å­—ç‰¹ç‚¹ï¼Œå»ºè®®åœ¨äººé™…å…³ç³»å’ŒèŒä¸šå‘å±•æ–¹é¢ä¿æŒçµæ´»æ€§ï¼Œé€‚æ—¶è°ƒæ•´ç­–ç•¥ã€‚'
            ];
            response = genericResponses[Math.floor(Math.random() * genericResponses.length)];
        }

        addMessage(response, false);
        chatSend.disabled = false;
    }, 1000 + Math.random() * 2000);
}

// æ—¶é—´æœªçŸ¥åŠŸèƒ½
function initTimeUnknown() {
  const timeCheckbox = $('timeUnknown');
  const timeInput = $('birthtime');
  
  if (!timeCheckbox || !timeInput) return;
  
  timeCheckbox.addEventListener('change', () => {
    timeInput.disabled = timeCheckbox.checked;
    if (timeCheckbox.checked) {
      showTimeEstimateDialog();
    }
  });
}

function showTimeEstimateDialog() {
  const periods = [
    { name: 'å­æ—¶', time: '23:00-01:00', value: '00:00' },
    { name: 'ä¸‘æ—¶', time: '01:00-03:00', value: '02:00' },
    { name: 'å¯…æ—¶', time: '03:00-05:00', value: '04:00' },
    { name: 'å¯æ—¶', time: '05:00-07:00', value: '06:00' },
    { name: 'è¾°æ—¶', time: '07:00-09:00', value: '08:00' },
    { name: 'å·³æ—¶', time: '09:00-11:00', value: '10:00' },
    { name: 'åˆæ—¶', time: '11:00-13:00', value: '12:00' },
    { name: 'æœªæ—¶', time: '13:00-15:00', value: '14:00' },
    { name: 'ç”³æ—¶', time: '15:00-17:00', value: '16:00' },
    { name: 'é…‰æ—¶', time: '17:00-19:00', value: '18:00' },
    { name: 'æˆŒæ—¶', time: '19:00-21:00', value: '20:00' },
    { name: 'äº¥æ—¶', time: '21:00-23:00', value: '22:00' }
  ];

  const periodText = periods.map(p => `${p.name}ï¼ˆ${p.time}ï¼‰`).join('\n');
  const selected = prompt(`è¯·é€‰æ‹©å¤§æ¦‚çš„å‡ºç”Ÿæ—¶æ®µï¼š\n${periodText}\n\nè¯·è¾“å…¥æ—¶æ®µåç§°ï¼ˆå¦‚ï¼šå­æ—¶ï¼‰`);
  
  if (selected) {
    const period = periods.find(p => p.name === selected);
    if (period) {
      $('birthtime').value = period.value;
      $('timeUnknown').checked = false;
      $('birthtime').disabled = false;
      showError(`å·²è®¾å®šä¸º${period.name}ï¼ˆ${period.time}ï¼‰çš„ä¸­ä½æ—¶é—´`);
    } else {
      showError('è¾“å…¥çš„æ—¶æ®µåç§°ä¸æ­£ç¡®ï¼Œè¯·é‡æ–°é€‰æ‹©');
    }
  }
}

// å¤šè¯­è¨€æ”¯æŒï¼ˆç®€åŒ–ç‰ˆï¼‰
function initLanguageSupport() {
  const langSelect = $('langSelect');
  if (!langSelect) return;

  // è®¾ç½®é»˜è®¤è¯­è¨€
  const savedLang = localStorage.getItem('bazi_lang') || 'zh-CN';
  langSelect.value = savedLang;
  document.documentElement.lang = savedLang;

  langSelect.addEventListener('change', (e) => {
    const lang = e.target.value;
    localStorage.setItem('bazi_lang', lang);
    document.documentElement.lang = lang;
    applyLanguage(lang);
  });
}

function applyLanguage(lang) {
  // ç®€åŒ–ç‰ˆå¤šè¯­è¨€ - å®é™…é¡¹ç›®ä¸­åº”è¯¥æœ‰å®Œæ•´çš„ç¿»è¯‘æ–‡ä»¶
  const translations = {
    'zh-CN': {
      title: 'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜',
      generate: 'ç”Ÿæˆå…«å­—',
      calculating: 'è®¡ç®—ä¸­...',
      namePlaceholder: 'ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰',
      gender: 'æ€§åˆ«',
      confidential: 'ä¸é€éœ²',
      male: 'ç”·æ€§',
      female: 'å¥³æ€§',
      calendar: 'å†æ³•',
      gregorian: 'é˜³å†',
      lunar: 'å†œå†',
      birthdate: 'å‡ºç”Ÿæ—¥æœŸ',
      birthtime: 'å‡ºç”Ÿæ—¶é—´',
      timeUnknown: 'å‡ºç”Ÿæ—¶é—´ä¸è¯¦',
      yourChart: 'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜',
      elementAnalysis: 'äº”è¡Œèƒ½é‡åˆ†æ',
      wood: 'æœ¨',
      fire: 'ç«',
      earth: 'åœŸ',
      metal: 'é‡‘',
      water: 'æ°´'
    },
    'en': {
      title: 'Bazi Fortune Â· Quick Analysis',
      generate: 'Generate Chart', 
      calculating: 'Calculating...',
      namePlaceholder: 'Your name (for personalization)',
      gender: 'Gender',
      confidential: 'Confidential',
      male: 'Male',
      female: 'Female',
      calendar: 'Calendar',
      gregorian: 'Gregorian',
      lunar: 'Lunar',
      birthdate: 'Birth Date',
      birthtime: 'Birth Time',
      timeUnknown: 'Birth time unknown',
      yourChart: 'Your Bazi Birth Chart',
      elementAnalysis: 'Five Elements Analysis',
      wood: 'Wood',
      fire: 'Fire',
      earth: 'Earth',
      metal: 'Metal',
      water: 'Water'
    },
    'zh-TW': {
      title: 'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤',
      generate: 'ç”Ÿæˆå…«å­—',
      calculating: 'è¨ˆç®—ä¸­...',
      namePlaceholder: 'ä½ çš„ç¨±å‘¼ï¼ˆç”¨æ–¼å€‹æ€§åŒ–ï¼‰',
      gender: 'æ€§åˆ¥',
      confidential: 'ä¸é€éœ²',
      male: 'ç”·æ€§',
      female: 'å¥³æ€§',
      calendar: 'æ›†æ³•',
      gregorian: 'é™½æ›†',
      lunar: 'è¾²æ›†',
      birthdate: 'å‡ºç”Ÿæ—¥æœŸ',
      birthtime: 'å‡ºç”Ÿæ™‚é–“',
      timeUnknown: 'å‡ºç”Ÿæ™‚é–“ä¸è©³',
      yourChart: 'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›¤',
      elementAnalysis: 'äº”è¡Œèƒ½é‡åˆ†æ',
      wood: 'æœ¨',
      fire: 'ç«',
      earth: 'åœŸ',
      metal: 'é‡‘',
      water: 'æ°´'
    }
  };

  const t = translations[lang] || translations['zh-CN'];
  
  // æ›´æ–°ç•Œé¢æ–‡æœ¬
  const titleEl = document.querySelector('.h2');
  if (titleEl) titleEl.textContent = t.title;
  
  const genBtn = $('genBtnText');
  if (genBtn) genBtn.textContent = t.generate;
  
  const nameInput = $('name');
  if (nameInput) nameInput.placeholder = t.namePlaceholder;
  
  // æ›´æ–°è¡¨æ ¼å’Œå…¶ä»–æ–‡æœ¬
  updateElementLabels(t);
}

function updateElementLabels(translations) {
  // æ›´æ–°äº”è¡Œæ ‡ç­¾
  const elements = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
  elements.forEach(element => {
    const elementSpans = document.querySelectorAll(`span:contains('${element}')`);
    elementSpans.forEach(span => {
      if (span.textContent.trim() === element) {
        span.textContent = translations[element.toLowerCase()] || element;
      }
    });
  });
}

// åˆå§‹åŒ–å‡½æ•°
function init() {
  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const today = new Date().toISOString().split('T')[0];
  const birthdateInput = $('birthdate');
  if (birthdateInput && !birthdateInput.value) {
    birthdateInput.value = today;
  }

  // ç»‘å®šäº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', generateBaziChart);
  }

  // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
  initChat();
  initTimeUnknown();
  initLanguageSupport();

  // å›è½¦é”®å¿«é€Ÿç”Ÿæˆ
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && (e.target.id === 'birthdate' || e.target.id === 'birthtime')) {
      generateBaziChart();
    }
  });

  console.log('å…«å­—å‘½ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>  
