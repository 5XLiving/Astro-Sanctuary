<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select,button{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间同一行 + 估时间按钮 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}

    /* —— 右下角心怜管家（只保留“问”悬浮球） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
  </style>
</head>
<body>
  <header>
    <div class="head-inner container">
      <div class="title">命理供门 · 八字简评</div>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="h2">八字命理 · 快速排盘</div>

      <div class="row cols-3">
        <div>
          <label class="muted">姓名（可选）</label>
          <input id="name" placeholder="你的称呼（用于个性化）">
        </div>
        <div>
          <label class="muted">性别</label>
          <select id="gender">
            <option value="">不透露</option>
            <option value="male">男性</option>
            <option value="female">女性</option>
          </select>
        </div>
        <div>
          <label class="muted">历法</label>
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted">出生日期</label>
          <input type="date" id="birthdate">
        </div>
        <div>
          <label class="muted">出生时间</label>
          <div class="time-row">
            <input type="time" id="birthtime" value="12:00">
            <label class="muted time-unknown"><input type="checkbox" id="timeUnknown"> 出生时间不详</label>
            <button class="btn btn-mini ghost" id="guessTimeBtn" type="button" title="用小测试估一下时间">🧭 估时间</button>
          </div>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="genBtn">
            <span id="genBtnText">生成八字</span>
            <span id="genBtnLoading" style="display:none">计算中...</span>
          </button>
        </div>
      </div>

      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2">五行能量分析</div>
        <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
        <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
        <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
        <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
        <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only">Email</label>
                <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="邮箱 Email" data-i18n-ph="ph_email" required/>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点“填入时间”，会用该时段的中位时间写到上方时间输入框，并自动取消“时间不详”。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  /* ================== 配置 & 工具 ================== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

  const $ = id => document.getElementById(id);
  function showErr(msg){ const e=$("error"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
  function showAuthErr(msg){ const e=$("authError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideAuthErr(){ const e=$("authError"); if(!e) return; e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
  function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
  function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

  /* ================== 多语言（精简：含常用键） ================== */
  const LANG_KEY="site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  const translations = {
    "zh-CN": { lang_label:"语言", btn_register:"注册账户", btn_login:"登入账户", btn_reset:"🔑 重设密码",
      note_price:"注册账号赠送一次免费体验", note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
      err_need_ep:"请输入邮箱与密码", err_pwd_rule:"密码至少8位，需包含大写/小写/数字/特殊符号",
      err_no_account:"账户不存在，请先注册", err_wrong_pwd:"密码错误", err_expired:"会员已过期，请续费",
      err_login_fail:"登入失败：", err_register_fail:"注册失败：", err_email_empty:"邮箱不能为空", err_pwd_empty:"密码不能为空",
      prompt_email:"请输入注册邮箱：", prompt_newpwd:"请输入新密码（至少8位，含大小写、数字、符号）：",
      btn_upgrade:"💎 升级为 VIP（月费）", btn_backshop:"← 返回命理商城",
      vip_title:"🌙 会员区域 VIP Segment", vip_mingli:"🗝 命理空间专属内容", vip_xinlian:"🌙 心怜空间专属内容",
      vip_love:"姻缘方向：恋爱缘分、婚姻走势", vip_career:"事业方向：职场发展、创业潜力", vip_wealth:"财运方向：财位分析、理财时机",
      vip_pet:"宠物命理：伴侣动物的性格与缘分", vip_hepan:"合盘分析：婚期择日、新生择时", vip_name:"测名分析：公司名、宝宝名、命名改运",
      vip_fengshui:"财位合盘：住家 / 办公室动线配合", vip_record:"灵性记录：照片、梦境、声音、愿望祈祷", vip_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
      vip_memorial:"家族纪念系统：亲人灵性纪念 & 延续", vip_tasks:"每周能量练习 / 神明仪式任务", vip_shop:"能量商城专属折扣 & 御守订制",
      login_title:"💎 登入 VIP 功能",
      chat_fab:"问", chat_placeholder:"请问您想了解什么？（如：如何开始免费体验）", chat_send:"发送",
      msg_reset_ok:"密码已成功更新，请用新密码重新登入。"
    },
    "zh-TW": { lang_label:"語言", btn_register:"註冊帳戶", btn_login:"登入帳戶", btn_reset:"🔑 重設密碼",
      note_price:"註冊贈一次免費體驗", note_price1:"$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）",
      err_need_ep:"請輸入電子郵件與密碼", err_pwd_rule:"密碼至少8位，需包含大小寫/數字/特殊符號",
      err_no_account:"帳戶不存在，請先註冊", err_wrong_pwd:"密碼錯誤", err_expired:"會員已過期，請續費",
      err_login_fail:"登入失敗：", err_register_fail:"註冊失敗：", err_email_empty:"郵箱不能為空", err_pwd_empty:"密碼不能為空",
      prompt_email:"請輸入註冊郵箱：", prompt_newpwd:"請輸入新密碼（至少8位，含大小寫、數字、符號）：",
      btn_upgrade:"💎 升級為 VIP（月費）", btn_backshop:"← 返回命理商城",
      vip_title:"🌙 會員區域 VIP Segment", vip_mingli:"🗝 命理空間專屬內容", vip_xinlian:"🌙 心憐空間專屬內容",
      vip_love:"姻緣方向：戀愛緣分、婚姻走勢", vip_career:"事業方向：職場發展、創業潛力", vip_wealth:"財運方向：財位分析、理財時機",
      vip_pet:"寵物命理：伴侶動物的性格與緣分", vip_hepan:"合盤分析：婚期擇日、新生擇時", vip_name:"測名分析：公司名、寶寶名、命名改運",
      vip_fengshui:"財位合盤：住家 / 辦公室動線配合", vip_record:"靈性記錄：照片、夢境、聲音、願望祈禱", vip_course:"命理課程：八字 / 塔羅 / 占星 / 靈數 / 人類圖",
      vip_memorial:"家族紀念系統：親人靈性紀念 & 延續", vip_tasks:"每週能量練習 / 神明儀式任務", vip_shop:"能量商城專屬折扣 & 御守訂製",
      login_title:"💎 登入 VIP 功能",
      chat_fab:"問", chat_placeholder:"想了解什麼？（例如：如何開始免費體驗）", chat_send:"發送",
      msg_reset_ok:"密碼已成功更新，請用新密碼重新登入。"
    },
    "en": { lang_label:"Language", btn_register:"Create Account", btn_login:"Log in", btn_reset:"🔑 Reset Password",
      note_price:"New account gets one free trial.", note_price1:"$9.9 / month · VIP (Astro + Soul + Courses)",
      err_need_ep:"Enter email and password", err_pwd_rule:"Password must be 8+ and include upper/lowercase, number, symbol",
      err_no_account:"Account not found. Please register first.", err_wrong_pwd:"Incorrect password", err_expired:"Membership expired. Please renew.",
      err_login_fail:"Login failed: ", err_register_fail:"Registration failed: ", err_email_empty:"Email cannot be empty", err_pwd_empty:"Password cannot be empty",
      prompt_email:"Enter your registered email:", prompt_newpwd:"Enter a new password (8+, upper/lower/digit/symbol):",
      btn_upgrade:"💎 Upgrade to VIP (Monthly)", btn_backshop:"← Back to Store",
      vip_title:"🌙 VIP Segment", vip_mingli:"🗝 Astro Sanctuary · Exclusive", vip_xinlian:"🌙 Soul Sanctuary · Exclusive",
      vip_love:"Love: Dating Fate, Marriage Trend", vip_career:"Career: Workplace, Entrepreneurship", vip_wealth:"Wealth: Wealth Position, Timing",
      vip_pet:"Pet Destiny: Temperament & Bond", vip_hepan:"Synastry: Wedding Dates, Birthtime", vip_name:"Name Reading: Company/Baby/Renaming",
      vip_fengshui:"Wealth & Layout: Home / Office", vip_record:"Spiritual Logs: Photos, Dreams, Voice, Prayers", vip_course:"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family Memorial: Spiritual Archive & Legacy", vip_tasks:"Weekly Energy Practices / Divine Ritual Tasks", vip_shop:"Store Discounts & Omamori",
      login_title:"💎 VIP Login",
      chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., how to start the free trial)", chat_send:"Send",
      msg_reset_ok:"Password updated. Please log in with the new one."
    }
  };
  function t(key){ const L = translations[getLang()] || translations["zh-CN"]; return L[key] || (translations["zh-CN"][key] || key); }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{ const key=el.getAttribute("data-i18n"); el.textContent=t(key);});
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{ const key=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(key));});
  }
  function applyChatI18n(){
    const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

  /* ================== 八字计算器（保持你的算法，修正模板字符串） ================== */
  class BaziCalculator{
    constructor(){
      this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
      this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
      this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
      this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
    }
    calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
    solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return{index:idx,branch:branchBy[idx]}; }
    calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
    calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
    calculateHourPillar(dayStem,hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
    getElement(stem,branch){ const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`; }
    getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
    getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
    getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
    calculateBazi(year,month,day,hour=12,timeUnknown=false){
      const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
      const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
      const dayElement=this.getStemElement(dayP.stem);
      const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
      const cnt={木:0,火:0,土:0,金:0,水:0};
      (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='？')cnt[this.getBranchElement(p.branch)]+=1; });
      const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
      const pct={wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100};
      return {pillars,counts:cnt,percents:pct,timeUnknown};
    }
  }
  const baziCalculator = new BaziCalculator();

  /* ================== 规则/渲染 ================== */
  function renderPillars(root,p,timeUnknown=false){
    if(!root) return; root.innerHTML='';
    [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
      const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem,branch=u?'？':v.branch;
      const div=document.createElement('div'); div.className='pillar'; div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`; root.appendChild(div);
    });
  }
  function displayClassicArea(p,timeUnknown){
    const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
    setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
    setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
    setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
    setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
    const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
    setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
    setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
    setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
    setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
  }
  function judgeStrength(dayGan,monthZhi,cnt){
    const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
    const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
    const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
    let score=0; if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
    score+=(cnt[dmEl]||0)*1.2; const mark=score>=3?'偏强':(score<=1?'偏弱':'平衡'); const focus=mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和'); return{season,mark,focus};
  }
  function chooseUseful(strength,dmElem){
    if(strength==='偏强') return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]};
    if(strength==='偏弱') return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]};
    return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
  }

  /* ================== 心怜管家（分析器） ================== */
  class XinLianAssistant{
    constructor(){ this.currentContext=null; }
    generateAnalysis(baziData){ this.currentContext=baziData; const a=$('assistant-analysis'), b=$('assistant-advice'); if(a) a.innerHTML=this.analyzeBazi(baziData); if(b) b.innerHTML=this.generateAdvice(baziData); }
    analyzeBazi({dayMaster,elements,strength,season,timeUnknown}){
      const timeNote=timeUnknown?'<li><strong>注意：</strong>已勾选“出生时间不详”，<strong>未纳入时柱</strong>。</li>':'';
      return `<ul class="ul">
        <li>日主：<strong>${dayMaster.stem}（${dayMaster.element}）</strong></li>
        <li>命局<strong>${strength.mark}</strong>：${this.getStrengthDescription(strength.mark)}</li>
        <li>季节：<strong>${season}</strong>，${this.getSeasonInfluence(season)}</li>
        <li>五行分布：${this.getElementDistribution(elements)}</li>
        ${timeNote}
      </ul>`;
    }
    generateAdvice({strength,useful,timeUnknown}){
      const timeWarn=timeUnknown?'<li><strong>提示：</strong>无时柱，建议仅作参考。</li>':'';
      return `<ul class="ul">
        <li><strong>发展策略：</strong>${strength.focus}</li>
        <li><strong>喜用元素：</strong>${(useful.useful||[]).join('、')}</li>
        <li><strong>幸运颜色：</strong>${this.getLuckyColors(useful.useful||[])}</li>
        <li><strong>适合方位：</strong>${this.getLuckyDirections(useful.useful||[])}</li>
        ${timeWarn}
      </ul>`;
    }
    getStrengthDescription(m){ return {偏强:'潜力足、抗压好',偏弱:'需外援更能发挥',平衡:'均衡、适应性强'}[m]||'具有独特特点'; }
    getSeasonInfluence(season){ const m={春:'木旺生发',夏:'火旺外放',秋:'金旺收敛',冬:'水旺内藏'}; return m[season]||'季节对命局有一定影响'; }
    getLuckyColors(list){ const m={木:'绿色/青色',火:'红色/紫色',土:'黄色/棕色',金:'白色/金色',水:'黑色/蓝色'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
    getLuckyDirections(list){ const m={木:'东方',火:'南方',土:'中央/东北/西南',金:'西方',水:'北方'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
    ELABEL(){ return {wood:'木',fire:'火',earth:'土',metal:'金',water:'水'}; }
    getElementDistribution(elements){ const L=this.ELABEL(); return Object.entries(elements).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${L[k]||k}${Math.round(v)}%`).join('、'); }
  }

  /* ================== 免费/富报告 ================== */
  function buildFreeReportHTML({pillars,percents,st,adv,timeUnknown}){
    const L={wood:'木',fire:'火',earth:'土',metal:'金',water:'水'};
    const entries=Object.entries(percents); const strongestK=entries.reduce((a,b)=>a[1]>b[1]?a:b)[0]; const weakestK=entries.reduce((a,b)=>a[1]<b[1]?a:b)[0];
    const strongest=L[strongestK], weakest=L[weakestK]; const absents=Object.keys(percents).filter(k=>Math.round(percents[k])===0).map(k=>L[k]).join('、');
    const fmt=k=>`${L[k]} ${Math.round(percents[k]||0)}%`; const line=['wood','fire','earth','metal','water'].map(fmt).join('　');
    const fav=(adv?.useful||[]).join('、'); const avoid=(adv?.avoid||[]).join('、')||'—'; const hourTxt=timeUnknown?'？？':(pillars.hour.stem+pillars.hour.branch);
    return `<div class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px;color:var(--brand)">免费报告</h3>
      <p style="margin:6px 0;">四柱：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">日主：<strong>${pillars.day.stem}</strong>（<strong>${pillars.day.element}</strong>）｜季节：<strong>${st.season||'-'}</strong>｜命局：<strong>${st.mark}</strong> · <strong>${st.focus}</strong></p>
      <p style="margin:8px 0;">五行：${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>偏旺；<strong>${weakest}</strong>偏弱。${absents?`<span class="muted">（缺：${absents}）</span>`:''}</p>
      <ul style="margin:6px 0 0 18px;line-height:1.6">
        <li>喜用优先：<strong>${fav||'—'}</strong>；忌讳：${avoid}</li>
        <li>调衡要点：${st.focus}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">提示：时间不详，时柱未纳入。</p>`:''}
    </div>`;
  }
  function buildRichReportHTML({pillars,percents,st,adv,timeUnknown}){
    const L={wood:'木',fire:'火',earth:'土',metal:'金',water:'水'}; const P=pillars;
    const line=['wood','fire','earth','metal','water'].map(k=>`${L[k]}${Math.round(percents[k]||0)}%`).join(' ');
    const entries=Object.entries(percents); const strongestK=entries.reduce((a,b)=>a[1]>b[1]?a:b, ['wood',0])[0]; const weakestK=entries.reduce((a,b)=>a[1]<b[1]?a:b, ['wood',0])[0];
    const strongest=L[strongestK]||'—', weakest=L[weakestK]||'—'; const absents=Object.keys(percents).filter(k=>Math.round(percents[k]||0)===0).map(k=>L[k]).join('、');
    const favList=(adv?.useful||[]).join('、')||'—', avoidList=(adv?.avoid||[]).join('、')||'—'; const hourTxt=timeUnknown?'？？':(P.hour.stem+P.hour.branch);
    return `
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">一、命盘总览</h3>
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
          <div>四柱：<strong>${P.year.stem}${P.year.branch} ${P.month.stem}${P.month.branch} ${P.day.stem}${P.day.branch} ${hourTxt}</strong></div>
          <div>日主：<strong>${P.day.stem}</strong>（<strong>${P.day.element}</strong>）</div>
          <div>季节：<strong>${st.season||'-'}</strong></div>
          <div>命局：<strong>${st.mark}</strong> · 策略：<strong>${st.focus}</strong></div>
        </div>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">二、五行能量分析</h3>
        <div style="font-size:14px;">${line}</div>
        <p style="margin:10px 0 0;"><strong>${strongest}</strong>偏旺；<strong>${weakest}</strong>偏弱。${absents?`<span class="muted">（缺：${absents}）</span>`:''}</p>
        <ul style="margin:10px 0 0 18px;line-height:1.6"><li>喜用优先：<strong>${favList}</strong></li><li>调衡要点：${st.focus}</li></ul>
        ${timeUnknown?`<p class="muted" style="margin-top:8px;">提示：出生时间不详，未纳入时柱。</p>`:''}
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">三、性格与天赋</h3>
        <p style="margin:8px 0;">依据日主、季节与强弱给出核心性格标签（模板化）。</p>
        <p style="margin:8px 0;">优势能量：执行/创造/学习（模板化）</p>
        <p style="margin:8px 0;">潜在挑战：急躁/边界（模板化）</p>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">四、格局与喜忌</h3>
        <p style="margin:8px 0;">喜用：${favList}；忌讳：${avoidList}</p>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">五、事业与发展（免费试读）</h3>
        <p style="margin:8px 0;">适合领域：依据喜用与日主气质（模板化）</p>
        <p style="margin:8px 0;">发展策略：${st.focus}，建立 SOP</p>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">六、感情与关系（免费试读）</h3>
        <p style="margin:8px 0;">沟通节奏与边界（模板化）</p>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">七、财富与理财（免费试读）</h3>
        <p style="margin:8px 0;">理财建议：以 ${favList} 为主调，稳中求进</p>
      </section>
      <section class="card" style="padding:20px;">
        <h3 style="margin-top:0;color:var(--brand)">八、健康与作息</h3>
        <p style="margin:8px 0;">按最弱五行（${weakest}）制定作息（模板化）</p>
      </section>
      <section class="card" style="padding:20px;margin-bottom:10px;">
        <h3 style="margin-top:0;color:var(--brand)">解锁完整专属报告</h3>
        <p style="margin:8px 0;">升级 VIP 获取 “事业策略树 / 婚姻合盘 / 90 天里程碑 / 风水微调 / 祈愿修心”。</p>
        <div style="margin-top:10px;"><a href="/vip" style="display:inline-block;padding:10px 16px;border-radius:10px;background:var(--brand);color:#111;font-weight:700;text-decoration:none;">升级 VIP</a></div>
      </section>`;
  }
  function mountRichReport({pillars,percents,st,adv,timeUnknown}){
    let host=$('xl-rich-report'); if(!host){ host=document.createElement('section'); host.id='xl-rich-report'; host.className='container'; host.style.paddingTop='12px'; ($('result')||document.body).appendChild(host); }
    host.innerHTML=buildRichReportHTML({pillars,percents,st,adv,timeUnknown});
  }

  /* ================== 管家卡片 & GPT 抽屉（抽屉被CSS隐藏） ================== */
  function buildButlerHTML(){ return `<div id="assistant-panel" class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);"><h3 style="margin:0 0 8px;color:var(--brand)">心怜管家 · 智能解读</h3><div id="assistant-analysis"></div><div id="assistant-advice" style="margin-top:8px"></div></div>`; }
  function buildChatDrawerHTML(){ return `<details id="gpt-drawer" class="xl-card" style="margin-top:12px;padding:0;border-radius:10px;background:var(--card);box-shadow:var(--shadow);"><summary style="cursor:pointer;list-style:none;padding:12px 16px;font-weight:700;color:var(--brand);">GPT 问答</summary><div style="padding:10px 12px;"><div id="gpt-body" style="max-height:260px;overflow:auto;font-size:14px;line-height:1.5;border:1px solid #222;border-radius:8px;padding:8px;"></div><div style="display:flex;gap:8px;margin-top:8px;"><input id="gpt-input" placeholder="问点什么…" style="flex:1;padding:8px;border-radius:8px;border:1px solid #222;background:#0b0f14;color:var(--text)"><button id="gpt-send" style="padding:8px 12px;border-radius:8px;background:var(--brand);color:#111;font-weight:700">发送</button></div></div></details>`; }
  async function callChatAPI(userText,ctx){
    const payload={messages:[{role:'user',content:userText}],context:ctx};
    async function post(url){ try{ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(r.ok){ const t=await r.text(); try{ const j=JSON.parse(t); return j.reply||t||'（无响应）'; }catch{return t||'（无响应）'; } } }catch(_){} return null; }
    return await post('/api/butler/chat') || await post('/api/chat') || '（暂时无法连接到服务端）';
  }
  function mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown}){
    const resultEl=$('result'); if(!resultEl) return;
    let freeNode=$('xl-free-report'); if(!freeNode){ freeNode=document.createElement('div'); freeNode.id='xl-free-report'; resultEl.appendChild(freeNode); }
    freeNode.innerHTML=buildFreeReportHTML({pillars,percents,st,adv,timeUnknown});
    let butler=$('assistant-panel'); if(!butler){ const wrap=document.createElement('div'); wrap.innerHTML=buildButlerHTML(); resultEl.appendChild(wrap.firstElementChild); }
    const ctx={ dayMaster:{stem:pillars.day.stem,element:pillars.day.element}, elements:percents, strength:st, season:st.season, useful:adv, timeUnknown };
    new XinLianAssistant().generateAnalysis(ctx);
    window.__bazi_ctx__={pillars,wuxing_ratio:percents,season:st.season,strength:st.mark,strategy:st.focus,useful:adv?.useful||[],timeUnknown};
    // （可选）插入被隐藏的 GPT 抽屉，保持结构一致
    if(!$('gpt-drawer')){ const wrap=document.createElement('div'); wrap.innerHTML=buildChatDrawerHTML(); resultEl.appendChild(wrap.firstElementChild); }
  }

  /* ================== 生成命盘 ================== */
  async function genChart(){
    const birth=($('birthdate')?.value||'').trim(); const timeUnknown=$('timeUnknown')?.checked||false;
    if(!birth){ showErr('请填写出生日期。'); return; }
    const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading'); if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';
    try{
      const [Y,M,D]=birth.split('-').map(Number); let hour=12;
      if(!timeUnknown){ const t=($('birthtime')?.value||'').trim(); if(t) hour=parseInt(t.split(':')[0],10); }
      const {pillars,counts,percents,timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);
      $('result')?.style.setProperty('display','block');
      const timeText=tu?'时间不详':(hour+'时'); setText('bazi-date',`出生日期: ${Y}年${M}月${D}日 ${timeText}`);
      if(tu){ const el=$('bazi-date'); el&&(el.innerHTML+=' <span class="badge-warn">未纳入时柱</span>'); }
      renderPillars($('bazi-pillars'),pillars,tu); displayClassicArea(pillars,tu);
      setBar($('bar-木'),percents.wood);  setText('pct-木',Math.round(percents.wood)+'%');
      setBar($('bar-火'),percents.fire);  setText('pct-火',Math.round(percents.fire)+'%');
      setBar($('bar-土'),percents.earth); setText('pct-土',Math.round(percents.earth)+'%');
      setBar($('bar-金'),percents.metal); setText('pct-金',Math.round(percents.metal)+'%');
      setBar($('bar-水'),percents.water); setText('pct-水',Math.round(percents.water)+'%');
      const st=judgeStrength(pillars.day.stem,pillars.month.branch,counts);
      const adv=chooseUseful(st.mark,pillars.day.element);
      const keys=Object.keys(counts); const maxK=keys.reduce((a,b)=>counts[a]>counts[b]?a:b); const minK=keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
      setText('bazi-elements-balance',`五行中${maxK}元素最强，${minK}元素最弱。`);
      mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown:tu});
      mountRichReport({pillars,percents,st,adv,timeUnknown:tu});
      console.log('实际 →', pillars.year.stem+pillars.year.branch, pillars.month.stem+pillars.month.branch, pillars.day.stem+pillars.day.branch, tu?'？':(pillars.hour.stem+pillars.hour.branch));
    }catch(err){ console.error(err); showErr('计算八字时出现错误，请重试'); }
    finally{ if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none'; }
  }

  /* ================== Chat 悬浮球 ================== */
  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat 浮窗（按钮+面板）
    const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title='心怜管家';
    const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head"><div class="ss-chat-title">心怜管家 · Chat</div><div class="ss-close" id="ssChatClose">✕</div></div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input"><input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')}"/><button id="ssChatSend" class="btn">${t('chat_send')}</button></div>`;
    document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
    applyChatI18n();

    const $body=$('ssChatBody'), $input=$('ssChatInput'), $send=$('ssChatSend'), $close=$('ssChatClose');
    const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); }; const closePanel=()=>{ chatPanel.style.display='none'; };
    chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);

    function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
    async function askChat(prompt){
      addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。'},{role:'user',content:prompt}]})});
        let data,reply=''; try{data=await r.json()}catch{data={}} reply=data.reply??data.text??data?.choices?.[0]?.message?.content??"";
        if(!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。'); addMsg(reply);
      }catch(e){ addMsg('网络异常，请稍后再试。'); }
    }
    $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
    $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
  });

  /* ================== 估时间向导 ================== */
  (function initBirthtimeWizard(){
    const tChk=$('timeUnknown'), tInput=$('birthtime'), btn=$('guessTimeBtn');
    const twMask=$('twMask'), twGrid=$('twGrid'), twApply=$('twApply'), twCancel=$('twCancel');
    if(!tInput||!tChk||!btn||!twMask||!twGrid||!twApply||!twCancel) return;

    const DZ=[
      ['子','23:00–01:00','00:00'],['丑','01:00–03:00','02:00'],['寅','03:00–05:00','04:00'],['卯','05:00–07:00','06:00'],
      ['辰','07:00–09:00','08:00'],['巳','09:00–11:00','10:00'],['午','11:00–13:00','12:00'],['未','13:00–15:00','14:00'],
      ['申','15:00–17:00','16:00'],['酉','17:00–19:00','18:00'],['戌','19:00–21:00','20:00'],['亥','21:00–23:00','22:00']
    ];
    let selected=null;

    function openWizard(){
      twMask.style.display='flex'; selected=null; twApply.disabled=true;
      if(!twGrid.dataset.built){
        DZ.forEach(([z,range])=>{
          const b=document.createElement('button'); b.type='button'; b.className='tw-btn'; b.textContent=`${z}（${range}）`;
          b.addEventListener('click',()=>{ [...twGrid.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); selected=z; twApply.disabled=false;});
          twGrid.appendChild(b);
        }); twGrid.dataset.built='1';
      }else{ [...twGrid.children].forEach(x=>x.classList.remove('active')); }
    }
    function closeWizard(){ twMask.style.display='none'; }
    tChk.addEventListener('change', ()=>{ tInput.disabled=tChk.checked; if(tChk.checked) openWizard(); });
    btn.addEventListener('click', openWizard);
    twCancel.addEventListener('click', closeWizard);
    twApply.addEventListener('click', ()=>{
      if(!selected) return;
      const mid=Object.fromEntries(DZ.map(([z,_,m])=>[z,m]))[selected];
      tInput.value=mid; tInput.disabled=false; tChk.checked=false; closeWizard();
    });
    tInput.disabled=tChk.checked;
  })();

  /* ================== 登录流程 ================== */
  async function safeJson(resp){ try{return await resp.json()}catch{return{ok:false,msg:'upstream_error'}} }
  async function loginFlow(email,password){
    const res=await safeJson(await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
    const msg=(res.msg||"").toString().toLowerCase(); let expired=false;
    if(res.expired===true) expired=true; else if(msg==='expired') expired=true; else if(res.expiresAt){ const ts=Date.parse(res.expiresAt); if(!Number.isNaN(ts)&&ts<Date.now()) expired=true; }
    if(expired){ const go=confirm(t('err_expired')+'。是否前往续费？'); if(go) window.open('https://yourshopifyshop.com/products/monthly-vip','_blank'); return; }
    if(res.ok===true){ localStorage.setItem('vipEmail',res.email||email); location.href='https://astro.5xliving.com/vip_soul_sanctuary.html'; return; }
    if(msg==='no_account') return showAuthErr(t('err_no_account'));
    if(msg==='wrong_pwd') return showAuthErr(t('err_wrong_pwd'));
    return showAuthErr(t('err_login_fail')+(res.msg?` ${res.msg}`:''));
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // 默认日期
    const today=new Date(); const def=today.toISOString().split('T')[0]; if($('birthdate')&&!$('birthdate').value) $('birthdate').value=def;
    $('genBtn')?.addEventListener('click',genChart);

    // i18n
    const select=$("langSelect"); const current=getLang(); if(select) select.value=current; applyI18n(); applyChatI18n();
    if(select){ select.addEventListener('change', ()=>{ setLang(select.value); applyI18n(); applyChatI18n(); }); }

    // 注册
    $('registerForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); hideAuthErr();
      const email=$('email').value.trim(); const password=$('password').value.trim();
      if(!email||!password) return showAuthErr(t('err_need_ep'));
      if(!strongPwd(password)) return showAuthErr(t('err_pwd_rule'));
      lock($('registerBtn'),true);
      try{
        const res=await safeJson(await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
        if(res.ok===true){ localStorage.setItem('vipEmail',email); location.href='vip_trial.html'; return; }
        if((res.msg||"").toString()==='exists'){ await loginFlow(email,password); return; }
        return showAuthErr((res.msg&&(res.msg+''))||t('err_register_fail'));
      }catch(err){ showAuthErr(t('err_register_fail')+(err?.message||'')); }
      finally{ lock($('registerBtn'),false); }
    });

    // 登录
    $('loginForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); hideAuthErr();
      const email=$('email').value.trim(); const password=$('password').value.trim();
      if(!email||!password) return showAuthErr(t('err_need_ep'));
      lock($('loginBtn'),true);
      try{ await loginFlow(email,password); }
      catch(err){ showAuthErr(t('err_login_fail')+(err?.message||'')); }
      finally{ lock($('loginBtn'),false); }
    });

    // 重设密码
    $('resetBtn')?.addEventListener('click', async ()=>{
      hideAuthErr();
      let email=prompt(t('prompt_email')); if(email===null) return; email=email.trim(); if(!email) return showAuthErr(t('err_email_empty'));
      let newPassword=prompt(t('prompt_newpwd')); if(newPassword===null) return; newPassword=newPassword.trim(); if(!newPassword) return showAuthErr(t('err_pwd_empty'));
      if(!strongPwd(newPassword)) return showAuthErr(t('err_pwd_rule'));
      lock($('resetBtn'),true);
      try{
        const res=await safeJson(await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword})}));
        if(!res.ok) return showAuthErr((res.msg&&(res.msg+''))||t('err_reset_fail'));
        alert(t('msg_reset_ok'));
      }catch(err){ showAuthErr(t('err_reset_fail')+(err?.message||'')); }
      finally{ lock($('resetBtn'),false); }
    });
  });

  /* ================== 自测（控制台）：1978-02-21 12:00 应为 戊午 甲寅 甲寅 庚午 ================== */
  (function(){
    const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12);
    console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
    console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
  })();
  </script>
</body>
</html>
