<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…«å­—å‘½ç† Â· 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="icon" href="data:,"><!-- é¿å… favicon 404 -->
<style>
:root{
  --bg:#0b0f14;
  --card:#11161dcc;
  --text:#e8edf3;
  --muted:#9aa3b2;
  --brand:#d4af37;
  --gold2:#f2d27a;
  --radius:14px;
  --shadow:0 8px 30px rgba(0,0,0,.35);
  --accent:#3a86ff;
  /* æ–°å¢ï¼šä¼šå‘˜åŒºæ ·å¼ç”¨åˆ°çš„å˜é‡ */
  --panel: rgba(255,255,255,.04);
  --border:#273246;
  --gold:#ffe084;
}  
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6}
.container{width:100%;max-width:1100px;padding:24px 16px 80px;margin:0 auto}
header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(12px);background:#0b0f14cc;border-bottom:1px solid #0f1622}
.head-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0;gap:14px}
.title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
.h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
.h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
.muted{color:var(--muted)}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
.bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
.badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}

/* è¯­è¨€é€‰æ‹©å™¨ */
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px;font-size:.95rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}

/* æ‚¬æµ®æ°”æ³¡æŒ‰é’® */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e}

/* ç®€æ˜“èŠå¤©é¢æ¿ï¼ˆå¯æŒ‰éœ€å†ç¾åŒ–ï¼‰ */
.ss-chat-panel{position:fixed;right:18px;bottom:88px;z-index:50;display:none;flex-direction:column;width:320px;max-width:92vw;background:#0e1520;border:1px solid rgba(212,175,55,.25);border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.45)}
.ss-chat-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(212,175,55,.25);color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px 12px;max-height:360px;overflow:auto;font-size:14px}
.ss-chat-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(212,175,55,.25)}
.ss-chat-input input{flex:1;border-radius:8px;border:1px solid #243244;background:#0b0f14;color:var(--text);padding:10px}
.ss-chat-input button{border-radius:8px;background:var(--brand);color:#111;font-weight:700;padding:10px 12px}
.ss-msg{background:#111823;border:1px solid #263448;border-radius:10px;padding:8px 10px;margin:6px 0}
.ss-msg.me{background:#1a2433;border-color:#32435a}

#gpt-drawer {display:block!important}
#gpt-drawer[hidden]{display:block!important}
#gpt-drawer>summary{display:block;cursor:pointer}
  /* ä¼šå‘˜åŒºæ•´ä½“å¡ç‰‡ */
.astro-auth{ max-width: 980px; margin: 28px auto; padding: 20px 18px;
  background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
  border: 1px solid var(--border); border-radius: var(--radius);
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
}
/* ä¸¤åˆ—å¸ƒå±€ */
.auth-grid{ display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; }
@media (max-width: 860px){ .auth-grid{ grid-template-columns: 1fr; } }

/* å†…éƒ¨å¡ç‰‡ */
.panel{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid var(--border); border-radius: var(--radius);
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.panel .head{ padding:16px 18px; border-bottom:1px solid var(--border);
  color:var(--gold); font-weight:700; letter-spacing:.3px;
}
.panel .body{ padding:18px; }

/* è¡¨å•è¡Œ */
.row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
.row.one{ grid-template-columns: 1fr; }
@media (max-width:640px){ .row{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">å‘½ç†ä¾›é—¨ Â· å…«å­—ç®€è¯„</div>
    <!-- è¯­è¨€é€‰æ‹©å™¨ -->
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰">
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender"><option value="">ä¸é€éœ²</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar"><option value="gregorian">é˜³å† / Gregorian</option><option value="lunar">å†œå† / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> å‡ºç”Ÿæ—¶é—´ä¸è¯¦</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ä¼šå‘˜ä¸“åŒº -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

    <!-- ç™»å½•/æ³¨å†Œè¡¨å•ï¼Œæ”¯æŒå›è½¦æäº¤ -->
    <section class="astro-auth">
      <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <!-- å…¬å…±è¾“å…¥ -->
            <div class="row" id="authFields">
              <label for="email" class="sr-only">Email</label>
              <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="é‚®ç®± Email" data-i18n-ph="ph_email" required />
              <input id="password" type="password" autocomplete="new-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required />
            </div>

            <div class="spacer"></div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
            </form>

            <div class="spacer"></div>

            <!-- é‡è®¾å¯†ç  -->
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>

            <div class="spacer"></div>

            <!-- æ³¨å†Œè¡¨å• -->
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
            </form>

            <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
            <div class="spacer"></div>
            <div class="error" id="auth-error" style="display:none"></div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>

            <div class="spacer"></div>

            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>

            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<script>
/* ---------------- åŸºç¡€å·¥å…· ---------------- */
const $ = (id)=>document.getElementById(id);

/* ============== å¤šè¯­è¨€å­—å…¸ï¼ˆä¿æŒåŸæ ·ï¼‰ ============== */
const translations={/* â€¦â€¦ï¼ˆä¿æŒä½ åŸæ¥çš„æ•´ä»½ translationsï¼›æ­¤å¤„çœç•¥ï¼Œä¸ºäº†é˜…è¯»ï¼‰ â€¦â€¦ */};
function t(key){
  const dict = (typeof translations === 'object' && translations) ? (translations[getLang()] || translations["zh-CN"] || {}) : {};
  return dict[key] || key;
}
const LANG_KEY="site_lang";
function getLang(){return localStorage.getItem(LANG_KEY)||document.documentElement.lang||"zh-CN";}
function setLang(code){localStorage.setItem(LANG_KEY,code);document.documentElement.lang=code;}
function applyI18n(){document.querySelectorAll("[data-i18n]").forEach(el=>{const k=el.getAttribute("data-i18n");el.textContent=t(k)});document.querySelectorAll("[data-i18n-ph]").forEach(el=>{const k=el.getAttribute("data-i18n-ph");el.setAttribute("placeholder",t(k))});}
function applyChatI18n(){const fab=$('ssChatFab');const inp=$('ssChatInput');const btn=$('ssChatSend');if(fab) fab.textContent=t('chat_fab');if(inp) inp.placeholder=t('chat_placeholder');if(btn) btn.textContent=t('chat_send');}

/* ============== å…«å­—è®¡ç®—å™¨ï¼ˆä¿æŒä½ çš„ç®—æ³•ï¼‰ ============== */
class BaziCalculator{constructor(){this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];this.ZODIAC=['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];}
calculateYearPillar(year){const s=(year-4)%10,b=(year-4)%12;return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]};}
solarMonthIndex(y,m,d){const mmdd=m*100+d;const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];let idx=11;for(const [thr,val]of gates)if(mmdd>=thr)idx=val;const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};return{index:idx,branch:branchBy[idx]};}
calculateMonthPillar(year,month,day){const {index,branch}=this.solarMonthIndex(year,month,day);const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};const stemIdx=(startMap[yStemIdx]+(index-1))%10;return{stem:this.HEAVENLY_STEMS[stemIdx],branch};}
calculateDayPillar(year,month,day){const baseUTC=Date.UTC(1900,0,31);const targetUTC=Date.UTC(year,month-1,day);const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);const stemIdx=(0+dayDiff)%10;const branchIdx=(4+dayDiff)%12;return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};}
calculateHourPillar(dayStem,hour){const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);const hourIndex=Math.floor((hour+1)/2)%12;const stemIdx=(startMap[dayIdx]+hourIndex)%10;return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]};}
getStemElement(stem){return({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]}
getBranchElement(branch){return({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]}
calculateBazi(year,month,day,hour=12,timeUnknown=false){const yearP=this.calculateYearPillar(year);const monthP=this.calculateMonthPillar(year,month,day);const dayP=this.calculateDayPillar(year,month,day);const hourP=timeUnknown?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:this.calculateHourPillar(dayP.stem,hour);const dayElement=this.getStemElement(dayP.stem);const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};(timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{if(p.stem&&p.stem!=='ï¼Ÿ')cnt[this.getStemElement(p.stem)]+=1;if(p.branch&&p.branch!=='ï¼Ÿ')cnt[this.getBranchElement(p.branch)]+=1});const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;const pct={wood:cnt['æœ¨']/total*100,fire:cnt['ç«']/total*100,earth:cnt['åœŸ']/total*100,metal:cnt['é‡‘']/total*100,water:cnt['æ°´']/total*100};return{pillars,counts:cnt,percents:pct,timeUnknown};}}
const baziCalculator=new BaziCalculator();

/* ---------------- è§„åˆ™/æ¸²æŸ“ï¼ˆä¿æŒä½ çš„é€»è¾‘ï¼‰ ---------------- */
function setText(id,v){const el=$(id);if(el) el.textContent=v}
function setBar(el,pct){if(el) el.style.width=Math.max(0,Math.min(100,pct))+'%'}
function showError(msg){const el=$('error');if(!el) return;el.textContent=msg;el.style.display='block';setTimeout(()=>{el.style.display='none'},5000)}
function renderPillars(root,p,timeUnknown=false){if(!root)return;root.innerHTML='';[['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{const u=(tit==='æ—¶æŸ±'&&timeUnknown);const stem=u?'ï¼Ÿ':v.stem,branch=u?'ï¼Ÿ':v.branch;const div=document.createElement('div');div.className='pillar';div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;root.appendChild(div)})}
function displayClassicArea(p,timeUnknown){const ge=(s,b)=>baziCalculator.getStemElement(s)+baziCalculator.getBranchElement(b);const ny=(s,b)=>baziCalculator.getNayin?s+b:b;setText('year-stem',p.year.stem);setText('year-branch',p.year.branch);setText('month-stem',p.month.stem);setText('month-branch',p.month.branch);setText('day-stem',p.day.stem);setText('day-branch',p.day.branch);setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem);setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);const setIf=(id,val)=>{const el=$(id);if(el) el.textContent=val};setIf('year-element',ge(p.year.stem,p.year.branch));setIf('month-element',ge(p.month.stem,p.month.branch));setIf('day-element',ge(p.day.stem,p.day.branch));setIf('hour-element',timeUnknown?'æœªçŸ¥':ge(p.hour.stem,p.hour.branch));
function judgeStrength(dayGan,monthZhi,cnt){const STEM_ELEM={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};const SEASON_BY_MONTH_BRANCH={å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};const dmEl=STEM_ELEM[dayGan];const season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';let score=0;if((season==='æ˜¥'&&'æœ¨ç«'.includes(dmEl))||(season==='å¤'&&'ç«åœŸ'.includes(dmEl))||(season==='ç§‹'&&dmEl==='é‡‘')||(season==='å†¬'&&dmEl==='æ°´'))score+=2;score+=(cnt[dmEl]||0)*1.2;const mark=score>=3?'åå¼º':(score<=1?'åå¼±':'å¹³è¡¡');const focus=mark==='åå¼º'?'æ³„ç§€/åˆ¶åŒ–':(mark==='åå¼±'?'è¡¥åŠ©/é¡ºåŠ¿':'å®ˆä¸­/è°ƒå’Œ');return{season,mark,focus}}
const hasNayin = typeof baziCalculator.getNayin === 'function';
setIf('year-nayin',  hasNayin ? baziCalculator.getNayin(p.year.stem, p.year.branch)  : 'â€”');
setIf('month-nayin', hasNayin ? baziCalculator.getNayin(p.month.stem,p.month.branch) : 'â€”');
setIf('day-nayin',   hasNayin ? baziCalculator.getNayin(p.day.stem,  p.day.branch)   : 'â€”');
setIf('hour-nayin',  timeUnknown ? 'æœªçŸ¥' : (hasNayin ? baziCalculator.getNayin(p.hour.stem,p.hour.branch) : 'â€”'));
function chooseUseful(strength,dmElem){
  if (strength==='åå¼º'){
    return {
      strategy:'æ³„ç§€/åˆ¶åŒ–',
      useful:({æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']})[dmElem],
      avoid:[dmElem]
    };
  } else if (strength==='åå¼±'){
    return {
      strategy:'ç”Ÿæ‰¶/è¡¥åŠ©',
      useful:({æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']})[dmElem],
      avoid:[]
    };
  }
  return {strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}
  
function buildChatDrawerHTML(){
  return `
  <details id="gpt-drawer" open class="xl-card" style="margin-top:12px;padding:0;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
    <summary style="cursor:pointer;list-style:none;padding:12px 16px;font-weight:700;color:var(--brand);">å¿ƒæ€œç®¡å®¶</summary>
    <div style="padding:10px 12px;">
      <div id="gpt-body" style="max-height:260px;overflow:auto;font-size:14px;line-height:1.5;border:1px solid #222;border-radius:8px;padding:8px;"></div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input id="gpt-input" placeholder="é—®ç‚¹ä»€ä¹ˆâ€¦" style="flex:1;padding:8px;border-radius:8px;border:1px solid #222;background:#0b0f14;color:var(--text)">
        <button id="gpt-send" style="padding:8px 12px;border-radius:8px;background:var(--brand);color:#111;font-weight:700">å‘é€</button>
      </div>
    </div>
  </details>`;
}
async function callChatAPI(userText,ctx){const payload={messages:[{role:'user',content:userText}],context:ctx};async function post(url){try{const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(r.ok){const t=await r.text();try{const j=JSON.parse(t);return j.reply||t||'ï¼ˆæ— å“åº”ï¼‰'}catch{return t||'ï¼ˆæ— å“åº”ï¼‰'}}}catch(_){}return null}return await post('/api/butler/chat')||await post('/api/chat')||'ï¼ˆæš‚æ—¶æ— æ³•è¿æ¥åˆ°æœåŠ¡ç«¯ï¼‰'}
function wireChatDrawer(){const send=$('gpt-send'),input=$('gpt-input'),body=$('gpt-body');if(!send||!input||!body) return;send.onclick=async()=>{const text=(input.value||'').trim();if(!text) return;body.insertAdjacentHTML('beforeend',`<div style="text-align:right;margin:6px 0;">${text}</div>`);input.value='';const ctx=window.__bazi_ctx__||{};const reply=await callChatAPI(text,ctx);body.insertAdjacentHTML('beforeend',`<div style="margin:6px 0;">${reply}</div>`);body.scrollTop=body.scrollHeight}}
function ensureGPTDrawer(){const host=$('result')||document.body;let drawer=$('gpt-drawer');if(!drawer){const wrap=document.createElement('div');wrap.innerHTML=buildChatDrawerHTML();host.insertBefore(wrap.firstElementChild,host.firstChild);drawer=$('gpt-drawer')}else if(host&&drawer.parentNode!==host){host.insertBefore(drawer,host.firstChild)}drawer.style.display='block';drawer.removeAttribute('hidden');const send=$('gpt-send');if(send){const cloned=send.cloneNode(true);send.parentNode.replaceChild(cloned,send)}wireChatDrawer()}

/* ---------------- ç»Ÿä¸€æŒ‚è½½ï¼šæŠ¥å‘Š + ç®¡å®¶ + æŠ½å±‰ ---------------- */
function buildFreeReportHTML({pillars,percents,st,adv,timeUnknown}){const L={wood:'æœ¨',fire:'ç«',earth:'åœŸ',metal:'é‡‘',water:'æ°´'};const entries=Object.entries(percents);const strongestK=entries.reduce((a,b)=>a[1]>b[1]?a:b)[0];const weakestK=entries.reduce((a,b)=>a[1]<b[1]?a:b)[0];const strongest=L[strongestK],weakest=L[weakestK];const absents=Object.keys(percents).filter(k=>Math.round(percents[k])===0).map(k=>L[k]).join('ã€');const fmt=k=>`${L[k]} ${Math.round(percents[k])}%`;const line=['wood','fire','earth','metal','water'].map(fmt).join('ã€€');const fav=(adv?.useful||[]).join('ã€');const avoid=(adv?.avoid||[]).join('ã€')||'â€”';const hourTxt=timeUnknown?'ï¼Ÿï¼Ÿ':(pillars.hour.stem+pillars.hour.branch);return `
  <div class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
    <h3 style="margin:0 0 8px;color:var(--brand)">å…è´¹æŠ¥å‘Š</h3>
    <p style="margin:6px 0;">å››æŸ±ï¼š<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
    <p style="margin:6px 0;">æ—¥ä¸»ï¼š<strong>${pillars.day.stem}</strong>ï¼ˆ<strong>${pillars.day.element}</strong>ï¼‰ï½œå­£èŠ‚ï¼š<strong>${st.season||'-'}</strong>ï½œå‘½å±€ï¼š<strong>${st.mark}</strong> Â· <strong>${st.focus}</strong></p>
    <p style="margin:8px 0;">äº”è¡Œï¼š${line}</p>
    <p style="margin:4px 0;"><strong>${strongest}</strong>åæ—ºï¼›<strong>${weakest}</strong>åå¼±ã€‚${absents?`<span style="color:var(--muted)">ï¼ˆç¼ºï¼š${absents}ï¼‰</span>`:''}</p>
    <ul style="margin:6px 0 0 18px;line-height:1.6">
      <li>å–œç”¨ä¼˜å…ˆï¼š<strong>${fav||'â€”'}</strong>ï¼›å¿Œè®³ï¼š${avoid}</li>
      <li>è°ƒè¡¡è¦ç‚¹ï¼š${st.focus}</li>
    </ul>
    ${timeUnknown?`<p style="margin:6px 0 0;color:var(--muted)">æç¤ºï¼šæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æœªçº³å…¥ã€‚</p>`:''}
  </div>`}
function buildButlerHTML(){return `
  <div id="assistant-panel" class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
    <h3 style="margin:0 0 8px;color:var(--brand)">å¿ƒæ€œç®¡å®¶ Â· æ™ºèƒ½è§£è¯»</h3>
    <div id="assistant-analysis"></div>
    <div id="assistant-advice" style="margin-top:8px"></div>
  </div>`}
function mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown}){const resultEl=$('result');if(!resultEl){console.warn('[mount] æ‰¾ä¸åˆ° #result');return}
let freeNode=$('xl-free-report');if(!freeNode){freeNode=document.createElement('div');freeNode.id='xl-free-report';resultEl.appendChild(freeNode)}freeNode.innerHTML=buildFreeReportHTML({pillars,percents,st,adv,timeUnknown});
let butler=$('assistant-panel');if(!butler){const wrap=document.createElement('div');wrap.innerHTML=buildButlerHTML();resultEl.appendChild(wrap.firstElementChild)}
let drawer=$('gpt-drawer');if(!drawer){const wrap=document.createElement('div');wrap.innerHTML=buildChatDrawerHTML();resultEl.appendChild(wrap.firstElementChild);wireChatDrawer()}
window.__bazi_ctx__={pillars,wuxing_ratio:percents,season:st.season,strength:st.mark,strategy:st.focus,useful:adv?.useful||[],timeUnknown}}
/* ---------------- ç”Ÿæˆå‘½ç›˜ä¸»æµç¨‹ ---------------- */
async function genChart(){const birth=($('birthdate')?.value||'').trim();const timeUnknown=$('timeUnknown')?.checked||false;if(!birth){showError('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸã€‚');return}
const btn=$('genBtn'),tx=$('genBtnText'),ld=$('genBtnLoading');if(btn) btn.disabled=true;if(tx) tx.style.display='none';if(ld) ld.style.display='inline-block';
try{const [Y,M,D]=birth.split('-').map(Number);let hour=12;if(!timeUnknown){const t=($('birthtime')?.value||'').trim();if(t) hour=parseInt(t.split(':')[0],10)}
const {pillars,counts,percents,timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);
$('result')?.style.setProperty('display','block');ensureGPTDrawer();
const timeText=tu?'æ—¶é—´ä¸è¯¦':(hour+'æ—¶');setText('bazi-date',`å‡ºç”Ÿæ—¥æœŸ: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);if(tu){const el=$('bazi-date');el&&(el.innerHTML+=' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>')}
renderPillars($('bazi-pillars'),pillars,tu);displayClassicArea(pillars,tu);
setBar($('bar-æœ¨'),percents.wood);setText('pct-æœ¨',Math.round(percents.wood)+'%');
setBar($('bar-ç«'),percents.fire);setText('pct-ç«',Math.round(percents.fire)+'%');
setBar($('bar-åœŸ'),percents.earth);setText('pct-åœŸ',Math.round(percents.earth)+'%');
setBar($('bar-é‡‘'),percents.metal);setText('pct-é‡‘',Math.round(percents.metal)+'%');
setBar($('bar-æ°´'),percents.water);setText('pct-æ°´',Math.round(percents.water)+'%');
const st=judgeStrength(pillars.day.stem,pillars.month.branch,counts);const adv=chooseUseful(st.mark,pillars.day.element);
const keys=Object.keys(counts);const maxK=keys.reduce((a,b)=>counts[a]>counts[b]?a:b);const minK=keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
setText('bazi-elements-balance',`äº”è¡Œä¸­${maxK}å…ƒç´ æœ€å¼ºï¼Œ${minK}å…ƒç´ æœ€å¼±ã€‚`);
mountExtensionsIntoResult({pillars,percents,st,adv,timeUnknown:tu});
try{const payload={profile:{name:$('name')?.value||'',gender:$('gender')?.value||'',calendar:$('calendar')?.value||'gregorian',birth:`${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`,time:tu?null:($('birthtime')?.value||''),timezone:'+08:00'},chart:{year:pillars.year,month:pillars.month,day:{stem:pillars.day.stem,branch:pillars.day.branch},hour:tu?{stem:'ï¼Ÿ',branch:'ï¼Ÿ'}:pillars.hour,day_master:pillars.day.stem,season:st.season,wuxing_ratio:{wood:percents.wood,fire:percents.fire,earth:percents.earth,metal:percents.metal,water:percents.water}},prefs:{lang:'zh-CN',tier:'free'}};
const resp=await fetch('/api/butler/explain',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>r.json()).catch(()=>null);
const ana=$('assistant-analysis');const advc=$('assistant-advice');if(resp&&resp.layout){if(ana&&resp?.layout?.cards?.[0]?.html) ana.innerHTML=resp.layout.cards[0].html;if(advc&&resp?.layout?.cards?.[1]?.html) advc.innerHTML=resp.layout.cards[1].html}}catch(_){}
console.log('å®é™… â†’',pillars.year.stem+pillars.year.branch,pillars.month.stem+pillars.month.branch,pillars.day.stem+pillars.day.branch,tu?'ï¼Ÿ':(pillars.hour.stem+pillars.hour.branch))
}catch(err){console.error(err);showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•')}
finally{if(btn) btn.disabled=false;if(tx) tx.style.display='inline';if(ld) ld.style.display='none'}}
 
/* ---------------- æ‚¬æµ®â€œå¿ƒæ€œç®¡å®¶â€çª—å£ï¼ˆä¿æŒä½ çš„å¯¹æ¥ï¼‰ ---------------- */
const API_BASE='https://throbbing-lab-1440.hello5xliving.workers.dev';
function showAuthErr(msg){const e=$("auth-error");e.textContent=msg;e.style.display="block";setTimeout(()=>{e.style.display='none'},5000)}
function hideAuthErr(){const e=$("auth-error");e.style.display="none";e.textContent=""}

document.addEventListener('DOMContentLoaded',()=>{
  // å…ˆåˆ›å»ºå†èµ‹å€¼
  const chatFab = document.createElement('div');
  chatFab.className = 'ss-chat-fab';
  chatFab.id = 'ssChatFab';
  chatFab.title = 'å¿ƒæ€œç®¡å®¶';
  chatFab.textContent = 'å¿ƒ';                  // åœ†å½¢æŒ‰é’®ä¸Šçš„å­—
  chatFab.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');

  const chatPanel = document.createElement('div');
  chatPanel.className = 'ss-chat-panel';
  chatPanel.id = 'ssChatPanel';
  chatPanel.setAttribute('role','dialog');
  chatPanel.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');
  chatPanel.innerHTML = `<div class="ss-chat-head"><div class="ss-chat-title">å¿ƒæ€œç®¡å®¶</div><div class="ss-close" id="ssChatClose">âœ•</div></div><div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div><div class="ss-chat-input"><input id="ssChatInput" type="text"/><button id="ssChatSend"></button></div>`;

  document.body.appendChild(chatFab);
  document.body.appendChild(chatPanel);

  // è¯­è¨€
  const select=$('langSelect');const current=getLang();if(select) select.value=current;applyI18n();applyChatI18n();

  const $body=$('ssChatBody'),$input=$('ssChatInput'),$send=$('ssChatSend'),$close=$('ssChatClose');
  const openPanel=()=>{chatPanel.style.display='flex';$input.focus()};const closePanel=()=>{chatPanel.style.display='none'};
  chatFab.addEventListener('click',openPanel);$close.addEventListener('click',closePanel);
  function addMsg(text,me=false){const div=document.createElement('div');div.className='ss-msg'+(me?' me':'');div.textContent=text;$body.appendChild(div);$body.scrollTop=$body.scrollHeight}
  async function askChat(prompt){addMsg(prompt,true);$input.value='';$input.focus();try{const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ï¼Œè¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚'},{role:'user',content:prompt}]})});let data,reply='';try{data=await r.json()}catch{data={}}reply=data.reply??data.text??data?.choices?.[0]?.message?.content??"";if(!reply) return addMsg('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚');addMsg(reply)}catch(e){addMsg('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚')}}
  $send.addEventListener('click',()=>{const v=$input.value.trim();if(v) askChat(v)});$input.addEventListener('keydown',(e)=>{if(e.key==='Enter'){const v=$input.value.trim();if(v) askChat(v)}});

  if(select){select.addEventListener('change',()=>{setLang(select.value);applyI18n();applyChatI18n()})}

  // ç”Ÿè¾°é»˜è®¤å€¼ + ç»‘å®š
  const today=new Date();const def=today.toISOString().split('T')[0];if($('birthdate')&&!$('birthdate').value)$('birthdate').value=def;
  $('genBtn')?.addEventListener('click',genChart);
});

/* ---------------- ç™»å½•æµç¨‹ï¼ˆä¿æŒä½ çš„é€»è¾‘ï¼Œé”™è¯¯æŒ‡å‘ auth-errorï¼‰ ---------------- */
async function safeJson(resp){try{return await resp.json()}catch{return{ok:false,msg:'upstream_error'}}}
function strongPwd(pw){return pw.length>=8&&/[A-Z]/.test(pw)&&/[a-z]/.test(pw)&&/[0-9]/.test(pw)&&/[^A-Za-z0-9]/.test(pw)}
async function loginFlow(email,password){const res=await safeJson(await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));const msg=(res.msg||"").toString().toLowerCase();let expired=false;if(res.expired===true) expired=true;else if(msg==='expired') expired=true;else if(res.expiresAt){const ts=Date.parse(res.expiresAt);if(!Number.isNaN(ts)&&ts<Date.now()) expired=true}
  if(expired){const go=confirm('ä¼šå‘˜å·²è¿‡æœŸï¼Œè¯·ç»­è´¹ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ');if(go) window.open('https://yourshopifyshop.com/products/monthly-vip','_blank');return}
  if(res.ok===true){localStorage.setItem('vipEmail',res.email||email);location.href='https://astro.5xliving.com/vip_soul_sanctuary.html';return}
  if(msg==='no_account') return showAuthErr('è´¦æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ');if(msg==='wrong_pwd') return showAuthErr('å¯†ç é”™è¯¯');return showAuthErr('ç™»å…¥å¤±è´¥ï¼š'+(res.msg?` ${res.msg}`:''))}

document.getElementById('registerForm').addEventListener('submit',async(e)=>{e.preventDefault();hideAuthErr();const email=$('email').value.trim();const password=$('password').value.trim();if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');if(!strongPwd(password)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');$('registerBtn').disabled=true;try{const res=await safeJson(await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));if(res.ok===true){localStorage.setItem('vipEmail',email);location.href='vip_trial.html';return}if((res.msg||"")==='exists'){await loginFlow(email,password);return}return showAuthErr((res.msg&&(res.msg+''))||'æ³¨å†Œå¤±è´¥ï¼š')}catch(err){showAuthErr('æ³¨å†Œå¤±è´¥ï¼š'+(err?.message||''))}finally{$('registerBtn').disabled=false}})
document.getElementById('loginForm').addEventListener('submit',async(e)=>{e.preventDefault();hideAuthErr();const email=$('email').value.trim();const password=$('password').value.trim();if(!email||!password) return showAuthErr('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');$('loginBtn').disabled=true;try{await loginFlow(email,password)}catch(err){showAuthErr('ç™»å…¥å¤±è´¥ï¼š'+(err?.message||''))}finally{$('loginBtn').disabled=false}})
document.getElementById('resetBtn').addEventListener('click',async()=>{hideAuthErr();let email=prompt('è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š');if(email===null) return;email=email.trim();if(!email) return showAuthErr('é‚®ç®±ä¸èƒ½ä¸ºç©º');let newPassword=prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™ã€æ•°å­—ã€ç¬¦å·ï¼‰ï¼š');if(newPassword===null) return;newPassword=newPassword.trim();if(!newPassword) return showAuthErr('å¯†ç ä¸èƒ½ä¸ºç©º');if(!strongPwd(newPassword)) return showAuthErr('å¯†ç è‡³å°‘8ä½ï¼Œéœ€åŒ…å«å¤§å†™/å°å†™/æ•°å­—/ç‰¹æ®Šç¬¦å·');$('resetBtn').disabled=true;try{const res=await safeJson(await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword})}));if(!res.ok) return showAuthErr((res.msg&&(res.msg+''))||'é‡è®¾å¤±è´¥ï¼š');alert('å¯†ç å·²æˆåŠŸæ›´æ–°ï¼Œè¯·ç”¨æ–°å¯†ç é‡æ–°ç™»å…¥ã€‚')}catch(err){showAuthErr('é‡è®¾å¤±è´¥ï¼š'+(err?.message||''))}finally{$('resetBtn').disabled=false}})

/* è‡ªæµ‹ï¼š1978-02-21 12:00ï¼ˆUTC+8ï¼‰åº”ä¸º æˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ */
(function(){const c=new BaziCalculator();const Y=c.calculateYearPillar(1978);const M=c.calculateMonthPillar(1978,2,21);const D=c.calculateDayPillar(1978,2,21);const H=c.calculateHourPillar(D.stem,12);console.log('åº”ä¸º â†’ å¹´ æˆŠåˆï½œæœˆ ç”²å¯…ï½œæ—¥ ç”²å¯…ï½œæ—¶ åºšåˆ');console.log('å®é™… â†’',Y.stem+Y.branch,M.stem+M.branch,D.stem+D.branch,H.stem+H.branch)})();
</script>
</body>
</html>
