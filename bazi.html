<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
/* ---- styles unchanged except tiny fixes ---- */
:root{
  --bg:#0b0f14; --bg-accent:#0e1520; --card:#11161dcc; --surface:#0f1624; --line:#1f2a36;
  --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --radius-sm:10px; --radius-lg:18px; --shadow:0 8px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.28);
  --container:1100px; --gap:12px; --pad:18px; --focus:0 0 0 2px rgba(212,175,55,0.2);
  --bp-s:520px; --bp-m:760px; --bp-l:900px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
             linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}
.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}
.site-header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.8); border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:var(--shadow-sm); font-weight:800; color:#ffe084}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}
.lang{display:flex; align-items:center; gap:8px}
.lang select{
  appearance:none; min-width:140px; border-radius:10px; border:1px solid #243244; background:var(--bg-accent); color:var(--text);
  padding:10px 34px 10px 12px; font-size:0.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}
.now{font-size:.9rem; color:var(--muted)}

.section{margin-top:18px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:var(--pad); margin:16px 0}
.h2{font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084; display:flex; gap:8px; align-items:center}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}
.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} .row.cols-2{grid-template-columns:1fr 1fr} }
input,select{width:100%; border-radius:12px; border:1px solid #243244; background:var(--bg-accent); color:var(--text); padding:12px 12px; font-size:15px; outline:0}
input::placeholder{color:#6f8092}
input:focus,select:focus{box-shadow:var(--focus); border-color:#3a4c63}
.btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}
.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width:520px){ .pillars{grid-template-columns:repeat(2,1fr)} }
.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width:420px){ .bazi-table th,.bazi-table td{padding:8px 10px} }
.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:60px 1fr 60px; gap:10px; align-items:center}
.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.badge-warn{display:inline-block; padding:2px 8px; margin-left:6px; border:1px solid #ffb84d; border-radius:999px; color:#ffb84d; font-size:0.82rem}
.muted{color:var(--muted)}
.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}
.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}
.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.rating{display:flex; align-items:center; gap:8px; margin:8px 0}
.rating-stars{color:var(--gold2)}
.tag{display:inline-block; background:rgba(212,175,55,.1); color:var(--gold2); padding:4px 8px; border-radius:6px; font-size:0.85rem; margin:2px}
.luck-grid{display:grid; gap:10px}
.luck-item{background:rgba(255,255,255,.05); border-radius:8px; padding:12px; border-left:3px solid var(--gold2)}
.luck-year{font-weight:700; color:var(--gold2)}
.luck-desc{font-size:0.9rem; margin-top:4px}
.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}
.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}
.ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0}
.ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px}
.ai-box-c{color:#e8edf3; line-height:1.7}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
.chip{padding:6px 10px; border-radius:999px; border:1px solid #2a3546; background:#0e1520; color:#e8edf3; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease}
.chip:hover{border-color:#f2d27a; box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
.chip:disabled{opacity:.6; cursor:not-allowed}
.skeleton{display:grid; gap:8px}
.skeleton div{height:12px; border-radius:6px; background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431); animation:sh 1.2s infinite}
@keyframes sh{0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5}}
.ai-lock-overlay{margin-top:10px; padding-top:10px; border-top:1px solid #1f2a36; text-align:center}
.ai-lock-overlay .tip{color:#ffd88a; font-weight:700; margin-bottom:4px}
.ai-lock-overlay .sub{color:var(--muted)}
.detail-view{display:none}
.detail-header{display:flex; align-items:center; gap:12px; margin-bottom:20px}
.back-btn{background:rgba(212,175,55,.1); border:1px solid rgba(212,175,55,.3); color:var(--gold2); padding:8px 16px; border-radius:8px; cursor:pointer}
.detail-content{line-height:1.8}
.detail-section{margin-bottom:24px}
.detail-section h4{color:var(--gold2); margin-bottom:12px; font-size:1.1rem}
.action-list{list-style:none; padding:0; margin:0}
.action-list li{margin-bottom:8px; padding-left:20px; position:relative}
.action-list li::before{content:"â€¢"; color:var(--gold2); position:absolute; left:0; top:0}
footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important} }
.sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
.chips-container{display:flex; flex-wrap:wrap; gap:8px; margin:20px 0; justify-content:center}
.vip-section{display:block !important}
.butler-professional{display:none; margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:20px}
.butler-header{display:flex; align-items:center; gap:10px; margin-bottom:20px; color:var(--gold2); font-size:1.2rem; font-weight:700}
.butler-content{
  line-height:1.8;
  /* remove fixed height + scrolling */
  /* max-height:600px; */
  /* overflow-y:auto; */
  padding:15px;
  background:var(--surface);
  border-radius:10px;
  border:1px solid #253245;
}
.butler-section{margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #253245}
.butler-section h4{color:var(--gold2); margin-bottom:10px; font-size:1.1rem}
.butler-chat{margin-top:20px; border-top:1px solid var(--line); padding-top:15px}
.chat-messages{height:200px; overflow-y:auto; margin-bottom:15px; padding:10px; background:var(--surface); border-radius:8px; border:1px solid #253245}
.chat-input-area{display:flex; gap:10px}
.chat-input-area input{flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3}
.chat-send-btn{padding:10px 20px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer}
/* remove gold focus */
input:focus,select:focus,textarea:focus{outline:none!important; box-shadow:none!important; border-color:#243244!important}
button:focus,.btn:focus,a:focus{outline:none!important; box-shadow:none!important}
*{-webkit-tap-highlight-color:transparent} .chip:hover{border-color:#2a3546; box-shadow:none}
/* floating chat */
.chat-float{position:fixed; bottom:20px; right:20px; width:350px; height:500px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); z-index:1000; display:none; flex-direction:column}
.chat-float-header{padding:12px 16px; border-bottom:1px solid var(--line); background:rgba(212,175,55,.1); color:var(--gold2); font-weight:700; display:flex; justify-content:space-between; align-items:center; cursor:move}
.chat-float-close{background:none; border:none; color:var(--gold2); font-size:1.2rem; cursor:pointer; padding:4px; border-radius:4px}
.chat-float-close:hover{background:rgba(212,175,55,.2)}
.chat-float-body{flex:1; display:flex; flex-direction:column; padding:0}
.chat-float-messages{flex:1; overflow-y:auto; padding:12px; background:var(--surface)}
.chat-float-input-area{padding:12px; border-top:1px solid var(--line); background:var(--bg-accent)}
.chat-toggle-btn{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:linear-gradient(180deg,#fff9e6,#e6c76e); border:1px solid #e6c76e; color:#191919; font-size:1.5rem; cursor:pointer; box-shadow:0 4px 12px rgba(230,199,110,.3); z-index:1001; display:flex; align-items:center; justify-content:center}
.chat-toggle-btn:hover{transform:scale(1.05); box-shadow:0 6px 20px rgba(230,199,110,.5)}
@media (max-width:768px){ .chat-float{width:300px; height:400px; bottom:10px; right:10px} .chat-toggle-btn{width:50px; height:50px; bottom:10px; right:10px}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com/" target="_self">
        <span class="brand-badge">5X</span>
        <span class="title" data-i18n="brand.subtitle">5xLiving Â· å…«å­—ç®€è¯„</span>
      </a>
<div class="lang">
  <span id="nowBox" class="now"></span>
  <select id="langSelect">
    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
    <option value="en">English</option>
    <option value="ja">æ—¥æœ¬èª</option>
    <option value="th">à¹„à¸—à¸¢</option>
    <option value="ms">Bahasa Melayu</option>
  </select>
</div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="h2" data-i18n="app.title">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="form.nameLabel">å§“åï¼ˆå¯é€‰ï¼‰</label>
          <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" />
        </div>
        <div>
          <label class="muted" data-i18n="form.genderLabel">æ€§åˆ«</label>
          <select id="gender">
            <option value=""        data-i18n="form.gender.hidden">ä¸é€éœ²</option>
            <option value="male"    data-i18n="form.gender.male">ç”·æ€§</option>
            <option value="female"  data-i18n="form.gender.female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="form.calendarLabel">å†æ³•</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="form.calendar.gregorian">é˜³å†</option>
            <option value="lunar"     data-i18n="form.calendar.lunar">å†œå†</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="form.birthdateLabel">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted" data-i18n="form.birthtimeLabel">å‡ºç”Ÿæ—¶é—´</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="form.timeUnknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn.generate">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none" data-i18n="btn.loading">è®¡ç®—ä¸­...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2" data-i18n="result.title">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <table class="bazi-table">
          <thead>
          <tr>
            <th></th>
            <th data-i18n="pillar.year">å¹´æŸ±</th>
            <th data-i18n="pillar.month">æœˆæŸ±</th>
            <th data-i18n="pillar.day">æ—¥æŸ±</th>
            <th data-i18n="pillar.hour">æ—¶æŸ±</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td data-i18n="table.row.stem">å¤©å¹²</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.branch">åœ°æ”¯</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.fiveElem">äº”è¡Œ</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td data-i18n="table.row.nayin">çº³éŸ³</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="energy.title">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span data-i18n="elem.wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
        <div class="bar-row"><span data-i18n="elem.water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
        <div id="bazi-elements-balance" class="muted"></div>
      </div>
    </section>

    <section id="butlerProfessional" class="butler-professional">
      <div class="butler-header">
        <span data-i18n="pro.title">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</span>
      </div>
      <div class="butler-content" id="professionalReport"></div>
    </section>

    <button class="chat-toggle-btn" id="chatToggle" data-i18n="chat.toggle">é—®</button>
    <div class="chat-float" id="chatFloat">
      <div class="chat-float-header">
        <span data-i18n="pro.title">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</span>
        <button class="chat-float-close" id="chatClose">Ã—</button>
      </div>
      <div class="chat-float-body">
        <div class="chat-float-messages" id="chatMessages">
          <div class="ss-msg" data-i18n="pro.welcome">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šå‘½ç†é¡¾é—®ï¼Œå·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Šã€‚æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘ã€‚</div>
        </div>
        <div class="chat-float-input-area">
          <div style="display:flex;gap:8px;">
            <input type="text" id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3;">
            <button class="chat-send-btn" id="chatSend" data-i18n="chat.send" style="padding:10px 16px; background:var(--gold); color:#191919; border:none; border-radius:8px; font-weight:700; cursor:pointer;">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <section class="card section vip-section">
      <h2 class="group-title" data-i18n="vip.title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip.group.astrology">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip.astrology.match">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip.astrology.career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip.astrology.wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip.astrology.pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip.group.spiritual">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip.spiritual.record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip.spiritual.courses">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°</li>
            <li data-i18n="vip.spiritual.family">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip.spiritual.practice">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="vip.login.title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="auth.header">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row" id="authFields">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é‚®ç®± Email">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="auth.login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="auth.reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="auth.register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="auth.freeTrialNote">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="vip.services.header">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="vip.upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="vip.back">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="muted" data-i18n="vip.priceNote">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer data-i18n="footer.copy">Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <script>window.API_BASE='https://throbbing-lab-1440.hello5xliving.workers.dev';</script>

  <!-- Main app -->
  <script>
  (() => {
    'use strict';
    const SG_TZ = 'Asia/Singapore';
    const $ = id => document.getElementById(id);
    const state = (window.state = window.state || {});
    state.lang = 'zh-CN';  // this page is fixed to Simplified Chinese
    try { localStorage.setItem('5x_lang', 'zh-CN'); } catch {}

    /* ===== I18N core ===== */
    window.I18N = window.I18N || {};
    const I18N = window.I18N;
    window.ensure = (code, dict) => { I18N[code] = Object.assign({}, I18N[code] || {}, dict); };

    // Base pack (zh-CN) â€“ shortened here because your packs are external
    I18N['zh-CN'] = Object.assign({}, I18N['zh-CN'] || {}, {
      action:{
        weekly:'æ¯å‘¨',
        energy:'èƒ½é‡ç»ƒä¹ ',
        career:'èŒä¸šç­–ç•¥ï¼šç¨³æ­¥æ¨è¿›ã€èšç„¦äº§å‡º',
        career2:'ç¨³å®šè¾“å‡ºä¸å¤ç›˜ï¼ˆæ‹†è§£ç›®æ ‡ â†’ å‘¨è®¡åˆ’ â†’ å¤ç›˜æ”¹è¿›ï¼‰',
        relationship:'å…³ç³»ç»è¥ï¼šçœŸè¯šæ²Ÿé€šã€è®¾å®šç•Œé™ã€åŠæ—¶å›åº”',
        wealth:'è´¢å¯Œï¼šé¢„ç®—/ç°é‡‘æµç®¡ç†ã€æŠ€èƒ½å˜ç°ã€æ§é£é™©'
      },      
      brand:{ subtitle:'5xLiving Â· å…«å­—ç®€è¯„' },
      nav:{ langLabel:'è¯­è¨€' },
      lang:{ 'zh-CN':'ç®€ä½“ä¸­æ–‡','zh-TW':'ç¹é«”ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª','th':'à¹„à¸—à¸¢','ms':'Bahasa Melayu' },
      app:{ title:'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜' },
      form:{ nameLabel:'å§“åï¼ˆå¯é€‰ï¼‰', namePlaceholder:'ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰', genderLabel:'æ€§åˆ«',
        gender:{ hidden:'ä¸é€éœ²', male:'ç”·æ€§', female:'å¥³æ€§' },
        calendarLabel:'å†æ³•', calendar:{ gregorian:'é˜³å†', lunar:'å†œå†' },
        birthdateLabel:'å‡ºç”Ÿæ—¥æœŸ', birthtimeLabel:'å‡ºç”Ÿæ—¶é—´', timeUnknown:'å‡ºç”Ÿæ—¶é—´ä¸è¯¦'
      },
      btn:{ generate:'ç”Ÿæˆå…«å­—', loading:'è®¡ç®—ä¸­...' },
      result:{ title:'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜' },
      pillar:{ year:'å¹´æŸ±', month:'æœˆæŸ±', day:'æ—¥æŸ±', hour:'æ—¶æŸ±' },
      table:{ row:{ stem:'å¤©å¹²', branch:'åœ°æ”¯', fiveElem:'äº”è¡Œ', nayin:'çº³éŸ³' } },
      energy:{ title:'äº”è¡Œèƒ½é‡åˆ†æ' },
      elem:{ wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´', month:'æœˆ', fiveElements:'äº”è¡Œ' },
      pro:{ title:'ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ', welcome:'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šå‘½ç†é¡¾é—®ï¼Œå·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Šã€‚æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘ã€‚' },
      chat:{ send:'å‘é€', placeholder:'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...', toggle:'é—®' },
      vip:{ title:'ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment',
        group:{ astrology:'ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹', spiritual:'ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹' },
        astrology:{ match:'å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿', career:'äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›', wealth:'è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº', pet:'å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†' },
        spiritual:{ record:'çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·', courses:'å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•°', family:'å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­', practice:'æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡' },
        login:{ title:'ğŸ’ ç™»å…¥ VIP åŠŸèƒ½' }, services:{ header:'ä¼šå‘˜æœåŠ¡' }, upgrade:'ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰', back:'â† è¿”å›å‘½ç†å•†åŸ',
        priceNote:'$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰'
      },
      auth:{ header:'è´¦æˆ·ç™»å½• / æ³¨å†Œ', login:'ç™»å…¥è´¦æˆ·', reset:'ğŸ”‘ é‡è®¾å¯†ç ', register:'æ³¨å†Œè´¦æˆ·',
        freeTrialNote:'æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ', emailPlaceholder:'é‚®ç®± Email', passwordPlaceholder:'å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰'
      },
      footer:{ copy:'Â© 5XLiving â€¢ Astro Sanctuary' },
      err:{ fillBirthdate:'è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ', invalidDate:'æ— æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè¯·ç”¨ YYYY-MM-DD', generateFail:'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' },
      ui:{ unknown:'æœªçŸ¥', timeUnknown:'æ—¶é—´ä¸è¯¦', hourSuffix:'{hh}:{mm}', birthSummary:'å‡ºç”Ÿæ—¥æœŸ: {y}å¹´{m}æœˆ{d}æ—¥ {timeText}', balance:'äº”è¡Œä¸­{strongest}æœ€å¼ºï¼Œ{weakest}æœ€å¼±ã€‚' },
      badge:{ noHour:'æœªçº³å…¥æ—¶æŸ±' },
      report:{ hourUnknownTip:'âš ï¸ æç¤ºï¼šå› å‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œéƒ¨åˆ†åˆ†æä»…ä¾›å‚è€ƒã€‚', tipTitle:'æç¤º', generating:'æ­£åœ¨ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š...', failed:'æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' },
      reportTitles:{ overview:'ğŸ“Š å‘½ç›˜æ€»è§ˆ', fiveElements:'ğŸŒ¿ äº”è¡Œåˆ†æ', tenGods:'âš¡ åç¥é…ç½®', useful:'ğŸ”‘ å–œç”¨ç¥', relationship:'ğŸ’• æ„Ÿæƒ…å©šå§»', career:'ğŸ’¼ äº‹ä¸šå‘å±•', wealth:'ğŸ’° è´¢è¿åˆ†æ', health:'ğŸŒ¡ï¸ å¥åº·å…»ç”Ÿ', nearTerm:'ğŸ”® è¿‘æœŸè¿åŠ¿', actions:'ğŸ“ è¡ŒåŠ¨æ¸…å•' },
      tenGodsNames:{ biJian:'æ¯”è‚©', jieCai:'åŠ«è´¢', shiShen:'é£Ÿç¥', shangGuan:'ä¼¤å®˜', zhengCai:'æ­£è´¢', pianCai:'åè´¢', zhengGuan:'æ­£å®˜', qiSha:'ä¸ƒæ€', zhengYin:'æ­£å°', pianYin:'åå°' },
      tenGodsHints:{ biJian:'åŒç±»ä¹‹åŠ©ä¸ç«äº‰ï¼Œåå‘è‡ªåŠ›ä¸å¹¶è‚©ä¹‹äºº', jieCai:'åŒç±»åˆ†å¤ºèµ„æºï¼Œå®œåˆä½œå¿Œäº‰æŠ¢', shiShen:'è¾“å‡º/åˆ›é€ /äº«å—ï¼Œåˆ©è¡¨è¾¾ä¸äº§å‡º', shangGuan:'çªç ´/è§„åˆ™å¤–ä¹‹æ‰ï¼Œåˆ©åˆ›æ–°ä½†å¿ŒçŠ¯ä¸Š', zhengCai:'æ­£ä¸šä¹‹è´¢ï¼Œç¨³å¥æ”¶å…¥ã€ç°é‡‘æµ', pianCai:'åé—¨ä¹‹è´¢ï¼Œæœºä¼š/çŸ­æ‰“ï¼Œéœ€æ§é£é™©', zhengGuan:'ç§©åºä¸è§„åˆ™ï¼ŒèŒä½ä¸åèª‰', qiSha:'å‹åŠ›ä¸æŒ‘æˆ˜ï¼Œæ‰§è¡ŒåŠ›å¼ºï¼Œéœ€åˆ¶è¡¡', zhengYin:'æ­£ç»Ÿèµ„æº/å­¦å†/é•¿è¾ˆåŠ©åŠ›', pianYin:'çµæ„Ÿ/åé—¨èµ„æº/å­¦ä¹ åŠ›ï¼Œæ˜“æƒ³å¤š' },
      reportLabels:{ dayMaster:'æ—¥ä¸»å‘½ç†', strength:'æ—¥ä¸»å¼ºå¼±', usefulSpirit:'å–œç”¨ç¥', elementCount:'äº”è¡Œä¸ªæ•°', elementStrength:'äº”è¡Œæ—ºè¡°', supportElements:'å¸®æ‰¶äº”è¡Œ', restrainElements:'å…‹æ³„äº”è¡Œ', missingElements:'äº”è¡Œæ‰€ç¼º', traits:'æ„Ÿæƒ…ç‰¹è´¨', marriageAdvice:'å©šå§»å»ºè®®', relationshipTips:'ç›¸å¤„ä¹‹é“', suitableCareers:'é€‚åˆè¡Œä¸š', careerAdvice:'å‘å±•å»ºè®®', favorableDirections:'æœ‰åˆ©æ–¹ä½', wealthCharacteristics:'è´¢è¿ç‰¹ç‚¹', wealthDirections:'æ±‚è´¢æ–¹å‘', financialAdvice:'ç†è´¢å»ºè®®', healthCharacteristics:'ä½“è´¨ç‰¹ç‚¹', healthTips:'æ³¨æ„äº‹é¡¹', wellnessAdvice:'å…»ç”Ÿå»ºè®®', overallFortune:'æ•´ä½“è¿åŠ¿', favorableTiming:'æœ‰åˆ©æ—¶æœº', cautions:'æ³¨æ„äº‹é¡¹', tenGods:'åç¥é…ç½®', symbolise:'è±¡å¾å«ä¹‰', analysis:'å¯¹ç­–å»ºè®®' },
      wellness:{ default:'è§„å¾‹ä½œæ¯ã€é€‚é‡è¿åŠ¨ã€æƒ…ç»ªç¨³å®šã€å°‘ç†¬å¤œ' },
      cautions:{ default:'é¿å¼€æƒ…ç»ªå†³ç­–ï¼Œæ§åˆ¶æ”¯å‡º' },
      fortune:{ steady:'å¹³ç¨³è°ƒæ•´æœŸ', upward:'åŠ¿å¤´å‘ä¸Šï¼Œåˆ©æ¨å¹¿/è¡¨è¾¾', focus:'æ”¶æ•›èšç„¦ï¼Œåˆ©åˆ¶åº¦ä¸æ‰§è¡Œ', study:'å­¦ä¹ è°ƒç ”æœŸï¼Œå…ˆè“„åå‘', foundation:'æ‰“åŸºç¡€ã€ç¨³èŠ‚å¥ä¸ºä¸»' },
      wealth:{ stable:'ä»¥ç¨³å®šæ”¶å…¥ä¸ºä¸»ï¼Œé€‚åˆç§¯ç´¯å¼ç†è´¢', opportunity:'åè´¢æœºä¼šå¤šï¼Œæ³¨æ„èŠ‚åˆ¶é£é™©', steady:'è´¢è¿å¹³ç¨³ï¼Œé‡åœ¨æŠ€èƒ½ä¸å£ç¢‘å¸¦åŠ¨æ”¶å…¥' },
      'report.dayMaster.jia':'ç”²æœ¨å‘½ï¼šæœ‰ç§¯ææ€§çš„å¼€æ‹“ç²¾ç¥ï¼Œç²¾åŠ›æ—ºç››', 'report.dayMaster.yi':'ä¹™æœ¨å‘½ï¼šæ€§æ ¼æŸ”é¡ºï¼Œå–œè¡Œå–„äº‹ï¼Œæœ‰åŒæƒ…å¿ƒ',
      'report.dayMaster.bing':'ä¸™ç«å‘½ï¼šçƒ­æƒ…è±ªçˆ½ï¼Œè‡ªä¿¡å¥½èƒœï¼Œå–„è¨€å¥è°ˆ', 'report.dayMaster.ding':'ä¸ç«å‘½ï¼šæ•¦åšæœ´å®ï¼Œé‡ä¿¡å®ˆä¹‰',
      'report.dayMaster.wu':'æˆŠåœŸå‘½ï¼šæœ‰ç§¯ææ€§ï¼Œå¹²ä¸€è¡Œæ˜“äºå¯¹äº‹ç‰©çƒ­è¡·', 'report.dayMaster.ji':'å·±åœŸå‘½ï¼šå’Œç¼“ï¼Œè°¨æ…ï¼Œå¿ƒçµæ‰‹å·§',
      'report.dayMaster.geng':'åºšé‡‘å‘½ï¼šç§¯æè¿›å–ï¼Œå‹‡æ•¢æœå†³', 'report.dayMaster.xin':'è¾›é‡‘å‘½ï¼šæ²‰ç€å¦ç›´æ— ç§ï¼Œå¾…äººæ¥ç‰©è®¤çœŸ',
      'report.dayMaster.ren':'å£¬æ°´å‘½ï¼šå¿ƒèƒ¸å®½å¹¿ï¼Œæœºæ™ºçµæ•ï¼Œå–œæ¬¢è‡ªç”±ï¼Œè®¨åŒæŸç¼š', 'report.dayMaster.gui':'ç™¸æ°´å‘½ï¼šé€å¼ºé¡½å›ºï¼Œæ˜¯åŠªåŠ›å®¶',
      'report.marriage.stable':'å©šå§»è¾ƒä¸ºç¨³å®šï¼Œé€‚åˆå»ºç«‹é•¿æœŸå…³ç³»', 'report.marriage.experienced':'æ„Ÿæƒ…ç»å†å¯èƒ½è¾ƒå¤šï¼Œéœ€è¦æ‰¾åˆ°çœŸæ­£é€‚åˆçš„ä¼´ä¾£', 'report.marriage.default':'å©šå§»éœ€è¦åŒæ–¹å…±åŒåŠªåŠ›ç»è¥',
      'report.career.leadership':'é€‚åˆç®¡ç†å²—ä½æˆ–è‡ªä¸»åˆ›ä¸šï¼Œæœ‰é¢†å¯¼æ½œåŠ›', 'report.career.business':'é€‚åˆå•†ä¸šã€é‡‘èé¢†åŸŸï¼Œè´¢è¿è¾ƒå¥½', 'report.career.creative':'é€‚åˆåˆ›æ„ã€è‰ºæœ¯ã€æŠ€æœ¯ç±»å·¥ä½œ', 'report.career.steady':'ç¨³æ‰ç¨³æ‰“ï¼Œåœ¨ä¸“ä¸šé¢†åŸŸæ·±è€•å‘å±•',
      'report.health.tips.jia':'å®šæœŸæ£€æŸ¥è‚åŠŸèƒ½ï¼Œä¿æŠ¤è§†åŠ›','report.health.tips.yi':'æ³¨æ„æƒ…ç»ªè°ƒèŠ‚ï¼Œé¿å…çœ¼éƒ¨ç–²åŠ³','report.health.tips.bing':'æ§åˆ¶æƒ…ç»ªï¼Œé¿å…ç†¬å¤œ','report.health.tips.ding':'ä¿è¯å……è¶³ç¡çœ ï¼Œé¿å…è¿‡åº¦ç´§å¼ ','report.health.tips.wu':'è§„å¾‹é¥®é£Ÿï¼Œé¿å…æš´é¥®æš´é£Ÿ','report.health.tips.ji':'æ³¨æ„é¥®é£Ÿå«ç”Ÿï¼Œé¿å…æ½®æ¹¿ç¯å¢ƒ','report.health.tips.geng':'æ³¨æ„ä¿æš–ï¼Œé¿å…å¹²ç‡¥ç¯å¢ƒ','report.health.tips.xin':'ä¿æŒç©ºæ°”æµé€šï¼Œé¿å…çƒŸå°˜','report.health.tips.ren':'ä¿æŒæ°´åˆ†å¹³è¡¡ï¼Œé¿å…å—å‡‰ï¼Œæ³¨æ„è‚¾è„ä¿å…»','report.health.tips.gui':'é€‚é‡é¥®æ°´ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯'
});

    // translate helper (single)
function deepGet(obj, path){
  return String(path).split('.').reduce(
    (o,k)=> (o && o[k] != null) ? o[k] : undefined,
    obj
  );
}

function t(path, lang = (window.state && window.state.lang) || 'zh-CN') {
  const pack = (window.I18N && window.I18N[lang])   || {};
  const base = (window.I18N && window.I18N['zh-CN']) || {};

  // 1ï¸âƒ£ å…ˆå°è¯•ã€Œæ‰å¹³ keyã€ï¼š 'report.dayMaster.jia'
  let v = pack[path];
  if (v != null && v !== '') return v;

  // 2ï¸âƒ£ å†å°è¯•åµŒå¥—å¯¹è±¡ï¼š pack.report.dayMaster.jia è¿™ç§
  v = deepGet(pack, path);
  if (v != null && v !== '') return v;

  // 3ï¸âƒ£ zh-CN æ‰å¹³ key
  v = base[path];
  if (v != null && v !== '') return v;

  // 4ï¸âƒ£ zh-CN åµŒå¥—å¯¹è±¡
  v = deepGet(base, path);
  if (v != null && v !== '') return v;

  // 5ï¸âƒ£ é»˜è®¤ä¸­æ–‡å…œåº•ï¼ˆåªæ”¾ä½ ç¡®å®šè¦æœ‰çš„ labelï¼‰
  const defaultMessages = {
    'reportLabels.symbolise': 'è±¡å¾å«ä¹‰',
    'reportLabels.analysis': 'å¯¹ç­–å»ºè®®',
    'reportLabels.tenGods': 'åç¥é…ç½®',
    'reportLabels.dayMaster': 'æ—¥ä¸»å‘½ç†',
    'reportLabels.elementCount': 'äº”è¡Œä¸ªæ•°',
    'reportLabels.missingElements': 'äº”è¡Œæ‰€ç¼º',
    'reportLabels.suitableCareers': 'é€‚åˆè¡Œä¸š',
    'reportLabels.careerAdvice': 'å‘å±•å»ºè®®',
    'reportLabels.favorableDirections': 'æœ‰åˆ©æ–¹ä½',
    'reportLabels.healthCharacteristics': 'ä½“è´¨ç‰¹ç‚¹',
    'reportLabels.healthTips': 'æ³¨æ„äº‹é¡¹',
    'reportLabels.wellnessAdvice': 'å…»ç”Ÿå»ºè®®',
    'reportLabels.overallFortune': 'æ•´ä½“è¿åŠ¿',
    'reportLabels.favorableTiming': 'æœ‰åˆ©æ—¶æœº',
    'reportLabels.cautions': 'æ³¨æ„äº‹é¡¹',

    // è¿™äº›æ˜¯ä½ åˆšåˆšé‡åˆ°é—®é¢˜çš„å‡ æ¡ï¼Œé¡ºæ‰‹å…œåº•ä¸€æ¬¡
    'report.dayMaster.jia': 'ç”²æœ¨å‘½ï¼šæœ‰ç§¯ææ€§çš„å¼€æ‹“ç²¾ç¥ï¼Œç²¾åŠ›æ—ºç››',
    'report.career.steady': 'ç¨³æ‰ç¨³æ‰“ï¼Œåœ¨ä¸“ä¸šé¢†åŸŸæ·±è€•å‘å±•',
    'report.marriage.experienced': 'æ„Ÿæƒ…ç»å†å¯èƒ½è¾ƒå¤šï¼Œéœ€è¦æ‰¾åˆ°çœŸæ­£é€‚åˆçš„ä¼´ä¾£',
    'wealth.steady': 'è´¢è¿å¹³ç¨³ï¼Œé‡åœ¨æŠ€èƒ½ä¸å£ç¢‘å¸¦åŠ¨æ”¶å…¥',
  };

  return defaultMessages[path] || '';
}
    window.t = t;

    function applyI18n(){
      const lang = state.lang || 'zh-CN';
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const val = t(key);
        if (typeof val === 'string' && val !== '') el.textContent = val;
      });
      document.querySelectorAll('option[data-i18n]').forEach(opt=>{
        const key = opt.getAttribute('data-i18n');
        const val = t(key);
        if (typeof val === 'string' && val !== '') opt.textContent = val;
      });
      const setPh = (id, value) => { const el=$(id); if (el && typeof value === 'string' && value) el.placeholder = value; };
      setPh('name', t('form.namePlaceholder'));
      setPh('chatInput', t('chat.placeholder'));

      if (window.lastCtx && typeof window.buildProReport === 'function') window.buildProReport(window.lastCtx);
    }
    window.applyI18n = applyI18n;

    /* ===== Bazi calculator ===== */
    class BaziCalculator {
      constructor(){
        this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
        this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
        this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
      }
      yearPillar(year){ const s=(year-4)%10, b=(year-4)%12; return {stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]}; }
      solarMonthIndex(y,m,d){ const mmdd=m*100+d;
        const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
        let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
        const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
        return {index:idx, branch:branchBy[idx]};
      }
      monthPillar(year,month,day){
        const {index,branch}=this.solarMonthIndex(year,month,day);
        const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
        const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
        const stemIdx=(startMap[yStemIdx]+(index-1))%10;
        return {stem:this.HEAVENLY_STEMS[stemIdx], branch};
      }
      dayPillar(year,month,day){
        const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
        const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
        const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
        return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
      }
      hourPillar(dayStem,hour){
        const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
        const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
        const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
        const hourIndex=Math.floor((hour+1)/2)%12;
        const stemIdx=(startMap[dayIdx]+hourIndex)%10;
        return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
      }
      stemElem(s){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[s]||'-'; }
      branchElem(b){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[b]||'-'; }
      nayin(s,b){ const si=this.HEAVENLY_STEMS.indexOf(s), bi=this.EARTHLY_BRANCHES.indexOf(b); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
      tenGods(dayStem, stems){
        const map={
          'ç”²':{'ç”²':'æ¯”è‚©','ä¹™':'åŠ«è´¢','ä¸™':'é£Ÿç¥','ä¸':'ä¼¤å®˜','æˆŠ':'åè´¢','å·±':'æ­£è´¢','åºš':'ä¸ƒæ€','è¾›':'æ­£å®˜','å£¬':'åå°','ç™¸':'æ­£å°'},
          'ä¹™':{'ç”²':'åŠ«è´¢','ä¹™':'æ¯”è‚©','ä¸™':'ä¼¤å®˜','ä¸':'é£Ÿç¥','æˆŠ':'æ­£è´¢','å·±':'åè´¢','åºš':'æ­£å®˜','è¾›':'ä¸ƒæ€','å£¬':'æ­£å°','ç™¸':'åå°'},
          'ä¸™':{'ç”²':'åå°','ä¹™':'æ­£å°','ä¸™':'æ¯”è‚©','ä¸':'åŠ«è´¢','æˆŠ':'é£Ÿç¥','å·±':'ä¼¤å®˜','åºš':'åè´¢','è¾›':'æ­£è´¢','å£¬':'ä¸ƒæ€','ç™¸':'æ­£å®˜'},
          'ä¸':{'ç”²':'æ­£å°','ä¹™':'åå°','ä¸™':'åŠ«è´¢','ä¸':'æ¯”è‚©','æˆŠ':'ä¼¤å®˜','å·±':'é£Ÿç¥','åºš':'æ­£è´¢','è¾›':'åè´¢','å£¬':'æ­£å®˜','ç™¸':'ä¸ƒæ€'},
          'æˆŠ':{'ç”²':'ä¸ƒæ€','ä¹™':'æ­£å®˜','ä¸™':'åå°','ä¸':'æ­£å°','æˆŠ':'æ¯”è‚©','å·±':'åŠ«è´¢','åºš':'é£Ÿç¥','è¾›':'ä¼¤å®˜','å£¬':'åè´¢','ç™¸':'æ­£è´¢'},
          'å·±':{'ç”²':'æ­£å®˜','ä¹™':'ä¸ƒæ€','ä¸™':'æ­£å°','ä¸':'åå°','æˆŠ':'åŠ«è´¢','å·±':'æ¯”è‚©','åºš':'ä¼¤å®˜','è¾›':'é£Ÿç¥','å£¬':'æ­£è´¢','ç™¸':'åè´¢'},
          'åºš':{'ç”²':'åè´¢','ä¹™':'æ­£è´¢','ä¸™':'ä¸ƒæ€','ä¸':'æ­£å®˜','æˆŠ':'åå°','å·±':'æ­£å°','åºš':'æ¯”è‚©','è¾›':'åŠ«è´¢','å£¬':'é£Ÿç¥','ç™¸':'ä¼¤å®˜'},
          'è¾›':{'ç”²':'æ­£è´¢','ä¹™':'åè´¢','ä¸™':'æ­£å®˜','ä¸':'ä¸ƒæ€','æˆŠ':'æ­£å°','å·±':'åå°','åºš':'åŠ«è´¢','è¾›':'æ¯”è‚©','å£¬':'ä¼¤å®˜','ç™¸':'é£Ÿç¥'},
          'å£¬':{'ç”²':'é£Ÿç¥','ä¹™':'ä¼¤å®˜','ä¸™':'åè´¢','ä¸':'æ­£è´¢','æˆŠ':'ä¸ƒæ€','å·±':'æ­£å®˜','åºš':'åå°','è¾›':'æ­£å°','å£¬':'æ¯”è‚©','ç™¸':'åŠ«è´¢'},
          'ç™¸':{'ç”²':'ä¼¤å®˜','ä¹™':'é£Ÿç¥','ä¸™':'æ­£è´¢','ä¸':'åè´¢','æˆŠ':'æ­£å®˜','å·±':'ä¸ƒæ€','åºš':'æ­£å°','è¾›':'åå°','å£¬':'åŠ«è´¢','ç™¸':'æ¯”è‚©'}
        };
        const m=map[dayStem]||{}; return stems.map(s=>m[s]||'-');
      }
    }

    /* ===== Analysis helpers ===== */
    function stemToPinyin(stem){
      const map = {'ç”²':'jia','ä¹™':'yi','ä¸™':'bing','ä¸':'ding','æˆŠ':'wu','å·±':'ji','åºš':'geng','è¾›':'xin','å£¬':'ren','ç™¸':'gui'};
      return map[stem] || String(stem).toLowerCase();
    }
    const controlChain = { 'æœ¨':'åœŸ', 'åœŸ':'æ°´', 'æ°´':'ç«', 'ç«':'é‡‘', 'é‡‘':'æœ¨' };
    const motherOf     = { 'æœ¨':'æ°´', 'ç«':'æœ¨', 'åœŸ':'ç«', 'é‡‘':'åœŸ', 'æ°´':'é‡‘' };

    const BaziAnalysis = {
      dayMasterLine(stem){ return t('report.dayMaster.'+stemToPinyin(stem)) || ''; },
      relation(dayStem){
        const dict={
          'ç”²':{traits:'æ„Ÿæƒ…è¾ƒä¸ºä¸»åŠ¨ï¼Œå–œæ¬¢æŒæ¡ä¸»å¯¼æƒï¼Œä½†è¦æ³¨æ„ç»™å¯¹æ–¹ç©ºé—´',tips:'å­¦ä¼šå€¾å¬å¯¹æ–¹æ„è§ï¼Œä¿æŒæ²Ÿé€šå¹³è¡¡'},
          'ä¹™':{traits:'æ„Ÿæƒ…ç»†è…»æ¸©æŸ”ï¼Œéœ€è¦ç¨³å®šçš„æƒ…æ„Ÿæ”¯æŒï¼Œä½†ä¸è¦è¿‡åº¦ä¾èµ–å¯¹æ–¹',tips:'å»ºç«‹è‡ªä¿¡ï¼Œæ˜ç¡®è¡¨è¾¾è‡ªå·±çš„éœ€æ±‚'},
          'ä¸™':{traits:'æ„Ÿæƒ…çƒ­æƒ…å¥”æ”¾ï¼Œä½†å®¹æ˜“å†²åŠ¨ï¼Œè¦æ§åˆ¶æƒ…ç»ªæ³¢åŠ¨',tips:'æ§åˆ¶æƒ…ç»ªæ³¢åŠ¨ï¼Œé¿å…å†²åŠ¨è¨€è¡Œ'},
          'ä¸':{traits:'æ„Ÿæƒ…ä¸“ä¸€æ‰§ç€ï¼Œä½†å®¹æ˜“çŒœç–‘ï¼Œè¦é¿å…è¿‡åº¦çŒœç–‘',tips:'ä¿¡ä»»ä¼´ä¾£ï¼Œå‡å°‘ä¸å¿…è¦çš„çŒœç–‘'},
          'æˆŠ':{traits:'æ„Ÿæƒ…ç¨³é‡åŠ¡å®ï¼Œé‡è§†å®¶åº­ç¨³å®šï¼Œä½†è¦å­¦ä¼šè¡¨è¾¾æƒ…æ„Ÿ',tips:'å­¦ä¼šæµªæ¼«è¡¨è¾¾ï¼Œå¢åŠ æƒ…æ„Ÿäº¤æµ'},
          'å·±':{traits:'æ„Ÿæƒ…ç»†è…»ä½“è´´ï¼Œä½†å®¹æ˜“ç¼ºä¹å®‰å…¨æ„Ÿï¼Œè¦å»ºç«‹è‡ªä¿¡å¿ƒ',tips:'åŸ¹å…»å®‰å…¨æ„Ÿï¼Œä¸è¦è¿‡åº¦ä¾èµ–'},
          'åºš':{traits:'æ„Ÿæƒ…æœæ–­ç›´æ¥ï¼Œä¸å–œæ¬¢æ‹–æ³¥å¸¦æ°´ï¼Œä½†è¦è€ƒè™‘å¯¹æ–¹æ„Ÿå—',tips:'è€ƒè™‘å¯¹æ–¹æ„Ÿå—ï¼Œé€‚å½“æ”¾æ…¢èŠ‚å¥'},
          'è¾›':{traits:'æ„Ÿæƒ…è¿½æ±‚å®Œç¾ï¼Œå¯¹ä¼´ä¾£è¦æ±‚è¾ƒé«˜ï¼Œä½†è¦æ¥å—å¯¹æ–¹ç¼ºç‚¹',tips:'æ¥å—ä¸å®Œç¾ï¼Œé™ä½å¯¹ä¼´ä¾£çš„è¦æ±‚'},
          'å£¬':{traits:'æ„Ÿæƒ…ä¸°å¯Œå¤šå˜ï¼Œéœ€è¦æ–°é²œæ„Ÿï¼Œä½†è¦ä¿æŒæ„Ÿæƒ…ç¨³å®š',tips:'ä¿æŒæ„Ÿæƒ…ç¨³å®šï¼ŒåŸ¹å…»å…±åŒå…´è¶£'},
          'ç™¸':{traits:'æ„Ÿæƒ…ç»†è…»æ•æ„Ÿï¼Œå®¹æ˜“æƒ…ç»ªåŒ–ï¼Œä½†è¦å­¦ä¼šæƒ…ç»ªç®¡ç†',tips:'å­¦ä¼šæƒ…ç»ªç®¡ç†ï¼Œç†æ€§å¤„ç†çŸ›ç›¾'}
        };
        return dict[dayStem]||{traits:'æ„Ÿæƒ…è¿åŠ¿å¹³ç¨³ï¼Œéœ€è¦ç”¨å¿ƒç»è¥',tips:'ç›¸äº’å°Šé‡ï¼ŒçœŸè¯šæ²Ÿé€šæ˜¯å…³é”®'};
      },
      marriageAdvice(ten){
        if(ten.includes('æ­£å®˜')||ten.includes('æ­£è´¢')) return t('report.marriage.stable');
        if(ten.includes('ä¸ƒæ€')||ten.includes('åè´¢')) return t('report.marriage.experienced');
        return t('report.marriage.default');
      },
      career(dayStem,ten){
        const map={ç”²:'ç®¡ç†å²—ä½ã€åˆ›ä¸šå¼€æ‹“ã€å»ºç­‘å·¥ç¨‹',ä¹™:'æ•™è‚²æ–‡åŒ–ã€åˆ›æ„è®¾è®¡ã€å’¨è¯¢é¡¾é—®',ä¸™:'å¸‚åœºè¥é”€ã€å¨±ä¹äº§ä¸šã€èƒ½æºè¡Œä¸š',ä¸:'æŠ€æœ¯ç ”å‘ã€åŒ»ç–—æœåŠ¡ã€ç²¾å¯†åˆ¶é€ ',æˆŠ:'é‡‘èæŠ•èµ„ã€æˆ¿åœ°äº§ã€èµ„æºç®¡ç†',å·±:'äººåŠ›èµ„æºã€æœåŠ¡è¡Œä¸šã€å†œä¸šç›¸å…³',åºš:'æ³•å¾‹è¡Œä¸šã€æœºæ¢°å·¥ç¨‹ã€å†›è­¦èŒä¸š',è¾›:'é‡‘èåˆ†æã€ç²¾å¯†ä»ªå™¨ã€ç å®è¡Œä¸š',å£¬:'è´¸æ˜“ç‰©æµã€æ—…æ¸¸è¡Œä¸šã€åˆ›æ„äº§ä¸š',ç™¸:'ç ”ç©¶æœºæ„ã€å¿ƒç†å’¨è¯¢ã€è‰ºæœ¯åˆ›ä½œ'};
        let adv=t('report.career.steady');
        if(ten.includes('æ­£å®˜')||ten.includes('ä¸ƒæ€')) adv=t('report.career.leadership');
        else if(ten.includes('æ­£è´¢')||ten.includes('åè´¢')) adv=t('report.career.business');
        else if(ten.includes('é£Ÿç¥')||ten.includes('ä¼¤å®˜')) adv=t('report.career.creative');
        return {suitable:map[dayStem]||t('report.career.steady'), advice:adv};
      },
      wealthDirs(dayStem){
        const dirs={ç”²:'ä¸œæ–¹ã€ä¸œå—æ–¹',ä¹™:'ä¸œæ–¹ã€å—æ–¹',ä¸™:'å—æ–¹',ä¸:'å—æ–¹ã€è¥¿å—æ–¹',æˆŠ:'ä¸­éƒ¨ã€æœ¬åœ°',å·±:'ä¸­éƒ¨ã€è¥¿å—æ–¹',åºš:'è¥¿æ–¹ã€è¥¿åŒ—æ–¹',è¾›:'è¥¿æ–¹ã€åŒ—æ–¹',å£¬:'åŒ—æ–¹',ç™¸:'åŒ—æ–¹ã€ä¸œæ–¹'};
        return dirs[dayStem]||'-';
      },
      health(dayStem){
        const c={ç”²:'è‚èƒ†ã€è§†åŠ›ã€ç­‹éª¨',ä¹™:'è‚è„åŠŸèƒ½ä¸æƒ…ç»ªè°ƒèŠ‚',ä¸™:'å¿ƒè¡€ç®¡ä¸çœ¼ç›ï¼Œæ³¨æ„æƒ…ç»ª',ä¸:'å¿ƒè„ä¸å¾ªç¯ï¼Œä¿è¯ç¡çœ ',æˆŠ:'è„¾èƒƒæ¶ˆåŒ–ï¼Œè§„å¾‹é¥®é£Ÿ',å·±:'è„¾èƒƒä¸çš®è‚¤ï¼Œæ³¨æ„å«ç”Ÿ',åºš:'å‘¼å¸ç³»ç»Ÿä¸å¤§è‚ ï¼Œé¿å…å¹²ç‡¥',è¾›:'è‚ºéƒ¨ä¸å‘¼å¸ï¼Œä¿æŒé€šé£',å£¬:'è‚¾è„æ³Œå°¿ï¼Œæ°´åˆ†å¹³è¡¡',ç™¸:'è‚¾ä¸è†€èƒ±ï¼Œé¿å…è¿‡åŠ³'};
        return c[dayStem]||'ä½“è´¨è¾ƒä¸ºå¹³è¡¡ï¼Œæ³¨æ„ä½œæ¯';
      }
    };

    // AI integration (single definition + breaker)
    (function () {
      const LS_DOWN = 'ai:insight:downUntil';
      const now = () => Date.now();
      const downUntil = () => { try { return parseInt(localStorage.getItem(LS_DOWN)||'0',10)||0; } catch { return 0; } };
      const markDown = (ms = 180000) => { try { localStorage.setItem(LS_DOWN, String(now()+ms)); } catch {} };
      const clearDown = () => { try { localStorage.removeItem(LS_DOWN); } catch {} };

      async function fetchJSON(url, init={}, timeoutMs=15000){
        const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        try{
          const res = await fetch(url, {...init, signal: ctrl.signal});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } finally { clearTimeout(t); }
      }

      async function _aiExplain(section, ctx, {lang, temperature=0.7, seed=null}={}){
        if (!window.API_BASE) return null;
        const json = await fetchJSON(`${String(window.API_BASE).replace(/\/$/,'')}/bazi/insight`, {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ section, lang, temperature, seed, ctx })
        });
        if (json && (json.symbolise || json.analysis)) return json;
        return null;
      }

      window.aiExplain = async function (section, ctx, opts) {
        if (now() < downUntil()) return null;
        try {
          const out = await _aiExplain(section, ctx, opts||{});
          if (out) { clearDown(); return out; }
          markDown(); return null;
        } catch {
          markDown(); return null;
        }
      };

      window.injectAI = async function (section, symId, anaId, ctx, opts) {
        try {
          const out = await window.aiExplain(section, ctx, opts);
          if (!out) return;
          const $sym = document.getElementById(symId);
          const $ana = document.getElementById(anaId);
          if ($sym && out.symbolise) $sym.textContent = `${t('reportLabels.symbolise')}ï¼š${out.symbolise}`;
          if ($ana && out.analysis)  $ana.textContent = `${t('reportLabels.analysis')}ï¼š${out.analysis}`;
        } catch {}
      };

      window.forceAiInsightRetry = function () { try { localStorage.removeItem(LS_DOWN); } catch {} };
    })();

    /* ===== Renderers ===== */
    function renderPillars(labels){
      const titles=[t('pillar.year'),t('pillar.month'),t('pillar.day'),t('pillar.hour')];
      const box = $('bazi-pillars'); if(!box) return;
      box.innerHTML = labels.map((lab,i)=>`
        <div class="pillar"><div class="tit">${titles[i]}</div><div class="gz">${lab||'-'}</div></div>
      `).join('');
    }
    function renderTable(data){
      const keys=['year','month','day','hour'];
      const translateElem = (val)=>{
        const map = { 'æœ¨': t('elem.wood'), 'ç«': t('elem.fire'),'åœŸ': t('elem.earth'),'é‡‘': t('elem.metal'),'æ°´': t('elem.water') };
        return map[val] || val;
      };
      ['stem','branch','element','nayin'].forEach(row=>{
        keys.forEach((k, i)=>{
          const cell = $(k+'-'+row); if (!cell) return;
          let v = (Array.isArray(data[row]) ? data[row][i] : '-') ?? '-';
          if (row === 'element') v = translateElem(v);
          cell.textContent = v;
        });
      });
    }
    function renderBars(pcts){
      ['æœ¨','ç«','åœŸ','é‡‘','æ°´'].forEach(e=>{
        const pct=Math.max(0,Math.min(100,Math.round(pcts[e]||0)));
        const bar=$('bar-'+e), lab=$('pct-'+e);
        if(bar) bar.style.width=pct+'%';
        if(lab) lab.textContent=pct+'%';
      });
      const entries=Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
      if(entries.length){
        const strongest = entries[0][0], weakest = entries.at(-1)[0];
        const mapName = {æœ¨:t('elem.wood'),ç«:t('elem.fire'),åœŸ:t('elem.earth'),é‡‘:t('elem.metal'),æ°´:t('elem.water')};
        const tpl = (t('ui.balance') || '{strongest} æœ€æ—ºï¼Œ{weakest} åå¼±ã€‚');
        const txt = tpl.replace('{strongest}', mapName[strongest]).replace('{weakest}', mapName[weakest]);
        const el=$('bazi-elements-balance'); if(el) el.textContent=txt;
      }
    }

    /* ===== Pro Report ===== */
    function i18nDirs(s){
      if(!s) return '';
      const L = state.lang;
      const maps = {
        'zh-CN': {'ä¸œæ–¹':'ä¸œæ–¹','ä¸œå—æ–¹':'ä¸œå—æ–¹','å—æ–¹':'å—æ–¹','è¥¿å—æ–¹':'è¥¿å—æ–¹','è¥¿æ–¹':'è¥¿æ–¹','è¥¿åŒ—æ–¹':'è¥¿åŒ—æ–¹','åŒ—æ–¹':'åŒ—æ–¹','ä¸œåŒ—æ–¹':'ä¸œåŒ—æ–¹','ä¸­éƒ¨ã€æœ¬åœ°':'ä¸­éƒ¨/æœ¬åœ°'},
        'zh-TW': {'ä¸œæ–¹':'æ±æ–¹','ä¸œå—æ–¹':'æ±å—æ–¹','å—æ–¹':'å—æ–¹','è¥¿å—æ–¹':'è¥¿å—æ–¹','è¥¿æ–¹':'è¥¿æ–¹','è¥¿åŒ—æ–¹':'è¥¿åŒ—æ–¹','åŒ—æ–¹':'åŒ—æ–¹','ä¸œåŒ—æ–¹':'æ±åŒ—æ–¹','ä¸­éƒ¨ã€æœ¬åœ°':'ä¸­éƒ¨/æœ¬åœ°'},
        'en':    {'ä¸œæ–¹':'East','ä¸œå—æ–¹':'Southeast','å—æ–¹':'South','è¥¿å—æ–¹':'Southwest','è¥¿æ–¹':'West','è¥¿åŒ—æ–¹':'Northwest','åŒ—æ–¹':'North','ä¸œåŒ—æ–¹':'Northeast','ä¸­éƒ¨ã€æœ¬åœ°':'Center / Local'}
      };
      const map = maps[L] || maps['en'];
      return Object.keys(map).reduce((acc,k)=> acc.replaceAll(k, map[k]), s);
    }
    const TG_KEY = {
      'æ¯”è‚©':'tenGodsNames.biJian','åŠ«è´¢':'tenGodsNames.jieCai','é£Ÿç¥':'tenGodsNames.shiShen','ä¼¤å®˜':'tenGodsNames.shangGuan',
      'æ­£è´¢':'tenGodsNames.zhengCai','åè´¢':'tenGodsNames.pianCai','æ­£å®˜':'tenGodsNames.zhengGuan','ä¸ƒæ€':'tenGodsNames.qiSha',
      'æ­£å°':'tenGodsNames.zhengYin','åå°':'tenGodsNames.pianYin'
    };
    function tenGodTipKey(cn){ const base = TG_KEY[cn]?.replace('tenGodsNames','tenGodsHints'); return base||''; }
    function tenGodsAdviceList(arr){
      const m = {
        'æ¯”è‚©':'Self-reliant; avoid stubbornness.','åŠ«è´¢':'Shares resources; curb impulse spends.','é£Ÿç¥':'Creative output; keep rhythm & health.',
        'ä¼¤å®˜':'Expressive/critical; mind your tone.','æ­£è´¢':'Stable income focus; budget first.','åè´¢':'Opportunistic gains; set risk limits.',
        'æ­£å®˜':'Rules/structure; keep flexibility.','ä¸ƒæ€':'Decisive drive; avoid recklessness.','æ­£å°':'Learning/support; avoid over-protection.','åå°':'Insightful/unique; donâ€™t over-detach.'
      };
      return arr.map(cn => t(tenGodTipKey(cn)) || m[cn] || String(cn));
    }

    function supportElems(dm){
      const map = { ç”²:['æ°´','æœ¨'], ä¹™:['æ°´','æœ¨'], ä¸™:['æœ¨','ç«'], ä¸:['æœ¨','ç«'], æˆŠ:['ç«','åœŸ'], å·±:['ç«','åœŸ'], åºš:['åœŸ','é‡‘'], è¾›:['åœŸ','é‡‘'], å£¬:['é‡‘','æ°´'], ç™¸:['é‡‘','æ°´'] };
      const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
      return (map[dm]||[]).map(key);
    }
    function restrainElems(dm){
      const map = { ç”²:['é‡‘'], ä¹™:['é‡‘'], ä¸™:['æ°´'], ä¸:['æ°´'], æˆŠ:['æœ¨'], å·±:['æœ¨'], åºš:['ç«'], è¾›:['ç«'], å£¬:['åœŸ'], ç™¸:['åœŸ'] };
      const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
      return (map[dm]||[]).map(key);
    }
    function computeUseful(p){ // 2 weakest
      const arr = Object.entries({æœ¨:p.æœ¨||0,ç«:p.ç«||0,åœŸ:p.åœŸ||0,é‡‘:p.é‡‘||0,æ°´:p.æ°´||0}).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k])=>k);
      const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
      return arr.map(key);
    }

/* ===== Pro report builder (CN) Â· 10 sections ===== */
window.buildProReport = function buildProReport(ctx){
  const box = $('professionalReport');
  if (!box || !ctx) return;

  // ctx ç»“æ„ï¼š{ pcts, dayStem, tenGods, unknown }
  const dm = ctx.dayStem || '';                      // æ—¥ä¸»å¤©å¹²ï¼ˆç”²ä¹™ä¸™ä¸...ï¼‰
  const pctsCN = ctx.pcts || {};                    // {æœ¨:%, ç«:%, ...}
  const ten = Array.isArray(ctx.tenGods) ? ctx.tenGods.filter(Boolean) : [];

  // æŠŠã€Œæœ¨ç«åœŸé‡‘æ°´ã€ç™¾åˆ†æ¯”æ˜ å°„æˆè‹±æ–‡é”®ï¼Œæ–¹ä¾¿åé¢ strongest/weakest åˆ¤æ–­
  const elem = {
    Wood:  pctsCN['æœ¨'] || 0,
    Fire:  pctsCN['ç«'] || 0,
    Earth: pctsCN['åœŸ'] || 0,
    Metal: pctsCN['é‡‘'] || 0,
    Water: pctsCN['æ°´'] || 0,
  };

  function strongestWeakest(obj){
    const arr = Object.entries(obj || {});
    if (!arr.length) return { strongest:'', weakest:'' };
    arr.sort((a,b)=> b[1] - a[1]);
    return {
      strongest: arr[0][0],
      weakest:   arr[arr.length - 1][0]
    };
  }

  const { strongest, weakest } = strongestWeakest(elem);

  const ELEM_LABEL_CN = {
    Wood:  'æœ¨',
    Fire:  'ç«',
    Earth: 'åœŸ',
    Metal: 'é‡‘',
    Water: 'æ°´'
  };
  const strongestLabel = ELEM_LABEL_CN[strongest] || strongest || '-';
  const weakestLabel   = ELEM_LABEL_CN[weakest]   || weakest   || '-';

  // ==== æ–‡æ¡ˆï¼šå…¨éƒ¨ç”¨ä½ ä¸Šé¢å·²ç»æœ‰çš„ BaziAnalysis + I18N ====
  const dmLine   = BaziAnalysis.dayMasterLine(dm)
    || 'ä½ çš„æ—¥ä¸»ä¸ªæ€§æ•´ä½“æ¯”è¾ƒå¹³è¡¡ï¼Œä¹Ÿå…·æœ‰ä¸é”™çš„é€‚åº”åŠ›ã€‚';
  const rel      = BaziAnalysis.relation(dm);
  const marriage = BaziAnalysis.marriageAdvice(ten);
  const career   = BaziAnalysis.career(dm, ten);     // {suitable, advice}
  const wealthDir= BaziAnalysis.wealthDirs(dm);
  const healthFo = BaziAnalysis.health(dm);

  // å–œç”¨æ–¹å‘ï¼ˆç”¨ä½ ä¸Šé¢å·²ç»å†™å¥½çš„ helperï¼‰
  const supportKeys  = supportElems(dm);             // ['elem.wood', ...]
  const restrainKeys = restrainElems(dm);
  const usefulKeys   = computeUseful({               // ä¼ å…¥äº”è¡Œç™¾åˆ†æ¯”
    æœ¨: pctsCN['æœ¨'] || 0,
    ç«: pctsCN['ç«'] || 0,
    åœŸ: pctsCN['åœŸ'] || 0,
    é‡‘: pctsCN['é‡‘'] || 0,
    æ°´: pctsCN['æ°´'] || 0,
  });

  const supportText  = supportKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';
  const restrainText = restrainKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';
  const usefulText   = usefulKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';

  // äº”è¡Œæ¡å½¢æ–‡å­—
  const elemLine = `
    æœ¨ï¼š${Math.round(elem.Wood)}% Â·
    ç«ï¼š${Math.round(elem.Fire)}% Â·
    åœŸï¼š${Math.round(elem.Earth)}% Â·
    é‡‘ï¼š${Math.round(elem.Metal)}% Â·
    æ°´ï¼š${Math.round(elem.Water)}%
  `.replace(/\s+/g,' ');

  // è¿‘æœŸè¿åŠ¿ by æœ€å¼ºäº”è¡Œ
  let nearTermFocus  = t('fortune.foundation') || 'æ‰“åŸºç¡€ã€ç¨³èŠ‚å¥ä¸ºä¸»';
  let nearTermAdvice = t('cautions.default')   || 'é¿å¼€æƒ…ç»ªå†³ç­–ï¼Œæ§åˆ¶æ”¯å‡ºã€‚';

  switch (strongest) {
    case 'Wood':
      nearTermFocus  = t('fortune.upward') || 'åŠ¿å¤´å‘ä¸Šï¼Œåˆ©æ¨å¹¿/è¡¨è¾¾';
      nearTermAdvice = 'é€‚åˆå­¦ä¹ æ–°æŠ€èƒ½ã€æ‹“å±•äººè„‰ï¼Œæ¯å‘¨ç¨³å®šæ¨è¿›ä¸€ä¸ªä¸­æœŸé¡¹ç›®ã€‚';
      break;
    case 'Fire':
      nearTermFocus  = t('fortune.upward') || 'åŠ¿å¤´å‘ä¸Šï¼Œåˆ©æ¨å¹¿/è¡¨è¾¾';
      nearTermAdvice = 'é«˜èƒ½é‡é€‚åˆæ›å…‰ã€è°ˆåˆ¤ã€ä¸Šçº¿æ–°è®¡åˆ’ï¼ŒåŒæ—¶é¿å…ä¸€æ—¶å†²åŠ¨ã€‚';
      break;
    case 'Earth':
      nearTermFocus  = t('fortune.focus') || 'æ”¶æ•›èšç„¦ï¼Œåˆ©åˆ¶åº¦ä¸æ‰§è¡Œ';
      nearTermAdvice = 'æ•´ç†æ—¶é—´ä¸è´¢åŠ¡ç»“æ„ï¼ŒæŠŠç²¾åŠ›é›†ä¸­åœ¨æœ€æœ‰å›æŠ¥çš„ 1â€“2 ä¸ªæ–¹å‘ã€‚';
      break;
    case 'Metal':
      nearTermFocus  = t('fortune.focus') || 'æ”¶æ•›èšç„¦ï¼Œåˆ©åˆ¶åº¦ä¸æ‰§è¡Œ';
      nearTermAdvice = 'é€‚åˆåˆ¶å®šè§„åˆ™ã€æµç¨‹ã€åˆåŒä¸å¤‡æ´æ–¹æ¡ˆï¼Œä¸ºä¸‹ä¸€é˜¶æ®µæ‰“å¥½åˆ¶åº¦åŸºç¡€ã€‚';
      break;
    case 'Water':
      nearTermFocus  = t('fortune.study') || 'å­¦ä¹ è°ƒç ”æœŸï¼Œå…ˆè“„åå‘';
      nearTermAdvice = 'å¤šè§‚å¯Ÿã€å¤šæ¯”è¾ƒï¼Œå…ˆè¯•å°æ­¥å®éªŒï¼Œå†å†³å®šçœŸæ­£è¦æŠ¼æ³¨çš„æ–¹å‘ã€‚';
      break;
  }

  // ==== 10 ä¸ªæ ‡é¢˜ç”¨ I18Nï¼ˆæœ‰å°±ç”¨ï¼Œæ²¡æœ‰å°±ç”¨ä¸­æ–‡å…œåº•ï¼‰ ====
  const title = {
    overview:     t('reportTitles.overview')     || 'ğŸ“Š å‘½ç›˜æ€»è§ˆ',
    fiveElements: t('reportTitles.fiveElements') || 'ğŸŒ¿ äº”è¡Œåˆ†æ',
    tenGods:      t('reportTitles.tenGods')      || 'âš¡ åç¥é…ç½®',
    useful:       t('reportTitles.useful')       || 'ğŸ”‘ å–œç”¨ç¥',
    relation:     t('reportTitles.relationship') || 'ğŸ’• æ„Ÿæƒ…å©šå§»',
    career:       t('reportTitles.career')       || 'ğŸ’¼ äº‹ä¸šå‘å±•',
    wealth:       t('reportTitles.wealth')       || 'ğŸ’° è´¢è¿åˆ†æ',
    health:       t('reportTitles.health')       || 'ğŸŒ¡ï¸ å¥åº·å…»ç”Ÿ',
    nearTerm:     t('reportTitles.nearTerm')     || 'ğŸ”® è¿‘æœŸè¿åŠ¿',
    actions:      t('reportTitles.actions')      || 'ğŸ“ è¡ŒåŠ¨æ¸…å•',
  };

  const parts = [];

  // 1. å‘½ç›˜æ€»è§ˆ
  parts.push(`
    <div class="butler-section">
      <h4>1. ${title.overview}</h4>
      <p><strong>${t('reportLabels.dayMaster') || 'æ—¥ä¸»å‘½ç†'}ï¼š</strong> ${dm || '-'} æ—¥ä¸»</p>
      <p>${dmLine}</p>
      ${ctx.unknown ? `<p>${t('report.report.hourUnknownTip') || 'âš ï¸ å‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œéƒ¨åˆ†åˆ†æä»…ä¾›å‚è€ƒã€‚'}</p>` : ''}
    </div>
  `);

  // 2. äº”è¡Œåˆ†æ
  parts.push(`
    <div class="butler-section">
      <h4>2. ${title.fiveElements}</h4>
      <p>${elemLine}</p>
      <p>
        <strong>æœ€æ—ºäº”è¡Œï¼š</strong> ${strongestLabel} &nbsp;&nbsp;
        <strong>ç›¸å¯¹è¾ƒå¼±ï¼š</strong> ${weakestLabel}
      </p>
      <p>
        æœ€å¼ºçš„äº”è¡Œä»£è¡¨ä½ æœ€è‡ªç„¶ã€æœ€å®¹æ˜“å‘æŒ¥çš„æ–¹å¼ï¼›
        æœ€å¼±çš„äº”è¡Œæ˜¯å¯ä»¥æ…¢æ…¢è¡¥å¼ºçš„é•¿æœŸæˆé•¿åŒºåŸŸï¼Œä¸éœ€è¦æ€¥ç€ä¸€æ¬¡åˆ°ä½ã€‚
      </p>
    </div>
  `);

  // 3. åç¥é…ç½®ï¼ˆè¿™é‡Œç”¨ç®€åŒ–è¯´æ˜ï¼‰
  parts.push(`
    <div class="butler-section">
      <h4>3. ${title.tenGods}</h4>
      <p>
        è¿™ä»½å¿«é€ŸæŠ¥å‘Šæ²¡æœ‰é€ä¸€åˆ—å‡ºæ¯ä¸ªåç¥çš„æŠ€æœ¯ç»†èŠ‚ï¼Œ
        ä½†æ•´ä½“æ ¼å±€æ˜¾ç¤ºï¼Œä½ åœ¨<strong>è‡ªæˆ‘è¡¨è¾¾ã€èµ„æºè¿ç”¨ä¸å¯¹ä»–äººè´£ä»»æ„Ÿ</strong>ä¹‹é—´ï¼Œ
        éœ€è¦æ‰¾åˆ°å¹³è¡¡ï¼šæ—¢ä¸èƒ½å®Œå…¨å¿½ç•¥è‡ªå·±ï¼Œä¹Ÿä¸é€‚åˆé•¿æœŸå§”å±ˆè‡ªå·±ã€‚
      </p>
      <p>
        å½“ä½ æ„Ÿè§‰ç‰¹åˆ«ç´¯æˆ–è¢«æ¶ˆè€—æ—¶ï¼Œå¯ä»¥é—®è‡ªå·±ï¼š
        ã€Œç°åœ¨è¿™ä»¶äº‹ï¼Œæ˜¯ä¸ºäº†è°ï¼Ÿæˆ‘æœ‰æ²¡æœ‰æŠŠè‡ªå·±çš„åº•çº¿è®²æ¸…æ¥šï¼Ÿã€
      </p>
    </div>
  `);

  // 4. å–œç”¨ç¥æ–¹å‘
  parts.push(`
    <div class="butler-section">
      <h4>4. ${title.useful}</h4>
      <p><strong>å¸®æ‰¶äº”è¡Œï¼š</strong> ${supportText}</p>
      <p><strong>éœ€è¦è¢«æ”¶æ•›ï¼å¹³è¡¡çš„äº”è¡Œï¼š</strong> ${restrainText}</p>
      <p><strong>å½“å‰å¯ä¼˜å…ˆè¡¥å¼ºçš„æ–¹å‘ï¼š</strong> ${usefulText || 'æ•´ä½“è¾ƒä¸ºå¹³å‡ï¼Œå¯ä¾ç”Ÿæ´»ç›®æ ‡çµæ´»è°ƒæ•´ã€‚'}</p>
      <p>
        ä½ å¯ä»¥é€è¿‡é¢œè‰²ã€ç¯å¢ƒå¸ƒç½®ã€å·¥ä½œå†…å®¹ä¸ç›¸å¤„å¯¹è±¡ï¼Œ
        æœ‰æ„è¯†åœ°å¼ºåŒ–å–œç”¨çš„äº”è¡Œï¼Œä¾‹å¦‚ï¼š
        é€‰æ‹©å¯¹åº”äº”è¡Œçš„é¢œè‰²ã€æ–¹ä½ä¸æ´»åŠ¨èŠ‚å¥ã€‚
      </p>
    </div>
  `);

  // 5. æ„Ÿæƒ…å©šå§»
  parts.push(`
    <div class="butler-section">
      <h4>5. ${title.relation}</h4>
      <p><strong>æ„Ÿæƒ…é£æ ¼ï¼š</strong> ${rel.traits}</p>
      <p><strong>å…³ç³»å»ºè®®ï¼š</strong> ${rel.tips}</p>
      <p><strong>å©šå§»æç¤ºï¼š</strong> ${marriage}</p>
      <p>
        æ„Ÿæƒ…å¯¹ä½ æ¥è¯´ï¼Œä¸åªæ˜¯æµªæ¼«ï¼Œæ›´æ˜¯é•¿æœŸçš„ã€Œåˆä½œå…³ç³»ã€ï¼š
        åœ¨ç¨³å®šçš„ç”Ÿæ´»èŠ‚å¥ã€æ¸…æ¥šçš„è¾¹ç•Œä¸è¯šå®æ²Ÿé€šä¸‹ï¼Œå…³ç³»ä¼šé¡ºå¾—å¤šã€‚
      </p>
    </div>
  `);

  // 6. äº‹ä¸šå‘å±•
  parts.push(`
    <div class="butler-section">
      <h4>6. ${title.career}</h4>
      <p><strong>é€‚åˆé¢†åŸŸï¼š</strong> ${career.suitable}</p>
      <p><strong>èŒæ¶¯å»ºè®®ï¼š</strong> ${career.advice}</p>
      <p>
        å°¤å…¶é€‚åˆä»¥<strong>ã€Œé•¿æœŸæ·±è€• + ä¸“ä¸šå£ç¢‘ã€</strong>çš„æ–¹å¼å‰è¿›ï¼Œ
        è®©åˆ«äººä¸€æƒ³åˆ°æŸä¸ªä¸»é¢˜ï¼Œå°±ä¼šè‡ªç„¶è”æƒ³åˆ°ä½ ï¼Œè€Œä¸æ˜¯åªé ä¸€ä¸¤æ¬¡çŸ­æš‚çš„æœºä¼šã€‚
      </p>
    </div>
  `);

  // 7. è´¢è¿åˆ†æ
  parts.push(`
    <div class="butler-section">
      <h4>7. ${title.wealth}</h4>
      <p><strong>æ±‚è´¢æ–¹å‘ï¼ˆæ–¹ä½å‚è€ƒï¼‰ï¼š</strong> ${wealthDir || '-'}</p>
      <p>
        è´¢è¿çš„å…³é”®ä¸åªæ˜¯ã€Œæœ‰æ²¡æœ‰æœºä¼šã€ï¼Œè€Œæ˜¯ä½ å¯¹ç°é‡‘æµå’Œé£é™©çš„æ•æ„Ÿåº¦ï¼š
        å»ºè®®å…ˆç¨³ä½ä¸»è¦æ”¶å…¥ï¼Œå†ä¸ºé«˜é£é™©é¡¹ç›®è®¾å®šã€ŒæŸå¤±ä¸Šé™ã€ã€‚
      </p>
      <p>
        å¯¹ä½ æ¥è¯´ï¼Œæœ€å¯æŒç»­çš„è´¢å¯Œæ¨¡å¼ï¼Œæ˜¯ç”¨ä¸“ä¸šä¸ä¿¡ä»»ç´¯ç§¯æ”¶å…¥ï¼Œ
        å†æ…¢æ…¢å‘å±•ä¸ä½ ä¸ªæ€§ç›¸ç¬¦çš„å‰¯ä¸šæˆ–é¢å¤–æ”¶å…¥æ¥æºã€‚
      </p>
    </div>
  `);

  // 8. å¥åº·å…»ç”Ÿ
  parts.push(`
    <div class="butler-section">
      <h4>8. ${title.health}</h4>
      <p><strong>èº«ä½“å…³æ³¨é‡ç‚¹ï¼š</strong> ${healthFo}</p>
      <p>
        å…»ç”Ÿä¸è¦å¤æ‚ï¼Œä¸€å¼€å§‹åªè¦åšåˆ°ï¼šè§„å¾‹ç¡çœ ã€ç®€å•è¿åŠ¨ã€é¥®é£Ÿä¸è¿‡åº¦ï¼Œ
        å†åŠ ä¸Šä¸€ç§å¯ä»¥æŒç»­çš„æƒ…ç»ªå®£æ³„æ–¹å¼ï¼ˆå†™æ—¥è®°ã€æ•£æ­¥ã€å†¥æƒ³ã€ç¥ˆç¥·ç­‰ï¼‰ï¼Œ
        å¯¹ä½ æ•´ä½“çš„èƒ½é‡éƒ½ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚
      </p>
    </div>
  `);

  // 9. è¿‘æœŸè¿åŠ¿ï¼ˆ3â€“6 ä¸ªæœˆï¼‰
  parts.push(`
    <div class="butler-section">
      <h4>9. ${title.nearTerm}</h4>
      <p><strong>è¿‘æœŸä¸»è½´ï¼š</strong> ${nearTermFocus}</p>
      <p><strong>å»ºè®®ï¼š</strong> ${nearTermAdvice}</p>
      <p>
        å½“ä½ è§‰å¾—æ–¹å‘æ··ä¹±æˆ–å‹åŠ›å˜å¤§æ—¶ï¼Œå¯ä»¥å…ˆæš‚åœæ–°è®¡åˆ’ï¼Œ
        æŠŠç°æœ‰äº‹æƒ…åˆ†çº§ï¼šå¿…è¦çš„å…ˆåšï¼Œæ¬¡è¦çš„å…ˆæ”¾ï¼Œ
        ç•™ä¸€ç‚¹ç©ºé—´ç»™è‡ªå·±è°ƒæ•´èŠ‚å¥ï¼Œè¿åŠ¿ä¼šæ¯”è¾ƒé¡ºæµã€‚
      </p>
    </div>
  `);

  // 10. è¡ŒåŠ¨æ¸…å•
  parts.push(`
    <div class="butler-section">
      <h4>10. ${title.actions}</h4>
      <ul class="action-list">
        <li>åœ¨ 30 å¤©å†…ï¼Œåªé€‰ä¸€ä¸ªæœ€é‡è¦çš„ç›®æ ‡ï¼ˆå·¥ä½œ / é’± / å¥åº·ï¼‰ï¼Œå†™æ¸…æ¥šå¹¶è´´åœ¨çœ‹å¾—åˆ°çš„åœ°æ–¹ã€‚</li>
        <li>æ¯å‘¨å›ºå®šé€‰ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæ£€æŸ¥è‡ªå·±åœ¨è¿™ä¸ªç›®æ ‡ä¸Šçš„å®é™…è¿›åº¦ï¼Œè€Œä¸æ˜¯åªçœ‹å¿ƒæƒ…ã€‚</li>
        <li>æœ‰æ„è¯†åœ°æ”¾å¤§ä½ æœ€å¼ºçš„äº”è¡Œï¼ˆ${strongestLabel}ï¼‰ï¼Œç”¨é¢œè‰²ã€ç¯å¢ƒå’Œäººé™…åœˆæ¥æ”¯æŒå®ƒã€‚</li>
        <li>é’ˆå¯¹æœ€å¼±çš„äº”è¡Œï¼ˆ${weakestLabel}ï¼‰ï¼Œè®¾è®¡ 1â€“2 ä¸ªå¯ä»¥æ¯å¤©æˆ–æ¯å‘¨åšåˆ°çš„å°ä¹ æƒ¯ï¼Œä¸æ€¥ç€æ±‚å¿«ï¼Œåªæ±‚ç¨³å®šã€‚</li>
      </ul>
    </div>
  `);

  box.innerHTML = parts.join('\n');

  const sec = $('butlerProfessional');
  if (sec) sec.style.display = 'block';

  // è®© i18n é‡åˆ·æ—¶å¯ä»¥é‡å»ºè¿™ä»½æŠ¥å‘Š
  window.lastCtx = ctx;
};
    
    /* ===== Gen + UI ===== */
    function showErr(msg){ const box=$('error'); if(!box) return; box.textContent=msg||t('err.generateFail'); box.style.display='block'; setTimeout(()=>{ box.style.display='none'; }, 4000); }
    function setGenLoading(v){ const btn=$('genBtn'), txt=$('genBtnText'), ld=$('genBtnLoading'); if(btn) btn.disabled=!!v; if(txt) txt.style.display=v?'none':'inline'; if(ld) ld.style.display=v?'inline':'none'; }
    function generate(){
      const birth = ($('birthdate')?.value||'').trim();
      if(!birth) return showErr(t('err.fillBirthdate'));
      if(!/^\d{4}-\d{2}-\d{2}$/.test(birth)) return showErr(t('err.invalidDate'));
      const [Y,M,D]=birth.split('-').map(n=>parseInt(n,10));
      const unknown = $('timeUnknown')?.checked;
      const timeVal = $('birthtime')?.value || '00:00';
      const hh = parseInt((timeVal.split(':')[0]||'0'),10) || 0;

      setGenLoading(true);
      try{
        const calc = new BaziCalculator();
        const y = calc.yearPillar(Y);
        const m = calc.monthPillar(Y,M,D);
        const d = calc.dayPillar(Y,M,D);
        const h = unknown ? {stem:'-',branch:'-'} : calc.hourPillar(d.stem, hh);

        renderPillars([y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, unknown ? (t('badge.noHour')||'-') : (h.stem+h.branch)]);

        const stems=[y.stem,m.stem,d.stem, unknown? '-' : h.stem];
        const branch=[y.branch,m.branch,d.branch, unknown? '-' : h.branch];
        const rawElems=[calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem), unknown? '-' : calc.stemElem(h.stem)];
        const nayin=[calc.nayin(y.stem,y.branch),calc.nayin(m.stem,m.branch),calc.nayin(d.stem,d.branch), unknown? '-' : calc.nayin(h.stem,h.branch)];
        renderTable({stem:stems,branch:branch,element:rawElems,nayin});

        const allElems = [calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem)]
          .concat(unknown?[]:[calc.stemElem(h.stem)])
          .concat([calc.branchElem(y.branch),calc.branchElem(m.branch),calc.branchElem(d.branch)])
          .concat(unknown?[]:[calc.branchElem(h.branch)]);
        const counts = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0}; allElems.forEach(e=>{ if(counts[e]!=null) counts[e]++; });
        const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
        const pcts = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, 100*v/total]));
        renderBars(pcts);

        const timeText = unknown ? (t('ui.timeUnknown')||'') :
          (t('ui.hourSuffix')||'{hh}:{mm}').replace('{hh}', String(hh).padStart(2,'0')).replace('{mm}', String(parseInt((timeVal.split(':')[1]||'0'),10)||0).padStart(2,'0'));
        const btxt = (t('ui.birthSummary')||'').replace('{y}',Y).replace('{m}',M).replace('{d}',D).replace('{timeText}', timeText);
        const bd=$('bazi-date'); if (bd) bd.textContent = btxt;

        const tg = calc.tenGods(d.stem, stems);
        const ctx = { pcts, dayStem: d.stem, tenGods: tg, unknown };
        window.buildProReport(ctx);

        $('result').style.display='block';
        $('butlerProfessional').style.display='block';
      }catch(e){ console.error(e); showErr(t('err.generateFail')); }
      finally{ setGenLoading(false); }
    }

    function appendMsg(text, who='user'){
      const box=$('chatMessages'); if(!box) return;
      const div=document.createElement('div');
      div.className = who==='user' ? 'me-msg' : 'ss-msg';
      div.textContent = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function setupAuthReveal(){
      const fields = $('authFields'); if(!fields) return;
      fields.style.display='none';
      const btn = document.createElement('button');
      btn.type='button'; btn.className='btn ghost block'; btn.id='revealAuthBtn';
      btn.textContent = 'ğŸ‘ æ˜¾ç¤ºè´¦å·è¾“å…¥ / Reveal login fields';
      const panelBody = fields.parentElement;
      panelBody.insertBefore(btn, panelBody.firstChild);
      btn.addEventListener('click', ()=>{
        const visible = fields.style.display!=='none';
        fields.style.display = visible ? 'none' : 'grid';
        btn.textContent = visible ? 'ğŸ‘ æ˜¾ç¤ºè´¦å·è¾“å…¥ / Reveal login fields' : 'ğŸ™ˆ éšè—è´¦å·è¾“å…¥ / Hide login fields';
      });
      const loginForm = $('loginForm'); const registerForm = $('registerForm'); const resetBtn = $('resetBtn'); const err = $('authError');
      function block(e){ e?.preventDefault(); if(err){ err.style.display='block'; err.textContent='Auth not wired yet / ç™»å½•æš‚æœªæ¥å…¥'; setTimeout(()=>err.style.display='none',3000); } }
      if(loginForm) loginForm.addEventListener('submit', block);
      if(registerForm) registerForm.addEventListener('submit', block);
      if(resetBtn) resetBtn.addEventListener('click', block);
    }

function onLangSelect(e){
  const lang = (e.target?.value) || 'zh-CN';
  try { localStorage.setItem('5x_lang', lang); } catch {}

  const LANG_PAGES = {
    'zh-CN': '/bazi.html',                                  // å½“å‰è¿™é¡µï¼ˆç®€ä½“ä¸­æ–‡ï¼‰
    'en':    '/assets/bazi-language-pack/bazi-en.html',     // è‹±æ–‡ç‰ˆ
    'zh-TW': '/assets/bazi-language-pack/bazi-zh-TW.html',
    'ja':    '/assets/bazi-language-pack/bazi-ja.html',
    'th':    '/assets/bazi-language-pack/bazi-th.html',
    'ms':    '/assets/bazi-language-pack/bazi-ms.html'
  };

  const target = LANG_PAGES[lang] || LANG_PAGES['zh-CN'];
  if (!target) return;

  // é¿å…é‡å¤è·³è½¬
  if (!window.location.pathname.endsWith(target)) {
    window.location.href = target;
  }
}

    function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
      const loc = localeMap[state.lang || 'zh-CN'] || 'en-US';
      const fmt = new Intl.DateTimeFormat(loc, { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, timeZone: SG_TZ });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    }
    window.tickNow = tickNow;

    function boot(){
      if (boot._didBoot) return; boot._didBoot = true;
      const langSel = $('langSelect');
      if (langSel) { langSel.value = state.lang; langSel.addEventListener('change', onLangSelect); }
      applyI18n();

      const unk = $('timeUnknown'), bt = $('birthtime');
      if (unk && bt){
        const sync = ()=>{ bt.disabled = !!unk.checked; bt.style.opacity = bt.disabled ? 0.5 : 1; };
        unk.addEventListener('change', sync); sync();
      }
      $('genBtn')?.addEventListener('click', generate);

      const chatToggle = $('chatToggle'), chatFloat  = $('chatFloat'), chatClose  = $('chatClose'), chatSend   = $('chatSend'), chatInput  = $('chatInput');
      if (chatToggle && chatFloat){ chatToggle.addEventListener('click', ()=>{ const cur = getComputedStyle(chatFloat).display; chatFloat.style.display = (cur === 'none' ? 'flex' : 'none'); }); }
      if (chatClose && chatFloat){ chatClose.addEventListener('click', ()=>{ chatFloat.style.display = 'none'; }); }
      if (chatSend && chatInput){
        const send = ()=>{ const q=(chatInput.value||'').trim(); if(!q) return; appendMsg(q,'user'); chatInput.value=''; const tpl=t('chatDyn.autoReply')||'æ”¶åˆ°ï¼š{q}ã€‚'; appendMsg(tpl.replace('{q}',q),'bot'); };
        chatSend.addEventListener('click', send);
        chatInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); send(); } });
      }

      tickNow(); if (!boot._clock) boot._clock = setInterval(tickNow, 60000);
      setupAuthReveal();
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot, { once:true });
    else boot();
  })();
  </script>

<!-- Clock + defaults keep-in-sync with language -->
<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Singapore';
  const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
  const getLocale = () => (localeMap[(window.state && window.state.lang) || 'zh-CN'] || 'en-US');

  // Chain applyI18n without breaking the version the app set earlier
  window.applyI18n = (function(prev){
    return function(){
      if (typeof prev === 'function') prev();
      if (typeof window.tickNow === 'function') window.tickNow();
    };
  })(window.applyI18n);

  // Define tickNow only if the app hasn't already defined it
  if (typeof window.tickNow !== 'function') {
    window.tickNow = function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const fmt = new Intl.DateTimeFormat(getLocale(), {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false, timeZone: TZ
      });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    };
  }

  // One-time birth defaults (kept exactly as behavior you intended)
  function initBirthDefaults() {
    const bd = $('birthdate'); const bt = $('birthtime'); const unk = $('timeUnknown');
    const nowSG = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));

    if (bd && !bd.value){
      const y=nowSG.getFullYear(), m=String(nowSG.getMonth()+1).padStart(2,'0'), d=String(nowSG.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    if (bt){
      const hh=String(nowSG.getHours()).padStart(2,'0'), mm=String(nowSG.getMinutes()).padStart(2,'0');
      if (!bt.value) bt.value = `${hh}:${mm}`;
      const setUnknownState = ()=>{ const isUnknown = !!(unk && unk.checked); bt.disabled = isUnknown; if (isUnknown) bt.value = ''; };
      setUnknownState();
      if (unk && !unk._wired){
        unk._wired = true;
        unk.addEventListener('change', ()=>{
          if (unk.checked){
            bt.disabled = true; bt.value = '';
          } else {
            bt.disabled = false;
            if (!bt.value){
              const n = new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
              bt.value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
            }
          }
        });
      }
    }
  }

  // Initial render + clock; guard against duplicate intervals from the main app
  initBirthDefaults();
  if (typeof window.tickNow === 'function') window.tickNow();
  if (!window._clock) window._clock = setInterval(()=>{ try{ window.tickNow(); }catch{} }, 60000);
})();
</script>
</body>
</html>
