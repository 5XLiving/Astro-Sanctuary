<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- 农历 <-> 阳历 可靠转换（成熟库） -->
<script src="https://unpkg.com/solarlunar@2.0.6/solarlunar.min.js"></script>

<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#0b0f14;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid:#1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 结果样式 */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.3rem;font-weight:700;letter-spacing:.05em}
.bars{display:grid;gap:8px;margin-top:10px}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.ul{margin:.4rem 0 0 .9rem;line-height:1.8}

/* Chat */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:95%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}

/* Chat 字号微调 */
.ss-chat-panel{font-size:15.5px}.ss-chat-head{font-size:16.5px}.ss-chat-body{gap:10px}
.ss-msg{font-size:15.5px;line-height:1.65;padding:10px 12px;border-radius:12px;max-width:95%}
.ss-msg.me{font-size:15.5px;line-height:1.65;padding:10px 12px;border-radius:12px}
.ss-chat-input input{font-size:15.5px;height:44px;padding:10px 12px}
.ss-chat-input button{font-size:15.5px;height:44px;padding:0 14px}
@media (max-width: 480px){
  .ss-chat-panel{font-size:16px}
  .ss-msg,.ss-msg.me{font-size:16px;line-height:1.7}
  .ss-chat-input input,.ss-chat-input button{height:46px;font-size:16px}
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title" data-i18n="site_title">命理供门 · 八字简评</div>
        <div class="muted" data-i18n="site_subtitle">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <section class="card">
    <div class="h2" data-i18n="form_title">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="name_label">姓名（可选）</label>
        <input id="name" data-i18n-ph="ph_name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">性别</label>
        <select id="gender">
          <option value="" data-i18n="gender_unknown">不透露</option>
          <option value="male" data-i18n="gender_male">男性</option>
          <option value="female" data-i18n="gender_female">女性</option>
          <option value="other" data-i18n="gender_other">其他</option>
        </select>
      </div>

      <!-- 历法 + 闰月 -->
      <div>
        <label class="muted" data-i18n="calendar_label">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_gregorian">阳历 / Gregorian</option>
            <option value="lunar" data-i18n="opt_lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none;font-size:.9rem;color:#cbd6e2;">
            <input type="checkbox" id="isLeap" /> 闰月
          </label>
        </div>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" id="calendarHint" style="display:none;margin-top:6px">
          当前为农历输入。若遇闰月请勾选“闰月”。系统将自动转换为阳历再计算。
        </div>
      </div>
      <div>
        <label class="muted" data-i18n="birth_time_label">出生时间</label>
        <input type="time" id="birthtime">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn" data-i18n="btn_generate">生成八字</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px" data-i18n="tip_tz">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div class="muted" id="error" style="color:#ffb4b4;display:none"></div>
  </section>

  <!-- 结果 -->
  <section id="result" style="display:none;">
    <div class="card section">
      <div class="h2" data-i18n="sec_bazi">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2" data-i18n="sec_wuxing">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-fire"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-earth" style="width:0%"></i></div>
        <div class="bar"><i id="bar-metal" style="width:0%"></i></div>
        <div class="bar"><i id="bar-water" style="width:0%"></i></div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <div class="card section">
      <div class="h2" data-i18n="sec_summary">命格简评</div>
      <div class="desc" id="bazi-advice" style="white-space:pre-wrap;line-height:1.7"></div>
      <ul class="ul" id="fate-points"></ul>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle" data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
/* ===== 配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const LANG_KEY = "site_lang";

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

/* ===== i18n（精简） ===== */
const i18n = {
  "zh-CN": {
    title:"八字命理 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
    site_title:"命理供门 · 八字简评", site_subtitle:"免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名",
    form_title:"八字命理 · 快速排盘",
    name_label:"姓名（可选）", ph_name:"你的称呼（用于个性化）",
    gender_label:"性别", gender_unknown:"不透露", gender_male:"男性", gender_female:"女性", gender_other:"其他",
    calendar_label:"历法", opt_gregorian:"阳历 / Gregorian", opt_lunar:"农历 / Lunar",
    birth_label:"出生日期", birth_time_label:"出生时间",
    btn_generate:"生成八字",
    tip_tz:"提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。",
    sec_bazi:"八字命理排盘", sec_wuxing:"五行分析", sec_summary:"命格简评",
    need_birth:"请完善出生日期与时间（若选农历，将自动换算为阳历）。",
    generating:"正在生成排盘与简评…",
    neterr:"网络异常，请稍后再试。", retry:"抱歉，暂时无法生成，请稍后再试。"
  },
  "en": {
    title:"BaZi (Four Pillars) · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
    site_title:"Astro Gate · BaZi Snapshot", site_subtitle:"Free preview · Deeper with VIP",
    form_title:"BaZi · Quick Chart",
    name_label:"Name (optional)", ph_name:"How to address you",
    gender_label:"Gender", gender_unknown:"Prefer not to say", gender_male:"Male", gender_female:"Female", gender_other:"Other",
    calendar_label:"Calendar", opt_gregorian:"Gregorian (Solar)", opt_lunar:"Lunar",
    birth_label:"Birthdate", birth_time_label:"Birth time",
    btn_generate:"Generate",
    tip_tz:"Note: temporarily assumes UTC+8.",
    sec_bazi:"BaZi Chart", sec_wuxing:"Five-Elements Balance", sec_summary:"Reading",
    need_birth:"Please provide both date and time. If Lunar is chosen, it will be converted to Solar first.",
    generating:"Generating chart & summary…",
    neterr:"Network error. Try again."
  },
  "ms": {
    title:"BaZi · 5XLiving", brand:"Soul Sanctuary", lang_label:"Bahasa",
    site_title:"Gerbang Astro · Ringkasan BaZi", site_subtitle:"Percuma · Versi VIP lebih mendalam",
    form_title:"BaZi · Carta Pantas",
    name_label:"Nama (pilihan)", ph_name:"Cara memanggil anda",
    gender_label:"Jantina", gender_unknown:"Rahsiakan", gender_male:"Lelaki", gender_female:"Perempuan", gender_other:"Lain",
    calendar_label:"Kalendar", opt_gregorian:"Gregorian (Suria)", opt_lunar:"Lunar",
    birth_label:"Tarikh lahir", birth_time_label:"Masa lahir",
    btn_generate:"Jana",
    tip_tz:"Nota: buat masa ini menganggap UTC+8.",
    sec_bazi:"Carta BaZi", sec_wuxing:"Keseimbangan Lima Unsur", sec_summary:"Ringkasan",
    need_birth:"Sila isi tarikh & masa. Jika Lunar dipilih, akan ditukar kepada Suria dahulu.",
    generating:"Menjana carta & ringkasan…",
    neterr:"Ralat rangkaian."
  }
};
function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{ const k=el.getAttribute("data-i18n"); el.textContent = t(k); });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{ const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k)); });
  const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']"); if(titleEl){ titleEl.textContent=t("title"); }
}

/* ===== Chat 浮窗（原样） ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      let data={}; try{data=await r.json()}catch{}
      const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||t('retry'));
    }catch{ addMsg(t('neterr')); }
  }
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();

/* ===== 渲染工具 ===== */
const pillarsEl = $('bazi-pillars');
const dateEl = $('bazi-date');
const dmEl = $('bazi-day-master');
const adviceEl = $('bazi-advice');
const pointsEl = $('fate-points');
const bars = {
  wood: $('bar-wood'),
  fire: $('bar-fire'),
  earth: $('bar-earth'),
  metal: $('bar-metal'),
  water: $('bar-water')
};
function setBar(el, pct){ el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function renderPillars(p){
  pillarsEl.innerHTML = '';
  const map = [
    ['年柱', p.year], ['月柱', p.month], ['日柱', p.day], ['时柱', p.hour]
  ];
  map.forEach(([tit, v])=>{
    const div = document.createElement('div');
    div.className='pillar';
    div.innerHTML = `<div class="tit">${tit}</div><div class="gz">${(v && v.gz) || '--'}</div>`;
    pillarsEl.appendChild(div);
  });
}

/* ===== 输入规范化 & 农历<->阳历 交叉校验 ===== */
function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str; // yyyy-mm-dd
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // dd/mm/yyyy
  if(m){ const [_, d, mo, y] = m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTimeTo24h(t){
  if(!t) return '00:00';
  const s = t.trim().toLowerCase().replace(/\s+/g,'');
  const m = s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t; // 原生 <input type="time"> 已是 HH:MM
  let hh = parseInt(m[1],10), mm = parseInt(m[2]||'0',10);
  const ap = m[3];
  if(ap === 'am'){ if(hh===12) hh=0; }
  else if(ap === 'pm'){ if(hh!==12) hh+=12; }
  return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
}
function lunarToSolarChecked(y, m, d, isLeap){
  const s = solarlunar.lunar2solar(y, m, d, !!isLeap);
  const Y = s.cYear || s.gregorianYear || s.year;
  const M = s.cMonth || s.gregorianMonth || s.month;
  const D = s.cDay || s.gregorianDay || s.day;
  const back = solarlunar.solar2lunar(Y, M, D);
  const ok = back.lYear===y && back.lMonth===m && back.lDay===d && (!!back.isLeap)===!!isLeap;
  if(!ok) throw new Error('农历/阳历交叉校验失败：请确认闰月是否正确、日期是否有效。');
  return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
}

/* ===== 组装提示（请求后端算盘并返回结构化） ===== */
function buildPromptBaZi({langName, name, gender, birthdate, birthtime}){
  const dt = `${birthdate} ${birthtime}:00`;
  return `你是 5XLiving 的“心怜管家”与专业命理助手。请以【${langName}】输出，并返回一个 JSON + 简短文字说明，用于前端渲染。
输入：
- 历法：阳历（Gregorian）
- 时区：默认东八区（UTC+8）
- 出生：${dt}
- 姓名：${name||'（未填）'}；性别：${gender||'（未填）'}

请先计算四柱（年、月、日、时）天干地支与日主，然后评估五行占比。严格按下方 JSON 结构返回（0–100 为相对占比）：
{
  "pillars":{
    "year":{"gz":"甲子"},
    "month":{"gz":"丙寅"},
    "day":{"gz":"辛卯"},
    "hour":{"gz":"癸亥"}
  },
  "dayMaster":{"stem":"辛","element":"金","desc":"…"},
  "elements":{"wood":0,"fire":0,"earth":0,"metal":0,"water":0},
  "strengths":["…","…"],
  "advice":"（3-6 段短句，围绕节奏/取舍/合作/健康/财务）"
}
紧随 JSON 后，再输出 3-5 条要点（短句）。不要添加无关前后缀。`;
}

/* ===== 请求 AI（命理） ===== */
async function askAI(prompt){
  const resp = await fetch(`${API_BASE}/api/chat`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[
      {role:'system',content:'你会计算八字四柱（可用简化近似），并生成结构化 JSON 供前端渲染；语言简洁、专业、可执行。'},
      {role:'user',content:prompt}
    ]})
  });
  let data={}; try{data=await resp.json()}catch{}
  return data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? '';
}
function safeParseJSONFromText(txt){
  const m = txt.match(/\{[\s\S]*\}/);
  if(!m) return null;
  try{ return JSON.parse(m[0]); }catch{ return null; }
}
function renderFromJSON(j){
  $('result').style.display='block';
  renderPillars(j.pillars||{});

  const dm = j.dayMaster||{};
  dmEl.textContent = dm.stem ? `日主：${dm.stem}（${dm.element||''}） ${dm.desc||''}` : '';

  const e = j.elements||{};
  const sum = Math.max(1, (e.wood||0)+(e.fire||0)+(e.earth||0)+(e.metal||0)+(e.water||0));
  setBar(bars.wood,  (e.wood||0)/sum*100);
  setBar(bars.fire,  (e.fire||0)/sum*100);
  setBar(bars.earth, (e.earth||0)/sum*100);
  setBar(bars.metal, (e.metal||0)/sum*100);
  setBar(bars.water, (e.water||0)/sum*100);

  $('bazi-elements-balance').textContent =
    `五行占比：木${e.wood||0} 火${e.fire||0} 土${e.earth||0} 金${e.metal||0} 水${e.water||0}`;
  $('bazi-strengths').textContent = (j.strengths||[]).length ? `亮点：${j.strengths.join('；')}` : '';

  adviceEl.textContent = j.advice || '';
}
function renderFallbackText(txt){
  $('result').style.display='block';
  pillarsEl.innerHTML=''; dmEl.textContent='';
  adviceEl.textContent = txt;
  $('bazi-elements-balance').textContent = '';
  $('bazi-strengths').textContent = '';
  Object.values(bars).forEach(el=>setBar(el,0));
  const lines = txt.split('\n').map(s=>s.trim()).filter(Boolean).slice(0,6);
  pointsEl.innerHTML = lines.map(s=>`<li>${s}</li>`).join('');
}

/* ===== 历法切换：显示/隐藏 闰月 & 提示 ===== */
const calendarSel = $('calendar');
const leapWrap = $('leapWrap');
const leapChk = $('isLeap');
const calendarHint = $('calendarHint');
calendarSel.addEventListener('change', ()=>{
  const isLunar = calendarSel.value==='lunar';
  leapWrap.style.display = isLunar ? 'inline-flex' : 'none';
  calendarHint.style.display = isLunar ? 'block' : 'none';
});

/* ===== 交互：生成八字 ===== */
$('genBtn').addEventListener('click', async ()=>{
  const err = $('error'); err.style.display='none'; err.textContent='';
  const cal = calendarSel.value;                      // 'gregorian' | 'lunar'
  const rawDate = $('birthdate').value.trim();
  const rawTime = $('birthtime').value.trim();

  if(!rawDate || !rawTime){
    err.textContent = t('need_birth'); err.style.display='block'; return;
  }

  // 规范化时间（容错 12:00 pm 等）
  const time24 = normalizeTimeTo24h(rawTime);

  // 统一得到“阳历 yyyy-mm-dd”
  let solarDateStr = '';
  try{
    if(cal==='gregorian'){
      const d = normalizeDate(rawDate);
      // 基础合法性（转数字以备显示）
      const [Y,M,D] = d.split('-').map(Number);
      if(!Y || !M || !D) throw new Error('日期无效');
      // 加一道交叉：阳->农->阳（不要求完全一致的字符串，但确保能往返）
      const l = solarlunar.solar2lunar(Y,M,D);
      const check = solarlunar.lunar2solar(l.lYear, l.lMonth, l.lDay, !!l.isLeap);
      const Y2 = check.cYear || check.year, M2 = (check.cMonth||check.month), D2 = (check.cDay||check.day);
      if(!(Y===Y2 && M===M2 && D===D2)) throw new Error('阳历往返校验失败');
      solarDateStr = d;
    }else{
      // 农历输入 -> 阳历 + 反向校验
      const d = normalizeDate(rawDate); // yyyy-mm-dd（这里 date input 已经是这个格式）
      const [y,m,day] = d.split('-').map(Number);
      const isLeap = !!leapChk.checked;
      solarDateStr = lunarToSolarChecked(y,m,day,isLeap);
    }
  }catch(e){
    err.textContent = (e && e.message) ? e.message : '日期换算失败，请检查输入（闰月/大小月）。';
    err.style.display='block';
    return;
  }

  // 清场
  $('result').style.display='none';
  pillarsEl.innerHTML=''; adviceEl.textContent=''; pointsEl.innerHTML='';
  Object.values(bars).forEach(el=>setBar(el,0));

  const langName = ({'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ms':'Bahasa Melayu'})[getLang()] || '简体中文';
  const prompt = buildPromptBaZi({
    langName,
    name: $('name').value.trim(),
    gender: $('gender').value,
    birthdate: solarDateStr, // 统一给后端阳历
    birthtime: time24
  });

  // 进度提示
  adviceEl.textContent = t('generating');

  try{
    const txt = await askAI(prompt);
    const json = safeParseJSONFromText(txt);
    $('bazi-date').textContent = `用于计算（UTC+8，阳历）：${solarDateStr} ${time24}`;
    if(json){
      renderFromJSON(json);
      const rest = txt.replace(/\{[\s\S]*\}/,'').trim();
      const bullets = rest.split('\n').map(s=>s.replace(/^[-•\s]+/,'').trim()).filter(Boolean).slice(0,6);
      pointsEl.innerHTML = bullets.map(s=>`<li>${s}</li>`).join('');
    }else{
      renderFallbackText(txt || t('retry'));
    }
  }catch(e){
    adviceEl.textContent = t('neterr');
    $('result').style.display='block';
  }
});

/* ===== 语言切换 ===== */
const sel = $('langSelect');
sel.value = getLang();
applyI18n();
sel.addEventListener('change', ()=>{ setLang(sel.value); applyI18n(); });

document.documentElement.lang = getLang();
applyI18n();

/* ========= 多 CDN 动态加载 solarlunar，保证可用 ========= */
async function ensureLunarLib(){
  if (window.solarlunar) return true;
  const cdns = [
    'https://unpkg.com/solarlunar@2.0.6/solarlunar.min.js',
    'https://cdn.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js',
    'https://fastly.jsdelivr.net/npm/solarlunar@2.0.6/solarlunar.min.js'
  ];
  for (const src of cdns){
    try{
      await new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error('load failed: '+src));
        document.head.appendChild(s);
      });
      if (window.solarlunar) return true;
    }catch(e){}
  }
  return false;
}

/* ========= 你现有的工具函数（保留） ========= */
function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str; // yyyy-mm-dd
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // dd/mm/yyyy
  if(m){ const [_, d, mo, y] = m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTimeTo24h(t){
  if(!t) return '00:00';
  const s = t.trim().toLowerCase().replace(/\s+/g,'');
  const m = s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t;
  let hh = parseInt(m[1],10), mm = parseInt(m[2]||'0',10);
  const ap = m[3];
  if(ap === 'am'){ if(hh===12) hh=0; }
  else if(ap === 'pm'){ if(hh!==12) hh+=12; }
  return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
}

/* ========= 用库时统一走这两个函数 ========= */
async function lunarToSolarChecked(y, m, d, isLeap){
  const ok = await ensureLunarLib();
  if(!ok) throw new Error('农历换算组件加载失败（网络/CDN）。请检查网络或稍后再试。');
  const s = solarlunar.lunar2solar(y, m, d, !!isLeap);
  const Y = s.cYear || s.gregorianYear || s.year;
  const M = s.cMonth || s.gregorianMonth || s.month;
  const D = s.cDay || s.gregorianDay || s.day;
  // 反向校验
  const back = solarlunar.solar2lunar(Y, M, D);
  const pass = back.lYear===y && back.lMonth===m && back.lDay===d && (!!back.isLeap)===!!isLeap;
  if(!pass) throw new Error('农历/阳历交叉校验失败：请核对闰月与日期。');
  return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
}

// 阳历往返校验（若库不可用则温和跳过，不报错）
async function solarRoundtripOrSkip(y, m, d){
  const ok = await ensureLunarLib();
  if(!ok) return true;  // 跳过，不阻塞
  const l = solarlunar.solar2lunar(y,m,d);
  const r = solarlunar.lunar2solar(l.lYear, l.lMonth, l.lDay, !!l.isLeap);
  const Y2 = r.cYear || r.year, M2 = (r.cMonth||r.month), D2 = (r.cDay||r.day);
  return (y===Y2 && m===M2 && d===D2);
}

/* ========= 接管“生成八字”按钮逻辑：稳健防错 ========= */
(function(){
  const err = document.getElementById('error');
  const calendarSel = document.getElementById('calendar');
  const leapChk = document.getElementById('isLeap');
  const genBtn = document.getElementById('genBtn');

  genBtn.addEventListener('click', async ()=>{
    err.style.display='none'; err.textContent='';
    const cal = calendarSel.value; // 'gregorian' | 'lunar'
    const rawDate = (document.getElementById('birthdate').value||'').trim();
    const rawTime = (document.getElementById('birthtime').value||'').trim();

    if(!rawDate || !rawTime){
      err.textContent = (typeof t==='function'? t('need_birth') : '请完善出生日期与时间。');
      err.style.display='block'; return;
    }

    const time24 = normalizeTimeTo24h(rawTime);
    let solarDateStr = '';

    try{
      if(cal==='gregorian'){
        const d = normalizeDate(rawDate);
        const [Y,M,D] = d.split('-').map(Number);
        if(!Y || !M || !D) throw new Error('日期无效');
        // 尝试往返校验；库不可用时自动跳过
        const ok = await solarRoundtripOrSkip(Y,M,D);
        if(!ok) throw new Error('阳历往返校验失败：请检查日期是否有效。');
        solarDateStr = d;
      }else{
        const d = normalizeDate(rawDate); // yyyy-mm-dd
        const [y,m,day] = d.split('-').map(Number);
        const isLeap = !!(leapChk && leapChk.checked);
        solarDateStr = await lunarToSolarChecked(y,m,day,isLeap);
      }
    }catch(e){
      err.textContent = e && e.message ? e.message : '日期换算失败，请检查输入（闰月/大小月）。';
      err.style.display='block';
      return;
    }

    /* ===== 以下保持你原来的调用逻辑不变 ===== */
    // 清场
    document.getElementById('result').style.display='none';
    ['bazi-pillars','bazi-advice','fate-points'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(id==='bazi-pillars') el.innerHTML='';
      else el.textContent='';
    });
    ['bar-wood','bar-fire','bar-earth','bar-metal','bar-water'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.width='0%';
    });

    const langName = ({'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ms':'Bahasa Melayu'})[
      (window.localStorage && localStorage.getItem('site_lang')) || document.documentElement.lang || 'zh-CN'
    ] || '简体中文';

    const prompt = buildPromptBaZi({
      langName,
      name: (document.getElementById('name').value||'').trim(),
      gender: document.getElementById('gender').value,
      birthdate: solarDateStr,   // 统一传阳历
      birthtime: time24
    });

    // 进度提示
    const adviceEl = document.getElementById('bazi-advice');
    adviceEl.textContent = (typeof t==='function'? t('generating') : '正在生成排盘与简评…');

    try{
      const txt = await askAI(prompt);
      const jsonMatch = txt && txt.match(/\{[\s\S]*\}/);
      const json = jsonMatch ? JSON.parse(jsonMatch[0]) : null;

      document.getElementById('bazi-date').textContent = `用于计算（UTC+8，阳历）：${solarDateStr} ${time24}`;
      if(json && typeof renderFromJSON === 'function'){
        renderFromJSON(json);
        const rest = txt.replace(/\{[\s\S]*\}/,'').trim();
        const bullets = rest.split('\n').map(s=>s.replace(/^[-•\s]+/,'').trim()).filter(Boolean).slice(0,6);
        document.getElementById('fate-points').innerHTML = bullets.map(s=>`<li>${s}</li>`).join('');
      }else if(typeof renderFallbackText === 'function'){
        renderFallbackText(txt || (typeof t==='function' ? t('retry') : '暂时无法生成，请稍后再试。'));
      }
    }catch(e){
      adviceEl.textContent = (typeof t==='function'? t('neterr') : '网络异常，请稍后再试。');
      document.getElementById('result').style.display='block';
    }
  });

  // 历法切换时显示/隐藏“闰月”提示（如果你的页面里已有此逻辑，可不重复）
  const leapWrap = document.getElementById('leapWrap');
  const calendarHint = document.getElementById('calendarHint');
  const toggleLunarUI = ()=>{
    const isLunar = calendarSel.value==='lunar';
    if(leapWrap) leapWrap.style.display = isLunar ? 'inline-flex' : 'none';
    if(calendarHint) calendarHint.style.display = isLunar ? 'block' : 'none';
  };
  calendarSel.addEventListener('change', toggleLunarUI);
  toggleLunarUI();
})();  
</script>
</body>
</html>
