<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="命理心怜空间 · 免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等，一站式灵性与命理体验。">
  <meta property="og:title" content="命理心怜空间 · Soul Sanctuary">
  <meta property="og:description" content="免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等。">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dCC; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4; --muted:#9aa3b2;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22); --radius:14px;
  }
    html,body{height:100%} 
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} } 
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6}
.container{max-width:1060px;margin:0 auto;padding:24px 16px 64px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
.h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
.h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
.muted{color:var(--muted)}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
.bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
.badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
#gpt-drawer { display:block !important; }
#gpt-drawer[hidden] { display:block !important; }
#gpt-drawer > summary { display:block; cursor:pointer; }
   /* 语言选择器 */
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{color:var(--muted); font-size:.9rem}
  .lang select{
    appearance:none; border-radius:10px; border:1px solid #243244; background:#0e1520; color:var(--text);
    padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== 按钮统一成高端亮金 ===== */
  .btn,
  .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:13px 16px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:600; letter-spacing:.3px;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover,
  .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Ghost 按钮保持辅助风格 */
  .btn.ghost{
    background:transparent; color:var(--gold2);
    border:1px solid rgba(212,175,55,.45); box-shadow:none;
  }

  /* block 按钮 */
  .btn.block {
    display: block;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .row.one .btn.block { display: block !important; }
  .panel .body .btn.block { margin-left:auto; margin-right:auto; }

  /* Chat 浮窗按钮也换成亮金 */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== 无障碍隐藏文字 ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
  .astro-auth{ max-width: 980px; margin: 28px auto; padding: 20px 18px;
    background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
    border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 18px 50px rgba(0,0,0,.35); }
  .auth-grid{ display:grid; gap:18px; grid-template-columns: 1.2fr .8fr; }
  @media (max-width: 860px){ .auth-grid{ grid-template-columns: 1fr; } }
  .panel{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35); }
  .panel .head{ padding:16px 18px; border-bottom:1px solid var(--border);
    color:var(--gold); font-weight:700; letter-spacing:.3px; }
  .panel .body{ padding:18px; }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row.one{ grid-template-columns: 1fr; }
  .row.center{ align-items:center; }
  @media (max-width:640px){ .row{ grid-template-columns: 1fr; } }
  .astro-auth input[type="email"], .astro-auth input[type="password"]{
    width:100%; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:10px;
    padding:13px 12px; outline:none; transition:.18s;
  }
  .astro-auth input:focus{ border-color:var(--gold2); box-shadow:0 0 0 3px rgba(212,175,55,.2); }
  .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
  .error{ color:#ffb4b4; background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25);
          padding:10px 12px; border-radius:10px; }
  .spacer{ height:12px; }
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">命理供门 · 八字简评</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender"><option value="">不透露</option><option value="male">男性</option><option value="female">女性</option></select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar"><option value="gregorian">阳历 / Gregorian</option><option value="lunar">农历 / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> 出生时间不详</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

      <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

<!-- 登录/注册表单，支持回车提交 -->
<section class="astro-auth">
  <div class="auth-grid">
    <!-- 左侧：输入 + 注册/登录 -->
    <div class="panel">
      <div class="head">账户登录 / 注册</div>
      <div class="body">
        <!-- 独立输入区（登录/注册共享这些输入） -->
        <div class="row" id="authFields">
          <label for="email" class="sr-only">Email</label>
          <input
            id="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            placeholder="邮箱 Email"
            data-i18n-ph="ph_email"
            required
          />

          <input
            id="password"
            type="password"
            autocomplete="new-password"
            placeholder="密码 Password（至少8位，含大小写数字符号）"
            data-i18n-ph="ph_password"
            required
           />
        </div>

        <div class="spacer"></div>

        <!-- 登录表单（复用上方两格输入） -->
        <form id="loginForm" class="row one">
          <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
        </form>

        <div class="spacer"></div>

        <!-- 重设密码（按钮非提交） -->
        <div class="row one">
          <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
        </div>

        <div class="spacer"></div>

        <!-- 注册表单（复用上方两格输入） -->
        <form class="row one" id="registerForm">
          <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
        
        <div class="muted" data-i18n="note_price">
        注册账号赠送一次免费体验
        </div>  

        <div class="spacer"></div>

        <div class="error" id="error" style="display:none"></div>
      </div>
    </div>
    </form>
    
    <!-- 右侧：会员与返回 -->
    <div class="panel">
      <div class="head">会员服务</div>
      <div class="body">
        <div class="row one">
          <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
        </div>

        <div class="spacer"></div>

        <div class="row one">
          <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
        </div>

        <div class="spacer"></div>
        <div class="muted" data-i18n="note_price1">
          $9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）
        </div>
      </div>
    </div>
  </div>
</section>

  <footer>© 5XLiving • Astro Sanctuary</footer>

  <!-- 功能脚本：后端代理 + 多语言 + Chat 浮窗 -->
<script>
  // ============== 统一配置（你的 Worker 域名） ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers.dev

  // 工具函数
  const $ = id => document.getElementById(id);
  function showErr(msg){ const e=$("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }

  // ============== 多语言 ==============
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }

  // （保留你原来的翻译表，我这里是完整一份，包含 chat_fab/chat_placeholder/chat_send）
  const translations = {
    "zh-CN": {
      page_title:"命理心怜空间 · Index",
      site_title:"命理心怜空间 · Soul Sanctuary",
      site_subtitle:"免费体验 & 会员专区 · 统一风格版",
      lang_label:"语言",
      free_title:"🌀 免费体验区 Free Segment",
      link_bazi:"八字命理分析", link_natal:"本命星盘分析", link_life:"灵数分析",
      link_tarot:"塔罗指引分析", link_kyuusei:"九星气学分析", link_energy:"能量类型分析", link_vedic:"印度命理吠陀占星",
      vip_title:"🌙 会员区域 VIP Segment",
      vip_mingli:"🗝 命理空间专属内容",
      vip_love:"姻缘方向：恋爱缘分、婚姻走势",
      vip_career:"事业方向：职场发展、创业潜力",
      vip_wealth:"财运方向：财位分析、理财时机",
      vip_pet:"宠物命理：伴侣动物的性格与缘分",
      vip_hepan:"合盘分析：婚期择日、新生择时",
      vip_name:"测名分析：公司名、宝宝名、命名改运",
      vip_fengshui:"财位合盘：住家 / 办公室动线配合",
      vip_xinlian:"🌙 心怜空间专属内容",
      vip_record:"灵性记录：照片、梦境、声音、愿望祈祷",
      vip_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
      vip_memorial:"家族纪念系统：亲人灵性纪念 & 延续",
      vip_tasks:"每周能量练习 / 神明仪式任务",
      vip_shop:"能量商城专属折扣 & 御守订制",
      login_title:"💎 登入 VIP 功能",
      ph_email:"邮箱 Email",
      ph_password:"密码 Password（至少8位，含大小写数字符号）",
      btn_register:"注册账户",
      btn_login:"登入账户",
      btn_upgrade:"💎 升级为 VIP（月费）",
      btn_backshop:"← 返回命理商城",
      btn_reset:"🔑 重设密码",
      note_price:"注册账号赠送一次免费体验",
      note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
      err_need_ep:"请输入邮箱与密码",
      err_pwd_rule:"密码至少8位，需包含大写/小写/数字/特殊符号",
      err_exists:"此邮箱已注册，请直接登入",
      err_register_fail:"注册失败：",
      err_no_account:"账户不存在，请先注册",
      err_wrong_pwd:"密码错误",
      err_expired:"会员已过期，请续费",
      err_login_fail:"登入失败：",
      prompt_email:"请输入注册邮箱：",
      err_email_empty:"邮箱不能为空",
      prompt_newpwd:"请输入新密码（至少8位，含大小写、数字、符号）：",
      err_pwd_empty:"密码不能为空",
      err_reset_fail:"重设失败：",
      msg_reset_ok:"密码已成功更新，请用新密码重新登入。",
      chat_fab:"问", chat_placeholder:"请问您想了解什么？（如：如何开始免费体验）", chat_send:"发送"
    },
    "zh-TW": {
      page_title:"命理心憐空間 · Index",
      site_title:"命理心憐空間 · Soul Sanctuary",
      site_subtitle:"免費體驗 & 會員專區 · 統一風格版",
      lang_label:"語言",
      free_title:"🌀 免費體驗區 Free Segment",
      link_bazi:"八字命理分析", link_natal:"本命星盤分析", link_life:"靈數分析",
      link_tarot:"塔羅指引分析", link_kyuusei:"九星氣學分析", link_energy:"能量類型分析", link_vedic:"印度命理吠陀占星",
      vip_title:"🌙 會員區域 VIP Segment",
      vip_mingli:"🗝 命理空間專屬內容",
      vip_love:"姻緣方向：戀愛緣分、婚姻走勢",
      vip_career:"事業方向：職場發展、創業潛力",
      vip_wealth:"財運方向：財位分析、理財時機",
      vip_pet:"寵物命理：伴侶動物的性格與緣分",
      vip_hepan:"合盤分析：婚期擇日、新生擇時",
      vip_name:"測名分析：公司名、寶寶名、命名改運",
      vip_fengshui:"財位合盤：住家 / 辦公室動線配合",
      vip_xinlian:"🌙 心憐空間專屬內容",
      vip_record:"靈性記錄：照片、夢境、聲音、願望祈禱",
      vip_course:"命理課程：八字 / 塔羅 / 占星 / 靈數 / 人類圖",
      vip_memorial:"家族紀念系統：親人靈性紀念 & 延續",
      vip_tasks:"每週能量練習 / 神明儀式任務",
      vip_shop:"能量商城專屬折扣 & 御守訂製",
      login_title:"💎 登入 VIP 功能",
      ph_email:"電子郵件 Email",
      ph_password:"密碼 Password（至少8位，含大小寫數字符號）",
      btn_register:"註冊帳戶", btn_login:"登入帳戶",
      btn_upgrade:"💎 升級為 VIP（月費）", btn_backshop:"← 返回命理商城",
      btn_reset:"🔑 重設密碼",
      note_price:"註冊贈一次免費體驗",
      note_price1:"$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）",
      err_need_ep:"請輸入電子郵件與密碼",
      err_pwd_rule:"密碼至少8位，需包含大小寫/數字/特殊符號",
      err_exists:"此郵箱已註冊，請直接登入",
      err_register_fail:"註冊失敗：",
      err_no_account:"帳戶不存在，請先註冊",
      err_wrong_pwd:"密碼錯誤",
      err_expired:"會員已過期，請續費",
      err_login_fail:"登入失敗：",
      prompt_email:"請輸入註冊郵箱：",
      err_email_empty:"郵箱不能為空",
      prompt_newpwd:"請輸入新密碼（至少8位，含大小寫、數字、符號）：",
      err_pwd_empty:"密碼不能為空",
      err_reset_fail:"重設失敗：",
      msg_reset_ok:"密碼已成功更新，請用新密碼重新登入。",
      chat_fab:"問", chat_placeholder:"想了解什麼？（例如：如何開始免費體驗）", chat_send:"發送"
    },
    "en": {
      page_title:"Soul Sanctuary · Index",
      site_title:"Soul Sanctuary",
      site_subtitle:"Free Segment & VIP Area · Unified Style",
      lang_label:"Language",
      free_title:"🌀 Free Segment",
      link_bazi:"Bazi Reading", link_natal:"Natal Chart", link_life:"Numerology",
      link_tarot:"Tarot Guidance", link_kyuusei:"Nine Star Ki", link_energy:"Energy Type", link_vedic:"Vedic Astrology",
      vip_title:"🌙 VIP Segment",
      vip_mingli:"🗝 Astro Sanctuary · Exclusive",
      vip_love:"Love: Dating Fate, Marriage Trend",
      vip_career:"Career: Workplace, Entrepreneurship",
      vip_wealth:"Wealth: Wealth Position, Timing",
      vip_pet:"Pet Destiny: Temperament & Bond",
      vip_hepan:"Synastry: Wedding Dates, Birthtime",
      vip_name:"Name Reading: Company/Baby/Renaming",
      vip_fengshui:"Wealth & Layout: Home / Office",
      vip_xinlian:"🌙 Soul Sanctuary · Exclusive",
      vip_record:"Spiritual Logs: Photos, Dreams, Voice, Prayers",
      vip_course:"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family Memorial: Spiritual Archive & Legacy",
      vip_tasks:"Weekly Energy Practices / Divine Ritual Tasks",
      vip_shop:"Store Discounts & Omamori",
      login_title:"💎 VIP Login",
      ph_email:"Email",
      ph_password:"Password (8+ chars, upper/lower/digit/symbol)",
      btn_register:"Create Account", btn_login:"Log in",
      btn_upgrade:"💎 Upgrade to VIP (Monthly)", btn_backshop:"← Back to Store",
      btn_reset:"🔑 Reset Password",
      note_price:"New account gets one free trial.",
      note_price1:"$9.9 / month · VIP (Astro + Soul + Courses)",
      err_need_ep:"Enter email and password",
      err_pwd_rule:"Password must be 8+ and include upper/lowercase, number, symbol",
      err_exists:"Email already registered. Please log in.",
      err_register_fail:"Registration failed: ",
      err_no_account:"Account not found. Please register first.",
      err_wrong_pwd:"Incorrect password",
      err_expired:"Membership expired. Please renew.",
      err_login_fail:"Login failed: ",
      prompt_email:"Enter your registered email:",
      err_email_empty:"Email cannot be empty",
      prompt_newpwd:"Enter a new password (8+, upper/lower/digit/symbol):",
      err_pwd_empty:"Password cannot be empty",
      err_reset_fail:"Reset failed: ",
      msg_reset_ok:"Password updated. Please log in with the new one.",
      chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., how to start the free trial)", chat_send:"Send"
    },
    "ja": {
      page_title:"ソウル・サンクチュアリ · Index",
      site_title:"ソウル・サンクチュアリ",
      site_subtitle:"無料体験 & VIP · 統一デザイン",
      lang_label:"言語",
      free_title:"🌀 無料体験ゾーン",
      link_bazi:"四柱推命", link_natal:"ネイタルチャート", link_life:"数秘術",
      link_tarot:"タロット", link_kyuusei:"九星気学", link_energy:"エネルギータイプ", link_vedic:"ヴェーディック占星術",
      vip_title:"🌙 VIP セグメント",
      vip_mingli:"🗝 命理エリア · 限定",
      vip_love:"縁結び：恋愛・結婚の流れ",
      vip_career:"仕事：職場・起業ポテンシャル",
      vip_wealth:"金運：財位・タイミング",
      vip_pet:"ペット命理：性格とご縁",
      vip_hepan:"相性：結婚日・出産時刻",
      vip_name:"命名：会社名・赤ちゃん名・改名",
      vip_fengshui:"財位×レイアウト：住宅 / オフィス",
      vip_xinlian:"🌙 心怜エリア · 限定",
      vip_record:"スピリチュアル記録：写真/夢/音声/祈り",
      vip_course:"講座：四柱/タロット/占星/数秘/HD",
      vip_memorial:"家族メモリアル：霊的記録と継承",
      vip_tasks:"毎週エナジー練習 / 儀式タスク",
      vip_shop:"ストア割引 & お守り",
      login_title:"💎 VIP ログイン",
      ph_email:"メール",
      ph_password:"パスワード（8文字以上、大小英字・数字・記号）",
      btn_register:"アカウント作成", btn_login:"ログイン",
      btn_upgrade:"💎 VIPにアップグレード（月額）", btn_backshop:"← ストアへ戻る",
      btn_reset:"🔑 パスワード再設定",
      note_price:"新規登録は1回無料体験。",
      note_price1:"$9.9/月（命理 + 心怜 + 講座）",
      err_need_ep:"メールとパスワードを入力してください",
      err_pwd_rule:"パスワードは8文字以上で、大小英字・数字・記号を含めてください",
      err_exists:"このメールは登録済みです。ログインしてください。",
      err_register_fail:"登録失敗：",
      err_no_account:"アカウントが見つかりません。先に登録してください。",
      err_wrong_pwd:"パスワードが違います",
      err_expired:"会員期限切れ。更新してください。",
      err_login_fail:"ログイン失敗：",
      prompt_email:"登録メールを入力してください：",
      err_email_empty:"メールは必須です",
      prompt_newpwd:"新しいパスワードを入力（8文字以上、大小英字・数字・記号）：",
      err_pwd_empty:"パスワードは必須です",
      err_reset_fail:"再設定失敗：",
      msg_reset_ok:"パスワードを更新しました。新しいパスワードでログインしてください。",
      chat_fab:"問", chat_placeholder:"何を知りたいですか？（例：無料体験の始め方）", chat_send:"送信"
    },
    "th": {
      page_title:"Soul Sanctuary · หน้าแรก",
      site_title:"Soul Sanctuary",
      site_subtitle:"ใช้งานฟรี & พื้นที่ VIP · สไตล์เดียวกัน",
      lang_label:"ภาษา",
      free_title:"🌀 พื้นที่ทดลองใช้ฟรี",
      link_bazi:"ดวงจีน (Bazi)", link_natal:"ดวงกำเนิด", link_life:"ตัวเลขชีวิต",
      link_tarot:"ไพ่ทาโรต์", link_kyuusei:"เก้าดาวคิวเซ", link_energy:"ประเภทพลังงาน", link_vedic:"โหราศาสตร์เวท",
      vip_title:"🌙 พื้นที่ VIP",
      vip_mingli:"🗝 เนื้อหาพิเศษ · Astro",
      vip_love:"ความรัก: คู่แท้/แนวโน้มแต่งงาน",
      vip_career:"การงาน: ที่ทำงาน/ศักยภาพธุรกิจ",
      vip_wealth:"การเงิน: จุดโชคลาภ/จังหวะลงทุน",
      vip_pet:"ดวงสัตว์เลี้ยง: นิสัย & สายใย",
      vip_hepan:"ความเข้ากันได้: วันแต่ง/เวลาคลอด",
      vip_name:"ตั้งชื่อ: บริษัท/ทารก/เปลี่ยนชื่อ",
      vip_fengshui:"ฮวงจุ้ยการเงิน: บ้าน / สำนักงาน",
      vip_xinlian:"🌙 เนื้อหาเฉพาะ · Soul",
      vip_record:"บันทึกจิตวิญญาณ: รูป/ความฝัน/เสียง/คำอธิษฐาน",
      vip_course:"คอร์ส: Bazi / Tarot / Astrology / Numerology / HD",
      vip_memorial:"อนุสรณ์ครอบครัว: บันทึกวิญญาณ & สืบสาน",
      vip_tasks:"ฝึกพลังงานรายสัปดาห์ / พิธีกรรม",
      vip_shop:"ส่วนลดร้านค้า & Omamori",
      login_title:"💎 เข้าสู่ระบบ VIP",
      ph_email:"อีเมล",
      ph_password:"รหัสผ่าน (8+ ตัวอักษร มีพิมพ์เล็ก/ใหญ่ ตัวเลขและสัญลักษณ์)",
      btn_register:"สมัครบัญชี", btn_login:"เข้าสู่ระบบ",
      btn_upgrade:"💎 อัปเกรด VIP (รายเดือน)", btn_backshop:"← กลับร้านค้า",
      btn_reset:"🔑 รีเซ็ตรหัสผ่าน",
      note_price:"สมัครใหม่ใช้ฟรี 1 ครั้ง",
      note_price1:"$9.9 / เดือน (Astro + Soul + คอร์ส)",
      err_need_ep:"กรอกอีเมลและรหัสผ่าน",
      err_pwd_rule:"รหัสผ่านต้อง 8+ ตัวอักษร และมีพิมพ์เล็ก/ใหญ่ ตัวเลข สัญลักษณ์",
      err_exists:"อีเมลนี้มีบัญชีแล้ว กรุณาเข้าสู่ระบบ",
      err_register_fail:"สมัครไม่สำเร็จ: ",
      err_no_account:"ไม่พบบัญชี กรุณาสมัครก่อน",
      err_wrong_pwd:"รหัสผ่านไม่ถูกต้อง",
      err_expired:"สมาชิกหมดอายุ กรุณาต่ออายุ",
      err_login_fail:"เข้าสู่ระบบล้มเหลว: ",
      prompt_email:"กรอกอีเมลที่สมัคร:",
      err_email_empty:"อีเมลห้ามว่าง",
      prompt_newpwd:"กรอกรหัสใหม่ (8+, มีพิมพ์เล็ก/ใหญ่ ตัวเลข สัญลักษณ์):",
      err_pwd_empty:"รหัสผ่านห้ามว่าง",
      err_reset_fail:"รีเซ็ตล้มเหลว: ",
      msg_reset_ok:"อัปเดตรหัสผ่านแล้ว โปรดเข้าสู่ระบบด้วยรหัสใหม่",
      chat_fab:"ถาม", chat_placeholder:"อยากรู้อะไร (เช่น เริ่มทดลองฟรีอย่างไร)", chat_send:"ส่ง"
    },
    "ms": {
      page_title:"Soul Sanctuary · Indeks",
      site_title:"Soul Sanctuary",
      site_subtitle:"Segmen Percuma & VIP · Gaya Bersatu",
      lang_label:"Bahasa",
      free_title:"🌀 Segmen Percuma",
      link_bazi:"Bazi", link_natal:"Carta Kelahiran", link_life:"Numerologi",
      link_tarot:"Tarot", link_kyuusei:"Nine Star Ki", link_energy:"Jenis Tenaga", link_vedic:"Astrologi Veda",
      vip_title:"🌙 Segmen VIP",
      vip_mingli:"🗝 Kandungan Eksklusif · Astro",
      vip_love:"Cinta: Jodoh/Lalu lintas perkahwinan",
      vip_career:"Kerjaya: Tempat kerja/Usahawan",
      vip_wealth:"Kewangan: Posisi kekayaan/Masa",
      vip_pet:"Nasib Haiwan: Perangai & Ikatan",
      vip_hepan:"Keserasian: Tarikh nikah/Waktu lahir",
      vip_name:"Nama: Syarikat/Bayi/Pertukaran nama",
      vip_fengshui:"Feng Shui Kekayaan: Rumah / Pejabat",
      vip_xinlian:"🌙 Kandungan Eksklusif · Soul",
      vip_record:"Log Spirit: Foto, Mimpi, Suara, Doa",
      vip_course:"Kursus: Bazi / Tarot / Astrologi / Numerologi / HD",
      vip_memorial:"Memorial Keluarga: Arkib & Legasi",
      vip_tasks:"Latihan Tenaga Mingguan / Ritual",
      vip_shop:"Diskaun Kedai & Omamori",
      login_title:"💎 Log Masuk VIP",
      ph_email:"Emel",
      ph_password:"Kata laluan (8+ aksara, huruf besar/kecil, nombor, simbol)",
      btn_register:"Daftar Akaun", btn_login:"Log Masuk",
      btn_upgrade:"💎 Naik Taraf VIP (Bulanan)", btn_backshop:"← Kembali ke Kedai",
      btn_reset:"🔑 Tetap Semula Kata Laluan",
      note_price:"Akaun baharu percubaan percuma sekali.",
      note_price1:"$9.9 / bulan (Astro + Soul + Kursus).",
      err_need_ep:"Masukkan emel dan kata laluan",
      err_pwd_rule:"Kata laluan mesti 8+ dan ada huruf besar/kecil, nombor, simbol",
      err_exists:"Emel telah didaftarkan. Sila log masuk.",
      err_register_fail:"Pendaftaran gagal: ",
      err_no_account:"Akaun tidak ditemui. Sila daftar dahulu.",
      err_wrong_pwd:"Kata laluan salah",
      err_expired:"Keahlian tamat tempoh. Sila perbaharui.",
      err_login_fail:"Log masuk gagal: ",
      prompt_email:"Masukkan emel berdaftar:",
      err_email_empty:"Emel tidak boleh kosong",
      prompt_newpwd:"Masukkan kata laluan baharu (8+, huruf besar/kecil, nombor, simbol):",
      err_pwd_empty:"Kata laluan tidak boleh kosong",
      err_reset_fail:"Tetap semula gagal: ",
      msg_reset_ok:"Kata laluan dikemas kini. Sila log masuk semula.",
      chat_fab:"Tanya", chat_placeholder:"Anda mahu tahu apa? (cth: cara mula percubaan)", chat_send:"Hantar"
    }
  };

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  // ============== Chat 浮窗（走 /api/chat） ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

// ======================= 八字计算器（不改算法） =======================
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS   = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC           = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year) {
    const s = (year - 4) % 10, b = (year - 4) % 12;
    return { stem: this.HEAVENLY_STEMS[(s+10)%10], branch: this.EARTHLY_BRANCHES[(b+12)%12], zodiac: this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y, m, d) {
    const mmdd = m*100 + d;
    const gates = [[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx = 11; for (const [thr,val] of gates) if (mmdd >= thr) idx = val;
    const branchBy = {1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
    return { index: idx, branch: branchBy[idx] };
  }
  calculateMonthPillar(year, month, day) {
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx  = (startMap[yStemIdx] + (index - 1)) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(year, month, day) {
    const baseUTC   = Date.UTC(1900, 0, 31); // 甲辰（辰=4）
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff   = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx   = (0 + dayDiff) % 10;    // 甲=0
    const branchIdx = (4 + dayDiff) % 12;    // 辰=4
    return { stem: this.HEAVENLY_STEMS[(stemIdx+10)%10], branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour) {
    const branchMap = {23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
    const startMap  = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; // 日干→子时起干
    const dayIdx    = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx   = (startMap[dayIdx] + hourIndex) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch: branchMap[hour] };
  }
  getElement(stem, branch) {
    const s = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
    const b = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    return `${s[stem]}${b[branch]}`;
  }
  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem), bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si*2 + bi) % this.NAYIN.length];
  }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP  = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP   = this.calculateDayPillar(year, month, day);
    const hourP  = timeUnknown ? {stem:'？', branch:'？'} : this.calculateHourPillar(dayP.stem, hour);
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = { year:yearP, month:monthP, day:{...dayP, element:dayElement}, hour:hourP };

    const cnt = {木:0,火:0,土:0,金:0,水:0};
    const list = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    list.forEach(p => {
      if (p.stem   && p.stem   !== '？') cnt[this.getStemElement(p.stem)]   += 1;
      if (p.branch && p.branch !== '？') cnt[this.getBranchElement(p.branch)] += 1;
    });
    const total = Object.values(cnt).reduce((a,b)=>a+b,0) || 1;
    const pct = { wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}
window.baziCalculator = window.baziCalculator || new BaziCalculator();


// ======================= 心怜管家（渲染器） =======================
class XinLianAssistant {
  constructor(){ this.currentContext=null; }
  generateAnalysis(baziData){
    this.currentContext = baziData;
    const a = document.getElementById('assistant-analysis');
    const b = document.getElementById('assistant-advice');
    if (a) a.innerHTML = this.analyzeBazi(baziData);
    if (b) b.innerHTML = this.generateAdvice(baziData);
  }
  analyzeBazi({dayMaster, elements, strength, season, timeUnknown}){
    const timeNote = timeUnknown
      ? '<li><strong>注意：</strong>已勾选“出生时间不详”，本页分析<strong>未纳入时柱</strong>（准确度会略降；补充具体时间可更精准）。</li>'
      : '';
    return `
      <ul class="ul">
        <li>您的日主为 <strong>${dayMaster.stem}（${dayMaster.element}）</strong></li>
        <li>命局整体<strong>${strength.mark}</strong>，${this.getStrengthDescription(strength.mark)}</li>
        <li>出生于<strong>${season}</strong>季，${this.getSeasonInfluence(season)}</li>
        <li>五行分布：${this.getElementDistribution(elements)}</li>
        ${timeNote}
      </ul>`;
  }
  generateAdvice({strength, useful, timeUnknown}){
    const timeWarn = timeUnknown ? '<li><strong>提示：</strong>无时柱，建议仅作参考。</li>' : '';
    return `
      <ul class="ul">
        <li><strong>发展策略：</strong>${strength.focus}</li>
        <li><strong>喜用元素：</strong>${(useful.useful||[]).join('、')}</li>
        <li><strong>幸运颜色：</strong>${this.getLuckyColors(useful.useful||[])}</li>
        <li><strong>适合方位：</strong>${this.getLuckyDirections(useful.useful||[])}</li>
        ${timeWarn}
      </ul>`;
  }
  getStrengthDescription(m){ return {偏强:'潜力足、抗压好',偏弱:'需外援更能发挥',平衡:'各面均衡、适应性强'}[m]||'具有独特特点'; }
  getSeasonInfluence(season){ const m={春:'木旺生发',夏:'火旺外放',秋:'金旺收敛',冬:'水旺内藏'}; return m[season]||'季节对命局有一定影响'; }
  getLuckyColors(list){ const m={木:'绿色/青色',火:'红色/紫色',土:'黄色/棕色',金:'白色/金色',水:'黑色/蓝色'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
  getLuckyDirections(list){ const m={木:'东方',火:'南方',土:'中央/东北/西南',金:'西方',水:'北方'}; return list.map(x=>m[x]).filter(Boolean).join('、'); }
  ELABEL(){ return {wood:'木', fire:'火', earth:'土', metal:'金', water:'水'}; }
  getElementDistribution(elements) {
    const L = this.ELABEL();
    return Object.entries(elements)
      .sort((a,b) => b[1] - a[1])
      .map(([k,v]) => `${L[k]||k}${Math.round(v)}%`)
      .join('、');
  }
  getStrongestElement(elements){
    const L = this.ELABEL();
    const [k] = Object.entries(elements).reduce((a,b)=> a[1]>b[1]?a:b);
    return L[k] || k;
  }
  getWeakestElement(elements){
    const L = this.ELABEL();
    const [k] = Object.entries(elements).reduce((a,b)=> a[1]<b[1]?a:b);
    return L[k] || k;
  }
  getWealthAdvice(){
    const { elements = {}, useful = { useful: [] }, timeUnknown } = this.currentContext || {};
    const strong = this.getStrongestElement(elements);
    const weak   = this.getWeakestElement(elements);
    const isGood = (strong === '金' || strong === '土');
    const list   = Array.isArray(useful.useful) ? useful.useful.join('、') : '';
    const note   = timeUnknown ? ' 由于时柱信息不完整，财运分析可能不够精确。' : '';
    return `您的财运${isGood ? '较佳' : '需努力'}。建议加强${list}元素的运用，避免${weak}相关的高风险投资。${note}`;
  }
  getHealthAdvice(){
    const { elements = {}, timeUnknown } = this.currentContext || {};
    const weak = this.getWeakestElement(elements);
    const healthMap = {木:'肝胆、眼睛',火:'心脏、血液循环',土:'脾胃、消化系统',金:'肺、呼吸系统',水:'肾、泌尿系统'};
    const part = healthMap[weak] || '整体作息';
    const note = timeUnknown ? ' 健康分析基于现有信息，建议结合实际情况。' : '';
    return `健康方面需特别注意${part}的保养。建议定期体检，保持规律作息。${note}`;
  }
  showActionResponse(action, response){
    const messageDiv = document.createElement('div');
    messageDiv.className = 'assistant-message';
    messageDiv.innerHTML = `
      <p><strong>${this.getActionTitle(action)}：</strong>${response}</p>
      <p class="muted" style="margin-top:10px;font-size:.9em;">
        💡 想要更精准的指导？<a href="#" style="color: var(--gold2);">升级VIP获取专属分析</a>
      </p>`;
    let container = document.querySelector('.assistant-container');
    if (!container){
      container = document.createElement('div');
      container.className = 'assistant-container';
      (document.getElementById('result') || document.body).appendChild(container);
    }
    const hook = container.querySelector('.vip-promo');
    hook && hook.parentNode===container ? container.insertBefore(messageDiv, hook) : container.appendChild(messageDiv);
    messageDiv.scrollIntoView({behavior:'smooth'});
  }
  getActionTitle(action){
    const t = {career:'事业建议', wealth:'财运分析', relationship:'感情指导', health:'健康提醒', lucky:'幸运方向'};
    return t[action] || '专业建议';
  }
}
const assistant = new XinLianAssistant();

// ======================= 工具 & 规则函数 =======================
function $(id){ return document.getElementById(id); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH = {寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl = STEM_ELEM[dayGan]; const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  let score = 0;
  if ((season==='春' && '木火'.includes(dmEl)) || (season==='夏' && '火土'.includes(dmEl)) || (season==='秋' && dmEl==='金') || (season==='冬' && dmEl==='水')) score += 2;
  score += (cnt[dmEl]||0) * 1.2;
  const mark  = score >= 3 ? '偏强' : (score <= 1 ? '偏弱' : '平衡');
  const focus = mark==='偏强' ? '泄秀/制化' : (mark==='偏弱' ? '补助/顺势' : '守中/调和');
  return {season, mark, focus};
}
function chooseUseful(strength, dmElem){
  if (strength==='偏强'){
    return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]};
  }else if (strength==='偏弱'){
    return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]};
  }
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}
function renderPillars(root, p, timeUnknown=false){
  if (!root) return;
  root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱' && timeUnknown);
    const stem = u?'？':v.stem, branch=u?'？':v.branch;
    const div = document.createElement('div');
    div.className='pillar';
    div.innerHTML = `<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p, timeUnknown){
  const ge = (s,b)=> baziCalculator.getElement(s,b);
  const ny = (s,b)=> baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem);   setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem);     setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem);
  setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf = (id,val)=>{ const el=$(id); if(el) el.textContent = val; };
  setIf('year-element',  ge(p.year.stem,  p.year.branch));
  setIf('month-element', ge(p.month.stem, p.month.branch));
  setIf('day-element',   ge(p.day.stem,   p.day.branch));
  setIf('hour-element',  timeUnknown?'未知':ge(p.hour.stem, p.hour.branch));
  setIf('year-nayin',  ny(p.year.stem,  p.year.branch));
  setIf('month-nayin', ny(p.month.stem, p.month.branch));
  setIf('day-nayin',   ny(p.day.stem,   p.day.branch));
  setIf('hour-nayin',  timeUnknown?'未知':ny(p.hour.stem, p.hour.branch));
}
function showError(msg){
  const el = $('error'); if(!el) return;
  el.textContent = msg; el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 5000);
}
function ensureAssistantSlots(){
  if (document.getElementById('assistant-analysis')) return;
  const host = document.querySelector('.assistant-container') || document.getElementById('result') || document.body;
  const wrap = document.createElement('div'); wrap.className = 'assistant-container';
  const a = document.createElement('div'); a.id = 'assistant-analysis';
  const b = document.createElement('div'); b.id = 'assistant-advice';
  wrap.append(a, b); host.appendChild(wrap);
}

// ======================= 免费报告（文本模块） =======================
function buildFreeReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'木', fire:'火', earth:'土', metal:'金', water:'水'};
  const entries = Object.entries(percents);
  const strongestK = entries.reduce((a,b)=> a[1]>b[1]?a:b)[0];
  const weakestK   = entries.reduce((a,b)=> a[1]<b[1]?a:b)[0];
  const strongest  = L[strongestK], weakest = L[weakestK];
  const absents = Object.keys(percents).filter(k => Math.round(percents[k])===0).map(k=>L[k]).join('、');
  const fmt = k => `${L[k]} ${Math.round(percents[k])}%`;
  const line = ['wood','fire','earth','metal','water'].map(fmt).join('　');
  const fav  = (adv?.useful||[]).join('、');
  const avoid= (adv?.avoid||[]).join('、') || '—';
  const hourTxt = timeUnknown ? '？？' : (pillars.hour.stem + pillars.hour.branch);
  return `
    <div class="xl-card" style="margin-top:12px; padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px; color:var(--brand)">免费报告</h3>
      <p style="margin:6px 0;">四柱：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">日主：<strong>${pillars.day.stem}</strong>（<strong>${pillars.day.element}</strong>）｜季节：<strong>${st.season||'-'}</strong>｜命局：<strong>${st.mark}</strong> · <strong>${st.focus}</strong></p>
      <p style="margin:8px 0;">五行：${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>偏旺；<strong>${weakest}</strong>偏弱。${absents?`<span style="color:var(--muted)">（缺：${absents}）</span>`:''}</p>
      <ul style="margin:6px 0 0 18px; line-height:1.6">
        <li>喜用优先：<strong>${fav||'—'}</strong>；忌讳：${avoid}</li>
        <li>调衡要点：${st.focus}</li>
      </ul>
      ${timeUnknown?`<p style="margin:6px 0 0; color:var(--muted)">提示：时间不详，时柱未纳入。</p>`:''}
    </div>
  `;
}

// ======================= 富内容报告（章节化） =======================
function buildRichReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'木', fire:'火', earth:'土', metal:'金', water:'水'};
  const P = pillars;
  const line = ['wood','fire','earth','metal','water'].map(k => `${L[k]}${Math.round(percents[k]||0)}%`).join(' ');
  const entries = Object.entries(percents);
  const strongestK = entries.reduce((a,b)=> (a[1]>b[1]?a:b), ['wood',0])[0];
  const weakestK   = entries.reduce((a,b)=> (a[1]<b[1]?a:b), ['wood',0])[0];
  const strongest  = L[strongestK]||'—';
  const weakest    = L[weakestK]||'—';
  const absents = Object.keys(percents).filter(k => Math.round(percents[k]||0)===0).map(k=>L[k]).join('、');
  const favList   = (adv?.useful||[]).join('、') || '—';
  const avoidList = (adv?.avoid||[]).join('、') || '—';
  const hourTxt   = timeUnknown ? '？？' : (P.hour.stem + P.hour.branch);

  return `
  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">一、命盘总览</h3>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; font-size:14px;">
      <div>四柱：<strong>${P.year.stem}${P.year.branch} ${P.month.stem}${P.month.branch} ${P.day.stem}${P.day.branch} ${hourTxt}</strong></div>
      <div>日主：<strong>${P.day.stem}</strong>（<strong>${P.day.element}</strong>）</div>
      <div>季节：<strong>${st.season||'-'}</strong></div>
      <div>命局：<strong>${st.mark}</strong> · 策略：<strong>${st.focus}</strong></div>
    </div>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">二、五行能量分析</h3>
    <div style="font-size:14px;">${line}</div>
    <p style="margin:10px 0 0;">
      <strong>${strongest}</strong>偏旺；<strong>${weakest}</strong>偏弱。
      ${absents ? `<span class="muted" style="color:var(--muted)">（缺：${absents}）</span>` : ``}
    </p>
    <ul style="margin:10px 0 0 18px; line-height:1.6">
      <li>喜用优先：<strong>${favList}</strong></li>
      <li>调衡要点：${st.focus}</li>
    </ul>
    ${timeUnknown ? `<p class="muted" style="color:var(--muted); margin-top:8px;">提示：出生时间不详，未纳入时柱。</p>` : ``}
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">三、性格与天赋</h3>
    <p style="margin:8px 0;"><strong>性格核心：</strong>依据日主、季节与强弱给出核心性格标签（示例：外向表达、行动力强）。</p>
    <p style="margin:8px 0;"><strong>优势能量：</strong>执行力 / 创造力 / 学习力（模板化补充）</p>
    <p style="margin:8px 0;"><strong>潜在挑战：</strong>急躁 / 过度承担 / 边界感（模板化补充）</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">四、格局与喜忌</h3>
    <p style="margin:8px 0;"><strong>格局要点：</strong>按四柱特征（坐禄/比劫/伤官/七杀等）模板化输出。</p>
    <p style="margin:8px 0;"><strong>喜用：</strong>${favList}</p>
    <p style="margin:8px 0;"><strong>忌讳：</strong>${avoidList}</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">五、事业与发展（免费试读）</h3>
    <p style="margin:8px 0;"><strong>适合领域：</strong>依据喜用与日主气质：策划/顾问/设计/运营等（模板化）</p>
    <p style="margin:8px 0;"><strong>发展策略：</strong>${st.focus}，建立 SOP 与可复制流程</p>
    <p style="margin:8px 0;"><strong>易错位风险：</strong>事必躬亲 / 决策失衡（模板化）</p>
    <p style="margin:10px 0 0;" class="muted">VIP 解锁：岗位定位、三年运势、转职择时与行动清单。</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">六、感情与关系（免费试读）</h3>
    <p style="margin:8px 0;"><strong>吸引类型：</strong>与日主互补/需要支持型（模板化）</p>
    <p style="margin:8px 0;"><strong>关系课题：</strong>边界 / 沟通节奏（模板化）</p>
    <p style="margin:8px 0;"><strong>相处建议：</strong>尊重节奏、定期复盘（模板化）</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">七、财富与理财（免费试读）</h3>
    <p style="margin:8px 0;"><strong>财星格局：</strong>结合强弱判断，偏财/正财（模板化）</p>
    <p style="margin:8px 0;"><strong>进财方式：</strong>内容/系统/复购（模板化）</p>
    <p style="margin:8px 0;"><strong>破财隐患：</strong>情绪消费/伙伴风险（模板化）</p>
    <p style="margin:8px 0;"><strong>理财建议：</strong>${favList} 为主调，稳中求进</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">八、健康与作息</h3>
    <p style="margin:8px 0;"><strong>易感部位：</strong>按最弱五行（${weakest}）对应系统（模板化）</p>
    <p style="margin:8px 0;"><strong>调理建议：</strong>作息规律、舒压训练、季节养生（模板化）</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">九、环境与色彩（五行调法）</h3>
    <p style="margin:8px 0;"><strong>有利方位：</strong>依据喜用：东/南/西/北/中（模板化）</p>
    <p style="margin:8px 0;"><strong>色彩/材质：</strong>与喜用对应色系与材质（模板化）</p>
    <p style="margin:8px 0;"><strong>空间微调：</strong>小范围摆设与动线建议（模板化）</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:16px;">
    <h3 style="margin-top:0; color:var(--brand)">十、流年 / 流月 · 免费预告</h3>
    <p style="margin:8px 0;"><strong>年度提示：</strong>依据当年干支与喜用给一句话预告（模板化）</p>
    <p style="margin:8px 0;"><strong>本月关注：</strong>节律与行动关键词（模板化）</p>
    <p style="margin:10px 0 0;" class="muted">VIP 解锁：12 个月行动清单与择日表。</p>
  </section>

  <section class="card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:10px;">
    <h3 style="margin-top:0; color:var(--brand)">解锁你的完整专属报告</h3>
    <p style="margin:8px 0;">
      免费版为基础解读。升级 <strong>VIP</strong>，即可获得
      <strong>婚姻 / 事业 / 财库 / 择日</strong> 的完整方案与可执行清单。
    </p>
    <div style="margin-top:10px;">
      <a href="/vip" style="display:inline-block; padding:10px 16px; border-radius:10px; background:var(--brand); color:#111; font-weight:700; text-decoration:none;">升级 VIP</a>
    </div>
  </section>
  `;
}
function mountRichReport({pillars, percents, st, adv, timeUnknown}) {
  let host = document.getElementById('xl-rich-report');
  if (!host) {
    host = document.createElement('section');
    host.id = 'xl-rich-report';
    host.className = 'container';
    host.style.paddingTop = '12px';
    (document.getElementById('result') || document.body).appendChild(host);
  }
  host.innerHTML = buildRichReportHTML({pillars, percents, st, adv, timeUnknown});
}

// ======================= 心怜管家卡片 & GPT抽屉 =======================
function buildButlerHTML(){
  return `
    <div id="assistant-panel" class="xl-card" style="margin-top:12px; padding:16px; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px; color:var(--brand)">心怜管家 · 智能解读</h3>
      <div id="assistant-analysis"></div>
      <div id="assistant-advice" style="margin-top:8px"></div>
    </div>
  `;
}
function buildChatDrawerHTML(){
  return `
    <details id="gpt-drawer" class="xl-card" style="margin-top:12px; padding:0; border-radius:10px; background:var(--card); box-shadow:var(--shadow);">
      <summary style="cursor:pointer; list-style:none; padding:12px 16px; font-weight:700; color:var(--brand);">GPT 问答</summary>
      <div style="padding:10px 12px;">
        <div id="gpt-body" style="max-height:260px; overflow:auto; font-size:14px; line-height:1.5; border:1px solid #222; border-radius:8px; padding:8px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input id="gpt-input" placeholder="问点什么…" style="flex:1; padding:8px; border-radius:8px; border:1px solid #222; background:#0b0f14; color:var(--text)">
          <button id="gpt-send" style="padding:8px 12px; border-radius:8px; background:var(--brand); color:#111; font-weight:700">发送</button>
        </div>
      </div>
    </details>
  `;
}
async function callChatAPI(userText, ctx){
  const payload = { messages: [{role:'user', content: userText}], context: ctx };
  async function post(url){
    try{
      const r = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (r.ok) {
        // 兼容两种返回格式
        const t = await r.text();
        try {
          const j = JSON.parse(t);
          return j.reply || t || '（无响应）';
        } catch { return t || '（无响应）'; }
      }
    }catch(_){}
    return null;
  }
  return await post('/api/butler/chat') || await post('/api/chat') || '（暂时无法连接到服务端）';
}
function wireChatDrawer(){
  const send = $('gpt-send'), input=$('gpt-input'), body=$('gpt-body');
  if(!send || !input || !body) return;
  send.onclick = async ()=>{
    const text = (input.value||'').trim(); if(!text) return;
    body.insertAdjacentHTML('beforeend', `<div style="text-align:right; margin:6px 0;">${text}</div>`);
    input.value='';
    const ctx = window.__bazi_ctx__ || {};
    const reply = await callChatAPI(text, ctx);
    body.insertAdjacentHTML('beforeend', `<div style="margin:6px 0;">${reply}</div>`);
    body.scrollTop = body.scrollHeight;
  };
}

// ======================= 统一挂载（免费报告 + 管家卡片 + GPT抽屉） =======================
function mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown}){
  const resultEl = $('result');
  if(!resultEl){ console.warn('[mount] 找不到 #result，跳过扩展模块渲染'); return; }

  // 1) 免费报告
  let freeNode = $('xl-free-report');
  if(!freeNode){
    freeNode = document.createElement('div');
    freeNode.id = 'xl-free-report';
    resultEl.appendChild(freeNode);
  }
  freeNode.innerHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown});

  // 2) 心怜管家卡片
  let butler = $('assistant-panel');
  if(!butler){
    const wrap = document.createElement('div');
    wrap.innerHTML = buildButlerHTML();
    resultEl.appendChild(wrap.firstElementChild);
  }
  assistant.generateAnalysis({
    dayMaster: { stem: pillars.day.stem, element: pillars.day.element },
    elements: { wood:percents.wood, fire:percents.fire, earth:percents.earth, metal:percents.metal, water:percents.water },
    strength: st, season: st.season, useful: adv, timeUnknown
  });

  // 3) GPT 抽屉
  let drawer = $('gpt-drawer');
  if(!drawer){
    const wrap = document.createElement('div');
    wrap.innerHTML = buildChatDrawerHTML();
    resultEl.appendChild(wrap.firstElementChild);
    wireChatDrawer();
  }

  // 4) 聊天上下文
  window.__bazi_ctx__ = {
    pillars,
    wuxing_ratio: percents,
    season: st.season,
    strength: st.mark,
    strategy: st.focus,
    useful: adv?.useful || [],
    timeUnknown
  };
}

function ensureGPTDrawer() {
  const host = document.getElementById('result') || document.body;
  let drawer = document.getElementById('gpt-drawer');

  // 不存在就创建
  if (!drawer) {
    const wrap = document.createElement('div');
    wrap.innerHTML = buildChatDrawerHTML();
    // 放到结果区的最前面，确保“看得见”
    host.insertBefore(wrap.firstElementChild, host.firstChild);
    drawer = document.getElementById('gpt-drawer');
  } else {
    // 已存在：若不在 #result，移过来并放最前
    if (host && drawer.parentNode !== host) {
      host.insertBefore(drawer, host.firstChild);
    }
  }

  // 兜底：确保显示、不被隐藏
  drawer.style.display = 'block';
  drawer.removeAttribute('hidden');

  // 反复绑定也没事：先解绑再绑（简单粗暴）
  const send = document.getElementById('gpt-send');
  if (send) {
    const cloned = send.cloneNode(true);
    send.parentNode.replaceChild(cloned, send);
  }
  wireChatDrawer();
}

// ======================= 主流程：生成八字并渲染 =======================
async function genChart(){
  const birth = ($('birthdate')?.value||'').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  if (!birth){ showError('请填写出生日期。'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D] = birth.split('-').map(Number);
    let hour = 12;
    if (!timeUnknown){
      const t = ($('birthtime')?.value||'').trim();
      if(t) hour = parseInt(t.split(':')[0],10);
    }

    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    // 显示结果区
    $('result')?.style.setProperty('display','block');
    ensureGPTDrawer(); // ← 强制把 GPT 抽屉放到结果区最上方并绑定事件

    // 日期与“未纳入时柱”徽章
    const timeText = tu ? '时间不详' : (hour + '时');
    setText('bazi-date', `出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if (tu) {
      const el = document.getElementById('bazi-date');
      el && (el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>');
    }

    // 经典区：四柱表 + 五行条
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);
    setBar($('bar-木'),  percents.wood);  setText('pct-木',  Math.round(percents.wood)+'%');
    setBar($('bar-火'),  percents.fire);  setText('pct-火',  Math.round(percents.fire)+'%');
    setBar($('bar-土'),  percents.earth); setText('pct-土',  Math.round(percents.earth)+'%');
    setBar($('bar-金'),  percents.metal); setText('pct-金',  Math.round(percents.metal)+'%');
    setBar($('bar-水'),  percents.water); setText('pct-水',  Math.round(percents.water)+'%');

    // 强弱/喜用
    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);
    const keys = Object.keys(counts);
    const maxK = keys.reduce((a,b)=>counts[a]>counts[b]?a:b);
    const minK = keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance', `五行中${maxK}元素最强，${minK}元素最弱。`);

    // 统一挂载（免费报告 + 管家卡片 + GPT抽屉）
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });

    // 富内容报告（第2~10章）
    mountRichReport({ pillars, percents, st, adv, timeUnknown: tu });

    // —— 可选：后端“心怜管家”解说（失败静默）
    try {
      const payload = {
        profile: {
          name: $('name')?.value || '', gender: $('gender')?.value || '',
          calendar: $('calendar')?.value || 'gregorian',
          birth: `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`,
          time: tu ? null : ($('birthtime')?.value || ''), timezone: '+08:00'
        },
        chart: {
          year: pillars.year, month: pillars.month, day: {stem:pillars.day.stem, branch:pillars.day.branch},
          hour: tu ? {stem:'？',branch:'？'} : pillars.hour,
          day_master: pillars.day.stem, season: st.season,
          wuxing_ratio: { wood: percents.wood, fire: percents.fire, earth: percents.earth, metal: percents.metal, water: percents.water }
        },
        prefs: { lang: 'zh-CN', tier: 'free' }
      };
      const resp = await fetch('/api/butler/explain', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).catch(()=>null);
      const ana = document.getElementById('assistant-analysis');
      const advc= document.getElementById('assistant-advice');
      if (resp && resp.layout) {
        if (ana && resp?.layout?.cards?.[0]?.html) ana.innerHTML = resp.layout.cards[0].html;
        if (advc && resp?.layout?.cards?.[1]?.html) advc.innerHTML= resp.layout.cards[1].html;
      }
    } catch(_) { /* 静默失败，不影响页面 */ }

    // 控制台校验
    console.log('实际 →',
      pillars.year.stem+pillars.year.branch,
      pillars.month.stem+pillars.month.branch,
      pillars.day.stem+pillars.day.branch,
      tu ? '？' : (pillars.hour.stem+pillars.hour.branch)
    );

  } catch(err){
    console.error(err);
    showError('计算八字时出现错误，请重试');
  } finally {
    if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none';
  }
}
  <!-- 功能脚本：后端代理 + 多语言 + Chat 浮窗 -->

  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat 按钮与面板
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">心怜管家 · Chat</div>
        <div class="ss-close" id="ssChatClose">✕</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    // 初始语言（页面 + chat）
    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。');
        addMsg(reply);
      }catch(e){
        addMsg('网络异常，请稍后再试。');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // 语言切换时，同步更新
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }
  });

  // ============== 登录流程（集中处理 exists / expired / expiresAt） ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }

  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    // ✅ 统一判断是否过期（兼容 msg/flag/时间戳）
    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      // 只提示，不跳转；可一键引导续费
      const go = confirm(t('err_expired') + "。是否前往续费？");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    // ✅ 正常通过才跳 VIP
    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    // 常见错误
    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== 表单事件（注册 / 登录 / 重设） ========
  document.getElementById("registerForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

    lock($("registerBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      }));

      if (res.ok === true){
        localStorage.setItem("vipEmail", email);
        location.href = "vip_trial.html";
        return;
      }

      // 已存在：自动尝试登录（用刚输入的密码）
      if ((res.msg||"").toString() === 'exists'){
        await loginFlow(email, password);
        return;
      }

      return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
    } catch(err){
      showErr(t('err_register_fail') + (err?.message || ''));
    } finally{
      lock($("registerBtn"), false);
    }
  });

  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    lock($("loginBtn"), true);
    try{
      await loginFlow(email, password);
    } catch(err){
      showErr(t('err_login_fail') + (err?.message || ''));
    } finally{
      lock($("loginBtn"), false);
    }
  });

  document.getElementById("resetBtn").addEventListener("click", async ()=>{
    hideErr();
    let email = prompt(t('prompt_email'));
    if (email === null) return; email = email.trim();
    if (!email) return showErr(t('err_email_empty'));

    let newPassword = prompt(t('prompt_newpwd'));
    if (newPassword === null) return; newPassword = newPassword.trim();
    if (!newPassword) return showErr(t('err_pwd_empty'));
    if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

    lock($("resetBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword })
      }));
      if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
      alert(t('msg_reset_ok'));
    } catch(err){
      showErr(t('err_reset_fail') + (err?.message || ''));
    } finally{
      lock($("resetBtn"), false);
    }
  });
  
// 事件绑定
document.addEventListener('DOMContentLoaded', ()=>{
  const today = new Date(); const def = today.toISOString().split('T')[0];
  if ($('birthdate') && !$('birthdate').value) $('birthdate').value = def;
  const tChk = $('timeUnknown'), tBox = $('timeInputContainer');
  if (tChk){ tChk.addEventListener('change', function(){ tBox && tBox.classList.toggle('disabled', this.checked); }); }
  $('genBtn')?.addEventListener('click', genChart);
});     

// ===== 自测（控制台）：1978-02-21 12:00（UTC+8）应为 戊午 甲寅 甲寅 庚午 =====
(function(){
  const c = new BaziCalculator();
  const Y=c.calculateYearPillar(1978);
  const M=c.calculateMonthPillar(1978,2,21);
  const D=c.calculateDayPillar(1978,2,21);
  const H=c.calculateHourPillar(D.stem,12);
  console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
  console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
