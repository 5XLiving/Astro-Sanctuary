<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + "不详"同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏"估时间"按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
/* 聊天输入行：输入框撑满、按钮按内容自适应 */
.ss-chat-input{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px; border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto; min-width:0;
}
.ss-chat-input .btn,
.ss-chat-input button{
  flex:0 0 auto;
  width:auto !important;
  white-space:nowrap;
  padding:10px 14px;
}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    /* 修复：Grid 子项允许收缩，避免内容把面板撑破 */
.auth-grid > * { min-width: 0; }
.panel .body .row.one > * { min-width: 0; }

/* 让会员按钮在窄宽度下能换行、居中且不溢出 */
.panel .body .btn {
  display: flex;               /* 改为 flex 更稳 */
  align-items: center;
  justify-content: center;
  text-align: center;
  white-space: normal;         /* 允许换行 */
  line-height: 1.2;
  word-break: break-word;      /* 多语言/长词可断行 */
}

/* 块级按钮确保占满容器且不超出 */
.btn.block { display:block; width:100%; box-sizing:border-box; }

/* 可选：如果仍有轻微位移，限制溢出 */
.panel .body { overflow: hidden; }

.panel .body .btn { padding: 10px 14px; }    
    /* === 表单网格：大屏 3 列，窄屏 1 列 === */
.row{display:grid;gap:12px;grid-template-columns:1fr;}        /* 默认 1 列 */
.row > *{min-width:0;}                                         /* 防止子项把容器撑爆 */
@media (min-width:760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr;}              /* 三列 */
}

/* 标签更紧凑 */
label.muted{display:block;margin-bottom:4px}

/* 按钮不要 100% 宽 */
#genBtn{width:auto !important}
.gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

/* 时间输入与"不详"并排、紧凑 */
.time-row{display:flex;align-items:center;gap:10px}
.time-row input[type="time"]{
  width:auto !important; flex:0 0 160px; min-width:140px;
}
.time-row .time-unknown{white-space:nowrap}
    .title a{ color: inherit; text-decoration: none; }
.title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    /* —— 统一头部 —— */
.site-header{
  position:sticky; top:0; z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

/* 品牌区：徽章 + 标题 */
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}

/* 语言选择：防止"语言"竖排、与第一张一致 */
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; min-width:170px;
  border-radius:10px; border:1px solid #243244;
  background:#0e1520; color:var(--text);
  padding:10px 34px 10px 12px; font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
/* 与 Index 保持一致的根字号（会影响 rem 计算） */
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }

/* 标题用 Noto Serif SC；字号/字重与 Index 完全一致 */
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}    

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}  

        /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* 免费简报样式 */
    .xl-card {
      margin-top:12px;
      padding:16px;
      border-radius:10px;
      background:var(--card);
      box-shadow:var(--shadow);
      border: 1px solid rgba(212,175,55,.2);
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <!-- 品牌：点击回到"八字简评"本页 -->
<a class="brand" href="https://astro.5xliving.com/" target="_self">
  <span class="brand-badge">5X</span>
  <span class="title">
    5xLiving · <span data-i18n="title_bazi_brief">八字简评</span>
  </span>
</a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
<div class="h2" data-i18n="title_quickcalc">八字命理 · 快速排盘</div>

<div class="row cols-3">
  <div>
    <label class="muted" data-i18n="label_name">姓名（可选）</label>
    <input id="name" placeholder="你的称呼（用于个性化）" data-i18n-ph="ph_name" />
  </div>
  <div>
    <label class="muted" data-i18n="gender_label">性别</label>
     <select id="gender">
     <option value="" data-i18n="opt_gender_confidential">不透露</option>
     <option value="male" data-i18n="opt_gender_male">男性</option>
     <option value="female" data-i18n="opt_gender_female">女性</option>
    </select>
  </div>
  <div>
    <label class="muted" data-i18n="label_calendar">历法</label>
     <select id="calendar">
     <option value="gregorian" data-i18n="opt_cal_gregorian">阳历</option>
     <option value="lunar" data-i18n="opt_cal_lunar">农历</option>
    </select>
  </div>
</div>

<div class="row cols-3" style="margin-top:10px">
  <div>
    <label class="muted" data-i18n="label_birthdate">出生日期</label>
    <input type="date" id="birthdate" />
  </div>

  <div>
    <label class="muted" data-i18n="label_birthtime">出生时间</label>
    <div class="time-row">
     <input type="time" id="birthtime" value="12:00" />
     <label class="muted time-unknown">
     <input type="checkbox" id="timeUnknown" />
     <span data-i18n="cb_time_unknown">出生时间不详</span>
      </label>
    </div>
  </div>

  <div class="gen-wrap">
  <button class="btn" id="genBtn" type="button" aria-busy="false" aria-controls="result">
    <span id="genBtnText" data-i18n="btn_generate_chart">生成八字</span>
    <span id="genBtnLoading" data-i18n="btn_loading" style="display:none">计算中…</span>
  </button>
</div>    

      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">您的生辰八字命盘</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
          <tbody>
            <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">五行能量分析</div>
        <div class="bar-row"><span data-i18n="el_wood">木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- 免费简报区域 -->
      <div id="xl-free-report"></div>
      
      <!-- 富报告区域 -->
      <div id="rich-report"></div>
    </section>

    <!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username" />
                <!-- 登录/注册建议用 username，密码管理器更容易配对 -->

                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input 
                  id="password" 
                  type="password" 
                  autocomplete="new-password" 
                  placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>

            
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点"填入时间"，会用该时段的中位时间写到上方时间输入框，并自动取消"时间不详"。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

<script>
(function(){
'use strict';

/* =========================
   基础配置 & 小工具
   ========================= */
const LANG_KEY = 'site_lang';
const $  = (id) => document.getElementById(id);
const qs = (s, root=document) => root.querySelector(s);

function showErr(msg){
  const e=$('error'); if(!e) return;
  e.textContent = msg || '';
  e.style.display = msg ? 'block' : 'none';
  if(msg) setTimeout(()=>{ e.style.display='none'; }, 4000);
}
function lock(el, v){ if(el){ el.disabled = !!v; el.setAttribute('aria-busy', v?'true':'false'); } }
function setText(id,v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(!el) return; const p = Math.max(0, Math.min(100, pct||0)); el.style.width = p + '%'; }
function safeHtml(s){ const d=document.createElement('div'); d.textContent=String(s||''); return d.innerHTML; }

/* =========================
   i18n：默认键（兜底 + 本页实际用到的键全补齐）
   ========================= */
const DEFAULT_KEYS = {
  'zh-CN': {
    // 通用
    lang_label:'语言',
    title_bazi_brief:'八字简评', title_quickcalc:'八字命理 · 快速排盘',
    label_name:'姓名（可选）', ph_name:'你的称呼（用于个性化）',
    gender_label:'性别', opt_gender_confidential:'不透露', opt_gender_male:'男性', opt_gender_female:'女性',
    label_calendar:'历法', opt_cal_gregorian:'阳历', opt_cal_lunar:'农历',
    label_birthdate:'出生日期', label_birthtime:'出生时间', cb_time_unknown:'出生时间不详',
    btn_generate_chart:'生成八字', btn_loading:'计算中…', err_need_date:'请先选择出生日期',
    // 五行/季节
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    // 报告
    rpt_free_title:'免费简报', rpt_pillars_label:'四柱', rpt_daymaster_label:'日主', rpt_season_label:'季节',
    rpt_chart_label:'命局', rpt_strategy_label:'策略', rpt_wuxing_label:'五行',
    rpt_strongest_word:'偏旺', rpt_weakest_word:'偏弱', rpt_absent_prefix:'缺：',
    rpt_balance_focus_label:'调衡要点', rpt_time_hint:'提示：出生时间不详，未纳入时柱，仅供参考。',
    rpt_time_unknown:'时间不详', elements_balance_tpl:'五行中{max}元素最强，{min}元素最弱。',
    rpt_fav_avoid_template:'喜用：{fav}｜忌：{avoid}',
    rpt_sec_overview_title:'一、命盘总览', rpt_sec_elements_title:'二、五行能量分析',
    rpt_sec_traits_title:'三、性格与天赋', rpt_sec_structure_title:'四、格局与喜忌',
    rpt_sec_career_title:'五、事业与发展（免费试读）', rpt_career_fields_placeholder:'适合领域（模板）',
    rpt_sec_love_title:'六、感情与关系（免费试读）', rpt_love_placeholder:'（模板）',
    rpt_sec_wealth_title:'七、财富与理财（免费试读）', rpt_wealth_suggestion_template:'理财建议：以 {fav} 为主调，稳中求进。',
    rpt_sec_health_title:'八、健康与作息', rpt_health_placeholder_template:'围绕最弱五行（{weak}）做优化。',
    rpt_sec_env_title:'九、环境与色彩', rpt_env_placeholder:'（模板）',
    rpt_strategy_drain:'泄秀/制化', rpt_strategy_support:'生扶/补助', rpt_strategy_balance:'调和',
    strength_strong:'偏强', strength_weak:'偏弱', strength_balanced:'平衡',
    useful_elements:'喜用元素：',
    // 心怜管家（UI + 提示）
    butler_chat_title:'心怜管家 · Chat', chat_fab:'问', chat_placeholder:'请问您想了解什么？（如：如何开始免费体验）', chat_send:'发送',
    chip_career:'事业建议', chip_love:'感情建议', chip_money:'财富建议', chip_list:'今日清单', chip_30d:'近30天运势',
    butler_need_chart:'请先生成命盘，再向我提问～',
    dev_strategy:'发展策略：'
  },
  'zh-TW': {
    lang_label:'語言',
    title_bazi_brief:'八字簡評', title_quickcalc:'八字命理 · 快速排盤',
    label_name:'姓名（可選）', ph_name:'你的稱呼（用於個性化）',
    gender_label:'性別', opt_gender_confidential:'不透露', opt_gender_male:'男性', opt_gender_female:'女性',
    label_calendar:'曆法', opt_cal_gregorian:'陽曆', opt_cal_lunar:'農曆',
    label_birthdate:'出生日期', label_birthtime:'出生時間', cb_time_unknown:'出生時間不詳',
    btn_generate_chart:'生成八字', btn_loading:'計算中…', err_need_date:'請先選擇出生日期',
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    rpt_free_title:'免費簡報', rpt_pillars_label:'四柱', rpt_daymaster_label:'日主', rpt_season_label:'季節',
    rpt_chart_label:'命局', rpt_strategy_label:'策略', rpt_wuxing_label:'五行',
    rpt_strongest_word:'偏旺', rpt_weakest_word:'偏弱', rpt_absent_prefix:'缺：',
    rpt_balance_focus_label:'調衡要點', rpt_time_hint:'提示：出生時間不詳，未納入時柱，僅供參考。',
    rpt_time_unknown:'時間不詳', elements_balance_tpl:'五行中{max}元素最強，{min}元素最弱。',
    rpt_fav_avoid_template:'喜用：{fav}｜忌：{avoid}',
    rpt_sec_overview_title:'一、命盤總覽', rpt_sec_elements_title:'二、五行能量分析',
    rpt_sec_traits_title:'三、性格與天賦', rpt_sec_structure_title:'四、格局與喜忌',
    rpt_sec_career_title:'五、事業與發展（免費試讀）', rpt_career_fields_placeholder:'適合領域（模板）',
    rpt_sec_love_title:'六、感情與關係（免費試讀）', rpt_love_placeholder:'（模板）',
    rpt_sec_wealth_title:'七、財富與理財（免費試讀）', rpt_wealth_suggestion_template:'理財建議：以 {fav} 為主調，穩中求進。',
    rpt_sec_health_title:'八、健康與作息', rpt_health_placeholder_template:'圍繞最弱五行（{weak}）做優化。',
    rpt_sec_env_title:'九、環境與色彩', rpt_env_placeholder:'（模板）',
    rpt_strategy_drain:'洩秀/制化', rpt_strategy_support:'生扶/補助', rpt_strategy_balance:'調和',
    strength_strong:'偏強', strength_weak:'偏弱', strength_balanced:'平衡',
    useful_elements:'喜用元素：',
    butler_chat_title:'心憐管家 · Chat', chat_fab:'問', chat_placeholder:'想了解什麼？', chat_send:'發送',
    chip_career:'事業建議', chip_love:'感情建議', chip_money:'財富建議', chip_list:'今日清單', chip_30d:'近30天運勢',
    butler_need_chart:'請先生成命盤，再向我提問～',
    dev_strategy:'發展策略：'
  },
  'en': {
    lang_label:'Language',
    title_bazi_brief:'BaZi Brief', title_quickcalc:'BaZi · Quick Chart',
    label_name:'Name (optional)', ph_name:'How should I call you?',
    gender_label:'Gender', opt_gender_confidential:'Prefer not to say', opt_gender_male:'Male', opt_gender_female:'Female',
    label_calendar:'Calendar', opt_cal_gregorian:'Gregorian', opt_cal_lunar:'Lunar',
    label_birthdate:'Birth Date', label_birthtime:'Birth Time', cb_time_unknown:'Time unknown',
    btn_generate_chart:'Generate Chart', btn_loading:'Calculating…', err_need_date:'Please select a date',
    el_wood:'Wood', el_fire:'Fire', el_earth:'Earth', el_metal:'Metal', el_water:'Water',
    season_spring:'Spring', season_summer:'Summer', season_autumn:'Autumn', season_winter:'Winter',
    rpt_free_title:'Free Brief', rpt_pillars_label:'Pillars', rpt_daymaster_label:'Day Master', rpt_season_label:'Season',
    rpt_chart_label:'Chart', rpt_strategy_label:'Strategy', rpt_wuxing_label:'Five Elements',
    rpt_strongest_word:'strongest', rpt_weakest_word:'weakest', rpt_absent_prefix:'Absent: ',
    rpt_balance_focus_label:'Balancing Focus', rpt_time_hint:'Tip: Birth time unknown; hour pillar excluded; reference only.',
    rpt_time_unknown:'Time unknown', elements_balance_tpl:'Among the five elements, {max} is strongest and {min} is weakest.',
    rpt_fav_avoid_template:'Favour: {fav} | Avoid: {avoid}',
    rpt_sec_overview_title:'1) Overview', rpt_sec_elements_title:'2) Five-Element Analysis',
    rpt_sec_traits_title:'3) Traits & Talents', rpt_sec_structure_title:'4) Structure & Favor/Avoid',
    rpt_sec_career_title:'5) Career (free preview)', rpt_career_fields_placeholder:'Suitable fields (template).',
    rpt_sec_love_title:'6) Relationships (free preview)', rpt_love_placeholder:'(template)',
    rpt_sec_wealth_title:'7) Wealth & Finance (free preview)', rpt_wealth_suggestion_template:'Finance: lead with {fav}, progress steadily.',
    rpt_sec_health_title:'8) Health & Routine', rpt_health_placeholder_template:'Optimize around the weakest element ({weak}).',
    rpt_sec_env_title:'9) Environment & Colors', rpt_env_placeholder:'(template)',
    rpt_strategy_drain:'Drain/Control', rpt_strategy_support:'Support/Nourish', rpt_strategy_balance:'Harmonize',
    strength_strong:'Strong', strength_weak:'Weak', strength_balanced:'Balanced',
    useful_elements:'Useful elements: ',
    butler_chat_title:'Butler · Chat', chat_fab:'Ask', chat_placeholder:'What would you like to know?', chat_send:'Send',
    chip_career:'Career', chip_love:'Love', chip_money:'Finance', chip_list:'Today List', chip_30d:'Next 30 days',
    butler_need_chart:'Please generate the chart first, then ask me.',
    dev_strategy:'Strategy: '
  },
  'ja': {
    lang_label:'言語',
    title_bazi_brief:'八字ブリーフ', title_quickcalc:'八字 · クイック',
    label_name:'名前（任意）', ph_name:'お呼び名',
    gender_label:'性別', opt_gender_confidential:'非公開', opt_gender_male:'男性', opt_gender_female:'女性',
    label_calendar:'暦', opt_cal_gregorian:'西暦', opt_cal_lunar:'旧暦',
    label_birthdate:'生年月日', label_birthtime:'出生時刻', cb_time_unknown:'時刻不明',
    btn_generate_chart:'命盤を生成', btn_loading:'計算中…', err_need_date:'日付を選択してください',
    el_wood:'木', el_fire:'火', el_earth:'土', el_metal:'金', el_water:'水',
    season_spring:'春', season_summer:'夏', season_autumn:'秋', season_winter:'冬',
    rpt_free_title:'無料ブリーフ', rpt_pillars_label:'四柱', rpt_daymaster_label:'日主', rpt_season_label:'季節',
    rpt_chart_label:'命式', rpt_strategy_label:'戦略', rpt_wuxing_label:'五行',
    rpt_strongest_word:'強い', rpt_weakest_word:'弱い', rpt_absent_prefix:'欠如：',
    rpt_balance_focus_label:'調整ポイント', rpt_time_hint:'ヒント：出生時刻不明のため時柱なし。参考値です。',
    rpt_time_unknown:'時刻不明', elements_balance_tpl:'五行のうち、{max}が最も強く、{min}が最も弱い。',
    rpt_fav_avoid_template:'用神：{fav}｜忌神：{avoid}',
    rpt_sec_overview_title:'一、概要', rpt_sec_elements_title:'二、五行分析',
    rpt_sec_traits_title:'三、性格・才能', rpt_sec_structure_title:'四、格局と喜忌',
    rpt_sec_career_title:'五、キャリア（無料）', rpt_career_fields_placeholder:'適職（テンプレ）',
    rpt_sec_love_title:'六、恋愛・関係（無料）', rpt_love_placeholder:'（テンプレ）',
    rpt_sec_wealth_title:'七、財運・資産（無料）', rpt_wealth_suggestion_template:'資産運用：{fav}を主調に、堅実に。',
    rpt_sec_health_title:'八、健康・生活', rpt_health_placeholder_template:'最弱五行（{weak}）に合わせて最適化。',
    rpt_sec_env_title:'九、環境と色彩', rpt_env_placeholder:'（テンプレ）',
    rpt_strategy_drain:'洩らし/制御', rpt_strategy_support:'扶け/補強', rpt_strategy_balance:'調和',
    strength_strong:'強い', strength_weak:'弱い', strength_balanced:'均衡',
    useful_elements:'有用な要素：',
    butler_chat_title:'執事 · チャット', chat_fab:'質問', chat_placeholder:'何を知りたいですか？', chat_send:'送信',
    chip_career:'キャリア', chip_love:'愛', chip_money:'財務', chip_list:'今日のリスト', chip_30d:'30日運勢',
    butler_need_chart:'まず命盤を生成してから質問してください。',
    dev_strategy:'戦略：'
  },
  'th': {
    lang_label:'ภาษา',
    title_bazi_brief:'สรุปดวง', title_quickcalc:'ดวง · คำนวณเร็ว',
    label_name:'ชื่อ (ไม่บังคับ)', ph_name:'ให้เราเรียกคุณว่า?',
    gender_label:'เพศ', opt_gender_confidential:'ไม่ระบุ', opt_gender_male:'ชาย', opt_gender_female:'หญิง',
    label_calendar:'ปฏิทิน', opt_cal_gregorian:'สากล', opt_cal_lunar:'จันทรคติ',
    label_birthdate:'วันเกิด', label_birthtime:'เวลาเกิด', cb_time_unknown:'ไม่ทราบเวลา',
    btn_generate_chart:'สร้างดวง', btn_loading:'กำลังคำนวณ…', err_need_date:'โปรดเลือกวันเกิด',
    el_wood:'ไม้', el_fire:'ไฟ', el_earth:'ดิน', el_metal:'โลหะ', el_water:'น้ำ',
    season_spring:'ใบไม้ผลิ', season_summer:'ร้อน', season_autumn:'ใบไม้ร่วง', season_winter:'หนาว',
    rpt_free_title:'สรุปฟรี', rpt_pillars_label:'เสา', rpt_daymaster_label:'Day Master', rpt_season_label:'ฤดู',
    rpt_chart_label:'ดวง', rpt_strategy_label:'กลยุทธ์', rpt_wuxing_label:'ห้าองค์ประกอบ',
    rpt_strongest_word:'เด่น', rpt_weakest_word:'อ่อน', rpt_absent_prefix:'ขาด: ',
    rpt_balance_focus_label:'จุดเน้นการปรับสมดุล', rpt_time_hint:'หมายเหตุ: ไม่ทราบเวลาเกิด จึงไม่รวมเสาเวลา',
    rpt_time_unknown:'ไม่ทราบเวลา', elements_balance_tpl:'ในห้าองค์ประกอบ {max} เด่นที่สุด และ {min} อ่อนที่สุด',
    rpt_fav_avoid_template:'เด่น: {fav} | เลี่ยง: {avoid}',
    rpt_sec_overview_title:'1) ภาพรวม', rpt_sec_elements_title:'2) วิเคราะห์องค์ประกอบ',
    rpt_sec_traits_title:'3) บุคลิก & ความถนัด', rpt_sec_structure_title:'4) โครงสร้าง & ควร/เลี่ยง',
    rpt_sec_career_title:'5) การงาน (ฟรี)', rpt_career_fields_placeholder:'สายงานที่เหมาะ (แม่แบบ)',
    rpt_sec_love_title:'6) ความรัก (ฟรี)', rpt_love_placeholder:'(แม่แบบ)',
    rpt_sec_wealth_title:'7) การเงิน (ฟรี)', rpt_wealth_suggestion_template:'การเงิน: นำด้วย {fav} เดินหน้าอย่างมั่นคง',
    rpt_sec_health_title:'8) สุขภาพ', rpt_health_placeholder_template:'ปรับตามธาตุที่อ่อนที่สุด ({weak}).',
    rpt_sec_env_title:'9) สภาพแวดล้อม', rpt_env_placeholder:'(แม่แบบ)',
    rpt_strategy_drain:'ระบาย/ควบคุม', rpt_strategy_support:'เสริม/เกื้อหนุน', rpt_strategy_balance:'ปรับสมดุล',
    strength_strong:'แข็งแรง', strength_weak:'อ่อน', strength_balanced:'สมดุล',
    useful_elements:'องค์ประกอบที่เป็นประโยชน์: ',
    butler_chat_title:'ผู้ช่วย · แชต', chat_fab:'ถาม', chat_placeholder:'อยากรู้อะไร?', chat_send:'ส่ง',
    chip_career:'งาน', chip_love:'ความรัก', chip_money:'การเงิน', chip_list:'เช็กลิสต์', chip_30d:'30 วันถัดไป',
    butler_need_chart:'กรุณาสร้างดวงก่อน แล้วค่อยถาม',
    dev_strategy:'กลยุทธ์: '
  },
  'ms': {
    lang_label:'Bahasa',
    title_bazi_brief:'Ringkas BaZi', title_quickcalc:'BaZi · Pantas',
    label_name:'Nama (pilihan)', ph_name:'Panggil saya…',
    gender_label:'Jantina', opt_gender_confidential:'Rahsia', opt_gender_male:'Lelaki', opt_gender_female:'Perempuan',
    label_calendar:'Kalendar', opt_cal_gregorian:'Gregorian', opt_cal_lunar:'Lunar',
    label_birthdate:'Tarikh Lahir', label_birthtime:'Masa Lahir', cb_time_unknown:'Tidak pasti masa',
    btn_generate_chart:'Jana Carta', btn_loading:'Mengira…', err_need_date:'Sila pilih tarikh',
    el_wood:'Kayu', el_fire:'Api', el_earth:'Tanah', el_metal:'Logam', el_water:'Air',
    season_spring:'Musim Bunga', season_summer:'Musim Panas', season_autumn:'Musim Luruh', season_winter:'Musim Sejuk',
    rpt_free_title:'Ringkasan Percuma', rpt_pillars_label:'Tiang', rpt_daymaster_label:'Day Master', rpt_season_label:'Musim',
    rpt_chart_label:'Carta', rpt_strategy_label:'Strategi', rpt_wuxing_label:'Lima Unsur',
    rpt_strongest_word:'paling kuat', rpt_weakest_word:'paling lemah', rpt_absent_prefix:'Tiada: ',
    rpt_balance_focus_label:'Fokus Keseimbangan', rpt_time_hint:'Nota: masa lahir tidak diketahui; tiang jam dikecualikan.',
    rpt_time_unknown:'Masa tidak diketahui', elements_balance_tpl:'Dalam lima unsur, {max} paling kuat dan {min} paling lemah.',
    rpt_fav_avoid_template:'Sokong: {fav} | Elak: {avoid}',
    rpt_sec_overview_title:'1) Gambaran', rpt_sec_elements_title:'2) Unsur',
    rpt_sec_traits_title:'3) Sifat & Bakat', rpt_sec_structure_title:'4) Struktur & Baik/Elak',
    rpt_sec_career_title:'5) Kerjaya (percuma)', rpt_career_fields_placeholder:'Bidang sesuai (templat).',
    rpt_sec_love_title:'6) Hubungan (percuma)', rpt_love_placeholder:'(templat)',
    rpt_sec_wealth_title:'7) Kewangan (percuma)', rpt_wealth_suggestion_template:'Kewangan: utamakan {fav}, maju stabil.',
    rpt_sec_health_title:'8) Kesihatan', rpt_health_placeholder_template:'Optimumkan unsur terlemah ({weak}).',
    rpt_sec_env_title:'9) Persekitaran & Warna', rpt_env_placeholder:'(templat)',
    rpt_strategy_drain:'Alir/Kawal', rpt_strategy_support:'Sokong/Suap', rpt_strategy_balance:'Seimbangkan',
    strength_strong:'Kuat', strength_weak:'Lemah', strength_balanced:'Seimbang',
    useful_elements:'Unsur berguna: ',
    butler_chat_title:'Pembantu · Sembang', chat_fab:'Tanya', chat_placeholder:'Apa yang ingin tahu?', chat_send:'Hantar',
    chip_career:'Kerjaya', chip_love:'Cinta', chip_money:'Kewangan', chip_list:'Senarai Hari Ini', chip_30d:'30 Hari Seterusnya',
    butler_need_chart:'Sila jana carta dahulu.',
    dev_strategy:'Strategi: '
  }
};

/* 你的 zh-CN 扩展翻译（页面已有），其余语言可空对象，缺的会优先走 DEFAULT_KEYS，再回退 zh-CN */
const translations = {
  'zh-CN': {
    // 你原本的 zh-CN 大段翻译已在页面；如果与默认相同，无需重复
  },
  'en': {}, 'ja': {}, 'th': {}, 'ms': {}, 'zh-TW': {}
};
// 确保所有语言键至少是对象
['zh-CN','zh-TW','en','ja','th','ms'].forEach(k => { translations[k] ??= {}; });

/* =========================
   i18n：核心方法
   ========================= */
function getLang(){
  const saved = localStorage.getItem(LANG_KEY);
  if (saved && (translations[saved] || DEFAULT_KEYS[saved])) return saved;
  const raw = (navigator.language||'zh-CN').replace('_','-');
  const map = { zh:'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW',
                en:'en','en-US':'en','en-GB':'en','en-AU':'en', ja:'ja','ja-JP':'ja', th:'th', ms:'ms' };
  return map[raw] || 'zh-CN';
}
function setLang(code){
  localStorage.setItem(LANG_KEY, code);
  document.documentElement.lang = code;
}
function t(key){
  const lang = getLang();
  const pack = translations[lang] || {};
  const zh   = translations['zh-CN'] || {};
  const D    = DEFAULT_KEYS[lang] || {};
  const Dz   = DEFAULT_KEYS['zh-CN'] || {};
  const val  = (pack[key] ?? D[key] ?? zh[key] ?? Dz[key]);
  if (val == null) { console.warn('[i18n missing]', lang, key); return ''; }
  return val;
}
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if (val !== '' && val !== key) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    const val = t(key);
    if (val !== '' && val !== key) el.setAttribute('placeholder', val);
  });
}

/* =========================
   八字计算器（简化可靠版）
   ========================= */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木',
                '泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金',
                '佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(y){
    const s=(y-4)%10, b=(y-4)%12;
    return { stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12], zodiac:this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y,m,d){
    // 以节气近似：小寒(01-06)前属于上一年腊月(12)；立春(02-04)起为寅月(1)……
    const mmdd=m*100+d, gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val;
    const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
    return {index:idx, branch:branchBy[idx]};
  }
  calculateMonthPillar(y,m,d){
    const {index,branch}=this.solarMonthIndex(y,m,d);
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(y).stem);
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; // 甲/己起丙寅……
    const stemIdx=(startMap[yStemIdx]+(index-1))%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(y,m,d){
    const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(y,m-1,d);
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
    const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
    return { stem:this.HEAVENLY_STEMS[(stemIdx+10)%10], branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour){
    const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; // 甲起甲子、乙起丙子……
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex=Math.floor((hour+1)/2)%12;
    const stemIdx=(startMap[dayIdx]+hourIndex)%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour] };
  }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  getElement(stem,branch){ return this.getStemElement(stem)+this.getBranchElement(branch); }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  calculateBazi(y,m,d,h=12,timeUnknown=false){
    const year=this.calculateYearPillar(y), month=this.calculateMonthPillar(y,m,d), day=this.calculateDayPillar(y,m,d);
    const hour=timeUnknown?{stem:'？', branch:'？'}:this.calculateHourPillar(day.stem,h);
    const dayElement=this.getStemElement(day.stem);
    const pillars={ year, month, day:{...day, element:dayElement}, hour };
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[year,month,day]:[year,month,day,hour]).forEach(p=>{
      if(p.stem&&p.stem!=='？') cnt[this.getStemElement(p.stem)]+=1;
      if(p.branch&&p.branch!=='？') cnt[this.getBranchElement(p.branch)]+=1;
    });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={ wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return { pillars, counts:cnt, percents:pct, timeUnknown };
  }
}
const baziCalculator = new BaziCalculator();

/* =========================
   多语言辅助
   ========================= */
const EL_CHAR_TO_KEY={木:'wood',火:'fire',土:'earth',金:'metal',水:'water'};
function ELABEL(){ return {
  wood: t('el_wood')||'木', fire: t('el_fire')||'火', earth: t('el_earth')||'土', metal: t('el_metal')||'金', water: t('el_water')||'水'
};}
function elCharsToLocale(arr){ const L=ELABEL(); return (arr||[]).map(ch=>L[EL_CHAR_TO_KEY[ch]]||ch); }
function listJoin(arr){ const lang=(getLang()||'').toLowerCase(); const sep=lang.startsWith('zh')?'、':', '; return (arr||[]).filter(Boolean).join(sep); }
function seasonName(s){
  const map={ 春:t('season_spring')||'春', 夏:t('season_summer')||'夏', 秋:t('season_autumn')||'秋', 冬:t('season_winter')||'冬' };
  return map[s]||s||'—';
}
function strategyName(s){
  const map={ '泄秀/制化':t('rpt_strategy_drain')||'泄秀/制化', '生扶/补助':t('rpt_strategy_support')||'生扶/补助', '调和':t('rpt_strategy_balance')||'调和' };
  return map[s]||s;
}

/* =========================
   报告构建（免费 & 富报告）
   ========================= */
function buildFreeReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), entries=Object.entries(percents||{});
  const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'', weakest=E[weakestK]||'';
  const absents=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]).filter(Boolean);
  const lang=(getLang()||'').toLowerCase(), sep=lang.startsWith('zh')?'　':' · ';
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]} ${Math.round(percents[k]||0)}%`).join(sep);
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favText=favLoc.length?listJoin(favLoc):'—', avoidText=avoidLoc.length?listJoin(avoidLoc):'—';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  const favAvoidLine=(t('rpt_fav_avoid_template')||'喜用：{fav}｜忌：{avoid}').replace('{fav}',favText).replace('{avoid}',avoidText);
  const absStr=absents.length? (lang.startsWith('zh')? `（${t('rpt_absent_prefix')||'缺：'}${listJoin(absents)}）` : ` (${t('rpt_absent_prefix')||'Absent: '}${listJoin(absents)})`) : '';
  return `
    <div class="xl-card">
      <h3 style="margin:0 0 8px;color:var(--brand)">${t('rpt_free_title')}</h3>
      <p style="margin:6px 0;">${t('rpt_pillars_label')}：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">${t('rpt_daymaster_label')}：<strong>${pillars.day.stem}</strong>（<strong>${dmElemName}</strong>）｜${t('rpt_season_label')}：<strong>${seasonName(st.season)||'-'}</strong>｜${t('rpt_chart_label')}：<strong>${t('strength_'+(st.mark==='偏强'?'strong':st.mark==='偏弱'?'weak':'balanced'))||st.mark}</strong> · <strong>${t('rpt_strategy_label')}：${stName}</strong></p>
      <p style="margin:8px 0;">${t('rpt_wuxing_label')}：${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')}；<strong>${weakest}</strong>${t('rpt_weakest_word')}。${absStr}</p>
      <ul style="margin:6px 0 0 18px;line-height:1.6">
        <li>${favAvoidLine}</li>
        <li>${t('rpt_balance_focus_label')}：${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">${t('rpt_time_hint')}</p>`:''}
    </div>`;
}
function buildRichReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), lang=(getLang()||'').toLowerCase();
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]}${lang.startsWith('zh')?'':' '}${Math.round(percents[k]||0)}%`).join(lang.startsWith('zh')?' ':' · ');
  const entries=Object.entries(percents||{}); const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'—', weakest=E[weakestK]||'—';
  const absentsArr=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]);
  const absentsStr=absentsArr.length ? (lang.startsWith('zh')? `（${t('rpt_absent_prefix')}${listJoin(absentsArr)}）` : ` (${t('rpt_absent_prefix')}${listJoin(absentsArr)})`) : '';
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favList=favLoc.length?listJoin(favLoc):'—', avoidList=avoidLoc.length?listJoin(avoidLoc):'—';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  return `
    <section class="card">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_overview_title')}</h3>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
        <div>${t('rpt_pillars_label')}：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></div>
        <div>${t('rpt_daymaster_label')}：<strong>${pillars.day.stem}</strong>（<strong>${dmElemName}</strong>）</div>
        <div>${t('rpt_season_label')}：<strong>${seasonName(st.season)||'-'}</strong></div>
        <div>${t('rpt_chart_label')}：<strong>${t('strength_'+(st.mark==='偏强'?'strong':st.mark==='偏弱'?'weak':'balanced'))||st.mark}</strong> · ${t('rpt_strategy_label')}：<strong>${stName}</strong></div>
      </div>
    </section>
    <section class="card">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_elements_title')}</h3>
      <div style="font-size:14px;">${line}</div>
      <p style="margin:10px 0 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')}；<strong>${weakest}</strong>${t('rpt_weakest_word')}。${absentsStr}</p>
      <ul style="margin:10px 0 0 18px;line-height:1.6">
        <li>${t('useful_elements')}${safeHtml(favList)}</li>
        <li>${t('rpt_balance_focus_label')}：${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:8px;">${t('rpt_time_hint')}</p>`:''}
    </section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_traits_title')}</h3><p>${t('rpt_traits_intro')||''}</p><p>${t('rpt_traits_adv')||''}</p><p>${t('rpt_traits_chal')||''}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_structure_title')}</h3><p>${(t('rpt_structure_line_template')||'喜用：{fav}；忌讳：{avoid}').replace('{fav}',safeHtml(favList)).replace('{avoid}',safeHtml(avoidList))}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_career_title')}</h3><p>${t('rpt_career_fields_placeholder')}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_love_title')}</h3><p>${t('rpt_love_placeholder')}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_wealth_title')}</h3><p>${(t('rpt_wealth_suggestion_template')||'理财建议：以 {fav} 为主调，稳中求进。').replace('{fav}',safeHtml(favList))}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_health_title')}</h3><p>${(t('rpt_health_placeholder_template')||'围绕最弱五行（{weak}）做优化。').replace('{weak}',safeHtml(weakest))}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_env_title')}</h3><p>${t('rpt_env_placeholder')}</p></section>
    <div id="butler-anchor"></div>`;
}
function mountFreeReport(ctx){
  const resultEl=$('result'); if(!resultEl) return;
  let freeNode=$('xl-free-report');
  if(!freeNode){ freeNode=document.createElement('div'); freeNode.id='xl-free-report'; resultEl.appendChild(freeNode); }
  freeNode.innerHTML=buildFreeReportHTML(ctx);
}
function mountRichReport(ctx){
  const resultEl=$('result'); if(!resultEl) return;
  let host=$('rich-report'); if(!host){ host=document.createElement('div'); host.id='rich-report'; resultEl.appendChild(host); }
  host.innerHTML=buildRichReportHTML(ctx);
}

/* =========================
   心怜管家：自动注入 UI + 最小可用交互
   ========================= */
function ensureButlerUI(){
  if ($('ssChatFab')) return;
  // FAB
  const fab=document.createElement('button');
  fab.id='ssChatFab';
  fab.className='ss-chat-fab';
  fab.type='button';
  fab.textContent=t('chat_fab');
  document.body.appendChild(fab);
  // Panel
  const panel=document.createElement('div');
  panel.id='ssChatPanel';
  panel.className='ss-chat-panel';
  panel.innerHTML=`
    <div class="ss-chat-head">
      <div class="ss-chat-title">${t('butler_chat_title')}</div>
      <div class="ss-close" id="ssChatClose" aria-label="Close">✕</div>
    </div>
    <div class="ss-chat-body" id="ssChatBody">
      <div class="ss-chips" id="ssChips" style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;"></div>
    </div>
    <div class="ss-chat-input">
      <input id="ssChatInput" placeholder="${t('chat_placeholder')}" />
      <button class="btn btn-mini" id="ssChatSend" type="button">${t('chat_send')}</button>
    </div>`;
  document.body.appendChild(panel);

  // 绑定
  const body = $('ssChatBody');
  function open(){ panel.style.display='block'; fab.setAttribute('aria-expanded','true'); }
  function close(){ panel.style.display='none'; fab.setAttribute('aria-expanded','false'); }
  fab.addEventListener('click', ()=>{ panel.style.display==='block'?close():open(); });
  $('ssChatClose').addEventListener('click', close);
  $('ssChatSend').addEventListener('click', handleSend);
  $('ssChatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); } });

  renderChips();
}
function renderChips(){
  const box=$('ssChips'); if(!box) return;
  const chips=[t('chip_career'),t('chip_love'),t('chip_money'),t('chip_list'),t('chip_30d')].filter(Boolean);
  box.innerHTML='';
  chips.forEach(text=>{
    const b=document.createElement('button');
    b.className='btn btn-mini';
    b.type='button';
    b.textContent=text;
    b.style.border='1px solid #e6c76e';
    b.style.background='transparent';
    b.style.color='#ffe084';
    b.addEventListener('click',()=>{ const i=$('ssChatInput'); i.value=text; i.focus(); });
    box.appendChild(b);
  });
}
function applyChatI18n(){
  const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend'), title=qs('.ss-chat-title');
  if(fab) fab.textContent=t('chat_fab');
  if(inp) inp.placeholder=t('chat_placeholder');
  if(btn) btn.textContent=t('chat_send');
  if(title) title.textContent=t('butler_chat_title');
  renderChips();
}
function botReplyFromCtx(ctx){
  if(!ctx) return t('butler_need_chart');
  const E=ELABEL();
  const dm = ctx.pillars.day.stem + '（' + (E[EL_CHAR_TO_KEY[ctx.pillars.day.element]]||'') + '）';
  const season = seasonName(ctx.st.season)||'-';
  const stName = strategyName(ctx.st.focus);
  const fav = elCharsToLocale((ctx.adv?.useful||[])).slice(0,3);
  const hint = ctx.timeUnknown ? (' ' + t('rpt_time_hint')) : '';
  return `${t('rpt_daymaster_label')}：${dm} · ${t('rpt_season_label')}：${season} · ${t('rpt_strategy_label')}：${stName}\n${t('useful_elements')}${listJoin(fav)}。${hint}`;
}
function pushMsg(text, me=false){
  const body=$('ssChatBody'); if(!body) return;
  const div=document.createElement('div');
  div.className='ss-msg'+(me?' me':'');
  div.innerHTML=safeHtml(text).replace(/\n/g,'<br>');
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}
function handleSend(){
  const input=$('ssChatInput'); if(!input) return;
  const q=(input.value||'').trim();
  if(!q) return;
  pushMsg(q, true);
  input.value='';
  // 简单基于当前命盘的应答
  pushMsg( botReplyFromCtx(lastBaziCtx), false );
}
function rerunButlerIfAny(){ applyChatI18n(); }

/* =========================
   事件绑定 & 主流程
   ========================= */
let lastBaziCtx = null;

function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem, branch=u?'？':v.branch;
    const div=document.createElement('div'); div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch));
  setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch));
  setIf('hour-element',timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch));
  setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch));
  setIf('hour-nayin',timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
}
function updateBars(pct){
  ['木','火','土','金','水'].forEach(ch=>{
    const key = ({'木':'wood','火':'fire','土':'earth','金':'metal','水':'water'})[ch];
    setBar($('bar-'+ch), Math.round((pct[key]||0)));
    setText('pct-'+ch, Math.round((pct[key]||0)) + '%');
  });
}
function elementsBalanceLine(pct){
  const E=ELABEL();
  const entries = Object.entries(pct||{});
  if(!entries.length) return '';
  const strongestK = entries.reduce((a,b)=>(a[1]>b[1]?a:b), ['wood',0])[0];
  const weakestK   = entries.reduce((a,b)=>(a[1]<b[1]?a:b), ['wood',0])[0];
  const sName = E[strongestK] || strongestK;
  const wName = E[weakestK] || weakestK;
  return (t('elements_balance_tpl')||'五行中{max}元素最强，{min}元素最弱。').replace('{max}', sName).replace('{min}', wName);
}
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'偏强':score<=1?'偏弱':'平衡';
  const focus=mark==='偏强'?'泄秀/制化':mark==='偏弱'?'生扶/补助':'调和';
  return { season, mark, focus };
}
function chooseUseful(strength, dmElem){
  if(strength==='偏强') return { strategy:'泄秀/制化',
    useful:{木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']}[dmElem], avoid:[dmElem] };
  if(strength==='偏弱') return { strategy:'生扶/补助',
    useful:{木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']}[dmElem], avoid:[] };
  return { strategy:'调和', useful:['木','火','土','金','水'], avoid:[] };
}

function onGenerate(){
  showErr('');
  const birthdate = $('birthdate')?.value;
  const timeUnknown = $('timeUnknown')?.checked;
  const birthtime = $('birthtime')?.value || '12:00';
  if(!birthdate){ showErr(t('err_need_date')); return; }
  const [y,m,d] = birthdate.split('-').map(n=>parseInt(n,10));
  let h = 12;
  if(!timeUnknown){
    const parts = birthtime.split(':').map(n=>parseInt(n,10));
    h = isFinite(parts[0]) ? parts[0] : 12;
  }
  const btn=$('genBtn'), txt=$('genBtnText'), loading=$('genBtnLoading');
  lock(btn,true); if(txt&&loading){ txt.style.display='none'; loading.style.display='inline'; }
  try{
    const res = baziCalculator.calculateBazi(y,m,d,h,timeUnknown);
    const st  = judgeStrength(res.pillars.day.stem, res.pillars.month.branch, res.counts);
    const adv = chooseUseful(st.mark, res.pillars.day.element);
    lastBaziCtx = { pillars:res.pillars, percents:res.percents, st, adv, timeUnknown:res.timeUnknown };

    $('result').style.display='block';
    renderPillars($('bazi-pillars'), res.pillars, timeUnknown);
    displayClassicArea(res.pillars, timeUnknown);
    updateBars(res.percents);
    const balEl = $('bazi-elements-balance'); if(balEl) balEl.textContent = elementsBalanceLine(res.percents);

    mountFreeReport(lastBaziCtx);
    mountRichReport(lastBaziCtx);

  }catch(e){
    console.error(e);
    showErr('服务繁忙，请稍后再试');
  }finally{
    lock(btn,false); if(txt&&loading){ txt.style.display='inline'; loading.style.display='none'; }
  }
}

function bindUI(){
  const genBtn=$('genBtn'); if(genBtn) genBtn.addEventListener('click', onGenerate);
  const chk=$('timeUnknown'), time=$('birthtime');
  if(chk && time){
    const toggle = ()=>{ time.disabled = chk.checked; time.style.opacity = chk.checked? .6 : 1; };
    chk.addEventListener('change', toggle); toggle();
  }
}
function rerenderReportsIfAny(){
  if(!lastBaziCtx) return;
  updateBars(lastBaziCtx.percents);
  const balEl=$('bazi-elements-balance'); if(balEl) balEl.textContent = elementsBalanceLine(lastBaziCtx.percents);
  mountFreeReport(lastBaziCtx);
  mountRichReport(lastBaziCtx);
}

function initLangUI(){
  const sel=$('langSelect'); if(!sel) return;
  const current=getLang(); sel.value=current; document.documentElement.lang=current;
  applyI18n(); applyChatI18n();
  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n(); applyChatI18n();
    rerenderReportsIfAny();
  });
}

window.addEventListener('DOMContentLoaded', ()=>{
  ensureButlerUI();       // 自动注入"心怜管家"
  initLangUI();           // 语言渲染
  bindUI();               // 表单交互
});

})();
</script>
</body>
</html>
