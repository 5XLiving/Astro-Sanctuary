
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* 所有CSS样式保持不变 - 已包含心怜管家样式 */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* 头部样式 */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em; font-size:1.1rem}
    
    .lang{display:flex; align-items:center; gap:8px}
    .lang select{
      appearance:none; min-width:140px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    /* 主要内容区域 */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* 八字柱样式 */
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    /* 五行能量条 */
    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0; transition:width 0.5s ease}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none; margin-top:10px;}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* 时间输入行 */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px;}

    /* 生成按钮包装 */
    .gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}
    #genBtn{width:auto !important}

    /* 详细分析区域 */
    .analysis-grid {display: grid; gap: 16px; margin-top: 20px;}
    .analysis-card {background: #0f1624; border: 1px solid #253245; border-radius: 12px; padding: 16px;}
    .analysis-card h3 {color: var(--gold2); margin: 0 0 12px 0; font-size: 1.1rem;}
    .analysis-content {line-height: 1.6;}
    .rating {display: flex; align-items: center; gap: 8px; margin: 8px 0;}
    .rating-stars {color: var(--gold2);}
    .tag {display: inline-block; background: rgba(212,175,55,.1); color: var(--gold2); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; margin: 2px;}
    
    /* 大运流年 */
    .luck-grid {display: grid; gap: 10px;}
    .luck-item {background: rgba(255,255,255,.05); border-radius: 8px; padding: 12px; border-left: 3px solid var(--gold2);}
    .luck-year {font-weight: bold; color: var(--gold2);}
    .luck-desc {font-size: 0.9rem; margin-top: 4px;}

    /* 会员区域 */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    
    /* VIP登录区域 */
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    
    /* AI管家样式 */
    .ai-box{background:#0b111a; border:1px solid #1f2a36; border-radius:12px; padding:14px 16px; margin:14px 0;}
    .ai-box-h{color:#ffd88a; font-weight:700; margin-bottom:8px;}
    .ai-box-c{color:#e8edf3; line-height:1.7;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer; transition:all 0.2s ease}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .chip:disabled{opacity:.6; cursor:not-allowed}
    
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    
    .ai-lock-overlay{margin-top:10px;padding-top:10px;border-top:1px solid #1f2a36;text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
    
    /* 详细分析页面样式 */
    .detail-view {display: none;}
    .detail-header {display: flex; align-items: center; gap: 12px; margin-bottom: 20px;}
    .back-btn {background: rgba(212,175,55,.1); border: 1px solid rgba(212,175,55,.3); color: var(--gold2); padding: 8px 16px; border-radius: 8px; cursor: pointer;}
    .detail-content {line-height: 1.8;}
    .detail-section {margin-bottom: 24px;}
    .detail-section h4 {color: var(--gold2); margin-bottom: 12px; font-size: 1.1rem;}
    .action-list {list-style: none; padding: 0;}
    .action-list li {margin-bottom: 8px; padding-left: 20px; position: relative;}
    .action-list li:before {content: "•"; color: var(--gold2); position: absolute; left: 0;}
    
    /* 聊天浮窗 - 移除相关样式 */
    
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0; margin-top:40px;}
    
    /* 响应式调整 */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:120px}
      .pillars{grid-template-columns:repeat(2,1fr);}
      .analysis-grid {grid-template-columns: 1fr;}
    }
    
    .sr-only{
       position:absolute !important;
       width:1px;height:1px;padding:0;margin:-1px;
       overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* 添加到CSS中 */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 20px 0;
      justify-content: center;
    }

    /* 在CSS部分添加VIP区域的特殊类 */
     .vip-section {
      display: block !important; /* 确保VIP区域始终显示 */
    }
        
    /* 心怜管家专业窗口 */
    .butler-professional {
        display: none;
        margin-top: 20px;
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 20px;
    }
    
    .butler-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        color: var(--gold2);
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .butler-content {
        line-height: 1.8;
        max-height: 600px;
        overflow-y: auto;
        padding: 15px;
        background: #0f1624;
        border-radius: 10px;
        border: 1px solid #253245;
    }
    
    .butler-section {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #253245;
    }
    
    .butler-section h4 {
        color: var(--gold2);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    /* 对话界面 */
    .butler-chat {
        margin-top: 20px;
        border-top: 1px solid var(--line);
        padding-top: 15px;
    }
    
    .chat-messages {
        height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
        padding: 10px;
        background: #0f1624;
        border-radius: 8px;
        border: 1px solid #253245;
    }
    
    .chat-input-area {
        display: flex;
        gap: 10px;
    }
    
    .chat-input-area input {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #253245;
        background: #0e1520;
        color: var(--text);
    }
    
    .chat-send-btn {
        padding: 10px 20px;
        background: var(--gold);
        color: #191919;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }

    /* 移除聊天浮窗相关样式 */
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="#" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving · 八字简评</span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 1. 八字排盘表单 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar">
          <option value="gregorian">阳历</option>
          <option value="lunar">农历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-row">
          <input type="time" id="birthtime" />
          <label class="muted time-unknown">
            <input type="checkbox" id="timeUnknown" />
            <span>出生时间不详</span>
          </label>
        </div>
      </div>
      <div class="gen-wrap">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果显示区域 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- 2. 心怜管家专业窗口 -->
  <section id="butlerProfessional" class="butler-professional">
    <div class="butler-header">
      <span>🧙‍♂️ 心怜管家 · 专业命理分析</span>
    </div>
    
    <div class="butler-content" id="professionalReport">
      <!-- AI生成的专业报告将渲染在这里 -->
    </div>
    
    <div class="butler-chat">
      <div class="chat-messages" id="chatMessages">
        <div class="ss-msg">您好！我是您的专业命理顾问，已为您生成详细分析报告。有什么具体问题可以随时问我。</div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="请输入您的问题...">
        <button class="chat-send-btn" id="chatSend">发送</button>
      </div>
    </div>
  </section>

  <!-- 3. 会员区域 -->
  <section class="card section vip-section">
    <h2 class="group-title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">🗝 命理空间专属内容</div>
        <ul>
          <li>姻缘方向：恋爱缘分、婚姻走势</li>
          <li>事业方向：职场发展、创业潜力</li>
          <li>财运方向：财位分析、理财时机</li>
          <li>宠物命理：伴侣动物的性格与缘分</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">🌙 心怜空间专属内容</div>
        <ul>
          <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li>命理课程：八字 / 塔罗 / 占星 / 灵数</li>
          <li>家族纪念系统：亲人灵性纪念 & 延续</li>
          <li>每周能量练习 / 神明仪式任务</li>
        </ul>
      </div>
    </div>

    <!-- VIP登录区域 -->
    <div class="group-title" style="margin-top:14px">💎 登入 VIP 功能</div>
    <section class="astro-auth">
      <div class="auth-grid">
        <!-- 左侧：输入 + 注册/登录 -->
        <div class="panel">
          <div class="head">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="邮箱 Email" required />
              <input id="password" name="password" type="password" autocomplete="current-password" placeholder="密码 Password（至少8位，含大小写数字符号）" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit">登入账户</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button">🔑 重设密码</button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit">注册账户</button>
              <div class="muted">注册账号赠送一次免费体验</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- 右侧：会员与返回 -->
        <div class="panel">
          <div class="head">会员服务</div>
          <div class="body">
            <div class="row one">
              <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">💎 升级为 VIP（月费）</a>
            </div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">← 返回命理商城</a>
            </div>
            <div class="muted">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<script>        
// 八字计算器类
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  
  calculateYearPillar(year){ 
    const s=(year-4)%10, b=(year-4)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(s+10)%10],
      branch: this.EARTHLY_BRANCHES[(b+12)%12],
      zodiac: this.ZODIAC[(b+12)%12]
    }; 
  }
  
  solarMonthIndex(y,m,d){ 
    const mmdd=m*100+d; 
    const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; 
    let idx=11; 
    for(const [thr,val] of gates) if(mmdd>=thr) idx=val; 
    const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; 
    return {index:idx, branch:branchBy[idx]}; 
  }
  
  calculateMonthPillar(year,month,day){ 
    const {index,branch}=this.solarMonthIndex(year,month,day); 
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); 
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; 
    const stemIdx=(startMap[yStemIdx]+(index-1))%10; 
    return {stem:this.HEAVENLY_STEMS[stemIdx], branch}; 
  }
  
  calculateDayPillar(year,month,day){ 
    const baseUTC=Date.UTC(1900,0,31); 
    const targetUTC=Date.UTC(year,month-1,day); 
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); 
    const stemIdx=(0+dayDiff)%10; 
    const branchIdx=(4+dayDiff)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10],
      branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12]
    }; 
  }
  
  calculateHourPillar(dayStem,hour){ 
    const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; 
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; 
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); 
    const hourIndex=Math.floor((hour+1)/2)%12; 
    const stemIdx=(startMap[dayIdx]+hourIndex)%10; 
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    }; 
  }
  
  getElement(stem,branch){ 
    const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; 
    const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; 
    return `${s[stem]}${b[branch]}`; 
  }
  
  getNayin(stem,branch){ 
    const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); 
    return this.NAYIN[(si*2+bi)%this.NAYIN.length]; 
  }
  
  getStemElement(stem){ 
    return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; 
  }
  
  getBranchElement(branch){ 
    return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; 
  }
  
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), 
          monthP=this.calculateMonthPillar(year,month,day), 
          dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ 
      if(p.stem&&p.stem!=='？') cnt[this.getStemElement(p.stem)]+=1; 
      if(p.branch&&p.branch!=='？') cnt[this.getBranchElement(p.branch)]+=1; 
    });
    
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={
      wood: cnt['木']/total*100,
      fire: cnt['火']/total*100,
      earth: cnt['土']/total*100, 
      metal: cnt['金']/total*100,
      water: cnt['水']/total*100
    };
    
    return {pillars, counts:cnt, percents:pct, timeUnknown};
  }
}

const baziCalculator = new BaziCalculator();

// 工具函数
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function showAuthErr(message) {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }
}

function hideAuthErr() {
  const errorEl = $('authError');
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
}

function lock(el, v) { if(el) el.disabled = v; }

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setBar(elementId, percentage) {
  const bar = $(elementId);
  if (bar) {
    setTimeout(() => {
      bar.style.width = Math.max(0, Math.min(100, percentage)) + '%';
    }, 100);
  }
}

// 渲染八字柱
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: '年柱', pillar: pillars.year },
    { title: '月柱', pillar: pillars.month },
    { title: '日柱', pillar: pillars.day },
    { title: '时柱', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === '时柱' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? '？' : pillar.stem}${isUnknown ? '？' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// 显示详细信息表格
function displayDetailedInfo(pillars, timeUnknown = false) {
  // 天干地支
  setText('year-stem', pillars.year.stem);
  setText('year-branch', pillars.year.branch);
  setText('month-stem', pillars.month.stem);
  setText('month-branch', pillars.month.branch);
  setText('day-stem', pillars.day.stem);
  setText('day-branch', pillars.day.branch);
  setText('hour-stem', timeUnknown ? '？' : pillars.hour.stem);
  setText('hour-branch', timeUnknown ? '？' : pillars.hour.branch);

  // 五行
  setText('year-element', baziCalculator.getElement(pillars.year.stem, pillars.year.branch));
  setText('month-element', baziCalculator.getElement(pillars.month.stem, pillars.month.branch));
  setText('day-element', baziCalculator.getElement(pillars.day.stem, pillars.day.branch));
  setText('hour-element', timeUnknown ? '未知' : baziCalculator.getElement(pillars.hour.stem, pillars.hour.branch));

  // 纳音
  setText('year-nayin', baziCalculator.getNayin(pillars.year.stem, pillars.year.branch));
  setText('month-nayin', baziCalculator.getNayin(pillars.month.stem, pillars.month.branch));
  setText('day-nayin', baziCalculator.getNayin(pillars.day.stem, pillars.day.branch));
  setText('hour-nayin', timeUnknown ? '未知' : baziCalculator.getNayin(pillars.hour.stem, pillars.hour.branch));
}

// 专业报告生成函数
// 专业报告生成函数 - 根据实际八字动态分析
async function generateProfessionalReport(baziData) {
    const pillars = baziData.pillars;
    const counts = baziData.counts;
    const gender = baziData.gender || '未透露';
    
    const baziString = `${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${pillars.hour.stem}${pillars.hour.branch}`;
    
    // 基于实际八字数据动态分析
    const dayStem = pillars.day.stem;
    const dayElement = pillars.day.element;
    const monthBranch = pillars.month.branch;
    
    // 动态分析格局
    const patterns = analyzePatterns(pillars, counts);
    const tenGodsAnalysis = analyzeTenGods(pillars);
    const usefulGods = analyzeUsefulGods(pillars, counts);
    const careerAnalysis = analyzeCareer(pillars, counts, gender);
    const wealthAnalysis = analyzeWealth(pillars, counts);
    const loveAnalysis = analyzeLove(pillars, counts, gender);
    const spiritualAnalysis = analyzeSpiritual(pillars);
    const yearlyAnalysis = analyzeNext3Years(pillars);
    
    return `
        <div class="butler-section">
            <h4>🔮 一、格局层次</h4>
            <p><strong>八字：</strong>${baziString}</p>
            <p><strong>日主：</strong>${dayStem}${dayElement}</p>
            <p><strong>五行分布：</strong>木${counts.木}% 火${counts.火}% 土${counts.土}% 金${counts.金}% 水${counts.水}%</p>
            <p><strong>主要格局：</strong></p>
            <ul>
                ${patterns.map(pattern => `<li><strong>${pattern.name}</strong> - ${pattern.description}</li>`).join('')}
            </ul>
            <p><strong>格局等级：</strong>${patterns[0]?.level || '需详细分析'}</p>
        </div>

        <div class="butler-section">
            <h4>⚔️ 二、十神配置分析</h4>
            ${tenGodsAnalysis}
        </div>

        <div class="butler-section">
            <h4>💎 三、用神喜忌</h4>
            ${usefulGods}
        </div>

        <div class="butler-section">
            <h4>🎯 四、事业发展</h4>
            ${careerAnalysis}
        </div>

        <div class="butler-section">
            <h4>💰 五、财运分析</h4>
            ${wealthAnalysis}
        </div>

        <div class="butler-section">
            <h4>❤️ 六、爱情分析</h4>
            ${loveAnalysis}
        </div>

        <div class="butler-section">
            <h4>🔮 七、玄学缘分</h4>
            ${spiritualAnalysis}
        </div>

        <div class="butler-section">
            <h4>📅 八、流年详批（未来3年）</h4>
            ${yearlyAnalysis}
        </div>
    `;
}

// 动态格局分析函数
function analyzePatterns(pillars, counts) {
    const patterns = [];
    const dayStem = pillars.day.stem;
    const monthBranch = pillars.month.branch;
    
    // 建禄格判断
    const jianLuBranches = {
        '甲': '寅', '乙': '卯', '丙': '巳', '丁': '午', '戊': '巳',
        '己': '午', '庚': '申', '辛': '酉', '壬': '亥', '癸': '子'
    };
    
    if (monthBranch === jianLuBranches[dayStem]) {
        patterns.push({
            name: '建禄格',
            level: '强格',
            description: '日主得月令，根基深厚，自强不息'
        });
    }
    
    // 木火通明格判断
    if ((counts.木 >= 25 && counts.火 >= 25) && (dayStem === '甲' || dayStem === '乙' || dayStem === '丙' || dayStem === '丁')) {
        patterns.push({
            name: '木火通明格',
            level: '贵格',
            description: '木火相生，文明之象，文采出众'
        });
    }
    
    // 从强格判断
    if (counts[getElementFromStem(dayStem)] >= 40) {
        patterns.push({
            name: '从强格',
            level: '特殊格局',
            description: '日主极旺，顺势而为'
        });
    }
    
    // 财官双美判断
    const wealthGods = countWealthGods(pillars, dayStem);
    const officerGods = countOfficerGods(pillars, dayStem);
    if (wealthGods >= 1 && officerGods >= 1) {
        patterns.push({
            name: '财官双美',
            level: '佳格',
            description: '财运与事业运俱佳'
        });
    }
    
    return patterns.length > 0 ? patterns : [{
        name: '普通格局',
        level: '需详细分析',
        description: '格局组合较为平衡'
    }];
}

// 十神分析函数
function analyzeTenGods(pillars) {
    const tenGodsMap = {
        '甲': { '甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印' },
        '乙': { '甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印' },
        // 其他天干的十神映射...
    };
    
    const dayStem = pillars.day.stem;
    let analysis = '';
    
    // 年柱十神
    const yearGod = tenGodsMap[dayStem]?.[pillars.year.stem] || '未知';
    analysis += `<p><strong>年柱：</strong>${yearGod}坐${getBranchElement(pillars.year.branch)} - ${getTenGodDescription(yearGod, '年')}</p>`;
    
    // 月柱十神
    const monthGod = tenGodsMap[dayStem]?.[pillars.month.stem] || '未知';
    analysis += `<p><strong>月柱：</strong>${monthGod}坐${getBranchElement(pillars.month.branch)} - ${getTenGodDescription(monthGod, '月')}</p>`;
    
    // 日柱十神（日主）
    analysis += `<p><strong>日柱：</strong>${dayStem}${getElementFromStem(dayStem)}日主坐${getBranchElement(pillars.day.branch)} - 自我认知与根基</p>`;
    
    // 时柱十神
    const hourGod = tenGodsMap[dayStem]?.[pillars.hour.stem] || '未知';
    analysis += `<p><strong>时柱：</strong>${hourGod}坐${getBranchElement(pillars.hour.branch)} - ${getTenGodDescription(hourGod, '时')}</p>`;
    
    return analysis;
}

// 用神分析函数
function analyzeUsefulGods(pillars, counts) {
    const dayStem = pillars.day.stem;
    const dayElement = getElementFromStem(dayStem);
    
    // 简单的身强身弱判断
    const totalElements = Object.values(counts).reduce((a, b) => a + b, 0);
    const selfStrength = counts[dayElement] / totalElements * 100;
    
    let bodyStrength, usefulGods, avoidGods;
    
    if (selfStrength >= 30) {
        bodyStrength = '身强';
        usefulGods = getControllingElements(dayElement); // 克泄耗
        avoidGods = getSupportingElements(dayElement);   // 生扶
    } else {
        bodyStrength = '身弱';
        usefulGods = getSupportingElements(dayElement);  // 生扶
        avoidGods = getControllingElements(dayElement);  // 克泄耗
    }
    
    return `
        <p><strong>身强分析：</strong>${bodyStrength}，${dayStem}${dayElement}日主占比${Math.round(selfStrength)}%</p>
        <p><strong>喜用神：</strong>${usefulGods.join('、')}</p>
        <p><strong>忌神：</strong>${avoidGods.join('、')}</p>
        <p><strong>调候建议：</strong>${getSeasonalAdvice(pillars.month.branch, dayElement)}</p>
    `;
}

// 辅助函数
function getElementFromStem(stem) {
    const stemElements = {
        '甲':'木', '乙':'木', '丙':'火', '丁':'火', '戊':'土', 
        '己':'土', '庚':'金', '辛':'金', '壬':'水', '癸':'水'
    };
    return stemElements[stem] || '未知';
}

function getBranchElement(branch) {
    const branchElements = {
        '子':'水', '丑':'土', '寅':'木', '卯':'木', '辰':'土',
        '巳':'火', '午':'火', '未':'土', '申':'金', '酉':'金', 
        '戌':'土', '亥':'水'
    };
    return branchElements[branch] || '未知';
}

function getSupportingElements(element) {
    const supportive = {
        '木': ['水', '木'], // 水生木，木助木
        '火': ['木', '火'], // 木生火，火助火
        '土': ['火', '土'], // 火生土，土助土
        '金': ['土', '金'], // 土生金，金助金
        '水': ['金', '水']  // 金生水，水助水
    };
    return supportive[element] || [];
}

function getControllingElements(element) {
    const controlling = {
        '木': ['金', '火', '土'], // 金克木，火泄木，木克土
        '火': ['水', '土', '金'], // 水克火，土泄火，火克金
        '土': ['木', '金', '水'], // 木克土，金泄土，土克水
        '金': ['火', '水', '木'], // 火克金，水泄金，金克木
        '水': ['土', '木', '火']  // 土克水，木泄水，水克火
    };
    return controlling[element] || [];
}

// 其他分析函数（事业、财运、爱情等）需要类似地根据实际八字数据动态生成
function analyzeCareer(pillars, counts, gender) {
    // 基于八字数据动态生成事业分析
    const dayElement = getElementFromStem(pillars.day.stem);
    const suitableCareers = getSuitableCareers(dayElement, counts);
    
    return `
        <p><strong>最佳领域：</strong></p>
        <ul>
            ${suitableCareers.map(career => `<li><strong>${career.field}</strong> - ${career.reason}</li>`).join('')}
        </ul>
        <p><strong>发展建议：</strong>${getCareerAdvice(pillars, counts)}</p>
    `;
}

// 类似的，需要实现 analyzeWealth, analyzeLove, analyzeSpiritual, analyzeNext3Years 等函数

// 初始化聊天功能
function initButlerChat() {
    const chatSend = document.getElementById('chatSend');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    
    if (!chatSend || !chatInput) return;
    
    chatSend.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
    });
    
    function sendChatMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // 添加用户消息
        const userMsg = document.createElement('div');
        userMsg.className = 'ss-msg me';
        userMsg.textContent = message;
        chatMessages.appendChild(userMsg);
        
        chatInput.value = '';
        
        // 模拟AI回复
        setTimeout(() => {
            const aiMsg = document.createElement('div');
            aiMsg.className = 'ss-msg';
            aiMsg.textContent = '这是一个很好的问题，让我结合您的命盘为您详细分析...';
            chatMessages.appendChild(aiMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 1000);
    }
}

// 页面加载初始化
function init() {
    // 设置默认日期为今天
    const birthdateInput = $('birthdate');
    if (birthdateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        birthdateInput.value = `${year}-${month}-${day}`;
    }

    // 设置默认时间为当前时间
    const birthtimeInput = $('birthtime');
    if (birthtimeInput) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        birthtimeInput.value = `${hours}:${minutes}`;
    }

    // 绑定事件
    const genBtn = $('genBtn');
    if (genBtn) {
        genBtn.addEventListener('click', generateBaziChart);
    }

    // 初始化聊天功能
    initButlerChat();

    // 初始化时间未知功能
    const timeUnknown = $('timeUnknown');
    const birthtime = $('birthtime');
    if (timeUnknown && birthtime) {
        timeUnknown.addEventListener('change', () => {
            birthtime.disabled = timeUnknown.checked;
            if (timeUnknown.checked) {
                birthtime.value = '';
            }
        });
    }

    console.log('八字命理系统初始化完成');
}

// 页面加载完成后初始化
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
</body>
</html>
