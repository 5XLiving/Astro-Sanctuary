<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="description" content="命理心怜空间 · 免费体验与VIP：八字、占星、灵数、塔罗、九星气学、能量类型。一站式灵性与命理体验。" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    --gold:#d4af37; --gold2:#f2d27a; --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22);
  }

  html,body{height:100%}
  html{font-size:16px}
  @media(min-width:768px){html{font-size:17px}}
  @media(min-width:1200px){html{font-size:18px}}

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Noto Sans SC", "Segoe UI", Roboto, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }

  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
  header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
  .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em;font-size:1.1rem}
  .subtitle{color:var(--muted);font-size:.9rem}

  .section{margin-top:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);padding:18px;margin:16px 0}
  .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
  .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

  .row{display:grid;gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr} }
  .row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} }

  input,select,button{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
    padding:12px 12px;font-size:15px;outline:none;
  }
  input::placeholder{color:#6f8092}
  .muted{color:var(--muted)}

  .btn{
    display:inline-grid;place-items:center;text-decoration:none;
    padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;cursor:pointer;
    font-weight:700;letter-spacing:.3px;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    box-shadow:0 6px 18px rgba(230,199,110,.4);transition:.15s;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.block{display:block;width:100%}

  /* 八字结果 */
  .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
  .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
  .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

  .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
  .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
  .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

  .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
  .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
  .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}

  .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
  .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}

  /* VIP / 登录 */
  .columns{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
  .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
  .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
  @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .panel .head{padding:16px 18px;border-bottom:1px solid var(--border);color:var(--gold);font-weight:700;letter-spacing:.3px}
  .panel .body{padding:18px}
  .astro-auth .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media(max-width:640px){ .astro-auth .row{grid-template-columns:1fr} }
  .row.one{grid-template-columns:1fr}
  .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">命理供门 · 八字简评</div>
  </div>
</header>

<main class="container">
  <!-- 排盘卡片 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>

    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）" />
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar">
          <option value="gregorian">阳历 / Gregorian</option>
          <option value="lunar">农历 / Lunar</option>
        </select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime" value="12:00" />
        <label class="muted" style="display:block;margin-top:6px">
          <input type="checkbox" id="timeUnknown" /> 出生时间不详
        </label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>

    <!-- 顶部错误位（只用于排盘） -->
    <div id="calcError" class="error-message"></div>
  </section>

  <!-- 结果区 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead>
          <tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr>
        </thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- 会员专区（原样保留） -->
  <section class="card section">
    <h2 class="group-title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">🗝 命理空间专属内容</div>
        <ul>
          <li>姻缘方向：恋爱缘分、婚姻走势</li>
          <li>事业方向：职场发展、创业潜力</li>
          <li>财运方向：财位分析、理财时机</li>
          <li>宠物命理：伴侣动物的性格与缘分</li>
          <li>合盘分析：婚期择日、新生择时</li>
          <li>测名分析：公司名、宝宝名、命名改运</li>
          <li>财位合盘：住家 / 办公室动线配合</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">🌙 心怜空间专属内容</div>
        <ul>
          <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li>命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
          <li>家族纪念系统：亲人灵性纪念 & 延续</li>
          <li>每周能量练习 / 神明仪式任务</li>
          <li>能量商城专属折扣 & 御守订制</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px">💎 登入 VIP 功能</div>

    <section class="astro-auth">
      <div class="auth-grid">
        <!-- 左：登录/注册 -->
        <div class="panel">
          <div class="head">账户登录 / 注册</div>
          <div class="body">
            <div class="row" id="authFields">
              <label for="email" class="sr-only">Email</label>
              <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="邮箱 Email" required />
              <input id="password" type="password" autocomplete="new-password" placeholder="密码（至少8位，含大小写数字符号）" required />
            </div>

            <div class="row one" style="margin-top:12px">
              <form id="loginForm" class="row one"><button class="btn block" id="loginBtn" type="submit">登入账户</button></form>
            </div>

            <div class="row one" style="margin-top:12px">
              <button class="btn ghost block" id="resetBtn" type="button">🔑 重设密码</button>
            </div>

            <div class="row one" style="margin-top:12px">
              <form id="registerForm" class="row one"><button class="btn block" id="registerBtn" type="submit">注册账户</button></form>
            </div>

            <div class="muted" style="margin-top:10px">注册账号赠送一次免费体验</div>

            <!-- 登录错误位（与上面 calcError 分开） -->
            <div class="error-message" id="authError" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- 右：会员与返回 -->
        <div class="panel">
          <div class="head">会员服务</div>
          <div class="body">
            <div class="row one">
              <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">💎 升级为 VIP（月费）</a>
            </div>
            <div class="row one" style="margin-top:12px">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">← 返回命理商城</a>
            </div>
            <div class="muted" style="margin-top:12px">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
          </div>
        </div>
      </div>
    </section>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<script>
'use strict';

/* ====== 基本配置 ====== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

/* 是否启用右下角“心怜管家聊天浮窗”（默认 false 以免“多窗口”） */
const ENABLE_BUTLER_CHAT = false;

/* ====== 工具函数（已拆成两处错误位） ====== */
const $ = (id) => document.getElementById(id);
const on = (id, evt, fn) => { const el=$(id); el && el.addEventListener(evt, fn); };

function showCalcErr(msg){ const e=$("calcError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>e.style.display="none", 5000); }
function showAuthErr(msg){ const e=$("authError"); if(!e) return; e.textContent=msg; e.style.display="block"; setTimeout(()=>e.style.display="none", 5000); }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ====== 八字计算器（保持你原算法） ====== */
class BaziCalculator{
  constructor(){ this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸']; this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥']; this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪']; this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水']; }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='？')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

/* ====== 规则/渲染 ====== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem,branch=u?'？':v.branch;
    const div=document.createElement('div'); div.className='pillar'; div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`; root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
}

/* ====== 强弱与喜用（简版） ====== */
function judgeStrength(dayGan,monthZhi,cnt){
  const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'偏强':(score<=1?'偏弱':'平衡');
  const focus=mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和');
  return{season,mark,focus};
}
function chooseUseful(strength,dmElem){
  if(strength==='偏强') return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]};
  if(strength==='偏弱') return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]};
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}

/* ====== 生成命盘 ====== */
async function genChart(){
  const birth=($('birthdate')?.value||'').trim();
  const timeUnknown=$('timeUnknown')?.checked||false;
  if(!birth){ showCalcErr('请填写出生日期。'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D]=birth.split('-').map(Number);
    let hour=12;
    if(!timeUnknown){ const t=($('birthtime')?.value||'').trim(); if(t) hour=parseInt(t.split(':')[0],10); }

    const {pillars,counts,percents,timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    $('result').style.display='block';
    const timeText=tu?'时间不详':(hour+'时');
    setText('bazi-date',`出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if(tu){ const el=$('bazi-date'); el&&(el.innerHTML+=' <span class="badge-warn">未纳入时柱</span>'); }

    renderPillars($('bazi-pillars'),pillars,tu);
    displayClassicArea(pillars,tu);
    setBar($('bar-木'),percents.wood);  setText('pct-木',Math.round(percents.wood)+'%');
    setBar($('bar-火'),percents.fire);  setText('pct-火',Math.round(percents.fire)+'%');
    setBar($('bar-土'),percents.earth); setText('pct-土',Math.round(percents.earth)+'%');
    setBar($('bar-金'),percents.metal); setText('pct-金',Math.round(percents.metal)+'%');
    setBar($('bar-水'),percents.water); setText('pct-水',Math.round(percents.water)+'%');

    const st=judgeStrength(pillars.day.stem,pillars.month.branch,counts);
    const adv=chooseUseful(st.mark,pillars.day.element);
    const keys=Object.keys(counts);
    const maxK=keys.reduce((a,b)=>counts[a]>counts[b]?a:b);
    const minK=keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance',`五行中${maxK}元素最强，${minK}元素最弱。`);

    // 控制台校验
    console.log('实际 →', pillars.year.stem+pillars.year.branch, pillars.month.stem+pillars.month.branch, pillars.day.stem+pillars.day.branch, tu?'？':(pillars.hour.stem+pillars.hour.branch));
  }catch(err){
    console.error(err);
    showCalcErr('计算八字时出现错误，请重试');
  }finally{
    if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none';
  }
}

/* ====== 登录流程（与重设） ====== */
async function safeJson(resp){ try{return await resp.json()}catch{return{ok:false,msg:'upstream_error'}} }
async function loginFlow(email,password){
  const res=await safeJson(await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
  const msg=(res.msg||"").toString().toLowerCase(); let expired=false;
  if(res.expired===true) expired=true; else if(msg==='expired') expired=true; else if(res.expiresAt){ const ts=Date.parse(res.expiresAt); if(!Number.isNaN(ts)&&ts<Date.now()) expired=true; }
  if(expired){ const go=confirm('会员已过期，请续费。是否前往续费？'); if(go) window.open('https://yourshopifyshop.com/products/monthly-vip','_blank'); return; }
  if(res.ok===true){ localStorage.setItem('vipEmail',res.email||email); location.href='https://astro.5xliving.com/vip_soul_sanctuary.html'; return; }
  if(msg==='no_account') return showAuthErr('账户不存在，请先注册');
  if(msg==='wrong_pwd')  return showAuthErr('密码错误');
  return showAuthErr('登入失败：'+(res.msg||''));
}

/* ====== 单次初始化防重 ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  if (window.__XL_INITED__) return;  // 防止重复初始化
  window.__XL_INITED__ = true;

  // 默认日期
  const today=new Date(); const def=today.toISOString().split('T')[0];
  if($('birthdate')&&!$('birthdate').value) $('birthdate').value=def;

  on('genBtn','click',genChart);

  // 账号相关
  on('registerForm','submit', async (e)=>{
    e.preventDefault();
    const email=$('email').value.trim(), password=$('password').value.trim();
    if(!email||!password) return showAuthErr('请输入邮箱与密码');
    if(!strongPwd(password)) return showAuthErr('密码至少8位，需含大小写/数字/符号');
    lock($('registerBtn'),true);
    try{
      const res=await safeJson(await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
      if(res.ok===true){ localStorage.setItem('vipEmail',email); location.href='vip_trial.html'; return; }
      if((res.msg||"").toString()==='exists'){ await loginFlow(email,password); return; }
      showAuthErr('注册失败：'+(res.msg||'')); 
    }catch(err){ showAuthErr('注册失败：'+(err?.message||'')); }
    finally{ lock($('registerBtn'),false); }
  });

  on('loginForm','submit', async (e)=>{
    e.preventDefault();
    const email=$('email').value.trim(), password=$('password').value.trim();
    if(!email||!password) return showAuthErr('请输入邮箱与密码');
    lock($('loginBtn'),true);
    try{ await loginFlow(email,password); }
    catch(err){ showAuthErr('登入失败：'+(err?.message||'')); }
    finally{ lock($('loginBtn'),false); }
  });

  on('resetBtn','click', async ()=>{
    let email=prompt('请输入注册邮箱：'); if(email===null) return; email=email.trim();
    if(!email) return showAuthErr('邮箱不能为空');
    let newPwd=prompt('请输入新密码（至少8位，含大小写、数字、符号）：'); if(newPwd===null) return; newPwd=newPwd.trim();
    if(!newPwd) return showAuthErr('密码不能为空');
    if(!strongPwd(newPwd)) return showAuthErr('密码至少8位，需含大小写/数字/符号');
    lock($('resetBtn'),true);
    try{
      const res=await safeJson(await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword:newPwd})}));
      if(!res.ok) return showAuthErr('重设失败：'+(res.msg||'')); 
      alert('密码已成功更新，请用新密码重新登入。');
    }catch(err){ showAuthErr('重设失败：'+(err?.message||'')); }
    finally{ lock($('resetBtn'),false); }
  });

  // （可选）右下角心怜管家浮窗
  if (ENABLE_BUTLER_CHAT) {
    // 如需启用，再补：创建 #ssChatFab/#ssChatPanel，并绑定事件
  }
});

/* 自测样例（控制台对比） */
(function(){
  const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12);
  console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
  console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
