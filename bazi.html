<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>八字命理 · 快速排盘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <style>
    /* 简化CSS以便调试 */
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a;
      --radius:14px;
    }
    body{
      color:var(--text); background: #0b0f14;
      font-family: system-ui, -apple-system, sans-serif;
      margin:0; padding:20px;
    }
    .container{max-width:1100px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084}
    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);}
    .btn{padding:12px 16px;border-radius:12px;background:var(--gold);color:#191919;font-weight:800;cursor:pointer;border:none;}
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px; margin-bottom:20px;}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
    .butler-professional{display:none;margin-top:20px;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:20px;}
    .butler-header{color:var(--gold2);font-size:1.2rem;font-weight:bold;margin-bottom:20px;}
    .butler-content{line-height:1.8;padding:15px;background:#0f1624;border-radius:10px;border:1px solid #253245;}
    .butler-section{margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid #253245;}
    .butler-section h4{color:var(--gold2);margin-bottom:10px;}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none;margin-top:10px;}
  </style>
</head>
<body>
<div class="container">
  <!-- 八字排盘表单 -->
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label>姓名（可选）</label>
        <input id="name" placeholder="你的称呼" />
      </div>
      <div>
        <label>性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
        </select>
      </div>
      <div>
        <label>历法</label>
        <select id="calendar">
          <option value="gregorian">阳历</option>
        </select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label>出生日期</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label>出生时间</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="time" id="birthtime" style="width:auto" />
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="timeUnknown" />
            <span>出生时间不详</span>
          </label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-end">
        <button class="btn" id="genBtn" type="button">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>
    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果显示区域 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div id="bazi-date" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- 心怜管家专业窗口 -->
  <section id="butlerProfessional" class="butler-professional">
    <div class="butler-header">🧙‍♂️ 心怜管家 · 专业命理分析</div>
    <div class="butler-content" id="professionalReport"></div>
  </section>
</div>

<script>
// 八字计算器类
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
  }
  
  calculateYearPillar(year){ 
    const s=(year-4)%10, b=(year-4)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(s+10)%10],
      branch: this.EARTHLY_BRANCHES[(b+12)%12]
    }; 
  }
  
  solarMonthIndex(y,m,d){ 
    const mmdd=m*100+d; 
    const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; 
    let idx=11; 
    for(const [thr,val] of gates) if(mmdd>=thr) idx=val; 
    const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; 
    return {index:idx, branch:branchBy[idx]}; 
  }
  
  calculateMonthPillar(year,month,day){ 
    const {index,branch}=this.solarMonthIndex(year,month,day); 
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); 
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; 
    const stemIdx=(startMap[yStemIdx]+(index-1))%10; 
    return {stem:this.HEAVENLY_STEMS[stemIdx], branch}; 
  }
  
  calculateDayPillar(year,month,day){ 
    const baseUTC=Date.UTC(1900,0,31); 
    const targetUTC=Date.UTC(year,month-1,day); 
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); 
    const stemIdx=(0+dayDiff)%10; 
    const branchIdx=(4+dayDiff)%12; 
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10],
      branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12]
    }; 
  }
  
  calculateHourPillar(dayStem,hour){ 
    const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; 
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; 
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); 
    const hourIndex=Math.floor((hour+1)/2)%12; 
    const stemIdx=(startMap[dayIdx]+hourIndex)%10; 
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    }; 
  }
  
  getStemElement(stem){ 
    return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; 
  }
  
  getBranchElement(branch){ 
    return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; 
  }
  
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), 
          monthP=this.calculateMonthPillar(year,month,day), 
          dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ 
      if(p.stem&&p.stem!=='？') cnt[this.getStemElement(p.stem)]+=1; 
      if(p.branch&&p.branch!=='？') cnt[this.getBranchElement(p.branch)]+=1; 
    });
    
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={
      wood: cnt['木']/total*100,
      fire: cnt['火']/total*100,
      earth: cnt['土']/total*100, 
      metal: cnt['金']/total*100,
      water: cnt['水']/total*100
    };
    
    return {pillars, counts:cnt, percents:pct, timeUnknown};
  }
}

const baziCalculator = new BaziCalculator();
const $ = id => document.getElementById(id);

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }
}

// 渲染八字柱
function renderPillars(pillars, timeUnknown = false) {
  const container = $('bazi-pillars');
  if (!container) return;

  container.innerHTML = '';
  
  const pillarData = [
    { title: '年柱', pillar: pillars.year },
    { title: '月柱', pillar: pillars.month },
    { title: '日柱', pillar: pillars.day },
    { title: '时柱', pillar: pillars.hour }
  ];

  pillarData.forEach(({ title, pillar }) => {
    const isUnknown = (title === '时柱' && timeUnknown);
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${title}</div>
      <div class="gz">${isUnknown ? '？' : pillar.stem}${isUnknown ? '？' : pillar.branch}</div>
    `;
    container.appendChild(div);
  });
}

// 专业报告生成函数 - 根据实际八字动态分析
async function generateProfessionalReport(baziData) {
    const pillars = baziData.pillars;
    const counts = baziData.counts;
    const gender = baziData.gender || '未透露';
    
    const baziString = `${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${pillars.hour.stem}${pillars.hour.branch}`;
    
    // 基于实际八字数据动态分析
    const dayStem = pillars.day.stem;
    const dayElement = pillars.day.element;
    
    // 动态分析格局
    const patterns = analyzePatterns(pillars, counts);
    const tenGodsAnalysis = analyzeTenGods(pillars);
    const usefulGods = analyzeUsefulGods(pillars, counts);
    const careerAnalysis = analyzeCareer(pillars, counts, gender);
    const wealthAnalysis = analyzeWealth(pillars, counts);
    const loveAnalysis = analyzeLove(pillars, counts, gender);
    const spiritualAnalysis = analyzeSpiritual(pillars);
    const yearlyAnalysis = analyzeNext3Years(pillars);
    
    return `
        <div class="butler-section">
            <h4>🔮 一、格局层次</h4>
            <p><strong>八字：</strong>${baziString}</p>
            <p><strong>日主：</strong>${dayStem}${dayElement}</p>
            <p><strong>五行分布：</strong>木${Math.round(counts.木)}% 火${Math.round(counts.火)}% 土${Math.round(counts.土)}% 金${Math.round(counts.金)}% 水${Math.round(counts.水)}%</p>
            <p><strong>主要格局：</strong></p>
            <ul>
                ${patterns.map(pattern => `<li><strong>${pattern.name}</strong> - ${pattern.description}</li>`).join('')}
            </ul>
            <p><strong>格局等级：</strong>${patterns[0]?.level || '需详细分析'}</p>
        </div>

        <div class="butler-section">
            <h4>⚔️ 二、十神配置分析</h4>
            ${tenGodsAnalysis}
        </div>

        <div class="butler-section">
            <h4>💎 三、用神喜忌</h4>
            ${usefulGods}
        </div>

        <div class="butler-section">
            <h4>🎯 四、事业发展</h4>
            ${careerAnalysis}
        </div>

        <div class="butler-section">
            <h4>💰 五、财运分析</h4>
            ${wealthAnalysis}
        </div>

        <div class="butler-section">
            <h4>❤️ 六、爱情分析</h4>
            ${loveAnalysis}
        </div>

        <div class="butler-section">
            <h4>🔮 七、玄学缘分</h4>
            ${spiritualAnalysis}
        </div>

        <div class="butler-section">
            <h4>📅 八、流年详批（未来3年）</h4>
            ${yearlyAnalysis}
        </div>
    `;
}

// 动态格局分析函数
function analyzePatterns(pillars, counts) {
    const patterns = [];
    const dayStem = pillars.day.stem;
    const monthBranch = pillars.month.branch;
    
    // 建禄格判断
    const jianLuBranches = {
        '甲': '寅', '乙': '卯', '丙': '巳', '丁': '午', '戊': '巳',
        '己': '午', '庚': '申', '辛': '酉', '壬': '亥', '癸': '子'
    };
    
    if (monthBranch === jianLuBranches[dayStem]) {
        patterns.push({
            name: '建禄格',
            level: '强格',
            description: '日主得月令，根基深厚，自强不息'
        });
    }
    
    // 木火通明格判断
    if ((counts.木 >= 25 && counts.火 >= 25) && (dayStem === '甲' || dayStem === '乙' || dayStem === '丙' || dayStem === '丁')) {
        patterns.push({
            name: '木火通明格',
            level: '贵格',
            description: '木火相生，文明之象，文采出众'
        });
    }
    
    // 从强格判断
    const dayElement = baziCalculator.getStemElement(dayStem);
    if (counts[dayElement] >= 40) {
        patterns.push({
            name: '从强格',
            level: '特殊格局',
            description: '日主极旺，顺势而为'
        });
    }
    
    return patterns.length > 0 ? patterns : [{
        name: '普通格局',
        level: '需详细分析',
        description: '格局组合较为平衡'
    }];
}

// 十神分析函数
function analyzeTenGods(pillars) {
    const tenGodsMap = {
        '甲': { '甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印' },
        '乙': { '甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印' },
        '丙': { '甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官' },
        '丁': { '甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀' },
        '戊': { '甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财' },
        '己': { '甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财' },
        '庚': { '甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官' },
        '辛': { '甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神' },
        '壬': { '甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财' },
        '癸': { '甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩' }
    };
    
    const dayStem = pillars.day.stem;
    let analysis = '';
    
    // 年柱十神
    const yearGod = tenGodsMap[dayStem]?.[pillars.year.stem] || '未知';
    analysis += `<p><strong>年柱：</strong>${yearGod} - 代表祖上根基与早年运势</p>`;
    
    // 月柱十神
    const monthGod = tenGodsMap[dayStem]?.[pillars.month.stem] || '未知';
    analysis += `<p><strong>月柱：</strong>${monthGod} - 代表父母兄弟与青年运势</p>`;
    
    // 日柱十神（日主）
    analysis += `<p><strong>日柱：</strong>${dayStem}${baziCalculator.getStemElement(dayStem)}日主 - 代表自我与配偶</p>`;
    
    // 时柱十神
    const hourGod = tenGodsMap[dayStem]?.[pillars.hour.stem] || '未知';
    analysis += `<p><strong>时柱：</strong>${hourGod} - 代表子女与晚年运势</p>`;
    
    return analysis;
}

// 用神分析函数
function analyzeUsefulGods(pillars, counts) {
    const dayStem = pillars.day.stem;
    const dayElement = baziCalculator.getStemElement(dayStem);
    
    // 简单的身强身弱判断
    const totalElements = Object.values(counts).reduce((a, b) => a + b, 0);
    const selfStrength = counts[dayElement] / totalElements * 100;
    
    let bodyStrength, usefulGods, avoidGods;
    
    if (selfStrength >= 30) {
        bodyStrength = '身强';
        usefulGods = getControllingElements(dayElement); // 克泄耗
        avoidGods = getSupportingElements(dayElement);   // 生扶
    } else {
        bodyStrength = '身弱';
        usefulGods = getSupportingElements(dayElement);  // 生扶
        avoidGods = getControllingElements(dayElement);  // 克泄耗
    }
    
    return `
        <p><strong>身强分析：</strong>${bodyStrength}，${dayStem}${dayElement}日主占比${Math.round(selfStrength)}%</p>
        <p><strong>喜用神：</strong>${usefulGods.join('、')}</p>
        <p><strong>忌神：</strong>${avoidGods.join('、')}</p>
        <p><strong>调候建议：</strong>根据五行平衡进行调整</p>
    `;
}

// 辅助函数
function getSupportingElements(element) {
    const supportive = {
        '木': ['水', '木'],
        '火': ['木', '火'],
        '土': ['火', '土'],
        '金': ['土', '金'],
        '水': ['金', '水']
    };
    return supportive[element] || [];
}

function getControllingElements(element) {
    const controlling = {
        '木': ['金', '火', '土'],
        '火': ['水', '土', '金'],
        '土': ['木', '金', '水'],
        '金': ['火', '水', '木'],
        '水': ['土', '木', '火']
    };
    return controlling[element] || [];
}

// 其他分析函数
function analyzeCareer(pillars, counts, gender) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const careers = {
        '木': ['教育文化', '创意设计', '环保健康', '医疗养生'],
        '火': ['科技创新', '能源电力', '娱乐传媒', '餐饮服务'],
        '土': ['房地产', '建筑工程', '金融投资', '农业食品'],
        '金': ['法律咨询', '机械制造', '金融证券', '技术研发'],
        '水': ['贸易物流', '旅游服务', '咨询顾问', '媒体传播']
    };
    
    return `
        <p><strong>最佳领域：</strong></p>
        <ul>
            ${(careers[dayElement] || careers['木']).map(field => `<li><strong>${field}</strong> - 适合${dayElement}元素特质的发展方向</li>`).join('')}
        </ul>
        <p><strong>发展建议：</strong>根据个人兴趣和专业技能选择适合的行业发展路径</p>
    `;
}

function analyzeWealth(pillars, counts) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const wealthTypes = {
        '木': '通过专业技能和稳定工作积累财富',
        '火': '适合投资和创新领域获得财富',
        '土': '房地产和实体产业是财富来源',
        '金': '金融投资和技术专利带来财富',
        '水': '贸易流通和咨询服务创造财富'
    };
    
    return `
        <p><strong>财运特点：</strong>${wealthTypes[dayElement] || wealthTypes['木']}</p>
        <p><strong>投资建议：</strong>根据五行平衡选择合适的投资方向</p>
        <p><strong>财富积累：</strong>中年时期财运较为旺盛</p>
    `;
}

function analyzeLove(pillars, counts, gender) {
    const dayStem = pillars.day.stem;
    const advice = gender === 'male' ? 
        '适合寻找性格温和、善解人意的伴侣' : 
        '适合寻找有责任心、事业稳定的伴侣';
    
    return `
        <p><strong>感情模式：</strong>${dayStem}日主在感情中比较${getLoveTrait(dayStem)}</p>
        <p><strong>伴侣选择：</strong>${advice}</p>
        <p><strong>婚姻时机：</strong>25-30岁是理想的结婚年龄段</p>
    `;
}

function getLoveTrait(stem) {
    const traits = {
        '甲': '主动积极', '乙': '温和体贴', '丙': '热情奔放', '丁': '细腻敏感',
        '戊': '稳重可靠', '己': '包容理解', '庚': '坚毅果断', '辛': '追求完美',
        '壬': '浪漫多情', '癸': '温柔体贴'
    };
    return traits[stem] || '真诚专一';
}

function analyzeSpiritual(pillars) {
    const dayElement = baziCalculator.getStemElement(pillars.day.stem);
    const spiritual = {
        '木': '具有强烈的直觉和感知能力',
        '火': '心灵敏锐，适合精神修行',
        '土': '注重实际，但具有内在智慧',
        '金': '理性思考，适合研究命理',
        '水': '灵感丰富，适合灵性探索'
    };
    
    return `
        <p><strong>灵性特质：</strong>${spiritual[dayElement] || spiritual['木']}</p>
        <p><strong>适合修行：</strong>冥想、命理研究、能量疗愈</p>
        <p><strong>玄学缘分：</strong>具有较强的命理学习潜力</p>
    `;
}

function analyzeNext3Years(pillars) {
    const currentYear = new Date().getFullYear();
    return `
        <p><strong>${currentYear}年：</strong>事业上有新机会，适合学习进修</p>
        <p><strong>${currentYear + 1}年：</strong>财运提升，有投资机会</p>
        <p><strong>${currentYear + 2}年：</strong>人际关系重要年份，注意合作</p>
    `;
}

// 显示专业报告
async function showProfessionalReport(baziData) {
    const butlerSection = document.getElementById('butlerProfessional');
    const reportContainer = document.getElementById('professionalReport');
    
    // 显示加载状态
    reportContainer.innerHTML = `正在生成专业分析报告...`;
    butlerSection.style.display = 'block';
    
    try {
        const report = await generateProfessionalReport(baziData);
        reportContainer.innerHTML = report;
        butlerSection.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        reportContainer.innerHTML = `报告生成失败，请重试`;
    }
}

// 生成八字命盘
async function generateBaziChart() {
    const birthdate = $('birthdate').value;
    if (!birthdate) {
        showError('请填写出生日期');
        return;
    }

    const timeUnknown = $('timeUnknown').checked;
    const [year, month, day] = birthdate.split('-').map(Number);
    
    let hour = 12;
    if (!timeUnknown) {
        const timeValue = $('birthtime').value;
        if (timeValue) {
            hour = parseInt(timeValue.split(':')[0], 10);
        }
    }

    // 显示加载状态
    const genBtn = $('genBtn');
    const genBtnText = $('genBtnText');
    const genBtnLoading = $('genBtnLoading');
    
    genBtn.disabled = true;
    genBtnText.style.display = 'none';
    genBtnLoading.style.display = 'inline-block';

    try {
        const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);

        // 显示结果区域
        $('result').style.display = 'block';

        // 设置日期显示
        const timeText = tu ? '时间不详' : `${hour}时`;
        $('bazi-date').textContent = `出生日期: ${year}年${month}月${day}日 ${timeText}`;

        // 渲染八字柱
        renderPillars(pillars, tu);

        // 计算完成后显示专业报告
        const baziData = {
            pillars: pillars,
            counts: counts, 
            gender: document.getElementById('gender').value,
            name: document.getElementById('name').value || '未知'
        };
        
        await showProfessionalReport(baziData);

    } catch (error) {
        console.error('八字计算错误:', error);
        showError('计算八字时出现错误，请重试');
    } finally {
        // 恢复按钮状态
        genBtn.disabled = false;
        genBtnText.style.display = 'inline';
        genBtnLoading.style.display = 'none';
    }
}

// 页面加载初始化
function init() {
    // 设置默认日期为今天
    const birthdateInput = $('birthdate');
    if (birthdateInput) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        birthdateInput.value = `${year}-${month}-${day}`;
    }

    // 绑定事件
    const genBtn = $('genBtn');
    if (genBtn) {
        genBtn.addEventListener('click', generateBaziChart);
    }

    // 初始化时间未知功能
    const timeUnknown = $('timeUnknown');
    const birthtime = $('birthtime');
    if (timeUnknown && birthtime) {
        timeUnknown.addEventListener('change', () => {
            birthtime.disabled = timeUnknown.checked;
            if (timeUnknown.checked) {
                birthtime.value = '';
            }
        });
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
