<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#9aa3b2;--brand:#d4af37;--gold:#d4af37;--gold2:#f2d27a;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.35)}
html,body{height:100%}
body{margin:0;color:var(--text);background:#0b0f14;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC",Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,textarea{ width:100%; box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
button,.btn{ width:auto;display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 结果样式 */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.3rem;font-weight:700;letter-spacing:.05em}
.bars{display:grid;gap:8px;margin-top:10px}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.ul{margin:.4rem 0 0 .9rem;line-height:1.8}

/* Chat 固定与样式 */
.ss-chat-fab{position: fixed; right: 18px; bottom: 18px; z-index: 9999; width: 56px; height: 56px; border-radius: 9999px; display: grid; place-items: center; font-weight: 800; border: 1px solid #e6c76e; background: linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; box-shadow: 0 8px 30px rgba(0,0,0,.35); cursor: pointer}
.ss-chat-panel{position: fixed; right: 18px; bottom: 86px; z-index: 9999; width: 360px; max-width: calc(100vw - 28px); max-height: 70vh; display: none; flex-direction: column; overflow: hidden; background:#0e1520; border:1px solid #243244; border-radius:14px; box-shadow: 0 8px 30px rgba(0,0,0,.35)}
@media (max-width: 480px){ .ss-chat-panel{ right: 10px; left: 10px; width: auto } }
.ss-chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #243244; color:#ffe084; font-weight:700 }
.ss-chat-body{ padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px; min-height:120px }
.ss-msg{ background:#101a28; border:1px solid #223047; padding:8px 10px; border-radius:10px; max-width:95%; font-size:14px; line-height:1.5 }
.ss-msg.me{ margin-left:auto; background:#1a2433; border-color:#2b3a51 }
.ss-chat-input{ display:flex; gap:8px; padding:10px; border-top:1px solid #243244 }
.ss-chat-input textarea{ flex:1; resize:none; min-height:44px; max-height:180px; font-size:14px; padding:10px 12px; border-radius:10px; border:1px solid #243244; background:#0f1522; color:#eaf0ff }
.ss-chat-input button{ padding:10px 12px; border-radius:10px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:700 }

/* 专业扩展块 */
.kv{display:grid;grid-template-columns:120px 1fr;gap:6px 12px;margin-top:6px}
.kv .k{color:#9aa3b2}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{padding:8px 10px;border:1px solid #243244;background:#0f1624}
.table th{color:#ffe084;font-weight:700}
.badge2{display:inline-block;border:1px solid #33465e;border-radius:999px;padding:2px 10px;margin-right:6px;margin-top:6px;color:#a7b5c5}
.note{color:#a7b5c5;font-size:.92rem}
.hr{height:1px;background:#1f2a36;margin:10px 0}

/* 修复“重新加载”按钮被拉伸 */
.btn,#depsReload{width:auto;display:inline-grid}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="muted">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> 闰月
          </label>
        </div>
        <div id="calendarHint" class="muted" style="display:none; margin-top:6px;">
          选择农历时，请确认是否为闰月；若为闰月请勾选“闰月”。系统会自动换算为阳历后计算。
        </div>
      </div>
    </div>

    <div id="depsRow" class="muted" style="display:flex;align-items:center;gap:10px;margin-top:8px">
      <span>依赖状态：</span>
      <span id="depsStatus" style="color:#ffdf8a">未加载</span>
      <button id="depsReload" class="btn" style="padding:6px 10px;border-radius:10px">重新加载</button>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">生成八字</button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div class="muted" id="error" style="color:#ffb4b4;display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card section">
      <div class="h2">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"></i></div>
        <div class="bar"><i id="bar-fire"></i></div>
        <div class="bar"><i id="bar-earth"></i></div>
        <div class="bar"><i id="bar-metal"></i></div>
        <div class="bar"><i id="bar-water"></i></div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <!-- 基础信息 -->
    <div class="card section">
      <div class="h2">基础信息</div>
      <div class="kv" id="kv-basic"></div>
    </div>

    <!-- 四柱明细 -->
    <div class="card section">
      <div class="h2">四柱明细</div>
      <table class="table" id="tbl-pillars">
        <thead><tr><th>柱</th><th>天干</th><th>十神</th><th>地支</th><th>藏干</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="note" id="note-stem-branch"></div>
    </div>

    <!-- 阴阳与五行 -->
    <div class="card section">
      <div class="h2">阴阳与五行</div>
      <div class="grid-2">
        <div>
          <div class="h3 muted" style="margin:0 0 6px">阴阳比例</div>
          <div id="yy-ratio" class="kv"></div>
        </div>
        <div>
          <div class="h3 muted" style="margin:0 0 6px">五行缺失/偏旺</div>
          <div id="elem-flags" class="kv"></div>
        </div>
      </div>
    </div>

    <!-- 喜用与开运建议 -->
    <div class="card section">
      <div class="h2">喜用与开运建议</div>
      <div class="kv" id="useful"></div>
      <div class="hr"></div>
      <div id="fengshui" class="note"></div>
    </div>

    <!-- 起运 / 大运 / 流年 -->
    <div class="card section">
      <div class="h2">起运·大运·流年（简表）</div>
      <div class="kv" id="start-yun"></div>
      <table class="table" id="tbl-dayun">
        <thead><tr><th>起始(公历)</th><th>大运干支</th><th>十神</th><th>所临地支</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hr"></div>
      <table class="table" id="tbl-liunian">
        <thead><tr><th>年份</th><th>流年干支</th><th>十神</th><th>备注</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <textarea id="ssChatInput" rows="2" placeholder="想和我说点什么…"></textarea>
    <button id="ssChatSend">发送</button>
  </div>
</div>

<script>
/* ========== 配置：本地库优先（assets/vendor/lunar.min.js） ========== */
const $ = id => document.getElementById(id);
const bySel = (s, root=document)=>root.querySelector(s);

function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  const m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){ const [_,d,mo,y]=m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTime24(t){
  if(!t) return '00:00';
  const s=t.trim().toLowerCase().replace(/\s+/g,'');
  const m=s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t;
  let hh=parseInt(m[1],10), mm=parseInt(m[2]||'0',10); const ap=m[3];
  if(ap==='am'){ if(hh===12) hh=0; } else if(ap==='pm'){ if(hh!==12) hh+=12; }
  return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
}
function setBar(el,pct){ if(el) el.style.width=Math.max(0,Math.min(100,pct))+'%'; }
function el(tag, attrs={}, html=""){ const d=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>d.setAttribute(k,v)); d.innerHTML=html; return d; }

/* 依赖加载状态 */
const LoadUI = {
  mount(){ /* 页面已有 depsStatus，不再重复创建 */ },
  set(text,isOk){ const n=$('depsStatus'); if(n){ n.textContent=''+text; n.style.color=isOk?'#9aa3b2':'#ffb4b4'; } }
};
async function loadScript(src, timeout=15000){
  if ([...document.scripts].some(s => (s.src||'').includes(src))) return;
  await new Promise((resolve,reject)=>{
    const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous';
    const t=setTimeout(()=>reject(new Error('timeout '+src)), timeout);
    s.onload=()=>{clearTimeout(t);resolve();};
    s.onerror=()=>{clearTimeout(t);reject(new Error('load failed '+src));};
    document.head.appendChild(s);
  });
}
async function ensureLunarJS(){
  if (window.Solar && window.Lunar) { LoadUI.set('lunar 已就绪', true); return true; }
  LoadUI.set('加载中…', true);
  const candidates = [
    'assets/vendor/lunar.min.js',
    '/assets/vendor/lunar.min.js'
    // 如需要可加外链CDN作兜底
  ];
  for (const u of candidates){
    try{
      await loadScript(u, 8000);
      if (window.Solar && window.Lunar){ LoadUI.set('lunar 已就绪（本地）', true); return true; }
      if (window.lunar && window.lunar.Solar && window.lunar.Lunar){
        window.Solar = window.lunar.Solar; window.Lunar = window.lunar.Lunar;
        LoadUI.set('lunar 已就绪（命名空间 lunar）', true);
        return true;
      }
    }catch(e){}
  }
  LoadUI.set('命理计算组件加载失败', false);
  return false;
}

/* ========== 命理基础 ========== */
const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const BRANCH_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
const YANG={甲:1,丙:1,戊:1,庚:1,壬:1};

function tenGod(dm, other){
  const order=['木','火','土','金','水'], i=order.indexOf(STEM_ELEM[dm]), j=order.indexOf(STEM_ELEM[other]);
  const s = YANG[dm]===YANG[other];
  const same=(a,b)=>a===b, next=(a,b)=> (a+1)%5===b, over=(a,b)=> (a+2)%5===b, beOver=(a,b)=> (a+3)%5===b, input=(a,b)=> (a+4)%5===b;
  if(same(i,j)) return s?'比肩':'劫财';
  if(next(i,j)) return s?'食神':'伤官';
  if(over(i,j)) return s?'偏财':'正财';
  if(beOver(i,j)) return s?'七杀':'正官';
  if(input(i,j)) return s?'偏印':'正印';
  return '';
}
function countElements(gzList){
  const cnt={木:0,火:0,土:0,金:0,水:0};
  gzList.forEach(gz=>{ if(!gz) return; const gan=gz[0], zhi=gz[1]; const e1=STEM_ELEM[gan], e2=BRANCH_ELEM[zhi];
    if(e1) cnt[e1]+=1; if(e2) cnt[e2]+=1; });
  const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
  return {cnt, pct:{ wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 }};
}
function judgeStrength(dayGan, monthZhi, cnt){
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  const genEl={木:'水',火:'木',土:'火',金:'土',水:'金'}[dmEl];
  const beOverEl={木:'金',火:'水',土:'木',金:'火',水:'土'}[dmEl];
  const overEl={木:'土',火:'金',土:'水',金:'木',水:'火'}[dmEl];
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score += (cnt[dmEl]||0)*1.2 + (cnt[genEl]||0)*1.5;
  score -= (cnt[beOverEl]||0)*1.5 + (cnt[overEl]||0)*0.8;
  const mark = score>=4?'偏强':(score<=1?'偏弱':'平衡');
  const focus = mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和');
  return {season, mark, focus};
}
function elemAdvice(pct, dm){
  const arr=[['木',pct.wood],['火',pct.fire],['土',pct.earth],['金',pct.metal],['水',pct.water]];
  const hi=arr.slice().sort((a,b)=>b[1]-a[1])[0][0], lo=arr.slice().sort((a,b)=>a[1]-b[1])[0][0];
  return {hi,lo, summary:`偏${hi}、${lo}偏弱；以日主「${dm.stem}（${dm.elem}）」为锚，强项快推、弱项外包。`};
}
function renderPillars(root,p){
  root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const div=el('div',{class:'pillar'}, `<div class="tit">${tit}</div><div class="gz">${(v&&v.gz)||'--'}</div>`);
    root.appendChild(div);
  });
}

/* ========== 生成排盘 ========== */
async function genChart(){
  const err=$('error'); err.style.display='none'; err.textContent='';
  const birth = normalizeDate(($('birthdate').value||'').trim());
  const time  = normalizeTime24(($('birthtime').value||'').trim());
  if(!birth || !time){ err.textContent='请完善出生日期与时间。'; err.style.display='block'; return; }

  const ok = await ensureLunarJS();
  if(!ok){ err.textContent='命理计算组件加载失败（请点击“重新加载”或换网络）'; err.style.display='block'; return; }

  try{
    const [Y,M,D]=birth.split('-').map(Number); const [hh,mm]=time.split(':').map(Number);
    const solar=Solar.fromYmdHms(Y,M,D,hh,mm||0,0);
    const lunar=solar.getLunar();
    const ec=lunar.getEightChar();

    const gzYear=ec.getYear(), gzMonth=ec.getMonth(), gzDay=ec.getDay(), gzHour=ec.getTime();
    const pillars={year:{gz:gzYear,gan:gzYear[0],zhi:gzYear[1]},month:{gz:gzMonth,gan:gzMonth[0],zhi:gzMonth[1]},day:{gz:gzDay,gan:gzDay[0],zhi:gzDay[1]},hour:{gz:gzHour,gan:gzHour[0],zhi:gzHour[1]}};
    const dayGan=pillars.day.gan, dmElem=STEM_ELEM[dayGan];

    $('result').style.display='block';
    $('bazi-date').textContent=`用于计算（UTC+8，阳历）：${birth} ${time}`;
    renderPillars($('bazi-pillars'), pillars);
    $('bazi-day-master').textContent=`日主：${dayGan}（${dmElem}）`;

    const {cnt,pct}=countElements([gzYear,gzMonth,gzDay,gzHour]);
    setBar($('bar-wood'), pct.wood); setBar($('bar-fire'), pct.fire); setBar($('bar-earth'), pct.earth);
    setBar($('bar-metal'), pct.metal); setBar($('bar-water'), pct.water);
    $('bazi-elements-balance').textContent=`五行占比：木${Math.round(pct.wood)} 火${Math.round(pct.fire)} 土${Math.round(pct.earth)} 金${Math.round(pct.metal)} 水${Math.round(pct.water)}`;

    const st=judgeStrength(dayGan, pillars.month.zhi, cnt);
    const adv = elemAdvice(
      { wood:pct.wood, fire:pct.fire, earth:pct.earth, metal:pct.metal, water:pct.water },
      { stem:dayGan, elem:dmElem }
    );
    const tgY=tenGod(dayGan,pillars.year.gan), tgM=tenGod(dayGan,pillars.month.gan), tgH=tenGod(dayGan,pillars.hour.gan);
    $('bazi-strengths').textContent=`亮点：${[tgY,tgM,tgH].filter(Boolean).join('、')||'均衡'}；强项：${adv.hi}；短板：${adv.lo}`;

    // —— 扩展面板 ——（放在成功分支，变量都已就绪）
    const ctxPro = { birthSolar:solar, lunarObj:lunar, ec, pillars, cnt, pct, st };
    renderProPanels(ctxPro);

    // Chat 上下文
    window.__BaziContext__={ date:`${birth} ${time}`, pillars:{year:gzYear,month:gzMonth,day:gzDay,hour:gzHour}, dayMaster:`${dayGan}（${dmElem}）`, season:st.season, strength:st.mark, strategy:st.focus, strong:adv.hi, weak:adv.lo };
  }catch(e){
    err.textContent = e?.message || '计算失败，请重试。';
    err.style.display='block';
    $('result').style.display='block';
  }
}

/* ========== 专业扩展：十神/阴阳/喜用/运势 ========== */
const STEM_YIN_YANG = {甲:'阳',乙:'阴',丙:'阳',丁:'阴',戊:'阳',己:'阴',庚:'阳',辛:'阴',壬:'阳',癸:'阴'};
function yinYangRatio(pillars){
  const stems=[pillars.year.gan,pillars.month.gan,pillars.day.gan,pillars.hour.gan];
  let y=0,n=0; stems.forEach(g=>{ (STEM_YIN_YANG[g]==='阳')? y++ : n++; });
  const pctY = Math.round(y/4*100), pctN = 100-pctY; return {yang:y, yin:n, pctY, pctN};
}
function elemFlags(pct){
  const flags=[]; const v = {木:pct.wood, 火:pct.fire, 土:pct.earth, 金:pct.metal, 水:pct.water};
  Object.entries(v).forEach(([k,p])=>{
    if (p<5) flags.push(`${k}：缺失/极弱`);
    else if (p<12) flags.push(`${k}：偏弱`);
    else if (p>35) flags.push(`${k}：偏旺`);
  }); return flags;
}
function chooseUseful(strength, dmElem){
  if (strength==='偏强'){
    const useful = ({木:['火','土','金'], 火:['土','金','水'], 土:['金','水','木'], 金:['水','木','火'], 水:['木','火','土']})[dmElem];
    return {strategy:'泄秀/制化', useful, avoid:[dmElem]};
  }else if (strength==='偏弱'){
    const helper = ({木:['木','水'], 火:['火','木'], 土:['土','火'], 金:['金','土'], 水:['水','金']})[dmElem];
    return {strategy:'生扶/补助', useful:helper, avoid:[]};
  }
  return {strategy:'守中/调和', useful:['木','火','土','金','水'], avoid:[]};
}
function relationHints(p){
  const g=[p.year.gan,p.month.gan,p.day.gan,p.hour.gan].join('');
  const z=[p.year.zhi,p.month.zhi,p.day.zhi,p.hour.zhi].join('');
  const hints=[];
  if (g.includes('甲') && g.includes('庚')) hints.push('命局天干留意：甲庚相冲');
  if (g.includes('乙') && g.includes('辛')) hints.push('命局天干留意：乙辛相冲');
  if (z.includes('寅') && z.includes('午')) hints.push('命局地支留意：寅午半合火');
  if (z.includes('午午')) hints.push('命局地支留意：午午自刑');
  return hints;
}
function tgName(dayGan, otherGan){ return tenGod(dayGan, otherGan); }
function zhiHiddenStems(z){
  try{ const hs = Lunar.LunarUtil.ZHI_HIDE_GAN.get(z) || []; return hs.join('、'); }catch{ return ''; }
}
function simplePattern(dayGan, monthZhi, tgMonth){
  const pat = [];
  if (['食神','伤官'].includes(tgMonth)) pat.push('食伤格（味）');
  if (['正财','偏财'].includes(tgMonth)) pat.push('财格（味）');
  if (['正官','七杀'].includes(tgMonth)) pat.push('官杀格（味）');
  return pat.join(' / ') || '平衡格（味）';
}
function renderYun(ec){
  try{
    // 性别参与起运计算：男性为 true，女性为 false；未选则按 true
    const genderSel = $('gender')?.value;
    const genderIsMale = (genderSel!=='female');

    const yun = ec.getYun(genderIsMale);
    const startTime = yun.getStartSolar();
    $('start-yun').innerHTML = `
      <div class="k">起运日期</div><div>${startTime.toYmd()}</div>
      <div class="k">起运年龄</div><div>${yun.getStartYear()}岁 ${yun.getStartMonth()}月 ${yun.getStartDay()}天</div>
    `;

    const tbody1 = $('tbl-dayun').querySelector('tbody'); tbody1.innerHTML='';
    yun.getDaYun().slice(0,8).forEach(dy=>{
      const start = dy.getStartSolar().toYmd();
      const gz = dy.getGanZhi();
      const ss = tgName(ec.getDay(), gz[0]);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${start}</td><td>${gz}</td><td>${ss||'-'}</td><td>${gz[1]}</td>`;
      tbody1.appendChild(tr);
    });

    const tbody2 = $('tbl-liunian').querySelector('tbody'); tbody2.innerHTML='';
    const thisYear = new Date().getFullYear();
    for(let y=thisYear; y<thisYear+10; y++){
      const ly = yun.getLiuNian(y);
      const gz = (ly && ly.getGanZhi) ? ly.getGanZhi() : '';
      const ss = gz ? tgName(ec.getDay(), gz[0]) : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${y}</td><td>${gz||'-'}</td><td>${ss||'-'}</td><td class="note">简参：遇冲合时注意节奏</td>`;
      tbody2.appendChild(tr);
    }
  }catch(e){
    $('start-yun').innerHTML = `<div class="k">起运</div><div>（此环境未启用 yun 接口）</div>`;
  }
}
function renderProPanels(ctx){
  const {birthSolar, lunarObj, ec, pillars, cnt, pct, st} = ctx;
  $('kv-basic').innerHTML = `
    <div class="k">公历</div><div>${birthSolar.toYmd()} ${String(birthSolar.getHour()).padStart(2,'0')}:${String(birthSolar.getMinute()).padStart(2,'0')}</div>
    <div class="k">农历</div><div>${lunarObj.toString()}</div>
    <div class="k">日主</div><div>${pillars.day.gan}（${STEM_ELEM[pillars.day.gan]}）</div>
    <div class="k">季节</div><div>${st.season}</div>
  `;
  const tb = $('tbl-pillars').querySelector('tbody'); tb.innerHTML='';
  [['年柱',pillars.year],['月柱',pillars.month],['日柱',pillars.day],['时柱',pillars.hour]].forEach(([label,v])=>{
    const ss = tgName(pillars.day.gan, v.gan);
    const hidden = zhiHiddenStems(v.zhi);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${label}</td><td>${v.gan}</td><td>${ss||'-'}</td><td>${v.zhi}</td><td>${hidden||'-'}</td>`;
    tb.appendChild(tr);
  });
  $('note-stem-branch').textContent = relationHints(pillars).join('；') || '（无明显冲合提示）';

  const yy = yinYangRatio(pillars);
  $('yy-ratio').innerHTML = `
    <div class="k">阳干</div><div>${yy.yang}（${yy.pctY}%）</div>
    <div class="k">阴干</div><div>${yy.yin}（${yy.pctN}%）</div>
  `;
  const flags = elemFlags(pct);
  $('elem-flags').innerHTML = flags.length ? flags.map(x=>`<span class="badge2">${x}</span>`).join('') : '<div class="k">提示</div><div>五行较均衡</div>';

  const pref = chooseUseful(st.mark, STEM_ELEM[pillars.day.gan]);
  $('useful').innerHTML = `
    <div class="k">格局味道</div><div>${simplePattern(pillars.day.gan, pillars.month.zhi, tgName(pillars.day.gan, pillars.month.gan))}</div>
    <div class="k">策略</div><div>${pref.strategy}</div>
    <div class="k">喜用</div><div>${pref.useful.join('、')}</div>
  `;
  const mapCFN = {
    金:'颜色·白/金/银；方位·西；数字·4/9',
    木:'颜色·青/绿；方位·东；数字·3/8',
    水:'颜色·黑/蓝；方位·北；数字·1/6',
    火:'颜色·红/紫/粉；方位·南；数字·2/7',
    土:'颜色·黄/咖；方位·中/东北/西南；数字·5/10'
  };
  $('fengshui').innerHTML = `建议优先运用：${pref.useful.map(x=>`【${x}】${mapCFN[x]||''}`).join('；')}。`;

  renderYun(ec);
}

/* ========== Chat ========== */
function setupChat(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'),
        input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  const open=()=>{ panel.style.display='flex'; input?.focus(); };
  const close=()=>{ panel.style.display='none'; };
  fab?.addEventListener('click',open); closeBtn?.addEventListener('click',close);

  function push(role,text){
    const d=document.createElement('div'); d.className='ss-msg'+(role==='me'?' me':''); d.textContent=text;
    body?.appendChild(d); body.scrollTop=body.scrollHeight;
  }
  async function askLLM(q){
    const ctx=window.__BaziContext__;
    if(!ctx) return '先点击“生成八字”，我会结合命盘聊具体方案～';
    return `已记录：日主${ctx.dayMaster}（${ctx.season}令，${ctx.strength}），建议「${ctx.strategy}」。强项${ctx.strong}、短板${ctx.weak}。想聊事业/财运/姻缘/起名/风水哪一块？`;
  }
  async function sendMsg(){
    const v=(input.value||'').trim(); if(!v) return;
    input.value=''; push('me',v);
    const t=document.createElement('div'); t.className='ss-msg'; t.textContent='…'; body.appendChild(t); body.scrollTop=body.scrollHeight;
    const a=await askLLM(v); t.remove(); push('bot',a);
  }
  input?.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }});
  send?.addEventListener('click', sendMsg);
  if(body && !body.dataset.inited){ push('bot','嗨～我是心怜管家。先在上面生成你的八字，我会结合命盘聊具体方案。'); body.dataset.inited='1'; }
}

/* ========== 绑定 ========== */
document.addEventListener('DOMContentLoaded', () => {
  // 确保 Chat 节点挂到 body
  (function relocateChatToBody(){
    const fab   = $('ssChatFab');
    const panel = $('ssChatPanel');
    if (fab   && fab.parentNode   !== document.body) document.body.appendChild(fab);
    if (panel && panel.parentNode !== document.body) document.body.appendChild(panel);
  })();

  setupChat();
  $('genBtn')?.addEventListener('click', genChart);

  // 历法提示显隐
  const cal = $('calendar'), leap = $('leapWrap'), hint = bySel('#calendarHint');
  const toggle = () => {
    const isLunar = cal?.value === 'lunar';
    if (leap) leap.style.display = isLunar ? 'inline-flex' : 'none';
    if (hint) hint.style.display = isLunar ? 'block' : 'none';
  };
  cal?.addEventListener('change', toggle); toggle();

  // 依赖重载按钮
  $('depsReload')?.addEventListener('click', async () => {
    const ok = await ensureLunarJS();
    if (!ok) { const err = $('error'); if (err){ err.textContent='命理计算组件加载失败（网络/拦截）。请稍后再试或换网络。'; err.style.display='block'; } }
  });

  // 页面加载即尝试拉起依赖（成功则按钮直接可用）
  ensureLunarJS();
});
</script>
</body>
</html>
