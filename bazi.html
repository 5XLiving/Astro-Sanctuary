<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    
    /* â€”â€” ç»Ÿä¸€å¤´éƒ¨ â€”â€” */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* â€”â€” å‡ºç”Ÿæ—¶é—´ï¼šæ—¶é—´è¾“å…¥ + "ä¸è¯¦"åŒä¸€è¡Œ â€”â€” */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* â€”â€” éšè—"ä¼°æ—¶é—´"æŒ‰é’®ï¼šä»…å‹¾é€‰ä¸è¯¦æ—¶å¼¹çª— â€”â€” */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* â€”â€” ä¼šå‘˜åŒºå¸ƒå±€ â€”â€” */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* â€”â€” ä¼°æ—¶é—´å¼¹çª— â€”â€” */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* â€”â€” ç®€æ˜“æŠ¥å‘Šæ ·å¼ â€”â€” */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }

    /* â€”â€” å¿ƒæ€œç®¡å®¶æ ·å¼ â€”â€” */
    .butler-section { margin-top: 20px; }
    .butler-card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 18px; margin: 16px 0; }
    .butler-title { font-size: 1.2rem; margin: 0 0 12px; font-weight: 800; color: var(--gold2); display: flex; gap: 8px; align-items: center; }
    .butler-title::before { content: ""; width: 4px; height: 18px; background: var(--brand); border-radius: 2px; }
    .butler-content { line-height: 1.7; white-space: pre-wrap; }
    .butler-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .butler-chip { padding: 6px 12px; border-radius: 999px; border: 1px solid #2a3546; background: #0e1520; color: var(--text); cursor: pointer; transition: all 0.2s; }
    .butler-chip:hover { border-color: var(--gold2); background: rgba(212,175,55,0.1); }
    .butler-skeleton { display: grid; gap: 8px; }
    .butler-skeleton div { height: 12px; border-radius: 6px; background: linear-gradient(90deg, #1a2431, #1f2b3b, #1a2431); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { opacity: .5; } 50% { opacity: 1; } 100% { opacity: .5; } }
    .butler-lock { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--line); text-align: center; }
    .butler-lock .tip { color: #ffd88a; font-weight: 700; margin-bottom: 4px; }
    .butler-lock .sub { color: var(--muted); }

    /* æˆé•¿è·Ÿè¸ªå™¨æ ·å¼ */
    .growth-tracker {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 20px;
    }

    .tracker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .progress-ring {
      position: relative;
      text-align: center;
    }

    .progress-ring span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--gold);
    }

    .mission-list {
      display: grid;
      gap: 10px;
    }

    .mission-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    .mission-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .energy-insight {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:140px}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving Â· <span data-i18n="title_bazi_brief">å…«å­—ç®€è¯„</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
      <div class="h2" data-i18n="title_quickcalc">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>

      <div class="row cols-3">
        <div>
          <label class="muted" data-i18n="label_name">å§“åï¼ˆå¯é€‰ï¼‰</label>
          <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" data-i18n-ph="ph_name" />
        </div>
        <div>
          <label class="muted" data-i18n="gender_label">æ€§åˆ«</label>
          <select id="gender">
            <option value="" data-i18n="opt_gender_confidential">ä¸é€éœ²</option>
            <option value="male" data-i18n="opt_gender_male">ç”·æ€§</option>
            <option value="female" data-i18n="opt_gender_female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted" data-i18n="label_calendar">å†æ³•</label>
          <select id="calendar">
            <option value="gregorian" data-i18n="opt_cal_gregorian">é˜³å†</option>
            <option value="lunar" data-i18n="opt_cal_lunar">å†œå†</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted" data-i18n="label_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>

        <div>
          <label class="muted" data-i18n="label_birthtime">å‡ºç”Ÿæ—¶é—´</label>
          <div class="time-row">
            <input type="time" id="birthtime" value="12:00" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span data-i18n="cb_time_unknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
            </label>
          </div>
        </div>

        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText" data-i18n="btn_generate_chart">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
          </button>
        </div>

        <div id="error" class="error-message"></div>
      </div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
          <tbody>
            <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span data-i18n="el_wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- å¿ƒæ€œç®¡å®¶ AI è§£è¯»åŒºåŸŸ -->
      <div class="butler-section">
        <div class="butler-card">
          <div class="butler-title">ğŸ§  å¿ƒæ€œç®¡å®¶ Â· å‘½ç†è§£è¯»</div>
          <div id="butler-content" class="butler-content">
            <div class="butler-skeleton">
              <div style="width:60%"></div>
              <div style="width:80%"></div>
              <div style="width:90%"></div>
              <div style="width:70%"></div>
              <div style="width:50%"></div>
            </div>
          </div>
          <div class="butler-chips">
            <button class="butler-chip" data-question="career">ğŸ’¼ äº‹ä¸šæ–¹å‘</button>
            <button class="butler-chip" data-question="love">â¤ï¸ æ„Ÿæƒ…å©šå§»</button>
            <button class="butler-chip" data-question="wealth">ğŸ’° è´¢è¿åˆ†æ</button>
            <button class="butler-chip" data-question="health">ğŸŒ¿ å¥åº·å…»ç”Ÿ</button>
            <button class="butler-chip" data-question="personality">ğŸŒŸ æ€§æ ¼ç‰¹è´¨</button>
          </div>
        </div>
      </div>

      <!-- æˆé•¿è·Ÿè¸ªå™¨ -->
      <div class="growth-tracker" id="growthTracker" style="display:none;">
        <div class="tracker-header">
          <h3>ğŸŒ± æ‚¨çš„æˆé•¿æ—…ç¨‹</h3>
          <div class="progress-ring">
            <svg width="60" height="60">
              <circle cx="30" cy="30" r="25" stroke="#2a3546" stroke-width="4" fill="none"/>
              <circle cx="30" cy="30" r="25" stroke="#d4af37" stroke-width="4" fill="none" 
                      stroke-dasharray="157" stroke-dashoffset="78.5" stroke-linecap="round"/>
            </svg>
            <span>50%</span>
          </div>
        </div>
        
        <div class="weekly-mission">
          <h4>ğŸ“‹ æœ¬å‘¨èƒ½é‡ç»ƒä¹ </h4>
          <div class="mission-list">
            <div class="mission-item">
              <input type="checkbox" id="mission1">
              <label for="mission1">æ™¨é—´5åˆ†é’Ÿæ„Ÿæ©å†¥æƒ³</label>
            </div>
            <div class="mission-item">
              <input type="checkbox" id="mission2">
              <label for="mission2">å¯¹3ä¸ªäººè¡¨è¾¾æ„Ÿè°¢</label>
            </div>
            <div class="mission-item">
              <input type="checkbox" id="mission3">
              <label for="mission3">å®Œæˆä¸€æ¬¡åˆ›æ„è¾“å‡º</label>
            </div>
          </div>
        </div>
        
        <div class="energy-insight">
          <h4>ğŸ’« ä»Šæ—¥èƒ½é‡æé†’</h4>
          <p id="dailyEnergyTip">æ ¹æ®æ‚¨çš„å‘½ç›˜ï¼Œä»Šå¤©é€‚åˆï¼šåˆ›æ„å·¥ä½œã€ä¸äººåˆä½œã€å­¦ä¹ æ–°æŠ€èƒ½</p>
        </div>
      </div>
    </section>

    <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username"
                  placeholder=""
                  data-i18n-ph="ph_email"
                  required
                />
                <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
                  data-i18n-ph="ph_password"
                  required
                />
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <!-- ä¼°æ—¶é—´å¼¹çª— -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">ğŸ§­ ä¼°ä¸€ä¸ªå¤§è‡´å‡ºç”Ÿæ—¶é—´</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">é€‰æ‹©ä½ è®°å¾—çš„<strong>å¤§æ¦‚æ—¶æ®µ</strong>ï¼ˆåœ°æ”¯åŒå°æ—¶æ®µï¼‰</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          é€‰æ‹©åç‚¹"å¡«å…¥æ—¶é—´"ï¼Œä¼šç”¨è¯¥æ—¶æ®µçš„ä¸­ä½æ—¶é—´å†™åˆ°ä¸Šæ–¹æ—¶é—´è¾“å…¥æ¡†ï¼Œå¹¶è‡ªåŠ¨å–æ¶ˆ"æ—¶é—´ä¸è¯¦"ã€‚
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">å–æ¶ˆ</button>
        <button class="btn" id="twApply" type="button" disabled>å¡«å…¥æ—¶é—´</button>
      </div>
    </div>
  </div>

<script>  
// ================== å¤šè¯­è¨€ç³»ç»Ÿ ==================
const translations = {
  "zh-CN": {
    // é€šç”¨
    "lang_label": "è¯­è¨€",
    "title_bazi_brief": "å…«å­—ç®€è¯„",
    "title_quickcalc": "å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜",
    
    // è¡¨å•æ ‡ç­¾
    "label_name": "å§“åï¼ˆå¯é€‰ï¼‰",
    "ph_name": "ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰",
    "gender_label": "æ€§åˆ«",
    "label_calendar": "å†æ³•",
    "label_birthdate": "å‡ºç”Ÿæ—¥æœŸ",
    "label_birthtime": "å‡ºç”Ÿæ—¶é—´",
    "cb_time_unknown": "å‡ºç”Ÿæ—¶é—´ä¸è¯¦",
    "btn_generate_chart": "ç”Ÿæˆå…«å­—",
    
    // æ€§åˆ«é€‰é¡¹
    "opt_gender_confidential": "ä¸é€éœ²",
    "opt_gender_male": "ç”·æ€§",
    "opt_gender_female": "å¥³æ€§",
    
    // å†æ³•é€‰é¡¹
    "opt_cal_gregorian": "é˜³å†",
    "opt_cal_lunar": "å†œå†",
    
    // é”™è¯¯ä¿¡æ¯
    "err_birthdate_required": "è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸ",
    "err_calculation_failed": "è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•",
    
    // äº”è¡Œæ ‡ç­¾
    "el_wood": "æœ¨",
    "el_fire": "ç«",
    "el_earth": "åœŸ",
    "el_metal": "é‡‘",
    "el_water": "æ°´",
    
    // å¿ƒæ€œç®¡å®¶
    "butler_title": "å¿ƒæ€œç®¡å®¶ Â· å‘½ç†è§£è¯»",
    "butler_loading": "æ­£åœ¨åˆ†ææ‚¨çš„å‘½ç›˜...",
    "butler_chip_career": "ğŸ’¼ äº‹ä¸šæ–¹å‘",
    "butler_chip_love": "â¤ï¸ æ„Ÿæƒ…å©šå§»",
    "butler_chip_wealth": "ğŸ’° è´¢è¿åˆ†æ",
    "butler_chip_health": "ğŸŒ¿ å¥åº·å…»ç”Ÿ",
    "butler_chip_personality": "ğŸŒŸ æ€§æ ¼ç‰¹è´¨",
    
    // åˆ†æå†…å®¹
    "analysis_strength_strong": "åå¼º",
    "analysis_strength_weak": "åå¼±",
    "analysis_strength_balanced": "å¹³è¡¡",
    "analysis_strategy_drain": "æ³„ç§€/åˆ¶åŒ–",
    "analysis_strategy_support": "è¡¥åŠ©/é¡ºåŠ¿",
    "analysis_strategy_balance": "å®ˆä¸­/è°ƒå’Œ",

    "rpt_sec_elements_title": "äº”è¡Œèƒ½é‡åˆ†æ",
    "vip_title": "ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
    "vip_mingli": "ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹", 
    "vip_love": "å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
    "vip_career": "äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
    "vip_wealth": "è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
    "vip_pet": "å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
    "vip_hepan": "åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    "vip_name": "æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
    "vip_fengshui": "è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
    "vip_xinlian": "ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
    "vip_record": "çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    "vip_course": "å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
    "vip_memorial": "å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
    "vip_tasks": "æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
    "vip_shop": "èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",

    "butler_overview_title": "å¿ƒæ€œç®¡å®¶ Â· å¿«é€Ÿæ€»è§ˆ",
    "ov_summary": "æ¦‚è§ˆ",
    "ov_elements": "äº”è¡Œç”»åƒ",
    "ov_strategy": "ç­–ç•¥",
    "ov_focus": "é‡ç‚¹æ–¹å‘",
    "ov_actions": "æœ¬å‘¨ä¸‰æ­¥è¡ŒåŠ¨"
  },
  "en": {
    // General
    "lang_label": "Language",
    "title_bazi_brief": "Bazi Brief Reading",
    "title_quickcalc": "Bazi Destiny Â· Quick Chart",
    
    // Form labels
    "label_name": "Name (optional)",
    "ph_name": "Your name (for personalization)",
    "gender_label": "Gender",
    "label_calendar": "Calendar",
    "label_birthdate": "Birth Date",
    "label_birthtime": "Birth Time",
    "cb_time_unknown": "Birth time unknown",
    "btn_generate_chart": "Generate Chart",
    
    // Gender options
    "opt_gender_confidential": "Confidential",
    "opt_gender_male": "Male",
    "opt_gender_female": "Female",
    
    // Calendar options
    "opt_cal_gregorian": "Gregorian",
    "opt_cal_lunar": "Lunar",
    
    // Error messages
    "err_birthdate_required": "Please enter birth date",
    "err_calculation_failed": "Error calculating Bazi, please try again",
    
    // Element labels
    "el_wood": "Wood",
    "el_fire": "Fire",
    "el_earth": "Earth",
    "el_metal": "Metal",
    "el_water": "Water",
    
    // Butler
    "butler_title": "Butler Â· Destiny Analysis",
    "butler_loading": "Analyzing your destiny chart...",
    "butler_chip_career": "ğŸ’¼ Career Direction",
    "butler_chip_love": "â¤ï¸ Love & Marriage",
    "butler_chip_wealth": "ğŸ’° Wealth Analysis",
    "butler_chip_health": "ğŸŒ¿ Health & Wellness",
    "butler_chip_personality": "ğŸŒŸ Personality Traits",
    
    // Analysis content
    "analysis_strength_strong": "Strong",
    "analysis_strength_weak": "Weak",
    "analysis_strength_balanced": "Balanced",
    "analysis_strategy_drain": "Drain/Control",
    "analysis_strategy_support": "Support/Nourish",
    "analysis_strategy_balance": "Balance/Harmony",

    "rpt_sec_elements_title": "Five Elements Analysis",
    "vip_title": "ğŸŒ™ VIP Member Area", 
    "vip_mingli": "ğŸ— Destiny Space Exclusive",
    "vip_love": "Love Direction: Relationships & Marriage Trends",
    "vip_career": "Career Path: Workplace & Entrepreneurship",
    "vip_wealth": "Wealth Analysis: Money Flow & Investment Timing",
    "vip_pet": "Pet Destiny: Companion Animal Compatibility",
    "vip_hepan": "Compatibility: Wedding Dates & Birth Timing",
    "vip_name": "Name Analysis: Business & Baby Names",
    "vip_fengshui": "Wealth Positions: Home/Office Layout",
    "vip_xinlian": "ğŸŒ™ XinLian Space Exclusive",
    "vip_record": "Spiritual Records: Photos, Dreams, Prayers",
    "vip_course": "Courses: Bazi, Tarot, Astrology, Numerology",
    "vip_memorial": "Family Memorial System",
    "vip_tasks": "Weekly Energy Practices & Rituals",
    "vip_shop": "Energy Shop Discounts & Talismans",

    "butler_overview_title": "Butler Â· Quick Overview",
    "ov_summary": "Summary",
    "ov_elements": "Element Profile",
    "ov_strategy": "Strategy",
    "ov_focus": "Focus Areas",
    "ov_actions": "3 Actions This Week"
  }
};

// è¯­è¨€ç®¡ç†
const LANG_KEY = "site_lang";

function getLang() {
  return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
}

function setLang(code) {
  localStorage.setItem(LANG_KEY, code);
  document.documentElement.lang = code;
  applyTranslations();
}

function t(key) {
  const lang = getLang();
  return translations[lang]?.[key] || translations["zh-CN"][key] || key;
}

function applyTranslations() {
  // ç¿»è¯‘æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  
  // ç¿»è¯‘å ä½ç¬¦
  document.querySelectorAll("[data-i18n-ph]").forEach(el => {
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  
  // æ›´æ–°å¿ƒæ€œç®¡å®¶èŠ¯ç‰‡
  updateButlerChips();
}

function updateButlerChips() {
  const chips = {
    'career': 'butler_chip_career',
    'love': 'butler_chip_love',
    'wealth': 'butler_chip_wealth',
    'health': 'butler_chip_health',
    'personality': 'butler_chip_personality'
  };
  
  Object.entries(chips).forEach(([type, key]) => {
    const chip = document.querySelector(`[data-question="${type}"]`);
    if (chip) {
      chip.textContent = t(key);
    }
  });
  
  // æ›´æ–°ç®¡å®¶æ ‡é¢˜
  const butlerTitle = document.querySelector('.butler-title');
  if (butlerTitle) {
    butlerTitle.textContent = t('butler_title');
  }
}

// ================== é…ç½® & å·¥å…·å‡½æ•° ==================
const $ = id => document.getElementById(id);

function showErr(msg){ 
  const e = $("error"); 
  if(!e) return; 
  e.textContent = msg; 
  e.style.display = "block"; 
  setTimeout(() => { e.style.display = 'none' }, 5000); 
}

function hideErr(){ 
  const e = $("error"); 
  if(!e) return; 
  e.style.display = "none"; 
  e.textContent = ""; 
}

function lock(el, v){ 
  if(el) el.disabled = v; 
}

function setText(id, v){ 
  const el = $(id); 
  if(el) el.textContent = v; 
}

function setBar(el, pct){ 
  if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; 
}

// ================== å…«å­—è®¡ç®—å™¨æ ¸å¿ƒ ==================
class BaziCalculator {
  constructor(){
    this.HEAVENLY_STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC = ['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  calculateYearPillar(year){ 
    const s = (year - 4) % 10;
    const b = (year - 4) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(s + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(b + 12) % 12],
      zodiac: this.ZODIAC[(b + 12) % 12]
    }; 
  }

  solarMonthIndex(y, m, d){ 
    const mmdd = m * 100 + d;
    const gates = [
      [106,12], [204,1], [306,2], [405,3], [506,4], 
      [606,5], [707,6], [808,7], [908,8], [1008,9], 
      [1107,10], [1207,11]
    ];
    let idx = 11;
    for(const [thr, val] of gates) {
      if(mmdd >= thr) idx = val;
    }
    const branchBy = {
      1:'å¯…', 2:'å¯', 3:'è¾°', 4:'å·³', 5:'åˆ', 
      6:'æœª', 7:'ç”³', 8:'é…‰', 9:'æˆŒ', 10:'äº¥', 
      11:'å­', 12:'ä¸‘'
    };
    return { index: idx, branch: branchBy[idx] };
  }

  calculateMonthPillar(year, month, day){ 
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2, 1:4, 2:6, 3:8, 4:0, 5:2, 6:4, 7:6, 8:8, 9:0};
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branch
    };
  }

  calculateDayPillar(year, month, day){ 
    const baseUTC = Date.UTC(1900, 0, 31);
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx = (0 + dayDiff) % 10;
    const branchIdx = (4 + dayDiff) % 12;
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx + 10) % 10],
      branch: this.EARTHLY_BRANCHES[(branchIdx + 12) % 12]
    };
  }

  calculateHourPillar(dayStem, hour){ 
    const branchMap = {
      23:'å­', 0:'å­', 1:'ä¸‘', 2:'ä¸‘', 3:'å¯…', 4:'å¯…',
      5:'å¯', 6:'å¯', 7:'è¾°', 8:'è¾°', 9:'å·³', 10:'å·³',
      11:'åˆ', 12:'åˆ', 13:'æœª', 14:'æœª', 15:'ç”³', 16:'ç”³',
      17:'é…‰', 18:'é…‰', 19:'æˆŒ', 20:'æˆŒ', 21:'äº¥', 22:'äº¥'
    };
    const startMap = {0:0, 1:2, 2:4, 3:6, 4:8, 5:0, 6:2, 7:4, 8:6, 9:8};
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx],
      branch: branchMap[hour]
    };
  }

  getElement(stem, branch){ 
    const s = {
      'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 
      'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 
      'å£¬':'æ°´', 'ç™¸':'æ°´'
    };
    const b = {
      'å­':'æ°´', 'ä¸‘':'åœŸ', 'å¯…':'æœ¨', 'å¯':'æœ¨', 
      'è¾°':'åœŸ', 'å·³':'ç«', 'åˆ':'ç«', 'æœª':'åœŸ', 
      'ç”³':'é‡‘', 'é…‰':'é‡‘', 'æˆŒ':'åœŸ', 'äº¥':'æ°´'
    };
    return `${s[stem]}${b[branch]}`;
  }

  getNayin(stem, branch){ 
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si * 2 + bi) % this.NAYIN.length];
  }

  getStemElement(stem){ 
    return {
      'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 
      'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 
      'å£¬':'æ°´', 'ç™¸':'æ°´'
    }[stem];
  }

  getBranchElement(branch){ 
    return {
      'å­':'æ°´', 'ä¸‘':'åœŸ', 'å¯…':'æœ¨', 'å¯':'æœ¨', 
      'è¾°':'åœŸ', 'å·³':'ç«', 'åˆ':'ç«', 'æœª':'åœŸ', 
      'ç”³':'é‡‘', 'é…‰':'é‡‘', 'æˆŒ':'åœŸ', 'äº¥':'æ°´'
    }[branch];
  }

  calculateBazi(year, month, day, hour = 12, timeUnknown = false){
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'ï¼Ÿ', branch:'ï¼Ÿ'} : this.calculateHourPillar(dayP.stem, hour);
    
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = {
      year: yearP,
      month: monthP,
      day: {...dayP, element: dayElement},
      hour: hourP
    };

    // è®¡ç®—äº”è¡Œåˆ†å¸ƒ
    const cnt = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
    const pillarsToCount = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    
    pillarsToCount.forEach(p => {
      if(p.stem && p.stem !== 'ï¼Ÿ') cnt[this.getStemElement(p.stem)] += 1;
      if(p.branch && p.branch !== 'ï¼Ÿ') cnt[this.getBranchElement(p.branch)] += 1;
    });

    const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
    const pct = {
      wood: cnt['æœ¨'] / total * 100,
      fire: cnt['ç«'] / total * 100,
      earth: cnt['åœŸ'] / total * 100,
      metal: cnt['é‡‘'] / total * 100,
      water: cnt['æ°´'] / total * 100
    };

    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}

const baziCalculator = new BaziCalculator();

// ================== å¢å¼ºçš„AIé™ªä¼´æˆé•¿ç®¡å®¶ ==================
class GrowthAdvisor {
  constructor() {
    this.growthPaths = {
      'æœ¨æ—º': {
        challenge: "ç«äº‰å‹åŠ›å¤§ï¼Œæ˜“ä¸äººå†²çª",
        solution: "å­¦ä¹ åˆä½œå…±èµ¢ï¼ŒåŸ¹å…»è€å¿ƒ",
        dailyPractice: ["æ™¨é—´å†¥æƒ³", "å›¢é˜Ÿè¿åŠ¨", "å­¦ä¹ å€¾å¬"],
        affirmation: "æˆ‘åƒå¤§æ ‘ä¸€æ ·ï¼Œæ—¢æŒºæ‹”åˆåŒ…å®¹"
      },
      'ç«å¼±': {
        challenge: "ç¼ºä¹è¡ŒåŠ¨åŠ›ï¼Œæ˜“çŠ¹è±«ä¸å†³",
        solution: "è®¾å®šå°ç›®æ ‡ï¼ŒåŸ¹å…»è¡ŒåŠ¨ä¹ æƒ¯",
        dailyPractice: ["æ¯æ—¥è¿åŠ¨15åˆ†é’Ÿ", "å…¬å¼€è¡¨è¾¾æƒ³æ³•", "å°è¯•æ–°äº‹ç‰©"],
        affirmation: "æˆ‘çš„å†…åœ¨ç«ç„°æ­£åœ¨ç‡ƒçƒ§ï¼Œå¸¦æˆ‘å‘å‰"
      }
    };
  }
  
  generateGrowthPlan(baziAnalysis) {
    const plan = {
      weeklyFocus: this.getWeeklyFocus(baziAnalysis),
      energyManagement: this.getEnergyTips(baziAnalysis),
      relationshipAdvice: this.getRelationshipTips(baziAnalysis)
    };
    return plan;
  }

  getWeeklyFocus(analysis) {
    const { strength, usefulElements } = analysis;
    
    if (strength.mark === 'åå¼º') {
      return {
        theme: "é‡Šæ”¾ä¸è½¬åŒ–",
        tasks: [
          "åˆ›ä½œè¾“å‡ºï¼šå†™ä¸€ç¯‡æ–‡ç« æˆ–å½•åˆ¶è§†é¢‘",
          "è¿åŠ¨æ’è§£ï¼šé«˜å¼ºåº¦é—´æ­‡è®­ç»ƒ",
          "ç¤¾äº¤åˆ†äº«ï¼šç»„ç»‡å°å‹èšä¼š"
        ]
      };
    } else {
      return {
        theme: "ç§¯ç´¯ä¸æ»‹å…»", 
        tasks: [
          "å­¦ä¹ å……ç”µï¼šå®Œæˆä¸€ä¸ªåœ¨çº¿è¯¾ç¨‹",
          "é™å¿ƒå…»æ€§ï¼šæ¯æ—¥å†¥æƒ³10åˆ†é’Ÿ",
          "å»ºç«‹ä¹ æƒ¯ï¼šè§„å¾‹ä½œæ¯"
        ]
      };
    }
  }

  getEnergyTips(analysis) {
    const { percents } = analysis;
    const tips = [];
    
    if (percents.wood > 40) tips.push("å¤šæ¥è§¦æ°´å…ƒç´ ç¯å¢ƒå¹³è¡¡æœ¨æ°”");
    if (percents.fire < 15) tips.push("å¢åŠ çº¢è‰²è£…é¥°ç‰©æå‡ç«èƒ½é‡");
    if (percents.water === 0) tips.push("å¤šå–æ°´ï¼Œæ¥è§¦è“è‰²ç‰©å“è¡¥å……æ°´å…ƒç´ ");
    
    return tips.length > 0 ? tips : ["ä¿æŒå½“å‰èƒ½é‡å¹³è¡¡çŠ¶æ€"];
  }

  getRelationshipTips(analysis) {
    const { pillars } = analysis;
    
    if (pillars.day.stem === 'ç”²' || pillars.day.stem === 'ä¹™') {
      return {
        communication: "ç›´æ¥è¡¨è¾¾ï¼Œé¿å…ç»•å¼¯å­",
        partnership: "å¯»æ‰¾åœŸå…ƒç´ å¼ºçš„ä¼´ä¾£å¹³è¡¡",
        conflict: "é‡åˆ°å†²çªå…ˆå†·é™å†æ²Ÿé€š"
      };
    }
    
    return {
      communication: "æ¸©å’Œè¡¨è¾¾ï¼Œæ³¨é‡æƒ…æ„Ÿäº¤æµ",
      partnership: "å¯»æ‰¾äº’è¡¥æ€§æ ¼çš„ä¼´ä¾£",
      conflict: "å¤šå€¾å¬å¯¹æ–¹éœ€æ±‚"
    };
  }
}

class ButlerAI {
  constructor() {
    this.currentAnalysis = null;
    this.growthAdvisor = new GrowthAdvisor();
    this.advancedKnowledge = this.initAdvancedKnowledge();
  }

  initAdvancedKnowledge() {
    return {
      stemTraits: {
        'ç”²': { nature: 'é˜³æœ¨', image: 'å‚å¤©å¤§æ ‘', traits: ['é¢†å¯¼åŠ›', 'æ­£ç›´', 'å¼€æ‹“ç²¾ç¥'], weakness: ['å›ºæ‰§', 'ç¼ºä¹å¼¹æ€§'] },
        'ä¹™': { nature: 'é˜´æœ¨', image: 'è—¤è”“èŠ±è‰', traits: ['çµæ´»', 'é€‚åº”åŠ›å¼º', 'è‰ºæœ¯æ€§'], weakness: ['ä¼˜æŸ”å¯¡æ–­', 'ä¾èµ–æ€§å¼º'] },
        'ä¸™': { nature: 'é˜³ç«', image: 'å¤ªé˜³', traits: ['çƒ­æƒ…', 'å…‰æ˜', 'æ„ŸæŸ“åŠ›'], weakness: ['æ€¥èº', 'å†²åŠ¨'] },
        'ä¸': { nature: 'é˜´ç«', image: 'ç¯çƒ›', traits: ['ç»†è‡´', 'ä¸“æ³¨', 'æ™ºæ…§'], weakness: ['å¤šç–‘', 'è®¡è¾ƒ'] },
        'æˆŠ': { nature: 'é˜³åœŸ', image: 'åŸå¢™åšåœŸ', traits: ['ç¨³é‡', 'è¯šä¿¡', 'è´£ä»»å¿ƒ'], weakness: ['å›ºæ‰§', 'ç¼ºä¹å˜é€š'] },
        'å·±': { nature: 'é˜´åœŸ', image: 'ç”°å›­ä¹‹åœŸ', traits: ['åŒ…å®¹', 'ç»†è…»', 'åŠ¡å®'], weakness: ['ä¼˜æŸ”å¯¡æ–­', 'ä¾èµ–æ€§å¼º'] },
        'åºš': { nature: 'é˜³é‡‘', image: 'åˆ€å‰‘åˆ©å™¨', traits: ['æœæ–­', 'åˆšæ¯…', 'æ­£ä¹‰æ„Ÿ'], weakness: ['å›ºæ‰§', 'ç¼ºä¹æŸ”æƒ…'] },
        'è¾›': { nature: 'é˜´é‡‘', image: 'ç å®é¦–é¥°', traits: ['ç²¾è‡´', 'æ•é”', 'è¿½æ±‚å®Œç¾'], weakness: ['è®¡è¾ƒ', 'ç¼ºä¹å¤§æ°”'] },
        'å£¬': { nature: 'é˜³æ°´', image: 'æ±Ÿæ²³æ¹–æµ·', traits: ['æ™ºæ…§', 'åŒ…å®¹', 'é€‚åº”åŠ›'], weakness: ['éšæ³¢é€æµ', 'ç¼ºä¹åŸåˆ™'] },
        'ç™¸': { nature: 'é˜´æ°´', image: 'é›¨éœ²ä¹‹æ°´', traits: ['ç»†è…»', 'æ•æ„Ÿ', 'æ´å¯ŸåŠ›'], weakness: ['å¤šè™‘', 'ç¼ºä¹å†³æ–­'] }
      }
    };
  }

  // å¿«é€Ÿæ€»è§ˆæ–¹æ³•
  getOverviewInCurrentLanguage() {
    if (!this.currentAnalysis) return t('butler_loading');
    const lang = getLang();
    return this._generateOverview(this.currentAnalysis, lang);
  }

  _generateOverview(analysis, lang) {
    const dm = analysis.pillars.day.stem + analysis.pillars.day.element;
    const strength = this.tStrength(analysis.strength.mark);
    const focus = this.tStrategy(analysis.strength.focus);
    const p = analysis.percents;

    const elements = [
      {k:'æœ¨', v: p.wood}, {k:'ç«', v:p.fire}, {k:'åœŸ', v:p.earth}, 
      {k:'é‡‘', v:p.metal}, {k:'æ°´', v:p.water}
    ];
    const strongest = elements.reduce((a,b)=>a.v>b.v?a:b);
    const weakest = elements.reduce((a,b)=>a.v<b.v?a:b);

    const useful = analysis.usefulElements.useful.join(lang==='en'?', ':'ã€');
    const avoid = analysis.usefulElements.avoid.length ? 
      (lang==='en'?'Avoid: ':'æ³¨æ„ï¼š') + analysis.usefulElements.avoid.join(lang==='en'?', ':'ã€') : '';

    const head = (k) => ({
      'zh-CN':`ã€${t(k)}ã€‘`,
      'en':`[${t(k)}]`
    }[lang] || `[${t(k)}]`);

    let s = `${t('butler_overview_title')}\n\n`;

    s += `${head('ov_summary')}\n` +
         `æ—¥ä¸» ${dm} Â· ${strength}\n\n`;

    s += `${head('ov_elements')}\n` +
         `å¼ºï¼š${strongest.k} ${Math.round(strongest.v)}% Â· å¼±ï¼š${weakest.k} ${Math.round(weakest.v)}%\n\n`;

    s += `${head('ov_strategy')}\n` +
         `ç”¨ã€Œ${focus}ã€ï¼›å¢å¼ºï¼š${useful}${avoid?` Â· ${avoid}`:''}\n\n`;

    // é‡ç‚¹æ–¹å‘
    const focusLines = [];
    if(this.hasWoodFireStructure(analysis.pillars)) 
      focusLines.push(lang==='en'?'Create/teach/brand via content':'å†…å®¹/æ•™å­¦/å“ç‰Œè¡¨è¾¾');
    if(analysis.pillars.hour.stem==='åºš') 
      focusLines.push(lang==='en'?'Compete/build standards':'ç«äº‰/æ ‡å‡†åŒ–');
    if(!focusLines.length) 
      focusLines.push(lang==='en'?'Stabilize offer â†’ price â†’ SOP':'å›ºå®šäº§å“ â†’ å®šä»· â†’ SOP');

    s += `${head('ov_focus')}\n` + 'â€¢ ' + focusLines.join('\nâ€¢ ') + `\n\n`;

    s += `${head('ov_actions')}\n` +
         (lang==='en'
          ? `1) Ship one piece of content\n2) Package & price one offer\n3) Add/upgrade one SOP`
          : `1ï¼‰è¾“å‡ºä¸€ç¯‡å†…å®¹\n2ï¼‰æ‰“åŒ…å¹¶å®šä»·ä¸€ä¸ªäº§å“\n3ï¼‰æ–°å¢/å‡çº§ä¸€æ¡SOP`);

    if(analysis.timeUnknown){
      s += (lang==='en'
        ? `\n\nâš ï¸ Note: hour pillar missing`
        : `\n\nâš ï¸ æç¤ºï¼šå› å‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±`);
    }
    return s;
  }

  // æ·±åº¦æŒ‡å¯¼æ–¹æ³•
  getAdvancedCareerAdvice(analysis) {
    const lang = getLang();
    const lanes = this.hasWoodFireStructure(analysis.pillars)
      ? (lang==='en'
          ? ['Content/education/brand', 'Advisory & training', 'Creative commerce']
          : ['å†…å®¹/æ•™è‚²/å“ç‰Œ', 'å’¨è¯¢ä¸åŸ¹è®­', 'åˆ›æ„å‹å•†ä¸š'])
      : (lang==='en'?['Management/ops','Specialist track']:['ç®¡ç†/è¿è¥','ä¸“ä¸šè·¯çº¿']);

    const playbook = (lang==='en'
      ? [
          'Quarter theme â†’ monthly launch â†’ weekly ship.',
          'One flagship offering; one evergreen lead magnet.',
          'Calendar blocks: create / monetize / systemize.'
        ]
      : [
          'å­£åº¦ä¸»é¢˜ â†’ æœˆåº¦ä¸Šæ–° â†’ æ¯å‘¨äº¤ä»˜ã€‚',
          'è‡³å°‘ä¸€ä¸ªæ——èˆ°æœåŠ¡ + ä¸€ä¸ªé•¿æœŸå¼•æµå“ã€‚',
          'æ—¥å†åˆ†åŒºï¼šåˆ›ä½œ / å˜ç° / æ ‡å‡†åŒ–ã€‚'
        ]);

    return (lang==='en'
      ? `ğŸ’¼ Career (Deep Guidance)\n\nSuggested paths:\n- `+lanes.join(`\n- `)+`\n\nGrowth Playbook:\n- `+playbook.join(`\n- `)
      : `ğŸ’¼ äº‹ä¸šæ·±åº¦æŒ‡å¯¼\n\né€‚é…èµ›é“ï¼š\n- `+lanes.join(`\n- `)+`\n\næˆé•¿è·¯å¾„ï¼š\n- `+playbook.join(`\n- `));
  }

  getAdvancedWealthAdvice(analysis) {
    const lang = getLang();
    const tips = (lang==='en')
      ? [
          'Build value ladder: entry â†’ core â†’ premium offers',
          'Weekly finance review: revenue Â· profit Â· receivables',
          'Package skills into sellable products & services',
          'Track key metrics: conversion rate & repeat business'
        ]
      : [
          'æ­å»ºä»·å€¼é˜¶æ¢¯ï¼šå¼•æµæ¬¾ â†’ æ ¸å¿ƒæ¬¾ â†’ é«˜å®¢å•',
          'æ¯å‘¨è´¢åŠ¡å¤ç›˜ï¼šè¥æ”¶ã€åˆ©æ¶¦ã€åº”æ”¶è´¦æ¬¾',
          'å°†æŠ€èƒ½æ‰“åŒ…æˆå¯é”€å”®çš„äº§å“æœåŠ¡',
          'å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡ï¼šè½¬åŒ–ç‡ä¸å¤è´­ç‡'
        ];
    return (lang==='en'
      ? `ğŸ’° Wealth Building Strategy\n\nâ€¢ Best offers: content/products, consulting, membership\nâ€¢ Pricing: maintain 3 tiers (Good/Better/Best)\n\nAction Steps:\n- `+tips.join(`\n- `)
      : `ğŸ’° è´¢å¯Œå»ºè®¾ç­–ç•¥\n\nâ€¢ æœ€ä½³äº§å“ï¼šå†…å®¹/è¯¾ç¨‹ã€å’¨è¯¢æœåŠ¡ã€ä¼šå‘˜\nâ€¢ å®šä»·ç­–ç•¥ï¼šä¿æŒä¸‰æ¡£ï¼ˆå…¥é—¨/æ ‡å‡†/æ——èˆ°ï¼‰\n\næ‰§è¡Œæ­¥éª¤ï¼š\n- `+tips.join(`\n- `));
  }

  getAdvancedLoveAdvice(analysis) {
    const lang = getLang();
    return (lang==='en'
      ? `â¤ï¸ Relationship Guidance\n\nYour style: expressive + principled. Best matches respect boundaries and growth.\n\nWeekly Practices:\n- Check-in conversations (facts/feelings/needs)\n- Shared financial & time planning\n- Monthly appreciation celebrations`
      : `â¤ï¸ æ„Ÿæƒ…å…³ç³»æŒ‡å¯¼\n\næ‚¨çš„é£æ ¼ï¼šè¡¨è¾¾å‹ + åŸåˆ™æ„Ÿã€‚é€‚åˆå°Šé‡è¾¹ç•Œã€æ„¿æ„å…±åŒæˆé•¿çš„ä¼´ä¾£ã€‚\n\næ¯å‘¨ç»ƒä¹ ï¼š\n- æ·±åº¦å¯¹è¯ï¼ˆäº‹å®/æ„Ÿå—/éœ€æ±‚ï¼‰\n- å…±åŒè´¢åŠ¡ä¸æ—¶é—´è§„åˆ’\n- æ¯æœˆæ„Ÿæ©åº†ç¥`);
  }

  getAdvancedHealthAdvice(analysis) {
    const lang = getLang();
    const weakest = Object.entries(analysis.percents).sort((a,b)=>a[1]-b[1])[0][0];
    const elementNames = {
      wood: lang==='en'?'Wood':'æœ¨', fire:lang==='en'?'Fire':'ç«', 
      earth:lang==='en'?'Earth':'åœŸ', metal:lang==='en'?'Metal':'é‡‘', 
      water:lang==='en'?'Water':'æ°´'
    };
    const rec = (lang==='en'
      ? [
          'Prioritize sleep & daily rhythm; 90-min focus blocks',
          'Hydration & breathing exercises',
          'Light cardio + mobility; avoid late caffeine'
        ]
      : [
          'ä¼˜å…ˆè§„å¾‹ä½œæ¯ï¼šå›ºå®šç¡çœ ä¸90åˆ†é’Ÿä¸“æ³¨å—',
          'å……åˆ†è¡¥æ°´ä¸å‘¼å¸ç»ƒä¹ ',
          'è½»æœ‰æ°§+çµæ´»åº¦è®­ç»ƒï¼›æ™šé—´é¿å…å’–å•¡å› '
        ]);
    return (lang==='en'
      ? `ğŸŒ¿ Wellness Plan\n\nWeaker element: ${elementNames[weakest]}\n\nDaily Practices:\n- `+rec.join(`\n- `)
      : `ğŸŒ¿ å¥åº·å…»ç”Ÿè®¡åˆ’\n\nåå¼±å…ƒç´ ï¼š${elementNames[weakest]}\n\næ¯æ—¥ç»ƒä¹ ï¼š\n- `+rec.join(`\n- `));
  }

  getAdvancedPersonalityDetail(analysis) {
    const lang = getLang();
    const traits = this.advancedKnowledge.stemTraits[analysis.pillars.day.stem].traits.join(lang==='en'?', ': 'ã€');
    const watch = this.advancedKnowledge.stemTraits[analysis.pillars.day.stem].weakness.join(lang==='en'?', ': 'ã€');
    return (lang==='en'
      ? `ğŸŒŸ Personality Insights\n\nCore strengths: ${traits}\nGrowth areas: ${watch}`
      : `ğŸŒŸ æ€§æ ¼æ·±åº¦è§£æ\n\næ ¸å¿ƒä¼˜åŠ¿ï¼š${traits}\næˆé•¿æ–¹å‘ï¼š${watch}`);
  }

  // è¾…åŠ©æ–¹æ³•
  tStrength(strength) {
    const map = {
      'åå¼º': t('analysis_strength_strong'),
      'åå¼±': t('analysis_strength_weak'),
      'å¹³è¡¡': t('analysis_strength_balanced')
    };
    return map[strength] || strength;
  }

  tStrategy(strategy) {
    const map = {
      'æ³„ç§€/åˆ¶åŒ–': t('analysis_strategy_drain'),
      'è¡¥åŠ©/é¡ºåŠ¿': t('analysis_strategy_support'),
      'å®ˆä¸­/è°ƒå’Œ': t('analysis_strategy_balance')
    };
    return map[strategy] || strategy;
  }

  hasWoodFireStructure(pillars) {
    const woodCount = this.countElement(pillars, 'æœ¨');
    const fireCount = this.countElement(pillars, 'ç«');
    return woodCount >= 2 && fireCount >= 2;
  }

  countElement(pillars, element) {
    let count = 0;
    Object.values(pillars).forEach(pillar => {
      if (this.advancedKnowledge.stemTraits[pillar.stem]?.nature.includes(element)) count++;
      // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ£€æŸ¥åœ°æ”¯å…ƒç´ 
    });
    return count;
  }

  analyzeBazi(baziData) {
    const { pillars, counts, percents, timeUnknown } = baziData;
    
    // ç®€åŒ–çš„å‘½å±€åˆ†æ
    const strength = this.judgeStrength(pillars, counts);
    const usefulElements = this.analyzeUsefulElements(strength.mark, pillars.day.element);

    this.currentAnalysis = {
      pillars,
      strength,
      usefulElements,
      percents,
      timeUnknown
    };

    return this.currentAnalysis;
  }

  judgeStrength(pillars, counts) {
    const dayElement = pillars.day.element;
    const sameElementCount = counts[dayElement] || 0;
    
    let mark, focus;
    if (sameElementCount >= 3) {
      mark = 'åå¼º';
      focus = 'æ³„ç§€åˆ¶åŒ–';
    } else if (sameElementCount <= 1) {
      mark = 'åå¼±';
      focus = 'ç”Ÿæ‰¶è¡¥åŠ©';
    } else {
      mark = 'å¹³è¡¡';
      focus = 'å®ˆä¸­è°ƒå’Œ';
    }
    
    return { mark, focus };
  }

  analyzeUsefulElements(strength, dmElem) {
    if (strength === 'åå¼º') {
      return {
        useful: this.getWeakeningElements(dmElem),
        avoid: [dmElem]
      };
    } else if (strength === 'åå¼±') {
      return {
        useful: this.getStrengtheningElements(dmElem),
        avoid: this.getWeakeningElements(dmElem)
      };
    } else {
      return {
        useful: ['æœ¨','ç«','åœŸ','é‡‘','æ°´'],
        avoid: []
      };
    }
  }

  getStrengtheningElements(element) {
    const map = {
      'æœ¨': ['æœ¨', 'æ°´'],
      'ç«': ['ç«', 'æœ¨'],
      'åœŸ': ['åœŸ', 'ç«'],
      'é‡‘': ['é‡‘', 'åœŸ'],
      'æ°´': ['æ°´', 'é‡‘']
    };
    return map[element] || [];
  }

  getWeakeningElements(element) {
    const map = {
      'æœ¨': ['ç«', 'åœŸ', 'é‡‘'],
      'ç«': ['åœŸ', 'é‡‘', 'æ°´'],
      'åœŸ': ['é‡‘', 'æ°´', 'æœ¨'],
      'é‡‘': ['æ°´', 'æœ¨', 'ç«'],
      'æ°´': ['æœ¨', 'ç«', 'åœŸ']
    };
    return map[element] || [];
  }

  answerQuestion(questionType) {
    if (!this.currentAnalysis) return 'è¯·å…ˆç”Ÿæˆå…«å­—å‘½ç›˜';
    
    switch(questionType) {
      case 'career':
        return this.getAdvancedCareerAdvice(this.currentAnalysis);
      case 'love':
        return this.getAdvancedLoveAdvice(this.currentAnalysis);
      case 'wealth':
        return this.getAdvancedWealthAdvice(this.currentAnalysis);
      case 'health':
        return this.getAdvancedHealthAdvice(this.currentAnalysis);
      case 'personality':
        return this.getAdvancedPersonalityDetail(this.currentAnalysis);
      default:
        return this.getOverviewInCurrentLanguage();
    }
  }
}

const butlerAI = new ButlerAI();

// ================== ç•Œé¢æ¸²æŸ“å‡½æ•° ==================
function renderPillars(root, p, timeUnknown = false) {
  if (!root) return;
  root.innerHTML = '';
  
  [['å¹´æŸ±', p.year], ['æœˆæŸ±', p.month], ['æ—¥æŸ±', p.day], ['æ—¶æŸ±', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === 'æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;
    
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `;
    root.appendChild(div);
  });
}

function displayClassicArea(p, timeUnknown) {
  const getElement = (s, b) => baziCalculator.getElement(s, b);
  const getNayin = (s, b) => baziCalculator.getNayin(s, b);
  
  setText('year-stem', p.year.stem);
  setText('month-stem', p.month.stem);
  setText('day-stem', p.day.stem);
  setText('hour-stem', timeUnknown ? 'ï¼Ÿ' : p.hour.stem);
  
  setText('year-branch', p.year.branch);
  setText('month-branch', p.month.branch);
  setText('day-branch', p.day.branch);
  setText('hour-branch', timeUnknown ? 'ï¼Ÿ' : p.hour.branch);
  
  setText('year-element', getElement(p.year.stem, p.year.branch));
  setText('month-element', getElement(p.month.stem, p.month.branch));
  setText('day-element', getElement(p.day.stem, p.day.branch));
  setText('hour-element', timeUnknown ? 'æœªçŸ¥' : getElement(p.hour.stem, p.hour.branch));
  
  setText('year-nayin', getNayin(p.year.stem, p.year.branch));
  setText('month-nayin', getNayin(p.month.stem, p.month.branch));
  setText('day-nayin', getNayin(p.day.stem, p.day.branch));
  setText('hour-nayin', timeUnknown ? 'æœªçŸ¥' : getNayin(p.hour.stem, p.hour.branch));
}

function updateButlerDisplay(content, questionType = 'overview') {
  const el = $('butler-content');
  if (!el) return;
  
  el.innerHTML = `<div style="white-space:pre-wrap;line-height:1.6;">${content}</div>`;
}

function showButlerLoading() {
  const butlerContent = $('butler-content');
  if (!butlerContent) return;
  
  butlerContent.innerHTML = `
    <div style="text-align: center; padding: 20px; color: var(--muted);">
      ${t('butler_loading')}
    </div>
  `;
}

function showGrowthTracker(analysis) {
  const tracker = $('growthTracker');
  if (tracker) {
    tracker.style.display = 'block';
    
    // æ ¹æ®åˆ†æç»“æœæ›´æ–°æ¯æ—¥èƒ½é‡æé†’
    const energyTip = $('dailyEnergyTip');
    if (energyTip && analysis) {
      const { strength, usefulElements } = analysis;
      if (strength.mark === 'åå¼º') {
        energyTip.textContent = 'æ ¹æ®æ‚¨çš„å‘½ç›˜ï¼Œä»Šå¤©é€‚åˆï¼šåˆ›æ„è¾“å‡ºã€è¿åŠ¨é‡Šæ”¾ã€ç¤¾äº¤åˆ†äº«';
      } else {
        energyTip.textContent = 'æ ¹æ®æ‚¨çš„å‘½ç›˜ï¼Œä»Šå¤©é€‚åˆï¼šå­¦ä¹ å……ç”µã€é™å¿ƒå…»æ€§ã€å»ºç«‹ä¹ æƒ¯';
      }
    }
  }
}

// ================== ä¸»é€»è¾‘å‡½æ•° ==================
async function genChart() {
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  
  if (!birth) {
    showErr(t('err_birthdate_required'));
    return;
  }

  const btn = $('genBtn');
  const tx = $('genBtnText');
  const ld = $('genBtnLoading');
  
  if (btn) btn.disabled = true;
  if (tx) tx.style.display = 'none';
  if (ld) ld.style.display = 'inline-block';

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12;
    
    if (!timeUnknown) {
      const t = ($('birthtime')?.value || '').trim();
      if (t) {
        const h = parseInt(t.split(':')[0], 10);
        if (!Number.isNaN(h)) hour = h;
      }
    }

    // è®¡ç®—å…«å­—
    const baziData = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    const { pillars, counts, percents, timeUnknown: tu } = baziData;

    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result')?.style.setProperty('display', 'block');
    
    // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
    const timeText = tu ? t('cb_time_unknown') : (hour + 'æ—¶');
    setText('bazi-date', `${t('label_birthdate')}: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if (tu) {
      const el = $('bazi-date');
      if (el) el.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>';
    }

    // æ¸²æŸ“å››æŸ±
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    // æ›´æ–°äº”è¡Œæ¡
    setBar($('bar-æœ¨'), percents.wood);
    setText('pct-æœ¨', Math.round(percents.wood) + '%');
    setBar($('bar-ç«'), percents.fire);
    setText('pct-ç«', Math.round(percents.fire) + '%');
    setBar($('bar-åœŸ'), percents.earth);
    setText('pct-åœŸ', Math.round(percents.earth) + '%');
    setBar($('bar-é‡‘'), percents.metal);
    setText('pct-é‡‘', Math.round(percents.metal) + '%');
    setBar($('bar-æ°´'), percents.water);
    setText('pct-æ°´', Math.round(percents.water) + '%');

    // äº”è¡Œå¹³è¡¡æç¤º
    const elements = [
      { name: t('el_wood'), value: percents.wood },
      { name: t('el_fire'), value: percents.fire },
      { name: t('el_earth'), value: percents.earth },
      { name: t('el_metal'), value: percents.metal },
      { name: t('el_water'), value: percents.water }
    ];
    
    const strongest = elements.reduce((a, b) => a.value > b.value ? a : b);
    const weakest = elements.reduce((a, b) => a.value < b.value ? a : b);
    
    setText('bazi-elements-balance', 
      `äº”è¡Œä¸­${strongest.name}å…ƒç´ æœ€å¼ºï¼Œ${weakest.name}å…ƒç´ æœ€å¼±ã€‚`
    );

    // å¿ƒæ€œç®¡å®¶åˆ†æ
    showButlerLoading();
    
    // æ¨¡æ‹Ÿåˆ†ææ—¶é—´
    setTimeout(() => {
      const analysis = butlerAI.analyzeBazi(baziData);
      // æ˜¾ç¤ºå¿«é€Ÿæ€»è§ˆ
      updateButlerDisplay(butlerAI.getOverviewInCurrentLanguage(), 'overview');
      // æ˜¾ç¤ºæˆé•¿è·Ÿè¸ªå™¨
      showGrowthTracker(analysis);
    }, 1000);

  } catch (err) {
    console.error(err);
    showErr(t('err_calculation_failed'));
  } finally {
    if (btn) btn.disabled = false;
    if (tx) tx.style.display = 'inline';
    if (ld) ld.style.display = 'none';
  }
}

// ================== åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ ==================
function initLanguageSystem() {
  const langSelect = $('langSelect');
  if (langSelect) {
    langSelect.value = getLang();
    langSelect.addEventListener('change', (e) => {
      setLang(e.target.value);
      // é‡æ–°ç”Ÿæˆå½“å‰å†…å®¹
      if (butlerAI.currentAnalysis) {
        updateButlerDisplay(butlerAI.getOverviewInCurrentLanguage(), 'overview');
      }
    });
  }
  
  applyTranslations();
}

// ================== äº‹ä»¶ç›‘å¬ ==================
document.addEventListener('DOMContentLoaded', () => {
  // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
  initLanguageSystem();
  
  // ç”ŸæˆæŒ‰é’®äº‹ä»¶
  const genBtn = $('genBtn');
  if (genBtn) {
    genBtn.addEventListener('click', genChart);
  }

  // å¿ƒæ€œç®¡å®¶èŠ¯ç‰‡ç‚¹å‡»äº‹ä»¶
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('butler-chip')) {
      const questionType = e.target.getAttribute('data-question');
      if (butlerAI.currentAnalysis) {
        const content = butlerAI.answerQuestion(questionType);
        updateButlerDisplay(content, questionType);
      } else {
        showErr('è¯·å…ˆç”Ÿæˆå…«å­—å‘½ç›˜');
      }
    }
  });

  // å‡ºç”Ÿæ—¶é—´ä¸è¯¦å¤é€‰æ¡†äº‹ä»¶
  const timeUnknown = $('timeUnknown');
  const birthtime = $('birthtime');
  if (timeUnknown && birthtime) {
    timeUnknown.addEventListener('change', () => {
      birthtime.disabled = timeUnknown.checked;
    });
  }

  // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
  const birthdate = $('birthdate');
  if (birthdate && !birthdate.value) {
    birthdate.value = new Date().toISOString().split('T')[0];
  }

  // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
  ['birthdate', 'birthtime'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          genChart();
        }
      });
    }
  });

  // æˆé•¿è·Ÿè¸ªå™¨ä»»åŠ¡å®Œæˆäº‹ä»¶
  document.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox' && e.target.closest('.mission-item')) {
      const completed = document.querySelectorAll('.mission-item input:checked').length;
      const total = document.querySelectorAll('.mission-item input').length;
      const progress = Math.round((completed / total) * 100);
      
      const progressCircle = document.querySelector('.progress-ring circle:last-child');
      const progressText = document.querySelector('.progress-ring span');
      
      if (progressCircle && progressText) {
        const circumference = 2 * Math.PI * 25;
        const offset = circumference - (progress / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
        progressText.textContent = progress + '%';
      }
    }
  });
});

console.log('AIé™ªä¼´æˆé•¿ç®¡å®¶ç³»ç»Ÿå·²åŠ è½½å®Œæˆï¼');
</script>
</body>
</html>
