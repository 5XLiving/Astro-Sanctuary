<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
    .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
    .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}

    .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
    .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
    .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* â€”â€” å‡ºç”Ÿæ—¶é—´ï¼šæ—¶é—´è¾“å…¥ + â€œä¸è¯¦â€åŒä¸€è¡Œ â€”â€” */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* â€”â€” éšè—â€œä¼°æ—¶é—´â€æŒ‰é’®ï¼šä»…å‹¾é€‰ä¸è¯¦æ—¶å¼¹çª— â€”â€” */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* â€”â€” å³ä¸‹è§’å¿ƒæ€œç®¡å®¶ï¼ˆé—®ï¼‰ â€”â€” */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
/* èŠå¤©è¾“å…¥è¡Œï¼šè¾“å…¥æ¡†æ’‘æ»¡ã€æŒ‰é’®æŒ‰å†…å®¹è‡ªé€‚åº” */
.ss-chat-input{
  display:flex; align-items:center; gap:8px;
  padding:10px 12px; border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto; min-width:0;
}
.ss-chat-input .btn,
.ss-chat-input button{
  flex:0 0 auto;
  width:auto !important;
  white-space:nowrap;
  padding:10px 14px;
}

    /* â€”â€” ä¼šå‘˜åŒºå¸ƒå±€ â€”â€” */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* â€”â€” åªä¿ç•™ä¸€ä¸ª GPT çª—å£ï¼šéšè—ç»“æœåŒºçš„ GPT æŠ½å±‰ â€”â€” */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* â€”â€” ä¼°æ—¶é—´å¼¹çª— â€”â€” */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    /* ä¿®å¤ï¼šGrid å­é¡¹å…è®¸æ”¶ç¼©ï¼Œé¿å…å†…å®¹æŠŠé¢æ¿æ’‘ç ´ */
.auth-grid > * { min-width: 0; }
.panel .body .row.one > * { min-width: 0; }

/* è®©ä¼šå‘˜æŒ‰é’®åœ¨çª„å®½åº¦ä¸‹èƒ½æ¢è¡Œã€å±…ä¸­ä¸”ä¸æº¢å‡º */
.panel .body .btn {
  display: flex;               /* æ”¹ä¸º flex æ›´ç¨³ */
  align-items: center;
  justify-content: center;
  text-align: center;
  white-space: normal;         /* å…è®¸æ¢è¡Œ */
  line-height: 1.2;
  word-break: break-word;      /* å¤šè¯­è¨€/é•¿è¯å¯æ–­è¡Œ */
}

/* å—çº§æŒ‰é’®ç¡®ä¿å æ»¡å®¹å™¨ä¸”ä¸è¶…å‡º */
.btn.block { display:block; width:100%; box-sizing:border-box; }

/* å¯é€‰ï¼šå¦‚æœä»æœ‰è½»å¾®ä½ç§»ï¼Œé™åˆ¶æº¢å‡º */
.panel .body { overflow: hidden; }

.panel .body .btn { padding: 10px 14px; }    
    /* === è¡¨å•ç½‘æ ¼ï¼šå¤§å± 3 åˆ—ï¼Œçª„å± 1 åˆ— === */
.row{display:grid;gap:12px;grid-template-columns:1fr;}        /* é»˜è®¤ 1 åˆ— */
.row > *{min-width:0;}                                         /* é˜²æ­¢å­é¡¹æŠŠå®¹å™¨æ’‘çˆ† */
@media (min-width:760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr;}              /* ä¸‰åˆ— */
}

/* æ ‡ç­¾æ›´ç´§å‡‘ */
label.muted{display:block;margin-bottom:4px}

/* æŒ‰é’®ä¸è¦ 100% å®½ */
#genBtn{width:auto !important}
.gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

/* æ—¶é—´è¾“å…¥ä¸â€œä¸è¯¦â€å¹¶æ’ã€ç´§å‡‘ */
.time-row{display:flex;align-items:center;gap:10px}
.time-row input[type="time"]{
  width:auto !important; flex:0 0 160px; min-width:140px;
}
.time-row .time-unknown{white-space:nowrap}
    .title a{ color: inherit; text-decoration: none; }
.title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    /* â€”â€” ç»Ÿä¸€å¤´éƒ¨ â€”â€” */
.site-header{
  position:sticky; top:0; z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

/* å“ç‰ŒåŒºï¼šå¾½ç«  + æ ‡é¢˜ */
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}

/* è¯­è¨€é€‰æ‹©ï¼šé˜²æ­¢â€œè¯­è¨€â€ç«–æ’ã€ä¸ç¬¬ä¸€å¼ ä¸€è‡´ */
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; min-width:170px;
  border-radius:10px; border:1px solid #243244;
  background:#0e1520; color:var(--text);
  padding:10px 34px 10px 12px; font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
/* ä¸ Index ä¿æŒä¸€è‡´çš„æ ¹å­—å·ï¼ˆä¼šå½±å“ rem è®¡ç®—ï¼‰ */
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }

/* æ ‡é¢˜ç”¨ Noto Serif SCï¼›å­—å·/å­—é‡ä¸ Index å®Œå…¨ä¸€è‡´ */
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}    
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <!-- å“ç‰Œï¼šç‚¹å‡»å›åˆ°â€œå…«å­—ç®€è¯„â€æœ¬é¡µ -->
<a class="brand" href="https://astro.5xliving.com/" target="_self">
  <span class="brand-badge">5X</span>
  <span class="title">
    5xLiving Â· <span data-i18n="title_bazi_brief">å…«å­—ç®€è¯„</span>
  </span>
</a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

  <main class="container">
    <section class="card">
<div class="h2" data-i18n="title_quickcalc">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>

<div class="row cols-3">
  <div>
    <label class="muted" data-i18n="label_name">å§“åï¼ˆå¯é€‰ï¼‰</label>
    <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰" data-i18n-ph="ph_name" />
  </div>
  <div>
    <label class="muted" data-i18n="gender_label">æ€§åˆ«</label>
     <select id="gender">
     <option value="" data-i18n="opt_gender_confidential">ä¸é€éœ²</option>
     <option value="male" data-i18n="opt_gender_male">ç”·æ€§</option>
     <option value="female" data-i18n="opt_gender_female">å¥³æ€§</option>
    </select>
  </div>
  <div>
    <label class="muted" data-i18n="label_calendar">å†æ³•</label>
     <select id="calendar">
     <option value="gregorian" data-i18n="opt_cal_gregorian">é˜³å†</option>
     <option value="lunar" data-i18n="opt_cal_lunar">å†œå†</option>
    </select>
  </div>
</div>

<div class="row cols-3" style="margin-top:10px">
  <div>
    <label class="muted" data-i18n="label_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
    <input type="date" id="birthdate" />
  </div>

  <div>
    <label class="muted" data-i18n="label_birthtime">å‡ºç”Ÿæ—¶é—´</label>
    <div class="time-row">
     <input type="time" id="birthtime" value="12:00" />
     <label class="muted time-unknown">
     <input type="checkbox" id="timeUnknown" />
     <span data-i18n="cb_time_unknown">å‡ºç”Ÿæ—¶é—´ä¸è¯¦</span>
      </label>
    </div>
  </div>

  <div class="gen-wrap">
    <button class="btn" id="genBtn">
      <span id="genBtnText" data-i18n="btn_generate_chart">ç”Ÿæˆå…«å­—</span>
      <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
      </div>
</div>

      <div id="error" class="error-message"></div>
    </section>

    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>

        <table class="bazi-table">
          <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
          <tbody>
            <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
            <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
            <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
            <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2" data-i18n="rpt_sec_elements_title">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span data-i18n="el_wood">æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
        <div class="bar-row"><span data-i18n="el_fire">ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
        <div class="bar-row"><span data-i18n="el_earth">åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
        <div class="bar-row"><span data-i18n="el_metal">é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
        <div class="bar-row"><span data-i18n="el_water">æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- ä¼šå‘˜ä¸“åŒº -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  inputmode="email"
                  autocomplete="username" />
                <!-- ç™»å½•/æ³¨å†Œå»ºè®®ç”¨ usernameï¼Œå¯†ç ç®¡ç†å™¨æ›´å®¹æ˜“é…å¯¹ -->

                <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
                <input 
                  id="password" 
                  type="password" 
                  autocomplete="new-password" 
                  placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required/>
              </div>

            
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <!-- ä¼°æ—¶é—´å¼¹çª— -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">ğŸ§­ ä¼°ä¸€ä¸ªå¤§è‡´å‡ºç”Ÿæ—¶é—´</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">é€‰æ‹©ä½ è®°å¾—çš„<strong>å¤§æ¦‚æ—¶æ®µ</strong>ï¼ˆåœ°æ”¯åŒå°æ—¶æ®µï¼‰</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          é€‰æ‹©åç‚¹â€œå¡«å…¥æ—¶é—´â€ï¼Œä¼šç”¨è¯¥æ—¶æ®µçš„ä¸­ä½æ—¶é—´å†™åˆ°ä¸Šæ–¹æ—¶é—´è¾“å…¥æ¡†ï¼Œå¹¶è‡ªåŠ¨å–æ¶ˆâ€œæ—¶é—´ä¸è¯¦â€ã€‚
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">å–æ¶ˆ</button>
        <button class="btn" id="twApply" type="button" disabled>å¡«å…¥æ—¶é—´</button>
      </div>
    </div>
  </div>

<script>
(function(){  
'use strict';

/* =====================================
   Xinlian Butler + å…«å­—æ’ç›˜ï¼ˆæ•´åˆç‰ˆ Â· å®Œæ•´ï¼‰
   - å³ä¸‹è§’ Butler Chat å®Œæ•´å®ç°
   - i18nï¼šè¡¥é½äº”è¡Œ/å­£èŠ‚é»˜è®¤é”®ï¼Œé¿å… data-i18n=el_wood ç­‰æ˜¾ç¤º key
   - è¯­è¨€åˆ‡æ¢ï¼šé‡æ¸²æŠ¥å‘Š + é‡æ–°è·‘ Butler
   - æœ€å°å¯ç”¨çš„ ç™»å½•/æ³¨å†Œ/é‡ç½® å¤„ç†ï¼ˆæ¥ä½ åç«¯å¯ç›´æ”¹ APIï¼‰
   ===================================== */

/* ================== åŸºç¡€é…ç½®/å·¥å…· ================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const LANG_KEY = 'site_lang';

const $ = (id) => document.getElementById(id);
const qs = (s, root = document) => root.querySelector(s);

function showErr(msg) {
  const e = $('error');
  if (!e) return;
  e.textContent = msg;
  e.style.display = 'block';
  setTimeout(() => { e.style.display = 'none'; }, 5000);
}
function hideErr(){ const e=$('error'); if(e){ e.style.display='none'; e.textContent=''; } }
function showAuthErr(msg) {
  const e = $('authError');
  if (!e) return;
  e.textContent = msg;
  e.style.display = 'block';
  setTimeout(() => { e.style.display = 'none'; }, 5000);
}
function hideAuthErr(){ const e=$('authError'); if(e){ e.style.display='none'; e.textContent=''; } }
function lock(el, v){ if(el) el.disabled = v; }
function strongPwd(pw){
  return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
}
function setText(id,v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ================== å¤šè¯­è¨€ï¼ˆå«é»˜è®¤é”®ï¼‰ ================== */
// â€”â€” äº”è¡Œ/å­£èŠ‚ é»˜è®¤é”® â€”â€”ï¼ˆæ‰¾ä¸åˆ°æ—¶ä¹Ÿèƒ½å…œåº•ï¼‰
const DEFAULT_KEYS = {
  'zh-CN': { el_wood:'æœ¨', el_fire:'ç«', el_earth:'åœŸ', el_metal:'é‡‘', el_water:'æ°´',
             season_spring:'æ˜¥', season_summer:'å¤', season_autumn:'ç§‹', season_winter:'å†¬',
             btn_generate_chart:'ç”Ÿæˆå…«å­—' },
  'zh-TW': { el_wood:'æœ¨', el_fire:'ç«', el_earth:'åœŸ', el_metal:'é‡‘', el_water:'æ°´',
             season_spring:'æ˜¥', season_summer:'å¤', season_autumn:'ç§‹', season_winter:'å†¬',
             btn_generate_chart:'ç”Ÿæˆå…«å­—' },
  'en':    { el_wood:'Wood', el_fire:'Fire', el_earth:'Earth', el_metal:'Metal', el_water:'Water',
             season_spring:'Spring', season_summer:'Summer', season_autumn:'Autumn', season_winter:'Winter',
             btn_generate_chart:'Generate Chart' },
  'ja':    { el_wood:'æœ¨', el_fire:'ç«', el_earth:'åœŸ', el_metal:'é‡‘', el_water:'æ°´',
             season_spring:'æ˜¥', season_summer:'å¤', season_autumn:'ç§‹', season_winter:'å†¬',
             btn_generate_chart:'å‘½ç›¤ã‚’ç”Ÿæˆ' },
  'th':    { el_wood:'à¹„à¸¡à¹‰', el_fire:'à¹„à¸Ÿ', el_earth:'à¸”à¸´à¸™', el_metal:'à¸—à¸­à¸‡', el_water:'à¸™à¹‰à¸³',
             season_spring:'à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´', season_summer:'à¸£à¹‰à¸­à¸™', season_autumn:'à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡', season_winter:'à¸«à¸™à¸²à¸§',
             btn_generate_chart:'à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸§à¸‡' },
  'ms':    { el_wood:'Kayu', el_fire:'Api', el_earth:'Tanah', el_metal:'Logam', el_water:'Air',
             season_spring:'Musim Bunga', season_summer:'Musim Panas', season_autumn:'Musim Luruh', season_winter:'Musim Sejuk',
             btn_generate_chart:'Jana Carta' }
};

// â€”â€” ä¸»ç¿»è¯‘è¡¨ï¼šå…ˆå®Œæ•´è¡¥é½ zh-CNï¼Œå…¶å®ƒè¯­è¨€å…ˆå›é€€åˆ°ä¸­æ–‡ï¼Œé¿å…æŠ¥é”™ â€”â€” 
const translations = {
  'zh-CN': {
    // é¡¶éƒ¨/è¡¨å•
    title_bazi_brief:'å…«å­—ç®€è¯„', lang_label:'è¯­è¨€', label_name:'å§“åï¼ˆå¯é€‰ï¼‰', ph_name:'ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰',
    gender_label:'æ€§åˆ«', opt_gender_confidential:'ä¸é€éœ²', opt_gender_male:'ç”·æ€§', opt_gender_female:'å¥³æ€§',
    label_calendar:'å†æ³•', opt_cal_gregorian:'é˜³å†', opt_cal_lunar:'å†œå†',
    label_birthdate:'å‡ºç”Ÿæ—¥æœŸ', label_birthtime:'å‡ºç”Ÿæ—¶é—´', cb_time_unknown:'å‡ºç”Ÿæ—¶é—´ä¸è¯¦',
    btn_generate_chart:'ç”Ÿæˆå…«å­—', title_quickcalc:'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜',
    // äº”è¡Œ/å­£èŠ‚ï¼ˆä¸ DEFAULT_KEYS ä¸€è‡´ï¼‰
    el_wood:'æœ¨', el_fire:'ç«', el_earth:'åœŸ', el_metal:'é‡‘', el_water:'æ°´',
    season_spring:'æ˜¥', season_summer:'å¤', season_autumn:'ç§‹', season_winter:'å†¬',
    // æŠ¥å‘Š
    rpt_sec_elements_title:'äº”è¡Œèƒ½é‡åˆ†æ', elements_balance_tpl:'äº”è¡Œä¸­{max}å…ƒç´ æœ€å¼ºï¼Œ{min}å…ƒç´ æœ€å¼±ã€‚',
    rpt_free_title:'å…è´¹ç®€æŠ¥', rpt_pillars_label:'å››æŸ±', rpt_daymaster_label:'æ—¥ä¸»', rpt_season_label:'å­£èŠ‚', rpt_chart_label:'å‘½å±€',
    strength_strong:'åå¼º', strength_weak:'åå¼±', strength_balanced:'å¹³è¡¡',
    rpt_strategy_label:'ç­–ç•¥', rpt_strategy_drain:'æ³„ç§€/åˆ¶åŒ–', rpt_strategy_support:'ç”Ÿæ‰¶/è¡¥åŠ©', rpt_strategy_balance:'è°ƒå’Œ',
    rpt_wuxing_label:'äº”è¡Œ', rpt_strongest_word:'åæ—º', rpt_weakest_word:'åå¼±', rpt_absent_prefix:'ç¼ºï¼š',
    rpt_fav_avoid_template:'å–œç”¨ï¼š{fav}ï½œå¿Œï¼š{avoid}', rpt_balance_focus_label:'è°ƒè¡¡è¦ç‚¹',
    rpt_time_unknown:'æ—¶é—´ä¸è¯¦', rpt_time_hint:'æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ï¼Œä»…ä¾›å‚è€ƒã€‚',
    rpt_sec_overview_title:'ä¸€ã€å‘½ç›˜æ€»è§ˆ', rpt_sec_traits_title:'ä¸‰ã€æ€§æ ¼ä¸å¤©èµ‹',
    rpt_sec_structure_title:'å››ã€æ ¼å±€ä¸å–œå¿Œ', rpt_structure_line_template:'å–œç”¨ï¼š{fav}ï¼›å¿Œè®³ï¼š{avoid}',
    rpt_sec_career_title:'äº”ã€äº‹ä¸šä¸å‘å±•ï¼ˆå…è´¹è¯•è¯»ï¼‰', rpt_career_fields_placeholder:'å¯èƒœä»»çš„é¢†åŸŸï¼šç®¡ç†ã€æ•™è‚²ã€å’¨è¯¢ã€äº§å“ã€è®¾è®¡ã€å†…å®¹ä¸ä¼ æ’­ç­‰ï¼›åœ¨å–œç”¨å…ƒç´ çš„è¡Œä¸šæ›´å®¹æ˜“è¢«çœ‹è§ä¸ææºã€‚',
    rpt_sec_love_title:'å…­ã€æ„Ÿæƒ…ä¸å…³ç³»ï¼ˆå…è´¹è¯•è¯»ï¼‰', rpt_love_placeholder:'å…³ç³»èŠ‚å¥ï¼šå¦è¯šæ²Ÿé€šã€ç»™å¯¹æ–¹ç©ºé—´ï¼›åœ¨æ°´èƒ½é‡ä¸è¶³æ—¶æ›´è¦æ³¨æ„å€¾å¬å’Œå…±æƒ…ã€‚',
    rpt_sec_wealth_title:'ä¸ƒã€è´¢å¯Œä¸ç†è´¢ï¼ˆå…è´¹è¯•è¯»ï¼‰', rpt_wealth_suggestion_template:'ç†è´¢å»ºè®®ï¼šä»¥ {fav} ä¸ºä¸»è°ƒï¼Œç¨³ä¸­æ±‚è¿›ã€‚',
    rpt_sec_health_title:'å…«ã€å¥åº·ä¸ä½œæ¯', rpt_health_placeholder_template:'å›´ç»•æœ€å¼±äº”è¡Œï¼ˆ{weak}ï¼‰åšä¼˜åŒ–ã€‚',
    rpt_sec_env_title:'ä¹ã€ç¯å¢ƒä¸è‰²å½©', rpt_env_placeholder:'ç”Ÿæ´»é…è‰²ä¸æ–¹ä½å¯é¡ºåº”å–œç”¨å…ƒç´ ï¼›è¡£ç‰©é¥°å“ä¸åŠå…¬ç¯å¢ƒå¯é€‚åº¦åŠ å…¥ç›¸åº”é¢œè‰²ä¸æè´¨ã€‚',
    useful_elements:'å–œç”¨å…ƒç´ ï¼š',
    // ç®¡å®¶ Butler
    butler_title:'å¿ƒæ€œç®¡å®¶ Â· è§£è¯»', butler_chat_title:'å¿ƒæ€œç®¡å®¶ Â· Chat',
    chat_placeholder:'è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ', chat_send:'å‘é€', chat_fab:'é—®',
    chip_career:'äº‹ä¸šå»ºè®®', chip_love:'æ„Ÿæƒ…å»ºè®®', chip_money:'è´¢å¯Œå»ºè®®', chip_list:'ä»Šæ—¥æ¸…å•', chip_30d:'30å¤©è®¡åˆ’',
    q_career:'ç»“åˆæˆ‘çš„å‘½ç›˜ï¼Œç»™å‡ºä¸‰æ¡åˆ‡å®å¯è¡Œçš„èŒä¸šå‘å±•å»ºè®®ï¼Œå¹¶æŒ‡å‡ºæœ¬æœˆå¯æ‰§è¡Œçš„ä¸€æ­¥ã€‚',
    q_love:'ç»“åˆæˆ‘çš„å‘½ç›˜ï¼Œå¦‚ä½•æ”¹å–„äº²å¯†å…³ç³»ï¼Ÿè¯·ç»™å‡ºä¸¤æ¡å…·ä½“æ²Ÿé€šç»ƒä¹ ã€‚',
    q_money:'ç»“åˆæˆ‘çš„å‘½ç›˜ï¼Œæœªæ¥ä¸‰ä¸ªæœˆçš„ç†è´¢åŠ¨ä½œåº”è¯¥æ€ä¹ˆå®‰æ’ï¼Ÿæ§åˆ¶é£é™©çš„å…³é”®æ˜¯ä»€ä¹ˆï¼Ÿ',
    q_list:'ç»™æˆ‘ä¸€ä¸ªä»Šå¤©å¯ä»¥é©¬ä¸Šæ‰§è¡Œçš„3â€”5æ¡æ¸…å•ã€‚', q_30d:'ä»¥æˆ‘çš„å‘½ç›˜ä¸ºå‚è€ƒï¼Œæ‹Ÿä¸€ä¸ª30å¤©çš„è‡ªæˆ‘æå‡è®¡åˆ’ï¼ˆæ¯å‘¨èšç„¦ä¸åŒä¸»é¢˜ï¼‰ã€‚',
    vip_tip:'ğŸ”’ å‡çº§ VIP ä»¥æŸ¥çœ‹å®Œæ•´è§£è¯»', vip_sub:'è§£é”äº‹ä¸š/æ„Ÿæƒ…/è´¢å¯Œ/å¥åº·ç­‰å…¨éƒ¨ç« èŠ‚ä¸æ¯å‘¨ç»ƒä¹ ', btn_unlock:'ç«‹å³è§£é”',
    // ä¼šå‘˜åŒº
    vip_title:'ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment', vip_mingli:'ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹', vip_xinlian:'ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹',
    vip_love:'å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿', vip_career:'äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›', vip_wealth:'è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº',
    vip_pet:'å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†', vip_hepan:'åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶', vip_name:'æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿',
    vip_fengshui:'è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ', vip_record:'çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·',
    vip_course:'å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾', vip_memorial:'å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­',
    vip_tasks:'æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡', vip_shop:'èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶',
    panel_login_head:'è´¦æˆ·ç™»å½• / æ³¨å†Œ', panel_member_head:'ä¼šå‘˜æœåŠ¡',
    btn_upgrade:'ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰', btn_backshop:'â† è¿”å›å‘½ç†å•†åŸ', note_price1:'$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰',
    btn_login:'ç™»å…¥è´¦æˆ·', btn_reset:'ğŸ”‘ é‡è®¾å¯†ç ', btn_register:'æ³¨å†Œè´¦æˆ·', note_price:'æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ',
    // æç¤º/é”™è¯¯
    err_network:'ç½‘ç»œå¼‚å¸¸', err_busy:'æœåŠ¡ç¹å¿™', err_email_empty:'é‚®ç®±ä¸èƒ½ä¸ºç©º', err_pwd_empty:'å¯†ç ä¸èƒ½ä¸ºç©º',
    err_login_fail:'ç™»å…¥å¤±è´¥ï¼š', err_need_ep:'è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ', err_pwd_rule:'å¯†ç è‡³å°‘8ä½ï¼Œå«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç¬¦å·',
    err_register_fail:'æ³¨å†Œå¤±è´¥ï¼š', prompt_email:'è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š', prompt_newpwd:'è¯·è¾“å…¥æ–°å¯†ç ï¼š',
    msg_reset_ok:'å·²æ›´æ–°å¯†ç ', err_reset_fail:'é‡è®¾å¤±è´¥ï¼š'
  },
  'zh-TW': null, 'en': null, 'ja': null, 'th': null, 'ms': null
};
// å›é€€ï¼šæŠŠ null çš„è¯­è¨€éƒ½æŒ‡å‘ zh-CN
for (const k of Object.keys(translations)) {
  if (translations[k] === null) translations[k] = translations['zh-CN'];
}

/* â€”â€” åŠ å›º t()ï¼šç¼ºå¤±é”®ä¸å†è¿”å› keyï¼Œè‡ªå¸¦å¤šå±‚å›é€€ â€”â€” */
function t(key){
  const lang = getLang();
  const pack = translations[lang] || {};
  const zh   = translations['zh-CN'] || {};
  const D    = DEFAULT_KEYS[lang] || DEFAULT_KEYS['zh-CN'] || {};
  const val  = (pack[key] ?? zh[key] ?? D[key]);
  if (val == null) {
    console.warn('[i18n missing]', lang, key);
    return ''; // å…³é”®ï¼šè¿”å›ç©ºä¸²ï¼Œé¿å…æŠŠ key æ˜¾ç¤ºåˆ°é¡µé¢
  }
  return val;
}

// â€”â€” ä»…ä¿ç•™ä¸€ä»½ â€”â€” 
const BUTLER_LANG_NAME = {
  'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese',
  en:'English', ja:'Japanese', th:'Thai', ms:'Malay'
};

function getLang(){
  const saved = localStorage.getItem(LANG_KEY);
  if (saved && (translations[saved] || DEFAULT_KEYS[saved])) return saved;
  const raw = (navigator.language||'zh-CN').replace('_','-');
  const map = { zh:'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW',
                en:'en','en-US':'en','en-GB':'en','en-AU':'en', ja:'ja','ja-JP':'ja', th:'th', ms:'ms' };
  return map[raw] || 'zh-CN';
}
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){
  const lang = getLang();
  const L = translations[lang] || translations['zh-CN'] || {};
  const D = DEFAULT_KEYS[lang] || DEFAULT_KEYS['zh-CN'] || {};
  return (L[key] != null ? L[key] : (D[key] != null ? D[key] : (translations['zh-CN']?.[key] ?? key)));
}
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if (val != null && val !== key) el.textContent = val;
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    const val = t(key);
    if (val != null && val !== key) el.setAttribute('placeholder', val);
  });
}
function applyChatI18n(){
  const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend'), title=qs('.ss-chat-title');
  if(fab) fab.textContent=t('chat_fab');
  if(inp) inp.placeholder=t('chat_placeholder');
  if(btn) btn.textContent=t('chat_send');
  if(title) title.textContent=t('butler_chat_title');
}
function initLangUI(){
  const sel=$('langSelect'); if(!sel) return;
  const current=getLang(); sel.value=current; document.documentElement.lang=current;
  applyI18n(); applyChatI18n();
  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n(); applyChatI18n();
    rerenderReportsIfAny();
    rerunButlerIfAny();
  });
}

/* ================== å…«å­—è®¡ç®—å™¨ï¼ˆç®€åŒ–ï¼‰ ================== */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC=['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }
  calculateYearPillar(y){ const s=(y-4)%10, b=(y-4)%12;
    return { stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12], zodiac:this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y,m,d){
    const mmdd=m*100+d, gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val;
    const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
    return {index:idx, branch:branchBy[idx]};
  }
  calculateMonthPillar(y,m,d){
    const {index,branch}=this.solarMonthIndex(y,m,d);
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(y).stem);
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx=(startMap[yStemIdx]+(index-1))%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(y,m,d){
    const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(y,m-1,d);
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
    const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
    return { stem:this.HEAVENLY_STEMS[(stemIdx+10)%10], branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour){
    const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex=Math.floor((hour+1)/2)%12;
    const stemIdx=(startMap[dayIdx]+hourIndex)%10;
    return { stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour] };
  }
  getStemElement(stem){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[stem]; }
  getBranchElement(branch){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[branch]; }
  getElement(stem,branch){ return this.getStemElement(stem)+this.getBranchElement(branch); }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  calculateBazi(y,m,d,h=12,timeUnknown=false){
    const year=this.calculateYearPillar(y), month=this.calculateMonthPillar(y,m,d), day=this.calculateDayPillar(y,m,d);
    const hour=timeUnknown?{stem:'ï¼Ÿ', branch:'ï¼Ÿ'}:this.calculateHourPillar(day.stem,h);
    const dayElement=this.getStemElement(day.stem);
    const pillars={ year, month, day:{...day, element:dayElement}, hour };
    const cnt={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    (timeUnknown?[year,month,day]:[year,month,day,hour]).forEach(p=>{
      if(p.stem&&p.stem!=='ï¼Ÿ') cnt[this.getStemElement(p.stem)]+=1;
      if(p.branch&&p.branch!=='ï¼Ÿ') cnt[this.getBranchElement(p.branch)]+=1;
    });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={ wood:cnt['æœ¨']/total*100, fire:cnt['ç«']/total*100, earth:cnt['åœŸ']/total*100, metal:cnt['é‡‘']/total*100, water:cnt['æ°´']/total*100 };
    return { pillars, counts:cnt, percents:pct, timeUnknown };
  }
}
const baziCalculator=new BaziCalculator();

/* ================== æ¸²æŸ“/è§„åˆ™ ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='æ—¶æŸ±'&&timeUnknown); const stem=u?'ï¼Ÿ':v.stem, branch=u?'ï¼Ÿ':v.branch;
    const div=document.createElement('div'); div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem); setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);
  const setIf=(id,val)=>{ const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch));
  setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch));
  setIf('hour-element',timeUnknown?'æœªçŸ¥':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch));
  setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch));
  setIf('hour-nayin',timeUnknown?'æœªçŸ¥':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH={å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='æ˜¥'&&'æœ¨ç«'.includes(dmEl))||(season==='å¤'&&'ç«åœŸ'.includes(dmEl))||(season==='ç§‹'&&dmEl==='é‡‘')||(season==='å†¬'&&dmEl==='æ°´')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'åå¼º':score<=1?'åå¼±':'å¹³è¡¡';
  const focus=mark==='åå¼º'?'æ³„ç§€/åˆ¶åŒ–':mark==='åå¼±'?'ç”Ÿæ‰¶/è¡¥åŠ©':'è°ƒå’Œ';
  return { season, mark, focus };
}
function chooseUseful(strength, dmElem){
  if(strength==='åå¼º') return { strategy:'æ³„ç§€/åˆ¶åŒ–',
    useful:{æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']}[dmElem], avoid:[dmElem] };
  if(strength==='åå¼±') return { strategy:'ç”Ÿæ‰¶/è¡¥åŠ©',
    useful:{æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']}[dmElem], avoid:[] };
  return { strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[] };
}

/* ================== å¤šè¯­è¨€è¾…åŠ© ================== */
const EL_CHAR_TO_KEY={æœ¨:'wood',ç«:'fire',åœŸ:'earth',é‡‘:'metal',æ°´:'water'};
function ELABEL(){ return {
  wood: t('el_wood')||'æœ¨', fire: t('el_fire')||'ç«', earth: t('el_earth')||'åœŸ', metal: t('el_metal')||'é‡‘', water: t('el_water')||'æ°´'
};}
function elCharsToLocale(arr){ const L=ELABEL(); return (arr||[]).map(ch=>L[EL_CHAR_TO_KEY[ch]]||ch); }
function listJoin(arr){ const lang=(getLang()||'').toLowerCase(); const sep=lang.startsWith('zh')?'ã€':', '; return (arr||[]).filter(Boolean).join(sep); }
function seasonName(s){
  const map={ æ˜¥:t('season_spring')||'æ˜¥', å¤:t('season_summer')||'å¤', ç§‹:t('season_autumn')||'ç§‹', å†¬:t('season_winter')||'å†¬' };
  return map[s]||s||'â€”';
}
function strategyName(s){
  const map={ 'æ³„ç§€/åˆ¶åŒ–':t('rpt_strategy_drain')||'æ³„ç§€/åˆ¶åŒ–', 'ç”Ÿæ‰¶/è¡¥åŠ©':t('rpt_strategy_support')||'ç”Ÿæ‰¶/è¡¥åŠ©', 'è°ƒå’Œ':t('rpt_strategy_balance')||'è°ƒå’Œ' };
  return map[s]||s;
}

/* ================== æŠ¥å‘Šæ„å»ºï¼ˆå…è´¹ + å¯ŒæŠ¥å‘Šï¼‰ ================== */
function buildFreeReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), entries=Object.entries(percents||{});
  const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'', weakest=E[weakestK]||'';
  const absents=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]).filter(Boolean);
  const lang=(getLang()||'').toLowerCase(), sep=lang.startsWith('zh')?'ã€€':' Â· ';
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]} ${Math.round(percents[k]||0)}%`).join(sep);
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favText=favLoc.length?listJoin(favLoc):'â€”', avoidText=avoidLoc.length?listJoin(avoidLoc):'â€”';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  const favAvoidLine=(t('rpt_fav_avoid_template')||'å–œç”¨ï¼š{fav}ï½œå¿Œï¼š{avoid}').replace('{fav}',favText).replace('{avoid}',avoidText);
  const absStr=absents.length? (lang.startsWith('zh')? `ï¼ˆ${t('rpt_absent_prefix')||'ç¼ºï¼š'}${listJoin(absents)}ï¼‰` : ` (${t('rpt_absent_prefix')||'Absent: '}${listJoin(absents)})`) : '';
  return `
    <div class="xl-card" style="margin-top:12px;padding:16px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);">
      <h3 style="margin:0 0 8px;color:var(--brand)">${t('rpt_free_title')||'å…è´¹ç®€æŠ¥'}</h3>
      <p style="margin:6px 0;">${t('rpt_pillars_label')||'å››æŸ±'}ï¼š<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">${t('rpt_daymaster_label')||'æ—¥ä¸»'}ï¼š<strong>${pillars.day.stem}</strong>ï¼ˆ<strong>${dmElemName}</strong>ï¼‰ï½œ${t('rpt_season_label')||'å­£èŠ‚'}ï¼š<strong>${seasonName(st.season)||'-'}</strong>ï½œ${t('rpt_chart_label')||'å‘½å±€'}ï¼š<strong>${t('strength_'+(st.mark==='åå¼º'?'strong':st.mark==='åå¼±'?'weak':'balanced'))||st.mark}</strong> Â· <strong>${t('rpt_strategy_label')||'ç­–ç•¥'}ï¼š${stName}</strong></p>
      <p style="margin:8px 0;">${t('rpt_wuxing_label')||'äº”è¡Œ'}ï¼š${line}</p>
      <p style="margin:4px 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')||'åæ—º'}ï¼›<strong>${weakest}</strong>${t('rpt_weakest_word')||'åå¼±'}ã€‚${absStr}</p>
      <ul style="margin:6px 0 0 18px;line-height:1.6">
        <li>${favAvoidLine}</li>
        <li>${t('rpt_balance_focus_label')||'è°ƒè¡¡è¦ç‚¹'}ï¼š${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">${t('rpt_time_hint')||'æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ï¼Œä»…ä¾›å‚è€ƒã€‚'}</p>`:''}
    </div>`;
}
function buildRichReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E=ELABEL(), lang=(getLang()||'').toLowerCase();
  const line=['wood','fire','earth','metal','water'].map(k=>`${E[k]}${lang.startsWith('zh')?'':' '}${Math.round(percents[k]||0)}%`).join(lang.startsWith('zh')?' ':' Â· ');
  const entries=Object.entries(percents||{}); const strongestK=entries.reduce((a,b)=>(a[1]>b[1]?a:b),['wood',0])[0];
  const weakestK=entries.reduce((a,b)=>(a[1]<b[1]?a:b),['wood',0])[0];
  const strongest=E[strongestK]||'â€”', weakest=E[weakestK]||'â€”';
  const absentsArr=Object.keys(percents||{}).filter(k=>Math.round(percents[k]||0)===0).map(k=>E[k]);
  const absentsStr=absentsArr.length ? (lang.startsWith('zh')? `ï¼ˆ${t('rpt_absent_prefix')||'ç¼ºï¼š'}${listJoin(absentsArr)}ï¼‰` : ` (${t('rpt_absent_prefix')||'Absent: '}${listJoin(absentsArr)})`) : '';
  const favLoc=elCharsToLocale(adv?.useful||[]), avoidLoc=elCharsToLocale(adv?.avoid||[]);
  const favList=favLoc.length?listJoin(favLoc):'â€”', avoidList=avoidLoc.length?listJoin(avoidLoc):'â€”';
  const hourTxt=timeUnknown?t('rpt_time_unknown'):(pillars.hour.stem + pillars.hour.branch);
  const dmElemName=E[EL_CHAR_TO_KEY[pillars.day.element]||'wood'];
  const stName=strategyName(st.focus);
  return `
    <section class="card" style="padding:20px;">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_overview_title')||'ä¸€ã€å‘½ç›˜æ€»è§ˆ'}</h3>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
        <div>${t('rpt_pillars_label')||'å››æŸ±'}ï¼š<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></div>
        <div>${t('rpt_daymaster_label')||'æ—¥ä¸»'}ï¼š<strong>${pillars.day.stem}</strong>ï¼ˆ<strong>${dmElemName}</strong>ï¼‰</div>
        <div>${t('rpt_season_label')||'å­£èŠ‚'}ï¼š<strong>${seasonName(st.season)||'-'}</strong></div>
        <div>${t('rpt_chart_label')||'å‘½å±€'}ï¼š<strong>${t('strength_'+(st.mark==='åå¼º'?'strong':st.mark==='åå¼±'?'weak':'balanced'))||st.mark}</strong> Â· ${t('rpt_strategy_label')||'ç­–ç•¥'}ï¼š<strong>${stName}</strong></div>
      </div>
    </section>
    <section class="card" style="padding:20px;">
      <h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_elements_title')||'äºŒã€äº”è¡Œèƒ½é‡åˆ†æ'}</h3>
      <div style="font-size:14px;">${line}</div>
      <p style="margin:10px 0 0;"><strong>${strongest}</strong>${t('rpt_strongest_word')||'åæ—º'}ï¼›<strong>${weakest}</strong>${t('rpt_weakest_word')||'åå¼±'}ã€‚${absentsStr}</p>
      <ul style="margin:10px 0 0 18px;line-height:1.6">
        <li>${t('useful_elements')||'å–œç”¨å…ƒç´ ï¼š'}${favList}</li>
        <li>${t('rpt_balance_focus_label')||'è°ƒè¡¡è¦ç‚¹'}ï¼š${stName}</li>
      </ul>
      ${timeUnknown?`<p class="muted" style="margin-top:8px;">${t('rpt_time_hint')||'æç¤ºï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæœªçº³å…¥æ—¶æŸ±ï¼Œä»…ä¾›å‚è€ƒã€‚'}</p>`:''}
    </section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_traits_title')||'ä¸‰ã€æ€§æ ¼ä¸å¤©èµ‹'}</h3><p>${t('rpt_traits_intro')||''}</p><p>${t('rpt_traits_adv')||''}</p><p>${t('rpt_traits_chal')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_structure_title')||'å››ã€æ ¼å±€ä¸å–œå¿Œ'}</h3><p>${(t('rpt_structure_line_template')||'å–œç”¨ï¼š{fav}ï¼›å¿Œè®³ï¼š{avoid}').replace('{fav}',favList).replace('{avoid}',avoidList)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_career_title')||'äº”ã€äº‹ä¸šä¸å‘å±•ï¼ˆå…è´¹è¯•è¯»ï¼‰'}</h3><p>${t('rpt_career_fields_placeholder')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_love_title')||'å…­ã€æ„Ÿæƒ…ä¸å…³ç³»ï¼ˆå…è´¹è¯•è¯»ï¼‰'}</h3><p>${t('rpt_love_placeholder')||''}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_wealth_title')||'ä¸ƒã€è´¢å¯Œä¸ç†è´¢ï¼ˆå…è´¹è¯•è¯»ï¼‰'}</h3><p>${(t('rpt_wealth_suggestion_template')||'ç†è´¢å»ºè®®ï¼šä»¥ {fav} ä¸ºä¸»è°ƒï¼Œç¨³ä¸­æ±‚è¿›ã€‚').replace('{fav}',favList)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_health_title')||'å…«ã€å¥åº·ä¸ä½œæ¯'}</h3><p>${(t('rpt_health_placeholder_template')||'å›´ç»•æœ€å¼±äº”è¡Œï¼ˆ{weak}ï¼‰åšä¼˜åŒ–ã€‚').replace('{weak}',weakest)}</p></section>
    <section class="card" style="padding:20px;"><h3 style="margin-top:0;color:var(--brand)">${t('rpt_sec_env_title')||'ä¹ã€ç¯å¢ƒä¸è‰²å½©'}</h3><p>${t('rpt_env_placeholder')||''}</p></section>
    <div id="butler-anchor"></div>`;
}
function mountExtensionsIntoResult(ctx){
  const resultEl=$('result'); if(!resultEl) return;
  let freeNode=$('xl-free-report');
  if(!freeNode){ freeNode=document.createElement('div'); freeNode.id='xl-free-report'; resultEl.appendChild(freeNode); }
  freeNode.innerHTML=buildFreeReportHTML(ctx);
}
function mountRichReport(ctx){
  let host=$('rich-report'); if(!host){ host=document.createElement('div'); host.id='rich-report'; $('result')?.appendChild(host); }
  host.innerHTML=buildRichReportHTML(ctx);
}

/* ================== Butler AI å¡ç‰‡ï¼ˆèŠ¯ç‰‡/é”å®š/å¤šè¯­è¨€ï¼‰ ================== */
(function injectAiStyle(){
  const old=$('ai-style'); if(old) old.remove();
  const style=document.createElement('style'); style.id='ai-style';
  style.textContent=`
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  `;
  document.head.appendChild(style);
})();
function mdToHtml(md){
  return (md||'')
    .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
    .replace(/^\s*[-*]\s+(.*)$/gm,'â€¢ $1')
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    .replace(/\n{2,}/g,'\n\n')
    .replace(/\n/g,'<br/>');
}
function isVIP(){ return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail'); }
function ensureAiCard(){
  if($('aiCard')) return;
  const wrap=$('rich-report')||$('result'); if(!wrap) return;
  const sec=document.createElement('div'); sec.className='sec'; sec.id='aiCard';
  sec.innerHTML=`
    <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')||'å¿ƒæ€œç®¡å®¶ Â· è§£è¯»'}</h3>
    <div id="aiContent" class="ai-content">
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>
    </div>
    <div class="chips" id="aiChips"></div>`;
  wrap.appendChild(sec);
  renderChips();
}
function renderChips(){
  const wrap=$('aiChips'); if(!wrap) return; wrap.innerHTML='';
  [{k:'chip_career',q:'q_career'}, {k:'chip_love',q:'q_love'}, {k:'chip_money',q:'q_money'}, {k:'chip_list',q:'q_list'}, {k:'chip_30d',q:'q_30d'}].forEach(it=>{
    const btn=document.createElement('button'); btn.className='chip'; btn.textContent=t(it.k); btn.setAttribute('data-q', t(it.q)); wrap.appendChild(btn);
  });
}
function buildButlerSystemPrompt(lang){
  const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
  const HEADER_MAP={
    'zh-CN':['äººç‰©ç”»åƒ','å…³ç³»ä¸æ²Ÿé€š','äº‹ä¸šä¸è‡ªæˆ‘å®ç°','é‡‘é’±ä¸ç‰©è´¨','ä»Šæ—¥/æœ¬å‘¨å¯æ‰§è¡Œæ¸…å•','æ¸©æŸ”æé†’'],
    'zh-TW':['äººç‰©ç”»åƒ','é—œä¿‚èˆ‡æºé€š','äº‹æ¥­èˆ‡è‡ªæˆ‘å¯¦ç¾','é‡‘éŒ¢èˆ‡ç‰©è³ª','ä»Šæ—¥/æœ¬é€±å¯åŸ·è¡Œæ¸…å–®','æº«æŸ”æé†’'],
    en:['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
    ja:['äººç‰©åƒ','é–¢ä¿‚ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³','ã‚­ãƒ£ãƒªã‚¢ã¨è‡ªå·±å®Ÿç¾','ãŠé‡‘ã¨ç‰©è³ª','ä»Šæ—¥/ä»Šé€±ã®å®Ÿè¡Œãƒªã‚¹ãƒˆ','ã‚„ã•ã—ã„ãƒªãƒã‚¤ãƒ³ãƒ‰'],
    th:['à¸ à¸²à¸à¸šà¸¸à¸„à¸„à¸¥','à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œ & à¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£','à¸à¸²à¸£à¸‡à¸²à¸™ & à¸à¸²à¸£à¹€à¸•à¸´à¸¡à¹€à¸•à¹‡à¸¡à¸•à¸™à¹€à¸­à¸‡','à¸à¸²à¸£à¹€à¸‡à¸´à¸™ & à¸§à¸±à¸•à¸–à¸¸','à¸£à¸²à¸¢à¸à¸²à¸£à¸›à¸à¸´à¸šà¸±à¸•à¸´ (à¸§à¸±à¸™à¸™à¸µà¹‰/à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰)','à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™'],
    ms:['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
  };
  const headers=HEADER_MAP[lang]||HEADER_MAP['zh-CN'];
  return [
    `You are "Xinlian Butler". OUTPUT LANGUAGE: ${ln}. Reply strictly in ${ln} only.`,
    'Warm, practical, actionable. No medical/legal conclusions.',
    'Markdown structure:',
    `## ${headers[0]}`, `## ${headers[1]} (2â€“4 bullets)`, `## ${headers[2]} (2â€“4 bullets)`,
    `## ${headers[3]} (2â€“3 bullets)`, `## ${headers[4]} (3â€“5 bullets; start with verbs; quantify if possible)`, `## ${headers[5]}`
  ].join('\n');
}
function buildBaziUserPrompt(ctx){
  const {name,date,time,place,pillars,percents,st,adv,timeUnknown}=ctx;
  const fav=listJoin(elCharsToLocale(adv?.useful||[])), avoid=listJoin(elCharsToLocale(adv?.avoid||[]));
  const elementsLine=`wood ${Math.round(percents.wood)}% Â· fire ${Math.round(percents.fire)}% Â· earth ${Math.round(percents.earth)}% Â· metal ${Math.round(percents.metal)}% Â· water ${Math.round(percents.water)}%`;
  const hourTxt=timeUnknown ? t('rpt_time_unknown') : (pillars.hour.stem + pillars.hour.branch);
  return [
    `Name: ${name||'-'}`,
    `Birth: ${date||'-'} ${time||'â€”'}${place?(' @ '+place):''}`,
    `Bazi pillars: Year ${pillars.year.stem}${pillars.year.branch} Â· Month ${pillars.month.stem}${pillars.month.branch} Â· Day ${pillars.day.stem}${pillars.day.branch} Â· Hour ${hourTxt}`,
    `Day Master: ${pillars.day.stem} (${pillars.day.element})`,
    `Season: ${st.season}; Chart Strength: ${st.mark}; Strategy: ${st.focus}`,
    `Favorable elements: ${fav||'â€”'}; Avoid: ${avoid||'â€”'}`,
    `Five elements distribution: ${elementsLine}`,
    'Expectation: human, concrete, and immediately actionable advice.'
  ].join('\n');
}
async function runButlerAI(ctx){
  ensureAiCard(); const title=$('butlerTitle'); if(title) title.textContent=t('butler_title')||'å¿ƒæ€œç®¡å®¶ Â· è§£è¯»';
  const elC=$('aiContent'); if(elC){ elC.innerHTML=`<div class="skeleton"><div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div><div style="width:70%"></div><div style="width:50%"></div></div>`; }
  const lang=getLang(), sys=buildButlerSystemPrompt(lang), usr=buildBaziUserPrompt(ctx);
  try{
    const r=await fetch(API_BASE+'/api/chat',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:usr}]}) });
    const data=await r.json().catch(()=>({})); const raw=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
    let html=mdToHtml(raw);
    if(!isVIP()){
      const parts=raw.split(/\n##\s+/); const header=parts.shift()||''; const kept=[header,...(parts.slice(0,2).map(p=>'## '+p))].join('\n\n');
      html = mdToHtml(kept) + `
        <div class="ai-lock-overlay" style="text-align:center;padding:14px 10px;border-top:1px solid #1f2a36;margin-top:10px">
          <div class="tip">${t('vip_tip')||'ğŸ”’ å‡çº§ VIP ä»¥æŸ¥çœ‹å®Œæ•´è§£è¯»'}</div>
          <div class="sub" style="margin-top:4px">${t('vip_sub')||''}</div>
          <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">${t('btn_unlock')||'ç«‹å³è§£é”'}</a>
        </div>`;
    }
    if(elC) elC.innerHTML=html; renderChips();
  }catch(e){ if(elC) elC.innerHTML=`<div style="color:#98a7b7">${t('err_network')||'ç½‘ç»œå¼‚å¸¸'}</div>`; }
}
function rerunButlerIfAny(){ if(!window.__bazi_ctx__) return; runButlerAI(window.__bazi_ctx__); }

// èŠ¯ç‰‡è¿½é—®
document.addEventListener('click',(e)=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  const q=chip.getAttribute('data-q') || chip.textContent;
  const el=$('aiContent'); if(!el) return;
  el.innerHTML += `<br/><br/><b>â€”</b> ${q}<br/>`;
  const sys=buildButlerSystemPrompt(getLang());
  fetch(API_BASE+'/api/chat',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys+'\n(Continue previous tone. Add concrete steps.)'},{role:'user',content:q}]}) })
    .then(r=>r.json()).then(data=>{
      const txt=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      el.innerHTML += mdToHtml('\n\n'+(txt || ('\n\n'+(t('err_busy')||'æœåŠ¡ç¹å¿™'))));
    }).catch(()=>{ el.innerHTML += `<div style="color:#98a7b7">${t('err_network')||'ç½‘ç»œå¼‚å¸¸'}</div>`; });
});

/* ================== ç”Ÿæˆå‘½ç›˜ï¼ˆæ•´åˆ Butlerï¼‰ ================== */
async function genChart(){
  const birth=($('birthdate')?.value||'').trim();
  const timeUnknown=$('timeUnknown')?.checked || false;
  const name=$('name')?.value?.trim() || '';
  const place=$('place')?.value?.trim() || ''; // ä½ é¡µé¢æ²¡æœ‰ placeï¼Œä¹Ÿæ²¡å…³ç³»
  if(!birth){ showErr('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸã€‚'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D]=birth.split('-').map(Number);
    let hour=12; if(!timeUnknown){ const tval=($('birthtime')?.value||'').trim(); if(tval){ const h=parseInt(tval.split(':')[0],10); if(!Number.isNaN(h)) hour=h; } }
    const {pillars, counts, percents, timeUnknown:tu}=baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    $('result')?.style.setProperty('display','block');
    const timeText=tu ? (t('rpt_time_unknown')||'æ—¶é—´ä¸è¯¦') : (hour+'æ—¶');
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if(tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('bar-æœ¨'), percents.wood); setText('pct-æœ¨', Math.round(percents.wood)+'%');
    setBar($('bar-ç«'), percents.fire); setText('pct-ç«', Math.round(percents.fire)+'%');
    setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ', Math.round(percents.earth)+'%');
    setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘', Math.round(percents.metal)+'%');
    setBar($('bar-æ°´'), percents.water); setText('pct-æ°´', Math.round(percents.water)+'%');

    const st=judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv=chooseUseful(st.mark, pillars.day.element);

    // â€œæœ€å¼º/æœ€å¼±â€æç¤ºï¼ˆæœ¬åœ°åŒ–ï¼‰
    const E=ELABEL(); const keys=Object.keys(counts);
    const maxK=keys.reduce((a,b)=> counts[a]>counts[b]?a:b), minK=keys.reduce((a,b)=> counts[a]<counts[b]?a:b);
    const char2Locale={æœ¨:E.wood,ç«:E.fire,åœŸ:E.earth,é‡‘:E.metal,æ°´:E.water};
    setText('bazi-elements-balance', (t('elements_balance_tpl')||'äº”è¡Œä¸­{max}å…ƒç´ æœ€å¼ºï¼Œ{min}å…ƒç´ æœ€å¼±ã€‚').replace('{max}',char2Locale[maxK]).replace('{min}',char2Locale[minK]));

    // ç¼“å­˜ç”¨äºè¯­è¨€åˆ‡æ¢ & è¿½é—®
    window.__last_report__={pillars, percents, st, adv, tu};

    mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown:tu});
    mountRichReport({pillars, percents, st, adv, timeUnknown:tu});

    // Butler
    const ctx={ name, place, date:`${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`, time:tu?'â€”':`${String(hour).padStart(2,'0')}:00`, pillars, percents, st, adv, timeUnknown:tu };
    window.__bazi_ctx__=ctx; await runButlerAI(ctx);
  }catch(err){ console.error(err); showErr('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•'); }
  finally{ if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none'; }
}
function rerenderReportsIfAny(){
  const ctx=window.__last_report__; if(!ctx) return;
  const {pillars, percents, st, adv, tu}=ctx;
  mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown:tu});
  mountRichReport({pillars, percents, st, adv, timeUnknown:tu});
}

/* ================== å³ä¸‹è§’ Chat æ‚¬æµ®çƒï¼ˆå®Œæ•´ï¼‰ ================== */
function mountChat(){
  if($('ssChatFab')) return;
  const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title=t('butler_chat_title')||'å¿ƒæ€œç®¡å®¶ Â· Chat';
  const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label', t('butler_chat_title')||'å¿ƒæ€œç®¡å®¶ Â· Chat');
  chatPanel.innerHTML = `
    <div class="ss-chat-head"><div class="ss-chat-title">${t('butler_chat_title')||'å¿ƒæ€œç®¡å®¶ Â· Chat'}</div><div class="ss-close" id="ssChatClose">âœ•</div></div>
    <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')||'è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ'}"/>
      <button id="ssChatSend" class="btn">${t('chat_send')||'å‘é€'}</button>
    </div>`;
  document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
  applyChatI18n();

  const $body=$('ssChatBody'), $input=$('ssChatInput'), $send=$('ssChatSend'), $close=$('ssChatClose');
  const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); };
  const closePanel=()=>{ chatPanel.style.display='none'; };
  chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);

  function addMsg(text, me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
  async function askChat(prompt){
    addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
    const sys=[`You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()]||'Simplified Chinese'}.`,'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'].join('\n');
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:prompt}]}) });
      let data,reply=''; try{ data=await r.json(); }catch{ data={}; }
      reply=data?.reply??data?.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply || t('err_busy') || 'æœåŠ¡ç¹å¿™');
    }catch(e){ addMsg(`${t('err_network')||'ç½‘ç»œå¼‚å¸¸'} Â· ${t('err_busy')||'æœåŠ¡ç¹å¿™'}`); }
  }
  $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
  $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
}

/* ================== ç™»å½•/æ³¨å†Œ/é‡ç½®ï¼ˆæœ€å°å®ç°ï¼‰ ================== */
function wireAuth(){
  const loginForm=$('loginForm'), registerForm=$('registerForm'), resetBtn=$('resetBtn');
  const emailEl=$('email'), pwdEl=$('password');

  loginForm?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=emailEl?.value.trim(), pwd=pwdEl?.value||'';
    if(!email) return showAuthErr(t('err_email_empty')||'é‚®ç®±ä¸èƒ½ä¸ºç©º');
    if(!pwd) return showAuthErr(t('err_pwd_empty')||'å¯†ç ä¸èƒ½ä¸ºç©º');
    lock(loginForm,true);
    try{
      const r=await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){
        localStorage.setItem('vipEmail', email);
        if(data?.vip==='active' || data?.status==='active') localStorage.setItem('vipStatus','active');
        showAuthErr('âœ… ç™»å½•æˆåŠŸ'); setTimeout(()=>hideAuthErr(),2000);
      }else{
        showAuthErr((t('err_login_fail')||'ç™»å…¥å¤±è´¥ï¼š')+(data?.message||r.status));
      }
    }catch(err){ showAuthErr(t('err_network')||'ç½‘ç»œå¼‚å¸¸'); }
    finally{ lock(loginForm,false); }
  });

  registerForm?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=emailEl?.value.trim(), pwd=pwdEl?.value||'';
    if(!email||!pwd) return showAuthErr(t('err_need_ep')||'è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ');
    if(!strongPwd(pwd)) return showAuthErr(t('err_pwd_rule')||'å¯†ç ä¸åˆè§„');
    lock(registerForm,true);
    try{
      const r=await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){
        localStorage.setItem('vipEmail', email);
        if(data?.vip==='active' || data?.status==='active') localStorage.setItem('vipStatus','active');
        showAuthErr('âœ… æ³¨å†ŒæˆåŠŸ'); setTimeout(()=>hideAuthErr(),2000);
      }else{
        showAuthErr((t('err_register_fail')||'æ³¨å†Œå¤±è´¥ï¼š')+(data?.message||r.status));
      }
    }catch(err){ showAuthErr(t('err_network')||'ç½‘ç»œå¼‚å¸¸'); }
    finally{ lock(registerForm,false); }
  });

  resetBtn?.addEventListener('click', async ()=>{
    hideAuthErr();
    const email = prompt(t('prompt_email')||'è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ï¼š'); if(!email) return;
    const pwd = prompt(t('prompt_newpwd')||'è¯·è¾“å…¥æ–°å¯†ç ï¼š'); if(!pwd) return;
    if(!strongPwd(pwd)) return showAuthErr(t('err_pwd_rule')||'å¯†ç ä¸åˆè§„');
    lock(resetBtn,true);
    try{
      const r=await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pwd})});
      const data=await r.json().catch(()=>({}));
      if(r.ok){ alert(t('msg_reset_ok')||'å·²æ›´æ–°å¯†ç '); }
      else{ showAuthErr((t('err_reset_fail')||'é‡è®¾å¤±è´¥ï¼š')+(data?.message||r.status)); }
    }catch(err){ showAuthErr(t('err_network')||'ç½‘ç»œå¼‚å¸¸'); }
    finally{ lock(resetBtn,false); }
  });
}

/* ============== DOM Ready ============== */
document.addEventListener('DOMContentLoaded', ()=>{
  if($('birthdate') && !$('birthdate').value){ $('birthdate').value = new Date().toISOString().split('T')[0]; }
  initLangUI();
  $('genBtn')?.addEventListener('click', genChart);
  mountChat();
  wireAuth();
});

})(); 
</script>
</body>
</html>
  



