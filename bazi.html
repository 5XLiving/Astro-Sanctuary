<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="icon" href="data:,">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    --gold:#d4af37; --gold2:#f2d27a; --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22);
  }
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:"";position:fixed;inset:0;z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
  header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
  .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em;font-size:1.1rem}
  .lang{display:flex;align-items:center;gap:8px}
  .lang select{
    appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
    padding:10px 34px 10px 12px;font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);padding:18px;margin:16px 0}
  .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
  .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
  .row{display:grid;gap:12px}
  @media(min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr} }

  input,select,button{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
    padding:12px 12px;font-size:15px;outline:none;
  }
  input::placeholder{color:#6f8092}
  .muted{color:var(--muted)}

  .btn{
    display:inline-grid;place-items:center;text-decoration:none;
    padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;cursor:pointer;
    font-weight:700;letter-spacing:.3px;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    box-shadow:0 6px 18px rgba(230,199,110,.4);transition:.15s;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.block{display:block;width:100%}

  /* —— 结果区 */
  .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
  .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
  .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
  .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
  .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
  .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
  .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
  .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
  .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
  .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
  .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}

  /* —— Chat 悬浮球（只保留“问”） */
  .ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e}
  .ss-chat-panel{display:none;position:fixed;right:18px;bottom:86px;width:min(360px,92vw);height:60vh;z-index:51;
    background:#0e1520;border:1px solid #263448;border-radius:14px;box-shadow:var(--shadow);overflow:hidden;flex-direction:column}
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #263448}
  .ss-chat-body{flex:1;overflow:auto;padding:10px 12px}
  .ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #263448}
  .ss-msg{background:#121a28;border:1px solid #273449;border-radius:10px;padding:8px 10px;margin:6px 0;max-width:85%}
  .ss-msg.me{margin-left:auto;background:#172236;border-color:#2d3d57}

  /* —— 出生时间一行：时间输入 + 勾选同一横 —— */
  .time-inline{display:flex;align-items:center;gap:10px}
  .time-inline .check-inline{
    display:inline-flex;align-items:center;gap:6px;
    color:var(--muted);user-select:none;white-space:nowrap;
  }
  @media (max-width:640px){ .time-inline{flex-wrap:wrap} }

  /* —— 估时向导（仅勾选后弹出）—— */
  .xl-wizard-mask{
    position:fixed; inset:0; z-index:1000; display:none;
    background:rgba(0,0,0,.45); backdrop-filter: blur(4px);
  }
  .xl-wizard{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(880px,92vw); border-radius:14px; overflow:hidden;
    background:var(--card); border:1px solid #243244; box-shadow: var(--shadow);
  }
  .xl-wizard .w-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 14px; border-bottom:1px solid #243244;
  }
  .xl-wizard .w-title{ font-weight:800; color:#ffe084; letter-spacing:.2px; }
  .xl-wizard .w-close{ cursor:pointer; opacity:.8; padding:6px 10px; }
  .xl-wizard .w-body{ padding:14px; color:var(--text); }
  .xl-wizard .w-tip{ color:var(--muted); margin:2px 0 10px; font-size:.95rem; }

  .w-grid{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  @media(min-width:760px){ .w-grid{ grid-template-columns:1fr 1fr 1fr; } }

  .w-chip{
    position:relative; border:1px solid #2a3548; background:#0e1520;
    border-radius:12px; padding:16px; min-height:76px;
    display:flex; align-items:center; justify-content:center; text-align:center;
    transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .w-chip input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .w-chip .label{ line-height:1.35; }
  .w-chip .dot{ width:9px; height:9px; border-radius:50%; border:2px solid #5f6b7e; margin:0 auto 8px; }
  .w-chip.active{ border-color:var(--brand); box-shadow:0 0 0 2px rgba(212,175,55,.18) inset; }
  .w-chip.active .dot{ border-color:var(--brand); background:var(--brand); }

  .w-actions{
    display:flex; gap:10px; justify-content:flex-end;
    padding:12px 14px; border-top:1px solid #243244; background:#0e1520;
  }
  .btn.ghost{ background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none; }

  /* —— VIP 区（简化版样式，保留结构） */
  .columns{display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
  .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,var(--panel),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
  @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .panel .head{padding:16px 18px;border-bottom:1px solid var(--border);color:var(--gold);font-weight:700;letter-spacing:.3px}
  .panel .body{padding:18px}
  .row.one{grid-template-columns:1fr}
  .spacer{height:12px}
  .error{color:#ffb4b4;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.25);padding:10px 12px;border-radius:10px}
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="title">命理供门 · 八字简评</div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>

    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender"><option value="">不透露</option><option value="male">男性</option><option value="female">女性</option></select>
      </div>
      <div>
        <label class="muted">历法</label>
        <select id="calendar"><option value="gregorian">阳历 / Gregorian</option><option value="lunar">农历 / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <div class="time-inline">
          <input type="time" id="birthtime" value="12:00">
          <label class="check-inline"><input type="checkbox" id="timeUnknown"> 出生时间不详</label>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">生成八字</span>
          <span id="genBtnLoading" style="display:none">计算中...</span>
        </button>
      </div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <!-- 结果区 -->
  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">您的生辰八字命盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>
      <table class="bazi-table">
        <thead><tr><th></th><th>年柱</th><th>月柱</th><th>日柱</th><th>时柱</th></tr></thead>
        <tbody>
          <tr><td>天干</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>地支</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>五行</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>纳音</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">五行能量分析</div>
      <div class="bar-row"><span>木</span><div class="bar"><i id="bar-木"></i></div><span id="pct-木">0%</span></div>
      <div class="bar-row"><span>火</span><div class="bar"><i id="bar-火"></i></div><span id="pct-火">0%</span></div>
      <div class="bar-row"><span>土</span><div class="bar"><i id="bar-土"></i></div><span id="pct-土">0%</span></div>
      <div class="bar-row"><span>金</span><div class="bar"><i id="bar-金"></i></div><span id="pct-金">0%</span></div>
      <div class="bar-row"><span>水</span><div class="bar"><i id="bar-水"></i></div><span id="pct-水">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- VIP（示意，内容保留） -->
  <section class="card section">
    <h2 class="group-title">🌙 会员区域 VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title">🗝 命理空间专属内容</div>
        <ul>
          <li>姻缘方向：恋爱缘分、婚姻走势</li>
          <li>事业方向：职场发展、创业潜力</li>
          <li>财运方向：财位分析、理财时机</li>
          <li>宠物命理：伴侣动物的性格与缘分</li>
          <li>合盘分析：婚期择日、新生择时</li>
          <li>测名分析：公司名、宝宝名、命名改运</li>
          <li>财位合盘：住家 / 办公室动线配合</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title">🌙 心怜空间专属内容</div>
        <ul>
          <li>灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li>命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
          <li>家族纪念系统：亲人灵性纪念 & 延续</li>
          <li>每周能量练习 / 神明仪式任务</li>
          <li>能量商城专属折扣 & 御守订制</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<!-- —— 估时向导（默认隐藏；只有勾选“不详”弹出） —— -->
<div class="xl-wizard-mask" id="twMask" aria-hidden="true">
  <div class="xl-wizard" role="dialog" aria-modal="true" aria-labelledby="twTitle">
    <div class="w-head">
      <div class="w-title" id="twTitle">估时向导</div>
      <button class="w-close" id="twClose" aria-label="关闭">✕</button>
    </div>
    <div class="w-body">
      <div class="w-tip">请选择更接近的大致时段，我们会填入一个建议时间（可再手动改）。</div>
      <div class="w-grid" id="twGrid">
        <label class="w-chip"><input type="radio" name="tw" value="06"><div class="label"><div class="dot"></div>清晨（5–7点）</div></label>
        <label class="w-chip"><input type="radio" name="tw" value="09"><div class="label"><div class="dot"></div>上午（7–11点）</div></label>
        <label class="w-chip"><input type="radio" name="tw" value="12"><div class="label"><div class="dot"></div>正午（11–13点）</div></label>
        <label class="w-chip"><input type="radio" name="tw" value="15"><div class="label"><div class="dot"></div>下午（13–17点）</div></label>
        <label class="w-chip"><input type="radio" name="tw" value="18"><div class="label"><div class="dot"></div>傍晚（17–19点）</div></label>
        <label class="w-chip"><input type="radio" name="tw" value="21"><div class="label"><div class="dot"></div>夜间（19–23点）</div></label>
      </div>
    </div>
    <div class="w-actions">
      <button class="btn ghost" id="twCancel">我还是不确定</button>
      <button class="btn" id="twApply">填入这个时间</button>
    </div>
  </div>
</div>

<footer>© 5XLiving • Astro Sanctuary</footer>

<script>
/* ============== 统一配置（你的 Worker 域名） ============== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

/* ============== 简易工具 ============== */
const $ = id => document.getElementById(id);
function setText(id, v){ const el=$(id); if(el) el.textContent=v; }
function setBar(el, pct){ if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function showError(msg){ const el=$('error'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 5000); }

/* ======================= 八字计算器 ======================= */
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN = ['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year) {
    const s = (year - 4) % 10, b = (year - 4) % 12;
    return { stem: this.HEAVENLY_STEMS[(s+10)%10], branch: this.EARTHLY_BRANCHES[(b+12)%12], zodiac: this.ZODIAC[(b+12)%12] };
  }
  solarMonthIndex(y, m, d) {
    const mmdd = m*100 + d;
    const gates = [[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx = 11;
    for (const [thr,val] of gates) if (mmdd >= thr) idx = val;
    const branchBy = {1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'};
    return { index: idx, branch: branchBy[idx] };
  }
  calculateMonthPillar(year, month, day) {
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; // 甲起丙寅
    const stemIdx = (startMap[yStemIdx] + (index - 1)) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }
  calculateDayPillar(year, month, day) {
    const baseUTC = Date.UTC(1900, 0, 31); // 甲辰
    const targetUTC = Date.UTC(year, month - 1, day);
    const dayDiff = Math.floor((targetUTC - baseUTC) / 86400000);
    const stemIdx = (0 + dayDiff) % 10;   // 甲=0
    const branchIdx = (4 + dayDiff) % 12; // 辰=4
    return { stem: this.HEAVENLY_STEMS[(stemIdx+10)%10], branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12] };
  }
  calculateHourPillar(dayStem, hour) {
    const branchMap = {23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'};
    const startMap = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; // 日干→子时起干
    const dayIdx = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemIdx = (startMap[dayIdx] + hourIndex) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch: branchMap[hour] };
  }
  getElement(stem, branch) {
    const s = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
    const b = {'子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
    return `${s[stem]}${b[branch]}`;
  }
  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem), bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si*2 + bi) % this.NAYIN.length];
  }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year, month, day, hour = 12, timeUnknown = false) {
    const yearP = this.calculateYearPillar(year);
    const monthP = this.calculateMonthPillar(year, month, day);
    const dayP = this.calculateDayPillar(year, month, day);
    const hourP = timeUnknown ? {stem:'？', branch:'？'} : this.calculateHourPillar(dayP.stem, hour);
    const dayElement = this.getStemElement(dayP.stem);
    const pillars = { year:yearP, month:monthP, day:{...dayP, element:dayElement}, hour:hourP };
    const cnt = {木:0,火:0,土:0,金:0,水:0};
    const list = timeUnknown ? [yearP, monthP, dayP] : [yearP, monthP, dayP, hourP];
    list.forEach(p => {
      if (p.stem && p.stem !== '？') cnt[this.getStemElement(p.stem)] += 1;
      if (p.branch && p.branch !== '？') cnt[this.getBranchElement(p.branch)] += 1;
    });
    const total = Object.values(cnt).reduce((a,b)=>a+b,0) || 1;
    const pct = { wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100 };
    return { pillars, counts: cnt, percents: pct, timeUnknown };
  }
}
const baziCalculator = new BaziCalculator();

/* ======================= 规则与报告 ======================= */
function judgeStrength(dayGan, monthZhi, cnt){
  const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH = {寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl = STEM_ELEM[dayGan];
  const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  let score = 0;
  if ((season==='春' && '木火'.includes(dmEl)) || (season==='夏' && '火土'.includes(dmEl)) || (season==='秋' && dmEl==='金') || (season==='冬' && dmEl==='水')) score += 2;
  score += (cnt[dmEl]||0) * 1.2;
  const mark = score >= 3 ? '偏强' : (score <= 1 ? '偏弱' : '平衡');
  const focus = mark==='偏强' ? '泄秀/制化' : (mark==='偏弱' ? '补助/顺势' : '守中/调和');
  return {season, mark, focus};
}
function chooseUseful(strength, dmElem){
  if (strength==='偏强'){
    return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]};
  } else if (strength==='偏弱'){
    return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]};
  }
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}

/* —— 渲染四柱/表格 —— */
function renderPillars(root, p, timeUnknown=false){
  if (!root) return;
  root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱' && timeUnknown);
    const stem = u?'？':v.stem, branch=u?'？':v.branch;
    const div = document.createElement('div');
    div.className='pillar';
    div.innerHTML = `<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p, timeUnknown){
  const ge = (s,b)=> baziCalculator.getElement(s,b);
  const ny = (s,b)=> baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem);  setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem);setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem);    setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf = (id,val)=>{ const el=$(id); if(el) el.textContent = val; };
  setIf('year-element', ge(p.year.stem, p.year.branch));
  setIf('month-element', ge(p.month.stem, p.month.branch));
  setIf('day-element', ge(p.day.stem, p.day.branch));
  setIf('hour-element', timeUnknown?'未知':ge(p.hour.stem, p.hour.branch));
  setIf('year-nayin', ny(p.year.stem, p.year.branch));
  setIf('month-nayin', ny(p.month.stem, p.month.branch));
  setIf('day-nayin', ny(p.day.stem, p.day.branch));
  setIf('hour-nayin', timeUnknown?'未知':ny(p.hour.stem, p.hour.branch));
}

/* —— 免费报告（简写） —— */
function buildFreeReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'木', fire:'火', earth:'土', metal:'金', water:'水'};
  const line = ['wood','fire','earth','metal','water'].map(k => `${L[k]} ${Math.round(percents[k]||0)}%`).join('　');
  const hourTxt = timeUnknown ? '？？' : (pillars.hour.stem + pillars.hour.branch);
  return `
    <div id="xl-free-report" class="card" style="margin-top:6px;">
      <div class="h2">免费报告</div>
      <p style="margin:6px 0;">四柱：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></p>
      <p style="margin:6px 0;">日主：<strong>${pillars.day.stem}</strong>（<strong>${pillars.day.element}</strong>）｜季节：<strong>${st.season||'-'}</strong>｜命局：<strong>${st.mark}</strong> · <strong>${st.focus}</strong></p>
      <p style="margin:8px 0;">五行：${line}</p>
      ${timeUnknown?`<p class="muted" style="margin-top:6px;">提示：时间不详，时柱未纳入。</p>`:''}
    </div>
  `;
}

/* —— 富内容报告（章节 1~10；给“十、流年/流月”加 id=sec-fore） —— */
function buildRichReportHTML({pillars, percents, st, adv, timeUnknown}) {
  const L = {wood:'木', fire:'火', earth:'土', metal:'金', water:'水'};
  const line = ['wood','fire','earth','metal','water'].map(k => `${L[k]}${Math.round(percents[k]||0)}%`).join(' ');
  const hourTxt = timeUnknown ? '？？' : (pillars.hour.stem + pillars.hour.branch);
  return `
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">一、命盘总览</h3>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;font-size:14px;">
        <div>四柱：<strong>${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${hourTxt}</strong></div>
        <div>日主：<strong>${pillars.day.stem}</strong>（<strong>${pillars.day.element}</strong>）</div>
        <div>季节：<strong>${st.season||'-'}</strong></div>
        <div>命局：<strong>${st.mark}</strong> · 策略：<strong>${st.focus}</strong></div>
      </div>
    </section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">二、五行能量分析</h3>
      <div style="font-size:14px;">${line}</div>
      <p class="muted" style="margin-top:8px;">${timeUnknown?'提示：出生时间不详，未纳入时柱。':''}</p>
    </section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">三、性格与天赋</h3><p>依据日主、季节与强弱给出核心性格标签（模板化）。</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">四、格局与喜忌</h3><p>按四柱特征（坐禄/比劫/伤官/七杀等）模板化输出。喜用：${(adv?.useful||[]).join('、')||'—'}</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">五、事业与发展（免费试读）</h3><p>发展策略：${st.focus}，建立 SOP 与可复制流程。</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">六、感情与关系（免费试读）</h3><p>相处建议：尊重节奏、定期复盘（模板化）。</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">七、财富与理财（免费试读）</h3><p>理财建议：以${(adv?.useful||[]).join('、')||'—'}为主调，稳中求进。</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">八、健康与作息</h3><p>依据最弱五行给出作息/饮食/运动提醒（模板化）。</p></section>
    <section class="card"><h3 style="margin-top:0;color:var(--brand)">九、环境与色彩（五行调法）</h3><p>有利方位与色彩材质（模板化）。</p></section>
    <section id="sec-fore" class="card" style="padding:20px;margin-bottom:10px;"><h3 style="margin-top:0;color:var(--brand)">十、流年 / 流月 · 免费预告</h3><p>年度提示 + 本月关注（模板化）。</p></section>
    <section id="sec-cta" class="card" style="padding:20px;margin-bottom:10px;"><h3 style="margin-top:0;color:var(--brand)">解锁你的完整专属报告</h3>
      <p>升级 <strong>VIP</strong>，获得婚姻 / 事业 / 财库 / 择日等完整方案与行动清单。</p>
      <div style="margin-top:10px;"><a href="/vip" class="btn" style="text-decoration:none;">升级 VIP</a></div>
    </section>
  `;
}

/* —— 心怜管家卡片 —— */
function ensureButlerCard(){
  if (document.getElementById('assistant-panel')) return;
  const card = document.createElement('div');
  card.id = 'assistant-panel';
  card.className = 'card';
  card.innerHTML = `
    <div class="h2">心怜管家 · 智能解读</div>
    <div id="assistant-analysis" style="margin-top:4px"></div>
    <div id="assistant-advice" class="muted" style="margin-top:8px"></div>
  `;
  // 初始先放在结果末尾，稍后再移动
  (document.getElementById('result') || document.body).appendChild(card);
}
function fillButler({pillars, percents, st, adv, timeUnknown}){
  ensureButlerCard();
  const ana = document.getElementById('assistant-analysis');
  const advc= document.getElementById('assistant-advice');
  if (ana) ana.innerHTML = `
    <ul>
      <li>日主：<strong>${pillars.day.stem}</strong>（${pillars.day.element}）</li>
      <li>命局偏${st.mark==='平衡'?'平衡':st.mark}：${st.focus}</li>
      <li>季节：${st.season}；五行比例：木${Math.round(percents.wood)}%、火${Math.round(percents.fire)}%、土${Math.round(percents.earth)}%、金${Math.round(percents.metal)}%、水${Math.round(percents.water)}%</li>
    </ul>`;
  if (advc) advc.innerHTML = `
    <ul>
      <li><strong>发展策略：</strong>${st.focus}</li>
      <li><strong>喜用元素：</strong>${(adv?.useful||[]).join('、')||'—'}</li>
      ${timeUnknown?'<li class="muted">提示：因勾选“时间不详”，本页分析未纳入时柱。</li>':''}
    </ul>`;
}

/* —— 把管家卡片挪到【十、流年/流月·免费预告】之后 —— */
function relocateButlerAfterForecast(){
  const butler = document.getElementById('assistant-panel');
  const fore = document.getElementById('sec-fore');
  if (butler && fore && fore.parentNode){
    fore.parentNode.insertBefore(butler, fore.nextSibling);
  }
}

/* —— GPT 抽屉（可选，小工具） —— */
function ensureGPTDrawer(){
  let drawer = document.getElementById('gpt-drawer');
  if (!drawer){
    const wrap = document.createElement('details');
    wrap.id = 'gpt-drawer';
    wrap.className = 'card';
    wrap.innerHTML = `
      <summary style="cursor:pointer;list-style:none;padding:12px 16px;font-weight:700;color:var(--brand);">GPT 问答</summary>
      <div style="padding:10px 12px;">
        <div id="gpt-body" style="max-height:260px; overflow:auto; font-size:14px; line-height:1.5; border:1px solid #222; border-radius:8px; padding:8px;"></div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input id="gpt-input" placeholder="问点什么…" style="flex:1; padding:8px; border-radius:8px; border:1px solid #222; background:#0b0f14; color:var(--text)">
          <button id="gpt-send" class="btn" style="padding:8px 12px;">发送</button>
        </div>
      </div>`;
    (document.getElementById('result')||document.body).appendChild(wrap);
  }
  const send = document.getElementById('gpt-send'), input=$('gpt-input'), body=$('gpt-body');
  if (send && input && body){
    send.onclick = async ()=>{
      const text = (input.value||'').trim();
      if(!text) return;
      body.insertAdjacentHTML('beforeend', `<div style="text-align:right; margin:6px 0;">${text}</div>`);
      input.value='';

      const payload = { messages: [{role:'user', content: text}], context: window.__bazi_ctx__ || {} };
      async function post(url){ try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (r.ok) { const t = await r.text(); try { const j = JSON.parse(t); return j.reply || t || '（无响应）'; } catch { return t || '（无响应）'; } }
      }catch(_){}
        return null; }
      const reply = await post('/api/butler/chat') || await post('/api/chat') || '（暂时无法连接到服务端）';
      body.insertAdjacentHTML('beforeend', `<div style="margin:6px 0;">${reply}</div>`);
      body.scrollTop = body.scrollHeight;
    };
  }
}

/* —— 统一挂载 —— */
function mountIntoResult({pillars, percents, st, adv, timeUnknown}){
  const resultEl = $('result');
  if(!resultEl) return;

  // 免费报告
  const freeHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown});
  resultEl.insertAdjacentHTML('beforeend', freeHTML);

  // 富文报告（含 1~10 节 + CTA）
  const richHTML = buildRichReportHTML({pillars, percents, st, adv, timeUnknown});
  resultEl.insertAdjacentHTML('beforeend', richHTML);

  // 管家卡片 + 填充
  fillButler({pillars, percents, st, adv, timeUnknown});

  // 把管家卡片移动到“十、流年/流月 · 免费预告”之后
  relocateButlerAfterForecast();

  // GPT 抽屉（可选）
  ensureGPTDrawer();

  // 聊天上下文（给后端）
  window.__bazi_ctx__ = {
    pillars,
    wuxing_ratio: percents,
    season: st.season,
    strength: st.mark,
    strategy: st.focus,
    useful: adv?.useful || [],
    timeUnknown
  };
}

/* ======================= 主流程：生成八字 ======================= */
async function genChart(){
  const birth = ($('birthdate')?.value||'').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  if (!birth){ showError('请填写出生日期。'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled=true; if(tx) tx.style.display='none'; if(ld) ld.style.display='inline-block';

  try{
    const [Y,M,D] = birth.split('-').map(Number);
    let hour = 12;
    if (!timeUnknown){
      const t = ($('birthtime')?.value||'').trim();
      if(t) hour = parseInt(t.split(':')[0],10);
    }

    const { pillars, counts, percents, timeUnknown: tu } = baziCalculator.calculateBazi(Y,M,D,hour,timeUnknown);

    // 显示结果区
    $('result')?.style.setProperty('display','block');

    // 日期与“未纳入时柱”徽章
    const timeText = tu ? '时间不详' : (hour + '时');
    setText('bazi-date', `出生日期：${Y}年${M}月${D}日 ${timeText}`);
    if (tu) { const el = $('bazi-date'); el && (el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>'); }

    // 经典区：四柱表 + 五行条
    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);
    setBar($('bar-木'), percents.wood); setText('pct-木', Math.round(percents.wood)+'%');
    setBar($('bar-火'), percents.fire); setText('pct-火', Math.round(percents.fire)+'%');
    setBar($('bar-土'), percents.earth); setText('pct-土', Math.round(percents.earth)+'%');
    setBar($('bar-金'), percents.metal); setText('pct-金', Math.round(percents.metal)+'%');
    setBar($('bar-水'), percents.water); setText('pct-水', Math.round(percents.water)+'%');

    // 强弱/喜用
    const st = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);
    const keys = Object.keys(counts);
    const maxK = keys.reduce((a,b)=>counts[a]>counts[b]?a:b);
    const minK = keys.reduce((a,b)=>counts[a]<counts[b]?a:b);
    setText('bazi-elements-balance', `五行中${maxK}元素最强，${minK}元素最弱。`);

    // 统一挂载（免费报告 + 富内容 + 管家 + GPT）
    mountIntoResult({ pillars, percents, st, adv, timeUnknown: tu });

    // 控制台校验
    console.log('四柱 →', pillars.year.stem+pillars.year.branch, pillars.month.stem+pillars.month.branch, pillars.day.stem+pillars.day.branch, tu ? '？' : (pillars.hour.stem+pillars.hour.branch) );
  } catch(err){
    console.error(err);
    showError('计算八字时出现错误，请重试');
  } finally {
    if(btn) btn.disabled=false; if(tx) tx.style.display='inline'; if(ld) ld.style.display='none';
  }
}

/* ======================= 估时向导交互 ======================= */
(function(){
  const chk = $('timeUnknown');
  const timeInput = $('birthtime');
  const mask = $('twMask');
  const grid = $('twGrid');
  const applyBtn = $('twApply');
  const cancelBtn = $('twCancel');
  const closeBtn = $('twClose');

  if(!chk || !timeInput || !mask) return;

  function setTimeDisabled(v){
    timeInput.disabled = v;
    timeInput.style.opacity = v ? .6 : 1;
  }
  function refreshActive(){
    document.querySelectorAll('.w-chip').forEach(el => {
      const input = el.querySelector('input[type="radio"]');
      el.classList.toggle('active', input && input.checked);
    });
  }
  grid && grid.addEventListener('change', refreshActive);

  chk.addEventListener('change', () => {
    const v = chk.checked;
    setTimeDisabled(v);
    if (v) {
      mask.style.display = 'block';
      mask.setAttribute('aria-hidden', 'false');
    } else {
      mask.style.display = 'none';
      mask.setAttribute('aria-hidden', 'true');
    }
  });

  function closeWizard(){
    mask.style.display = 'none';
    mask.setAttribute('aria-hidden', 'true');
  }
  cancelBtn && cancelBtn.addEventListener('click', closeWizard);
  closeBtn && closeBtn.addEventListener('click', closeWizard);
  mask && mask.addEventListener('click', (e)=>{ if(e.target===mask) closeWizard(); });

  applyBtn && applyBtn.addEventListener('click', ()=>{
    const sel = grid.querySelector('input[name="tw"]:checked');
    if(!sel){ alert('请先选择一个大致时段'); return; }
    const hh = String(sel.value).padStart(2,'0');
    timeInput.value = `${hh}:00`;
    chk.checked = false;
    setTimeDisabled(false);
    closeWizard();
    refreshActive();
  });

  setTimeDisabled(chk.checked);
  refreshActive();
})();

/* ================== 事件绑定 ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // 默认日期
  const today=new Date(); const def=today.toISOString().split('T')[0]; if($('birthdate')&&!$('birthdate').value) $('birthdate').value=def;

  // 生成
  $('genBtn')?.addEventListener('click', genChart);

  // Chat
  const chatFab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), close=$('ssChatClose');
  chatFab.addEventListener('click', ()=>{ panel.style.display='flex'; input.focus(); });
  close.addEventListener('click', ()=>{ panel.style.display='none'; });
  function addMsg(t,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=t; body.appendChild(div); body.scrollTop=body.scrollHeight; }
  async function askChat(prompt){ addMsg(prompt,true); input.value=''; try{ const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'system',content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。'},{role:'user',content:prompt}]})}); let data={}; try{data=await r.json()}catch{} const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??"抱歉，服务暂时繁忙，请稍后重试。"; addMsg(reply);}catch{ addMsg('网络异常，请稍后再试。'); } }
  send.addEventListener('click', ()=>{ const v=input.value.trim(); if(v) askChat(v); });
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=input.value.trim(); if(v) askChat(v); }});

  // 估时向导：勾选时弹出；取消隐藏
  const timeUnknown=$('timeUnknown'); timeUnknown.addEventListener('change', (e)=>{ if(e.target.checked) openTimeEstimator(); else closeTimeEstimator(); });
  $('te-close')?.addEventListener('click', closeTimeEstimator);
  $('te-mask')?.addEventListener('click', (e)=>{ if(e.target===$('te-mask')) closeTimeEstimator(); });
  $('te-confirm')?.addEventListener('click', ()=>{
    const sel=document.querySelector('input[name="te-slot"]:checked');
    if(!sel){ alert('请选择一个大致时段'); return; }
    $('birthtime').value=sel.value; // 写入建议时间
    $('timeUnknown').checked=false; // 自动取消“不详”
    closeTimeEstimator();
    const tips=$('bazi-date'); if(tips) tips.innerHTML=(tips.innerHTML||'')+` <span class="badge-warn">已根据估时向导填入：${sel.value}</span>`;
  });
  $('te-skip')?.addEventListener('click', closeTimeEstimator);

  // 登录/注册/重设（最小可用）
  function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
  $('registerForm')?.addEventListener('submit', async (e)=>{ e.preventDefault();
    const email=$('email').value.trim(), password=$('password').value.trim();
    if(!email||!password) return showAuthErr('请输入邮箱与密码'); if(!strongPwd(password)) return showAuthErr('密码至少8位，需包含大写/小写/数字/特殊符号');
    $('registerBtn').disabled=true;
    try{
      const res=await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}).then(r=>r.json());
      if(res.ok===true){ localStorage.setItem('vipEmail',email); location.href='vip_trial.html'; return; }
      if((res.msg||'')==='exists'){ // 已存在：尝试登录
        const login=await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}).then(r=>r.json());
        if(login.ok===true){ localStorage.setItem('vipEmail',email); location.href='https://astro.5xliving.com/vip_soul_sanctuary.html'; return; }
      }
      showAuthErr('注册失败：'+(res.msg||''));
    }catch(err){ showAuthErr('注册失败：'+(err?.message||'')); }
    finally{ $('registerBtn').disabled=false; }
  });
  $('loginForm')?.addEventListener('submit', async (e)=>{ e.preventDefault();
    const email=$('email').value.trim(), password=$('password').value.trim(); if(!email||!password) return showAuthErr('请输入邮箱与密码');
    $('loginBtn').disabled=true;
    try{
      const res=await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}).then(r=>r.json());
      if(res.ok===true){ localStorage.setItem('vipEmail',res.email||email); location.href='https://astro.5xliving.com/vip_soul_sanctuary.html'; return; }
      showAuthErr('登入失败：'+(res.msg||''));
    }catch(err){ showAuthErr('登入失败：'+(err?.message||'')); }
    finally{ $('loginBtn').disabled=false; }
  });
  $('resetBtn')?.addEventListener('click', async ()=>{
    let email=prompt('请输入注册邮箱：'); if(email===null) return; email=email.trim(); if(!email) return showAuthErr('邮箱不能为空');
    let newPassword=prompt('请输入新密码（至少8位，含大小写、数字、符号）：'); if(newPassword===null) return; newPassword=newPassword.trim(); if(!newPassword) return showAuthErr('密码不能为空');
    if(!(/.{8,}/.test(newPassword) && /[A-Z]/.test(newPassword) && /[a-z]/.test(newPassword) && /[0-9]/.test(newPassword) && /[^A-Za-z0-9]/.test(newPassword))) return showAuthErr('密码至少8位，需包含大写/小写/数字/特殊符号');
    $('resetBtn').disabled=true;
    try{
      const res=await fetch(`${API_BASE}/api/reset`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,newPassword})}).then(r=>r.json());
      if(!res.ok) return showAuthErr('重设失败：'+(res.msg||'')); alert('密码已成功更新，请用新密码重新登入。');
    }catch(err){ showAuthErr('重设失败：'+(err?.message||'')); }
    finally{ $('resetBtn').disabled=false; }
  });
});

/* ================== 自测（控制台） ================== */
(function(){
  const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12);
  console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
  console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
})();
</script>
</body>
</html>
