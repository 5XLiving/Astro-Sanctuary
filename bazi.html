<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#9aa3b2;--brand:#d4af37;--gold:#d4af37;--gold2:#f2d27a;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.35)}
html,body{height:100%}
body{margin:0;color:var(--text);background:#0b0f14;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC",Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 结果样式 */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.3rem;font-weight:700;letter-spacing:.05em}
.bars{display:grid;gap:8px;margin-top:10px}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.ul{margin:.4rem 0 0 .9rem;line-height:1.8}

/* Chat（保留可用，但不影响排盘） */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:95%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="muted">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">其他</option>
        </select>
      </div>

      <!-- 历法 + 闰月（唯一的 calendarHint） -->
      <div>
        <label class="muted">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> 闰月
          </label>
        </div>
        <div id="calendarHint" class="muted" style="display:none; margin-top:6px;">
          选择农历时，请确认是否为闰月；若为闰月请勾选“闰月”。系统会自动换算为阳历后计算。
        </div>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">生成八字</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div class="muted" id="error" style="color:#ffb4b4;display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card section">
      <div class="h2">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-fire"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-earth" style="width:0%"></i></div>
        <div class="bar"><i id="bar-metal" style="width:0%"></i></div>
        <div class="bar"><i id="bar-water" style="width:0%"></i></div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <div class="card section">
      <div class="h2">命格简评</div>
      <div class="desc" id="bazi-advice" style="white-space:pre-wrap;line-height:1.7"></div>
      <ul class="ul" id="fate-points"></ul>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗（可留可删） -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" placeholder="问点什么吧…"/>
    <button id="ssChatSend">发送</button>
  </div>
</div>
  
<!-- 只需要这个库：本地 + 多CDN 回退 -->
<script>
/* ================== 站点配置（改这个） ================== */
// 如果你已有 Cloudflare Worker/后端聊天接口，把地址填进来：例如
// const WORKER_API = "https://throbbing-lab-1440.你的域名.workers.dev/chat";
const WORKER_API = ""; // 留空则走本地兜底

/* ================== 小工具 ================== */
const $ = id => document.getElementById(id);
function bySel(s, root=document){ return root.querySelector(s); }
function el(tag, attrs={}, html=""){ const d=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>d.setAttribute(k,v)); if(html!==undefined) d.innerHTML=html; return d; }
function normalizeDate(str){ if(!str) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str; const m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m){const[_,d,mo,y]=m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`;} return str; }
function normalizeTime24(t){ if(!t) return "00:00"; const s=t.trim().toLowerCase().replace(/\s+/g,""); const m=s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/); if(!m) return t; let hh=parseInt(m[1],10), mm=parseInt(m[2]||'0',10); const ap=m[3]; if(ap==="am"){if(hh===12) hh=0;} else if(ap==="pm"){if(hh!==12) hh+=12;} return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
async function loadScript(src, timeout=15000){ if([...document.scripts].some(s=>(s.src||'').includes(src))) return; await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; const t=setTimeout(()=>rej(new Error('timeout '+src)),timeout); s.onload=()=>{clearTimeout(t);res();}; s.onerror=()=>{clearTimeout(t);rej(new Error('load failed '+src));}; document.head.appendChild(s); }); }

/* ================== 命理计算（本地） ================== */
const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const BRANCH_ELEM={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
const YANG={甲:1,丙:1,戊:1,庚:1,壬:1};

function tenGod(dm, other){
  const order=['木','火','土','金','水'], i=order.indexOf(STEM_ELEM[dm]), j=order.indexOf(STEM_ELEM[other]);
  const same=(a,b)=>a===b, next=(a,b)=> (a+1)%5===b, over=(a,b)=> (a+2)%5===b, beOver=(a,b)=> (a+3)%5===b, input=(a,b)=> (a+4)%5===b;
  const s = YANG[dm]===YANG[other];
  if(same(i,j)) return s?'比肩':'劫财';
  if(next(i,j)) return s?'食神':'伤官';
  if(over(i,j)) return s?'偏财':'正财';
  if(beOver(i,j)) return s?'七杀':'正官';
  if(input(i,j)) return s?'偏印':'正印';
  return '';
}
function countElements(gzList){
  const cnt={木:0,火:0,土:0,金:0,水:0};
  gzList.forEach(gz=>{ if(!gz) return; const gan=gz[0], zhi=gz[1]; const e1=STEM_ELEM[gan], e2=BRANCH_ELEM[zhi]; if(e1) cnt[e1]+=1; if(e2) cnt[e2]+=1; });
  const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
  return {cnt, pct:{
    wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100
  }};
}
function judgeStrength(dayGan, monthZhi, cnt){
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  const genEl={木:'水',火:'木',土:'火',金:'土',水:'金'}[dmEl];
  const beOverEl={木:'金',火:'水',土:'木',金:'火',水:'土'}[dmEl];
  const overEl={木:'土',火:'金',土:'水',金:'木',水:'火'}[dmEl];
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score += (cnt[dmEl]||0)*1.2 + (cnt[genEl]||0)*1.5;
  score -= (cnt[beOverEl]||0)*1.5 + (cnt[overEl]||0)*0.8;
  const mark = score>=4?'偏强':(score<=1?'偏弱':'平衡');
  const focus = mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和');
  return {season, mark, focus};
}
function elemAdvice(pct, dm){
  const arr=[['木',pct.wood],['火',pct.fire],['土',pct.earth],['金',pct.metal],['水',pct.water]];
  const hi=arr.slice().sort((a,b)=>b[1]-a[1])[0][0], lo=arr.slice().sort((a,b)=>a[1]-b[1])[0][0];
  const idea={木:'成长/内容/教育/上游',火:'传播/品牌/销售/文娱',土:'项目/运营/服务/基建',金:'标准/制造/金融/风控',水:'信息/数据/出行/国际'};
  return {hi,lo, summary:`偏${hi}、${lo}偏弱；以日主「${dm.stem}（${dm.elem}）」为锚，强项快推、弱项外包。`};
}
function renderPillars(root,p){
  root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const div=el('div',{class:'pillar'}, `<div class="tit">${tit}</div><div class="gz">${(v&&v.gz)||'--'}</div>`); root.appendChild(div);
  });
}

/* ================== 依赖加载 ================== */
async function ensureLunarJS(){
  if(window.Solar && window.Lunar) return true;
  try{ await loadScript('https://unpkg.zhimg.com/lunar-javascript@1.6.15/lunar.min.js'); }catch{}
  if(!(window.Solar&&window.Lunar)){ try{ await loadScript('https://fastly.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js'); }catch{} }
  if(window.lunar && window.lunar.Solar && window.lunar.Lunar){ window.Solar=window.lunar.Solar; window.Lunar=window.lunar.Lunar; }
  if(!(window.Solar&&window.Lunar)) throw new Error('命理计算组件加载失败。');
}

/* ================== 主流程（排盘 + 进阶 + VIP） ================== */
async function genChart(){
  const err=$('error'); err.style.display='none'; err.textContent='';
  const rawDate=($('birthdate').value||'').trim(); const rawTime=($('birthtime').value||'').trim();
  if(!rawDate||!rawTime){ err.textContent='请完善出生日期与时间。'; err.style.display='block'; return; }
  try{
    await ensureLunarJS();
    const t24=normalizeTime24(rawTime); const [Y,M,D]=normalizeDate(rawDate).split('-').map(Number); const [hh,mm]=t24.split(':').map(Number);
    const solar=Solar.fromYmdHms(Y,M,D,hh,mm||0,0), lunar=solar.getLunar(), ec=lunar.getEightChar();
    const gzYear=ec.getYear(), gzMonth=ec.getMonth(), gzDay=ec.getDay(), gzHour=ec.getTime();
    const pillars={year:{gz:gzYear,gan:gzYear[0],zhi:gzYear[1]},month:{gz:gzMonth,gan:gzMonth[0],zhi:gzMonth[1]},day:{gz:gzDay,gan:gzDay[0],zhi:gzDay[1]},hour:{gz:gzHour,gan:gzHour[0],zhi:gzHour[1]}};
    const dayGan=pillars.day.gan, dmElem=STEM_ELEM[dayGan];
    // 渲染
    $('result').style.display='block';
    $('bazi-date').textContent=`用于计算（UTC+8，阳历）：${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')} ${t24}`;
    renderPillars($('bazi-pillars'), pillars);
    $('bazi-day-master').textContent=`日主：${dayGan}（${dmElem}）`;
    const {cnt,pct}=countElements([gzYear,gzMonth,gzDay,gzHour]);
    const bars={wood:$('bar-wood'),fire:$('bar-fire'),earth:$('bar-earth'),metal:$('bar-metal'),water:$('bar-water')};
    function setBar(n,p){ if(n) n.style.width=Math.max(0,Math.min(100,p))+'%'; }
    setBar(bars.wood,pct.wood); setBar(bars.fire,pct.fire); setBar(bars.earth,pct.earth); setBar(bars.metal,pct.metal); setBar(bars.water,pct.water);
    $('bazi-elements-balance').textContent=`五行占比：木${Math.round(pct.wood)} 火${Math.round(pct.fire)} 土${Math.round(pct.earth)} 金${Math.round(pct.metal)} 水${Math.round(pct.water)}`;
    // 强弱/十神/建议
    const st=judgeStrength(dayGan, pillars.month.zhi, cnt);
    const adv=elemAdvice({wood:pct.wood,fire:pct.fire,earth:pct.earth,metal:pct.metal,water:pct.water},{stem:dayGan,elem:dmElem});
    const tgYear=tenGod(dayGan,pillars.year.gan), tgMonth=tenGod(dayGan,pillars.month.gan), tgHour=tenGod(dayGan,pillars.hour.gan);
    $('bazi-strengths').textContent=`亮点：${[tgYear,tgMonth,tgHour].filter(Boolean).join('、')||'均衡'}；强项：${adv.hi}；短板：${adv.lo}`;
    $('bazi-advice').textContent=`核心判断：${st.mark}；季节：${st.season}；策略：${st.focus}。${adv.summary}`;
    // 进阶/ VIP 块（先移除旧）
    bySel('#adv-section')?.remove(); bySel('#vip-section')?.remove();
    const sec1=el('section',{class:'card section',id:'adv-section'},`
      <div class="h2">进阶解析</div>
      <div style="white-space:pre-wrap;line-height:1.8">四柱：${gzYear}｜${gzMonth}｜${gzDay}｜${gzHour}
· 日主 ${dayGan}（${dmElem}），月令${st.season}，整体「${st.mark}」，宜「${st.focus}」。
· 十神（年/月/时）：${tgYear||'-'}｜${tgMonth||'-'}｜${tgHour||'-'}
· 资源结构：${adv.summary}
节奏建议：${st.season==='春'?'生发铺垫':st.season==='夏'?'强推进与曝光':st.season==='秋'?'收敛打磨标准':st.season==='冬'?'沉淀体系蓄势':'按轻重缓急'}</div>`);
    $('result').after(sec1);
    const vdata={
      love:`${st.mark==='偏强'?'先事业后婚恋，择平衡型伴侣':'稳中求进，择互补型伴侣'}；优先在「${adv.hi}」场景结缘，避免「${adv.lo}」冲突。`,
      career:`倾向「${adv.hi}」行业与岗位；「${adv.lo}」宜外包/搭档。${tgMonth==='正官'?'官星见，管理线有利；':''}${tgMonth==='食神'||tgMonth==='伤官'?'食伤显，内容/产品/创作有势；':''}`,
      wealth:`财气来源：${(tgYear==='正财'||tgMonth==='正财'||tgHour==='正财')?'正财清晰；':''}${(tgYear==='偏财'||tgMonth==='偏财'||tgHour==='偏财')?'偏财灵动；':''}理财：强势期增配工具/指数，弱势期现金流优先。`,
      pet:`偏${dmElem==='木'?'温顺聪明':'活泼热情'}型伴侣动物；用「${adv.hi}」元素色系与玩具增缘。`,
      match:`择日以用神当令；避开「${adv.lo}」过弱时段。新生择时优先 ${st.mark==='偏强'?'印财调候':'印比护身' }。`,
      name:`命名补「${adv.lo}」避「${adv.hi}」过旺；公司名取「${adv.hi}」意象利品牌；宝宝名宜${st.mark==='偏强'?'稳重收敛':'明朗阳刚' }。`,
      feng:`办公/住家：${adv.hi}方位布光/绿植/动线增强；${adv.lo}方位收纳/静化。`
    };
    const sec2=el('section',{class:'card section',id:'vip-section'},`
      <div class="h2">VIP 命理空间</div>
      <div style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
        ${[
          ['姻缘方向','恋爱缘分、婚姻走势',vdata.love],
          ['事业方向','职场发展、创业潜力',vdata.career],
          ['财运方向','财位分析、理财时机',vdata.wealth],
          ['宠物命理','伴侣动物的性格与缘分',vdata.pet],
          ['合盘分析','婚期择日、新生择时',vdata.match],
          ['测名分析','公司名、宝宝名、命名改运',vdata.name],
          ['财位合盘','住家 / 办公室动线配合',vdata.feng],
        ].map(([t,s,c])=>`<div style="background:#0f1624;border:1px solid #253245;border-radius:12px;padding:12px">
            <div style="font-weight:700;margin-bottom:4px">${t}</div>
            <div class="muted" style="margin-bottom:6px">${s}</div>
            <div class="muted">试读：${c}</div>
        </div>`).join('')}
      </div>`);
    sec1.after(sec2);

    // —— 提供给心怜管家的上下文（最近一盘）
    window.__BaziContext__ = {
      date: `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')} ${t24}`,
      pillars: {year:gzYear,month:gzMonth,day:gzDay,hour:gzHour},
      dayMaster: `${dayGan}（${dmElem}）`,
      season: st.season, strength: st.mark, strategy: st.focus,
      strong: adv.hi, weak: adv.lo
    };

  }catch(e){
    const err=$('error'); err.textContent=(e&&e.message)||'网络异常，请稍后再试。'; err.style.display='block';
    $('result').style.display='block';
  }
}

/* ================== 心怜管家（Chat，带后端/本地兜底） ================== */
function setupChat(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  const open=()=>{ panel.style.display='flex'; input.focus(); };
  const close=()=>{ panel.style.display='none'; };
  fab?.addEventListener('click',open); closeBtn?.addEventListener('click',close);

  function push(role,text){ const div=el('div',{class:'ss-msg'+(role==='me'?' me':'')}); div.textContent=text; body.appendChild(div); body.scrollTop=body.scrollHeight; }

  async function askLLM(q){
    // 组织上下文（最近一次排盘）
    const ctx=window.__BaziContext__;
    const system = `你是“心怜管家”，语气温暖克制。若用户聊命理，结合上下文给出结构化建议。
上下文：${ctx?JSON.stringify(ctx):'暂无排盘'}。`;
    // 若未配置后端，走本地兜底
    if(!WORKER_API){
      // 简单兜底规则
      if(!ctx) return '先点击“生成八字”，我会结合你的命盘再说得更具体～';
      return `已记录：日主${ctx.dayMaster}，${ctx.season}令，整体${ctx.strength}。建议「${ctx.strategy}」。强项${ctx.strong}、短板${ctx.weak}。你想聊：事业/财运/姻缘/风水/起名 哪一块？`;
    }
    try{
      const r=await fetch(WORKER_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system,query:q})});
      if(!r.ok) throw new Error('net');
      const data=await r.json();
      return (data.reply||'（无回复）').trim();
    }catch{ return '网络不稳定，我暂时连不上服务；先给你本地建议：'+(await askLLM('（本地兜底）')); }
  }

  async function sendMsg(){
    const v=input.value.trim(); if(!v) return; input.value=''; push('me',v);
    const thinking=el('div',{class:'ss-msg'},'…'); body.appendChild(thinking); body.scrollTop=body.scrollHeight;
    const ans=await askLLM(v); thinking.remove(); push('bot',ans);
  }
  send?.addEventListener('click',sendMsg);
  input?.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMsg(); });

  // 首次欢迎
  if(body && !body.dataset.inited){ push('bot','嗨，我是心怜管家～ 先在上面生成你的八字，我就能结合命盘聊事业、姻缘、财运、风水与命名了。'); body.dataset.inited='1'; }
}

/* ================== 事件绑定 ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  $('genBtn')?.addEventListener('click', genChart);
  setupChat(); // 初始化管家
  // 历法 UI（你的页面已有选项，这里只做提示显隐）
  const calendarSel=$('calendar'), leapWrap=$('leapWrap'), hint=bySel('#calendarHint');
  function toggle(){ const isLunar=calendarSel?.value==='lunar'; if(leapWrap) leapWrap.style.display=isLunar?'inline-flex':'none'; if(hint) hint.style.display=isLunar?'block':'none'; }
  calendarSel?.addEventListener('change',toggle); toggle();
});
</script>
</body>
</html>

