<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>å…«å­—å‘½ç† Â· 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="icon" href="data:,"> <!-- é¿å… favicon 404 -->
<style>
:root {
  --bg: #0b0f14; --card: #11161dcc; --text: #e8edf3; --muted: #9aa3b2;
  --brand: #d4af37; --gold2: #f2d27a; --radius: 14px; --shadow: 0 8px 30px rgba(0,0,0,.35);
  --accent:#3a86ff;
}
html,body{height:100%;margin:0;color:var(--text);background:var(--bg);font-family:Inter,system-ui,-apple-system,"Noto Sans SC",sans-serif;line-height:1.6}
.container{max-width:1060px;margin:0 auto;padding:24px 16px 64px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0}
.h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
.h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
.muted{color:var(--muted)}
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
.bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
.bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
.bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
.error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
</style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="title">å‘½ç†ä¾›é—¨ Â· å…«å­—ç®€è¯„ï¼ˆä¿®å¤ç‰ˆï¼‰</div>
    <div class="muted">å…è´¹åŒºä¹Ÿè¦å¥½æ‡‚ Â· å·²ä¿®å¤æŒ‰é’®ä¸æœˆ/æ—¥/æ—¶æŸ±ç®—æ³•</div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›˜</div>
    <div class="row cols-3">
      <div>
        <label class="muted">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input id="name" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ï¼‰">
      </div>
      <div>
        <label class="muted">æ€§åˆ«</label>
        <select id="gender"><option value="">ä¸é€éœ²</option><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select>
      </div>
      <div>
        <label class="muted">å†æ³•</label>
        <select id="calendar"><option value="gregorian">é˜³å† / Gregorian</option><option value="lunar">å†œå† / Lunar</option></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">å‡ºç”Ÿæ—¶é—´</label>
        <input type="time" id="birthtime" value="12:00">
        <label class="muted" style="display:block;margin-top:6px"><input type="checkbox" id="timeUnknown"> å‡ºç”Ÿæ—¶é—´ä¸è¯¦</label>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">
          <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
          <span id="genBtnLoading" style="display:none">è®¡ç®—ä¸­...</span>
        </button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">è¯´æ˜ï¼šæš‚ä»¥ä¸œå…«åŒºï¼ˆUTC+8ï¼‰æ¨ç®—ï¼›åç»­å°†æ”¯æŒæŒ‰å‡ºç”Ÿåœ°æ¢ç®—ä¸å†œå†è¾“å…¥ã€‚</div>
    <div id="error" class="error-message"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card">
      <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›˜</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date" style="margin-top:6px"></div>

      <table class="bazi-table">
        <thead><tr><th></th><th>å¹´æŸ±</th><th>æœˆæŸ±</th><th>æ—¥æŸ±</th><th>æ—¶æŸ±</th></tr></thead>
        <tbody>
          <tr><td>å¤©å¹²</td><td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td></tr>
          <tr><td>åœ°æ”¯</td><td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td></tr>
          <tr><td>äº”è¡Œ</td><td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td></tr>
          <tr><td>çº³éŸ³</td><td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
      <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-æœ¨"></i></div><span id="pct-æœ¨">0%</span></div>
      <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-ç«"></i></div><span id="pct-ç«">0%</span></div>
      <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-åœŸ"></i></div><span id="pct-åœŸ">0%</span></div>
      <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-é‡‘"></i></div><span id="pct-é‡‘">0%</span></div>
      <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-æ°´"></i></div><span id="pct-æ°´">0%</span></div>
      <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</main>

<script>
// â€”â€” å…«å­—è®¡ç®—å™¨ï¼ˆå·²ä¿®æ­£ï¼šèŠ‚æ°”å®šæœˆã€æ—¥æŸ±+1ã€å®‰å…¨æ—¶åŒºè®¡ç®—ï¼‰
class BaziCalculator {
  constructor() {
    this.HEAVENLY_STEMS  = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES= ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.ZODIAC          = ['é¼ ','ç‰›','è™','å…”','é¾™','è›‡','é©¬','ç¾Š','çŒ´','é¸¡','ç‹—','çŒª'];
    this.NAYIN = ['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }

  // å¹´æŸ±ï¼šæŒ‰å¹´ä»½æ¨
  calculateYearPillar(year) {
    const s = (year - 4) % 10, b = (year - 4) % 12;
    return { stem: this.HEAVENLY_STEMS[s], branch: this.EARTHLY_BRANCHES[b], zodiac: this.ZODIAC[b] };
  }

  // â€”â€” èŠ‚æ°”æœˆåºï¼ˆå¯…=1â€¦ä¸‘=12ï¼‰ï¼Œè¿‘ä¼¼é˜ˆå€¼è¶³å¤Ÿæ’æœˆæŸ±
  solarMonthIndex(y, m, d) {
    const mmdd = m*100 + d;
    const gates = [
      [106, 12], // å°å¯’å‰å½’ä¸Šå¹´è…Šæœˆ
      [204, 1],  [306, 2],  [405, 3],  [506, 4],  [606, 5],
      [707, 6],  [808, 7],  [908, 8],  [1008,9],  [1107,10], [1207,11]
    ];
    let idx = 11;
    for (const [thr,val] of gates) if (mmdd >= thr) idx = val;
    const branchBy = {1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
    return { index: idx, branch: branchBy[idx] };
  }

  // æœˆæŸ±ï¼šç”²/å·±å¹´ä¸™å¯…èµ·ï¼›ä¹™/åºšå¹´æˆŠå¯…èµ·ï¼›ä¸™/è¾›å¹´åºšå¯…èµ·ï¼›ä¸/å£¬å¹´å£¬å¯…èµ·ï¼›æˆŠ/ç™¸å¹´ç”²å¯…èµ·
  calculateMonthPillar(year, month, day) {
    const { index, branch } = this.solarMonthIndex(year, month, day);
    const yStemIdx = this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem);
    const startMap = {0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx  = (startMap[yStemIdx] + (index - 1)) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch };
  }

  // æ—¥æŸ±ï¼šä»¥ 1900-01-31 ä¸ºç”²åˆæ—¥ï¼›ç”¨ UTC è®¡ç®—å¹¶ +1 ä¿®æ­£å¸¸è§åç§»
  calculateDayPillar(year, month, day) {
    const baseUTC   = Date.UTC(1900, 0, 31);             // 1900-01-31
    const targetUTC = Date.UTC(year, month-1, day);
    const dayDiff   = Math.floor((targetUTC - baseUTC)/86400000) + 1; // â† +1 å¾ˆå…³é”®
    const stemIdx   = (0 + dayDiff) % 10;  // ç”²=0
    const branchIdx = (6 + dayDiff) % 12;  // åˆ=6
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10],
      branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12]
    };
  }

  // æ—¶æŸ±ï¼šå­æ—¶èµ·ï¼›ç”²æ—¥å­æ—¶èµ·ç”²ã€ä¹™æ—¥èµ·ä¸™â€¦ï¼ˆåå¤©å¹²é¡ºæ¨ï¼‰
  calculateHourPillar(dayStem, hour) {
    const branchMap = {23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
    const startMap  = {0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; // æ—¥å¹²â†’å­æ—¶èµ·å¹²
    const dayIdx    = this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex = Math.floor((hour + 1)/2) % 12;
    const stemIdx   = (startMap[dayIdx] + hourIndex) % 10;
    return { stem: this.HEAVENLY_STEMS[stemIdx], branch: branchMap[hour] };
  }

  getElement(stem, branch) {
    const s = {'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'};
    const b = {'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
    return `${s[stem]}${b[branch]}`;
  }

  getNayin(stem, branch) {
    const si = this.HEAVENLY_STEMS.indexOf(stem);
    const bi = this.EARTHLY_BRANCHES.indexOf(branch);
    return this.NAYIN[(si*2 + bi) % this.NAYIN.length];
  }

  analyzeElements(b) {
    const r = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
    for (const k of ['year','month','day','hour']) {
      const s = b[k].stem;  if (s!=='ï¼Ÿ') r[this.getElement(s,'å­')[0]]++;
      const z = b[k].branch;if (z!=='ï¼Ÿ') r[this.getElement('ç”²',z)[1]]++;
    }
    return r;
  }
}
const baziCalculator = new BaziCalculator();

// â€”â€” ç”ŸæˆæŒ‰é’®ï¼šåªç»‘å®šä¸€æ¬¡
document.addEventListener('DOMContentLoaded', () => {
  const genBtn = document.getElementById('genBtn');
  genBtn?.addEventListener('click', () => {
    const birthdate   = document.getElementById('birthdate').value;
    const birthtime   = document.getElementById('birthtime').value || '12:00';
    const timeUnknown = document.getElementById('timeUnknown').checked;
    if (!birthdate) return showError('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ');

    // UIï¼šloading
    document.getElementById('genBtnText').style.display = 'none';
    document.getElementById('genBtnLoading').style.display = 'inline-block';

    setTimeout(() => {
      try {
        const [y,m,d] = birthdate.split('-').map(n=>parseInt(n,10));
        let h = 12;
        if (!timeUnknown && birthtime) h = parseInt(birthtime.split(':')[0], 10);

        const yearP  = baziCalculator.calculateYearPillar(y);
        const monthP = baziCalculator.calculateMonthPillar(y, m, d); // â† å…³é”®ï¼šä¼  day
        const dayP   = baziCalculator.calculateDayPillar(y, m, d);
        const hourP  = timeUnknown ? {stem:'ï¼Ÿ',branch:'ï¼Ÿ'} : baziCalculator.calculateHourPillar(dayP.stem, h);

        const bazi = {year:yearP, month:monthP, day:dayP, hour:hourP};
        displayBaziResult(bazi, y, m, d, h, timeUnknown);

        // è‡ªæµ‹ï¼ˆä½ ä¹Ÿå¯åˆ æ‰ï¼‰
        console.log('å®é™… â†’', yearP.stem+yearP.branch, monthP.stem+monthP.branch, dayP.stem+dayP.branch, hourP.stem+hourP.branch);

      } catch(e) {
        console.error(e);
        showError('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
      } finally {
        document.getElementById('genBtnText').style.display = 'inline';
        document.getElementById('genBtnLoading').style.display = 'none';
      }
    }, 200);
  });
});

// â€”â€” ä»¥ä¸‹ä¿æŒä½ åŸæ¥çš„æ¸²æŸ“å‡½æ•°ï¼ˆç•¥å¾®æ•´ç†ï¼‰
function displayBaziResult(bazi, year, month, day, hour, timeUnknown) {
  document.getElementById('result').style.display = 'block';
  const pillars = [
    { title: 'å¹´æŸ±', stem: bazi.year.stem,  branch: bazi.year.branch },
    { title: 'æœˆæŸ±', stem: bazi.month.stem, branch: bazi.month.branch },
    { title: 'æ—¥æŸ±', stem: bazi.day.stem,   branch: bazi.day.branch },
    { title: 'æ—¶æŸ±', stem: bazi.hour.stem,  branch: bazi.hour.branch }
  ];
  const box = document.getElementById('bazi-pillars'); box.innerHTML = '';
  pillars.forEach(p => {
    const el = document.createElement('div');
    el.className = 'pillar';
    el.innerHTML = `<div class="tit">${p.title}</div><div class="gz">${p.stem}${p.branch}</div>`;
    box.appendChild(el);
  });

  // è¡¨æ ¼
  setText('year-stem', bazi.year.stem);   setText('year-branch',  bazi.year.branch);
  setText('month-stem',bazi.month.stem);  setText('month-branch', bazi.month.branch);
  setText('day-stem',  bazi.day.stem);    setText('day-branch',   bazi.day.branch);
  setText('hour-stem', bazi.hour.stem);   setText('hour-branch',  bazi.hour.branch);

  setText('year-element',  baziCalculator.getElement(bazi.year.stem,  bazi.year.branch));
  setText('month-element', baziCalculator.getElement(bazi.month.stem, bazi.month.branch));
  setText('day-element',   baziCalculator.getElement(bazi.day.stem,   bazi.day.branch));
  setText('hour-element',  bazi.hour.stem==='ï¼Ÿ' ? 'æœªçŸ¥' : baziCalculator.getElement(bazi.hour.stem, bazi.hour.branch));

  setText('year-nayin',  baziCalculator.getNayin(bazi.year.stem,  bazi.year.branch));
  setText('month-nayin', baziCalculator.getNayin(bazi.month.stem, bazi.month.branch));
  setText('day-nayin',   baziCalculator.getNayin(bazi.day.stem,   bazi.day.branch));
  setText('hour-nayin',  bazi.hour.stem==='ï¼Ÿ' ? 'æœªçŸ¥' : baziCalculator.getNayin(bazi.hour.stem, bazi.hour.branch));

  setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeUnknown ? 'æ—¶é—´ä¸è¯¦' : hour + 'æ—¶'}`);

  const elements = baziCalculator.analyzeElements(bazi);
  updateElementBars(elements);
  generateBaziAnalysis(bazi, elements, document.getElementById('name').value || 'æ‚¨');
  document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

function updateElementBars(elements) {
  const total = Object.values(elements).reduce((a,b)=>a+b,0)||1;
  for (const [k,c] of Object.entries(elements)) {
    const pct = (c/total)*100;
    const bar = document.getElementById(`bar-${k}`); const pctEl = document.getElementById(`pct-${k}`);
    if (bar) bar.style.width = `${pct}%`; if (pctEl) pctEl.textContent = `${pct.toFixed(1)}%`;
  }
  const keys = Object.keys(elements);
  const maxK = keys.reduce((a,b)=>elements[a]>elements[b]?a:b);
  const minK = keys.reduce((a,b)=>elements[a]<elements[b]?a:b);
  setText('bazi-elements-balance', `äº”è¡Œä¸­${maxK}å…ƒç´ æœ€å¼ºï¼Œ${minK}å…ƒç´ æœ€å¼±ã€‚`);
}

// â€”â€” ä¸‹é¢æ˜¯ä½ åŸæ¥çš„è§£è¯»å‡½æ•°ï¼ˆç•¥ï¼‰
function generateBaziAnalysis(bazi, elements, name){
  const dayStemNames = {'ç”²':'ç”²æœ¨','ä¹™':'ä¹™æœ¨','ä¸™':'ä¸™ç«','ä¸':'ä¸ç«','æˆŠ':'æˆŠåœŸ','å·±':'å·±åœŸ','åºš':'åºšé‡‘','è¾›':'è¾›é‡‘','å£¬':'å£¬æ°´','ç™¸':'ç™¸æ°´'};
  setHTML('day-pillar-analysis', `<p>${name}çš„æ—¥ä¸»ä¸º<strong>${dayStemNames[bazi.day.stem]}</strong>ï¼Œä»£è¡¨å‘½ä¸»çš„æœ¬æ€§å’Œæ ¸å¿ƒç‰¹è´¨ã€‚</p><p>æ—¥æŸ±${bazi.day.stem}${bazi.day.branch}ï¼Œçº³éŸ³${baziCalculator.getNayin(bazi.day.stem,bazi.day.branch)}ã€‚</p>`);
  setHTML('zodiac-analysis', `<p>${name}çš„ç”Ÿè‚–ä¸º<strong>${bazi.year.zodiac}</strong>ã€‚</p><p>å¹´æŸ±${bazi.year.stem}${bazi.year.branch}ï¼Œçº³éŸ³${baziCalculator.getNayin(bazi.year.stem,bazi.year.branch)}ã€‚</p>`);
  setHTML('career-analysis', `<p>æ ¹æ®äº”è¡Œåˆ†æï¼Œ${name}çš„å‘½å±€ä¸­${getStrongestElement(elements)}å…ƒç´ è¾ƒä¸ºçªå‡ºã€‚</p><p>é€‚åˆä»äº‹ä¸${getCareerAdvice(elements)}ç›¸å…³çš„è¡Œä¸šã€‚</p><p>è´¢è¿æ–¹é¢ï¼Œ${getWealthAdvice(bazi.day.stem)}</p>`);
  setHTML('relationship-analysis', `<p>${name}åœ¨äººé™…å…³ç³»æ–¹é¢${getRelationshipAdvice(bazi.day.stem)}</p><p>æ„Ÿæƒ…æ–¹é¢ï¼Œ${getLoveAdvice(bazi.day.stem, document.getElementById('gender').value)}</p>`);
}
function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML=html; }
function getStrongestElement(e){ return Object.keys(e).reduce((a,b)=>e[a]>e[b]?a:b); }
function getCareerAdvice(e){ const s=getStrongestElement(e); const m={'æœ¨':'æ•™è‚²ã€æ–‡åŒ–ã€è‰ºæœ¯ã€åŒ»ç–—','ç«':'ç§‘æŠ€ã€èƒ½æºã€é¤é¥®ã€å¨±ä¹','åœŸ':'æˆ¿åœ°äº§ã€å»ºç­‘ã€å†œä¸šã€é‡‘è','é‡‘':'é‡‘å±ã€æœºæ¢°ã€æ³•å¾‹ã€ç®¡ç†','æ°´':'è´¸æ˜“ã€è¿è¾“ã€æ—…æ¸¸ã€æœåŠ¡'}; return m[s]||'å¤šç§è¡Œä¸š'; }
function getWealthAdvice(s){ const m={'ç”²':'è´¢è¿ç¨³å®šï¼Œé€‚åˆé•¿æœŸæŠ•èµ„','ä¹™':'è´¢è¿èµ·ä¼ï¼Œéœ€è¦è°¨æ…ç†è´¢','ä¸™':'è´¢è¿æ—ºç››ï¼Œä½†éœ€é˜²ç ´è´¢','ä¸':'è´¢è¿å¹³ç¨³ï¼Œé€‚åˆç¨³å¥æŠ•èµ„','æˆŠ':'è´¢è¿ä¸°åšï¼Œä½†æ¥å¾—è¾ƒæ…¢','å·±':'è´¢è¿ç¨³å®šï¼Œé€‚åˆç§¯ç´¯','åºš':'è´¢è¿èµ·ä¼ï¼Œéœ€è¦æŠŠæ¡æ—¶æœº','è¾›':'è´¢è¿è‰¯å¥½ï¼Œé€‚åˆç²¾ç»†ç»è¥','å£¬':'è´¢è¿æµåŠ¨ï¼Œé€‚åˆçµæ´»æŠ•èµ„','ç™¸':'è´¢è¿éšç§˜ï¼Œéœ€è¦è€å¿ƒç­‰å¾…'}; return m[s]||'è´¢è¿å¹³ç¨³ï¼Œéœ€è¦åˆç†è§„åˆ’'; }
function getRelationshipAdvice(s){ const m={'ç”²':'æ€§æ ¼ç›´çˆ½ï¼Œäººé™…å…³ç³»è‰¯å¥½','ä¹™':'æ¸©å’Œä½“è´´ï¼Œäººç¼˜ä¸é”™','ä¸™':'çƒ­æƒ…å¼€æœ—ï¼Œäº¤å‹å¹¿æ³›','ä¸':'ç»†è…»æ•æ„Ÿï¼Œéœ€è¦æ›´å¤šä¿¡ä»»','æˆŠ':'ç¨³é‡å¯é ï¼Œæœ‹å‹å¿ è¯š','å·±':'åŒ…å®¹å¤§åº¦ï¼Œäººç¼˜å¾ˆå¥½','åºš':'åˆšå¼ºæœæ–­ï¼Œéœ€è¦æ›´å¤šæŸ”å’Œ','è¾›':'ç²¾æ˜ç»†è‡´ï¼Œäº¤å‹è°¨æ…','å£¬':'éšå’ŒåŒ…å®¹ï¼Œäººç¼˜å¹¿æ³›','ç™¸':'å†…å‘æ•æ„Ÿï¼Œéœ€è¦ä¸»åŠ¨ç¤¾äº¤'}; return m[s]||'äººé™…å…³ç³»å¹³ç¨³'; }
function getLoveAdvice(s, g){ const m={'ç”²':'æ„Ÿæƒ…ä¸“ä¸€ï¼Œé‡è§†å®¶åº­','ä¹™':'æ„Ÿæƒ…ç»†è…»ï¼Œéœ€è¦å®‰å…¨æ„Ÿ','ä¸™':'æ„Ÿæƒ…çƒ­çƒˆï¼Œè¿½æ±‚æµªæ¼«','ä¸':'æ„Ÿæƒ…æ·±æ²‰ï¼Œéœ€è¦ç†è§£','æˆŠ':'æ„Ÿæƒ…ç¨³å®šï¼Œé‡è§†è´£ä»»','å·±':'æ„Ÿæƒ…åŒ…å®¹ï¼Œå–„äºä»˜å‡º','åºš':'æ„Ÿæƒ…åˆšå¼ºï¼Œéœ€è¦æ¸©æŸ”','è¾›':'æ„Ÿæƒ…ç²¾è‡´ï¼Œè¿½æ±‚å®Œç¾','å£¬':'æ„Ÿæƒ…éšå’Œï¼Œé€‚åº”æ€§å¼º','ç™¸':'æ„Ÿæƒ…æ•æ„Ÿï¼Œéœ€è¦å‘µæŠ¤'}; let t=m[s]||'æ„Ÿæƒ…å¹³ç¨³'; if(g==='male') t+='ï¼Œä½œä¸ºç”·æ€§ï¼Œåœ¨æ„Ÿæƒ…ä¸­åº”ä¸»åŠ¨æ‰¿æ‹…è´£ä»»ã€‚'; if(g==='female') t+='ï¼Œä½œä¸ºå¥³æ€§ï¼Œåœ¨æ„Ÿæƒ…ä¸­ä¿æŒç‹¬ç«‹è‡ªä¿¡ã€‚'; return t; }

// å¿ƒæ€œç®¡å®¶ AI åŠŸèƒ½
class XinLianAssistant {
  constructor() {
    this.currentContext = null;
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('action-btn')) {
        const action = e.target.getAttribute('data-action');
        this.handleAction(action);
      }
    });
  }

  generateAnalysis(baziData) {
    this.currentContext = baziData;
    
    const analysis = this.analyzeBazi(baziData);
    const advice = this.generateAdvice(baziData);
    
    document.getElementById('assistant-analysis').innerHTML = analysis;
    document.getElementById('assistant-advice').innerHTML = advice;
  }

  analyzeBazi(baziData) {
    const { dayMaster, elements, strength, season, timeUnknown } = baziData;
    
    let timeNote = '';
    if (timeUnknown) {
      timeNote = '<li><strong>æ³¨æ„ï¼š</strong>ç”±äºå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æ— æ³•ç¡®å®šï¼Œæ­¤åˆ†æä»…åŸºäºå¹´æœˆæ—¥ä¸‰æŸ±</li>';
    }
    
    let analysis = `
      <ul class="ul">
        <li>æ‚¨çš„æ—¥ä¸»ä¸º <strong>${dayMaster.stem}ï¼ˆ${dayMaster.element}ï¼‰</strong></li>
        <li>å‘½å±€æ•´ä½“<strong>${strength.mark}</strong>ï¼Œ${this.getStrengthDescription(strength.mark)}</li>
        <li>å‡ºç”Ÿäº<strong>${season}</strong>å­£èŠ‚ï¼Œ${this.getSeasonInfluence(season, dayMaster.element)}</li>
        <li>äº”è¡Œåˆ†å¸ƒï¼š${this.getElementDistribution(elements)}</li>
        ${timeNote}
      </ul>
    `;
    
    return analysis;
  }

  generateAdvice(baziData) {
    const { strength, useful, timeUnknown } = baziData;
    
    let timeWarning = '';
    if (timeUnknown) {
      timeWarning = '<li><strong>é‡è¦æç¤ºï¼š</strong>ç”±äºç¼ºå°‘æ—¶æŸ±ä¿¡æ¯ï¼Œæ­¤åˆ†æä»…ä¾›å‚è€ƒã€‚å»ºè®®æä¾›å‡†ç¡®å‡ºç”Ÿæ—¶é—´ä»¥è·å¾—æ›´ç²¾å‡†çš„å‘½ç†åˆ†æã€‚</li>';
    }
    
    let advice = `
      <ul class="ul">
        <li><strong>å‘å±•ç­–ç•¥ï¼š</strong>${strength.focus}</li>
        <li><strong>å–œç”¨å…ƒç´ ï¼š</strong>${useful.useful.join('ã€')}</li>
        <li><strong>å¹¸è¿é¢œè‰²ï¼š</strong>${this.getLuckyColors(useful.useful)}</li>
        <li><strong>é€‚åˆæ–¹ä½ï¼š</strong>${this.getLuckyDirections(useful.useful)}</li>
        ${timeWarning}
      </ul>
    `;
    
    return advice;
  }

  handleAction(action) {
    if (!this.currentContext) return;
    
    let response = '';
    
    switch(action) {
      case 'career':
        response = this.getCareerAdvice();
        break;
      case 'wealth':
        response = this.getWealthAdvice();
        break;
      case 'relationship':
        response = this.getRelationshipAdvice();
        break;
      case 'health':
        response = this.getHealthAdvice();
        break;
      case 'lucky':
        response = this.getLuckyDirectionsAdvice();
        break;
    }
    
    this.showActionResponse(action, response);
  }

  getCareerAdvice() {
    const { dayMaster, strength, timeUnknown } = this.currentContext;
    const careers = {
      'æœ¨': ['æ•™è‚²è¡Œä¸š', 'åˆ›æ„è®¾è®¡', 'å‡ºç‰ˆä¼ åª’', 'ç¯ä¿äº§ä¸š'],
      'ç«': ['äº’è”ç½‘ç§‘æŠ€', 'å¸‚åœºè¥é”€', 'å¨±ä¹äº§ä¸š', 'é¤é¥®è¡Œä¸š'],
      'åœŸ': ['æˆ¿åœ°äº§', 'å»ºç­‘å·¥ç¨‹', 'é‡‘èæŠ•èµ„', 'ç®¡ç†å’¨è¯¢'],
      'é‡‘': ['æ³•å¾‹è¡Œä¸š', 'ç²¾å¯†åˆ¶é€ ', 'é‡‘èåˆ†æ', 'æŠ€æœ¯ç ”å‘'],
      'æ°´': ['ç‰©æµè¿è¾“', 'æ—…æ¸¸è¡Œä¸š', 'å¿ƒç†å’¨è¯¢', 'å›½é™…è´¸æ˜“']
    };
    
    const suitableCareers = careers[dayMaster.element] || ['å¤šå…ƒåŒ–å‘å±•'];
    const strengthText = strength.mark === 'åå¼º' ? 'é€‚åˆæŒ‘æˆ˜æ€§å·¥ä½œ' : 'é€‚åˆç¨³å®šæ€§å·¥ä½œ';
    const timeNote = timeUnknown ? 'ï¼ˆæ³¨ï¼šæ—¶æŸ±ä¿¡æ¯ç¼ºå¤±ï¼Œå»ºè®®ä»…ä¾›å‚è€ƒï¼‰' : '';
    
    return `åŸºäºæ‚¨çš„${dayMaster.element}å±æ€§æ—¥ä¸»ï¼Œ${strengthText}ã€‚æ¨èèŒä¸šæ–¹å‘ï¼š${suitableCareers.join('ã€')}ã€‚${timeNote}`;
  }

  getWealthAdvice() {
    const { elements, useful, timeUnknown } = this.currentContext;
    const strongElement = this.getStrongestElement(elements);
    const weakElement = this.getWeakestElement(elements);
    const timeNote = timeUnknown ? ' ç”±äºæ—¶æŸ±ä¿¡æ¯ä¸å®Œæ•´ï¼Œè´¢è¿åˆ†æå¯èƒ½ä¸å¤Ÿç²¾ç¡®ã€‚' : '';
    
    return `æ‚¨çš„è´¢è¿${strongElement === 'é‡‘' || strongElement === 'åœŸ' ? 'è¾ƒä½³' : 'éœ€åŠªåŠ›'}ã€‚å»ºè®®åŠ å¼º${useful.useful.join('ã€')}å…ƒç´ çš„è¿ç”¨ï¼Œé¿å…${weakElement}ç›¸å…³çš„é«˜é£é™©æŠ•èµ„ã€‚${timeNote}`;
  }

  getRelationshipAdvice() {
    const { dayMaster, elements, timeUnknown } = this.currentContext;
    const compatibleElements = this.getCompatibleElements(dayMaster.element);
    const timeNote = timeUnknown ? ' æ—¶æŸ±ä¿¡æ¯ç¼ºå¤±å¯èƒ½å½±å“æ„Ÿæƒ…åˆ†æçš„å‡†ç¡®æ€§ã€‚' : '';
    
    return `æ„Ÿæƒ…æ–¹é¢ï¼Œæ‚¨ä¸${compatibleElements.join('ã€')}å±æ€§çš„äººè¾ƒä¸ºæŠ•ç¼˜ã€‚å»ºè®®å¤šå‚ä¸ç¤¾äº¤æ´»åŠ¨ï¼Œæ‰©å¤§äº¤é™…åœˆã€‚${timeNote}`;
  }

  getHealthAdvice() {
    const { elements, timeUnknown } = this.currentContext;
    const weakElement = this.getWeakestElement(elements);
    const healthMap = {
      'æœ¨': 'è‚èƒ†ã€çœ¼ç›',
      'ç«': 'å¿ƒè„ã€è¡€æ¶²å¾ªç¯',
      'åœŸ': 'è„¾èƒƒã€æ¶ˆåŒ–ç³»ç»Ÿ',
      'é‡‘': 'è‚ºã€å‘¼å¸ç³»ç»Ÿ',
      'æ°´': 'è‚¾ã€æ³Œå°¿ç³»ç»Ÿ'
    };
    const timeNote = timeUnknown ? ' å¥åº·åˆ†æåŸºäºç°æœ‰ä¿¡æ¯ï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µã€‚' : '';
    
    return `å¥åº·æ–¹é¢éœ€ç‰¹åˆ«æ³¨æ„${healthMap[weakElement]}çš„ä¿å…»ã€‚å»ºè®®å®šæœŸä½“æ£€ï¼Œä¿æŒè§„å¾‹ä½œæ¯ã€‚${timeNote}`;
  }

  getLuckyDirectionsAdvice() {
    const { useful, timeUnknown } = this.currentContext;
    const directionMap = {
      'æœ¨': 'ä¸œæ–¹',
      'ç«': 'å—æ–¹',
      'åœŸ': 'ä¸­å¤®ã€ä¸œåŒ—ã€è¥¿å—',
      'é‡‘': 'è¥¿æ–¹',
      'æ°´': 'åŒ—æ–¹'
    };
    
    const directions = useful.useful.map(el => directionMap[el]).filter(Boolean);
    const timeNote = timeUnknown ? ' æ–¹ä½å»ºè®®åŸºäºç°æœ‰ä¿¡æ¯ã€‚' : '';
    
    return `æ‚¨çš„å¹¸è¿æ–¹ä½æ˜¯ï¼š${directions.join('ã€')}ã€‚åœ¨è¿™äº›æ–¹å‘å·¥ä½œã€ç”Ÿæ´»æˆ–æ—…è¡Œä¼šå¸¦æ¥å¥½è¿ã€‚${timeNote}`;
  }

  showActionResponse(action, response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'assistant-message';
    messageDiv.innerHTML = `
      <p><strong>${this.getActionTitle(action)}ï¼š</strong>${response}</p>
      <p class="muted" style="margin-top: 10px; font-size: 0.9em;">
        ğŸ’¡ æƒ³è¦æ›´ç²¾å‡†çš„æŒ‡å¯¼ï¼Ÿ<a href="#" style="color: var(--gold2);">å‡çº§VIPè·å–ä¸“å±åˆ†æ</a>
      </p>
    `;
    
    document.querySelector('.assistant-container').insertBefore(messageDiv, document.querySelector('.vip-promo'));
    messageDiv.scrollIntoView({ behavior: 'smooth' });
  }

  // è¾…åŠ©æ–¹æ³•
  getStrengthDescription(strength) {
    const descriptions = {
      'åå¼º': 'å…·æœ‰è¾ƒå¥½çš„å‘å±•æ½œåŠ›å’ŒæŠ—å‹èƒ½åŠ›',
      'åå¼±': 'éœ€è¦æ›´å¤šçš„æ”¯æŒå’Œå¸®åŠ©æ‰èƒ½å‘æŒ¥æ½œåŠ›',
      'å¹³è¡¡': 'å„æ–¹é¢å‘å±•è¾ƒä¸ºå‡è¡¡ï¼Œé€‚åº”æ€§å¼º'
    };
    return descriptions[strength] || 'å…·æœ‰ç‹¬ç‰¹çš„å‘å±•ç‰¹ç‚¹';
  }

  getSeasonInfluence(season, element) {
    const influences = {
      'æ˜¥': 'æœ¨æ°”æ—ºç››ï¼Œç”Ÿæœºå‹ƒå‹ƒ',
      'å¤': 'ç«æ°”æ—ºç››ï¼Œçƒ­æƒ…æ´‹æº¢',
      'ç§‹': 'é‡‘æ°”æ—ºç››ï¼Œæ”¶è·æ—¶èŠ‚',
      'å†¬': 'æ°´æ°”æ—ºç››ï¼Œå†…æ•›æ²‰é™'
    };
    return influences[season] || 'å­£èŠ‚ç‰¹ç‚¹å¯¹å‘½å±€æœ‰ä¸€å®šå½±å“';
  }

  getElementDistribution(elements) {
    const sorted = Object.entries(elements)
      .sort((a, b) => b[1] - a[1])
      .map(([el, val]) => `${el}${Math.round(val)}%`)
      .join('ã€');
    return sorted;
  }

  getLuckyColors(elements) {
    const colorMap = {
      'æœ¨': 'ç»¿è‰²ã€é’è‰²',
      'ç«': 'çº¢è‰²ã€ç´«è‰²',
      'åœŸ': 'é»„è‰²ã€æ£•è‰²',
      'é‡‘': 'ç™½è‰²ã€é‡‘è‰²',
      'æ°´': 'é»‘è‰²ã€è“è‰²'
    };
    return elements.map(el => colorMap[el]).join('ã€');
  }

  getLuckyDirections(elements) {
    const directionMap = {
      'æœ¨': 'ä¸œæ–¹',
      'ç«': 'å—æ–¹',
      'åœŸ': 'ä¸­å¤®',
      'é‡‘': 'è¥¿æ–¹',
      'æ°´': 'åŒ—æ–¹'
    };
    return elements.map(el => directionMap[el]).join('ã€');
  }

  getStrongestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] > b[1] ? a : b)[0];
  }

  getWeakestElement(elements) {
    return Object.entries(elements).reduce((a, b) => a[1] < b[1] ? a : b)[0];
  }

  getCompatibleElements(element) {
    const compatibility = {
      'æœ¨': ['ç«', 'æ°´'],
      'ç«': ['æœ¨', 'åœŸ'],
      'åœŸ': ['ç«', 'é‡‘'],
      'é‡‘': ['åœŸ', 'æ°´'],
      'æ°´': ['é‡‘', 'æœ¨']
    };
    return compatibility[element] || ['å¤šæ ·åŒ–'];
  }

  getActionTitle(action) {
    const titles = {
      'career': 'äº‹ä¸šå»ºè®®',
      'wealth': 'è´¢è¿åˆ†æ',
      'relationship': 'æ„Ÿæƒ…æŒ‡å¯¼',
      'health': 'å¥åº·æé†’',
      'lucky': 'å¹¸è¿æ–¹å‘'
    };
    return titles[action] || 'ä¸“ä¸šå»ºè®®';
  }
}

// åˆå§‹åŒ–
const baziCalculator = new BaziCalculator();
const assistant = new XinLianAssistant();

// å·¥å…·å‡½æ•°
function $(id) { return document.getElementById(id); }
function setBar(el, pct) { if(el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
function el(tag, attrs = {}, html = "") { 
  const d = document.createElement(tag); 
  Object.entries(attrs).forEach(([k, v]) => d.setAttribute(k, v)); 
  d.innerHTML = html; 
  return d; 
}

// äº”è¡Œåˆ†æ
function countElements(pillars, timeUnknown = false) {
  const cnt = {æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0};
  const STEM_ELEM = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const BRANCH_ELEM = {å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
  
  // åªè®¡ç®—å¹´æœˆæ—¥ä¸‰æŸ±
  const pillarsToCount = timeUnknown ? 
    [pillars.year, pillars.month, pillars.day] : 
    [pillars.year, pillars.month, pillars.day, pillars.hour];
  
  pillarsToCount.forEach(pillar => {
    if(pillar.stem && STEM_ELEM[pillar.stem] && pillar.stem !== 'ï¼Ÿ') 
      cnt[STEM_ELEM[pillar.stem]] += 1;
    if(pillar.branch && BRANCH_ELEM[pillar.branch] && pillar.branch !== 'ï¼Ÿ') 
      cnt[BRANCH_ELEM[pillar.branch]] += 1;
  });
  
  const total = Object.values(cnt).reduce((a, b) => a + b, 0) || 1;
  return {
    cnt, 
    pct: {
      wood: cnt['æœ¨'] / total * 100,
      fire: cnt['ç«'] / total * 100,
      earth: cnt['åœŸ'] / total * 100,
      metal: cnt['é‡‘'] / total * 100,
      water: cnt['æ°´'] / total * 100
    }
  };
}

// åˆ¤æ–­å‘½å±€å¼ºå¼±
function judgeStrength(dayGan, monthZhi, cnt) {
  const STEM_ELEM = {ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH = {å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  
  const dmEl = STEM_ELEM[dayGan];
  const season = SEASON_BY_MONTH_BRANCH[monthZhi] || '-';
  
  let score = 0;
  if((season === 'æ˜¥' && 'æœ¨ç«'.includes(dmEl)) || (season === 'å¤' && 'ç«åœŸ'.includes(dmEl)) || 
     (season === 'ç§‹' && dmEl === 'é‡‘') || (season === 'å†¬' && dmEl === 'æ°´')) score += 2;
  
  score += (cnt[dmEl] || 0) * 1.2;
  
  const mark = score >= 3 ? 'åå¼º' : (score <= 1 ? 'åå¼±' : 'å¹³è¡¡');
  const focus = mark === 'åå¼º' ? 'æ³„ç§€/åˆ¶åŒ–' : (mark === 'åå¼±' ? 'è¡¥åŠ©/é¡ºåŠ¿' : 'å®ˆä¸­/è°ƒå’Œ');
  
  return {season, mark, focus};
}

// é€‰æ‹©å–œç”¨ç¥
function chooseUseful(strength, dmElem) {
  if (strength === 'åå¼º') {
    const useful = ({æœ¨:['ç«','åœŸ','é‡‘'], ç«:['åœŸ','é‡‘','æ°´'], åœŸ:['é‡‘','æ°´','æœ¨'], é‡‘:['æ°´','æœ¨','ç«'], æ°´:['æœ¨','ç«','åœŸ']})[dmElem];
    return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful, avoid:[dmElem]};
  } else if (strength === 'åå¼±') {
    const helper = ({æœ¨:['æœ¨','æ°´'], ç«:['ç«','æœ¨'], åœŸ:['åœŸ','ç«'], é‡‘:['é‡‘','åœŸ'], æ°´:['æ°´','é‡‘']})[dmElem];
    return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:helper, avoid:[]};
  }
  return {strategy:'å®ˆä¸­/è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}

// æ¸²æŸ“å››æŸ±
function renderPillars(root, p, timeUnknown = false) {
  root.innerHTML = '';
  [['å¹´æŸ±', p.year], ['æœˆæŸ±', p.month], ['æ—¥æŸ±', p.day], ['æ—¶æŸ±', p.hour]].forEach(([tit, v]) => {
    const isUnknown = (tit === 'æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;
    
    const div = el('div', {class: 'pillar'}, `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
    `);
    root.appendChild(div);
  });
}

// ç”Ÿæˆå…«å­—
async function genChart() {
  const err = $('error');
  err.style.display = 'none';
  err.textContent = '';
  
  const birth = ($('birthdate').value || '').trim();
  const timeUnknown = $('timeUnknown').checked;
  
  if(!birth) {
    err.textContent = 'è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸã€‚';
    err.style.display = 'block';
    return;
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  $('genBtnText').style.display = 'none';
  $('genBtnLoading').style.display = 'inline-block';
  $('genBtn').disabled = true;

  try {
    const [Y, M, D] = birth.split('-').map(Number);
    let hour = 12; // é»˜è®¤ä¸­åˆ12ç‚¹
    
    if (!timeUnknown) {
      const time = ($('birthtime').value || '').trim();
      if (time) {
        const [hh, mm] = time.split(':').map(Number);
        hour = hh;
      }
    }
    
    // ä½¿ç”¨ä¿®å¤çš„è®¡ç®—å™¨
    const pillars = baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);
    
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    $('result').style.display = 'block';
    
    let timeDisplay = timeUnknown ? 'æ—¶é—´ä¸è¯¦ï¼ˆä½¿ç”¨é»˜è®¤æ—¶é—´è®¡ç®—æ—¥æŸ±ï¼‰' : $('birthtime').value;
    $('bazi-date').textContent = `ç”¨äºè®¡ç®—ï¼ˆUTC+8ï¼Œé˜³å†ï¼‰ï¼š${birth} ${timeDisplay}`;
    
    // æ¸²æŸ“å››æŸ±
    renderPillars($('bazi-pillars'), pillars, timeUnknown);
    $('bazi-day-master').textContent = `æ—¥ä¸»ï¼š${pillars.day.stem}ï¼ˆ${pillars.day.element}ï¼‰`;
    
    // æ—¶é—´ä¸è¯¦æç¤º
    if (timeUnknown) {
      $('bazi-time-note').textContent = 'âš ï¸ æ³¨æ„ï¼šå‡ºç”Ÿæ—¶é—´ä¸è¯¦ï¼Œæ—¶æŸ±æ— æ³•ç¡®å®šã€‚æ­¤åˆ†æä»…åŸºäºå¹´æœˆæ—¥ä¸‰æŸ±ï¼Œå‡†ç¡®æ€§æœ‰é™ã€‚';
    } else {
      $('bazi-time-note').textContent = '';
    }
    
    // äº”è¡Œåˆ†æ
    const {cnt, pct} = countElements(pillars, timeUnknown);
    setBar($('bar-wood'), pct.wood);
    setBar($('bar-fire'), pct.fire);
    setBar($('bar-earth'), pct.earth);
    setBar($('bar-metal'), pct.metal);
    setBar($('bar-water'), pct.water);
    
    // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
    $('pct-wood').textContent = Math.round(pct.wood) + '%';
    $('pct-fire').textContent = Math.round(pct.fire) + '%';
    $('pct-earth').textContent = Math.round(pct.earth) + '%';
    $('pct-metal').textContent = Math.round(pct.metal) + '%';
    $('pct-water').textContent = Math.round(pct.water) + '%';
    
    $('bazi-elements-balance').textContent = `äº”è¡Œå æ¯”ï¼šæœ¨${Math.round(pct.wood)}% ç«${Math.round(pct.fire)}% åœŸ${Math.round(pct.earth)}% é‡‘${Math.round(pct.metal)}% æ°´${Math.round(pct.water)}%`;
    
    // å‘½å±€åˆ†æ
    const st = judgeStrength(pillars.day.stem, pillars.month.branch, cnt);
    const adv = chooseUseful(st.mark, pillars.day.element);
    
    $('bazi-strengths').textContent = `å‘½å±€${st.mark}ï¼Œå»ºè®®ç­–ç•¥ï¼š${st.focus}`;
    
    // è°ƒç”¨AIåŠ©æ‰‹
    const baziData = {
      dayMaster: pillars.day,
      elements: {
        wood: pct.wood,
        fire: pct.fire,
        earth: pct.earth,
        metal: pct.metal,
        water: pct.water
      },
      strength: st,
      season: st.season,
      useful: adv,
      timeUnknown: timeUnknown
    };
    
    assistant.generateAnalysis(baziData);  
  
// â€”â€” å…¬å…±ï¼šé”™è¯¯æç¤º
function showError(msg){
  const el=document.getElementById('error'); if(!el) return;
  el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},5000);
}
</script>
</body>
</html>
