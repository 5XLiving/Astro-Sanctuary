<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>八字命理 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#9aa3b2;--brand:#d4af37;--gold:#d4af37;--gold2:#f2d27a;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.35)}
html,body{height:100%}
body{margin:0;color:var(--text);background:#0b0f14;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC",Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 结果样式 */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
.pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:10px;text-align:center}
.pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
.pillar .gz{font-size:1.3rem;font-weight:700;letter-spacing:.05em}
.bars{display:grid;gap:8px;margin-top:10px}
.bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden}
.bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a)}
.ul{margin:.4rem 0 0 .9rem;line-height:1.8}

/* Chat（保留可用，但不影响排盘） */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:95%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div>
        <div class="title">命理供门 · 八字简评</div>
        <div class="muted">免费版 · 全面不深｜VIP 解锁流年/大运/择日/命名</div>
      </div>
    </div>
    <div class="lang">
      <label for="langSelect">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div class="h2">八字命理 · 快速排盘</div>
    <div class="row cols-3">
      <div>
        <label class="muted">姓名（可选）</label>
        <input id="name" placeholder="你的称呼（用于个性化）">
      </div>
      <div>
        <label class="muted">性别</label>
        <select id="gender">
          <option value="">不透露</option>
          <option value="male">男性</option>
          <option value="female">女性</option>
          <option value="other">其他</option>
        </select>
      </div>

      <!-- 历法 + 闰月（唯一的 calendarHint） -->
      <div>
        <label class="muted">历法</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="calendar">
            <option value="gregorian">阳历 / Gregorian</option>
            <option value="lunar">农历 / Lunar</option>
          </select>
          <label id="leapWrap" style="display:none; align-items:center; gap:6px; margin-left:8px;">
            <input type="checkbox" id="isLeap"> 闰月
          </label>
        </div>
        <div id="calendarHint" class="muted" style="display:none; margin-top:6px;">
          选择农历时，请确认是否为闰月；若为闰月请勾选“闰月”。系统会自动换算为阳历后计算。
        </div>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted">出生时间</label>
        <input type="time" id="birthtime">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn" id="genBtn">生成八字</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">提示：临时默认东八区（UTC+8）。后续将支持按出生地换算。</div>
    <div class="muted" id="error" style="color:#ffb4b4;display:none"></div>
  </section>

  <section id="result" style="display:none;">
    <div class="card section">
      <div class="h2">八字命理排盘</div>
      <div class="pillars" id="bazi-pillars"></div>
      <div class="muted" id="bazi-date"></div>
      <div class="muted" id="bazi-day-master"></div>
    </div>

    <div class="card section">
      <div class="h2">五行分析</div>
      <div class="bars">
        <div class="bar"><i id="bar-wood"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-fire"  style="width:0%"></i></div>
        <div class="bar"><i id="bar-earth" style="width:0%"></i></div>
        <div class="bar"><i id="bar-metal" style="width:0%"></i></div>
        <div class="bar"><i id="bar-water" style="width:0%"></i></div>
      </div>
      <div class="muted" id="bazi-elements-balance" style="margin-top:8px"></div>
      <div class="muted" id="bazi-strengths" style="margin-top:6px"></div>
    </div>

    <div class="card section">
      <div class="h2">命格简评</div>
      <div class="desc" id="bazi-advice" style="white-space:pre-wrap;line-height:1.7"></div>
      <ul class="ul" id="fate-points"></ul>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗（可留可删） -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" placeholder="问点什么吧…"/>
    <button id="ssChatSend">发送</button>
  </div>
</div>
  
<!-- 只需要这个库：本地 + 多CDN 回退 -->
<script>
/* ========== 轻量工具 ========== */
const $ = id => document.getElementById(id);

/* ========== 五行/十神基础 ========== */
const STEMS = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const BRANCHES = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const STEM_ELEM = {甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const BRANCH_ELEM = {子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const SEASON_BY_MONTH_BRANCH = {
  寅:'春', 卯:'春', 辰:'春',
  巳:'夏', 午:'夏', 未:'夏',
  申:'秋', 酉:'秋', 戌:'秋',
  亥:'冬', 子:'冬', 丑:'冬'
};
const DM_TEN_GODS = (()=> {
  // 十神矩阵：按“日主五行”相对他干五行 → 十神
  // 同我=比肩/劫财；我生=食神/伤官；我克=偏财/正财；克我=七杀/正官；生我=偏印/正印（阴阳配合）
  const order = ['木','火','土','金','水'];        // 相生循环：木→火→土→金→水→木
  const yang = {甲:1,丙:1,戊:1,庚:1,壬:1};         // 阳干
  function idx(el){ return order.indexOf(el); }
  function rel(dmEl, otherEl){
    const i=idx(dmEl), j=idx(otherEl);
    if(i===j) return 'same';                         // 同我
    if((i+1)%5===j) return 'output';                 // 我生
    if((i+2)%5===j) return 'overcome';               // 我克
    if((i+3)%5===j) return 'be_overcome';            // 克我
    if((i+4)%5===j) return 'input';                  // 生我
    return 'other';
  }
  function tenGod(dmStem, otherStem){
    const dmEl = STEM_ELEM[dmStem], oEl = STEM_ELEM[otherStem];
    const dmYang = !!yang[dmStem], oYang = !!yang[otherStem];
    const r = rel(dmEl, oEl);
    const yinSame = (dmYang===oYang); // 阴阳同/异决定正偏
    if(r==='same')       return yinSame?'比肩':'劫财';
    if(r==='output')     return yinSame?'食神':'伤官';
    if(r==='overcome')   return yinSame?'偏财':'正财';
    if(r==='be_overcome')return yinSame?'七杀':'正官';
    if(r==='input')      return yinSame?'偏印':'正印';
    return '';
  }
  return tenGod;
})();

/* ========== 组件加载（简洁版） ========== */
async function loadScript(src, timeout=12000){
  if ([...document.scripts].some(s => (s.src||'').includes(src))) return;
  await new Promise((res, rej)=>{
    const s=document.createElement('script');
    s.src=src; s.async=true; s.crossOrigin='anonymous';
    const t=setTimeout(()=>rej(new Error('timeout '+src)), timeout);
    s.onload=()=>{clearTimeout(t);res();};
    s.onerror=()=>{clearTimeout(t);rej(new Error('load failed '+src));};
    document.head.appendChild(s);
  });
}
async function ensureLunarJS(){
  if (window.Solar && window.Lunar) return true;
  try{
    await loadScript('https://unpkg.zhimg.com/lunar-javascript@1.6.15/lunar.min.js', 15000);
  }catch{}
  if(!(window.Solar && window.Lunar)){
    await loadScript('https://fastly.jsdelivr.net/npm/lunar-javascript@1.6.15/lunar.min.js', 15000);
  }
  if(window.lunar && window.lunar.Solar && window.lunar.Lunar){
    window.Solar = window.lunar.Solar; window.Lunar = window.lunar.Lunar;
  }
  if(!(window.Solar && window.Lunar)) throw new Error('命理计算组件加载失败。');
}

/* ========== 输入规范化 ========== */
function normalizeDate(str){
  if(!str) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  const m=str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){ const [_, d, mo, y] = m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
  return str;
}
function normalizeTimeTo24h(t){
  if(!t) return '00:00';
  const s=t.trim().toLowerCase().replace(/\s+/g,'');
  const m=s.match(/^(\d{1,2})(?::?(\d{2}))?(am|pm)?$/);
  if(!m) return t;
  let hh=parseInt(m[1],10), mm=parseInt(m[2]||'0',10), ap=m[3];
  if(ap==='am'){ if(hh===12) hh=0; } else if(ap==='pm'){ if(hh!==12) hh+=12; }
  return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
}

/* ========== 计算与渲染 ========== */
function setBar(el, pct){ if(el) el.style.width = Math.max(0,Math.min(100,pct))+'%'; }
function renderPillars(root,p){
  root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const div=document.createElement('div');
    div.className='pillar';
    div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${(v&&v.gz)||'--'}</div>`;
    root.appendChild(div);
  });
}
function countElementsFromGZ(gzList){
  const cnt={木:0,火:0,土:0,金:0,水:0};
  gzList.forEach(gz=>{
    if(!gz) return;
    const gan=gz[0], zhi=gz[1];
    const e1=STEM_ELEM[gan], e2=BRANCH_ELEM[zhi];
    if(e1) cnt[e1]+=1;
    if(e2) cnt[e2]+=1;
  });
  const total = Object.values(cnt).reduce((a,b)=>a+b,0)||1;
  const pct = {wood:cnt['木']/total*100, fire:cnt['火']/total*100, earth:cnt['土']/total*100, metal:cnt['金']/total*100, water:cnt['水']/total*100};
  return {cnt, pct};
}
function judgeStrength(dayStem, monthBranch, elemCnt){
  // 简化判断：月令为主，同气(同五行)与生我为助力；克我为压力。输出 “偏强/平衡/偏弱”
  const dmEl = STEM_ELEM[dayStem];
  const season = SEASON_BY_MONTH_BRANCH[monthBranch];
  const favorBySeason = {
    春:'木火', 夏:'火土', 秋:'金', 冬:'水', // 夏湿土亦旺
  }[season] || '';
  let score = 0;
  // 月令偏好
  if(favorBySeason.includes(dmEl)) score += 2;
  // 同我、印星加分；财官减分（粗略）
  const same = elemCnt[dmEl]||0;
  const genEl = {木:'水',火:'木',土:'火',金:'土',水:'金'}[dmEl];   // 生我
  const drainEl = {木:'火',火:'土',土:'金',金:'水',水:'木'}[dmEl]; // 我生
  const overcomeEl = {木:'土',火:'金',土:'水',金:'木',水:'火'}[dmEl]; // 我克
  const beOverEl = {木:'金',火:'水',土:'木',金:'火',水:'土'}[dmEl]; // 克我
  score += (elemCnt[genEl]||0)*1.5 + (same)*1.2;
  score -= (elemCnt[beOverEl]||0)*1.5 + (elemCnt[overcomeEl]||0)*0.8;
  // 结论
  const mark = score>=4 ? '偏强' : (score<=1 ? '偏弱':'平衡');
  const focus = mark==='偏强' ? '泄秀/制化' : (mark==='偏弱' ? '补助/顺势' : '守中/调和');
  return {season, mark, focus};
}
function tenGodSummary(dayStem, pillars){
  const tg = {
    year: DM_TEN_GODS(dayStem, pillars.year.gan),
    month:DM_TEN_GODS(dayStem, pillars.month.gan),
    day:  '日主',
    hour: DM_TEN_GODS(dayStem, pillars.hour.gan)
  };
  const cnt={比肩:0,劫财:0,食神:0,伤官:0,偏财:0,正财:0,七杀:0,正官:0,偏印:0,正印:0};
  ['year','month','hour'].forEach(k=>{ const v=tg[k]; if(v && cnt[v]!=null) cnt[v]++; });
  const top = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).filter(([,n])=>n>0).slice(0,3).map(([k,n])=>`${k}×${n}`);
  return {tg, cnt, top};
}
function elemAdvice(elemPct, dm){
  const arr=[['木',elemPct.wood],['火',elemPct.fire],['土',elemPct.earth],['金',elemPct.metal],['水',elemPct.water]];
  const hi=arr.slice().sort((a,b)=>b[1]-a[1])[0][0];
  const lo=arr.slice().sort((a,b)=>a[1]-b[1])[0][0];
  const idea = {
    木:'成长/内容/教育/园林/供给链上游',
    火:'传播/品牌/销售/餐饮/能源/文娱',
    土:'项目/运营/服务/中台/基建/地产',
    金:'标准/制造/金融/工具/法务/风控',
    水:'信息/数据/出行/物流/国际/智库'
  };
  return {
    hi, lo,
    summary:`偏${hi}、${lo}偏弱。强项侧重「${idea[hi]}」，弱项宜引入外部/流程化；以日主「${dm.stem}（${dm.elem}）」为锚，先顺势再补位。`
  };
}

/* ========== VIP 七专题生成（可接付费逻辑） ========== */
function buildVipCards(root, data, isVip=false){
  const items = [
    ['姻缘方向','恋爱缘分、婚姻走势', data.v_love],
    ['事业方向','职场发展、创业潜力', data.v_career],
    ['财运方向','财位分析、理财时机', data.v_wealth],
    ['宠物命理','伴侣动物的性格与缘分', data.v_pet],
    ['合盘分析','婚期择日、新生择时', data.v_match],
    ['测名分析','公司名、宝宝名、命名改运', data.v_name],
    ['财位合盘','住家 / 办公室动线配合', data.v_fengshui],
  ];
  const wrap = document.createElement('section');
  wrap.className='card section';
  wrap.innerHTML = `<div class="h2">VIP 命理空间</div><div id="vip-grid" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));"></div>`;
  const grid = wrap.querySelector('#vip-grid');
  items.forEach(([title, sub, content])=>{
    const el=document.createElement('div');
    el.style.cssText='background:#0f1624;border:1px solid #253245;border-radius:12px;padding:12px;';
    if(isVip){
      el.innerHTML = `<div style="font-weight:700;margin-bottom:4px">${title}</div>
      <div class="muted" style="margin-bottom:6px">${sub}</div>
      <div style="white-space:pre-wrap;line-height:1.7">${content}</div>`;
    }else{
      el.innerHTML = `<div style="font-weight:700;margin-bottom:4px">${title}</div>
      <div class="muted" style="margin-bottom:6px">${sub}</div>
      <div class="muted">试读：${content.split('；')[0]}。<br/>…</div>`;
    }
    grid.appendChild(el);
  });
  root.appendChild(wrap);
}

/* ========== 主流程绑定 ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  const genBtn = $('genBtn'), calendarSel = $('calendar');
  const bars={wood:$('bar-wood'),fire:$('bar-fire'),earth:$('bar-earth'),metal:$('bar-metal'),water:$('bar-water')};
  const result = $('result');

  genBtn.addEventListener('click', async ()=>{
    const err=$('error'); err.style.display='none'; err.textContent='';
    const rawDate = ($('birthdate').value||'').trim();
    const rawTime = ($('birthtime').value||'').trim();
    if(!rawDate || !rawTime){ err.textContent='请完善出生日期与时间。'; err.style.display='block'; return; }

    try{
      await ensureLunarJS();
      const time24 = normalizeTimeTo24h(rawTime);
      const [Y,M,D] = normalizeDate(rawDate).split('-').map(Number);
      const [hh,mm] = time24.split(':').map(Number);

      // 计算四柱
      const solar = Solar.fromYmdHms(Y,M,D,hh,mm||0,0);
      const lunar = solar.getLunar();
      const ec = lunar.getEightChar();

      const gzYear = ec.getYear(), gzMonth = ec.getMonth(), gzDay = ec.getDay(), gzHour = ec.getTime();
      const dayGan = ec.getDayGan(), dayZhi = ec.getDayZhi();

      // 渲染基础
      result.style.display='block';
      $('bazi-date').textContent = `用于计算（UTC+8，阳历）：${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')} ${time24}`;
      renderPillars($('bazi-pillars'), {
        year:{gz:gzYear, gan:gzYear[0], zhi:gzYear[1]},
        month:{gz:gzMonth,gan:gzMonth[0],zhi:gzMonth[1]},
        day:{gz:gzDay,gan:gzDay[0],zhi:gzDay[1]},
        hour:{gz:gzHour,gan:gzHour[0],zhi:gzHour[1]}
      });

      const dmElem = STEM_ELEM[dayGan];
      $('bazi-day-master').textContent = `日主：${dayGan}（${dmElem}）`;

      // 五行占比
      const pillars = {
        year:{gz:gzYear, gan:gzYear[0], zhi:gzYear[1]},
        month:{gz:gzMonth,gan:gzMonth[0],zhi:gzMonth[1]},
        day:{gz:gzDay,gan:gzDay[0],zhi:gzDay[1]},
        hour:{gz:gzHour,gan:gzHour[0],zhi:gzHour[1]}
      };
      const {cnt, pct} = countElementsFromGZ([gzYear,gzMonth,gzDay,gzHour]);
      setBar(bars.wood, pct.wood); setBar(bars.fire, pct.fire); setBar(bars.earth, pct.earth); setBar(bars.metal, pct.metal); setBar(bars.water, pct.water);
      $('bazi-elements-balance').textContent =
        `五行占比：木${Math.round(pct.wood)} 火${Math.round(pct.fire)} 土${Math.round(pct.earth)} 金${Math.round(pct.metal)} 水${Math.round(pct.water)}`;

      // 日主强弱 & 用神方向
      const season = SEASON_BY_MONTH_BRANCH[pillars.month.zhi];
      const strength = judgeStrength(dayGan, pillars.month.zhi, cnt);
      const elemAdv = elemAdvice({wood:pct.wood,fire:pct.fire,earth:pct.earth,metal:pct.metal,water:pct.water},{stem:dayGan,elem:dmElem});

      // 十神分布
      const tg = tenGodSummary(dayGan, pillars);

      // —— 进阶解析：一段长文 + 要点
      // 1) 清理旧的进阶/VIP块
      document.querySelectorAll('#adv-section, #vip-section').forEach(n=>n.remove());

      const adv = document.createElement('section');
      adv.id = 'adv-section';
      adv.className='card section';
      const longText =
`命盘速览：
· 日主：${dayGan}（${dmElem}），月令${season}气象，整体呈「${strength.mark}」取向，宜「${strength.focus}」。
· 四柱：${gzYear}｜${gzMonth}｜${gzDay}｜${gzHour}
· 十神重心：${tg.top.join('、') || '分布均衡'}；（年/月/时干相对日主：${tg.tg.year||'-'}｜${tg.tg.month||'-'}｜${tg.tg.hour||'-'}）
· 资源结构：${elemAdv.summary}

用神/忌神（简化）：
- 用神侧重：当日主「${strength.mark}」时，${strength.mark==='偏强'?'宜取「泄秀（食伤）/制化（财官）」':'宜取「印比/同气」为主'}；结合当下任务灵活取舍。
- 场景策略：强项快推（${elemAdv.hi}类），弱项设边界（${elemAdv.lo}类）并引入外部协作。

节奏建议：
- 季节顺势：${season}令下宜${season==='春'?'生发启动、先铺内容与渠道':season==='夏'?'扩张曝光、定目标强推进':season==='秋'?'收敛打磨、确立标准与质控':'信息集结、沉淀体系、耐心蓄势'}。
- 时间管理：强势时段多做决策与推进；弱势时段安排复盘与补位。`;

      adv.innerHTML = `
        <div class="h2">进阶解析</div>
        <div style="white-space:pre-wrap;line-height:1.8">${longText}</div>
        <ul class="ul" style="margin-top:6px">
          <li>重点资源：${elemAdv.hi}；短板：${elemAdv.lo}</li>
          <li>十神提示：${tg.top.join('、') || '均衡分布，注意根据任务切换角色'}</li>
          <li>当前总评：${strength.mark}，建议「${strength.focus}」</li>
        </ul>`;
      result.parentNode.insertBefore(adv, result.nextSibling);

      // —— VIP 命理空间：按你七专题生成要点文案（示例逻辑）
      const isVip=false; // 你接入登录/支付后把它设为 true
      const vdata = {
        v_love:    `${strength.mark==='偏强'?'先事业后婚恋，择能量平衡型伴侣':'先稳定再推进，择互补型伴侣'}；留意${elemAdv.lo}类冲突，优先在${elemAdv.hi}场景结缘。`,
        v_career:  `职业倾向：${elemAdv.hi}行业更顺；${elemAdv.lo}相关宜外包/搭档。${tg.cnt['正官']>0?'官星见，宜走标准化/管理线；':''}${tg.cnt['食神']+tg.cnt['伤官']>0?'食伤旺，内容/产品/创作有势；':''}`,
        v_wealth:  `财气来源：${tg.cnt['正财']+tg.cnt['偏财']>0?'财星透，财路清晰；':''}${strength.mark==='偏强'?'注意分散风险、合理纳税':''}；理财节奏：强势期增配指数/工具，弱势期现金流为先。`,
        v_pet:     `适配性格：${dmElem==='木'?'温顺聪明型（犬/鹦鹉）':dmElem==='火'?'活泼热情型（犬/小型猫）':dmElem==='土'?'稳定依恋型（猫/仓鼠）':dmElem==='金'?'安静守序型（猫/鱼）':'灵动灵性型（猫/鱼）'}；日常以${elemAdv.hi}元素色系与玩具增缘。`,
        v_match:   `婚期/择日：用神当令（月度${season}相生之月/日）、避开${elemAdv.lo}过弱的时段；新生择时以${strength.mark==='偏强'?'印财调候':'印比护身'}为优先。`,
        v_name:    `命名取象：补「${elemAdv.lo}」避「过旺${elemAdv.hi}」；公司名偏${elemAdv.hi}意象更利品牌势能；宝宝名以${strength.mark==='偏强'?'收敛/稳重':'明朗/阳刚'}为宜。`,
        v_fengshui:`财位动线：${elemAdv.hi}方位布光/动线/绿植增强气场；${elemAdv.lo}方位以收纳/整洁化解；工位布局遵循“强项侧、入口亮、弱项静”。`
      };
      const vipWrap = document.createElement('div');
      vipWrap.id='vip-section';
      result.parentNode.insertBefore(vipWrap, adv.nextSibling);
      buildVipCards(vipWrap, vdata, /* isVip */ false);

      // —— 命格简评（沿用顶部卡）
      $('bazi-advice').textContent = `核心判断：${strength.mark}；节奏：${season}令取「${strength.focus}」。${elemAdv.summary}`;

      // —— 亮点行（可显示十神/强项）
      $('bazi-strengths').textContent = `亮点：${tg.top.join('、') || '平衡协调'}；强项方向：${elemAdv.hi}；短板：${elemAdv.lo}`;

    }catch(e){
      const err=$('error'); err.textContent = e && e.message ? e.message : '网络异常，请稍后再试。';
      err.style.display='block';
      $('result').style.display='block';
    }
  });
});
</script>
</body>
</html>

