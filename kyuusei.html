<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">命理心怜空间 · Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="命理心怜空间 · 免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等，一站式灵性与命理体验。">
  <meta property="og:title" content="命理心怜空间 · Soul Sanctuary">
  <meta property="og:description" content="免费体验区与VIP专区：八字、占星、灵数、塔罗、九星气学、能量类型等。">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22);
  }

  html,body{height:100%}
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} }
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }

  .glow{position:fixed; inset:auto auto 10% -10%; width:45vw; height:45vw; max-width:700px; max-height:700px;
    background:radial-gradient(closest-side, #2a98ff33, transparent 70%); filter:blur(30px); z-index:-1; pointer-events:none;}
  .container{width:100%; max-width:1100px; padding:24px 16px 80px; margin:0 auto;}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(12px);
    background:#0b0f14cc; border-bottom:1px solid #0f1622;}
  .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand-badge{width:36px; height:36px; border-radius:10px; background:linear-gradient(145deg,#273243,#0e141c);
    display:grid; place-items:center; color:var(--brand); font-weight:700; box-shadow:var(--shadow)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem}
  .subtitle{color:var(--muted); font-size:.9rem}

  /* 语言选择器 */
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{color:var(--muted); font-size:.9rem}
  .lang select{
    appearance:none; border-radius:10px; border:1px solid #243244; background:#0e1520; color:var(--text);
    padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== 亮金按钮 ===== */
  .btn,
  .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:13px 16px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:600; letter-spacing:.3px;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover,
  .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Chat 浮窗按钮 */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }
  /* Chat 面板样式 */
  .ss-chat-panel{
    position:fixed; right:18px; bottom:86px; width:320px; max-height:70vh;
    display:none; flex-direction:column; overflow:hidden; z-index:50;
    background:#0e1520; border:1px solid #243244; border-radius:14px; box-shadow:var(--shadow);
  }
  .ss-chat-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #243244; color:#ffe084; font-weight:700}
  .ss-chat-body{padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px; min-height:120px}
  .ss-chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid #243244}
  .ss-chat-input input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #243244; background:#0f1522; color:#eaf0ff}
  .ss-chat-input button{padding:10px 12px; border-radius:10px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:700}
  .ss-msg{background:#101a28; border:1px solid #223047; padding:8px 10px; border-radius:10px; max-width:85%}
  .ss-msg.me{margin-left:auto; background:#1a2433; border-color:#2b3a51}

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== 无障碍隐藏文字 ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
</style>
</head>

<body>
  <div class="glow"></div>
  <header>
    <div class="head-inner container">
      <div class="brand">
        <div class="brand-badge">5X</div>
        <div>
          <div class="title" data-i18n="site_title">命理心怜空间 · Soul Sanctuary</div>
        </div>
      </div>
      <!-- 语言选择器 -->
      <div class="lang">
        <label for="langSelect" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>九星气学简评</h1>

    <!-- 九星输入 -->
    <div class="card">
      <div class="row one">
        <div>
          <label class="muted">出生日期</label>
          <input type="date" id="birthdate">
        </div>
        <div>
          <label class="sr-only">生成</label>
          <button class="btn block" id="kyGo">生成分析</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        提示：九星以<strong>节分（立春，约 2 月 4 日）</strong>为换年点。生日在 <b>1/1–2/3（含）</b> 按上一年计算。
      </div>
    </div>

    <!-- 九星结果 -->
    <div class="section card" id="result" style="display:none;">
      <h2>您的九星主星</h2>
      <p>主星：<strong id="mainStar"></strong>（<span id="jpName"></span>）</p>
      <div id="starMeta" style="display:flex; gap:8px; flex-wrap:wrap; margin:6px 0">
        <!-- 五行/颜色/关键词 -->
      </div>
      <div id="starDesc"></div>
    </div>

    <div class="section card">
      <h2>完整版分析</h2>
      <p>加入会员可解锁流年飞泊图、九宫吉位规划、日式开运指南与命名建议。</p>
    </div>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 功能脚本：后端代理 + 多语言 + Chat 浮窗 + 九星算法 -->
<script>
  // ============== 统一配置（你的 Worker 域名） ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers.dev

  // 工具函数
  const $ = id => document.getElementById(id);
  function showErr(msg){ let e=$("error"); if(!e){e=document.createElement('div');e.id='error';e.className='error';document.body.appendChild(e);} e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); if(!e) return; e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }

  // ============== 多语言（精简保留：t/applyI18n/setLang） ==============
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
  const translations = {
    "zh-CN": { page_title:"命理心怜空间 · Index", site_title:"命理心怜空间 · Soul Sanctuary", lang_label:"语言",
      chat_fab:"问", chat_placeholder:"请问您想了解什么？（如：如何开始免费体验）", chat_send:"发送" },
    "zh-TW": { page_title:"命理心憐空間 · Index", site_title:"命理心憐空間 · Soul Sanctuary", lang_label:"語言",
      chat_fab:"問", chat_placeholder:"想了解什麼？（例如：如何開始免費體驗）", chat_send:"發送" },
    "en":    { page_title:"Soul Sanctuary · Index", site_title:"Soul Sanctuary", lang_label:"Language",
      chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., free trial)", chat_send:"Send" },
    "ja":    { page_title:"ソウル・サンクチュアリ · Index", site_title:"ソウル・サンクチュアリ", lang_label:"言語",
      chat_fab:"問", chat_placeholder:"何を知りたいですか？", chat_send:"送信" },
    "th":    { page_title:"Soul Sanctuary · หน้าแรก", site_title:"Soul Sanctuary", lang_label:"ภาษา",
      chat_fab:"ถาม", chat_placeholder:"อยากรู้อะไร", chat_send:"ส่ง" },
    "ms":    { page_title:"Soul Sanctuary · Indeks", site_title:"Soul Sanctuary", lang_label:"Bahasa",
      chat_fab:"Tanya", chat_placeholder:"Anda mahu tahu apa?", chat_send:"Hantar" }
  };
  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  // ============== Chat 浮窗（走 /api/chat） ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat 按钮与面板
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">心怜管家 · Chat</div>
        <div class="ss-close" id="ssChatClose" style="cursor:pointer">✕</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    // 初始语言（页面 + chat）
    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。');
        addMsg(reply);
      }catch(e){
        addMsg('网络异常，请稍后再试。');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // 语言切换时，同步更新
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }
  });

  /* ========================== 九星气学：主星计算 ========================== */
  function reduce1(n){
    let s = Math.abs(n).toString().split('').reduce((a,b)=>a+Number(b),0);
    while(s>9) s = s.toString().split('').reduce((a,b)=>a+Number(b),0);
    return s;
  }
  function isBeforeSetsubun(d){
    // 2/4 起为新年，1/1~2/3（含）按上一年
    const m = d.getMonth(); // 0..11
    const day = d.getDate();
    return (m===0) || (m===1 && day<=3);
  }
  function calcHonmeiStar(dateStr){
    const d = new Date(dateStr);
    if(isNaN(d)) return null;
    const y = d.getFullYear();
    const root = reduce1(y);
    const base = isBeforeSetsubun(d) ? 12 : 11;
    let num = base - root;
    while(num<=0) num += 9;
    return num; // 1..9
  }

  const STARS = {
    1:{ zh:'一白水星', jp:'Ippaku Suisei', elem:'水', color:'白', key:['流动','直觉','沟通'],
        persona:'敏感细腻、共情力强，行动灵活，擅长信息流转与关系协调。',
        strengths:['感知敏锐','适应性强','善于连接资源'], shadows:['情绪受外界影响大','优柔寡断','边界感不足'],
        advice:['一年设 1 个主轴，避免分散','沟通先列事实，再谈感受','社交有度，保留独处时段'] },
    2:{ zh:'二黑土星', jp:'Jikoku Dosei', elem:'土', color:'黑', key:['滋养','承载','耐性'],
        persona:'务实稳健、重视秩序与照料，擅长从 0-1 到 1-10 的持续耕耘。',
        strengths:['稳定耐心','照顾氛围','落地执行细致'], shadows:['过度保守','拖延','抗拒变化'],
        advice:['每月一次断舍离','关键节点让位于效率','学会求助，避免独自扛'] },
    3:{ zh:'三碧木星', jp:'Sanpeki Mokusei', elem:'木', color:'碧', key:['生发','表达','突破'],
        persona:'好奇心强、表达欲旺，喜欢新鲜创意与开疆拓土。',
        strengths:['启动力强','带动氛围','不怕试错'], shadows:['情绪起伏','收尾差','注意力分散'],
        advice:['用“周冲刺”代替长计划','设底线与退出标准','公开承诺提高完结率'] },
    4:{ zh:'四绿木星', jp:'Shiroku Mokusei', elem:'木', color:'绿', key:['交流','学习','旅行'],
        persona:'温和包容、擅长倾听与知识整合，适合教育与跨界协作。',
        strengths:['沟通润物无声','学习/复盘力强','带来松弛感'], shadows:['回避冲突','犹豫不决','容易迷失自我'],
        advice:['练习界限句式','每季一次独旅','把输出写进日程'] },
    5:{ zh:'五黄土星', jp:'Gogou Dosei', elem:'土', color:'黄', key:['中宫','权衡','重启'],
        persona:'居中定盘、抗压强，关键时刻能镇住场，适合策略与危机管理。',
        strengths:['定夺力强','系统重构力','止损能力'], shadows:['控制欲','苛刻','关系紧张'],
        advice:['共识-委派-检查','流程产品化','每周一次身心排浊'] },
    6:{ zh:'六白金星', jp:'Roppaku Kinsei', elem:'金', color:'白', key:['秩序','领导','远见'],
        persona:'自律果断、标准感强，擅长立规则、搭体系、带队伍。',
        strengths:['战略视角','高标准执行','抗干扰'], shadows:['完美主义','表达偏冷','容易孤立'],
        advice:['设置弹性标准','表达认可与感谢','按季度复盘战略'] },
    7:{ zh:'七赤金星', jp:'Shichiseki Kinsei', elem:'金', color:'赤', key:['社交','品味','享受'],
        persona:'人缘好、审美在线，擅长把平凡做出质感，适合品牌与社群。',
        strengths:['感染力强','审美与包装','资源整合'], shadows:['享乐拖延','在意评价','消费冲动'],
        advice:['把享受变成奖励','月度财务复盘','节律化内容产出'] },
    8:{ zh:'八白土星', jp:'Happaku Dosei', elem:'土', color:'白', key:['积累','转折','定山'],
        persona:'稳中求变、厚积薄发；静得下、守得住，关键时刻能翻盘。',
        strengths:['资源积累','筹划周密','拐点判断'], shadows:['固执','不求助','转弯慢'],
        advice:['半年一次大整理','把需求说清楚','遇转折先 3 天冷静'] },
    9:{ zh:'九紫火星', jp:'Kyūshi Kasei', elem:'火', color:'紫', key:['光彩','灵感','传播'],
        persona:'热情外放、灵感多，适合登台表达与IP打造，成就来自“被看见”。',
        strengths:['创造力','舞台感','传播力'], shadows:['情绪上头','持续力不足','过度追求关注'],
        advice:['把创作排成日/周更','情绪上头先停 10 分钟','作品上平台，不在脑子里'] }
  };

  function renderStar(num){
    const data = STARS[num]; if(!data) return;
    $("mainStar").textContent = data.zh;
    $("jpName").textContent  = data.jp;

    $("starMeta").innerHTML = `
      <span class="tag" style="display:inline-block;padding:2px 8px;border:1px solid var(--gold);color:var(--gold);border-radius:999px">五行：${data.elem}</span>
      <span class="tag" style="display:inline-block;padding:2px 8px;border:1px solid var(--gold);color:var(--gold);border-radius:999px">色：${data.color}</span>
      <span class="tag" style="display:inline-block;padding:2px 8px;border:1px solid var(--gold);color:var(--gold);border-radius:999px">关键词：${data.key.join(' / ')}</span>
    `;
    $("starDesc").innerHTML = `
      <p class="muted" style="margin:.3rem 0 0">性格倾向：${data.persona}</p>
      <p style="margin:.6rem 0 .2rem"><b>优势</b></p>
      <ul style="margin:.2rem 0 .6rem .9rem">${data.strengths.map(x=>`<li>${x}</li>`).join('')}</ul>
      <p style="margin:.6rem 0 .2rem"><b>可能的盲点</b></p>
      <ul style="margin:.2rem 0 .6rem .9rem">${data.shadows.map(x=>`<li>${x}</li>`).join('')}</ul>
      <p style="margin:.6rem 0 .2rem"><b>行动建议（近 30 天）</b></p>
      <ul style="margin:.2rem 0 .2rem .9rem">${data.advice.map(x=>`<li>${x}</li>`).join('')}</ul>
      <p class="muted" style="margin-top:.6rem">注：九星以节分（立春，通常 2/4）换年；更完整流年/吉位需结合飞泊盘推演。</p>
    `;
    $("result").style.display = "block";
  }

  // 绑定按钮
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = $("kyGo");
    btn.addEventListener('click', ()=>{
      const v = $("birthdate").value;
      if(!v){ alert('请先选择出生日期'); return; }
      const n = calcHonmeiStar(v);
      if(!n){ alert('日期格式不正确'); return; }
      renderStar(n);
    });
  });

  /* ====== （可选）登录相关代码：仅在页面存在表单时才绑定，避免报错 ====== */
  if (document.getElementById("registerForm")){
    document.getElementById("registerForm").addEventListener("submit", async (e)=>{
      e.preventDefault(); /* 你的注册逻辑… */ });
  }
  if (document.getElementById("loginForm")){
    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault(); /* 你的登录逻辑… */ });
  }
</script>
</body>
</html>
