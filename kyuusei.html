<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>九星气学 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%} body{margin:0;color:var(--text);background:#0b0f14;font-family:Inter,system-ui,"Noto Sans SC",Arial,sans-serif}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--gold);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:3px 10px;border:1px solid var(--gold);color:var(--gold);border-radius:999px;margin-right:6px;margin-top:4px}
.h2{font-size:1.2rem;margin:0 0 .5rem}
.muted{color:#9aa3b2}
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:85%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}
pre.ai{white-space:pre-wrap;line-height:1.7}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
    --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35); --blur:10px;
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22);
  }

  html,body{height:100%}
  html{font-size:16px}
  @media(min-width:768px){ html{font-size:17px} }
  @media(min-width:1200px){ html{font-size:18px} }

  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background:url('assets/images/gate.jpg') center/cover no-repeat;
    filter:brightness(.45) saturate(.9) blur(2px);
  }

  .glow{position:fixed; inset:auto auto 10% -10%; width:45vw; height:45vw; max-width:700px; max-height:700px;
    background:radial-gradient(closest-side, #2a98ff33, transparent 70%); filter:blur(30px); z-index:-1; pointer-events:none;}
  .container{width:100%; max-width:1100px; padding:24px 16px 80px; margin:0 auto;}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(12px);
    background:#0b0f14cc; border-bottom:1px solid #0f1622;}
  .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand-badge{width:36px; height:36px; border-radius:10px; background:linear-gradient(145deg,#273243,#0e141c);
    display:grid; place-items:center; color:var(--brand); font-weight:700; box-shadow:var(--shadow)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem}
  .subtitle{color:var(--muted); font-size:.9rem}

  /* 语言选择器 */
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{color:var(--muted); font-size:.9rem}
  .lang select{
    appearance:none; border-radius:10px; border:1px solid #243244; background:#0e1520; color:var(--text);
    padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }

  .section{margin-top:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter: blur(var(--blur)); padding:18px;}
  .grid-links{display:grid; gap:12px; grid-template-columns:repeat(1,1fr)}
  @media(min-width:640px){ .grid-links{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:980px){ .grid-links{grid-template-columns:repeat(3,1fr)} }
  .link-card{display:flex; align-items:center; justify-content:center; text-align:center; padding:16px 12px;
    border:1px solid #263448; background:#0e1520; border-radius:12px; text-decoration:none; color:var(--text);
    transition:transform .05s ease, box-shadow .2s ease;}
  .link-card:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
  .group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}

  .row{display:grid; gap:12px}
  @media(min-width:640px){ .row{grid-template-columns:1fr 1fr 1fr} }
  input,button{
    width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244;
    background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none;
  }
  input::placeholder{color:#6f8092}

  /* ===== 亮金按钮 ===== */
  .btn,
  .btn-gold {
    display:inline-grid; place-items:center; text-decoration:none;
    padding:13px 16px; border-radius:12px; border:1px solid #e6c76e; cursor:pointer;
    font-weight:600; letter-spacing:.3px;
    background: linear-gradient(180deg, #fff9e6, #e6c76e);
    color:#191919;
    box-shadow:0 6px 18px rgba(230, 199, 110, 0.4);
    transition:.15s;
  }
  .btn:hover,
  .btn-gold:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(230, 199, 110, 0.5); }
  .btn[disabled]{opacity:.6; cursor:not-allowed}

  /* Chat 浮窗按钮 */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }
  /* Chat 面板样式 */
  .ss-chat-panel{
    position:fixed; right:18px; bottom:86px; width:320px; max-height:70vh;
    display:none; flex-direction:column; overflow:hidden; z-index:50;
    background:#0e1520; border:1px solid #243244; border-radius:14px; box-shadow:var(--shadow);
  }
  .ss-chat-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #243244; color:#ffe084; font-weight:700}
  .ss-chat-body{padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px; min-height:120px}
  .ss-chat-input{display:flex; gap:8px; padding:10px; border-top:1px solid #243244}
  .ss-chat-input input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #243244; background:#0f1522; color:#eaf0ff}
  .ss-chat-input button{padding:10px 12px; border-radius:10px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:700}
  .ss-msg{background:#101a28; border:1px solid #223047; padding:8px 10px; border-radius:10px; max-width:85%}
  .ss-msg.me{margin-left:auto; background:#1a2433; border-color:#2b3a51}

  .columns{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
  .list-block{border:1px solid #263448; background:#0e1520; border-radius:12px; padding:16px}
  .list-block ul{margin:.2rem 0 0; padding-left:1.1rem}
  .muted{color:var(--muted)} .error{color:#ff8f8f; margin-top:8px}
  footer{color:#6c7b8c; font-size:.85rem; text-align:center; padding:30px 0}

  /* ===== 无障碍隐藏文字 ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
</style>
</head>

<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title">Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSelect">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <div class="card">
    <div class="h2">九星气学 · 快速解读</div>
    <div class="row cols-3">
      <div>
        <label class="muted">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" style="margin-top:6px">提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。</div>
      </div>
      <div>
        <label class="muted">主题</label>
        <select id="topic">
          <option value="love">爱情/关系</option>
          <option value="career">事业/工作</option>
          <option value="wealth">财富/投资</option>
          <option value="family">家庭/人际</option>
          <option value="health">健康/身心</option>
          <option value="study">学业/成长</option>
          <option value="move">旅行/搬迁</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted">常用问题</label>
        <select id="presetQ">
          <option value="">（可选）选择一个模板</option>
          <option>她/他爱我吗？我们接下来怎么走更好？</option>
          <option>我是否应该换工作/创业？需要注意什么？</option>
          <option>近期在投资与理财上，应如何取舍？</option>
          <option>如何改善与家人的关系与沟通？</option>
          <option>我最近健康/情绪的关键提醒是什么？</option>
        </select>
      </div>
    </div>
    <div class="row cols-1" style="margin-top:10px">
      <div>
        <label class="muted">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" placeholder="例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。"></textarea>
      </div>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn">生成分析</button></div>
      <div><button id="clear" class="btn" style="background:#101826;color:#ffe084;border-color:#3a3f47">清空</button></div>
    </div>
  </div>

  <!-- 结果：主星 -->
  <div id="starCard" class="section card" style="display:none">
    <div class="h2">您的九星主星</div>
    <p>主星：<b id="starName"></b>（<span id="starJP"></span>）</p>
    <div id="starBadges" style="margin:6px 0"></div>
    <div id="starAbout" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 结果：心怜管家解读 -->
  <div id="aiCard" class="section card" style="display:none">
    <div class="h2">心怜管家解读与建议</div>
    <pre id="心怜管家Text" class="心怜管家"></pre>
    <div id="心怜管家Reco" style="margin-top:10px"></div>
  </div>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>
  
<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="心怜管家">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="心怜管家">
  <div class="ss-chat-head">
    <div>心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" placeholder="问点什么吧…" />
    <button id="ssChatSend">发送</button>
  </div>
</div>

<script>
/* ===== 基础配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers

/* ===== 语言获取（仅用于提示词语言） ===== */
const LANG_KEY="site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
document.getElementById('langSelect').value=getLang();
document.getElementById('langSelect').addEventListener('change',e=>{
  localStorage.setItem(LANG_KEY,e.target.value);
  document.documentElement.lang=e.target.value;
});

/* ===== Chat 浮窗 ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      const data=await r.json(); const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||'抱歉，稍后再试。');
    }catch{ addMsg('网络异常，请稍后再试。');}
  }
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();
function $(id){return document.getElementById(id)}

/* ===== 九星算法（节分 2/4 换年） ===== */
function reduce1(n){let s=Math.abs(n).toString().split('').reduce((a,b)=>a+Number(b),0);while(s>9)s=s.toString().split('').reduce((a,b)=>a+Number(b),0);return s;}
function isBeforeSetsubun(d){const m=d.getMonth(),day=d.getDate();return (m===0)||(m===1&&day<=3);}
function calcHonmei(dateStr){const d=new Date(dateStr);if(isNaN(d))return null;const root=reduce1(d.getFullYear());let num=(isBeforeSetsubun(d)?12:11)-root;while(num<=0)num+=9;return num;}

const STARS={
  1:{zh:'一白水星',jp:'Ippaku Suisei',elem:'水',color:'白',key:['流动','直觉','沟通'],about:'敏感细腻、共情力强，行动灵活，擅长信息与关系协调。'},
  2:{zh:'二黑土星',jp:'Jikoku Dosei',elem:'土',color:'黑',key:['滋养','承载','耐性'],about:'务实稳健、重视秩序与照料，擅长持续耕耘与落地。'},
  3:{zh:'三碧木星',jp:'Sanpeki Mokusei',elem:'木',color:'碧',key:['生发','表达','突破'],about:'好奇表达欲强，喜欢创意与开疆拓土。'},
  4:{zh:'四绿木星',jp:'Shiroku Mokusei',elem:'木',color:'绿',key:['交流','学习','旅行'],about:'温和包容、擅长倾听与知识整合，适合教育与协作。'},
  5:{zh:'五黄土星',jp:'Gogou Dosei',elem:'土',color:'黄',key:['中宫','权衡','重启'],about:'居中定盘、抗压强，擅长策略与危机管理。'},
  6:{zh:'六白金星',jp:'Roppaku Kinsei',elem:'金',color:'白',key:['秩序','领导','远见'],about:'自律果断、擅立规则与带队。'},
  7:{zh:'七赤金星',jp:'Shichiseki Kinsei',elem:'金',color:'赤',key:['社交','品味','享受'],about:'人缘好、审美在线，擅品牌与社群。'},
  8:{zh:'八白土星',jp:'Happaku Dosei',elem:'土',color:'白',key:['积累','转折','定山'],about:'稳中求变、厚积薄发，关键时刻能翻盘。'},
  9:{zh:'九紫火星',jp:'Kyūshi Kasei',elem:'火',color:'紫',key:['光彩','灵感','传播'],about:'热情外放、灵感多，适合登台表达与IP打造。'}
};

/* ===== 渲染主星卡片 ===== */
function renderStar(n){
  const s=STARS[n]; if(!s) return;
  $('starName').textContent=s.zh; $('starJP').textContent=s.jp;
  $('starBadges').innerHTML=`<span class="badge">五行：${s.elem}</span><span class="badge">色：${s.color}</span><span class="badge">关键词：${s.key.join(' / ')}</span>`;
  $('starAbout').textContent='性格倾向：'+s.about;
  $('starCard').style.display='block';
}

/* ===== 组装给 GPT 的提示词 ===== */
function buildPrompt({lang, star, topic, question}){
  const topicMap={
    love:'爱情/关系', career:'事业/工作', wealth:'财富/投资', family:'家庭/人际',
    health:'健康/身心', study:'学业/成长', move:'旅行/搬迁', other:'其他'
  };
  const starText=`主星：${star.zh}（${star.jp}）；五行：${star.elem}；关键词：${star.key.join('、')}。性格：${star.about}`;
  return `你是 5XLiving「心怜管家」与资深九星气学顾问。请使用【${lang}】输出，语气温暖、专业、落地。
用户的主星信息：${starText}
用户主题：${topicMap[topic] || topic}
用户问题：${question || '（无具体问题，请给通用提示）'}

请按以下结构输出（不要加多余前后缀）：
# 核心判断（2-4 句）
# 现在要做的事（列 3 条，动词开头）
# 避坑提醒（列 2-3 条）
# 可尝试的灵性练习（从冥想/manifestation/书写愿望/仪式中给 2-3 条，给操作要点）
# AI 推举内容（列 3-5 条，结合本网站：如预约一对一、加入 VIP、许愿包/御守、学习课程、把计划存入心怜笔记等）`;
}

/* ===== 请求 GPT 并渲染 ===== */
async function askAI(prompt){
  const resp=await fetch(`${API_BASE}/api/chat`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[{role:'system',content:'你将产出结构化的九星气学建议，务必简明清晰、可执行。'}, {role:'user',content:prompt}]})
  });
  let data={}; try{data=await resp.json()}catch{}
  return data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? '';
}

/* ===== 交互 ===== */
$('presetQ').addEventListener('change',e=>{
  const v=e.target.value; if(v){ const q=$('question'); q.value = q.value? q.value+'\n'+v : v; }
});
$('clear').addEventListener('click',()=>{
  $('birthdate').value=''; $('question').value=''; $('presetQ').value=''; $('topic').value='love';
  $('starCard').style.display='none'; $('aiCard').style.display='none';
});

$('go').addEventListener('click', async ()=>{
  const date=$('birthdate').value.trim();
  if(!date){ alert('请先选择出生日期'); return; }
  const n=calcHonmei(date);
  if(!n){ alert('日期格式有误'); return; }
  const star=STARS[n];
  renderStar(n);

  const topic=$('topic').value;
  const question=($('question').value || $('presetQ').value || '').trim();
  const langMap={ 'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu' };
  const prompt=buildPrompt({lang:langMap[getLang()]||'简体中文',star,topic,question});

  $('aiText').textContent='正在生成解读…';
  $('aiCard').style.display='block';
  try{
    const txt=await ask心怜管家(prompt);
    $('心怜管家Text').textContent = txt || '抱歉，暂时无法生成，请稍后再试。';
    // 粗略把“心怜管家 推举内容”单独抽出（用于按钮/链接位；如果结构不固定则直接显示文本即可）
    const recos=[];
    (txt||'').split('\n').forEach(l=>{ if(/推举|推荐|VIP|许愿|预约|课程|笔记|御守/.test(l)) recos.push(l.trim()); });
    $('aiReco').innerHTML = recos.length ? `<div class="h2" style="margin-top:12px">心怜管家推举内容</div>
      <ul style="margin:.3rem 0 .2rem .9rem">${recos.slice(0,5).map(x=>`<li>${x}</li>`).join('')}</ul>` : '';
  }catch(e){
    $('心怜管家Text').textContent='网络异常，请稍后再试。';
  }
});
</script>
</body>
</html>

