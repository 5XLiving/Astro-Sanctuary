<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¹æ˜Ÿæ°”å­¦ Â· 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* â€”â€” ç»Ÿä¸€å¤´éƒ¨ â€”â€” */
    .site-header{
      position:sticky; top:0; z-index:10;
      background:#0b0f14cc;
      border-bottom:1px solid #0f1622;
      backdrop-filter:saturate(140%) blur(12px);
    }
    .head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{
      display:inline-grid; place-items:center;
      width:34px; height:34px; border-radius:8px;
      background:linear-gradient(180deg,#0e1520,#0b1018);
      border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
      font-weight:800; color:#ffe084;
    }
    .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:700; letter-spacing:.02em}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }

    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
    .lang select{
      appearance:none; min-width:170px;
      border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:var(--text);
      padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){
      .title{font-size:1rem}
      .lang select{min-width:140px}
    }

    /* â€”â€” åŸºæœ¬å¡ç‰‡/æ ‡é¢˜ â€”â€” */
    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    /* â€”â€” è¡¨å•ç½‘æ ¼ï¼šä¸å…«å­—é¡µä¸€è‡´ â€”â€” */
    .row{display:grid;gap:12px;grid-template-columns:1fr;}
    .row > *{min-width:0;}
    @media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr;} .row.cols-2{grid-template-columns:1fr 1fr;} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder,textarea::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    /* â€”â€” ä¸»æ˜Ÿä¿¡æ¯å¾½ç«  â€”â€” */
    .badge{display:inline-block;padding:6px 10px;border:1px solid #2a3546;background:#0e1520;border-radius:999px;margin:4px 6px 0 0;font-size:.92rem}
    .badge b{color:#ffd88a}

    /* â€”â€” Butler åŒºåŸŸï¼ˆä¸å…«å­—é¡µä¸€è‡´ï¼‰ â€”â€” */
    .sec h3{margin:0 0 8px;color:var(--brand)}
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}

    /* â€”â€” ä¼šå‘˜åŒº & ç™»å½• é¢æ¿ï¼ˆä¸å…«å­—é¡µä¸€è‡´ï¼‰ â€”â€” */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* â€”â€” å³ä¸‹è§’å¿ƒæ€œç®¡å®¶ï¼ˆä¸å…«å­—é¡µä¸€è‡´ï¼šéšè—ï¼‰ â€”â€” */
    .ss-chat-fab, .ss-chat-panel { display: none !important; }
    /* ä¸ Index ä¿æŒä¸€è‡´çš„æ ¹å­—å·ï¼ˆä¼šå½±å“ remï¼‰ */
    html { font-size: 16px; }
    @media (min-width: 768px){ html { font-size: 17px; } }
    @media (min-width: 1200px){ html { font-size: 18px; } }
  </style>
</head>

<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· <span data-i18n="title_kyuusei_brief">ä¹æ˜Ÿæ°”å­¦</span></span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- è¡¨å•ï¼šä¸å…«å­—é¡µå¸ƒå±€ä¸€è‡´ï¼Œä½†å­—æ®µä¸ºä¹æ˜Ÿ -->
  <section class="card">
    <div class="h2" data-i18n="title_quickcalc">ä¹æ˜Ÿæ°”å­¦ Â· å¿«é€Ÿè§£è¯»</div>

    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="label_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate" />
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">ä¸»é¢˜</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">çˆ±æƒ…/å…³ç³»</option>
          <option value="career" data-i18n="topic_career">äº‹ä¸š/å·¥ä½œ</option>
          <option value="wealth" data-i18n="topic_wealth">è´¢å¯Œ/æŠ•èµ„</option>
          <option value="family" data-i18n="topic_family">å®¶åº­/äººé™…</option>
          <option value="health" data-i18n="topic_health">å¥åº·/èº«å¿ƒ</option>
          <option value="study" data-i18n="topic_study">å­¦ä¸š/æˆé•¿</option>
          <option value="move"  data-i18n="topic_move">æ—…è¡Œ/æ¬è¿</option>
          <option value="other" data-i18n="topic_other">å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="preset_label">å¸¸ç”¨é—®é¢˜</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">ï¼ˆå¯é€‰ï¼‰é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿</option>
          <option data-i18n="preset_1">å¥¹/ä»–çˆ±æˆ‘å—ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥æ€ä¹ˆèµ°æ›´å¥½ï¼Ÿ</option>
          <option data-i18n="preset_2">æˆ‘æ˜¯å¦åº”è¯¥æ¢å·¥ä½œ/åˆ›ä¸šï¼Ÿéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</option>
          <option data-i18n="preset_3">è¿‘æœŸåœ¨æŠ•èµ„ä¸ç†è´¢ä¸Šï¼Œåº”å¦‚ä½•å–èˆï¼Ÿ</option>
          <option data-i18n="preset_4">å¦‚ä½•æ”¹å–„ä¸å®¶äººçš„å…³ç³»ä¸æ²Ÿé€šï¼Ÿ</option>
          <option data-i18n="preset_5">æˆ‘æœ€è¿‘å¥åº·/æƒ…ç»ªçš„å…³é”®æé†’æ˜¯ä»€ä¹ˆï¼Ÿ</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="q_label">ä½ çš„å…·ä½“é—®é¢˜ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©çš„è¯¾é¢˜æ˜¯â€œå¥¹çˆ±æˆ‘å—â€ã€‚å¸Œæœ›å¾—åˆ°æ¸…æ™°çš„ä¸‹ä¸€æ­¥å»ºè®®ä¸é¿å‘æé†’ã€‚"></textarea>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:10px">
      <div><button class="btn" id="genBtn" type="button" data-i18n="btn_generate">ç”Ÿæˆè§£è¯»</button></div>
      <div><button class="btn ghost" id="clearBtn" type="button" data-i18n="btn_clear">æ¸…ç©º</button></div>
    </div>

    <div id="error" class="error-message"></div>
  </section>

  <!-- ç»“æœåŒºï¼šä¸»æ˜Ÿä¿¡æ¯ -->
  <section id="result" style="display:none;">
    <div class="card" id="starCard">
      <div class="h2" data-i18n="sec_star">æ‚¨çš„ä¹æ˜Ÿä¸»æ˜Ÿ</div>
      <p><span data-i18n="star_label">ä¸»æ˜Ÿ</span>ï¼š<b id="starName">-</b>ï¼ˆ<span id="starJP">-</span>ï¼‰</p>
      <div id="starBadges" style="margin:6px 0"></div>
      <div id="starAbout" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card" id="freeReport">
      <div class="h2" data-i18n="rpt_free_title">å…è´¹ç®€æŠ¥</div>
      <div id="freeReportBody" class="ai-content"></div>
    </div>

    <div class="card" id="rich-report"></div>
    <div id="butler-host"></div>
  </section>

  <!-- ä¼šå‘˜ä¸“åŒºï¼ˆå¤ç”¨å…«å­—é¡µç»“æ„ä¸æ–‡æ¡ˆé”®ï¼‰ -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

    <section class="astro-auth">
      <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
              <input id="email" name="email" type="email" inputmode="email" autocomplete="username" data-i18n-ph="ph_email" placeholder="" required />
              <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
              <input id="password" name="password" type="password" autocomplete="current-password" data-i18n-ph="ph_password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" required />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>
            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
  
<script>
;(() => {
  'use strict';

  /* ========================= åŸºç¡€é…ç½® & å·¥å…· ========================= */

  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

  const $ = (id) => document.getElementById(id);

  const LANG_KEY = 'site_lang';
  function getLang() {
    return localStorage.getItem(LANG_KEY) || document.documentElement.lang || 'zh-CN';
  }
  function setLang(code) {
    localStorage.setItem(LANG_KEY, code);
    document.documentElement.lang = code;
  }

  // è‹¥ Part2 å·²æ³¨å…¥ window.translationsï¼Œæ­¤å¤„åªåšå…œåº•ä¸ merge
  window.translations = window.translations || {};
  const baseZh = window.translations['zh-CN'] || {
    title_kyuusei_brief: 'ä¹æ˜Ÿæ°”å­¦',
    title_quickcalc: 'ä¹æ˜Ÿæ°”å­¦ Â· å¿«é€Ÿè§£è¯»',
    label_birthdate: 'å‡ºç”Ÿæ—¥æœŸ',
    topic_label: 'ä¸»é¢˜',
    topic_love: 'çˆ±æƒ…/å…³ç³»',
    topic_career: 'äº‹ä¸š/å·¥ä½œ',
    topic_wealth: 'è´¢å¯Œ/æŠ•èµ„',
    topic_family: 'å®¶åº­/äººé™…',
    topic_health: 'å¥åº·/èº«å¿ƒ',
    topic_study: 'å­¦ä¸š/æˆé•¿',
    topic_move: 'æ—…è¡Œ/æ¬è¿',
    topic_other: 'å…¶ä»–',
    preset_label: 'å¸¸ç”¨é—®é¢˜',
    preset_none: 'ï¼ˆå¯é€‰ï¼‰é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿',
    preset_1: 'å¥¹/ä»–çˆ±æˆ‘å—ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥æ€ä¹ˆèµ°æ›´å¥½ï¼Ÿ',
    preset_2: 'æˆ‘æ˜¯å¦åº”è¯¥æ¢å·¥ä½œ/åˆ›ä¸šï¼Ÿéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ',
    preset_3: 'è¿‘æœŸåœ¨æŠ•èµ„ä¸ç†è´¢ä¸Šï¼Œåº”å¦‚ä½•å–èˆï¼Ÿ',
    preset_4: 'å¦‚ä½•æ”¹å–„ä¸å®¶äººçš„å…³ç³»ä¸æ²Ÿé€šï¼Ÿ',
    preset_5: 'æˆ‘æœ€è¿‘å¥åº·/æƒ…ç»ªçš„å…³é”®æé†’æ˜¯ä»€ä¹ˆï¼Ÿ',
    q_label: 'ä½ çš„å…·ä½“é—®é¢˜ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰',
    q_ph: 'ä¾‹å¦‚ï¼šä»Šå¤©çš„è¯¾é¢˜æ˜¯â€œå¥¹çˆ±æˆ‘å—â€ã€‚å¸Œæœ›å¾—åˆ°æ¸…æ™°çš„ä¸‹ä¸€æ­¥å»ºè®®ä¸é¿å‘æé†’ã€‚',
    btn_generate: 'ç”Ÿæˆåˆ†æ',
    btn_clear: 'æ¸…ç©º',
    sec_star: 'æ‚¨çš„ä¹æ˜Ÿä¸»æ˜Ÿ',
    star_label: 'ä¸»æ˜Ÿ',
    rpt_free_title: 'å…è´¹ç®€æŠ¥',
    err_birth_required: 'è¯·å…ˆé€‰æ‹©å‡ºç”Ÿæ—¥æœŸ',
    err_calc_failed: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚',
    butler_title: 'å¿ƒæ€œç®¡å®¶ Â· è§£è¯»',
    chip_career: 'äº‹ä¸š',
    chip_love: 'æ„Ÿæƒ…',
    chip_money: 'è´¢è¿',
    chip_list: 'ä»Šæ—¥å¾…åŠ',
    chip_30d: '30å¤©å»ºè®®',
    q_career: 'ç»“åˆæˆ‘çš„ä¸»æ˜Ÿ/è±¡æ„/å‰æ–¹ï¼Œç»™æˆ‘å¯æ‰§è¡Œçš„èŒä¸šå»ºè®®ï¼ˆé€‚åˆè¡Œä¸š/å²—ä½/çŸ­æœŸçªç ´ç‚¹ï¼‰ã€‚',
    q_love: 'ç»“åˆä¸»æ˜Ÿä¸ç›¸æ€§ï¼Œç»™å‡ºæ‹çˆ±/å©šå§»å»ºè®®ï¼šèŠ‚å¥/è¾¹ç•Œ/å¸¸è§å‘ä¸ä¿®æ­£åŠæ³•ã€‚',
    q_money: 'æœªæ¥åŠå¹´è´¢è¿ï¼šç°é‡‘æµã€é£é™©é…æ¯”ã€æ”¯å‡ºä¼˜åŒ–ä¸å…·ä½“è¡ŒåŠ¨æ¸…å•ã€‚',
    q_list: 'åŸºäºä¸»æ˜Ÿç‰¹è´¨ï¼Œç”Ÿæˆ 3â€“5 æ¡å¯æ‰§è¡Œçš„ä»Šæ—¥å¾…åŠï¼Œé™„æ—¶é—´å»ºè®®ã€‚',
    q_30d: 'ç»“åˆå‰è‰²/å‰æ–¹/ä½œæ¯ï¼Œè®¾è®¡ 30 å¤©å¾®ç»ƒä¹ ï¼ˆæ¯å¤© 1 æ¡ï¼‰ï¼Œç®€å•å¯åšæŒã€‚',
    // æ–¹ä½/è‰²å½©æ ‡ç­¾
    dir_east: 'ä¸œæ–¹', dir_west: 'è¥¿æ–¹', dir_south: 'å—æ–¹', dir_north: 'åŒ—æ–¹',
    dir_ne: 'ä¸œåŒ—', dir_nw: 'è¥¿åŒ—', dir_se: 'ä¸œå—', dir_sw: 'è¥¿å—', dir_center: 'ä¸­å¤®',
    color_water: 'é»‘/è“', color_wood: 'ç»¿/é’', color_fire: 'çº¢/ç´«',
    color_earth: 'é»„/ç±³/æ£•', color_metal: 'ç™½/é‡‘/é“¶',
    // æ˜Ÿå/ç®€ä»‹ï¼ˆzh å…œåº•ï¼‰
    ks_1_name: 'ä¸€ç™½æ°´æ˜Ÿ', ks_1_about: 'æµåŠ¨/ç›´è§‰/æ²Ÿé€šï¼›ä¿¡æ¯ä¸ç§»åŠ¨ä¹‹æ˜Ÿã€‚',
    ks_2_name: 'äºŒé»‘åœŸæ˜Ÿ', ks_2_about: 'åŠ¡å®/æ»‹å…»/æ‰¿è½½ï¼›ç´¯ç§¯ç¨³å®šä¹‹æ˜Ÿã€‚',
    ks_3_name: 'ä¸‰ç¢§æœ¨æ˜Ÿ', ks_3_about: 'ç”Ÿå‘/è¡¨è¾¾/çªç ´ï¼›åˆ›æ–°ä¸é€Ÿåº¦ä¹‹æ˜Ÿã€‚',
    ks_4_name: 'å››ç»¿æœ¨æ˜Ÿ', ks_4_about: 'äº¤æµ/å­¦ä¹ /æ—…è¡Œï¼›åè°ƒä¸ç½‘ç»œä¹‹æ˜Ÿã€‚',
    ks_5_name: 'äº”é»„åœŸæ˜Ÿ', ks_5_about: 'ä¸­å®«/æƒè¡¡/å¤ä½ï¼›ç£åœºå¼ºã€æ³¢åŠ¨æœŸæ…è¡Œã€‚',
    ks_6_name: 'å…­ç™½é‡‘æ˜Ÿ', ks_6_about: 'ç§©åº/é¢†å¯¼/è¿œè§ï¼›è´£ä»»ä¸æˆæœä¹‹æ˜Ÿã€‚',
    ks_7_name: 'ä¸ƒèµ¤é‡‘æ˜Ÿ', ks_7_about: 'ç¤¾äº¤/å“å‘³/äº«å—ï¼›å–œæ‚¦ä¸æ”¶è·ä¹‹æ˜Ÿã€‚',
    ks_8_name: 'å…«ç™½åœŸæ˜Ÿ', ks_8_about: 'ç§¯ç´¯/è½¬æŠ˜/å®šå±±ï¼›æ”¹é€ ä¸å»¶ç»­ä¹‹æ˜Ÿã€‚',
    ks_9_name: 'ä¹ç´«ç«æ˜Ÿ', ks_9_about: 'å…‰å½©/çµæ„Ÿ/ä¼ æ’­ï¼›åèª‰ä¸èˆå°ä¹‹æ˜Ÿã€‚',
    // å°è´´å£«
    ks_sec_overview_title: 'ä¸€ï¼‰ä¸»æ˜Ÿä¸è¦ç‚¹',
    ks_sec_dirs_title: 'äºŒï¼‰åŸºç¡€å‰æ–¹',
    ks_sec_colors_title: 'ä¸‰ï¼‰å‰è‰²/ç‰©ä»¶',
    ks_sec_timing_title: 'å››ï¼‰æ—¶è¿æç¤º',
    ks_tip_travel: 'è¿œè¡Œæ—¶å¯å‚è€ƒã€Œå‰æ–¹ã€æ‹©å‘ï¼Œæ•´ä½“æ›´é¡ºã€‚',
    ks_tip_move: 'æ¬è¿å®œæŸ¥å¹´ç›˜+æœˆç›˜ï¼Œé¿å¼€å†²å…‹æ–¹ã€‚',
    ks_tip_daily: 'æ—¥å¸¸ç”Ÿæ´»é‡Œçš„å°æ–¹ä½é€‰æ‹©ï¼Œä¹Ÿä¼šé•¿æœŸåŠ åˆ†ã€‚'
  };
  window.translations['zh-CN'] = Object.assign({}, baseZh, window.translations['zh-CN']);

  function t(key) {
    const L = window.translations[getLang()] || window.translations['zh-CN'];
    return L[key] || (window.translations['zh-CN'][key] || key);
  }

  function applyI18n() {
    // data-i18n æ–‡æ¡ˆ
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const k = el.getAttribute('data-i18n');
      el.textContent = t(k);
    });
    // data-i18n-ph å ä½
    document.querySelectorAll('[data-i18n-ph]').forEach(el => {
      const k = el.getAttribute('data-i18n-ph');
      el.setAttribute('placeholder', t(k));
    });
  }

  /* ========================= ä¹æ˜Ÿæ•°æ®ä¸ç®—æ³• ========================= */

  // JP åç§° + äº”è¡Œ/è‰²å½©/å…³é”®è¯ï¼ˆä¸éšè¯­è¨€å˜åŒ–çš„å…ƒæ•°æ®ï¼‰
  const STARS_META = {
    1: { jp: 'Ippaku Suisei', element: 'æ°´', color: t('color_water'), kw: ['æµåŠ¨','ç›´è§‰','æ²Ÿé€š'] },
    2: { jp: 'Jikoku Dosei',  element: 'åœŸ', color: t('color_earth'), kw: ['æ»‹å…»','æ‰¿è½½','è€æ€§'] },
    3: { jp: 'Sanpeki Mokusei', element: 'æœ¨', color: t('color_wood'), kw: ['ç”Ÿå‘','è¡¨è¾¾','çªç ´'] },
    4: { jp: 'Shiroku Mokusei', element: 'æœ¨', color: t('color_wood'), kw: ['äº¤æµ','å­¦ä¹ ','æ—…è¡Œ'] },
    5: { jp: 'GogÅ Dosei',      element: 'åœŸ', color: t('color_earth'), kw: ['ä¸­å®«','æƒè¡¡','é‡å¯'] },
    6: { jp: 'Roppaku Kinsei',  element: 'é‡‘', color: t('color_metal'), kw: ['ç§©åº','é¢†å¯¼','è¿œè§'] },
    7: { jp: 'Shichiseki Kinsei', element: 'é‡‘', color: t('color_metal'), kw: ['ç¤¾äº¤','å“å‘³','äº«å—'] },
    8: { jp: 'Happaku Dosei',     element: 'åœŸ', color: t('color_earth'), kw: ['ç§¯ç´¯','è½¬æŠ˜','å®šå±±'] },
    9: { jp: 'KyÅ«shi Kasei',      element: 'ç«', color: t('color_fire'), kw: ['å…‰å½©','çµæ„Ÿ','ä¼ æ’­'] }
  };

  // ä»¥èŠ‚åˆ†ï¼ˆ2/4ï¼‰æ¢å¹´ï¼ŒæŒ‰å¹´æ•°ç æ±‚ä¸»æ˜Ÿï¼š num = ((isBeforeSetsubun?12:11) - digitroot(year))ï¼›<=0åˆ™+9
  function isBeforeSetsubun(d) {
    const m = d.getMonth(), day = d.getDate();
    return (m === 0) || (m === 1 && day <= 3); // 1æœˆï¼Œæˆ–2æœˆ1-3æ—¥
  }
  function digitRoot(n) {
    let s = Math.abs(n).toString().split('').reduce((a, b) => a + Number(b), 0);
    while (s > 9) s = s.toString().split('').reduce((a, b) => a + Number(b), 0);
    return s;
  }
  function calcHonmeiStar(dateStr) {
    const d = new Date(dateStr + 'T12:00:00'); // local noon
    if (isNaN(d)) return null;
    const y = d.getFullYear();
    const n = (isBeforeSetsubun(d) ? 12 : 11) - digitRoot(y);
    let num = n;
    while (num <= 0) num += 9;
    return num; // 1..9
  }

  // element â†’ åŸºç¡€å‰æ–¹ä¸å‰è‰²ï¼ˆç®€åŒ–è§„åˆ™ï¼šä¸å…ƒç´ ç›¸é…ï¼‰
  function basicLuckyDirsByElement(el) {
    const D = {
      'æ°´': [t('dir_north'), t('dir_ne')],
      'æœ¨': [t('dir_east'), t('dir_se')],
      'ç«': [t('dir_south')],
      'é‡‘': [t('dir_west'), t('dir_nw')],
      'åœŸ': [t('dir_center'), t('dir_ne'), t('dir_sw')]
    };
    return D[el] || [];
  }

  /* ========================= UI æ¸²æŸ“ï¼ˆä¸ Bazi é¡µé£æ ¼ä¸€è‡´ï¼‰ ========================= */

  // å¾½ç«  HTML
  function badgeHTML(label, value) {
    return `<span style="display:inline-block;border:1px solid #2a3546;background:#0e1520;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:.9rem">
      <b style="color:#ffd88a">${label}ï¼š</b>${value}</span>`;
  }

  // æ¸²æŸ“ã€Œä¸»æ˜Ÿå¡ç‰‡ã€â€”â€” è‹¥é¡µé¢å·²æœ‰ #starCardï¼ˆä½ æ—§ç‰ˆçš„å®¹å™¨ï¼‰ï¼Œåˆ™å¡«å……å®ƒï¼›å¦åˆ™åœ¨ #result ä¸‹åˆ›å»º ks-result å¡ç‰‡
  function renderStarCard(n) {
    if (!n) return;
    const nameKey = `ks_${n}_name`;
    const aboutKey = `ks_${n}_about`;
    const name = t(nameKey);
    const about = t(aboutKey);
    const meta = STARS_META[n];

    const exist = $('starCard');
    if (exist) {
      // å…¼å®¹ä½ æœ€åˆä¹æ˜Ÿé¡µçš„ ID
      const L = {
        badge_elem: t('topic_label') || 'ä¸»é¢˜', // å›é€€
      };
      $('starName') && ( $('starName').textContent = name );
      $('starJP') && ( $('starJP').textContent = meta.jp );
      if ($('starBadges')) {
        $('starBadges').innerHTML =
          badgeHTML('äº”è¡Œ', meta.element) +
          badgeHTML('è‰²å½©', meta.color) +
          badgeHTML('å…³é”®è¯', meta.kw.join(' / '));
      }
      $('starAbout') && ( $('starAbout').textContent = about );
      exist.style.display = 'block';
      return;
    }

    // ä¸ Bazi é¡µä¸€è‡´ï¼šå¡è¿› #result
    let result = $('result');
    if (!result) {
      // æ²¡æœ‰ result å°±åˆ›å»ºä¸€ä¸ª
      result = document.createElement('section');
      result.id = 'result';
      result.style.display = 'block';
      const main = document.querySelector('main.container') || document.querySelector('main') || document.body;
      main.appendChild(result);
    }

    let host = $('ks-result');
    if (!host) {
      host = document.createElement('div');
      host.id = 'ks-result';
      host.className = 'card';
      result.appendChild(host);
    }
    host.innerHTML = `
      <div class="h2">${t('sec_star') || 'æ‚¨çš„ä¹æ˜Ÿä¸»æ˜Ÿ'}</div>
      <p><span>${t('star_label') || 'ä¸»æ˜Ÿ'}</span>ï¼š<b>${name}</b>ï¼ˆ<span>${meta.jp}</span>ï¼‰</p>
      <div style="margin:6px 0">
        ${badgeHTML('äº”è¡Œ', meta.element)}
        ${badgeHTML('è‰²å½©', meta.color)}
        ${badgeHTML('å…³é”®è¯', meta.kw.join(' / '))}
      </div>
      <div class="muted" style="margin-top:8px">${about}</div>
    `;
  }

  // æ¸²æŸ“ã€Œå…è´¹ç®€æŠ¥ã€
  function renderFreeSummary(n) {
    if (!n) return;
    const name = t(`ks_${n}_name`);
    const about = t(`ks_${n}_about`);
    const meta = STARS_META[n];
    const dirs = basicLuckyDirsByElement(meta.element);

    const result = $('result') || (()=>{
      const sec = document.createElement('section');
      sec.id = 'result'; sec.style.display='block';
      (document.querySelector('main.container') || document.querySelector('main') || document.body).appendChild(sec);
      return sec;
    })();

    let free = $('ks-free');
    if (!free) {
      free = document.createElement('div');
      free.id = 'ks-free';
      free.className = 'card';
      result.appendChild(free);
    }

    const sec = (title, body) => `
      <div class="sec">
        <h3 style="margin:0 0 6px;color:#f2d27a;font-size:1.05rem">${title}</h3>
        <div class="ai-content" style="white-space:pre-wrap;line-height:1.7">${body}</div>
      </div>`;

    free.innerHTML = `
      <div class="h2">${t('rpt_free_title')}</div>
      ${sec(t('ks_sec_overview_title'),
        `â€¢ ${name}ï½œ${meta.jp}\nâ€¢ äº”è¡Œï¼š${meta.element}\nâ€¢ å…³é”®è¯ï¼š${meta.kw.join(' / ')}\nâ€¢ ç®€è¿°ï¼š${about}`
      )}
      ${sec(t('ks_sec_dirs_title'),
        `â€¢ åŸºç¡€å‰æ–¹ï¼š${dirs.join(' / ') || '-' }`
      )}
      ${sec(t('ks_sec_colors_title'),
        `â€¢ å‰è‰²ï¼š${meta.color}`
      )}
      ${sec(t('ks_sec_timing_title'),
        `â€¢ ${t('ks_tip_travel')}\nâ€¢ ${t('ks_tip_move')}\nâ€¢ ${t('ks_tip_daily')}`
      )}
    `;
  }

  /* ========================= Butlerï¼ˆä¸ Bazi åŒæ¬¾èŠ¯ç‰‡ä½“éªŒï¼‰ ========================= */

  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese',
    'en':'English',
    'ja':'Japanese',
    'th':'Thai',
    'ms':'Malay'
  };
  function buildButlerSystemPrompt(lang) {
    const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    return [
      `You are a concise Nine Star Ki advisor. Reply in ${ln}.`,
      `Constraints:`,
      `- Use short paragraphs and bullets; be concrete and actionable.`,
      `- Avoid deterministic predictions; frame as tendencies and practical tips.`,
      `- Mirror the user's language tone (warm, professional).`
    ].join('\n');
  }
  function buildButlerUserPrompt(starNum, topic) {
    const ln = BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese';
    const meta = STARS_META[starNum] || {};
    const name = t(`ks_${starNum}_name`) || '';
    const about = t(`ks_${starNum}_about`) || '';
    const dirs = basicLuckyDirsByElement(meta.element).join(' / ') || '-';

    const lines = [
      `Nine Star Ki summary:`,
      `Main Star: ${name} (${meta.jp||''}); Element: ${meta.element||''}`,
      `Keywords: ${(meta.kw||[]).join(', ')}`,
      `Base lucky directions: ${dirs}; Lucky colors: ${meta.color||''}`,
      `About: ${about}`,
      ``,
      `Task: ${topic}`,
      `Language: ${ln}. Reply ONLY in ${ln}.`
    ];
    return lines.join('\n');
  }

  function ensureAiCard() {
    const target = $('result') || document.querySelector('#rich-report') || document.querySelector('main') || document.body;
    if (!target) return;
    let card = $('aiCard');
    if (card) return;

    const sec = document.createElement('div');
    sec.className = 'sec';
    sec.id = 'aiCard';
    sec.innerHTML = `
      <h3 id="butlerTitle">${t('butler_title')}</h3>
      <div id="aiContent" class="ai-content">
        <div class="skeleton">
          <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:60%"></div>
          <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:80%"></div>
          <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:70%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px"></div>
    `;
    target.appendChild(sec);
    renderChips();
  }

  function renderChips() {
    const wrap = $('aiChips'); if (!wrap) return;
    const items = [
      { k: 'chip_career', q: 'q_career' },
      { k: 'chip_love',   q: 'q_love'   },
      { k: 'chip_money',  q: 'q_money'  },
      { k: 'chip_list',   q: 'q_list'   },
      { k: 'chip_30d',    q: 'q_30d'    }
    ];
    wrap.innerHTML = '';
    items.forEach(it => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.style.cssText = 'padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer';
      btn.textContent = t(it.k);
      btn.dataset.q = t(it.q);
      btn.addEventListener('click', () => {
        const topic = btn.dataset.q || '';
        askButler(topic);
      });
      wrap.appendChild(btn);
    });
  }

  async function askButler(topic) {
    ensureAiCard();
    const out = $('aiContent');
    if (out) out.innerHTML = `<div class="skeleton">
      <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:60%"></div>
      <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:80%"></div>
      <div style="height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite;width:70%"></div>
    </div>`;

    const lang = getLang();
    const sys = buildButlerSystemPrompt(lang);
    const star = window.__ks_state__?.starNum || 1;
    const user = buildButlerUserPrompt(star, topic || t('q_career'));

    try {
      const r = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ messages: [
          { role:'system', content: sys },
          { role:'user',   content: user }
        ]})
      });
      const data = await r.json().catch(()=> ({}));
      let text = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      if (!text) text = (lang.startsWith('zh') ? 'æŠ±æ­‰ï¼Œæš‚æ—¶æ²¡æœ‰ç”Ÿæˆåˆ°å†…å®¹ã€‚' : 'Sorry, no content generated.');
      out.innerHTML = mdToHtml(text);
    } catch {
      out && (out.textContent = lang.startsWith('zh') ? 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚' : 'Network error. Try again later.');
    }
  }

  function mdToHtml(md) {
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'â€¢ $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }

  /* ========================= äº¤äº’é€»è¾‘ ========================= */

  // é¢„è®¾é—®é¢˜ â†’ è¿½åŠ åˆ° #question
  (function hookPreset() {
    const sel = $('presetQ');
    if (!sel) return;
    sel.addEventListener('change', e => {
      const idx = sel.selectedIndex;
      if (idx > 0) {
        const text = sel.options[idx].textContent.trim();
        const q = $('question');
        if (q) q.value = q.value ? (q.value + '\n' + text) : text;
      }
    });
  })();

  // æ¸…ç©º
  (function hookClear() {
    const btn = $('clear');
    if (!btn) return;
    btn.addEventListener('click', () => {
      const bd = $('birthdate'); bd && (bd.value = '');
      const q = $('question');  q && (q.value = '');
      const p = $('presetQ');   p && (p.value = '');
      const t = $('topic');     t && (t.value = 'love');
      const sc = $('starCard'); sc && (sc.style.display = 'none');
      const res = $('result');  if (res) res.style.display = 'none';
      window.__ks_state__ = null;
    });
  })();

  // ç”Ÿæˆï¼ˆå…¼å®¹ #go ä¸ #genBtnï¼‰
  const triggerBtn = $('go') || $('genBtn');
  if (triggerBtn) {
    triggerBtn.addEventListener('click', async () => {
      const date = ($('birthdate')?.value || '').trim();
      if (!date) { alert(t('err_birth_required')); return; }
      const star = calcHonmeiStar(date);
      if (!star) { alert(t('err_calc_failed')); return; }

      // è®°å½•ä¸æ¸²æŸ“
      window.__ks_state__ = { starNum: star, date };
      const result = $('result'); if (result) result.style.display = 'block';
      renderStarCard(star);
      renderFreeSummary(star);

      // Butler é»˜è®¤ç»™â€œäº‹ä¸šâ€å»ºè®®
      ensureAiCard();
      $('butlerTitle') && ( $('butlerTitle').textContent = t('butler_title') );
      renderChips();
      askButler(t('q_career'));
    });
  }

  // è¯­è¨€åˆ‡æ¢ï¼šä¸ Bazi é¡µä¸€è‡´
  (function initLangUI() {
    const sel = $('langSelect');
    if (!sel) return;
    sel.value = getLang();
    document.documentElement.lang = getLang();
    applyI18n();

    sel.addEventListener('change', () => {
      setLang(sel.value);
      applyI18n();
      // é‡ç»˜ä¹æ˜Ÿç»“æœ
      const star = window.__ks_state__?.starNum;
      if (star) {
        renderStarCard(star);
        renderFreeSummary(star);
      }
      // åˆ·æ–° Butler æ ‡é¢˜ä¸èŠ¯ç‰‡æ–‡æ¡ˆ
      const titleEl = $('butlerTitle'); if (titleEl) titleEl.textContent = t('butler_title');
      renderChips();
    });
  })();

  // åˆæ¬¡è¿›å…¥ä¹Ÿåº”ç”¨è¯­è¨€
  document.documentElement.lang = getLang();
  applyI18n();

  /* ========================= ç»“æŸ ========================= */
})();
</script>
</body>
</html>
  
