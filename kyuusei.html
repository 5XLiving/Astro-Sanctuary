
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">九星气学 · 5XLiving</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat, linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:url('assets/images/gate.jpg') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
    header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .title{font-family:"Noto Serif SC",serif;font-weight:700;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:.9rem}
    .lang{display:flex;align-items:center;gap:8px}
    .lang select{
      appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:10px 34px 10px 12px;font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
    }

    .section{margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .h2{font-size:1.2rem;margin:0 0 12px;font-weight:800;color:#ffe084;display:flex;gap:8px;align-items:center}
    .h2::before{content:"";width:4px;height:18px;background:var(--brand);border-radius:2px}

    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}

    input,select{
      width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);
      padding:12px 12px;font-size:15px;outline:none;
    }
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(230,199,110,.5)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}
    .btn.block{display:block;width:100%}

    .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
    .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
    .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
    .error-message{background:rgba(255,90,95,.1);border:1px solid #ff5a5f;border-radius:8px;padding:10px;display:none}
    .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
    .muted{color:var(--muted)}

    /* —— 出生时间：时间输入 + “不详”同一行 —— */
    .time-row{display:flex;align-items:center;gap:10px}
    .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
    .btn-mini{padding:8px 10px;border-radius:10px}
    /* —— 隐藏“估时间”按钮：仅勾选不详时弹窗 —— */
    #guessTimeBtn{display:none !important; visibility:hidden !important;}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-fab, .ss-chat-panel { display: none !important; }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}

    /* 聊天输入行：输入框撑满、按钮按内容自适应 */
    .ss-chat-input{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px; border-top:1px solid #243244;
   }
    .ss-chat-input input{
    flex:1 1 auto; min-width:0;
   }
    .ss-chat-input .btn,
    .ss-chat-input button{
    flex:0 0 auto;
    width:auto !important;
    white-space:nowrap;
    padding:10px 14px;
   }

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:var(--text);cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    /* 修复：Grid 子项允许收缩，避免内容把面板撑破 */
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* 让会员按钮在窄宽度下能换行、居中且不溢出 */
    .panel .body .btn {
      display: flex;               /* 改为 flex 更稳 */
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: normal;         /* 允许换行 */
      line-height: 1.2;
      word-break: break-word;      /* 多语言/长词可断行 */
    }

/* 块级按钮确保占满容器且不超出 */
.btn.block { display:block; width:100%; box-sizing:border-box; }

/* 可选：如果仍有轻微位移，限制溢出 */
.panel .body { overflow: hidden; }

.panel .body .btn { padding: 10px 14px; }    
    /* === 表单网格：大屏 3 列，窄屏 1 列 === */
.row{display:grid;gap:12px;grid-template-columns:1fr;}        /* 默认 1 列 */
.row > *{min-width:0;}                                         /* 防止子项把容器撑爆 */
@media (min-width:760px){
  .row.cols-3{grid-template-columns:1fr 1fr 1fr;}              /* 三列 */
}

/* 标签更紧凑 */
label.muted{display:block;margin-bottom:4px}

/* 按钮不要 100% 宽 */
#genBtn{width:auto !important}
.gen-wrap{display:flex;align-items:flex-end;justify-content:flex-end}

/* 时间输入与“不详”并排、紧凑 */
.time-row{display:flex;align-items:center;gap:10px}
.time-row input[type="time"]{
  width:auto !important; flex:0 0 160px; min-width:140px;
}
.time-row .time-unknown{white-space:nowrap}
    .title a{ color: inherit; text-decoration: none; }
.title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    /* —— 统一头部 —— */
.site-header{
  position:sticky; top:0; z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}

/* 品牌区：徽章 + 标题 */
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}

/* 语言选择：防止“语言”竖排、与第一张一致 */
.lang{display:flex; align-items:center; gap:8px}
.lang label{white-space:nowrap; color:var(--muted); margin-right:4px}
.lang select{
  appearance:none; min-width:170px;
  border-radius:10px; border:1px solid #243244;
  background:#0e1520; color:var(--text);
  padding:10px 34px 10px 12px; font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
}

@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
/* 与 Index 保持一致的根字号（会影响 rem 计算） */
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }

/* 标题用 Noto Serif SC；字号/字重与 Index 完全一致 */
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}    

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}  

        /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:var(--gold2);font-size:1.05rem}
    .report p,.report li{line-height:1.7}
  
    .sr-only{
      position:absolute !important;
      width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }        
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">
        5xLiving · <span data-i18n="title_kyuusei_brief">九星气学</span>
      </span>
    </a>

    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <div class="card">
    <div class="h2" data-i18n="form_title">九星气学 · 快速解读</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" style="margin-top:6px" data-i18n="solar_tip">提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。</div>
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">主题</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">爱情/关系</option>
          <option value="career" data-i18n="topic_career">事业/工作</option>
          <option value="wealth" data-i18n="topic_wealth">财富/投资</option>
          <option value="family" data-i18n="topic_family">家庭/人际</option>
          <option value="health" data-i18n="topic_health">健康/身心</option>
          <option value="study" data-i18n="topic_study">学业/成长</option>
          <option value="move"  data-i18n="topic_move">旅行/搬迁</option>
          <option value="other" data-i18n="topic_other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="preset_label">常用问题</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">（可选）选择一个模板</option>
          <option data-i18n="preset_1">她/他爱我吗？我们接下来怎么走更好？</option>
          <option data-i18n="preset_2">我是否应该换工作/创业？需要注意什么？</option>
          <option data-i18n="preset_3">近期在投资与理财上，应如何取舍？</option>
          <option data-i18n="preset_4">如何改善与家人的关系与沟通？</option>
          <option data-i18n="preset_5">我最近健康/情绪的关键提醒是什么？</option>
        </select>
      </div>
    </div>
    <div class="row cols-1" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="q_label">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。"></textarea>
      </div>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">生成分析</button></div>
      <div><button id="clear" class="btn" style="background:#101826;color:#ffe084;border-color:#3a3f47" data-i18n="btn_clear">清空</button></div>
    </div>
  </div>

  <!-- 结果：主星 -->
  <div id="starCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_star">您的九星主星</div>
    <p><span data-i18n="star_label">主星</span>：<b id="starName"></b>（<span id="starJP"></span>）</p>
    <div id="starBadges" style="margin:6px 0"></div>
    <div id="starAbout" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 结果：AI 解读 -->
  <div id="aiCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_ai">心怜管家解读与建议</div>
    <pre id="aiText" style="white-space:pre-wrap;line-height:1.7"></pre>
    <div id="aiReco" style="margin-top:10px"></div>
  </div>

<!-- 会员专区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <!-- 左侧：输入 + 注册/登录 -->
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
       <div class="row" id="authFields">
         <!-- 登录/注册建议用 username，密码管理器更容易配对 -->
         <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
         <input
            id="email"
            name="email"
            type="email"
            inputmode="email"
            autocomplete="username"
            placeholder=""
            data-i18n-ph="ph_email"
            required
         />
         <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
         <input
            id="password"
            name="password"
            type="password"
            autocomplete="current-password"
            placeholder="密码 Password（至少8位，含大小写数字符号）"
            data-i18n-ph="ph_password"
            required
         />
       </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <!-- 右侧：会员与返回 -->
          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <!-- 估时间弹窗 -->
  <div class="tw-mask" id="twMask" aria-hidden="true">
    <div class="tw-box" role="dialog" aria-modal="true" aria-labelledby="twTitle">
      <div class="tw-head" id="twTitle">🧭 估一个大致出生时间</div>
      <div class="tw-body">
        <div class="muted" style="margin-bottom:8px">选择你记得的<strong>大概时段</strong>（地支双小时段）</div>
        <div class="tw-grid" id="twGrid"></div>
        <div class="muted" style="margin-top:10px;font-size:.9em">
          选择后点“填入时间”，会用该时段的中位时间写到上方时间输入框，并自动取消“时间不详”。
        </div>
      </div>
      <div class="tw-foot">
        <button class="btn ghost" id="twCancel" type="button">取消</button>
        <button class="btn" id="twApply" type="button" disabled>填入时间</button>
      </div>
    </div>
  </div>

<script>
/* ===== 配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers
const LANG_KEY = "site_lang";

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

/* ===== i18n 词库（精简示例；其他语言缺失时回退到中文） ===== */
const i18n = {
  "zh-CN": {
    title:"九星气学 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
    form_title:"九星气学 · 快速解读", birth_label:"出生日期",
    solar_tip:"提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。",
    topic_label:"主题",
    topic_love:"爱情/关系", topic_career:"事业/工作", topic_wealth:"财富/投资",
    topic_family:"家庭/人际", topic_health:"健康/身心", topic_study:"学业/成长",
    topic_move:"旅行/搬迁", topic_other:"其他",
    preset_label:"常用问题", preset_none:"（可选）选择一个模板",
    preset_1:"她/他爱我吗？我们接下来怎么走更好？",
    preset_2:"我是否应该换工作/创业？需要注意什么？",
    preset_3:"近期在投资与理财上，应如何取舍？",
    preset_4:"如何改善与家人的关系与沟通？",
    preset_5:"我最近健康/情绪的关键提醒是什么？",
    q_label:"你的具体问题（可直接粘贴）",
    q_ph:"例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。",
    btn_gen:"生成分析", btn_clear:"清空",
    sec_star:"您的九星主星", star_label:"主星",
    badge_elem:"五行", badge_color:"色", badge_kw:"关键词",
    about_label:"性格倾向", sec_ai:"心怜管家解读与建议",
    chat_fab:"问", chat_title:"心怜管家 · Chat", chat_ph:"想了解什么？（如：如何开始免费体验）", chat_send:"发送",
    please_birth:"请先选择出生日期", bad_date:"日期格式有误", generating:"正在生成解读…",
    reco_title:"心怜管家推举内容", retry:"抱歉，暂时无法生成，请稍后再试。", neterr:"网络异常，请稍后再试。"

    vip_title: "🌙 会员区域 VIP Segment",
    vip_mingli: "🗝 命理空间专属内容",
    vip_xinlian: "🌙 心怜空间专属内容",
    vip_love: "姻缘方向：恋爱缘分、婚姻走势",
    vip_career: "事业方向：职场发展、创业潜力",
    vip_wealth: "财运方向：财位分析、理财时机",
    vip_pet: "宠物命理：伴侣动物的性格与缘分",
    vip_hepan: "合盘分析：婚期择日、新生择时",
    vip_name: "测名分析：公司名、宝宝名、命名改运",
    vip_fengshui: "财位合盘：住家 / 办公室动线配合",
    vip_record: "灵性记录：照片、梦境、声音、愿望祈祷",
    vip_course: "命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    vip_memorial: "家族纪念系统：亲人灵性纪念 & 延续",
    vip_tasks: "每周能量练习 / 神明仪式任务",
    vip_shop: "能量商城专属折扣 & 御守订制",
    login_title: "💎 登入 VIP 功能",

    chat_fab: "问",
    chat_placeholder: "请问您想了解什么？（如：如何开始免费体验）",
    chat_send: "发送",
    msg_reset_ok: "密码已成功更新，请用新密码重新登入。",

    ph_email: "邮箱 Email",
    ph_password: "密码 Password（至少8位，含大小写数字符号）",
    ph_label_password: "密码 Password",

    title_quickcalc: "八字命理 · 快速排盘",
    title_bazi_brief: "八字简评",
    label_name: "姓名（可选）",
    ph_name: "你的称呼（用于个性化）",
    gender_label: "性别",
    label_calendar: "历法",
    label_birthdate: "出生日期",
    label_birthtime: "出生时间",
    cb_time_unknown: "出生时间不详",
    btn_generate_chart: "生成八字",
    panel_login_head: "账户登录 / 注册",
    panel_member_head: "会员服务",

    // —— Butler / Report keys（中文） ——
    butler_title: "心怜管家 · 解读",
    day_master: "日主",
    chart_strength: "命局",
    season: "季节",
    wuxing_distribution: "五行分布",
    note: "注意",
    time_unknown_checked: "已勾选“出生时间不详”",
    hour_pillar_excluded: "未纳入时柱",
    hint: "提示",
    no_hour_tip: "无时柱，建议仅作参考。",
    dev_strategy: "发展策略：",
    useful_elements: "喜用元素：",
    lucky_colors: "幸运颜色：",
    lucky_directions: "适合方位：",
    strength_strong: "偏强",
    strength_weak: "偏弱",
    strength_balanced: "平衡",
    desc_strong: "潜力足、抗压好",
    desc_weak: "需外援更能发挥",
    desc_balanced: "均衡、适应性强",
    desc_generic: "具有独特特点",
    season_spring: "木旺生发",
    season_summer: "火旺外放",
    season_autumn: "金旺收敛",
    season_winter: "水旺内藏",
    season_generic: "季节对命局有一定影响",
    el_wood: "木",
    el_fire: "火",
    el_earth: "土",
    el_metal: "金",
    el_water: "水",
    dir_wood: "东方",
    dir_fire: "南方",
    dir_earth: "中央/东北/西南",
    dir_metal: "西方",
    dir_water: "北方",
    color_wood: "绿色/青色",
    color_fire: "红色/紫色",
    color_earth: "黄色/棕色",
    color_metal: "白色/金色",
    color_water: "黑色/蓝色",

    // 报告分段
    rpt_free_title: "免费简报",
    rpt_pillars_label: "四柱",
    rpt_daymaster_label: "日主",
    rpt_season_label: "季节",
    rpt_chart_label: "命局",
    rpt_strategy_label: "策略",
    rpt_wuxing_label: "五行分布",
    rpt_strongest_word: "偏旺",
    rpt_weakest_word: "偏弱",
    rpt_absent_prefix: "缺：",
    rpt_fav_avoid_template: "喜用：{fav}｜忌：{avoid}",
    rpt_balance_focus_label: "调衡要点",
    rpt_time_hint: "提示：出生时间不详，未纳入时柱，仅供参考。",
    rpt_time_unknown: "时间不详",
    rpt_sec_overview_title: "一、命盘总览",
    rpt_sec_elements_title: "二、五行能量分析",
    rpt_sec_traits_title: "三、性格与天赋",
    rpt_traits_intro: "依据日主、季节与强弱给出核心性格标签（模板化占位）。",
    rpt_traits_adv: "优势能量：执行 / 创造 / 学习（模板化占位）。",
    rpt_traits_chal: "潜在挑战：节奏 / 边界 / 过犹不及（模板化占位）。",
    rpt_sec_structure_title: "四、格局与喜忌",
    rpt_structure_line_template: "喜用：{fav}；忌讳：{avoid}",
    rpt_sec_career_title: "五、事业与发展（免费试读）",
    rpt_career_fields_placeholder: "适合领域：结合喜用与气质（模板化占位）。",
    rpt_dev_strategy_prefix: "发展策略：",
    rpt_sec_love_title: "六、感情与关系（免费试读）",
    rpt_love_placeholder: "沟通节奏与边界建议（模板化占位）。",
    rpt_sec_wealth_title: "七、财富与理财（免费试读）",
    rpt_wealth_suggestion_template: "理财建议：以 {fav} 为主调，稳中求进。",
    rpt_sec_health_title: "八、健康与作息",
    rpt_health_placeholder_template: "围绕最弱五行（{weak}）做作息与环境优化（模板化占位）。",
    rpt_sec_env_title: "九、环境与色彩",
    rpt_env_placeholder: "有利方位与配色随喜用（模板化占位）。",
    rpt_strategy_drain: "泄秀/制化",
    rpt_strategy_support: "生扶/补助",
    rpt_strategy_balance: "调和",

    // AI 芯片 & 任务
    chip_career: "事业",
    chip_love: "感情",
    chip_money: "财运",
    chip_list: "今日待办",
    chip_30d: "30天建议",
  },
  "en": {
    title:"Nine Star Ki · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
    form_title:"Nine Star Ki · Quick Reading", birth_label:"Birthdate",
    solar_tip:"Tip: Ki year switches at Setsubun (~Feb 4). Birthdays on Jan 1–Feb 3 belong to the previous year.",
    topic_label:"Topic",
    topic_love:"Love/Relationship", topic_career:"Career/Work", topic_wealth:"Wealth/Investment",
    topic_family:"Family/Social", topic_health:"Health/Mind-Body", topic_study:"Study/Growth",
    topic_move:"Travel/Move", topic_other:"Other",
    preset_label:"Quick Questions", preset_none:"(Optional) Choose a template",
    preset_1:"Does she/he love me? What’s the best next move?",
    preset_2:"Should I change job/start a business? What to watch out for?",
    preset_3:"How should I decide on investing/finances recently?",
    preset_4:"How to improve communication with family?",
    preset_5:"What are the key reminders for my health/emotions now?",
    q_label:"Your specific question (paste here)", q_ph:"e.g. Today’s topic: “Does she love me?” Please give clear next steps and pitfalls.",
    btn_gen:"Generate Reading", btn_clear:"Clear",
    sec_star:"Your Main Star", star_label:"Main Star",
    badge_elem:"Element", badge_color:"Color", badge_kw:"Keywords",
    about_label:"Tendencies", sec_ai:"Concierge Reading & Advice",
    chat_fab:"Chat", chat_title:"Concierge · Chat", chat_ph:"Ask me anything (e.g., how to start a free trial)", chat_send:"Send",
    please_birth:"Please select your birthdate", bad_date:"Invalid date", generating:"Generating reading…",
    reco_title:"Concierge Recommendations", retry:"Sorry, couldn’t generate for now.", neterr:"Network error. Try again later."
    vip_title: "🌙 VIP Segment",
    vip_mingli: "🗝 Astro Sanctuary · Exclusive",
    vip_xinlian: "🌙 Soul Sanctuary · Exclusive",
    vip_love: "Love: Dating Fate, Marriage Trend",
    vip_career: "Career: Workplace, Entrepreneurship",
    vip_wealth: "Wealth: Wealth Position, Timing",
    vip_pet: "Pet Destiny: Temperament & Bond",
    vip_hepan: "Synastry: Wedding Dates, Birthtime",
    vip_name: "Name Reading: Company/Baby/Renaming",
    vip_fengshui: "Wealth & Layout: Home / Office",
    vip_record: "Spiritual Logs: Photos, Dreams, Voice, Prayers",
    vip_course: "Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
    vip_memorial: "Family Memorial: Spiritual Archive & Legacy",
    vip_tasks: "Weekly Energy Practices / Divine Ritual Tasks",
    vip_shop: "Store Discounts & Omamori",
    login_title: "💎 VIP Login",

    chat_fab: "Chat",
    chat_placeholder: "What would you like to know? (e.g., how to start the free trial)",
    chat_send: "Send",
    msg_reset_ok: "Password updated. Please log in with the new one.",

    ph_email: "Email",
    ph_password: "Password (8+, upper/lower/digit/symbol)",
    ph_label_password:"Password",

    title_quickcalc: "Bazi · Quick Chart",
    title_bazi_brief: "Bazi Quick Reading",
    label_name: "Name (optional)",
    ph_name: "Your name (for personalization)",
    gender_label: "Gender",
    label_calendar: "Calendar",
    label_birthdate: "Birth Date",
    label_birthtime: "Birth Time",
    cb_time_unknown: "Birth time unknown",
    btn_generate_chart: "Generate Chart",
    panel_login_head: "Account Login / Sign-up",
    panel_member_head: "Membership Services",

    opt_gender_confidential: "Confidential",
    opt_gender_male: "Male",
    opt_gender_female: "Female",
    opt_cal_gregorian: "Gregorian",
    opt_cal_lunar: "Lunar",

    elements_balance_tpl: "Strongest: {max} · Weakest: {min}",

    // —— Butler / Report keys（English） ——
    butler_title: "Xinlian Butler · Insight",
    day_master: "Day Master",
    chart_strength: "Chart Strength",
    season: "Season",
    wuxing_distribution: "Five Elements",
    note: "Note",
    time_unknown_checked: "“Birth time unknown” is checked",
    hour_pillar_excluded: "Hour pillar not included",
    hint: "Hint",
    no_hour_tip: "No hour pillar — treat as reference only.",
    dev_strategy: "Development strategy: ",
    useful_elements: "Favorable elements: ",
    lucky_colors: "Lucky colors: ",
    lucky_directions: "Lucky directions: ",
    strength_strong: "Strong-leaning",
    strength_weak: "Weak-leaning",
    strength_balanced: "Balanced",
    desc_strong: "High potential and stress-tolerant",
    desc_weak: "Works better with external support",
    desc_balanced: "Well-balanced and adaptable",
    desc_generic: "Has unique characteristics",
    season_spring: "Wood thrives; outward growth",
    season_summer: "Fire thrives; expression/outflow",
    season_autumn: "Metal thrives; organize/refine",
    season_winter: "Water thrives; conserve/reflect",
    season_generic: "Seasonal qi has some influence",
    el_wood: "Wood",
    el_fire: "Fire",
    el_earth: "Earth",
    el_metal: "Metal",
    el_water: "Water",
    dir_wood: "East",
    dir_fire: "South",
    dir_earth: "Center/NE/SW",
    dir_metal: "West",
    dir_water: "North",
    color_wood: "Green/Teal",
    color_fire: "Red/Purple",
    color_earth: "Yellow/Brown",
    color_metal: "White/Gold",
    color_water: "Black/Blue",

    rpt_free_title: "Free Summary",
    rpt_pillars_label: "Pillars",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "Season",
    rpt_chart_label: "Chart",
    rpt_strategy_label: "Strategy",
    rpt_wuxing_label: "Five Elements",
    rpt_strongest_word: "strongest",
    rpt_weakest_word: "weakest",
    rpt_absent_prefix: "Absent: ",
    rpt_fav_avoid_template: "Favorable: {fav} | Avoid: {avoid}",
    rpt_balance_focus_label: "Balance focus",
    rpt_time_hint: "Note: birth time unknown; hour pillar excluded—use as reference only.",
    rpt_time_unknown: "Unknown time",
    rpt_sec_overview_title: "1) Overview",
    rpt_sec_elements_title: "2) Element Analysis",
    rpt_sec_traits_title: "3) Traits & Talents",
    rpt_traits_intro: "Core trait tags based on DM, season, and strength (placeholder).",
    rpt_traits_adv: "Advantages: Execution / Creativity / Learning (placeholder).",
    rpt_traits_chal: "Challenges: Pace / Boundaries (placeholder).",
    rpt_sec_structure_title: "4) Structure & Preferences",
    rpt_structure_line_template: "Favorable: {fav}; Avoid: {avoid}",
    rpt_sec_career_title: "5) Career (sample)",
    rpt_career_fields_placeholder: "Suitable fields (placeholder).",
    rpt_dev_strategy_prefix: "Development strategy: ",
    rpt_sec_love_title: "6) Love (sample)",
    rpt_love_placeholder: "Communication pace & boundaries (placeholder).",
    rpt_sec_wealth_title: "7) Wealth (sample)",
    rpt_wealth_suggestion_template: "Wealth tip: prefer flows aligned with {fav}.",
    rpt_sec_health_title: "8) Health",
    rpt_health_placeholder_template: "Care for weakest element: {weak}.",
    rpt_sec_env_title: "9) Environment & Colors",
    rpt_env_placeholder: "Favorable directions & palette follow your favorable elements.",
    rpt_strategy_drain: "Drain/Control",
    rpt_strategy_support: "Support/Nourish",
    rpt_strategy_balance: "Balance",

    chip_career: "Career",
    chip_love: "Love",
    chip_money: "Wealth",
    chip_list: "Today's To-Dos",
    chip_30d: "30-Day Plan",
  },
  "ms": {
    title:"Nine Star Ki · 5XLiving", brand:"Soul Sanctuary", lang_label:"Bahasa",
    form_title:"Ringkasan Nine Star Ki", birth_label:"Tarikh lahir",
    solar_tip:"Nota: Tahun Ki bertukar pada Setsubun (~4 Feb). Lahir 1/1–3/2 dikira tahun sebelumnya.",
    topic_label:"Topik",
    topic_love:"Cinta/Hubungan", topic_career:"Kerjaya", topic_wealth:"Kewangan/Investasi",
    topic_family:"Keluarga/Sosial", topic_health:"Kesihatan", topic_study:"Pembelajaran",
    topic_move:"Perjalanan/Pindah", topic_other:"Lain-lain",
    preset_label:"Soalan Pantas", preset_none:"(Pilihan) Pilih templat",
    preset_1:"Adakah dia mencintai saya? Langkah seterusnya?",
    preset_2:"Patut tukar kerja/memulakan bisnes? Apa yang perlu berjaga?",
    preset_3:"Bagaimana membuat keputusan pelaburan/ kewangan kini?",
    preset_4:"Cara memperbaiki komunikasi keluarga?",
    preset_5:"Peringatan utama kesihatan/emosi saya kini?",
    q_label:"Soalan khusus anda", q_ph:"cth: Topik hari ini: “Adakah dia mencintai saya?” Beri langkah seterusnya & elak perangkap.",
    btn_gen:"Jana Analisis", btn_clear:"Kosongkan",
    sec_star:"Bintang Utama Anda", star_label:"Bintang",
    badge_elem:"Unsur", badge_color:"Warna", badge_kw:"Kata Kunci",
    about_label:"Kecenderungan", sec_ai:"Bacaan & Nasihat Concierge",
    chat_fab:"Tanya", chat_title:"Concierge · Sembang", chat_ph:"Tanya apa-apa", chat_send:"Hantar",
    please_birth:"Sila pilih tarikh lahir", bad_date:"Tarikh tidak sah", generating:"Menjana bacaan…",
    reco_title:"Cadangan Concierge", retry:"Maaf, gagal jana buat masa ini.", neterr:"Ralat rangkaian."
    vip_title: "🌙 Segmen VIP",
    vip_mingli: "🗝 Ruang Astro · Eksklusif",
    vip_xinlian: "🌙 Soul Sanctuary · Eksklusif",
    vip_love: "Cinta: Jodoh & Arah Perkahwinan",
    vip_career: "Kerjaya: Perkembangan & Usahawan",
    vip_wealth: "Kekayaan: Kedudukan Harta & Masa",
    vip_pet: "Nasib Haiwan: Perangai & Ikatan",
    vip_hepan: "Keserasian: Tarikh Nikah, Waktu Lahir",
    vip_name: "Analisis Nama: Syarikat/Bayi/Penamaan Semula",
    vip_fengshui: "Kedudukan Harta & Susun Atur: Rumah / Pejabat",
    vip_record: "Log Spiritual: Foto, Mimpi, Suara, Doa",
    vip_course: "Kursus: Bazi / Tarot / Astrologi / Nombor / Human Design",
    vip_memorial: "Peringatan Keluarga: Arkib Rohani & Legasi",
    vip_tasks: "Amalan Tenaga Mingguan / Tugas Ritual",
    vip_shop: "Diskaun Kedai & Omamori",
    login_title: "💎 Log Masuk VIP",

    chat_fab: "Chat",
    chat_placeholder: "Apa yang anda mahu tahu? (cth: cara mula percubaan percuma)",
    chat_send: "Hantar",
    msg_reset_ok: "Kata laluan dikemas kini. Log masuk dengan yang baharu.",

    ph_email: "Emel",
    ph_password: "Kata Laluan (8+, huruf besar/kecil/nombor/simbol)",
    ph_label_password: "Kata Laluan",

    title_quickcalc: "Bazi · Carta Pantas",
    title_bazi_brief: "Bazi · Ringkasan",
    label_name: "Nama (pilihan)",
    ph_name: "Nama anda (untuk personalisasi)",
    gender_label: "Jantina",
    label_calendar: "Kalendar",
    label_birthdate: "Tarikh Lahir",
    label_birthtime: "Masa Lahir",
    cb_time_unknown: "Masa lahir tidak diketahui",
    btn_generate_chart: "Jana Carta",
    panel_login_head: "Log Masuk / Daftar Akaun",
    panel_member_head: "Perkhidmatan Keahlian",

    opt_gender_confidential: "Rahsia",
    opt_gender_male: "Lelaki",
    opt_gender_female: "Perempuan",
    opt_cal_gregorian: "Gregorian",
    opt_cal_lunar: "Lunar",

    elements_balance_tpl: "Terkuat: {max} · Terlemah: {min}",

    butler_title: "Xinlian Butler · Insight",
    day_master: "Day Master",
    chart_strength: "Kekuatan Carta",
    season: "Musim",
    wuxing_distribution: "Lima Unsur",
    note: "Nota",
    time_unknown_checked: "“Masa lahir tidak diketahui” dipilih",
    hour_pillar_excluded: "Tiang jam tidak disertakan",
    hint: "Petua",
    no_hour_tip: "Tiada tiang jam — rujukan sahaja.",
    dev_strategy: "Strategi pembangunan: ",
    useful_elements: "Unsur baik: ",
    lucky_colors: "Warna bertuah: ",
    lucky_directions: "Arah bertuah: ",
    strength_strong: "Cenderung kuat",
    strength_weak: "Cenderung lemah",
    strength_balanced: "Seimbang",
    desc_strong: "Potensi tinggi, tahan tekanan",
    desc_weak: "Lebih baik dengan sokongan luar",
    desc_balanced: "Seimbang dan mudah menyesuaikan",
    desc_generic: "Mempunyai ciri tersendiri",
    season_spring: "Kayu kuat; pertumbuhan",
    season_summer: "Api kuat; ekspresi",
    season_autumn: "Logam kuat; pengumpulan/penyusunan",
    season_winter: "Air kuat; penjimatan/refleksi",
    season_generic: "Tenaga musim memberi sedikit pengaruh",
    el_wood: "Kayu",
    el_fire: "Api",
    el_earth: "Tanah",
    el_metal: "Logam",
    el_water: "Air",
    dir_wood: "Timur",
    dir_fire: "Selatan",
    dir_earth: "Tengah/Timur Laut/Barat Daya",
    dir_metal: "Barat",
    dir_water: "Utara",
    color_wood: "Hijau/Teal",
    color_fire: "Merah/Ungu",
    color_earth: "Kuning/Coklat",
    color_metal: "Putih/Emas",
    color_water: "Hitam/Biru",

    rpt_free_title: "Ringkasan Percuma",
    rpt_pillars_label: "Empat Tiang",
    rpt_daymaster_label: "Day Master",
    rpt_season_label: "Musim",
    rpt_chart_label: "Carta",
    rpt_strategy_label: "Strategi",
    rpt_wuxing_label: "Lima Unsur",
    rpt_strongest_word: "paling kuat",
    rpt_weakest_word: "paling lemah",
    rpt_absent_prefix: "Tiada: ",
    rpt_fav_avoid_template: "Unsur baik: {fav} | Elak: {avoid}",
    rpt_balance_focus_label: "Fokus keseimbangan",
    rpt_time_hint: "Nota: masa lahir tidak diketahui; tiang jam dikecualikan — rujukan sahaja.",
    rpt_time_unknown: "Masa tidak diketahui",
    rpt_sec_overview_title: "1) Gambaran Umum",
    rpt_sec_elements_title: "2) Analisis Unsur",
    rpt_sec_traits_title: "3) Sifat & Bakat",
    rpt_traits_intro: "Tag sifat teras berdasarkan DM, musim, dan kekuatan (placeholder).",
    rpt_traits_adv: "Kelebihan: Pelaksanaan / Kreativiti / Pembelajaran (placeholder).",
    rpt_traits_chal: "Cabaran: Tempo / Sempadan / Berlebihan (placeholder).",
    rpt_sec_structure_title: "4) Struktur & Kecenderungan",
    rpt_structure_line_template: "Baik: {fav}; Elak: {avoid}",
    rpt_sec_career_title: "5) Kerjaya (contoh)",
    rpt_career_fields_placeholder: "Bidang yang sesuai (placeholder).",
    rpt_dev_strategy_prefix: "Strategi pembangunan: ",
    rpt_sec_love_title: "6) Cinta (contoh)",
    rpt_love_placeholder: "Tempo komunikasi & sempadan (placeholder).",
    rpt_sec_wealth_title: "7) Kekayaan (contoh)",
    rpt_wealth_suggestion_template: "Tip kekayaan: utamakan aliran yang sejajar dengan {fav}.",
    rpt_sec_health_title: "8) Kesihatan",
    rpt_health_placeholder_template: "Jaga unsur paling lemah: {weak}.",
    rpt_sec_env_title: "9) Persekitaran & Warna",
    rpt_env_placeholder: "Arah & palet yang baik mengikuti unsur pilihan anda.",
    rpt_strategy_drain: "Leraikan/Kawal",
    rpt_strategy_support: "Sokong/Perkuat",
    rpt_strategy_balance: "Seimbangkan",

    chip_career: "Kerjaya",
    chip_love: "Cinta",
    chip_money: "Kewangan",
    chip_list: "Tugas Hari Ini",
    chip_30d: "Pelan 30 Hari",
  }
};

/* 将页面静态文案替换为当前语言 */  
function t(key){
  const L = translations[getLang()] || translations["zh-CN"];
  return L[key] || (translations["zh-CN"][key] || key);
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

/* ================== Butler AI 卡片（芯片/锁定/多语言） ================== */
/* 1) 样式注入 */
(function injectAiStyle(){
  const old=document.getElementById('ai-style'); if(old) old.remove();
  const style=document.createElement('style'); style.id='ai-style';
  style.textContent=`
    .sec h3{margin:0 0 8px;color:var(--brand)}
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .chip:hover{border-color:#f2d27a;box-shadow:0 0 0 2px rgba(242,210,122,.15) inset}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  `;
  document.head.appendChild(style);
})();

/* 2) 工具函数 */
function mdToHtml(md){
  return (md||'')
    .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
    .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    .replace(/\n{2,}/g,'\n\n')
    .replace(/\n/g,'<br/>');
}
function isVIP(){
  return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
}

/* 3) 卡片挂载 & 芯片 */
function ensureAiCard(){
  const target =
    document.getElementById('butler-host') ||
    document.getElementById('rich-report') ||
    document.getElementById('result');
  if (!target) return;

  let card = document.getElementById('aiCard');
  if (card) {
    // 若已存在但位置不对，搬到 target，确保排在报告之后
    if (card.parentElement !== target) target.appendChild(card);
    return;
  }

  // 首次创建
  const sec = document.createElement('div');
  sec.className = 'sec';
  sec.id = 'aiCard';
  sec.innerHTML = `
    <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')||'心怜管家 · 解读'}</h3>
    <div id="aiContent" class="ai-content">
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>
    </div>
    <div class="chips" id="aiChips"></div>
  `;
  target.appendChild(sec);
  renderChips();
}  
  
/* ===== Chat 浮窗 ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      let data={}; try{data=await r.json()}catch{}
      const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||t('retry'));
    }catch{ addMsg(t('neterr')); }
  }
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();

/* ===== 九星算法（节分 2/4 换年） ===== */
function reduce1(n){let s=Math.abs(n).toString().split('').reduce((a,b)=>a+Number(b),0);while(s>9)s=s.toString().split('').reduce((a,b)=>a+Number(b),0);return s;}
function isBeforeSetsubun(d){const m=d.getMonth(),day=d.getDate();return (m===0)||(m===1&&day<=3);}
function calcHonmei(dateStr){const d=new Date(dateStr);if(isNaN(d))return null;const root=reduce1(d.getFullYear());let num=(isBeforeSetsubun(d)?12:11)-root;while(num<=0)num+=9;return num;}

/* ===== 九星词典（基础画像） ===== */
const STARS={
  1:{zh:'一白水星',jp:'Ippaku Suisei',elem:{zh:'水',en:'Water',ms:'Air'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['流动','直觉','沟通'],en:['Flow','Intuition','Communication'],ms:['Alir','Intuisi','Komunikasi']},about:{zh:'敏感细腻、共情力强，行动灵活，擅长信息与关系协调。',en:'Sensitive and empathic; agile; great at information & relationship alignment.',ms:'Peka & berempati; lincah; bagus penyelarasan maklumat & hubungan.'}},
  2:{zh:'二黑土星',jp:'Jikoku Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'黑',en:'Black',ms:'Hitam'},key:{zh:['滋养','承载','耐性'],en:['Nourish','Support','Patience'],ms:['Membaja','Menyokong','Sabar']},about:{zh:'务实稳健、重视秩序与照料，擅长持续耕耘与落地。',en:'Practical and steady; values order & care; good at steady execution.',ms:'Praktikal & stabil; nilai tertib & penjagaan; baik pelaksanaan berterusan.'}},
  3:{zh:'三碧木星',jp:'Sanpeki Mokusei',elem:{zh:'木',en:'Wood',ms:'Kayu'},color:{zh:'碧',en:'Cyan',ms:'Biru Hijau'},key:{zh:['生发','表达','突破'],en:['Growth','Expression','Breakthrough'],ms:['Tumbuh','Ekspresi','Terobosan']},about:{zh:'好奇表达欲强，喜欢创意与开疆拓土。',en:'Curious and expressive; loves creativity & pioneering.',ms:'Ingin tahu & ekspresif; suka kreativiti & perintis.'}},
  4:{zh:'四绿木星',jp:'Shiroku Mokusei',elem:{zh:'木',en:'Wood',ms:'Kayu'},color:{zh:'绿',en:'Green',ms:'Hijau'},key:{zh:['交流','学习','旅行'],en:['Exchange','Learning','Travel'],ms:['Interaksi','Belajar','Perjalanan']},about:{zh:'温和包容、擅长倾听与知识整合，适合教育与协作。',en:'Gentle & inclusive; great at listening & integrating knowledge; good for education & collaboration.',ms:'Lunak & inklusif; mahir mendengar & integrasi ilmu; sesuai pendidikan & kolaborasi.'}},
  5:{zh:'五黄土星',jp:'Gogou Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'黄',en:'Yellow',ms:'Kuning'},key:{zh:['中宫','权衡','重启'],en:['Center','Weighing','Reset'],ms:['Pusat','Menimbang','Set Semula']},about:{zh:'居中定盘、抗压强，擅长策略与危机管理。',en:'Centering & resilient; skilled at strategy & crisis management.',ms:'Memusat & tahan tekanan; mahir strategi & pengurusan krisis.'}},
  6:{zh:'六白金星',jp:'Roppaku Kinsei',elem:{zh:'金',en:'Metal',ms:'Logam'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['秩序','领导','远见'],en:['Order','Leadership','Vision'],ms:['Tertib','Kepimpinan','Wawasan']},about:{zh:'自律果断、擅立规则与带队。',en:'Disciplined & decisive; sets rules and leads.',ms:'Berdisiplin & tegas; menetap peraturan & memimpin.'}},
  7:{zh:'七赤金星',jp:'Shichiseki Kinsei',elem:{zh:'金',en:'Metal',ms:'Logam'},color:{zh:'赤',en:'Red',ms:'Merah'},key:{zh:['社交','品味','享受'],en:['Social','Taste','Enjoyment'],ms:['Sosial','Citarasa','Menikmati']},about:{zh:'人缘好、审美在线，擅品牌与社群。',en:'Popular with great taste; good at brand & community.',ms:'Popular & citarasa baik; hebat jenama & komuniti.'}},
  8:{zh:'八白土星',jp:'Happaku Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['积累','转折','定山'],en:['Accumulate','Turn','Stability'],ms:['Kumpul','Pusingan','Stabil']},about:{zh:'稳中求变、厚积薄发，关键时刻能翻盘。',en:'Stable yet transformative; turns tides after accumulation.',ms:'Stabil namun berubah; bangkit selepas pengumpulan.'}},
  9:{zh:'九紫火星',jp:'Kyūshi Kasei',elem:{zh:'火',en:'Fire',ms:'Api'},color:{zh:'紫',en:'Purple',ms:'Ungu'},key:{zh:['光彩','灵感','传播'],en:['Radiance','Inspiration','Broadcast'],ms:['Cahaya','Inspirasi','Sebar']},about:{zh:'热情外放、灵感多，适合登台表达与IP打造。',en:'Passionate & radiant; good for stage & IP building.',ms:'Bersemangat & bersinar; sesuai pentas & bina IP.'}}
};

/* 保存最后一次结果，切语言时用于重绘 */
let __STAR_STATE = null;

/* ===== 渲染主星卡片 ===== */
function renderStar(n){
  const lang = getLang();
  const L = i18n[lang] || i18n["zh-CN"];
  const star = STARS[n]; if(!star) return;

  const name = star[lang==='en'?'en':'zh'] ? star[lang==='en'?'en':'zh'] : star.zh; // 名称主要用中文；可自行扩展多语名
  $('starName').textContent = star.zh; // 中文名保持传统术语
  $('starJP').textContent   = star.jp;

  const elem = star.elem[lang] || star.elem.zh;
  const color= star.color[lang]|| star.color.zh;
  const kws  = (star.key[lang] || star.key.zh).join(' / ');
  const about= star.about[lang] || star.about.zh;

  $('starBadges').innerHTML =
    `<span class="badge">${L.badge_elem}：${elem}</span>`+
    `<span class="badge">${L.badge_color}：${color}</span>`+
    `<span class="badge">${L.badge_kw}：${kws}</span>`;
  $('starAbout').textContent = `${L.about_label}：${about}`;
  $('starCard').style.display='block';
}

/* ===== 组装给 GPT 的提示词 ===== */
function buildPrompt({langName, star, topic, question}){
  const topicMap = {
    "zh-CN": {love:"爱情/关系",career:"事业/工作",wealth:"财富/投资",family:"家庭/人际",health:"健康/身心",study:"学业/成长",move:"旅行/搬迁",other:"其他"},
    "en":    {love:"Love/Relationship",career:"Career/Work",wealth:"Wealth/Investment",family:"Family/Social",health:"Health/Mind-Body",study:"Study/Growth",move:"Travel/Move",other:"Other"},
    "ms":    {love:"Cinta/Hubungan",career:"Kerjaya",wealth:"Kewangan/Investasi",family:"Keluarga/Sosial",health:"Kesihatan",study:"Pembelajaran",move:"Perjalanan/Pindah",other:"Lain-lain"}
  }[getLang()] || {};

  const starText = `主星：${star.zh}（${star.jp}）；五行：${star.elem.zh}；关键词：${star.key.zh.join('、')}。性格：${star.about.zh}`;
  return `你是 5XLiving「心怜管家」与资深九星气学顾问。请使用【${langName}】输出，语气温暖、专业、落地。
用户的主星信息：${starText}
用户主题：${topicMap[topic] || topic}
用户问题：${question || '（无具体问题，请给通用提示）'}

请按以下结构输出（不要加多余前后缀）：
# 核心判断（2-4 句）
# 现在要做的事（列 3 条，动词开头）
# 避坑提醒（列 2-3 条）
# 可尝试的灵性练习（从冥想/manifestation/书写愿望/仪式中给 2-3 条，给操作要点）
# AI 推举内容（列 3-5 条，结合本网站：如预约一对一、加入 VIP、许愿包/御守、课程、把计划存入心怜笔记等）`;
}

/* ===== 请求 AI ===== */
async function askAI(prompt){
  const resp = await fetch(`${API_BASE}/api/chat`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[
      {role:'system',content:'你将产出结构化的九星气学建议，务必简明清晰、可执行。'},
      {role:'user',content:prompt}
    ]})
  });
  let data={}; try{data=await resp.json()}catch{}
  return data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? '';
}

/* ===== 交互 ===== */
$('presetQ').addEventListener('change',e=>{
  const v=e.target.value; if(v){ const q=$('question'); q.value = q.value? q.value+'\n'+v : v; }
});
$('clear').addEventListener('click',()=>{
  $('birthdate').value=''; $('question').value=''; $('presetQ').value=''; $('topic').value='love';
  $('starCard').style.display='none'; $('aiCard').style.display='none'; __STAR_STATE=null;
});
$('go').addEventListener('click', async ()=>{
  const L = i18n[getLang()]||i18n["zh-CN"];
  const date=$('birthdate').value.trim();
  if(!date){ alert(L.please_birth); return; }
  const n=calcHonmei(date); if(!n){ alert(L.bad_date); return; }
  __STAR_STATE = n; renderStar(n);

  const topic=$('topic').value;
  const question=( $('question').value || $('presetQ').value || '' ).trim();
  const langName = ({'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu'})[getLang()] || '简体中文';
  const prompt=buildPrompt({langName, star:STARS[n], topic, question});

  $('aiText').textContent = L.generating;
  $('aiCard').style.display='block';
  try{
    const txt = await askAI(prompt);
    $('aiText').textContent = txt || L.retry;

    // 从文本里抓“推举/推荐/VIP/许愿/课程/预约/笔记/御守”等做一个列表（尽量温和）
    const recos=[]; (txt||'').split('\n').forEach(l=>{
      if(/推举|推荐|VIP|许愿|课程|预约|御守|笔记|会员/i.test(l)) recos.push(l.trim());
    });
    $('aiReco').innerHTML = recos.length
      ? `<div class="h2">${L.reco_title}</div><ul style="margin:.3rem 0 .2rem .9rem">${recos.slice(0,5).map(x=>`<li>${x}</li>`).join('')}</ul>`
      : '';
  }catch(e){
    $('aiText').textContent = L.neterr;
  }

 // 首次创建
  const sec = document.createElement('div');
  sec.className = 'sec';
  sec.id = 'aiCard';
  sec.innerHTML = `
    <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')||'心怜管家 · 解读'}</h3>
    <div id="aiContent" class="ai-content">
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>
    </div>
    <div class="chips" id="aiChips"></div>
  `;
  target.appendChild(sec);
  renderChips();
}
  
function renderChips(){
  const wrap=document.getElementById('aiChips'); if(!wrap) return;
  wrap.innerHTML='';
  [
    {k:'chip_career',q:'q_career'},
    {k:'chip_love',  q:'q_love'},
    {k:'chip_money', q:'q_money'},
    {k:'chip_list',  q:'q_list'},
    {k:'chip_30d',   q:'q_30d'}
  ].forEach(it=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=t(it.k);
    btn.setAttribute('data-q', t(it.q));
    wrap.appendChild(btn);
  });
}

/* 4) Prompt 生成（多语言） */
const BUTLER_LANG_NAME = {
  'zh-CN':'Simplified Chinese',
  'en':'English',
  'ja':'Japanese',
  'th':'Thai',
  'ms':'Malay'
};
function buildButlerSystemPrompt(lang){
  const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
  return [
    `You are a concise Bazi assistant. Reply in ${ln}.`,
    `Constraints:`,
    `- Use short paragraphs and bullet points; be concrete and actionable.`,
    `- If hour pillar is missing, include a brief caution.`,
    `- Avoid deterministic predictions; frame as tendencies and practical tips.`,
    `- Mirror the user's language tone (polite, warm).`
  ].join('\n');
}
function buildUserPrompt(topic, ctx){
  const {pillars, percents, st, adv, timeUnknown} = ctx || {};

  // 语言名（跟随当前 UI 语言）
  const ln = BUTLER_LANG_NAME[(getLang && getLang()) || 'zh-CN'] || 'Simplified Chinese';

  const E = { wood:t('el_wood'), fire:t('el_fire'), earth:t('el_earth'), metal:t('el_metal'), water:t('el_water') };
  const elemLine = ['wood','fire','earth','metal','water']
    .map(k=>`${E[k]} ${Math.round((percents||{})[k]||0)}%`).join(' · ');
  const fav   = (adv?.useful||[]).join('/');
  const avoid = (adv?.avoid ||[]).join('/');
  const hourTxt = timeUnknown ? t('rpt_time_unknown') : ((pillars?.hour?.stem||'') + (pillars?.hour?.branch||''));

  const lines = [
    `Bazi summary:`,
    `Year ${pillars?.year?.stem||''}${pillars?.year?.branch||''} · Month ${pillars?.month?.stem||''}${pillars?.month?.branch||''} · Day ${pillars?.day?.stem||''}${pillars?.day?.branch||''} · Hour ${hourTxt||''}`,
    `Day Master: ${pillars?.day?.stem||''} (${pillars?.day?.element||''})`,
    `Season: ${st?.season||''}; Strength: ${st?.mark||''}; Strategy: ${st?.focus||''}`,
    `Elements: ${elemLine}`,
    `Favorable: ${fav||'-'}; Avoid: ${avoid||'-'}`,
    timeUnknown ? `Caution: hour pillar excluded.` : ``,
    ``,
    `Task: ${topic}`,
    // 语言强约束（很重要！）
    `Language: ${ln}. Reply ONLY in ${ln}.`,
    `Do not translate previously shown content; generate fresh guidance in ${ln}.`
  ].filter(Boolean);

  return lines.join('\n');
}

/* 5) 请求与渲染 */
async function askAi(topic){
  // 先确保卡片存在，并记录“上一次主题”
  ensureAiCard();
  const card = document.getElementById('aiCard');
  if (card) card.dataset.lastQ = topic;  // 记住最近的主题

  // remember which language this content was generated in
 if (card) card.dataset.lang = (getLang && getLang()) || 'zh-CN';

  // 骨架屏
  const out = document.getElementById('aiContent');
  if (out) {
    out.innerHTML = `
      <div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>`;
  }

  try{
    // 组 Prompt（含语言）
    const ctx  = window.__last_report__ || {};
    const lang = (getLang && getLang()) || 'zh-CN';
    const sys  = buildButlerSystemPrompt(lang);
    const user = buildUserPrompt(topic, ctx);

    const r = await fetch(`${API_BASE}/api/chat`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ messages: [
        { role:'system', content: sys },
        { role:'user',   content: user }
      ]})
    });

    let data; try{ data = await r.json(); }catch{ data = {}; }
    let text = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';

    if(!text){
      text = lang.startsWith('zh')
        ? '抱歉，暂时没有生成到内容，请稍后再试。'
        : 'Sorry, no content generated. Please try again.';
    }

    // 非会员只显示前几行 + 引导
    if(!isVIP()){
      const teaser = text.split('\n').slice(0,6).join('\n');
      out.innerHTML = mdToHtml(teaser) + `
        <div class="ai-lock-overlay">
          <div class="tip">💎 ${t('vip_title') || 'VIP Segment'}</div>
          <div class="sub">${
            lang.startsWith('zh') ? '登录/升级后解锁完整解读' : 'Log in / upgrade to unlock the full guidance.'
          }</div>
        </div>`;
    }else{
      out.innerHTML = mdToHtml(text);
    }
  }catch(e){
    if(out){
      out.innerHTML = (getLang && getLang()).startsWith('zh')
        ? '网络异常或服务繁忙，请稍后重试。'
        : 'Network error or service busy. Please try again later.';
    }
  }
}

/* 6) 与页面交互：芯片点击 & 语言切换 & 排盘完成后挂载 */
document.addEventListener('click', (e)=>{
  const el = e.target;
  if(el && el.classList.contains('chip')){
    const q = el.getAttribute('data-q') || '';
    if(q) askAi(q);
  }
});

function mountExtensionsIntoResult({pillars, percents, st, adv, timeUnknown}){
  const resultEl = document.getElementById('result');
  if (!resultEl) return;

  // 免费报告
  let freeNode = document.getElementById('xl-free-report');
  if (!freeNode) {
    freeNode = document.createElement('div');
    freeNode.id = 'xl-free-report';
    resultEl.appendChild(freeNode);
  }
  freeNode.innerHTML = buildFreeReportHTML({pillars, percents, st, adv, timeUnknown});
} // ←←← 必须有这一行，结束函数

function mountButlerCard(){
  ensureAiCard();
  const aiCard = document.getElementById('aiCard');
  if (aiCard && !aiCard.dataset.autorun) {
    aiCard.dataset.autorun = '1';
    askAi(t('q_career'));  // 默认先给“事业”建议
  }
}

// 语言切换时，仅刷新标题与芯片文案（不自动翻译/重生管家内容）
(function patchRerenderForAi(){
  const _orig = (typeof rerenderReportsIfAny==='function') ? rerenderReportsIfAny : null;

  window.rerenderReportsIfAny = function(){
    if(_orig) _orig();

    // refresh title & chips text
    const titleEl = document.getElementById('butlerTitle');
    if (titleEl) titleEl.textContent = t('butler_title');
    renderChips();

    // if language changed, regenerate Butler with the last topic
    const aiCard = document.getElementById('aiCard');
    const newLang = (getLang && getLang()) || 'zh-CN';
    const lastQ   = (aiCard && aiCard.dataset.lastQ) || t('q_career');

    if (!aiCard) return;

    if (aiCard.dataset.lang !== newLang) {
      aiCard.dataset.lang = newLang;
      askAi(lastQ); // <- regenerate in the new language
      return;
    }

    // If content hasn't been generated yet (still skeleton), generate once
    const out = document.getElementById('aiContent');
    if (out && out.querySelector('.skeleton')) {
      askAi(lastQ);
    }
  };
})();


/* ================== 报告函数最小实现（兜底） ================== */
(function ensureReportFallbacks(){
  if (typeof window.buildFreeReportHTML !== 'function') {
    window.buildFreeReportHTML = function({ pillars, percents, st, adv, timeUnknown } = {}) {
      const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const E = ELABEL();
      const p = percents || {};
      const ym = `${esc(pillars?.year?.stem||'')}${esc(pillars?.year?.branch||'')}`;
      const mm = `${esc(pillars?.month?.stem||'')}${esc(pillars?.month?.branch||'')}`;
      const dm = `${esc(pillars?.day?.stem||'')}${esc(pillars?.day?.branch||'')}`;
      const hm = timeUnknown ? t('rpt_time_unknown') : `${esc(pillars?.hour?.stem||'')}${esc(pillars?.hour?.branch||'')}`;
      const fav = (adv?.useful||[]).join('/'), avoid = (adv?.avoid||[]).join('/');

      return `
        <div class="card">
          <div class="h2">${esc(t('rpt_free_title'))}</div>
          <div>${esc(t('rpt_pillars_label'))}：${ym}｜${mm}｜${dm}｜${hm}</div>
          <div>${esc(t('rpt_daymaster_label'))}：${esc(pillars?.day?.stem||'')}（${esc(pillars?.day?.element||'')}）</div>
          <div>${esc(t('rpt_season_label'))}：${esc(st?.season||'-')} ｜ ${esc(t('rpt_chart_label'))}：${esc(st?.mark||'-')}</div>
          <div style="margin-top:8px">${esc(t('rpt_wuxing_label'))}：${E.wood} ${Math.round(p.wood||0)}% · ${E.fire} ${Math.round(p.fire||0)}% · ${E.earth} ${Math.round(p.earth||0)}% · ${E.metal} ${Math.round(p.metal||0)}% · ${E.water} ${Math.round(p.water||0)}%</div>
          ${timeUnknown ? `<div class="muted" style="margin-top:6px">${esc(t('rpt_time_hint'))}</div>` : ''}
          <div style="margin-top:8px">${esc(t('rpt_fav_avoid_template').replace('{fav}', fav||'-').replace('{avoid}', avoid||'-'))}</div>
        </div>
      `;
    };
  }

  // ✅ 关键：给出“1–9 段”的完整 fallback
  if (typeof window.buildRichReportHTML !== 'function') {
    window.buildRichReportHTML = function({ pillars, percents, st, adv, timeUnknown } = {}) {
      const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const E = ELABEL(); const p = percents || {};
      const kv = [[E.wood,p.wood||0],[E.fire,p.fire||0],[E.earth,p.earth||0],[E.metal,p.metal||0],[E.water,p.water||0]];
      const strongest = kv.reduce((a,b)=> a[1]>=b[1]?a:b)[0];
      const weakest   = kv.reduce((a,b)=> a[1]<=b[1]?a:b)[0];
      const absent    = kv.filter(([,v])=>Math.round(v)===0).map(([k])=>k);

      const ym = `${esc(pillars?.year?.stem||'')}${esc(pillars?.year?.branch||'')}`;
      const mm = `${esc(pillars?.month?.stem||'')}${esc(pillars?.month?.branch||'')}`;
      const dm = `${esc(pillars?.day?.stem||'')}${esc(pillars?.day?.branch||'')}`;
      const hm = timeUnknown ? t('rpt_time_unknown') : `${esc(pillars?.hour?.stem||'')}${esc(pillars?.hour?.branch||'')}`;
      const fav=(adv?.useful||[]).join('/'), avoid=(adv?.avoid||[]).join('/');

      const sec=(title,body)=>`<div class="sec"><h3>${esc(title)}</h3><div class="ai-content">${body}</div></div>`;
      const bullet = arr => (arr||[]).map(x=>`• ${esc(x)}`).join('<br>');

      return [
        // 1) 总览
        sec(t('rpt_sec_overview_title'),
          `${esc(t('rpt_pillars_label'))}：${ym}｜${mm}｜${dm}｜${hm}<br>`+
          `${esc(t('rpt_daymaster_label'))}：${esc(pillars?.day?.stem||'')}（${esc(pillars?.day?.element||'')}）<br>`+
          `${esc(t('rpt_season_label'))}：${esc(st?.season||'-')} ｜ ${esc(t('rpt_chart_label'))}：${esc(st?.mark||'-')}`+
          (timeUnknown?`<br><span class="muted">${esc(t('rpt_time_hint'))}</span>`:'')
        ),

        // 2) 五行能量
        sec(t('rpt_sec_elements_title'),
          `${E.wood} ${Math.round(p.wood||0)}% · ${E.fire} ${Math.round(p.fire||0)}% · ${E.earth} ${Math.round(p.earth||0)}% · ${E.metal} ${Math.round(p.metal||0)}% · ${E.water} ${Math.round(p.water||0)}%<br>`+
          `${esc(t('rpt_balance_focus_label'))}：${esc(strongest)} ${esc(t('rpt_strongest_word'))}，${esc(weakest)} ${esc(t('rpt_weakest_word'))}`+
          (absent.length?`，${esc(t('rpt_absent_prefix'))}${esc(absent.join('/'))}`:'')
        ),

        // 3) 性格与天赋（占位）
        sec(t('rpt_sec_traits_title'),
          bullet([t('rpt_traits_intro'), t('rpt_traits_adv'), t('rpt_traits_chal')])
        ),

        // 4) 格局与喜忌
        sec(t('rpt_sec_structure_title'),
          `${esc(t('rpt_structure_line_template').replace('{fav}', fav||'-').replace('{avoid}', avoid||'-'))}<br>`+
          `${esc(t('rpt_strategy_label'))} ${esc(st?.focus||'-')}`
        ),

        // 5) 事业与发展（试读）
        sec(t('rpt_sec_career_title'),
          `${esc(t('rpt_career_fields_placeholder'))}<br>`+
          `${esc(t('rpt_dev_strategy_prefix'))}${esc(st?.focus||'-')}`
        ),

        // 6) 感情（试读）
        sec(t('rpt_sec_love_title'), esc(t('rpt_love_placeholder'))),

        // 7) 财富（试读）
        sec(t('rpt_sec_wealth_title'), esc(t('rpt_wealth_suggestion_template').replace('{fav}', fav||'-'))),

        // 8) 健康
        sec(t('rpt_sec_health_title'), esc(t('rpt_health_placeholder_template').replace('{weak}', weakest))),

        // 9) 环境与色彩
        sec(t('rpt_sec_env_title'), esc(t('rpt_env_placeholder')))
      ].join('');
    };
  }
})();


/* ================== 八字计算器（简化） ================== */
class BaziCalculator{
  constructor(){
    this.HEAVENLY_STEMS=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
    this.EARTHLY_BRANCHES=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
    this.ZODIAC=['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
    this.NAYIN=['海中金','炉中火','大林木','路旁土','剑锋金','山头火','涧下水','城头土','白蜡金','杨柳木','泉中水','屋上土','霹雳火','松柏木','长流水','砂石金','山下火','平地木','壁上土','金箔金','佛灯火','天河水','大驿土','钗钏金','桑柘木','大溪水','沙中土','天上火','石榴木','大海水'];
  }
  calculateYearPillar(year){ const s=(year-4)%10,b=(year-4)%12; return{stem:this.HEAVENLY_STEMS[(s+10)%10],branch:this.EARTHLY_BRANCHES[(b+12)%12],zodiac:this.ZODIAC[(b+12)%12]}; }
  solarMonthIndex(y,m,d){ const mmdd=m*100+d; const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]]; let idx=11; for(const [thr,val] of gates) if(mmdd>=thr) idx=val; const branchBy={1:'寅',2:'卯',3:'辰',4:'巳',5:'午',6:'未',7:'申',8:'酉',9:'戌',10:'亥',11:'子',12:'丑'}; return{index:idx,branch:branchBy[idx]}; }
  calculateMonthPillar(year,month,day){ const {index,branch}=this.solarMonthIndex(year,month,day); const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.calculateYearPillar(year).stem); const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0}; const stemIdx=(startMap[yStemIdx]+(index-1))%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch}; }
  calculateDayPillar(year,month,day){ const baseUTC=Date.UTC(1900,0,31); const targetUTC=Date.UTC(year,month-1,day); const dayDiff=Math.floor((targetUTC-baseUTC)/86400000); const stemIdx=(0+dayDiff)%10; const branchIdx=(4+dayDiff)%12; return{stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]}; }
  calculateHourPillar(dayStem,hour){ const branchMap={23:'子',0:'子',1:'丑',2:'丑',3:'寅',4:'寅',5:'卯',6:'卯',7:'辰',8:'辰',9:'巳',10:'巳',11:'午',12:'午',13:'未',14:'未',15:'申',16:'申',17:'酉',18:'酉',19:'戌',20:'戌',21:'亥',22:'亥'}; const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8}; const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem); const hourIndex=Math.floor((hour+1)/2)%12; const stemIdx=(startMap[dayIdx]+hourIndex)%10; return{stem:this.HEAVENLY_STEMS[stemIdx],branch:branchMap[hour]}; }
  getElement(stem,branch){ const s={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'}; const b={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'}; return `${s[stem]}${b[branch]}`; }
  getNayin(stem,branch){ const si=this.HEAVENLY_STEMS.indexOf(stem), bi=this.EARTHLY_BRANCHES.indexOf(branch); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
  getStemElement(stem){ return ({甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'})[stem]; }
  getBranchElement(branch){ return ({子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'})[branch]; }
  calculateBazi(year,month,day,hour=12,timeUnknown=false){
    const yearP=this.calculateYearPillar(year), monthP=this.calculateMonthPillar(year,month,day), dayP=this.calculateDayPillar(year,month,day);
    const hourP=timeUnknown?{stem:'？',branch:'？'}:this.calculateHourPillar(dayP.stem,hour);
    const dayElement=this.getStemElement(dayP.stem);
    const pillars={year:yearP,month:monthP,day:{...dayP,element:dayElement},hour:hourP};
    const cnt={木:0,火:0,土:0,金:0,水:0};
    (timeUnknown?[yearP,monthP,dayP]:[yearP,monthP,dayP,hourP]).forEach(p=>{ if(p.stem&&p.stem!=='？')cnt[this.getStemElement(p.stem)]+=1; if(p.branch&&p.branch!=='？')cnt[this.getBranchElement(p.branch)]+=1; });
    const total=Object.values(cnt).reduce((a,b)=>a+b,0)||1;
    const pct={wood:cnt['木']/total*100,fire:cnt['火']/total*100,earth:cnt['土']/total*100,metal:cnt['金']/total*100,water:cnt['水']/total*100};
    return {pillars,counts:cnt,percents:pct,timeUnknown};
  }
}
const baziCalculator = new BaziCalculator();

/* ================== 规则/渲染 ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem,branch=u?'？':v.branch;
    const div=document.createElement('div'); div.className='pillar'; div.innerHTML=`<div class="tit">${tit}</div><div class="gz">${stem}${branch}</div>`; root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'？':p.hour.stem); setText('hour-branch',timeUnknown?'？':p.hour.branch);
  const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'未知':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'未知':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan,monthZhi,cnt){
  const STEM_ELEM={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
  const SEASON_BY_MONTH_BRANCH={寅:'春',卯:'春',辰:'春',巳:'夏',午:'夏',未:'夏',申:'秋',酉:'秋',戌:'秋',亥:'冬',子:'冬',丑:'冬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='春'&&'木火'.includes(dmEl))||(season==='夏'&&'火土'.includes(dmEl))||(season==='秋'&&dmEl==='金')||(season==='冬'&&dmEl==='水')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'偏强':(score<=1?'偏弱':'平衡');
  const focus=mark==='偏强'?'泄秀/制化':(mark==='偏弱'?'补助/顺势':'守中/调和'); return{season,mark,focus};
}
function chooseUseful(strength,dmElem){
  if(strength==='偏强') return {strategy:'泄秀/制化', useful:({木:['火','土','金'],火:['土','金','水'],土:['金','水','木'],金:['水','木','火'],水:['木','火','土']})[dmElem], avoid:[dmElem]};
  if(strength==='偏弱') return {strategy:'生扶/补助', useful:({木:['木','水'],火:['火','木'],土:['土','火'],金:['金','土'],水:['水','金']})[dmElem], avoid:[]};
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}

/* ——（可选）旧管家面板定位：若无 #assistant-panel 则不动作 —— */
function relocateButlerPanel(){
  const panel  = document.getElementById('assistant-panel');
  const anchor = document.getElementById('butler-anchor');
  if (panel && anchor && anchor.parentNode){
    anchor.parentNode.insertBefore(panel, anchor.nextSibling);
  }
}

/* ================== 生成命盘 ================== */
async function genChart(){
  const birth = ($('birthdate')?.value || '').trim();
  const timeUnknown = $('timeUnknown')?.checked || false;
  if (!birth){ showErr('请填写出生日期。'); return; }

  const btn=$('genBtn'), tx=$('genBtnText'), ld=$('genBtnLoading');
  if(btn) btn.disabled = true;
  if(tx) tx.style.display = 'none';
  if(ld) ld.style.display = 'inline-block';

  try{
    const [Y,M,D] = birth.split('-').map(Number);
    let hour = 12;
    if (!timeUnknown){
      const t = ($('birthtime')?.value || '').trim();
      if (t){
        const h = parseInt(t.split(':')[0], 10);
        if (!Number.isNaN(h)) hour = h;
      }
    }

    const { pillars, counts, percents, timeUnknown: tu } =
      baziCalculator.calculateBazi(Y, M, D, hour, timeUnknown);

    $('result')?.style.setProperty('display','block');
    const timeText = tu ? '时间不详' : (hour + '时');
    setText('bazi-date', `出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if (tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span class="badge-warn">未纳入时柱</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('bar-木'), percents.wood);  setText('pct-木',  Math.round(percents.wood)  + '%');
    setBar($('bar-火'), percents.fire);  setText('pct-火',  Math.round(percents.fire)  + '%');
    setBar($('bar-土'), percents.earth); setText('pct-土',  Math.round(percents.earth) + '%');
    setBar($('bar-金'), percents.metal); setText('pct-金',  Math.round(percents.metal) + '%');
    setBar($('bar-水'), percents.water); setText('pct-水',  Math.round(percents.water) + '%');

    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);

    // 本地化“最强/最弱”提示
    {
      const keys = Object.keys(counts);
      const maxK = keys.reduce((a,b)=> counts[a] > counts[b] ? a : b);
      const minK = keys.reduce((a,b)=> counts[a] < counts[b] ? a : b);
      const E = ELABEL();
      const char2Locale = { 木: E.wood, 火: E.fire, 土: E.earth, 金: E.metal, 水: E.water };
      setText(
        'bazi-elements-balance',
        t('elements_balance_tpl')
          .replace('{max}', char2Locale[maxK])
          .replace('{min}', char2Locale[minK])
      );
    }

    // 存入上下文（修正字段名：timeUnknown）
    window.__last_report__ = { pillars, percents, st, adv, timeUnknown: tu };

    // 顺序很重要：免费/富报告 → 管家
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });
    mountRichReport({ pillars, percents, st, adv, timeUnknown: tu });
    mountButlerCard(); // <- 确保管家在最下方

    console.log(
      '实际 →',
      pillars.year.stem+pillars.year.branch,
      pillars.month.stem+pillars.month.branch,
      pillars.day.stem+pillars.day.branch,
      tu ? '？' : (pillars.hour.stem+pillars.hour.branch)
    );
  } catch (err){
    console.error(err);
    showErr('计算八字时出现错误，请重试');
  } finally {
    if(btn) btn.disabled = false;
    if(tx)  tx.style.display = 'inline';
    if(ld)  ld.style.display = 'none';
  }
}

function mountRichReport({ pillars, percents, st, adv, timeUnknown }) {
  let host = document.getElementById('rich-report');
  if (!host) {
    host = document.createElement('div');
    host.id = 'rich-report';
    const result = document.getElementById('result');
    if (result) result.appendChild(host);
  }
  host.innerHTML = buildRichReportHTML({ pillars, percents, st, adv, timeUnknown });

  // 👉 确保“管家”容器在报告之后
  let bhost = document.getElementById('butler-host');
  if (!bhost && host.parentNode) {
    bhost = document.createElement('div');
    bhost.id = 'butler-host';
    host.parentNode.insertBefore(bhost, host.nextSibling);
  }

  if (typeof relocateButlerPanel === 'function') relocateButlerPanel();
}

/* ================== 语言：初始化 + 切换后重渲染 ================== */
function applyChatI18n(){
  const fab=$('ssChatFab'), inp=$('ssChatInput'), btn=$('ssChatSend');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
}
function initLangUI(){
  const sel = document.getElementById('langSelect');
  if(!sel) return;
  const current = getLang();
  sel.value = current;
  document.documentElement.lang = current;
  applyI18n();
  applyChatI18n();

  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n();
    applyChatI18n();
    rerenderReportsIfAny();
  });
}
function rerenderReportsIfAny(){
  const ctx = window.__last_report__;
  if (!ctx) return;

  const { pillars, percents, st, adv, timeUnknown } = ctx;

  // 1) 重新渲染报告（免费+富报告）
  mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown });
  mountRichReport({ pillars, percents, st, adv, timeUnknown });
  if (typeof relocateButlerPanel === 'function') relocateButlerPanel();

  // 2) 切语言后同步刷新“最强/最弱”提示
  const E = ELABEL();
  const key2Locale = { wood: E.wood, fire: E.fire, earth: E.earth, metal: E.metal, water: E.water };
  const entries = Object.entries(percents || {});
  const strongestK = entries.reduce((a,b)=> a[1] > b[1] ? a : b, ['wood',0])[0];
  const weakestK   = entries.reduce((a,b)=> a[1] < b[1] ? a : b, ['wood',0])[0];
  setText(
    'bazi-elements-balance',
    t('elements_balance_tpl')
      .replace('{max}', key2Locale[strongestK])
      .replace('{min}', key2Locale[weakestK])
  );

  // 3) 刷新 AI 卡片标题与芯片文案
  const titleEl = document.getElementById('butlerTitle');
  if (titleEl) titleEl.textContent = t('butler_title');
  renderChips();
}

/* ================== 估时间向导（仅勾选不详时触发） ================== */
(function initBirthtimeWizard(){
  const tChk=$('timeUnknown'), tInput=$('birthtime'), btn=$('guessTimeBtn');
  const twMask=$('twMask'), twGrid=$('twGrid'), twApply=$('twApply'), twCancel=$('twCancel');
  if(!tInput||!tChk||!twMask||!twGrid||!twApply||!twCancel) return;

  const DZ=[
    ['子','23:00–01:00','00:00'],['丑','01:00–03:00','02:00'],['寅','03:00–05:00','04:00'],['卯','05:00–07:00','06:00'],
    ['辰','07:00–09:00','08:00'],['巳','09:00–11:00','10:00'],['午','11:00–13:00','12:00'],['未','13:00–15:00','14:00'],
    ['申','15:00–17:00','16:00'],['酉','17:00–19:00','18:00'],['戌','19:00–21:00','20:00'],['亥','21:00–23:00','22:00']
  ];
  let selected=null;

  function openWizard(){
    twMask.style.display='flex'; selected=null; twApply.disabled=true;
    if(!twGrid.dataset.built){
      DZ.forEach(([z,range])=>{
        const b=document.createElement('button'); b.type='button'; b.className='tw-btn'; b.textContent=`${z}（${range}）`;
        b.addEventListener('click',()=>{ [...twGrid.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); selected=z; twApply.disabled=false;});
        twGrid.appendChild(b);
      }); twGrid.dataset.built='1';
    }else{ [...twGrid.children].forEach(x=>x.classList.remove('active')); }
  }
  function closeWizard(){ twMask.style.display='none'; }

  tChk.addEventListener('change', ()=>{ tInput.disabled=tChk.checked; if(tChk.checked) openWizard(); else closeWizard(); });
  btn && btn.addEventListener('click', openWizard);
  twCancel.addEventListener('click', closeWizard);
  twApply.addEventListener('click', ()=>{
    if(!selected) return;
    const mid=Object.fromEntries(DZ.map(([z,_,m])=>[z,m]))[selected];
    tInput.value=mid; tInput.disabled=false; tChk.checked=false; closeWizard();
  });
  tInput.disabled=tChk.checked;
})();

/* ================== 登录流程（统一使用 fetchJSON） ================== */
async function loginFlow(email,password){
  const res = await fetchJSON('/api/login', { email, password });
  const msg=(res.msg||"").toString().toLowerCase();
  let expired=false;
  if(res.expired===true) expired=true;
  else if(msg==='expired') expired=true;
  else if(res.expiresAt){
    const ts=Date.parse(res.expiresAt);
    if(!Number.isNaN(ts)&&ts<Date.now()) expired=true;
  }

  if(expired){
    const go=confirm(t('err_expired')+'。是否前往续费？');
    if(go){
      const a=document.createElement('a');
      a.href='https://yourshopifyshop.com/products/monthly-vip';
      a.target='_blank'; a.rel='noopener noreferrer';
      document.body.appendChild(a); a.click(); a.remove();
    }
    return;
  }

  if(res.ok===true){
    localStorage.setItem('vipEmail',res.email||email);
    location.href='https://astro.5xliving.com/vip_soul_sanctuary.html';
    return;
  }

  if(msg==='no_account') return showAuthErr(t('err_no_account'));
  if(msg==='wrong_pwd') return showAuthErr(t('err_wrong_pwd'));
  const extra = res.msg ? ` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}` : '';
  return showAuthErr(t('err_login_fail')+extra);
}

/* —— 表单事件绑定（合并为一次 DOMContentLoaded） —— */
document.addEventListener('DOMContentLoaded', ()=>{
  initLangUI();

    // —— 最小防自动填充（不预设邮箱/密码）——
  (() => {
    const form = document.getElementById('loginForm');
    if (form) form.setAttribute('autocomplete','off');
    const email = document.getElementById('email');
    const pwd   = document.getElementById('password');
    if (email) email.setAttribute('autocomplete','off');
    if (pwd)   pwd.setAttribute('autocomplete','new-password');
  })();

  // Default date today (若为空)
    var bd=document.querySelector('#birthdate');
    if(bd && !bd.value){ bd.value = new Date().toISOString().split('T')[0]; }
  });
  
  // 生成命盘按钮和输入回车
  const genBtn = $('genBtn');
  if (genBtn && typeof genChart === 'function') {
    genBtn.addEventListener('click', genChart);
  }

  ['birthdate','birthtime'].forEach(id=>{
    const el=$(id);
    if(el) el.addEventListener('keydown', e=>{
      if(e.key==='Enter' && typeof genChart === 'function') genChart();
    });
  });

  // 注册
  $('registerForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=$('email')?.value.trim(); const password=$('password')?.value.trim();
    if(!email||!password) return showAuthErr(t('err_need_ep'));
    if(!strongPwd(password)) return showAuthErr(t('err_pwd_rule'));
    lock($('registerBtn'),true);
    try{
      const res=await fetchJSON('/api/register',{email,password});
      if(res.ok===true){ localStorage.setItem('vipEmail',email); location.href='vip_trial.html'; return; }
      if((res.msg||"").toString().toLowerCase()==='exists'){ await loginFlow(email,password); return; }
      return showAuthErr((res.msg&&(res.msg+''))||t('err_register_fail'));
    }catch(err){ showAuthErr(t('err_register_fail')+(err?.message||'')); }
    finally{ lock($('registerBtn'),false); }
  });

  // 登录
  $('loginForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault(); hideAuthErr();
    const email=$('email')?.value.trim(); const password=$('password')?.value.trim();
    if(!email||!password) return showAuthErr(t('err_need_ep'));
    lock($('loginBtn'),true);
    try{ await loginFlow(email,password); }
    catch(err){ showAuthErr(t('err_login_fail')+(err?.message||'')); }
    finally{ lock($('loginBtn'),false); }
  });

  // 重置密码
  $('resetBtn')?.addEventListener('click', async ()=>{
    hideAuthErr();
    let email=prompt(t('prompt_email')); if(email===null) return; email=email.trim(); if(!email) return showAuthErr(t('err_email_empty'));
    let newPassword=prompt(t('prompt_newpwd')); if(newPassword===null) return; newPassword=newPassword.trim(); if(!newPassword) return showAuthErr(t('err_pwd_empty'));
    if(!strongPwd(newPassword)) return showAuthErr(t('err_pwd_rule'));
    lock($('resetBtn'),true);
    try{
      const res=await fetchJSON('/api/reset',{email,newPassword});
      if(!res.ok){ const extra=res.msg?` ${(typeof res.msg==='string')?res.msg:JSON.stringify(res.msg)}`:''; return showAuthErr(extra||t('err_reset_fail')); }
      alert(t('msg_reset_ok'));
    }catch(err){ showAuthErr(t('err_reset_fail')+(err?.message||'')); }
    finally{ lock($('resetBtn'),false); }
  });
  
  // === Box 样式（新） ===
(function injectBoxStyle(){
  const id='box-style'; const old=document.getElementById(id); if (old) old.remove();
  const style=document.createElement('style'); style.id=id;
  style.textContent = `
    :root{
      --box-bg:#0b111a;
      --box-line:#1f2a36;
      --box-text:#e8edf3;
      --box-title:#ffd88a;
      --muted:#9db0c3;
    }
    .box{background:var(--box-bg); border:1px solid var(--box-line); border-radius:12px; padding:14px 16px; margin:14px 0;}
    .box-h{color:var(--box-title); font-weight:700; margin-bottom:8px;}
    .box-c{color:var(--box-text); line-height:1.7;}
    .box .muted{color:var(--muted);}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--box-line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  `;
  document.head.appendChild(style);
})();

/* === BAZI：把每一段包进 .box（非侵入式）=== */
/* === BAZI：把每一段包进 .box（保留 #aiCard / #butlerTitle）=== */
(function boxifyBazi(){
  function wrapSec(sec){
    if (!sec || sec.closest('.box')) return;

    const isAiCard = sec.id === 'aiCard';             // 关键：是否管家卡
    const titleEl  = sec.querySelector('h3');
    const titleTxt = titleEl ? titleEl.textContent.trim() : '';
    const titleId  = titleEl ? titleEl.id : '';

    const frag = document.createDocumentFragment();
    if (titleEl) titleEl.remove();
    while (sec.firstChild) frag.appendChild(sec.firstChild);

    const box = document.createElement('div');
    box.className = 'box';

    // ✅ 保留 id 和 dataset，避免后续 runAI 找不到 #aiCard
    if (isAiCard){
      box.id = 'aiCard';
      for (const k in sec.dataset) box.dataset[k] = sec.dataset[k];
    }

    const h = document.createElement('div');
    h.className = 'box-h';
    h.textContent = titleTxt || '';

    // ✅ 如果原本标题是 #butlerTitle，也把 id 迁移过来，便于多语言刷新
    if (titleId === 'butlerTitle') h.id = 'butlerTitle';

    const c = document.createElement('div');
    c.className = 'box-c';
    c.appendChild(frag);

    box.appendChild(h);
    box.appendChild(c);
    sec.replaceWith(box);
  }

  function wrapCard(card){
    if (!card || card.classList.contains('box')) return;
    const titleEl = card.querySelector('.h2');
    const title   = titleEl ? titleEl.textContent.trim() : '';
    if (titleEl) titleEl.remove();

    const box = document.createElement('div'); box.className = 'box';
    const h   = document.createElement('div'); h.className   = 'box-h'; h.textContent = title || '';
    const c   = document.createElement('div'); c.className   = 'box-c';
    while (card.firstChild) c.appendChild(card.firstChild);
    box.appendChild(h); box.appendChild(c);
    card.replaceWith(box);
  }

  function applyAll(root){
    if (!root) return;
    // 富报告
    root.querySelectorAll('#rich-report .sec').forEach(wrapSec);
    // ✅ 管家卡片（不管有没有 .sec，都包）
    const ai = root.querySelector('#aiCard'); if (ai) wrapSec(ai);
    // 免费简报
    root.querySelectorAll('#xl-free-report .card').forEach(wrapCard);
  }

  // 1) 先跑一次
  applyAll(document.getElementById('result') || document);

  // 2) 挂钩你现有的渲染函数（保持你原逻辑不变）
  const _mountRich = window.mountRichReport;
  if (typeof _mountRich === 'function'){
    window.mountRichReport = function(...args){
      _mountRich.apply(this, args);
      applyAll(document.getElementById('result') || document);
    };
  }
  const _mountExt = window.mountExtensionsIntoResult;
  if (typeof _mountExt === 'function'){
    window.mountExtensionsIntoResult = function(...args){
      _mountExt.apply(this, args);
      applyAll(document.getElementById('result') || document);
    };
  }
  const _rerender = window.rerenderReportsIfAny;
  if (typeof _rerender === 'function'){
    window.rerenderReportsIfAny = function(...args){
      _rerender.apply(this, args);
      applyAll(document.getElementById('result') || document);
    };
  }

  // 3) 兜底：监听 #aiCard 动态插入（先插入后 wrap 的场景）
  const root = document.getElementById('result') || document.body;
  if (root) {
    const mo = new MutationObserver((mutList)=>{
      for (const m of mutList){
        for (const n of m.addedNodes){
          if (!(n instanceof HTMLElement)) continue;
          const ai = (n.id === 'aiCard') ? n : n.querySelector?.('#aiCard');
          if (ai && !ai.closest('.box')) wrapSec(ai);
        }
      }
    });
    mo.observe(root, { childList:true, subtree:true });
  }
})

/* ===== 语言切换：即时更新文案 + 重绘结果 ===== */
const sel = $('langSelect');
sel.value = getLang();
applyI18n();
sel.addEventListener('change', ()=>{
  setLang(sel.value);
  applyI18n();
  // 结果已生成则重绘
  if(__STAR_STATE) renderStar(__STAR_STATE);
});

/* 初次进入也应用语言（若 localStorage 有值） */
document.documentElement.lang = getLang();
applyI18n();

/* ================== 自测：1978-02-21 12:00 → 戊午 甲寅 甲寅 庚午 ================== */
(function(){
  const c=new BaziCalculator(); const Y=c.calculateYearPillar(1978); const M=c.calculateMonthPillar(1978,2,21); const D=c.calculateDayPillar(1978,2,21); const H=c.calculateHourPillar(D.stem,12);
  console.log('应为 → 年 戊午｜月 甲寅｜日 甲寅｜时 庚午');
  console.log('实际 →', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);  
</script>
</body>
</html>


