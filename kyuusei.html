<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">九星气学 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#0b0f14;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:3px 10px;border:1px solid var(--gold);color:var(--gold);border-radius:999px;margin-right:6px;margin-top:4px}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* Chat */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:85%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}

  /* ====== Chat 字体与尺寸放大（覆盖原样式） ====== */
  .ss-chat-panel { font-size: 15.5px; }              /* 整个面板基础字号 */
  .ss-chat-head  { font-size: 16.5px; }              /* 标题行字号 */

  .ss-chat-body { gap: 10px; }                       /* 气泡间距更舒适 */

  .ss-msg{
    font-size: 15.5px;                               /* 聊天气泡字号 */
    line-height: 1.65;                               
    padding: 10px 12px;                              /* 气泡内边距 */
    border-radius: 12px;                             
    max-width: 95%;                                  /* 减少换行次数 */
  }
  .ss-msg.me{
    font-size: 15.5px;
    line-height: 1.65;
    padding: 10px 12px;
    border-radius: 12px;
  }

  .ss-chat-input input{
    font-size: 15.5px; 
    height: 44px;                                    /* 输入框更高 */
    padding: 10px 12px;
  }
  .ss-chat-input button{
    font-size: 15.5px; 
    height: 44px;                                    /* 发送按钮更高 */
    padding: 0 14px;
  }

  /* 移动端再稍微大一点，避免眯眼 */
  @media (max-width: 480px){
    .ss-chat-panel { font-size: 16px; }
    .ss-msg, .ss-msg.me { font-size: 16px; line-height: 1.7; }
    .ss-chat-input input, .ss-chat-input button { height: 46px; font-size: 16px; }
  }  
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand">Soul Sanctuary</div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <div class="card">
    <div class="h2" data-i18n="form_title">九星气学 · 快速解读</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" style="margin-top:6px" data-i18n="solar_tip">提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。</div>
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">主题</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">爱情/关系</option>
          <option value="career" data-i18n="topic_career">事业/工作</option>
          <option value="wealth" data-i18n="topic_wealth">财富/投资</option>
          <option value="family" data-i18n="topic_family">家庭/人际</option>
          <option value="health" data-i18n="topic_health">健康/身心</option>
          <option value="study" data-i18n="topic_study">学业/成长</option>
          <option value="move"  data-i18n="topic_move">旅行/搬迁</option>
          <option value="other" data-i18n="topic_other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="preset_label">常用问题</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">（可选）选择一个模板</option>
          <option data-i18n="preset_1">她/他爱我吗？我们接下来怎么走更好？</option>
          <option data-i18n="preset_2">我是否应该换工作/创业？需要注意什么？</option>
          <option data-i18n="preset_3">近期在投资与理财上，应如何取舍？</option>
          <option data-i18n="preset_4">如何改善与家人的关系与沟通？</option>
          <option data-i18n="preset_5">我最近健康/情绪的关键提醒是什么？</option>
        </select>
      </div>
    </div>
    <div class="row cols-1" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="q_label">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。"></textarea>
      </div>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">生成分析</button></div>
      <div><button id="clear" class="btn" style="background:#101826;color:#ffe084;border-color:#3a3f47" data-i18n="btn_clear">清空</button></div>
    </div>
  </div>

  <!-- 结果：主星 -->
  <div id="starCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_star">您的九星主星</div>
    <p><span data-i18n="star_label">主星</span>：<b id="starName"></b>（<span id="starJP"></span>）</p>
    <div id="starBadges" style="margin:6px 0"></div>
    <div id="starAbout" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 结果：AI 解读 -->
  <div id="aiCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_ai">心怜管家解读与建议</div>
    <pre id="aiText" style="white-space:pre-wrap;line-height:1.7"></pre>
    <div id="aiReco" style="margin-top:10px"></div>
  </div>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
/* ===== 配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers
const LANG_KEY = "site_lang";

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

/* ===== i18n 词库（精简示例；其他语言缺失时回退到中文） ===== */
const i18n = {
  "zh-CN": {
    title:"九星气学 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
    form_title:"九星气学 · 快速解读", birth_label:"出生日期",
    solar_tip:"提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。",
    topic_label:"主题",
    topic_love:"爱情/关系", topic_career:"事业/工作", topic_wealth:"财富/投资",
    topic_family:"家庭/人际", topic_health:"健康/身心", topic_study:"学业/成长",
    topic_move:"旅行/搬迁", topic_other:"其他",
    preset_label:"常用问题", preset_none:"（可选）选择一个模板",
    preset_1:"她/他爱我吗？我们接下来怎么走更好？",
    preset_2:"我是否应该换工作/创业？需要注意什么？",
    preset_3:"近期在投资与理财上，应如何取舍？",
    preset_4:"如何改善与家人的关系与沟通？",
    preset_5:"我最近健康/情绪的关键提醒是什么？",
    q_label:"你的具体问题（可直接粘贴）",
    q_ph:"例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。",
    btn_gen:"生成分析", btn_clear:"清空",
    sec_star:"您的九星主星", star_label:"主星",
    badge_elem:"五行", badge_color:"色", badge_kw:"关键词",
    about_label:"性格倾向", sec_ai:"心怜管家解读与建议",
    chat_fab:"问", chat_title:"心怜管家 · Chat", chat_ph:"想了解什么？（如：如何开始免费体验）", chat_send:"发送",
    please_birth:"请先选择出生日期", bad_date:"日期格式有误", generating:"正在生成解读…",
    reco_title:"心怜管家推举内容", retry:"抱歉，暂时无法生成，请稍后再试。", neterr:"网络异常，请稍后再试。"
  },
  "en": {
    title:"Nine Star Ki · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
    form_title:"Nine Star Ki · Quick Reading", birth_label:"Birthdate",
    solar_tip:"Tip: Ki year switches at Setsubun (~Feb 4). Birthdays on Jan 1–Feb 3 belong to the previous year.",
    topic_label:"Topic",
    topic_love:"Love/Relationship", topic_career:"Career/Work", topic_wealth:"Wealth/Investment",
    topic_family:"Family/Social", topic_health:"Health/Mind-Body", topic_study:"Study/Growth",
    topic_move:"Travel/Move", topic_other:"Other",
    preset_label:"Quick Questions", preset_none:"(Optional) Choose a template",
    preset_1:"Does she/he love me? What’s the best next move?",
    preset_2:"Should I change job/start a business? What to watch out for?",
    preset_3:"How should I decide on investing/finances recently?",
    preset_4:"How to improve communication with family?",
    preset_5:"What are the key reminders for my health/emotions now?",
    q_label:"Your specific question (paste here)", q_ph:"e.g. Today’s topic: “Does she love me?” Please give clear next steps and pitfalls.",
    btn_gen:"Generate Reading", btn_clear:"Clear",
    sec_star:"Your Main Star", star_label:"Main Star",
    badge_elem:"Element", badge_color:"Color", badge_kw:"Keywords",
    about_label:"Tendencies", sec_ai:"Concierge Reading & Advice",
    chat_fab:"Chat", chat_title:"Concierge · Chat", chat_ph:"Ask me anything (e.g., how to start a free trial)", chat_send:"Send",
    please_birth:"Please select your birthdate", bad_date:"Invalid date", generating:"Generating reading…",
    reco_title:"Concierge Recommendations", retry:"Sorry, couldn’t generate for now.", neterr:"Network error. Try again later."
  },
  "ms": {
    title:"Nine Star Ki · 5XLiving", brand:"Soul Sanctuary", lang_label:"Bahasa",
    form_title:"Ringkasan Nine Star Ki", birth_label:"Tarikh lahir",
    solar_tip:"Nota: Tahun Ki bertukar pada Setsubun (~4 Feb). Lahir 1/1–3/2 dikira tahun sebelumnya.",
    topic_label:"Topik",
    topic_love:"Cinta/Hubungan", topic_career:"Kerjaya", topic_wealth:"Kewangan/Investasi",
    topic_family:"Keluarga/Sosial", topic_health:"Kesihatan", topic_study:"Pembelajaran",
    topic_move:"Perjalanan/Pindah", topic_other:"Lain-lain",
    preset_label:"Soalan Pantas", preset_none:"(Pilihan) Pilih templat",
    preset_1:"Adakah dia mencintai saya? Langkah seterusnya?",
    preset_2:"Patut tukar kerja/memulakan bisnes? Apa yang perlu berjaga?",
    preset_3:"Bagaimana membuat keputusan pelaburan/ kewangan kini?",
    preset_4:"Cara memperbaiki komunikasi keluarga?",
    preset_5:"Peringatan utama kesihatan/emosi saya kini?",
    q_label:"Soalan khusus anda", q_ph:"cth: Topik hari ini: “Adakah dia mencintai saya?” Beri langkah seterusnya & elak perangkap.",
    btn_gen:"Jana Analisis", btn_clear:"Kosongkan",
    sec_star:"Bintang Utama Anda", star_label:"Bintang",
    badge_elem:"Unsur", badge_color:"Warna", badge_kw:"Kata Kunci",
    about_label:"Kecenderungan", sec_ai:"Bacaan & Nasihat Concierge",
    chat_fab:"Tanya", chat_title:"Concierge · Sembang", chat_ph:"Tanya apa-apa", chat_send:"Hantar",
    please_birth:"Sila pilih tarikh lahir", bad_date:"Tarikh tidak sah", generating:"Menjana bacaan…",
    reco_title:"Cadangan Concierge", retry:"Maaf, gagal jana buat masa ini.", neterr:"Ralat rangkaian."
  }
};

/* 将页面静态文案替换为当前语言 */
function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n"); el.textContent = t(k);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k));
  });
  const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']");
  if(titleEl){ titleEl.textContent=t("title"); }
}

/* ===== Chat 浮窗 ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      let data={}; try{data=await r.json()}catch{}
      const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||t('retry'));
    }catch{ addMsg(t('neterr')); }
  }
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();

/* ===== 九星算法（节分 2/4 换年） ===== */
function reduce1(n){let s=Math.abs(n).toString().split('').reduce((a,b)=>a+Number(b),0);while(s>9)s=s.toString().split('').reduce((a,b)=>a+Number(b),0);return s;}
function isBeforeSetsubun(d){const m=d.getMonth(),day=d.getDate();return (m===0)||(m===1&&day<=3);}
function calcHonmei(dateStr){const d=new Date(dateStr);if(isNaN(d))return null;const root=reduce1(d.getFullYear());let num=(isBeforeSetsubun(d)?12:11)-root;while(num<=0)num+=9;return num;}

/* ===== 九星词典（基础画像） ===== */
const STARS={
  1:{zh:'一白水星',jp:'Ippaku Suisei',elem:{zh:'水',en:'Water',ms:'Air'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['流动','直觉','沟通'],en:['Flow','Intuition','Communication'],ms:['Alir','Intuisi','Komunikasi']},about:{zh:'敏感细腻、共情力强，行动灵活，擅长信息与关系协调。',en:'Sensitive and empathic; agile; great at information & relationship alignment.',ms:'Peka & berempati; lincah; bagus penyelarasan maklumat & hubungan.'}},
  2:{zh:'二黑土星',jp:'Jikoku Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'黑',en:'Black',ms:'Hitam'},key:{zh:['滋养','承载','耐性'],en:['Nourish','Support','Patience'],ms:['Membaja','Menyokong','Sabar']},about:{zh:'务实稳健、重视秩序与照料，擅长持续耕耘与落地。',en:'Practical and steady; values order & care; good at steady execution.',ms:'Praktikal & stabil; nilai tertib & penjagaan; baik pelaksanaan berterusan.'}},
  3:{zh:'三碧木星',jp:'Sanpeki Mokusei',elem:{zh:'木',en:'Wood',ms:'Kayu'},color:{zh:'碧',en:'Cyan',ms:'Biru Hijau'},key:{zh:['生发','表达','突破'],en:['Growth','Expression','Breakthrough'],ms:['Tumbuh','Ekspresi','Terobosan']},about:{zh:'好奇表达欲强，喜欢创意与开疆拓土。',en:'Curious and expressive; loves creativity & pioneering.',ms:'Ingin tahu & ekspresif; suka kreativiti & perintis.'}},
  4:{zh:'四绿木星',jp:'Shiroku Mokusei',elem:{zh:'木',en:'Wood',ms:'Kayu'},color:{zh:'绿',en:'Green',ms:'Hijau'},key:{zh:['交流','学习','旅行'],en:['Exchange','Learning','Travel'],ms:['Interaksi','Belajar','Perjalanan']},about:{zh:'温和包容、擅长倾听与知识整合，适合教育与协作。',en:'Gentle & inclusive; great at listening & integrating knowledge; good for education & collaboration.',ms:'Lunak & inklusif; mahir mendengar & integrasi ilmu; sesuai pendidikan & kolaborasi.'}},
  5:{zh:'五黄土星',jp:'Gogou Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'黄',en:'Yellow',ms:'Kuning'},key:{zh:['中宫','权衡','重启'],en:['Center','Weighing','Reset'],ms:['Pusat','Menimbang','Set Semula']},about:{zh:'居中定盘、抗压强，擅长策略与危机管理。',en:'Centering & resilient; skilled at strategy & crisis management.',ms:'Memusat & tahan tekanan; mahir strategi & pengurusan krisis.'}},
  6:{zh:'六白金星',jp:'Roppaku Kinsei',elem:{zh:'金',en:'Metal',ms:'Logam'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['秩序','领导','远见'],en:['Order','Leadership','Vision'],ms:['Tertib','Kepimpinan','Wawasan']},about:{zh:'自律果断、擅立规则与带队。',en:'Disciplined & decisive; sets rules and leads.',ms:'Berdisiplin & tegas; menetap peraturan & memimpin.'}},
  7:{zh:'七赤金星',jp:'Shichiseki Kinsei',elem:{zh:'金',en:'Metal',ms:'Logam'},color:{zh:'赤',en:'Red',ms:'Merah'},key:{zh:['社交','品味','享受'],en:['Social','Taste','Enjoyment'],ms:['Sosial','Citarasa','Menikmati']},about:{zh:'人缘好、审美在线，擅品牌与社群。',en:'Popular with great taste; good at brand & community.',ms:'Popular & citarasa baik; hebat jenama & komuniti.'}},
  8:{zh:'八白土星',jp:'Happaku Dosei',elem:{zh:'土',en:'Earth',ms:'Tanah'},color:{zh:'白',en:'White',ms:'Putih'},key:{zh:['积累','转折','定山'],en:['Accumulate','Turn','Stability'],ms:['Kumpul','Pusingan','Stabil']},about:{zh:'稳中求变、厚积薄发，关键时刻能翻盘。',en:'Stable yet transformative; turns tides after accumulation.',ms:'Stabil namun berubah; bangkit selepas pengumpulan.'}},
  9:{zh:'九紫火星',jp:'Kyūshi Kasei',elem:{zh:'火',en:'Fire',ms:'Api'},color:{zh:'紫',en:'Purple',ms:'Ungu'},key:{zh:['光彩','灵感','传播'],en:['Radiance','Inspiration','Broadcast'],ms:['Cahaya','Inspirasi','Sebar']},about:{zh:'热情外放、灵感多，适合登台表达与IP打造。',en:'Passionate & radiant; good for stage & IP building.',ms:'Bersemangat & bersinar; sesuai pentas & bina IP.'}}
};

/* 保存最后一次结果，切语言时用于重绘 */
let __STAR_STATE = null;

/* ===== 渲染主星卡片 ===== */
function renderStar(n){
  const lang = getLang();
  const L = i18n[lang] || i18n["zh-CN"];
  const star = STARS[n]; if(!star) return;

  const name = star[lang==='en'?'en':'zh'] ? star[lang==='en'?'en':'zh'] : star.zh; // 名称主要用中文；可自行扩展多语名
  $('starName').textContent = star.zh; // 中文名保持传统术语
  $('starJP').textContent   = star.jp;

  const elem = star.elem[lang] || star.elem.zh;
  const color= star.color[lang]|| star.color.zh;
  const kws  = (star.key[lang] || star.key.zh).join(' / ');
  const about= star.about[lang] || star.about.zh;

  $('starBadges').innerHTML =
    `<span class="badge">${L.badge_elem}：${elem}</span>`+
    `<span class="badge">${L.badge_color}：${color}</span>`+
    `<span class="badge">${L.badge_kw}：${kws}</span>`;
  $('starAbout').textContent = `${L.about_label}：${about}`;
  $('starCard').style.display='block';
}

/* ===== 组装给 GPT 的提示词 ===== */
function buildPrompt({langName, star, topic, question}){
  const topicMap = {
    "zh-CN": {love:"爱情/关系",career:"事业/工作",wealth:"财富/投资",family:"家庭/人际",health:"健康/身心",study:"学业/成长",move:"旅行/搬迁",other:"其他"},
    "en":    {love:"Love/Relationship",career:"Career/Work",wealth:"Wealth/Investment",family:"Family/Social",health:"Health/Mind-Body",study:"Study/Growth",move:"Travel/Move",other:"Other"},
    "ms":    {love:"Cinta/Hubungan",career:"Kerjaya",wealth:"Kewangan/Investasi",family:"Keluarga/Sosial",health:"Kesihatan",study:"Pembelajaran",move:"Perjalanan/Pindah",other:"Lain-lain"}
  }[getLang()] || {};

  const starText = `主星：${star.zh}（${star.jp}）；五行：${star.elem.zh}；关键词：${star.key.zh.join('、')}。性格：${star.about.zh}`;
  return `你是 5XLiving「心怜管家」与资深九星气学顾问。请使用【${langName}】输出，语气温暖、专业、落地。
用户的主星信息：${starText}
用户主题：${topicMap[topic] || topic}
用户问题：${question || '（无具体问题，请给通用提示）'}

请按以下结构输出（不要加多余前后缀）：
# 核心判断（2-4 句）
# 现在要做的事（列 3 条，动词开头）
# 避坑提醒（列 2-3 条）
# 可尝试的灵性练习（从冥想/manifestation/书写愿望/仪式中给 2-3 条，给操作要点）
# AI 推举内容（列 3-5 条，结合本网站：如预约一对一、加入 VIP、许愿包/御守、课程、把计划存入心怜笔记等）`;
}

/* ===== 请求 AI ===== */
async function askAI(prompt){
  const resp = await fetch(`${API_BASE}/api/chat`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[
      {role:'system',content:'你将产出结构化的九星气学建议，务必简明清晰、可执行。'},
      {role:'user',content:prompt}
    ]})
  });
  let data={}; try{data=await resp.json()}catch{}
  return data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? '';
}

/* ===== 交互 ===== */
$('presetQ').addEventListener('change',e=>{
  const v=e.target.value; if(v){ const q=$('question'); q.value = q.value? q.value+'\n'+v : v; }
});
$('clear').addEventListener('click',()=>{
  $('birthdate').value=''; $('question').value=''; $('presetQ').value=''; $('topic').value='love';
  $('starCard').style.display='none'; $('aiCard').style.display='none'; __STAR_STATE=null;
});
$('go').addEventListener('click', async ()=>{
  const L = i18n[getLang()]||i18n["zh-CN"];
  const date=$('birthdate').value.trim();
  if(!date){ alert(L.please_birth); return; }
  const n=calcHonmei(date); if(!n){ alert(L.bad_date); return; }
  __STAR_STATE = n; renderStar(n);

  const topic=$('topic').value;
  const question=( $('question').value || $('presetQ').value || '' ).trim();
  const langName = ({'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ja':'日本語','th':'ไทย','ms':'Bahasa Melayu'})[getLang()] || '简体中文';
  const prompt=buildPrompt({langName, star:STARS[n], topic, question});

  $('aiText').textContent = L.generating;
  $('aiCard').style.display='block';
  try{
    const txt = await askAI(prompt);
    $('aiText').textContent = txt || L.retry;

    // 从文本里抓“推举/推荐/VIP/许愿/课程/预约/笔记/御守”等做一个列表（尽量温和）
    const recos=[]; (txt||'').split('\n').forEach(l=>{
      if(/推举|推荐|VIP|许愿|课程|预约|御守|笔记|会员/i.test(l)) recos.push(l.trim());
    });
    $('aiReco').innerHTML = recos.length
      ? `<div class="h2">${L.reco_title}</div><ul style="margin:.3rem 0 .2rem .9rem">${recos.slice(0,5).map(x=>`<li>${x}</li>`).join('')}</ul>`
      : '';
  }catch(e){
    $('aiText').textContent = L.neterr;
  }
});

/* ===== 语言切换：即时更新文案 + 重绘结果 ===== */
const sel = $('langSelect');
sel.value = getLang();
applyI18n();
sel.addEventListener('change', ()=>{
  setLang(sel.value);
  applyI18n();
  // 结果已生成则重绘
  if(__STAR_STATE) renderStar(__STAR_STATE);
});

/* 初次进入也应用语言（若 localStorage 有值） */
document.documentElement.lang = getLang();
applyI18n();
</script>
</body>
</html>
