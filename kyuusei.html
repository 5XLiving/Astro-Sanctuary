<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">九星气学 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* —— 统一头部 —— */
    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:.02em}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem; background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:calc(100% - 12px) 50%}
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* —— 页面结构 —— */
    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    /* —— 简易报告样式 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    /* —— 右下角心怜管家（问） —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    /* —— 会员区布局 —— */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— 只保留一个 GPT 窗口：隐藏结果区的 GPT 抽屉 —— */
    #gpt-drawer, #gpt-drawer[hidden], #gpt-drawer>summary{display:none !important}

    /* —— 估时间弹窗 —— */
    .tw-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .tw-box{width:min(560px,94vw);background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
    .tw-head{padding:12px 14px;border-bottom:1px solid #243244;font-weight:700}
    .tw-body{padding:14px}
    .tw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .tw-btn{padding:10px;border:1px solid #243244;border-radius:12px;background:#0f1624;color:#e8edf3;cursor:pointer}
    .tw-btn.active{border-color:var(--gold2);box-shadow:0 0 0 2px rgba(212,175,55,.25) inset}
    .tw-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #243244}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }
   </style>   
<style>
@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}
html { font-size: 16px; }
@media (min-width: 768px){ html { font-size: 17px; } }
@media (min-width: 1200px){ html { font-size: 18px; } }
.site-header .brand .title,
.site-header .title{
  font-family: "Noto Serif SC","Noto Serif",serif !important;
  font-weight: 600 !important;
  letter-spacing: .02em;
  font-size: 1.1rem !important;
  line-height: 1.25;
}
  </style>
</head>
<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand">Soul Sanctuary</div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <div class="card">
    <div class="h2" data-i18n="form_title">九星气学 · 快速解读</div>
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
        <div class="muted" style="margin-top:6px" data-i18n="solar_tip">提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。</div>
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">主题</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">爱情/关系</option>
          <option value="career" data-i18n="topic_career">事业/工作</option>
          <option value="wealth" data-i18n="topic_wealth">财富/投资</option>
          <option value="family" data-i18n="topic_family">家庭/人际</option>
          <option value="health" data-i18n="topic_health">健康/身心</option>
          <option value="study" data-i18n="topic_study">学业/成长</option>
          <option value="move"  data-i18n="topic_move">旅行/搬迁</option>
          <option value="other" data-i18n="topic_other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="preset_label">常用问题</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">（可选）选择一个模板</option>
          <option data-i18n="preset_1">她/他爱我吗？我们接下来怎么走更好？</option>
          <option data-i18n="preset_2">我是否应该换工作/创业？需要注意什么？</option>
          <option data-i18n="preset_3">近期在投资与理财上，应如何取舍？</option>
          <option data-i18n="preset_4">如何改善与家人的关系与沟通？</option>
          <option data-i18n="preset_5">我最近健康/情绪的关键提醒是什么？</option>
        </select>
      </div>
    </div>
    <div class="row cols-1" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="q_label">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。"></textarea>
      </div>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">生成分析</button></div>
      <div><button id="clear" class="btn" style="background:#101826;color:#ffe084;border-color:#3a3f47" data-i18n="btn_clear">清空</button></div>
    </div>
  </div>

  <!-- 结果：主星 -->
  <div id="starCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_star">您的九星主星</div>
    <p><span data-i18n="star_label">主星</span>：<b id="starName"></b>（<span id="starJP"></span>）</p>
    <div id="starBadges" style="margin:6px 0"></div>
    <div id="starAbout" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 结果：AI 解读 -->
  <div id="aiCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_ai">心怜管家解读与建议</div>
    <pre id="aiText" style="white-space:pre-wrap;line-height:1.7"></pre>
    <div id="aiReco" style="margin-top:10px"></div>
  </div>

  <footer>© 5XLiving • Astro Sanctuary</footer>
</main>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
(function(){
  'use strict';

  /* ============== 基础常量/工具 ============== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  const LANG_KEY = 'site_lang';
  const qs  = (s,root=document)=>root.querySelector(s);
  const gid = (id)=>document.getElementById(id);

  /* ============== i18n 文案（沿用你的 six-lang；只补了九星字段） ============== */
  const I18N = {
    'zh-CN': {
      lang_label:'语言',
      page_title:'本命星盘｜Natal Chart',
      chat_fab:'问', chat_placeholder:'想了解什么？（如：功能、会员说明）', chat_send:'发送',
      butler_chat_title:'心怜管家 · Chat',
      // 九星页本身的文案
      form_title:'九星气学 · 快速解读',
      birth_label:'出生日期',
      solar_tip:'提示：九星以节分（立春，约 2/4）为换年点；1/1–2/3 计上一年。',
      topic_label:'主题',
      topic_love:'爱情/关系', topic_career:'事业/工作', topic_wealth:'财富/投资',
      topic_family:'家庭/人际', topic_health:'健康/身心', topic_study:'学业/成长',
      topic_move:'旅行/搬迁', topic_other:'其他',
      preset_label:'常用问题',
      preset_none:'（可选）选择一个模板',
      q_label:'你的具体问题（可直接粘贴）',
      q_ph:'例如：今天的课题是“她爱我吗”。希望得到清晰的下一步建议与避坑提醒。',
      btn_gen:'生成分析', btn_clear:'清空',
      sec_star:'您的九星主星', star_label:'主星',
      sec_ai:'心怜管家解读与建议',
      // 徽章标签
      badge_element:'五行', badge_dir:'方位', badge_color:'色彩', badge_keywords:'关键词',
      // AI 预设快捷
      chip_career:'事业解读', chip_love:'感情关系', chip_money:'财务建议', chip_list:'本周执行清单', chip_30d:'30天计划',
      q_career:'继续解读事业与团队协作', q_love:'说说感情与长期关系', q_money:'给我财务习惯、盲区与改善建议', q_list:'给我一份本周可执行清单', q_30d:'为我定一个30天成长计划',
      // 错误
      err_network:'网络异常', err_busy:'服务暂时繁忙，请稍后重试。',
      alert_birth:'请先选择出生日期'
    },
    'zh-TW': {
      lang_label:'語言',
      page_title:'本命星盤｜Natal Chart',
      chat_fab:'問', chat_placeholder:'想了解什麼？（例如：功能、會員說明）', chat_send:'傳送',
      butler_chat_title:'心怜管家 · Chat',
      form_title:'九星氣學 · 快速解讀',
      birth_label:'出生日期',
      solar_tip:'提示：九星以節分（立春，約 2/4）為換年點；1/1–2/3 計上一年。',
      topic_label:'主題',
      topic_love:'感情/關係', topic_career:'事業/工作', topic_wealth:'財富/投資',
      topic_family:'家庭/人際', topic_health:'健康/身心', topic_study:'學業/成長',
      topic_move:'旅行/搬遷', topic_other:'其他',
      preset_label:'常用問題',
      preset_none:'（可選）選一個模板',
      q_label:'你的具體問題（可直接貼上）',
      q_ph:'例如：今天的課題是「她愛我嗎」，希望得到下一步建議與避坑提醒。',
      btn_gen:'產生分析', btn_clear:'清空',
      sec_star:'你的九星主星', star_label:'主星',
      sec_ai:'心怜管家解讀與建議',
      badge_element:'五行', badge_dir:'方位', badge_color:'色彩', badge_keywords:'關鍵字',
      chip_career:'事業解讀', chip_love:'感情關係', chip_money:'財務建議', chip_list:'本週執行清單', chip_30d:'30天計畫',
      q_career:'繼續解讀事業與團隊協作', q_love:'說說感情與長期關係', q_money:'給我財務習慣、盲點與改善建議', q_list:'給我一份本週可執行清單', q_30d:'為我訂一個30天成長計畫',
      err_network:'網路異常', err_busy:'服務繁忙，請稍後再試。', alert_birth:'請先選擇出生日期'
    },
    'en': {
      lang_label:'Language',
      page_title:'Natal Chart',
      chat_fab:'Chat', chat_placeholder:'What would you like to know? (features, membership)', chat_send:'Send',
      butler_chat_title:'Xinlian Butler · Chat',
      form_title:'Nine Star Ki · Quick Reading',
      birth_label:'Birth Date',
      solar_tip:'Note: Nine Star Ki year changes at Setsubun (~Feb 4). Jan 1–Feb 3 counts as previous year.',
      topic_label:'Topic',
      topic_love:'Love/Relationships', topic_career:'Career/Work', topic_wealth:'Wealth/Investing',
      topic_family:'Family/Social', topic_health:'Health/Wellbeing', topic_study:'Study/Growth',
      topic_move:'Travel/Move', topic_other:'Other',
      preset_label:'Common prompts',
      preset_none:'(Optional) pick a template',
      q_label:'Your specific question',
      q_ph:'e.g., “Does she love me?” Please give clear next-step advice and pitfalls to avoid.',
      btn_gen:'Generate', btn_clear:'Clear',
      sec_star:'Your Main Star (Honmei)',
      star_label:'Main Star',
      sec_ai:'Butler’s Insights & Advice',
      badge_element:'Element', badge_dir:'Direction', badge_color:'Color', badge_keywords:'Keywords',
      chip_career:'Career', chip_love:'Relationships', chip_money:'Money Advice', chip_list:'Weekly To-Dos', chip_30d:'30-Day Plan',
      q_career:'Continue with career & teamwork insights', q_love:'Talk about love & long-term relationships', q_money:'Give me money habits, blind spots & improvements', q_list:'Give me an actionable list for this week', q_30d:'Make me a 30-day growth plan',
      err_network:'Network error', err_busy:'Service is busy. Please try again later.', alert_birth:'Please select your birth date first'
    },
    'ja': {
      lang_label:'言語',
      page_title:'出生ホロスコープ｜Natal Chart',
      chat_fab:'問', chat_placeholder:'機能・会員などご質問ください', chat_send:'送信',
      butler_chat_title:'心怜バトラー · チャット',
      form_title:'九星気学 · クイックリーディング',
      birth_label:'生年月日',
      solar_tip:'節分（およそ2/4）で年が切り替わります。1/1–2/3は前年扱い。',
      topic_label:'テーマ',
      topic_love:'恋愛/関係', topic_career:'仕事/キャリア', topic_wealth:'資産/投資',
      topic_family:'家族/人間関係', topic_health:'健康/心身', topic_study:'学び/成長',
      topic_move:'旅行/転居', topic_other:'その他',
      preset_label:'よくある質問',
      preset_none:'（任意）テンプレを選択',
      q_label:'具体的な質問',
      q_ph:'例：「彼女は私を愛している？」次の一歩と回避ポイントを知りたい。',
      btn_gen:'生成', btn_clear:'クリア',
      sec_star:'あなたの本命星',
      star_label:'本命星',
      sec_ai:'バトラーの解読と提案',
      badge_element:'五行', badge_dir:'方位', badge_color:'色', badge_keywords:'キーワード',
      chip_career:'キャリア', chip_love:'関係性', chip_money:'お金の助言', chip_list:'今週のToDo', chip_30d:'30日プラン',
      q_career:'キャリア/チーム連携を続けて分析', q_love:'恋愛/長期関係について話して', q_money:'お金の習慣・盲点・改善', q_list:'今週の実行リスト', q_30d:'30日成長プランを作って',
      err_network:'ネットワークエラー', err_busy:'混み合っています。後ほどお試しください。', alert_birth:'生年月日を選択してください'
    },
    'th': {
      lang_label:'ภาษา',
      page_title:'ดวงกำเนิด｜Natal Chart',
      chat_fab:'ถาม', chat_placeholder:'อยากรู้อะไรเกี่ยวกับฟีเจอร์/สมาชิก', chat_send:'ส่ง',
      butler_chat_title:'ผู้ช่วยซินเหลียน · แชต',
      form_title:'เก้าดาวคี (Nine Star Ki) · วิเคราะห์เร็ว',
      birth_label:'วันเกิด',
      solar_tip:'หมายเหตุ: ปีคีเปลี่ยนที่ Setsubun (~4 ก.พ.) วันที่ 1 ม.ค.–3 ก.พ. นับปีที่แล้ว',
      topic_label:'หัวข้อ',
      topic_love:'ความรัก/ความสัมพันธ์', topic_career:'งาน/อาชีพ', topic_wealth:'ทรัพย์สิน/การลงทุน',
      topic_family:'ครอบครัว/สังคม', topic_health:'สุขภาพ/ใจ-กาย', topic_study:'การเรียน/เติบโต',
      topic_move:'ท่องเที่ยว/ย้ายที่อยู่', topic_other:'อื่น ๆ',
      preset_label:'คำถามที่พบบ่อย',
      preset_none:'(ตัวเลือก) เลือกเทมเพลต',
      q_label:'คำถามของคุณ',
      q_ph:'เช่น “เขารักฉันไหม” ขอคำแนะนำขั้นถัดไปและสิ่งที่ควรหลีกเลี่ยง',
      btn_gen:'สร้างผล', btn_clear:'ล้าง',
      sec_star:'ดาวหลักของคุณ',
      star_label:'ดาวหลัก',
      sec_ai:'คำตีความ & คำแนะนำ',
      badge_element:'ธาตุ', badge_dir:'ทิศ', badge_color:'สี', badge_keywords:'คีย์เวิร์ด',
      chip_career:'การงาน', chip_love:'ความสัมพันธ์', chip_money:'คำแนะนำการเงิน', chip_list:'สิ่งที่ทำได้สัปดาห์นี้', chip_30d:'แผน 30 วัน',
      q_career:'วิเคราะห์การงานและทีมต่อ', q_love:'พูดถึงความรักและความสัมพันธ์ยาวนาน', q_money:'นิสัยเงิน จุดบอด และการปรับปรุง', q_list:'รายการทำได้จริงสัปดาห์นี้', q_30d:'วางแผนพัฒนา 30 วัน',
      err_network:'เครือข่ายผิดพลาด', err_busy:'ระบบหนาแน่น โปรดลองใหม่', alert_birth:'โปรดเลือกวันเกิดก่อน'
    },
    'ms': {
      lang_label:'Bahasa',
      page_title:'Carta Kelahiran｜Natal Chart',
      chat_fab:'Chat', chat_placeholder:'Tanya tentang ciri/keahlian', chat_send:'Hantar',
      butler_chat_title:'Xinlian Butler · Chat',
      form_title:'Nine Star Ki · Bacaan Pantas',
      birth_label:'Tarikh Lahir',
      solar_tip:'Nota: Tahun Ki berubah pada Setsubun (~4 Feb). 1 Jan–3 Feb dikira tahun sebelumnya.',
      topic_label:'Topik',
      topic_love:'Cinta/Hubungan', topic_career:'Kerjaya/ kerja', topic_wealth:'Kekayaan/Pelaburan',
      topic_family:'Keluarga/Sosial', topic_health:'Kesihatan/Jiwa-raga', topic_study:'Belajar/Pembangunan',
      topic_move:'Travel/Pindah', topic_other:'Lain-lain',
      preset_label:'Templat soalan',
      preset_none:'(Opsyenal) pilih templat',
      q_label:'Soalan khusus anda',
      q_ph:'cth: “Dia cintakan saya?” Beri langkah seterusnya dan perangkap yang patut dielak.',
      btn_gen:'Jana', btn_clear:'Kosongkan',
      sec_star:'Bintang Utama Anda',
      star_label:'Bintang',
      sec_ai:'Wawasan & Nasihat',
      badge_element:'Unsur', badge_dir:'Arah', badge_color:'Warna', badge_keywords:'Kata Kunci',
      chip_career:'Kerjaya', chip_love:'Hubungan', chip_money:'Nasihat Wang', chip_list:'Senarai Mingguan', chip_30d:'Pelan 30 Hari',
      q_career:'Teruskan wawasan kerjaya & pasukan', q_love:'Bincang cinta & hubungan jangka panjang', q_money:'Tabiat wang, titik buta & baik pulih', q_list:'Senarai tindakan minggu ini', q_30d:'Pelan perkembangan 30 hari',
      err_network:'Ralat rangkaian', err_busy:'Perkhidmatan sibuk. Cuba lagi kemudian.', alert_birth:'Sila pilih tarikh lahir dahulu'
    }
  };

  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  function getLang(){
    const saved = localStorage.getItem(LANG_KEY);
    if (saved && I18N[saved]) return saved;
    const raw = (navigator.language || 'zh-CN').replace('_','-');
    const map = {'zh':'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW',
                 'en':'en','en-US':'en','en-GB':'en','en-AU':'en','ja':'ja','ja-JP':'ja','th':'th','ms':'ms'};
    return map[raw] || 'zh-CN';
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  function t(key){
    const L = I18N[getLang()] || I18N['zh-CN'];
    return L[key] || (I18N['zh-CN'][key] || key);
  }
  function applyI18n(){
    const L = I18N[getLang()] || I18N['zh-CN'];
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = L[key] || I18N['zh-CN'][key];
      if (val != null) el.textContent = val;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const key = el.getAttribute('data-i18n-ph');
      const val = L[key] || I18N['zh-CN'][key];
      if (val != null) el.setAttribute('placeholder', val);
    });
    document.title = L['page_title'] || document.title;
    const sel = gid('langSelect'); if (sel) sel.value = getLang();
  }
  function applyChatI18n(){
    const fab = gid('ssChatFab');
    const inp = gid('ssChatInput');
    const btn = gid('ssChatSend');
    const title = qs('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('butler_chat_title');
  }
  function initLangUI(){
    const sel = gid('langSelect');
    if(!sel) return;
    const current = getLang();
    sel.value = current;
    document.documentElement.lang = current;
    applyI18n(); applyChatI18n();
    sel.addEventListener('change', ()=>{
      setLang(sel.value);
      applyI18n(); applyChatI18n();
      // 语言切换后，如果已有结果，按当前语言重渲染
      if (gid('starCard')?.style.display === 'block'){
        const d = gid('birthdate')?.value;
        if (d) {
          const ns = getNineStar(d);
          renderStarCard(ns);
        }
      }
    });
  }

  /* ============== 九星数据 & 计算（节分切年 2/4） ============== */
  // 1~9：一白水 ~ 九紫火
  const STAR_META = {
    1: { cn:'一白水星', jp:'一白水星（Ippaku Suisei）', elCN:'水', elEN:'Water', dirCN:'北',    dirEN:'North',     colorCN:'白/蓝', colorEN:'White/Blue',
         kwCN:'直觉 流动 沟通', kwEN:'Intuition, flow, communication',
         about:{
           'zh-CN':'感受力强、适应力高，擅长以温和方式连接人与资源；易犹豫或顾虑过多，给自己设置“决策时限”更顺。',
           'zh-TW':'感受力強、適應力高，擅長以溫和方式連結；易猶豫或顧慮過多，替自己設下「決策時限」。',
           'en':'Sensitive and adaptable; connects people and resources softly. Watch for over-caution—set clear decision deadlines.',
           'ja':'感受性が高く適応力あり。柔らかなつながりづくりが得意。慎重すぎに注意。決断期限を設けよう。'
         }},
    2: { cn:'二黑土星', jp:'二黒土星（Jikoku Dosei）',   elCN:'土', elEN:'Earth', dirCN:'西南', dirEN:'Southwest', colorCN:'棕/土黄', colorEN:'Brown/Earth',
         kwCN:'滋养 支援 耐心', kwEN:'Nurture, support, patience',
         about:{
           'zh-CN':'踏实照料型，能把想法落地；容易“过度承担”，学会委派与说“不”。',
           'zh-TW':'踏實照料型，能把想法落地；易「過度承擔」，練習授權與說不。',
           'en':'Grounded nurturer who executes steadily. Beware over-carrying—practice delegation and boundaries.',
           'ja':'堅実で支えるタイプ。着実に実行。背負い過ぎに注意。委任と境界線を意識して。'
         }},
    3: { cn:'三碧木星', jp:'三碧木星（Sanpeki Mokusei）', elCN:'木', elEN:'Wood', dirCN:'正东', dirEN:'East',      colorCN:'青/绿', colorEN:'Blue/Green',
         kwCN:'启动 表达 先锋', kwEN:'Starter, expression, pioneer',
         about:{
           'zh-CN':'行动与表达力强，敢于打头阵；急脾气或口快易伤人，练“先停一拍”更顺。',
           'zh-TW':'行動與表達力強，敢於打頭陣；口快易傷人，先停一拍更順。',
           'en':'Bold starter with strong voice. Guard against impulsive words—insert a pause before speaking.',
           'ja':'行動・発信が得意。早口や衝動的発言に注意。ひと呼吸おいて。'
         }},
    4: { cn:'四绿木星', jp:'四緑木星（Shiroku Mokusei）', elCN:'木', elEN:'Wood', dirCN:'东南', dirEN:'Southeast', colorCN:'绿', colorEN:'Green',
         kwCN:'协商 连结 流动', kwEN:'Mediation, networking, flow',
         about:{
           'zh-CN':'人缘广、擅协商，新机会常来自关系网；拖延和分心是课题，用“时间盒”管理精力。',
           'zh-TW':'人緣廣、善協商；拖延與分心是課題，用「時間盒」。',
           'en':'Networker and mediator; opportunities come via people. Fight drift with time-boxing.',
           'ja':'人脈と調整が強み。先延ばしを時間ボックスで対処。'
         }},
    5: { cn:'五黄土星', jp:'五黄土星（Goō Dosei）',      elCN:'土', elEN:'Earth', dirCN:'中宫', dirEN:'Center',    colorCN:'黄', colorEN:'Yellow',
         kwCN:'定盘 权威 转化', kwEN:'Center, authority, transformation',
         about:{
           'zh-CN':'气场强、能定盘与扭转局势；避免控制与冒进，守住“原则+风险边界”。',
           'zh-TW':'氣場強，能扭轉局勢；避免控制與冒進，守住原則與風險邊界。',
           'en':'Powerful presence; can transform situations. Avoid over-control; stick to principles and risk limits.',
           'ja':'存在感が強く変革力あり。支配と強引さに注意。原則とリスク管理を。'
         }},
    6: { cn:'六白金星', jp:'六白金星（Roppaku Kinsei）', elCN:'金', elEN:'Metal', dirCN:'西北', dirEN:'Northwest', colorCN:'白', colorEN:'White',
         kwCN:'标准 规划 领导', kwEN:'Standards, planning, leadership',
         about:{
           'zh-CN':'擅制定标准与远期规划；完美与自尊心强，学会“80 分先上”。',
           'zh-TW':'擅長標準與規劃；完美與自尊強，先上80分。',
           'en':'Strategic planner and standard-setter. Perfectionism is a trap—ship at 80%.',
           'ja':'基準づくりと計画が得意。完璧主義に注意。まず80%で出す。'
         }},
    7: { cn:'七赤金星', jp:'七赤金星（Shichiseki Kinsei）', elCN:'金', elEN:'Metal', dirCN:'正西', dirEN:'West',     colorCN:'赤/粉', colorEN:'Red/Rose',
         kwCN:'愉悦 口才 财运', kwEN:'Joy, eloquence, finances',
         about:{
           'zh-CN':'魅力沟通与审美在线；注意享乐与消费失衡，给“收入-储蓄-花销”做比例。',
           'zh-TW':'魅力與溝通強；注意享樂與消費失衡，做比例配置。',
           'en':'Charming communicator with taste. Guard against indulgence—use clear income/saving/spend ratios.',
           'ja':'魅力と会話力。浪費に注意。収入・貯蓄・支出の比率管理を。'
         }},
    8: { cn:'八白土星', jp:'八白土星（Happaku Dosei）',  elCN:'土', elEN:'Earth', dirCN:'东北', dirEN:'Northeast', colorCN:'白/乳', colorEN:'White/Cream',
         kwCN:'停变 积累 稳固', kwEN:'Stop–shift, accumulation, stability',
         about:{
           'zh-CN':'山之气，先停再变，擅持久积累；固执与闭塞是挑战，定期“断舍离”。',
           'zh-TW':'山之氣，先停再變；固執與閉塞，定期斷捨離。',
           'en':'Mountain energy—pause then change; excels at long-term accumulation. Avoid rigidity—declutter regularly.',
           'ja':'山の気。止めてから変える。頑固を手放し、定期的に手放す。'
         }},
    9: { cn:'九紫火星', jp:'九紫火星（Kyūshi Kasei）',   elCN:'火', elEN:'Fire', dirCN:'正南', dirEN:'South',     colorCN:'紫/红', colorEN:'Purple/Red',
         kwCN:'光彩 表达 学习', kwEN:'Radiance, expression, learning',
         about:{
           'zh-CN':'显化力与审美强、爱舞台；情绪起伏快，建立“输出-充电”的节律。',
           'zh-TW':'顯化與審美強、喜舞台；情緒起伏快，建立輸出-充電節律。',
           'en':'Radiant and expressive; loves the stage. Manage mood swings with output–recharge rhythms.',
           'ja':'発信と美意識が強い。気分の波に注意。出力と充電のリズムづくりを。'
         }}
  };

  // 2/4（含）起计入当年；1/1–2/3 计上一年
  function adjustedYearForSetsubun(dateStr){
    if(!dateStr) return null;
    const d = new Date(dateStr + 'T12:00:00');
    let y = d.getFullYear();
    const m = d.getMonth()+1, day = d.getDate();
    if (m < 2 || (m === 2 && day < 4)) y -= 1;
    return y;
  }
  // 本命星号：1~9
  // 公式：n = ((10 - (year % 9)) % 9) + 1
  function calcNineStarNumber(adjYear){
    const r = adjYear % 9;
    return ((10 - r) % 9) + 1;
  }
  function getNineStar(dateStr){
    const y = adjustedYearForSetsubun(dateStr);
    if (y == null) return null;
    const num = calcNineStarNumber(y);
    const meta = STAR_META[num];
    return { year:y, num, ...meta };
  }

  /* ============== 渲染：主星卡 ============== */
  function badge(label, value){
    return `<span style="display:inline-block;border:1px solid #2a3546;background:#0e1520;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:.9rem"><b style="color:#ffd88a">${label}：</b>${value}</span>`;
  }
  function renderStarCard(ns){
    if(!ns) return;
    const lang = getLang();
    const starName = (lang==='en') ? `${ns.cn} / ${ns.jp}` : ns.cn;
    gid('starCard').style.display = 'block';
    gid('starName').textContent = starName;
    gid('starJP').textContent = ns.jp;
    const elLabel = t('badge_element'), dirLabel=t('badge_dir'), colorLabel=t('badge_color'), kwLabel=t('badge_keywords');
    const elVal   = (lang==='en') ? ns.elEN : ns.elCN;
    const dirVal  = (lang==='en') ? ns.dirEN : ns.dirCN;
    const colorVal= (lang==='en') ? ns.colorEN : ns.colorCN;
    const kwVal   = (lang==='en') ? ns.kwEN : ns.kwCN;
    gid('starBadges').innerHTML = [
      badge(elLabel, elVal),
      badge(dirLabel, dirVal),
      badge(colorLabel, colorVal),
      badge(kwLabel, kwVal)
    ].join('');
    const about = ns.about?.[lang] || ns.about?.['zh-CN'] || '';
    gid('starAbout').textContent = about;
  }

  /* ============== Butler（AI） ============== */
  function mdToHtml(md){
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  function buildButlerSystemPrompt(lang){
    const ln = BUTLER_LANG_NAME[lang] || 'Simplified Chinese';
    // 为九星气学定制的输出骨架（不作医疗/法律/保证性断言）
    const H = {
      'zh-CN': ['人物画像（基于本命星）','关系沟通','事业与执行','财富与节律','可执行清单（本周/30天）','温柔提醒（避坑）'],
      'zh-TW': ['人物画像（本命星）','關係溝通','事業與執行','財富與節律','可執行清單（本週/30天）','溫柔提醒（避坑）'],
      'en':    ['Persona (Honmei-based)','Relationships','Career & Execution','Money & Rhythms','Action List (This Week / 30 Days)','Gentle Cautions'],
      'ja':    ['人物像（本命星ベース）','関係性','キャリアと実行','お金とリズム','実行リスト（今週/30日）','やさしい注意点'],
      'th':    ['ภาพบุคคล (ดาวหลัก)','ความสัมพันธ์','การงาน & การลงมือ','การเงิน & จังหวะ','รายการทำ (สัปดาห์นี้/30 วัน)','คำเตือนอ่อนโยน'],
      'ms':    ['Persona (Bintang Utama)','Hubungan','Kerjaya & Pelaksanaan','Wang & Ritma','Senarai Tindakan (Minggu/30 Hari)','Peringatan Lembut']
    }[lang] || H['zh-CN'];
    return [
      `You are "Xinlian Butler". OUTPUT LANGUAGE: ${ln}. Reply strictly in ${ln}.`,
      'Use Nine Star Ki (honmei star) as context. Warm, practical, actionable. No medical/legal/financial guarantees.',
      'Markdown sections:',
      `## ${H[0]}`,
      `## ${H[1]} (2–4 bullets)`,
      `## ${H[2]} (2–4 bullets)`,
      `## ${H[3]} (2–3 bullets)`,
      `## ${H[4]} (3–6 bullets; start with verbs; quantify when possible)`,
      `## ${H[5]}`
    ].join('\n');
  }
  async function runAI(ns){
    if(!ns) return;
    const lang = getLang();
    const topic = gid('topic')?.value || 'other';
    const q = gid('question')?.value?.trim() || '';
    const topicText = ({
      'zh-CN':{
        love:'感情/关系', career:'事业/工作', wealth:'财富/投资', family:'家庭/人际', health:'健康/身心', study:'学业/成长', move:'旅行/搬迁', other:'其他'
      },
      'zh-TW':{
        love:'感情/關係', career:'事業/工作', wealth:'財富/投資', family:'家庭/人際', health:'健康/身心', study:'學業/成長', move:'旅行/搬遷', other:'其他'
      },
      'en':{
        love:'Love/Relationships', career:'Career/Work', wealth:'Wealth/Investing', family:'Family/Social', health:'Health/Wellbeing', study:'Study/Growth', move:'Travel/Move', other:'Other'
      },
      'ja':{
        love:'恋愛/関係', career:'仕事/キャリア', wealth:'資産/投資', family:'家族/人間関係', health:'健康/心身', study:'学び/成長', move:'旅行/転居', other:'その他'
      },
      'th':{
        love:'ความรัก/ความสัมพันธ์', career:'งาน/อาชีพ', wealth:'ทรัพย์สิน/การลงทุน', family:'ครอบครัว/สังคม', health:'สุขภาพ/ใจ-กาย', study:'การเรียน/เติบโต', move:'ท่องเที่ยว/ย้าย', other:'อื่น ๆ'
      },
      'ms':{
        love:'Cinta/Hubungan', career:'Kerjaya/kerja', wealth:'Kekayaan/Pelaburan', family:'Keluarga/Sosial', health:'Kesihatan/Jiwa-raga', study:'Belajar/Pembangunan', move:'Travel/Pindah', other:'Lain-lain'
      }
    }[lang]||{})[topic] || topic;

    const sys = buildButlerSystemPrompt(lang);
    const usr = [
      `Nine Star Ki main star: ${ns.cn} / ${ns.jp} (#${ns.num})`,
      `Element: ${(lang==='en'?ns.elEN:ns.elCN)}; Direction: ${(lang==='en'?ns.dirEN:ns.dirCN)}; Keywords: ${(lang==='en'?ns.kwEN:ns.kwCN)}`,
      `Adjusted Year (Setsubun rule): ${ns.year}`,
      `Focus Topic: ${topicText}`,
      q ? `Question: ${q}` : ''
    ].filter(Boolean).join('\n');

    const box = gid('aiCard');
    const pre = gid('aiText');
    box.style.display = 'block';
    if(pre) pre.textContent = '…';

    try{
      const r = await fetch(API_BASE + '/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({messages:[
          {role:'system',content:sys},
          {role:'user',content:usr}
        ]})
      });
      const data = await r.json().catch(()=>({}));
      const raw  = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      if(pre){
        // 用 <pre>，保持原样；也可改成富文本：
        pre.innerHTML = mdToHtml(raw || '');
      }
    }catch(e){
      if(pre) pre.textContent = `${t('err_network')}: ${e?.message||''}`;
    }
  }

  /* ============== 交互：生成 & 清空 & 预设模板 ============== */
  function onGenerate(){
    const d = gid('birthdate')?.value;
    if(!d){ alert(t('alert_birth')); return; }
    const ns = getNineStar(d);
    renderStarCard(ns);
    runAI(ns);
  }
  function onClear(){
    gid('birthdate').value = '';
    gid('question').value = '';
    gid('starCard').style.display = 'none';
    gid('aiCard').style.display = 'none';
  }
  function onPresetChange(){
    const sel = gid('presetQ');
    const v = sel?.value || '';
    if(!v) return;
    gid('question').value = sel.options[sel.selectedIndex].textContent || '';
  }

  /* ============== 右下角 Chat 浮窗（保留你的实现） ============== */
  function mountChat(){
    if (gid('ssChatFab')) return;
    const chatFab=document.createElement('div'); chatFab.className='ss-chat-fab'; chatFab.id='ssChatFab'; chatFab.title=t('butler_chat_title');
    const chatPanel=document.createElement('div'); chatPanel.className='ss-chat-panel'; chatPanel.id='ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label',t('butler_chat_title'));
    chatPanel.innerHTML = `
      <div class="ss-chat-head"><div class="ss-chat-title">${t('butler_chat_title')}</div><div class="ss-close" id="ssChatClose">✕</div></div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')}"/>
        <button id="ssChatSend" class="btn">${t('chat_send')}</button>
      </div>`;
    document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
    applyChatI18n();

    const $body=gid('ssChatBody'), $input=gid('ssChatInput'), $send=gid('ssChatSend'), $close=gid('ssChatClose');
    const openPanel=()=>{ chatPanel.style.display='block'; $input&&$input.focus(); };
    const closePanel=()=>{ chatPanel.style.display='none'; };
    chatFab.addEventListener('click',openPanel); $close&&$close.addEventListener('click',closePanel);

    function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
    async function askChat(prompt){
      addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
      const sys = [
        `You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese'}.`,
        'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'
      ].join('\n');
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({messages:[
            {role:'system',content:sys},
            {role:'user',content:prompt}
          ]})
        });
        const data=await r.json().catch(()=>({}));
        const reply=data?.reply??data?.text??data?.choices?.[0]?.message?.content??'';
        addMsg(reply || t('err_busy'));
      }catch(e){ addMsg(`${t('err_network')}，${t('err_busy')}`); }
    }
    $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
    $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
  }

  /* ============== 页面初始化 ============== */
  document.addEventListener('DOMContentLoaded', ()=>{
    // 默认今天，便于测试
    if (gid('birthdate') && !gid('birthdate').value){
      gid('birthdate').value = new Date().toISOString().split('T')[0];
    }
    initLangUI();
    mountChat();

    // 绑定按钮
    gid('go')?.addEventListener('click', onGenerate);
    gid('clear')?.addEventListener('click', onClear);
    gid('presetQ')?.addEventListener('change', onPresetChange);
  });

})();
</script>
</body>
</html>



