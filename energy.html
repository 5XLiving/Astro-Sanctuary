<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">能量类型分析 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#0b0f14;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.badge{display:inline-block;padding:3px 10px;border:1px solid var(--gold);color:var(--gold);border-radius:999px;margin-right:6px;margin-top:4px}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* Chat */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:85%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}

/* 放大 Chat 字体 */
.ss-chat-panel { font-size: 15.5px; }
.ss-chat-head  { font-size: 16.5px; }
.ss-chat-body { gap: 10px; }
.ss-msg{ font-size: 15.5px; line-height: 1.65; padding: 10px 12px; border-radius: 12px; max-width: 95%; }
.ss-msg.me{ font-size: 15.5px; line-height: 1.65; padding: 10px 12px; border-radius: 12px; }
.ss-chat-input input{ font-size: 15.5px; height: 44px; padding: 10px 12px; }
.ss-chat-input button{ font-size: 15.5px; height: 44px; padding: 0 14px; }
@media (max-width: 480px){
  .ss-chat-panel { font-size: 16px; }
  .ss-msg, .ss-msg.me { font-size: 16px; line-height: 1.7; }
  .ss-chat-input input, .ss-chat-input button { height: 46px; font-size: 16px; }
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand">Soul Sanctuary</div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 表单 -->
  <div class="card">
    <div class="h2" data-i18n="form_title">能量类型分析 · 快速解读</div>

    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="name_label">姓名（可选）</label>
        <input type="text" id="name" data-i18n-ph="name_ph" placeholder="你的称呼（用于个性化称呼）">
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">性别</label>
        <select id="gender">
          <option value="" data-i18n="gender_unknown">不透露</option>
          <option value="male" data-i18n="gender_male">男性</option>
          <option value="female" data-i18n="gender_female">女性</option>
          <option value="other" data-i18n="gender_other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="birth_time_label">出生时间（可选）</label>
        <input type="time" id="birthtime">
      </div>
      <div>
        <label class="muted" data-i18n="birth_place_label">出生地点（可选）</label>
        <input type="text" id="birthplace" data-i18n-ph="birth_place_ph" placeholder="城市/国家">
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">关注主题</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">爱情/关系</option>
          <option value="career" data-i18n="topic_career">事业/工作</option>
          <option value="wealth" data-i18n="topic_wealth">财富/投资</option>
          <option value="family" data-i18n="topic_family">家庭/人际</option>
          <option value="health" data-i18n="topic_health">健康/身心</option>
          <option value="study" data-i18n="topic_study">学业/成长</option>
          <option value="move"  data-i18n="topic_move">旅行/搬迁</option>
          <option value="other" data-i18n="topic_other">其他</option>
        </select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="preset_label">常用问题</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">（可选）选择一个模板</option>
          <option data-i18n="preset_1">我现在的能量状态有什么特点？</option>
          <option data-i18n="preset_2">怎么用对策略，减少内耗？</option>
          <option data-i18n="preset_3">近期在事业/合作上如何对齐节奏？</option>
          <option data-i18n="preset_4">关系里的能量互动有什么提醒？</option>
          <option data-i18n="preset_5">如何建立稳定的情绪与界限？</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label class="muted" data-i18n="q_label">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="例如：最近总是感到疲惫内耗，想知道我的能量策略是什么、下一步该做什么。"></textarea>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">生成分析</button></div>
      <div><button id="clear" class="btn" style="background:#101826;color:#ffe084;border-color:#3a3f47" data-i18n="btn_clear">清空</button></div>
    </div>
  </div>

  <!-- 结果：AI 解读 -->
  <div id="aiCard" class="section card" style="display:none">
    <div class="h2" data-i18n="sec_ai">心怜管家解读与建议</div>
    <pre id="aiText" style="white-space:pre-wrap;line-height:1.7"></pre>
    <div id="aiReco" style="margin-top:10px"></div>
  </div>

  <footer>© 5XLiving • Astro/Soul Sanctuary</footer>
</main>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
/* ===== 配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers
const LANG_KEY = "site_lang";

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

/* ===== i18n ===== */
const i18n = {
  "zh-CN": {
    title:"能量类型分析 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
    form_title:"能量类型分析 · 快速解读",
    name_label:"姓名（可选）", name_ph:"你的称呼（用于个性化称呼）",
    gender_label:"性别", gender_unknown:"不透露", gender_male:"男性", gender_female:"女性", gender_other:"其他",
    birth_label:"出生日期", birth_time_label:"出生时间（可选）", birth_place_label:"出生地点（可选）", birth_place_ph:"城市/国家",
    topic_label:"关注主题",
    topic_love:"爱情/关系", topic_career:"事业/工作", topic_wealth:"财富/投资",
    topic_family:"家庭/人际", topic_health:"健康/身心", topic_study:"学业/成长",
    topic_move:"旅行/搬迁", topic_other:"其他",
    preset_label:"常用问题", preset_none:"（可选）选择一个模板",
    preset_1:"我现在的能量状态有什么特点？",
    preset_2:"怎么用对策略，减少内耗？",
    preset_3:"近期在事业/合作上如何对齐节奏？",
    preset_4:"关系里的能量互动有什么提醒？",
    preset_5:"如何建立稳定的情绪与界限？",
    q_label:"你的具体问题（可直接粘贴）",
    q_ph:"例如：最近总是感到疲惫内耗，想知道我的能量策略是什么、下一步该做什么。",
    btn_gen:"生成分析", btn_clear:"清空",
    sec_ai:"心怜管家解读与建议",
    chat_fab:"问", chat_title:"心怜管家 · Chat", chat_ph:"想了解什么？（如：如何开始免费体验）", chat_send:"发送",
    need_birth:"请至少选择出生日期（可留空时间/地点）",
    generating:"正在生成解读…",
    reco_title:"心怜管家推举内容",
    retry:"抱歉，暂时无法生成，请稍后再试。", neterr:"网络异常，请稍后再试。"
  },
  "en": {
    title:"Energy Type Analysis · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
    form_title:"Energy Type · Quick Reading",
    name_label:"Name (optional)", name_ph:"How to address you",
    gender_label:"Gender", gender_unknown:"Prefer not to say", gender_male:"Male", gender_female:"Female", gender_other:"Other",
    birth_label:"Birthdate", birth_time_label:"Time of birth (optional)", birth_place_label:"Place of birth (optional)", birth_place_ph:"City/Country",
    topic_label:"Focus topic",
    topic_love:"Love/Relationship", topic_career:"Career/Work", topic_wealth:"Wealth/Investment",
    topic_family:"Family/Social", topic_health:"Health/Mind-Body", topic_study:"Study/Growth",
    topic_move:"Travel/Move", topic_other:"Other",
    preset_label:"Quick questions", preset_none:"(Optional) Choose a template",
    preset_1:"What are the features of my current energy state?",
    preset_2:"How to use the right strategy and reduce drain?",
    preset_3:"How to align rhythm for career/collab recently?",
    preset_4:"Any reminders for energy dynamics in relationships?",
    preset_5:"How to build steady emotions and boundaries?",
    q_label:"Your specific question (paste here)",
    q_ph:"E.g. I feel drained recently. What’s my best energy strategy and next steps?",
    btn_gen:"Generate Reading", btn_clear:"Clear",
    sec_ai:"Concierge Reading & Advice",
    chat_fab:"Chat", chat_title:"Concierge · Chat", chat_ph:"Ask me anything", chat_send:"Send",
    need_birth:"Please select at least your birthdate (time/place optional).",
    generating:"Generating reading…",
    reco_title:"Concierge Recommendations",
    retry:"Sorry, couldn’t generate for now.", neterr:"Network error. Try again later."
  },
  "ms": {
    title:"Analisis Jenis Tenaga · 5XLiving", brand:"Soul Sanctuary", lang_label:"Bahasa",
    form_title:"Jenis Tenaga · Ringkasan",
    name_label:"Nama (pilihan)", name_ph:"Cara memanggil anda",
    gender_label:"Jantina", gender_unknown:"Rahsiakan", gender_male:"Lelaki", gender_female:"Perempuan", gender_other:"Lain",
    birth_label:"Tarikh lahir", birth_time_label:"Masa lahir (pilihan)", birth_place_label:"Tempat lahir (pilihan)", birth_place_ph:"Bandar/Negara",
    topic_label:"Topik fokus",
    topic_love:"Cinta/Hubungan", topic_career:"Kerjaya", topic_wealth:"Kewangan/Pelaburan",
    topic_family:"Keluarga/Sosial", topic_health:"Kesihatan/Emosi", topic_study:"Pembelajaran",
    topic_move:"Perjalanan/Pindah", topic_other:"Lain-lain",
    preset_label:"Soalan pantas", preset_none:"(Pilihan) Pilih templat",
    preset_1:"Apakah ciri tenaga saya kini?",
    preset_2:"Bagaimana guna strategi betul & kurangkan keletihan?",
    preset_3:"Selaraskan rentak untuk kerjaya/kolaborasi?",
    preset_4:"Peringatan dinamik tenaga dalam hubungan?",
    preset_5:"Bina emosi stabil dan sempadan?",
    q_label:"Soalan khusus anda",
    q_ph:"Contoh: saya rasa letih; apakah strategi tenaga terbaik & langkah seterusnya?",
    btn_gen:"Jana Analisis", btn_clear:"Kosongkan",
    sec_ai:"Bacaan & Nasihat Concierge",
    chat_fab:"Tanya", chat_title:"Concierge · Sembang", chat_ph:"Tanya apa-apa", chat_send:"Hantar",
    need_birth:"Sila pilih sekurang-kurangnya tarikh lahir (masa/tempat pilihan).",
    generating:"Menjana bacaan…",
    reco_title:"Cadangan Concierge",
    retry:"Maaf, gagal jana buat masa ini.", neterr:"Ralat rangkaian."
  }
};

function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n"); el.textContent = t(k);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k));
  });
  const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']");
  if(titleEl){ titleEl.textContent=t("title"); }
}

/* ===== Chat 浮窗 ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      let data={}; try{data=await r.json()}catch{}
      const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||t('retry'));
    }catch{ addMsg(t('neterr')); }
  }
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();

/* ===== 组装给 GPT 的提示词（能量类型） ===== */
function buildPromptEnergy({langName, name, gender, birthdate, birthtime, birthplace, topic, question}){
  const topicMap = ({
    "zh-CN": {love:"爱情/关系",career:"事业/工作",wealth:"财富/投资",family:"家庭/人际",health:"健康/身心",study:"学业/成长",move:"旅行/搬迁",other:"其他"},
    "en":     {love:"Love/Relationship",career:"Career/Work",wealth:"Wealth/Investment",family:"Family/Social",health:"Health/Mind-Body",study:"Study/Growth",move:"Travel/Move",other:"Other"},
    "ms":     {love:"Cinta/Hubungan",career:"Kerjaya",wealth:"Kewangan/Pelaburan",family:"Keluarga/Sosial",health:"Kesihatan/Emosi",study:"Pembelajaran",move:"Perjalanan/Pindah",other:"Lain-lain"}
  })[getLang()] || {};

  const basic = [
    name ? `称呼：${name}` : null,
    gender ? `性别：${gender}` : null,
    birthdate ? `生日：${birthdate}` : null,
    birthtime ? `时间：${birthtime}` : null,
    birthplace ? `地点：${birthplace}` : null
  ].filter(Boolean).join('；');

  return `你是 5XLiving 的“心怜管家”，同时是资深能量类型教练（融合能量策略/情绪管理/界限练习/节奏规划）。请使用【${langName}】输出，语气温暖、专业、可落地。

用户基础信息：${basic || '（用户未提供更多信息）'}
关注主题：${topicMap[topic] || topic}
用户问题：${question || '（无具体问题，请给通用提示）'}

请按以下结构输出（不要多余前后缀）：
# 核心判断（2-4句，概括能量节奏与策略抓手）
# 现在要做的事（列3条，动词开头、可执行）
# 避坑提醒（列2-3条，具体到行为）
# 能量练习（2-3条：冥想/呼吸/书写/仪式/节律；给操作要点和频次）
# AI 推举内容（3-5条，结合本站：预约一对一、加入VIP、课程/练习包、御守/许愿、把计划存入心怜笔记等，写成建议句式）`;
}

/* ===== 请求 AI ===== */
async function askAI(prompt){
  const resp = await fetch(`${API_BASE}/api/chat`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[
      {role:'system',content:'你将产出结构化的能量类型建议，务必简明清晰、可执行。'},
      {role:'user',content:prompt}
    ]})
  });
  let data={}; try{data=await resp.json()}catch{}
  return data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? '';
}

/* ===== 交互 ===== */
$('presetQ').addEventListener('change',e=>{
  const v=e.target.value; if(v){ const q=$('question'); q.value = q.value? q.value+'\n'+v : v; }
});

$('clear').addEventListener('click',()=>{
  ['name','gender','birthdate','birthtime','birthplace','question'].forEach(id=>{
    if($(id)) $(id).value = id==='gender' ? '' : '';
  });
  $('presetQ').value=''; $('topic').value='love';
  $('aiCard').style.display='none'; $('aiText').textContent=''; $('aiReco').innerHTML='';
});

$('go').addEventListener('click', async ()=>{
  const L = i18n[getLang()]||i18n["zh-CN"];
  const birthdate = $('birthdate').value.trim();
  if(!birthdate){ alert(L.need_birth); return; }

  const payload = {
    langName: ({'zh-CN':'简体中文','zh-TW':'繁體中文','en':'English','ms':'Bahasa Melayu'})[getLang()] || '简体中文',
    name: $('name').value.trim(),
    gender: $('gender').value,
    birthdate,
    birthtime: $('birthtime').value.trim(),
    birthplace: $('birthplace').value.trim(),
    topic: $('topic').value,
    question: ( $('question').value || $('presetQ').value || '' ).trim()
  };

  const prompt = buildPromptEnergy(payload);
  $('aiText').textContent = L.generating;
  $('aiCard').style.display='block';

  try{
    const txt = await askAI(prompt);
    $('aiText').textContent = txt || L.retry;

    const recos=[];
    (txt||'').split('\n').forEach(l=>{
      if(/推举|推荐|VIP|预约|课程|练习|许愿|御守|笔记|会员/i.test(l)) recos.push(l.trim());
    });
    $('aiReco').innerHTML = recos.length
      ? `<div class="h2">${L.reco_title}</div><ul style="margin:.3rem 0 .2rem .9rem">${recos.slice(0,5).map(x=>`<li>${x}</li>`).join('')}</ul>`
      : '';
  }catch(e){
    $('aiText').textContent = L.neterr;
  }
});

/* ===== 语言切换 ===== */
const sel = $('langSelect');
sel.value = getLang();
applyI18n();
sel.addEventListener('change', ()=>{
  setLang(sel.value);
  applyI18n();
});
document.documentElement.lang = getLang();
applyI18n();
</script>
</body>
</html>
