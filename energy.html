<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">èƒ½é‡ç±»å‹åˆ†æ Â· 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    --glow: 0 0 0 1px rgba(212,175,55,.28), 0 8px 30px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
  .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
  .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem; line-height:1.25}
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{white-space:nowrap; color:var(--muted)}
  .lang select{
    appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
    background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }
  .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
  .h2{font-weight:800;color:#ffe084;margin:0 0 10px}
  .sub{color:var(--muted)}
  .card{background:#11161dcc;border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .row{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
  label.muted{display:block;margin-bottom:4px;color:#98a7b7}
  input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:#e8edf3;padding:12px;font-size:15px;outline:none}
  textarea{min-height:96px}
  input::placeholder,textarea::placeholder{color:#6f8092}
  .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
  .btn.secondary{background:#101826;color:#ffe084;border-color:#3a3f47}
  .btn.ghost{background:transparent;color:#ffe084;border:1px solid rgba(230,199,110,.6)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .muted{color:#98a7b7}
  .error{color:#ff8b8b}
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

  /* ============ æ–°å¢ï¼šé«˜çº§é€‰é¡¹ã€å°ç»„ä»¶ã€ç¾åŒ– ============ */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a3546;border-radius:999px;background:#0e1520;color:#e8edf3}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:8px 0 6px}
  .kpi{padding:10px;border:1px solid #243244;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
  .kpi .k{color:#98a7b7;font-size:.88rem}
  .kpi .v{font-weight:800;color:#ffe084;margin-top:4px}
  .note{font-size:.9rem;color:#98a7b7}

  /* AI result */
  #aiCard .skeleton, #sysCard .skeleton{display:grid;gap:8px}
  #aiCard .skeleton div, #sysCard .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  #aiText, #sysText{white-space:normal;line-height:1.7}
  #aiText ul, #sysText ul{margin:.4rem 0 .2rem 1.2rem}
  /* æ–‡å†…æ ‡é¢˜ä¸å¡ç‰‡æ ‡é¢˜åŒè‰²ï¼ˆç³»ç»Ÿ/ç®¡å®¶åŒè‰²ï¼‰ */
  #aiText h2, #aiText h3, #sysText h2, #sysText h3{
    color:#ffe084 !important;
    margin:12px 0 6px;
    font-size:1.05rem;
    font-weight:800;
  }

  /* Chat */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}

  /* æ‰“å°ä¼˜åŒ– */
  @media print{
    .site-header,.ss-chat-fab,.ss-chat-panel,.lang,.toolbar button{display:none!important}
    body{background:#fff;color:#000}
    .card{box-shadow:none;background:#fff;border:0}
    .container{padding:0}
  }
</style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· <span data-i18n="brand">Soul Sanctuary</span></span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <h1 class="h1" data-i18n="title">èƒ½é‡ç±»å‹åˆ†æ Â· 5XLiving</h1>

  <!-- è¡¨å• -->
  <div class="card">
    <div class="h2" data-i18n="form_title">èƒ½é‡ç±»å‹åˆ†æ Â· å¿«é€Ÿè§£è¯»</div>
    <div id="err" class="error" style="display:none"></div>

    <!-- Row 1 -->
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="name_label">å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="name" data-i18n-ph="name_ph" placeholder="ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ç§°å‘¼ï¼‰">
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">æ€§åˆ«</label>
        <select id="gender">
          <option value="" data-i18n="gender_unknown">ä¸é€éœ²</option>
          <option value="male" data-i18n="gender_male">ç”·æ€§</option>
          <option value="female" data-i18n="gender_female">å¥³æ€§</option>
          <option value="other" data-i18n="gender_other">å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="birth_place_label">å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="birthplace" data-i18n-ph="birth_place_ph" placeholder="åŸå¸‚/å›½å®¶">
      </div>
    </div><!-- /Row 1 -->

    <!-- Row 2 -->
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="birth_label">å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted" data-i18n="birth_time_label">å‡ºç”Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
        <input type="time" id="birthtime">
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">å…³æ³¨ä¸»é¢˜</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">çˆ±æƒ…/å…³ç³»</option>
          <option value="career" data-i18n="topic_career">äº‹ä¸š/å·¥ä½œ</option>
          <option value="wealth" data-i18n="topic_wealth">è´¢å¯Œ/æŠ•èµ„</option>
          <option value="family" data-i18n="topic_family">å®¶åº­/äººé™…</option>
          <option value="health" data-i18n="topic_health">å¥åº·/èº«å¿ƒ</option>
          <option value="study" data-i18n="topic_study">å­¦ä¸š/æˆé•¿</option>
          <option value="move"  data-i18n="topic_move">æ—…è¡Œ/æ¬è¿</option>
          <option value="other" data-i18n="topic_other">å…¶ä»–</option>
        </select>
      </div>
    </div><!-- /Row 2 -->

    <!-- Row 3 -->
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="preset_label">å¸¸ç”¨é—®é¢˜</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">ï¼ˆå¯é€‰ï¼‰é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿</option>
          <option data-i18n="preset_1">æˆ‘ç°åœ¨çš„èƒ½é‡çŠ¶æ€æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</option>
          <option data-i18n="preset_2">æ€ä¹ˆç”¨å¯¹ç­–ç•¥ï¼Œå‡å°‘å†…è€—ï¼Ÿ</option>
          <option data-i18n="preset_3">è¿‘æœŸåœ¨äº‹ä¸š/åˆä½œä¸Šå¦‚ä½•å¯¹é½èŠ‚å¥ï¼Ÿ</option>
          <option data-i18n="preset_4">å…³ç³»é‡Œçš„èƒ½é‡äº’åŠ¨æœ‰ä»€ä¹ˆæé†’ï¼Ÿ</option>
          <option data-i18n="preset_5">å¦‚ä½•å»ºç«‹ç¨³å®šçš„æƒ…ç»ªä¸ç•Œé™ï¼Ÿ</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label class="muted" data-i18n="q_label">ä½ çš„å…·ä½“é—®é¢˜ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç–²æƒ«å†…è€—ï¼Œæƒ³çŸ¥é“æˆ‘çš„èƒ½é‡ç­–ç•¥æ˜¯ä»€ä¹ˆã€ä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆã€‚"></textarea>
      </div>
    </div><!-- /Row 4 -->
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">ç”Ÿæˆåˆ†æ</button></div>
      <div><button id="clear" class="btn secondary" data-i18n="btn_clear">æ¸…ç©º</button></div>
    </div><!-- /Row 4 -->
  </div><!-- /card form -->

  <!-- ç»“æœï¼šç®¡å®¶å»ºè®®åœ¨ä¸‹ï¼ˆæ¸©æš–ï¼‰ -->
  <div id="aiCard" class="card" style="display:none">
    <div class="h2" data-i18n="sec_ai">å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®</div>
    <div id="aiText"></div>
  </div>

  <!-- ä¼šå‘˜åŒºï¼ˆå±•ç¤ºç”¨ï¼‰ -->
  <section class="card section">
    <h2 class="h2" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="row cols-2">
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul class="muted" style="margin:.2rem 0 0 1.1rem">
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul class="muted" style="margin:.2rem 0 0 1.1rem">
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="h3" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
    <div class="row cols-2">
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
        <div class="row" id="authFields">
          <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
          <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
          <input id="password" type="password" autocomplete="new-password" data-i18n-ph="ph_password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" required/>
        </div>
        <div class="row cols-2" style="margin-top:10px">
          <button class="btn" id="loginBtn" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
          <button class="btn secondary" id="resetBtn" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="registerBtn" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
          <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
          <div class="error" id="authError" style="display:none"></div>
        </div>
      </div>
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
        <div class="row">
          <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
          <a class="btn secondary" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
          <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>Â© 5XLiving â€¢ Astro/Soul Sanctuary</footer>

<!-- Chat æµ®çª— -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">é—®</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div class="ss-chat-title" data-i18n="chat_title">å¿ƒæ€œç®¡å®¶ Â· Chat</div>
    <div id="ssChatClose" style="cursor:pointer">âœ•</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="é—®ç‚¹ä»€ä¹ˆå§â€¦"/>
    <button id="ssChatSend" class="btn" data-i18n="chat_send">å‘é€</button>
  </div>
</div>

<script>
(function(){
  "use strict";

  /* ===== é…ç½® ===== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // â† æ”¹æˆä½ çš„ Workers
  const LANG_KEY = "site_lang";

  /* ===== å°å·¥å…· ===== */
  const $ = (id) => document.getElementById(id);
  const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
  const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };
  const copyText = async (txt) => { try{ await navigator.clipboard.writeText(txt); alert(t('copied_ok')||'å·²å¤åˆ¶'); }catch{ } };
  const download = (name, content) => {
    const blob = new Blob([content], {type:'text/markdown;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()}, 0);
  };

  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese',
    'en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  /* ===== i18n ===== */
  const i18n = {
    "zh-CN": {
      title:"èƒ½é‡ç±»å‹åˆ†æ Â· 5XLiving", brand:"Soul Sanctuary", lang_label:"è¯­è¨€",
      form_title:"èƒ½é‡ç±»å‹åˆ†æ Â· å¿«é€Ÿè§£è¯»",
      name_label:"å§“åï¼ˆå¯é€‰ï¼‰", name_ph:"ä½ çš„ç§°å‘¼ï¼ˆç”¨äºä¸ªæ€§åŒ–ç§°å‘¼ï¼‰",
      gender_label:"æ€§åˆ«", gender_unknown:"ä¸é€éœ²", gender_male:"ç”·æ€§", gender_female:"å¥³æ€§", gender_other:"å…¶ä»–",
      birth_label:"å‡ºç”Ÿæ—¥æœŸ", birth_time_label:"å‡ºç”Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰", birth_place_label:"å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¯é€‰ï¼‰", birth_place_ph:"åŸå¸‚/å›½å®¶",
      topic_label:"å…³æ³¨ä¸»é¢˜",
      topic_love:"çˆ±æƒ…/å…³ç³»", topic_career:"äº‹ä¸š/å·¥ä½œ", topic_wealth:"è´¢å¯Œ/æŠ•èµ„",
      topic_family:"å®¶åº­/äººé™…", topic_health:"å¥åº·/èº«å¿ƒ", topic_study:"å­¦ä¸š/æˆé•¿",
      topic_move:"æ—…è¡Œ/æ¬è¿", topic_other:"å…¶ä»–",
      preset_label:"å¸¸ç”¨é—®é¢˜", preset_none:"ï¼ˆå¯é€‰ï¼‰é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿",
      preset_1:"æˆ‘ç°åœ¨çš„èƒ½é‡çŠ¶æ€æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ",
      preset_2:"æ€ä¹ˆç”¨å¯¹ç­–ç•¥ï¼Œå‡å°‘å†…è€—ï¼Ÿ",
      preset_3:"è¿‘æœŸåœ¨äº‹ä¸š/åˆä½œä¸Šå¦‚ä½•å¯¹é½èŠ‚å¥ï¼Ÿ",
      preset_4:"å…³ç³»é‡Œçš„èƒ½é‡äº’åŠ¨æœ‰ä»€ä¹ˆæé†’ï¼Ÿ",
      preset_5:"å¦‚ä½•å»ºç«‹ç¨³å®šçš„æƒ…ç»ªä¸ç•Œé™ï¼Ÿ",
      q_label:"ä½ çš„å…·ä½“é—®é¢˜ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰",
      q_ph:"ä¾‹å¦‚ï¼šæœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç–²æƒ«å†…è€—ï¼Œæƒ³çŸ¥é“æˆ‘çš„èƒ½é‡ç­–ç•¥æ˜¯ä»€ä¹ˆã€ä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆã€‚",
      btn_gen:"ç”Ÿæˆåˆ†æ", btn_clear:"æ¸…ç©º",
      sec_sys:"ç³»ç»Ÿåˆ†ææŠ¥å‘Šï¼ˆä¸“ä¸šç‰ˆï¼‰",
      sec_ai:"å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®",
      chat_fab:"é—®", chat_title:"å¿ƒæ€œç®¡å®¶ Â· Chat", chat_ph:"æƒ³äº†è§£ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ï¼šå¦‚ä½•å¼€å§‹å…è´¹ä½“éªŒï¼‰", chat_send:"å‘é€",
      need_birth:"è¯·è‡³å°‘é€‰æ‹©å‡ºç”Ÿæ—¥æœŸï¼ˆå¯ç•™ç©ºæ—¶é—´/åœ°ç‚¹ï¼‰",
      generating:"æ­£åœ¨ç”Ÿæˆè§£è¯»â€¦",
      retry:"æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•ç”Ÿæˆï¼Œè¯·ç¨åå†è¯•ã€‚", neterr:"ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚",
      vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment", vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
      vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿", vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
      vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº", vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
      vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶", vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
      vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
      vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹", vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
      vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
      vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­", vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
      vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶", login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
      panel_login_head:"è´¦æˆ·ç™»å½• / æ³¨å†Œ",
      ph_email:"é‚®ç®± Email", ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘ 8 ä½ï¼Œéœ€åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ä¸ç¬¦å·ï¼‰", ph_label_password:"å¯†ç  Password",
      btn_login:"ç™»å½•è´¦æˆ·", btn_register:"æ³¨å†Œè´¦æˆ·", btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
      panel_member_head:"ä¼šå‘˜æœåŠ¡", btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰", btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
      note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ", note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
      /* æ–°å¢ UI æ–‡å­— */
      depth_label:"åˆ†ææ·±åº¦", depth_normal:"æ ‡å‡†", depth_advanced:"è¿›é˜¶", depth_expert:"ä¸“å®¶ï¼ˆæ›´å­¦æœ¯ï¼‰",
      auto_improve_label:"å¼€å¯è‡ªä¼˜åŒ–ï¼ˆå…ˆè¯„å®¡åä¿®è®¢æŠ¥å‘Šï¼‰",
      kpi_age:"å¹´é¾„ï¼ˆä¼°ï¼‰", kpi_lifepath:"ç”Ÿå‘½çµæ•°", kpi_element:"è±¡é™å…ƒç´ ", kpi_timeband:"æ—¶æ®µèŠ‚å¾‹",
      btn_rerun_sys:"â†» é‡æ–°ç”Ÿæˆç³»ç»ŸæŠ¥å‘Š", btn_rerun_ai:"â†» é‡æ–°ç”Ÿæˆç®¡å®¶å»ºè®®",
      btn_copy_sys:"å¤åˆ¶ç³»ç»ŸæŠ¥å‘Š", btn_copy_ai:"å¤åˆ¶ç®¡å®¶å»ºè®®", btn_download_md:"ä¸‹è½½ Markdown", btn_print:"æ‰“å°/å­˜ PDF",
      copied_ok:"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
    },
    "en": {
      title:"Energy Type Analysis Â· 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
      form_title:"Energy Type Â· Quick Reading",
      name_label:"Name (optional)", name_ph:"How to address you",
      gender_label:"Gender", gender_unknown:"Prefer not to say", gender_male:"Male", gender_female:"Female", gender_other:"Other",
      birth_label:"Birthdate", birth_time_label:"Time of birth (optional)", birth_place_label:"Place of birth (optional)", birth_place_ph:"City/Country",
      topic_label:"Focus topic",
      topic_love:"Love/Relationship", topic_career:"Career/Work", topic_wealth:"Wealth/Investment",
      topic_family:"Family/Social", topic_health:"Health/Mind-Body", topic_study:"Study/Growth",
      topic_move:"Travel/Move", topic_other:"Other",
      preset_label:"Quick questions", preset_none:"(Optional) Choose a template",
      preset_1:"What are the features of my current energy state?",
      preset_2:"How to use the right strategy and reduce drain?",
      preset_3:"How to align rhythm for career/collab recently?",
      preset_4:"Any reminders for energy dynamics in relationships?",
      preset_5:"How to build steady emotions and boundaries?",
      q_label:"Your specific question (paste here)",
      q_ph:"E.g. I feel drained recently. Whatâ€™s my best energy strategy and next steps?",
      btn_gen:"Generate Reading", btn_clear:"Clear",
      sec_sys:"System Analysis Report (Scholarly)", sec_ai:"Concierge Reading & Advice",
      chat_fab:"Chat", chat_title:"Concierge Â· Chat", chat_ph:"Ask me anything", chat_send:"Send",
      need_birth:"Please select at least your birthdate (time/place optional).",
      generating:"Generating readingâ€¦",
      retry:"Sorry, couldnâ€™t generate for now.", neterr:"Network error. Try again later.",
      vip_title:"ğŸŒ™ VIP Area", vip_mingli:"ğŸ— Astrology Space â€” Exclusive Content",
      vip_love:"Love & Marriage: romantic chemistry, marriage outlook", vip_career:"Career: workplace growth, entrepreneurship potential",
      vip_wealth:"Wealth: wealth placement analysis, right timing", vip_pet:"Pet Astrology: companion animalsâ€™ personality & bonds",
      vip_hepan:"Synastry: wedding date selection, birth timing", vip_name:"Name Analysis: company names, baby names, luck-renaming",
      vip_fengshui:"Wealth Feng Shui Match: home/office layout alignment",
      vip_xinlian:"ğŸŒ™ Xinlian Space â€” Exclusive Content", vip_record:"Spiritual Records: photos, dreams, audio, wishes/prayers",
      vip_course:"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family Memorial: spiritual remembrance & legacy", vip_tasks:"Weekly energy practices / deity rituals",
      vip_shop:"Energy shop member discounts & custom amulets", login_title:"ğŸ’ Sign in for VIP features",
      panel_login_head:"Account Login / Sign-up",
      ph_email:"Email", ph_password:"Password (min 8 chars with upper/lowercase, number & symbol)", ph_label_password:"Password",
      btn_login:"Log in", btn_register:"Create Account", btn_reset:"ğŸ”‘ Reset Password",
      panel_member_head:"Membership Services", btn_upgrade:"ğŸ’ Upgrade to VIP (Monthly)", btn_backshop:"â† Back to Astrology Shop",
      note_price:"Sign up to get one free trial", note_price1:"$9.9 / month VIP (Astrology Space + Xinlian Space + Spiritual Courses)",
      /* New UI */
      depth_label:"Depth", depth_normal:"Standard", depth_advanced:"Advanced", depth_expert:"Expert (scholarly)",
      auto_improve_label:"Auto-Improve (review & revise report)",
      kpi_age:"Age (est.)", kpi_lifepath:"Life Path", kpi_element:"Element Quadrant", kpi_timeband:"Time Band",
      btn_rerun_sys:"â†» Regenerate Scholar Report", btn_rerun_ai:"â†» Regenerate Butler Advice",
      btn_copy_sys:"Copy Scholar Report", btn_copy_ai:"Copy Butler Advice", btn_download_md:"Download Markdown", btn_print:"Print/Save PDF",
      copied_ok:"Copied to clipboard"
    }
  };

  function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k=el.getAttribute("data-i18n"); el.textContent = t(k);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k));
    });
    const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']");
    if(titleEl){ titleEl.textContent=t("title"); }
  }

  /* ===== Markdown -> HTMLï¼ˆç®€ç‰ˆï¼‰ ===== */
  function mdToHtml(md){
    if(!md) return '';
    return md
      .replace(/(^|\n)[#ï¼ƒ]{1,3}\s+(.+?)\s*(?=\n|$)/g, '$1<h3 class="ai-head">$2</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'<li>$1</li>')
      .replace(/(?:^|\n)(<li>[\s\S]+?<\/li>)+/g, m => `<ul>${m}</ul>`)
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }

  /* ===== æ—§ï¼šå•é˜¶æ®µæç¤ºè¯ï¼ˆä¿ç•™ï¼Œä¸ä½¿ç”¨ï¼‰ ===== */
  function buildPromptEnergy({langName, name, gender, birthdate, birthtime, birthplace, topic, question}){
    const topicMap = ({
      "zh-CN": {love:"çˆ±æƒ…/å…³ç³»",career:"äº‹ä¸š/å·¥ä½œ",wealth:"è´¢å¯Œ/æŠ•èµ„",family:"å®¶åº­/äººé™…",health:"å¥åº·/èº«å¿ƒ",study:"å­¦ä¸š/æˆé•¿",move:"æ—…è¡Œ/æ¬è¿",other:"å…¶ä»–"},
      "en":     {love:"Love/Relationship",career:"Career/Work",wealth:"Wealth/Investment",family:"Family/Social",health:"Health/Mind-Body",study:"Study/Growth",move:"Travel/Move",other:"Other"}
    })[getLang()] || {};
    const basic = [
      name ? `ç§°å‘¼ï¼š${name}` : null,
      gender ? `æ€§åˆ«ï¼š${gender}` : null,
      birthdate ? `ç”Ÿæ—¥ï¼š${birthdate}` : null,
      birthtime ? `æ—¶é—´ï¼š${birthtime}` : null,
      birthplace ? `åœ°ç‚¹ï¼š${birthplace}` : null
    ].filter(Boolean).join('ï¼›');

    return `ä½ æ˜¯ 5XLiving çš„â€œå¿ƒæ€œç®¡å®¶â€ï¼Œä¹Ÿæ˜¯èµ„æ·±èƒ½é‡ç±»å‹æ•™ç»ƒï¼ˆèƒ½é‡ç­–ç•¥/æƒ…ç»ªç®¡ç†/ç•Œé™ç»ƒä¹ /èŠ‚å¥è§„åˆ’ï¼‰ã€‚è¯·ä½¿ç”¨ã€${langName}ã€‘è¾“å‡ºï¼Œè¯­æ°”æ¸©æš–ã€ä¸“ä¸šã€å¯è½åœ°ã€‚

ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼š${basic || 'ï¼ˆç”¨æˆ·æœªæä¾›æ›´å¤šä¿¡æ¯ï¼‰'}
å…³æ³¨ä¸»é¢˜ï¼š${topicMap[topic] || topic || 'é€šç”¨'}
ç”¨æˆ·é—®é¢˜ï¼š${question || 'ï¼ˆæ— å…·ä½“é—®é¢˜ï¼Œè¯·ç»™é€šç”¨æç¤ºï¼‰'}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºï¼ˆä¸è¦æ·»åŠ å…¶ä»–æ ‡é¢˜/å‰åç¼€ï¼‰ï¼š
# æ ¸å¿ƒåˆ¤æ–­ï¼ˆ2â€“4å¥ï¼Œæ¦‚æ‹¬èƒ½é‡èŠ‚å¥ä¸å…³é”®ç­–ç•¥ï¼‰
# ç°åœ¨è¦åšçš„äº‹ï¼ˆ3æ¡ï¼ŒåŠ¨è¯å¼€å¤´ã€å¯æ‰§è¡Œã€å°½é‡é‡åŒ–ï¼‰
# é¿å‘æé†’ï¼ˆ2â€“3æ¡ï¼Œå…·ä½“åˆ°è¡Œä¸ºï¼‰
# èƒ½é‡ç»ƒä¹ ï¼ˆ2â€“3æ¡ï¼šå†¥æƒ³/å‘¼å¸/ä¹¦å†™/ä»ªå¼/èŠ‚å¾‹ï¼›å†™æ“ä½œè¦ç‚¹ä¸é¢‘æ¬¡ï¼‰
# AI æ¨ä¸¾å†…å®¹ï¼ˆ3â€“5æ¡ï¼šå¯åŒ…å«é¢„çº¦ 1v1 / åŠ å…¥ VIP / è¯¾ç¨‹ç»ƒä¹ åŒ… / å¾¡å®ˆä¸è®¸æ„¿ / å°†è®¡åˆ’å­˜å…¥å¿ƒæ€œç¬”è®°ç­‰ï¼Œå†™æˆå»ºè®®å¥å¼ï¼‰`;
  }

  /* ===== æ–°ï¼šä¸¤é˜¶æ®µæç¤ºè¯ ===== */

  function calcBasics(birthdate, birthtime){
    const today = new Date();
    const bd = new Date(birthdate);
    const age = bd instanceof Date && !isNaN(bd)
      ? (today.getFullYear() - bd.getFullYear() - ((today.getMonth()<bd.getMonth() || (today.getMonth()==bd.getMonth() && today.getDate()<bd.getDate()))?1:0))
      : null;

    const digits = (birthdate||'').replace(/\D/g,'').split('').map(Number);
    const sum = digits.reduce((a,b)=>a+b,0);
    const reduce = (n)=>{
      if([11,22,33].includes(n)) return n;
      let s=n; while(s>9){ s = String(s).split('').reduce((a,b)=>a+Number(b),0); if([11,22,33].includes(s)) break; }
      return s;
    };
    const lifePath = reduce(sum);

    const m = bd.getMonth()+1;
    const seasonElement =
      (m>=3 && m<=5) ? 'æœ¨ï¼ˆæ˜¥ï¼‰' :
      (m>=6 && m<=8) ? 'ç«ï¼ˆå¤ï¼‰' :
      (m>=9 && m<=11)? 'é‡‘ï¼ˆç§‹ï¼‰' : 'æ°´ï¼ˆå†¬ï¼‰';

    const h = Number((birthtime||'00:00').split(':')[0]||0);
    const timeBand =
      (h>=5 && h<9) ? 'æ¸…æ™¨' :
      (h>=9 && h<12)? 'ä¸Šåˆ' :
      (h>=12&& h<17)? 'ä¸‹åˆ' :
      (h>=17&& h<21)? 'å‚æ™š' : 'æ·±å¤œ';

    return { age, lifePath, seasonElement, timeBand };
  }

  function buildPromptSystemReport({langName, basics, name, gender, birthdate, birthtime, birthplace, topic, question, depth='normal'}){
    const basicLine = [
      name ? `ç§°å‘¼ï¼š${name}` : null,
      gender ? `æ€§åˆ«ï¼š${gender}` : null,
      birthdate ? `ç”Ÿæ—¥ï¼š${birthdate}` : null,
      birthtime ? `æ—¶é—´ï¼š${birthtime}` : null,
      birthplace ? `åœ°ç‚¹ï¼š${birthplace}` : null
    ].filter(Boolean).join('ï¼›');

    const rigor = depth==='expert'
      ? 'ä½¿ç”¨å­¦æœ¯/æ–¹æ³•è®ºå£å»ï¼Œå¼•ç”¨å®šä¹‰æœ¯è¯­ï¼Œç¡®ä¿å„æ®µè½éƒ½æœ‰åˆ¤æ®æˆ–å¯å¤æ ¸çš„æŒ‡æ ‡ã€‚'
      : depth==='advanced'
        ? 'è¯­æ°”ä¸“ä¸šï¼Œç»™å‡ºåˆ¤æ–­-è¯æ®-å«ä¹‰ä¸‰æ®µå¼ï¼Œé€‚åº¦å¼•ç”¨æ¡†æ¶æœ¯è¯­ã€‚'
        : 'æ¸…æ™°æ˜“æ‡‚ï¼Œç»™å‡ºæŒ‡æ ‡ä¸å«ä¹‰ï¼Œé¿å…è¿‡åº¦æœ¯è¯­ã€‚';

    return `ä½ æ˜¯ 5XLiving çš„â€œèƒ½é‡ç ”ç©¶å‘˜ï¼ˆEnergy Scholarï¼‰â€ï¼Œæ’°å†™ã€ç³»ç»Ÿåˆ†ææŠ¥å‘Šã€‘ã€‚è¾“å‡ºè¯­è¨€ï¼šã€${langName}ã€‘ã€‚
${rigor} é¿å…åŒ»ç–—/æ³•å¾‹è¡¨è¿°ï¼›å…è®¸åŸºäºèƒ½é‡å­¦æ¡†æ¶ï¼ˆæ•°å­—å‘½ç†/èŠ‚å¾‹/å…ƒç´ è±¡é™/è¡Œä¸ºèŠ‚å¾‹ï¼‰åšå—é™æ¨æ–­ï¼Œå¹¶æ˜ç¡®å±€é™æ€§ã€‚

ã€ç”¨æˆ·åŸºç¡€ä¿¡æ¯ã€‘${basicLine || 'ï¼ˆæœªæä¾›æ›´å¤šï¼‰'}
ã€èšç„¦ä¸»é¢˜ã€‘${topic || 'é€šç”¨'}
ã€ç”¨æˆ·é—®é¢˜ã€‘${question || 'ï¼ˆæ— å…·ä½“é—®é¢˜ï¼‰'}

ã€å¯éªŒè¯åŸºç¡€æŒ‡æ ‡ï¼ˆå‰ç«¯å·²è®¡ç®—ï¼‰ã€‘
- å¹´é¾„ï¼ˆä¼°ç®—ï¼‰ï¼š${basics.age ?? 'æœªçŸ¥'}
- ç”Ÿå‘½çµæ•°ï¼š${basics.lifePath}
- è±¡é™å…ƒç´ ï¼ˆæŒ‰å‡ºç”Ÿæœˆç²—ç•¥ï¼‰ï¼š${basics.seasonElement}
- å‡ºç”Ÿæ—¶æ®µï¼š${basics.timeBand}

è¯·ä¸¥æ ¼æŒ‰æ­¤ç»“æ„è¾“å‡ºï¼ˆMarkdownï¼‰ï¼š
# æ‘˜è¦ï¼ˆ3-5å¥ï¼Œæç‚¼ä¸»ç»“è®ºä¸åˆ¤æ®ï¼‰
# åŸºç¡€ä¿¡æ¯ï¼ˆè¡¨æ ¼åˆ—å‡ºä¸Šé¢çš„å¯éªŒè¯æŒ‡æ ‡ï¼‰
# èƒ½é‡ç»“æ„ä¸ç±»å‹ï¼ˆåŸºäºâ€œå…ƒç´ è±¡é™/çµæ•°/æ—¶æ®µèŠ‚å¾‹â€çš„åˆæˆåˆ¤æ–­ï¼›å†™å‡ºæ¨ç†é“¾ï¼‰
# å…³é”®æŒ‡æ ‡ä¸å«ä¹‰ï¼ˆåˆ— 4-6 é¡¹æŒ‡æ ‡ï¼Œç»™å‡ºå®šä¹‰ä¸å½±å“ç»´åº¦ï¼‰
# æ—¶é—´èŠ‚å¾‹ï¼ˆæœªæ¥30/90å¤©ï¼šçª—å£æœŸ/æ˜“è€—æœŸï¼›ç”¨å‘¨æ¬¡æˆ–æ—¥æœŸèŒƒå›´è¡¨è¾¾ï¼‰
# ä¼˜åŠ¿ä¸é£é™©ï¼ˆå„3-5æ¡ï¼ŒæŒ‡å‘è¡Œä¸ºä¸åœºæ™¯ï¼‰
# æ–¹æ³•è®ºä¸å±€é™ï¼ˆæ•°æ®ç¼ºå£/å‡è®¾/é¿å…è¯¯ç”¨ï¼‰
ä»…è¾“å‡ºæŠ¥å‘Šæ­£æ–‡ï¼Œä¸è¦åŠ å…¥å»ºè®®æˆ–å¯¹è¯è¯­æ°”ã€‚`;
  }

  function buildPromptReportReview({langName, rawReport}){
    return `ä½ æ˜¯ 5XLiving çš„â€œå­¦æœ¯å®¡æ ¡å‘˜â€ã€‚OUTPUT LANGUAGE: ${langName}ã€‚
å®¡é˜…ä¸‹æ–¹â€œç³»ç»Ÿåˆ†ææŠ¥å‘Šâ€ï¼ŒæŒ‡å‡ºï¼š
- é€»è¾‘è·³è·ƒã€æœ¯è¯­æœªå®šä¹‰ã€æŒ‡æ ‡ä¸ç»“è®ºæœªå»ºç«‹æ˜ å°„ä¹‹å¤„
- å¯å¤æ ¸æ€§ä¸è¶³ä¹‹å¤„ï¼ˆç¼ºå£/å‡è®¾ï¼‰
- å¯ä»¥è¡¥å……çš„æ—¶é—´èŠ‚å¾‹æˆ–è¡Œä¸ºæŒ‡æ ‡
ç„¶åç»™å‡ºã€ä¿®è®¢åçš„å®Œæ•´æŠ¥å‘Šã€‘ï¼ˆä¿ç•™åŸç»“æ„ä¸æ ‡é¢˜ï¼‰ã€‚

<<<æŠ¥å‘ŠåŸæ–‡>>>
${rawReport}
<<<ç»“æŸ>>>`;
  }

  function buildPromptButlerAdvice({langName, systemReport, topic}){
    return `ä½ æ˜¯ 5XLiving çš„â€œå¿ƒæ€œç®¡å®¶ï¼ˆXinlian Butlerï¼‰â€ï¼Œè¯­æ°”æ¸©æš–ã€å®æ“ã€‚OUTPUT LANGUAGE: ${langName}ã€‚
æ ¹æ®è¿™ä»½â€œç³»ç»Ÿåˆ†ææŠ¥å‘Šâ€ï¼ˆå¦‚ä¸‹ï¼‰ç»™ç”¨æˆ·æå‡ºè½åœ°å»ºè®®ï¼Œé¿å…é‡å¤æŠ¥å‘ŠåŸæ–‡ï¼š
<<<ç³»ç»Ÿåˆ†ææŠ¥å‘Š>>>
${systemReport}
<<<æŠ¥å‘Šç»“æŸ>>>

è¯·æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºï¼ˆMarkdownï¼‰ï¼š
# æ ¸å¿ƒåˆ¤æ–­ï¼ˆ2â€“4å¥ï¼Œå¼•ç”¨æŠ¥å‘Šé‡Œçš„å…³é”®è¯æ®ï¼‰
# ç°åœ¨è¦åšçš„äº‹ï¼ˆ3æ¡ï¼ŒåŠ¨è¯å¼€å¤´ã€å«é¢‘æ¬¡/æ—¶é•¿/é˜ˆå€¼ï¼‰
# é¿å‘æé†’ï¼ˆ2â€“3æ¡ï¼Œå…·ä½“åˆ°è¡Œä¸ºï¼‰
# èƒ½é‡ç»ƒä¹ ï¼ˆ2â€“3æ¡ï¼šå†¥æƒ³/å‘¼å¸/ä¹¦å†™/ä»ªå¼/èŠ‚å¾‹ï¼›å†™æ¸…æ“ä½œè¦ç‚¹ä¸é¢‘æ¬¡ï¼‰
# AI æ¨ä¸¾å†…å®¹ï¼ˆ3â€“5æ¡ï¼šå¯åŒ…å«é¢„çº¦ 1v1 / åŠ å…¥ VIP / è¯¾ç¨‹ç»ƒä¹ åŒ… / å¾¡å®ˆä¸è®¸æ„¿ / å°†è®¡åˆ’å­˜å…¥å¿ƒæ€œç¬”è®°ç­‰ï¼Œå†™æˆå»ºè®®å¥å¼ï¼‰`;
  }

  /* ===== åŸï¼šå•é˜¶æ®µ generateï¼ˆä¿ç•™ï¼Œä½†ç¨åä¼šè¢«æ–°åŒåå‡½æ•°è¦†ç›–ï¼‰ ===== */
  async function generate(){
    // å ä½ï¼šæ–°å‡½æ•°ä¼šåœ¨ä¸‹æ–¹è¦†ç›–
  }

  /* ===== æ–°ï¼šä¸¤é˜¶æ®µç”Ÿæˆï¼ˆç³»ç»Ÿâ†’å®¡æ ¡ä¿®è®¢â†’ç®¡å®¶ï¼‰ ===== */
  async function runScholar({langName, basics, name, gender, birthdate, birthtime, birthplace, topic, question, depth}){
    const sysCard = $('sysCard'), sysBox=$('sysText');
    const sysPrompt = buildPromptSystemReport({langName, basics, name, gender, birthdate, birthtime, birthplace, topic, question, depth});
    const sysSys = `You are "Energy Scholar" for 5XLiving. Output language: ${langName}. Be rigorous and structured. Avoid medical/legal claims.`;

    sysCard.style.display='block';
    sysBox.innerHTML = `<div class="skeleton">
      <div style="width:78%"></div><div style="width:92%"></div><div style="width:86%"></div>
      <div style="width:70%"></div><div style="width:55%"></div>
    </div>`;

    const rA = await fetch(`${API_BASE}/api/chat`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:sysSys},
        {role:'user',content:sysPrompt}
      ]})
    });
    const dataA = await rA.json().catch(()=>({}));
    return dataA.reply || dataA.text || dataA?.choices?.[0]?.message?.content || '';
  }

  async function runScholarReview({langName, rawReport}){
    const prompt = buildPromptReportReview({langName, rawReport});
    const sysSys = `You are "Energy Scholar Reviewer". Output language: ${langName}. Give a revised, more rigorous report.`;

    const r = await fetch(`${API_BASE}/api/chat`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:sysSys},
        {role:'user',content:prompt}
      ]})
    });
    const data = await r.json().catch(()=>({}));
    return data.reply || data.text || data?.choices?.[0]?.message?.content || rawReport;
  }

  async function runButler({langName, systemReport}){
    const aiBox=$('aiText'); const aiCard=$('aiCard');
    aiCard.style.display='block';
    aiBox.innerHTML = `<div class="skeleton">
      <div style="width:65%"></div><div style="width:82%"></div><div style="width:90%"></div>
      <div style="width:72%"></div><div style="width:48%"></div>
    </div>`;

    const butlerSys = `You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Tone: warm, practical, actionable. Avoid medical/legal claims.`;
    const prompt = buildPromptButlerAdvice({langName, systemReport});

    const rB = await fetch(`${API_BASE}/api/chat`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:butlerSys},
        {role:'user',content:prompt}
      ]})
    });
    const dataB = await rB.json().catch(()=>({}));
    return dataB.reply || dataB.text || dataB?.choices?.[0]?.message?.content || '';
  }

  /* è¦†ç›– generateï¼šä¸¤é˜¶æ®µä¸»æµç¨‹ */
  async function generate(){
    const lang = getLang();
    const langName = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    const name = $('name').value.trim();
    const gender = $('gender').value;
    const birthdate = $('birthdate').value;
    const birthtime = $('birthtime').value;
    const birthplace = $('birthplace').value.trim();
    const topic = $('topic').value;
    const question = $('question').value.trim();
    const depth = $('depth')?.value || 'normal';
    const autoImprove = ($('autoImprove')?.value||'off') === 'on';

    if(!birthdate){
      const e=$('err'); e.style.display='block'; e.textContent=t('need_birth');
      setTimeout(()=>e.style.display='none', 3000);
      return;
    }

    // KPIs
    const basics = calcBasics(birthdate, birthtime);
    const kpis = $('sysKPIs');
    if (kpis){
      kpis.innerHTML = `
        <div class="kpi"><div class="k">${t('kpi_age')}</div><div class="v">${(basics.age??'â€”')}</div></div>
        <div class="kpi"><div class="k">${t('kpi_lifepath')}</div><div class="v">${basics.lifePath}</div></div>
        <div class="kpi"><div class="k">${t('kpi_element')}</div><div class="v">${basics.seasonElement}</div></div>
        <div class="kpi"><div class="k">${t('kpi_timeband')}</div><div class="v">${basics.timeBand}</div></div>
      `;
    }

    // A. Scholar
    let scholarReport = '';
    try{
      scholarReport = await runScholar({langName, basics, name, gender, birthdate, birthtime, birthplace, topic, question, depth});
      $('sysText').innerHTML = mdToHtml(scholarReport || t('retry'));
      window.scrollTo({top: $('sysCard').offsetTop - 10, behavior:'smooth'});
    }catch(e){ $('sysText').textContent = t('neterr'); return; }

    // A2. Review & Reviseï¼ˆå¯é€‰ï¼‰
    if (autoImprove){
      try{
        const revised = await runScholarReview({langName, rawReport: scholarReport});
        if (revised && revised.trim().length > 60){
          scholarReport = revised;
          $('sysText').innerHTML = mdToHtml(revised);
        }
      }catch(e){}
    }

    // B. Butler
    try{
      const butlerAdvice = await runButler({langName, systemReport: scholarReport});
      $('aiText').innerHTML = mdToHtml(butlerAdvice || t('retry'));
      // ä¿å­˜åˆ°ä½œç”¨åŸŸï¼Œæ–¹ä¾¿å¯¼å‡º/å¤åˆ¶
      window.__lastScholar = scholarReport;
      window.__lastButler  = butlerAdvice;
    }catch(e){ $('aiText').textContent = t('neterr'); }
  }

  /* ====== Chat æµ®çª— ====== */
  function mountChat(){
    const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
    function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
    async function askChat(prompt){
      addMsg(prompt,true); input.value='';
      const sys = `You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()]||'Simplified Chinese'}. Help with features, navigation, and membership. Tone: warm, concise.`;
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
          {role:'system',content:sys},{role:'user',content:prompt}
        ]})});
        let data={}; try{data=await r.json()}catch{}
        const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
        addMsg(reply || t('retry'));
      }catch{ addMsg(t('neterr')); }
    }
    fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
    closeBtn.addEventListener('click',()=>panel.style.display='none');
    send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
    input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
  }

  /* ===== äº‹ä»¶ & åˆå§‹åŒ– ===== */
  function applyChatI18n(){
    $('ssChatFab').textContent = t('chat_fab');
    $('ssChatSend').textContent = t('chat_send');
    $('ssChatInput').placeholder = t('chat_ph');
    document.querySelector('.ss-chat-title').textContent = t('chat_title');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const bd = $('birthdate');
    if (bd && !bd.value) {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    const sel = $('langSelect');
    const current = getLang();
    sel.value = current;
    document.documentElement.lang = current;
    applyI18n();
    applyChatI18n();
    mountChat();

    $('go').addEventListener('click', generate);
    $('clear').addEventListener('click', ()=>{
      ['name','gender','birthtime','birthplace','topic','question','presetQ'].forEach(id=>{
        const el=$(id); if(!el) return;
        if (el.tagName==='SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      $('sysCard').style.display='none'; $('sysText').innerHTML=''; $('sysKPIs').innerHTML='';
      $('aiCard').style.display='none';  $('aiText').innerHTML='';
      $('err').style.display='none';
      window.__lastScholar = ''; window.__lastButler = '';
    });

    $('presetQ').addEventListener('change', (e)=>{
      const txt = e.target.options[e.target.selectedIndex].textContent.trim();
      if (txt) $('question').value = txt;
    });

    sel.addEventListener('change', ()=>{
      setLang(sel.value);
      applyI18n();
      applyChatI18n();
    });

    // å·¥å…·æ æŒ‰é’®
    $('btnRerunSys').addEventListener('click', async ()=>{
      const lang = getLang();
      const langName = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
      const basics = calcBasics($('birthdate').value, $('birthtime').value);
      const name=$('name').value.trim(), gender=$('gender').value, birthdate=$('birthdate').value, birthtime=$('birthtime').value, birthplace=$('birthplace').value.trim(), topic=$('topic').value, question=$('question').value.trim(), depth=$('depth')?.value||'normal';
      const r = await runScholar({langName, basics, name, gender, birthdate, birthtime, birthplace, topic, question, depth});
      $('sysText').innerHTML = mdToHtml(r||t('retry')); window.__lastScholar = r;
    });
    $('btnRerunAI').addEventListener('click', async ()=>{
      const lang = getLang(); const langName = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
      const report = window.__lastScholar || $('sysText').innerText || '';
      const r = await runButler({langName, systemReport: report});
      $('aiText').innerHTML = mdToHtml(r||t('retry')); window.__lastButler = r;
    });
    $('btnCopySys').addEventListener('click', ()=> copyText(window.__lastScholar || $('sysText').innerText || ''));
    $('btnCopyAI').addEventListener('click', ()=> copyText(window.__lastButler || $('aiText').innerText || ''));
    $('btnDownloadMd').addEventListener('click', ()=>{
      const md = `# ${t('sec_sys')}\n\n${window.__lastScholar||''}\n\n---\n\n# ${t('sec_ai')}\n\n${window.__lastButler||''}\n`;
      download('Energy_Report_5XLiving.md', md);
    });
    $('btnPrint').addEventListener('click', ()=> window.print());
  });
})();
</script>
</body>
</html>

