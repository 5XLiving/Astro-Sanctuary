
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">能量类型分析 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
  .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
  .title{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; letter-spacing:.02em; font-size:1.1rem; line-height:1.25}
  .lang{display:flex; align-items:center; gap:8px}
  .lang label{white-space:nowrap; color:var(--muted)}
  .lang select{
    appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
    background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
  }
  .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
  .h2{font-weight:800;color:#ffe084;margin:0 0 10px}
  .sub{color:var(--muted)}
  .card{background:#11161dcc;border:1px solid #1f2a36;border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .row{display:grid; gap:12px; grid-template-columns:1fr}
  @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
  label.muted{display:block;margin-bottom:4px;color:#98a7b7}
  input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:#e8edf3;padding:12px;font-size:15px;outline:none}
  textarea{min-height:96px}
  input::placeholder,textarea::placeholder{color:#6f8092}
  .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
  .btn.secondary{background:#101826;color:#ffe084;border-color:#3a3f47}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .muted{color:#98a7b7}
  .error{color:#ff8b8b}
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

  /* AI result */
  #aiCard .skeleton{display:grid;gap:8px}
  #aiCard .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  #aiText{white-space:normal;line-height:1.7}
  #aiText ul{margin:.4rem 0 .2rem 1.2rem}
  /* AI 文内标题与卡片标题同色 */
  #aiText h2,
  #aiText h3{
  color:#ffe084 !important;
  margin:12px 0 6px;
  font-size:1.05rem;
  font-weight:800;
}

  /* Chat */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}
</style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving · <span data-i18n="brand">Soul Sanctuary</span></span>
    </a>
    <div class="lang">
      <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
      <select id="langSelect" aria-label="Language">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <h1 class="h1" data-i18n="title">能量类型分析 · 5XLiving</h1>

  <!-- 表单 -->
  <div class="card">
    <div class="h2" data-i18n="form_title">能量类型分析 · 快速解读</div>
    <div id="err" class="error" style="display:none"></div>

    <!-- Row 1 -->
    <div class="row cols-3">
      <div>
        <label class="muted" data-i18n="name_label">姓名（可选）</label>
        <input type="text" id="name" data-i18n-ph="name_ph" placeholder="你的称呼（用于个性化称呼）">
      </div>
      <div>
        <label class="muted" data-i18n="gender_label">性别</label>
        <select id="gender">
          <option value="" data-i18n="gender_unknown">不透露</option>
          <option value="male" data-i18n="gender_male">男性</option>
          <option value="female" data-i18n="gender_female">女性</option>
          <option value="other" data-i18n="gender_other">其他</option>
        </select>
      </div>
      <div>
        <label class="muted" data-i18n="birth_place_label">出生地点（可选）</label>
        <input type="text" id="birthplace" data-i18n-ph="birth_place_ph" placeholder="城市/国家">
      </div>
    </div><!-- /Row 1 -->

    <!-- Row 2 -->
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="birth_label">出生日期</label>
        <input type="date" id="birthdate">
      </div>
      <div>
        <label class="muted" data-i18n="birth_time_label">出生时间（可选）</label>
        <input type="time" id="birthtime">
      </div>
      <div>
        <label class="muted" data-i18n="topic_label">关注主题</label>
        <select id="topic">
          <option value="love"  data-i18n="topic_love">爱情/关系</option>
          <option value="career" data-i18n="topic_career">事业/工作</option>
          <option value="wealth" data-i18n="topic_wealth">财富/投资</option>
          <option value="family" data-i18n="topic_family">家庭/人际</option>
          <option value="health" data-i18n="topic_health">健康/身心</option>
          <option value="study" data-i18n="topic_study">学业/成长</option>
          <option value="move"  data-i18n="topic_move">旅行/搬迁</option>
          <option value="other" data-i18n="topic_other">其他</option>
        </select>
      </div>
    </div><!-- /Row 2 -->

    <!-- Row 3 -->
    <div class="row cols-3" style="margin-top:10px">
      <div>
        <label class="muted" data-i18n="preset_label">常用问题</label>
        <select id="presetQ">
          <option value="" data-i18n="preset_none">（可选）选择一个模板</option>
          <option data-i18n="preset_1">我现在的能量状态有什么特点？</option>
          <option data-i18n="preset_2">怎么用对策略，减少内耗？</option>
          <option data-i18n="preset_3">近期在事业/合作上如何对齐节奏？</option>
          <option data-i18n="preset_4">关系里的能量互动有什么提醒？</option>
          <option data-i18n="preset_5">如何建立稳定的情绪与界限？</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label class="muted" data-i18n="q_label">你的具体问题（可直接粘贴）</label>
        <textarea id="question" rows="3" data-i18n-ph="q_ph" placeholder="例如：最近总是感到疲惫内耗，想知道我的能量策略是什么、下一步该做什么。"></textarea>
      </div>
    </div><!-- /Row 3 -->

    <!-- Row 4 -->
    <div class="row cols-2" style="margin-top:10px">
      <div><button id="go" class="btn" data-i18n="btn_gen">生成分析</button></div>
      <div><button id="clear" class="btn secondary" data-i18n="btn_clear">清空</button></div>
    </div><!-- /Row 4 -->
  </div><!-- /card form -->

  <!-- 结果 -->
  <div id="aiCard" class="card" style="display:none">
    <div class="h2" data-i18n="sec_ai">心怜管家解读与建议</div>
    <div id="aiText"></div>
  </div>

  <!-- 会员区（展示用） -->
  <section class="card section">
    <h2 class="h2" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
    <div class="row cols-2">
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
        <ul class="muted" style="margin:.2rem 0 0 1.1rem">
          <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
          <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
          <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
          <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
          <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
          <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
          <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
        </ul>
      </div>
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
        <ul class="muted" style="margin:.2rem 0 0 1.1rem">
          <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
          <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
          <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
          <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
          <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
        </ul>
      </div>
    </div>

    <div class="h3" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>
    <div class="row cols-2">
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="panel_login_head">账户登录 / 注册</div>
        <div class="row" id="authFields">
          <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
          <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
          <input id="password" type="password" autocomplete="new-password" data-i18n-ph="ph_password" placeholder="密码 Password（至少8位，含大小写数字符号）" required/>
        </div>
        <div class="row cols-2" style="margin-top:10px">
          <button class="btn" id="loginBtn" data-i18n="btn_login">登入账户</button>
          <button class="btn secondary" id="resetBtn" data-i18n="btn_reset">🔑 重设密码</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="registerBtn" data-i18n="btn_register">注册账户</button>
          <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
          <div class="error" id="authError" style="display:none"></div>
        </div>
      </div>
      <div class="card" style="margin:0">
        <div class="h3" data-i18n="panel_member_head">会员服务</div>
        <div class="row">
          <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
          <a class="btn secondary" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
          <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>© 5XLiving • Astro/Soul Sanctuary</footer>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div class="ss-chat-title" data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" class="btn" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
(function(){
  "use strict";

  /* ===== 配置 ===== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers
  const LANG_KEY = "site_lang";

  /* ===== 小工具 ===== */
  const $ = (id) => document.getElementById(id);
  const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
  const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese',
    'en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  /* ===== i18n ===== */
  const i18n = {
    "zh-CN": {
      title:"能量类型分析 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
      form_title:"能量类型分析 · 快速解读",
      name_label:"姓名（可选）", name_ph:"你的称呼（用于个性化称呼）",
      gender_label:"性别", gender_unknown:"不透露", gender_male:"男性", gender_female:"女性", gender_other:"其他",
      birth_label:"出生日期", birth_time_label:"出生时间（可选）", birth_place_label:"出生地点（可选）", birth_place_ph:"城市/国家",
      topic_label:"关注主题",
      topic_love:"爱情/关系", topic_career:"事业/工作", topic_wealth:"财富/投资",
      topic_family:"家庭/人际", topic_health:"健康/身心", topic_study:"学业/成长",
      topic_move:"旅行/搬迁", topic_other:"其他",
      preset_label:"常用问题", preset_none:"（可选）选择一个模板",
      preset_1:"我现在的能量状态有什么特点？",
      preset_2:"怎么用对策略，减少内耗？",
      preset_3:"近期在事业/合作上如何对齐节奏？",
      preset_4:"关系里的能量互动有什么提醒？",
      preset_5:"如何建立稳定的情绪与界限？",
      q_label:"你的具体问题（可直接粘贴）",
      q_ph:"例如：最近总是感到疲惫内耗，想知道我的能量策略是什么、下一步该做什么。",
      btn_gen:"生成分析", btn_clear:"清空",
      sec_ai:"心怜管家解读与建议",
      chat_fab:"问", chat_title:"心怜管家 · Chat", chat_ph:"想了解什么？（如：如何开始免费体验）", chat_send:"发送",
      need_birth:"请至少选择出生日期（可留空时间/地点）",
      generating:"正在生成解读…",
      retry:"抱歉，暂时无法生成，请稍后再试。", neterr:"网络异常，请稍后再试。",
      vip_title:"🌙 会员区域 VIP Segment", vip_mingli:"🗝 命理空间专属内容",
      vip_love:"姻缘方向：恋爱缘分、婚姻走势", vip_career:"事业方向：职场发展、创业潜力",
      vip_wealth:"财运方向：财位分析、理财时机", vip_pet:"宠物命理：伴侣动物的性格与缘分",
      vip_hepan:"合盘分析：婚期择日、新生择时", vip_name:"测名分析：公司名、宝宝名、命名改运",
      vip_fengshui:"财位合盘：住家 / 办公室动线配合",
      vip_xinlian:"🌙 心怜空间专属内容", vip_record:"灵性记录：照片、梦境、声音、愿望祈祷",
      vip_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
      vip_memorial:"家族纪念系统：亲人灵性纪念 & 延续", vip_tasks:"每周能量练习 / 神明仪式任务",
      vip_shop:"能量商城专属折扣 & 御守订制", login_title:"💎 登入 VIP 功能",
      panel_login_head:"账户登录 / 注册",
      ph_email:"邮箱 Email", ph_password:"密码 Password（至少 8 位，需包含大小写字母、数字与符号）", ph_label_password:"密码 Password",
      btn_login:"登录账户", btn_register:"注册账户", btn_reset:"🔑 重设密码",
      panel_member_head:"会员服务", btn_upgrade:"💎 升级为 VIP（月费）", btn_backshop:"← 返回命理商城",
      note_price:"注册账号赠送一次免费体验", note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）"
    },
    "en": {
      title:"Energy Type Analysis · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
      form_title:"Energy Type · Quick Reading",
      name_label:"Name (optional)", name_ph:"How to address you",
      gender_label:"Gender", gender_unknown:"Prefer not to say", gender_male:"Male", gender_female:"Female", gender_other:"Other",
      birth_label:"Birthdate", birth_time_label:"Time of birth (optional)", birth_place_label:"Place of birth (optional)", birth_place_ph:"City/Country",
      topic_label:"Focus topic",
      topic_love:"Love/Relationship", topic_career:"Career/Work", topic_wealth:"Wealth/Investment",
      topic_family:"Family/Social", topic_health:"Health/Mind-Body", topic_study:"Study/Growth",
      topic_move:"Travel/Move", topic_other:"Other",
      preset_label:"Quick questions", preset_none:"(Optional) Choose a template",
      preset_1:"What are the features of my current energy state?",
      preset_2:"How to use the right strategy and reduce drain?",
      preset_3:"How to align rhythm for career/collab recently?",
      preset_4:"Any reminders for energy dynamics in relationships?",
      preset_5:"How to build steady emotions and boundaries?",
      q_label:"Your specific question (paste here)",
      q_ph:"E.g. I feel drained recently. What’s my best energy strategy and next steps?",
      btn_gen:"Generate Reading", btn_clear:"Clear",
      sec_ai:"Concierge Reading & Advice",
      chat_fab:"Chat", chat_title:"Concierge · Chat", chat_ph:"Ask me anything", chat_send:"Send",
      need_birth:"Please select at least your birthdate (time/place optional).",
      generating:"Generating reading…",
      retry:"Sorry, couldn’t generate for now.", neterr:"Network error. Try again later.",
      vip_title:"🌙 VIP Area", vip_mingli:"🗝 Astrology Space — Exclusive Content",
      vip_love:"Love & Marriage: romantic chemistry, marriage outlook", vip_career:"Career: workplace growth, entrepreneurship potential",
      vip_wealth:"Wealth: wealth placement analysis, right timing", vip_pet:"Pet Astrology: companion animals’ personality & bonds",
      vip_hepan:"Synastry: wedding date selection, birth timing", vip_name:"Name Analysis: company names, baby names, luck-renaming",
      vip_fengshui:"Wealth Feng Shui Match: home/office layout alignment",
      vip_xinlian:"🌙 Xinlian Space — Exclusive Content", vip_record:"Spiritual Records: photos, dreams, audio, wishes/prayers",
      vip_course:"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
      vip_memorial:"Family Memorial: spiritual remembrance & legacy", vip_tasks:"Weekly energy practices / deity rituals",
      vip_shop:"Energy shop member discounts & custom amulets", login_title:"💎 Sign in for VIP features",
      panel_login_head:"Account Login / Sign-up",
      ph_email:"Email", ph_password:"Password (min 8 chars with upper/lowercase, number & symbol)", ph_label_password:"Password",
      btn_login:"Log in", btn_register:"Create Account", btn_reset:"🔑 Reset Password",
      panel_member_head:"Membership Services", btn_upgrade:"💎 Upgrade to VIP (Monthly)", btn_backshop:"← Back to Astrology Shop",
      note_price:"Sign up to get one free trial", note_price1:"$9.9 / month VIP (Astrology Space + Xinlian Space + Spiritual Courses)"
    }
  };

  function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k=el.getAttribute("data-i18n"); el.textContent = t(k);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k));
    });
    const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']");
    if(titleEl){ titleEl.textContent=t("title"); }
  }

  /* ===== Markdown -> HTML（简版） ===== */
 function mdToHtml(md){
  if(!md) return '';
  return md
    // 标题：支持 # / ＃，1~3 级
    .replace(/(^|\n)[#＃]{1,3}\s+(.+?)\s*(?=\n|$)/g, '$1<h3 class="ai-head">$2</h3>')
    // 列表：- 或 *
    .replace(/^\s*[-*]\s+(.*)$/gm,'<li>$1</li>')
    .replace(/(?:^|\n)(<li>[\s\S]+?<\/li>)+/g, m => `<ul>${m}</ul>`)
    // 加粗
    .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
    // 换行
    .replace(/\n{2,}/g,'\n\n')
    .replace(/\n/g,'<br/>');
}

  /* ===== 生成提示词 ===== */
  function buildPromptEnergy({langName, name, gender, birthdate, birthtime, birthplace, topic, question}){
    const topicMap = ({
      "zh-CN": {love:"爱情/关系",career:"事业/工作",wealth:"财富/投资",family:"家庭/人际",health:"健康/身心",study:"学业/成长",move:"旅行/搬迁",other:"其他"},
      "en":     {love:"Love/Relationship",career:"Career/Work",wealth:"Wealth/Investment",family:"Family/Social",health:"Health/Mind-Body",study:"Study/Growth",move:"Travel/Move",other:"Other"}
    })[getLang()] || {};
    const basic = [
      name ? `称呼：${name}` : null,
      gender ? `性别：${gender}` : null,
      birthdate ? `生日：${birthdate}` : null,
      birthtime ? `时间：${birthtime}` : null,
      birthplace ? `地点：${birthplace}` : null
    ].filter(Boolean).join('；');

    return `你是 5XLiving 的“心怜管家”，也是资深能量类型教练（能量策略/情绪管理/界限练习/节奏规划）。请使用【${langName}】输出，语气温暖、专业、可落地。

用户基础信息：${basic || '（用户未提供更多信息）'}
关注主题：${topicMap[topic] || topic || '通用'}
用户问题：${question || '（无具体问题，请给通用提示）'}

请严格按以下结构输出（不要添加其他标题/前后缀）：
# 核心判断（2–4句，概括能量节奏与关键策略）
# 现在要做的事（3条，动词开头、可执行、尽量量化）
# 避坑提醒（2–3条，具体到行为）
# 能量练习（2–3条：冥想/呼吸/书写/仪式/节律；写操作要点与频次）
# AI 推举内容（3–5条：可包含预约 1v1 / 加入 VIP / 课程练习包 / 御守与许愿 / 将计划存入心怜笔记等，写成建议句式）`;
  }

  /* ====== 生成流程 ====== */
  async function generate(){
    const lang = getLang();
    const langName = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    const name = $('name').value.trim();
    const gender = $('gender').value;
    const birthdate = $('birthdate').value;
    const birthtime = $('birthtime').value;
    const birthplace = $('birthplace').value.trim();
    const topic = $('topic').value;
    const question = $('question').value.trim();

    if(!birthdate){
      const e=$('err'); e.style.display='block'; e.textContent=t('need_birth');
      setTimeout(()=>e.style.display='none', 3000);
      return;
    }

    const sys = `You are "Xinlian Butler", an energy-type coach. OUTPUT LANGUAGE: ${langName}. Tone: warm, practical, actionable. Avoid medical/legal claims.`;
    const usr = buildPromptEnergy({langName, name, gender, birthdate, birthtime, birthplace, topic, question});

    const card = $('aiCard'); const box = $('aiText');
    card.style.display='block';
    box.innerHTML = `<div class="skeleton">
      <div style="width:65%"></div><div style="width:82%"></div><div style="width:90%"></div>
      <div style="width:72%"></div><div style="width:48%"></div>
    </div>`;

    try{
      const r = await fetch(`${API_BASE}/api/chat`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({messages:[
          {role:'system',content:sys},
          {role:'user',content:usr}
        ]})
      });
      let data={}; try{ data = await r.json(); }catch{}
      const raw = data.reply || data.text || (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
      box.innerHTML = mdToHtml(raw || t('retry'));
      window.scrollTo({top: card.offsetTop - 10, behavior:'smooth'});
    }catch(e){
      box.textContent = t('neterr');
    }
  }

  /* ====== Chat 浮窗 ====== */
  function mountChat(){
    const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
    function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
    async function askChat(prompt){
      addMsg(prompt,true); input.value='';
      const sys = `You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()]||'Simplified Chinese'}. Help with features, navigation, and membership. Tone: warm, concise.`;
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
          {role:'system',content:sys},{role:'user',content:prompt}
        ]})});
        let data={}; try{data=await r.json()}catch{}
        const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
        addMsg(reply || t('retry'));
      }catch{ addMsg(t('neterr')); }
    }
    fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
    closeBtn.addEventListener('click',()=>panel.style.display='none');
    send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
    input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
  }

  /* ===== 事件 & 初始化 ===== */
  function applyChatI18n(){
    $('ssChatFab').textContent = t('chat_fab');
    $('ssChatSend').textContent = t('chat_send');
    $('ssChatInput').placeholder = t('chat_ph');
    document.querySelector('.ss-chat-title').textContent = t('chat_title');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const bd = $('birthdate');
    if (bd && !bd.value) {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    const sel = $('langSelect');
    const current = getLang();
    sel.value = current;
    document.documentElement.lang = current;
    applyI18n();
    applyChatI18n();
    mountChat();

    $('go').addEventListener('click', generate);
    $('clear').addEventListener('click', ()=>{
      ['name','gender','birthtime','birthplace','topic','question','presetQ'].forEach(id=>{
        const el=$(id); if(!el) return;
        if (el.tagName==='SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      $('aiCard').style.display='none';
      $('aiText').innerHTML='';
      $('err').style.display='none';
    });

    $('presetQ').addEventListener('change', (e)=>{
      const txt = e.target.options[e.target.selectedIndex].textContent.trim();
      if (txt) $('question').value = txt;
    });

    sel.addEventListener('change', ()=>{
      setLang(sel.value);
      applyI18n();
      applyChatI18n();
    });
  });
})();
</script>
</body>
</html>


