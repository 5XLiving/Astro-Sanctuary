<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å¡”ç½—è¯¾ç¨‹è¯­éŸ³åŠŸèƒ½</title>
  <style>
    body { background: #111; color: gold; font-family: sans-serif; padding: 2rem; }
    .audio-controls { margin-bottom: 1rem; }
    select, button { font-size: 1rem; margin-right: 0.5rem; }
    .playback-options label { margin-right: 1rem; }
  </style>
</head>
<body>

  <h2>å¡”ç½—è¯¾ç¨‹ ç¬¬1è¯¾</h2>

  <div class="audio-controls">
    <label for="language-select">æ’­æ”¾è¯­è¨€ï¼š</label>
    <select id="language-select">
      <option value="ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
      <option value="English">English</option>
      <option value="EspaÃ±ol">EspaÃ±ol</option>
      <option value="æ—¥æœ¬èª">æ—¥æœ¬èª</option>
    </select>

    <button id="play-btn" aria-label="æ’­æ”¾éŸ³é¢‘">ğŸ§ Listen</button>

    <div class="playback-options">
      <label>è¯­é€Ÿ: <input type="range" id="speed-control" min="0.5" max="1.5" step="0.1" value="1.0"></label>
      <label>éŸ³é‡: <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.8"></label>
    </div>
  </div>

  <div class="spiritual-text">
    å¡”ç½—ç‰Œæœ€æ—©å¯è¿½æº¯è‡³14ä¸–çºªçš„æ¬§æ´²ï¼Œæœ€åˆæ˜¯ä¸€ç§è´µæ—å¨±ä¹çº¸ç‰Œï¼Œä½†å®ƒçœŸæ­£æµä¼ å¼€æ¥ï¼Œæ˜¯å› ä¸ºå…¶æ·±è—çš„ç¥ç§˜ä¸»ä¹‰è±¡å¾ä½“ç³»ï¼Œä¸å¡å·´æ‹‰ã€å æ˜Ÿã€ç‚¼é‡‘æœ¯ç­‰ä¼ ç»Ÿå¯†åˆ‡ç›¸å…³ã€‚
  </div>

  <script>
    const voiceMap = {
      'ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰': { languageCode: 'cmn-CN', name: 'cmn-CN-Wavenet-B' },
      'English': { languageCode: 'en-US', name: 'en-US-Wavenet-B' },
      'EspaÃ±ol': { languageCode: 'es-ES', name: 'es-ES-Wavenet-B' },
      'æ—¥æœ¬èª': { languageCode: 'ja-JP', name: 'ja-JP-Wavenet-B' }
    };

    async function playSpiritualContent(lang, text) {
      try {
        const response = await fetch('/api/get-tts-token', { method: 'POST' });
        const { token } = await response.json();
        if (!token) throw new Error('æ— æ³•å–å¾— TTS token');

        const voice = voiceMap[lang];
        if (!voice) {
          alert('æš‚æ— æ­¤è¯­è¨€çš„è¯­éŸ³èµ„æ–™');
          return;
        }

        const inputData = { text };

        const audioResponse = await fetch(
          `https://text-to-speech.googleapis.com/v1/text:synthesize?key=${token}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              input: inputData,
              voice,
              audioConfig: {
                audioEncoding: 'MP3',
                speakingRate: 0.9,
                pitch: -2.0
              }
            })
          }
        );

        const result = await audioResponse.json();
        if (!result.audioContent) throw new Error('TTS æ— éŸ³é¢‘è¾“å‡º');

        const byteCharacters = atob(result.audioContent);
        const byteArray = new Uint8Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteArray[i] = byteCharacters.charCodeAt(i);
        }
        const blob = new Blob([byteArray], { type: 'audio/mp3' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);

        audio.volume = parseFloat(document.getElementById('volume-control')?.value || 0.8);
        audio.playbackRate = parseFloat(document.getElementById('speed-control')?.value || 1.0);
        audio.play();

      } catch (err) {
        console.error(err);
        alert('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
      }
    }

    document.getElementById('play-btn').addEventListener('click', () => {
      const lang = document.getElementById('language-select').value;
      const text = document.querySelector('.spiritual-text').innerText;
      playSpiritualContent(lang, text);
    });
  </script>

</body>
</html>
