<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>塔罗课程语音功能</title>
  <style>
    body { background: #111; color: gold; font-family: sans-serif; padding: 2rem; }
    .audio-controls { margin-bottom: 1rem; }
    select, button { font-size: 1rem; margin-right: 0.5rem; }
    .playback-options label { margin-right: 1rem; }
  </style>
</head>
<body>

  <h2>塔罗课程 第1课</h2>

  <div class="audio-controls">
    <label for="language-select">播放语言：</label>
    <select id="language-select">
      <option value="中文（简体）">中文（简体）</option>
      <option value="English">English</option>
      <option value="Español">Español</option>
      <option value="日本語">日本語</option>
    </select>

    <button id="play-btn" aria-label="播放音频">🎧 Listen</button>

    <div class="playback-options">
      <label>语速: <input type="range" id="speed-control" min="0.5" max="1.5" step="0.1" value="1.0"></label>
      <label>音量: <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.8"></label>
    </div>
  </div>

  <div class="spiritual-text">
    塔罗牌最早可追溯至14世纪的欧洲，最初是一种贵族娱乐纸牌，但它真正流传开来，是因为其深藏的神秘主义象征体系，与卡巴拉、占星、炼金术等传统密切相关。
  </div>

  <script>
    const voiceMap = {
      '中文（简体）': { languageCode: 'cmn-CN', name: 'cmn-CN-Wavenet-B' },
      'English': { languageCode: 'en-US', name: 'en-US-Wavenet-B' },
      'Español': { languageCode: 'es-ES', name: 'es-ES-Wavenet-B' },
      '日本語': { languageCode: 'ja-JP', name: 'ja-JP-Wavenet-B' }
    };

    async function playSpiritualContent(lang, text) {
      try {
        const response = await fetch('/api/get-tts-token', { method: 'POST' });
        const { token } = await response.json();
        if (!token) throw new Error('无法取得 TTS token');

        const voice = voiceMap[lang];
        if (!voice) {
          alert('暂无此语言的语音资料');
          return;
        }

        const inputData = { text };

        const audioResponse = await fetch(
          `https://text-to-speech.googleapis.com/v1/text:synthesize?key=${token}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              input: inputData,
              voice,
              audioConfig: {
                audioEncoding: 'MP3',
                speakingRate: 0.9,
                pitch: -2.0
              }
            })
          }
        );

        const result = await audioResponse.json();
        if (!result.audioContent) throw new Error('TTS 无音频输出');

        const byteCharacters = atob(result.audioContent);
        const byteArray = new Uint8Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteArray[i] = byteCharacters.charCodeAt(i);
        }
        const blob = new Blob([byteArray], { type: 'audio/mp3' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);

        audio.volume = parseFloat(document.getElementById('volume-control')?.value || 0.8);
        audio.playbackRate = parseFloat(document.getElementById('speed-control')?.value || 1.0);
        audio.play();

      } catch (err) {
        console.error(err);
        alert('语音播放失败，请检查控制台');
      }
    }

    document.getElementById('play-btn').addEventListener('click', () => {
      const lang = document.getElementById('language-select').value;
      const text = document.querySelector('.spiritual-text').innerText;
      playSpiritualContent(lang, text);
    });
  </script>

</body>
</html>
