<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
:root{
  --bg:#0b0f14; --bg-accent:#0e1520; --card:#11161dcc; --surface:#0f1624; --line:#1f2a36;
  --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --radius-sm:10px; --radius-lg:18px; --shadow:0 8px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.28);
  --container:1100px; --gap:12px; --pad:18px; --focus:0 0 0 2px rgba(212,175,55,0.2);
  --bp-s:520px; --bp-m:760px; --bp-l:900px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
             linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans TC","Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}
.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}
.site-header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.8); border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:var(--shadow-sm); font-weight:800; color:#ffe084}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}
.now{font-size:.9rem; color:var(--muted)}

.section{margin-top:18px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:var(--pad); margin:16px 0}
.h2{font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084; display:flex; gap:8px; align-items:center}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}
.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} .row.cols-2{grid-template-columns:1fr 1fr} }
input,select{width:100%; border-radius:12px; border:1px solid #243244; background:var(--bg-accent); color:var(--text); padding:12px 12px; font-size:15px; outline:0}
input::placeholder{color:#6f8092}
input:focus,select:focus{box-shadow:var(--focus); border-color:#3a4c63}
.btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}
.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width:520px){ .pillars{grid-template-columns:repeat(2,1fr)} }
.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width:420px){ .bazi-table th,.bazi-table td{padding:8px 10px} }
.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:80px 1fr 60px; gap:10px; align-items:center}
.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.muted{color:var(--muted)}
.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}
.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}
.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}
.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

/* Butler / Pro report */
.butler-professional{display:none; margin-top:20px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:20px}
.butler-header{display:flex; align-items:center; gap:10px; margin-bottom:20px; color:var(--gold2); font-size:1.2rem; font-weight:700}
.butler-content{line-height:1.8; max-height:600px; overflow-y:auto; padding:15px; background:var(--surface); border-radius:10px; border:1px solid #253245}
.butler-section{margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #253245}
.butler-section h4{color:var(--gold2); margin-bottom:10px; font-size:1.05rem}

/* floating chat */
.chat-float{position:fixed; bottom:20px; right:20px; width:350px; height:500px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); z-index:1000; display:none; flex-direction:column}
.chat-float-header{padding:12px 16px; border-bottom:1px solid var(--line); background:rgba(212,175,55,.1); color:var(--gold2); font-weight:700; display:flex; justify-content:space-between; align-items:center; cursor:move}
.chat-float-close{background:none; border:none; color:var(--gold2); font-size:1.2rem; cursor:pointer; padding:4px; border-radius:4px}
.chat-float-close:hover{background:rgba(212,175,55,.2)}
.chat-float-body{flex:1; display:flex; flex-direction:column; padding:0}
.chat-float-messages{flex:1; overflow-y:auto; padding:12px; background:var(--surface); font-size:0.9rem}
.chat-float-input-area{padding:12px; border-top:1px solid var(--line); background:var(--bg-accent)}
.chat-toggle-btn{position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:linear-gradient(180deg,#fff9e6,#e6c76e); border:1px solid #e6c76e; color:#191919; font-size:1.5rem; cursor:pointer; box-shadow:0 4px 12px rgba(230,199,110,.3); z-index:1001; display:flex; align-items:center; justify-content:center}
.chat-toggle-btn:hover{transform:scale(1.05); box-shadow:0 6px 20px rgba(230,199,110,.5)}
@media (max-width:768px){
  .chat-float{width:300px; height:400px; bottom:10px; right:10px}
  .chat-toggle-btn{width:50px; height:50px; bottom:10px; right:10px}
}

/* form focus simplification */
input:focus,select:focus,textarea:focus{outline:none!important; box-shadow:none!important; border-color:#243244!important}
button:focus,.btn:focus,a:focus{outline:none!important; box-shadow:none!important}
*{-webkit-tap-highlight-color:transparent}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !é‡è¦} }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç°¡è©•</span>
    </a>
    <div style="display:flex; align-items:center; gap:10px;">
      <!-- Language selector -->
      <select id="langSelect" style="border-radius:999px; padding:6px 10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; font-size:0.85rem;">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>

      <span id="nowBox" class="now"></span>
    </div>
  </div>
</header>

  <main class="container">
    <!-- Input card -->
    <section class="card">
      <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤</div>
      <div class="row cols-3">
        <div>
          <label class="muted">å§“åï¼ˆé¸å¡«ï¼‰</label>
          <input id="name" placeholder="ä½ çš„ç¨±å‘¼ï¼ˆç”¨æ–¼å€‹äººåŒ–ï¼‰" />
        </div>
        <div>
          <label class="muted">æ€§åˆ¥</label>
          <select id="gender">
            <option value="">ä¸é€éœ²</option>
            <option value="male">ç”·æ€§</option>
            <option value="female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted">æ›†æ³•</label>
          <select id="calendar">
            <option value="gregorian">é™½æ›†</option>
            <option value="lunar">è¾²æ›†ï¼ˆå°šæœªæ”¯æ´ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted">å‡ºç”Ÿæ™‚é–“</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span>å‡ºç”Ÿæ™‚é–“ä¸è©³</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none">è¨ˆç®—ä¸­...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <!-- Result: pillars & elements -->
    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›¤</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <table class="bazi-table">
          <thead>
          <tr>
            <th></th>
            <th>å¹´æŸ±</th>
            <th>æœˆæŸ±</th>
            <th>æ—¥æŸ±</th>
            <th>æ™‚æŸ±</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>å¤©å¹²</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td>åœ°æ”¯</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td>äº”è¡Œ</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td>ç´éŸ³</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-wood"></i></div><span id="pct-wood">0%</span></div>
        <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-fire"></i></div><span id="pct-fire">0%</span></div>
        <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-earth"></i></div><span id="pct-earth">0%</span></div>
        <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-metal"></i></div><span id="pct-metal">0%</span></div>
        <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-water"></i></div><span id="pct-water">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- Pro report -->
    <section id="butlerProfessional" class="butler-professional">
      <div class="butler-header">
        <span>ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· å°ˆæ¥­å‘½ç†è§£è®€</span>
      </div>
      <div class="butler-content" id="professionalReport"></div>
    </section>

    <!-- Floating chat -->
    <button class="chat-toggle-btn" id="chatToggle">ç™¼å•</button>
    <div class="chat-float" id="chatFloat">
      <div class="chat-float-header">
        <span>ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· å•ç­”</span>
        <button class="chat-float-close" id="chatClose">Ã—</button>
      </div>
      <div class="chat-float-body">
        <div class="chat-float-messages" id="chatMessages">
          <div class="ss-msg">
            å—¨ï¼Œæˆ‘æ˜¯ä½ çš„å‘½ç†é¡§å•ã€‚ç•¶ä½ ç”Ÿæˆå‘½ç›¤ä¹‹å¾Œï¼Œå¯ä»¥é‡å°æ„Ÿæƒ…ã€äº‹æ¥­ã€è²¡å¯Œæˆ–æ™‚é–“ç¯€å¥ï¼Œæå‡ºæ›´å…·é«”çš„å•é¡Œã€‚
          </div>
        </div>
        <div class="chat-float-input-area">
          <div style="display:flex;gap:8px;">
            <input type="text" id="chatInput" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #253245; background:#0e1520; color:#e8edf3;">
            <button class="btn" id="chatSend" style="padding:8px 16px;">é€å‡º</button>
          </div>
        </div>
      </div>
    </div>

    <!-- VIP segment -->
    <section class="card section">
      <h2 class="group-title">ğŸŒ™ VIP å€åŸŸ</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title">ğŸ— å‘½ç†ç©ºé–“ Â· å°ˆå±¬å…§å®¹</div>
          <ul>
            <li>æ„Ÿæƒ…ï¼šç·£åˆ†æ·±åº¦èˆ‡å©šå§»èµ°å‘</li>
            <li>äº‹æ¥­ï¼šè·æ¶¯ç™¼å±•èˆ‡å‰µæ¥­æ½›åŠ›</li>
            <li>è²¡å¯Œï¼šè²¡ä½ã€åè²¡èˆ‡é€²è²¡ç¯€å¥</li>
            <li>å¯µç‰©å‘½ç›¤ï¼šé™ªä¼´å‹•ç‰©çš„æ€§æ ¼èˆ‡èƒ½é‡</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé–“ Â· éˆæ€§è¨˜éŒ„</div>
          <ul>
            <li>éˆæ€§ç­†è¨˜ï¼šç…§ç‰‡ã€å¤¢å¢ƒã€èªéŸ³èˆ‡ç¥ˆé¡˜æ–‡å­—</li>
            <li>èª²ç¨‹ï¼šå…«å­— / å¡”ç¾… / å æ˜Ÿ / éˆæ•¸</li>
            <li>å®¶æ—ç´€å¿µç³»çµ±ï¼šç‚ºè¦ªäººä¿ç•™ä¸€å€‹å°ˆå±¬ä½ç½®</li>
            <li>æ¯é€±èƒ½é‡ç·´ç¿’èˆ‡ç¥æ˜é¢¨æ ¼çš„å°ä»»å‹™</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px">ğŸ’ VIP ç™»å…¥</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head">å¸³è™Ÿç™»å…¥ / è¨»å†Š</div>
            <div class="body">
              <div class="row" id="authFields">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é›»å­éƒµä»¶ Email">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 8 ç¢¼ï¼Œå«å¤§å°å¯«èˆ‡æ•¸å­—ç¬¦è™Ÿï¼‰">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit">ç™»å…¥</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button">ğŸ”‘ é‡è¨­å¯†ç¢¼</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit">å»ºç«‹æ–°å¸³è™Ÿ</button>
                <div class="muted">è¨»å†Šå¾Œå¯ç²å¾—ä¸€æ¬¡å…è²»è§£ç›¤é«”é©—ã€‚</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head">æœƒå“¡æœå‹™</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">
                  ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆä»˜ï¼‰
                </a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">
                  â† å›åˆ° Astro å•†åŸ
                </a>
              </div>
              <div class="muted">$9.9 / æœˆ Â· å‘½ç†ç©ºé–“ + å¿ƒæ€œç©ºé–“ + å…¨éƒ¨å¿ƒéˆèª²ç¨‹</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <script>
  // If you hook to your worker, set it here (optional)
  window.API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

  (function(){
    'use strict';
    const SG_TZ = 'Asia/Singapore';
    const $ = id => document.getElementById(id);
    // è®“å…¨å±€ä¹Ÿèƒ½å…±ç”¨åŒä¸€å€‹ $
    window.$ = window.$ || $;
    const state = window.state = window.state || {};
    state.lang = 'zh-TW';

    const CURRENT_LANG = 'zh-TW';

    const LANG_PAGES = {
      'zh-CN': '/bazi.html',
      'en':    '/assets/bazi-language-pack/bazi-en.html',
      'zh-TW': '/assets/bazi-language-pack/bazi-zh-TW.html',
      'ja':    '/assets/bazi-language-pack/bazi-ja.html',
      'th':    '/assets/bazi-language-pack/bazi-th.html',
      'ms':    '/assets/bazi-language-pack/bazi-ms.html'
    };

    function updateNowBox(){
      try{
        const now = new Date();
        const fmt = new Intl.DateTimeFormat('zh-TW',{
          timeZone:SG_TZ,
          year:'numeric',month:'short',day:'2-digit',
          hour:'2-digit',minute:'2-digit'
        });
        const box = $('nowBox');
        if(box) box.textContent = fmt.format(now) + ' Â· SGT';
      }catch(e){}
    }
    updateNowBox();
    setInterval(updateNowBox, 60000);

    class BaziCalculator {
      constructor(){
        this.HEAVENLY_STEMS=['Jia','Yi','Bing','Ding','Wu','Ji','Geng','Xin','Ren','Gui'];
        this.STEMS_CN=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
        this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
        this.NAYIN=[
          'æµ·ä¸­é‡‘','çˆä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ',
          'åŠé‹’é‡‘','å±±é ­ç«','æ¾—ä¸‹æ°´','åŸé ­åœŸ',
          'ç™½è Ÿé‡‘','æ¥ŠæŸ³æœ¨','äº•æ³‰æ°´','å±‹ä¸ŠåœŸ',
          'éœ¹é‚ç«','æ¾æŸæœ¨','é•·æµæ°´','æ²™ä¸­é‡‘',
          'å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘',
          'ç‡ˆç«','å¤©æ²³æ°´','åŸç‰†åœŸ','ç™½è‡˜é‡‘',
          'æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«',
          'çŸ³æ¦´æœ¨','å¤§æµ·æ°´'
        ];
      }
      stemCn(index){ return this.STEMS_CN[(index+10)%10]; }
      yearPillar(year){
        const s=(year-4)%10, b=(year-4)%12;
        return {stemCn:this.stemCn(s), stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]};
      }
      solarMonthIndex(y,m,d){
        const mmdd=m*100+d;
        const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
        let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
        const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
        return {index:idx, branch:branchBy[idx]};
      }
      monthPillar(year,month,day){
        const {index,branch}=this.solarMonthIndex(year,month,day);
        const yStemIdx=(this.yearPillar(year).stemCn && this.STEMS_CN.indexOf(this.yearPillar(year).stemCn)) || 0;
        const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
        const stemIdx=(startMap[yStemIdx]+(index-1))%10;
        return {stemCn:this.stemCn(stemIdx), stem:this.HEAVENLY_STEMS[stemIdx], branch};
      }
      dayPillar(year,month,day){
        const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
        const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
        const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
        return {stemCn:this.stemCn(stemIdx), stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
      }
      hourPillar(dayStemCn,hour){
        const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
        const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
        const dayIdx=this.STEMS_CN.indexOf(dayStemCn);
        const hourIndex=Math.floor((hour+1)/2)%12;
        const stemIdx=(startMap[dayIdx]+hourIndex)%10;
        return {stemCn:this.stemCn(stemIdx), stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
      }
      stemElem(cn){
        return ({'ç”²':'Wood','ä¹™':'Wood','ä¸™':'Fire','ä¸':'Fire','æˆŠ':'Earth','å·±':'Earth',
                 'åºš':'Metal','è¾›':'Metal','å£¬':'Water','ç™¸':'Water'})[cn]||'-';
      }
      branchElem(b){
        return ({'å­':'Water','ä¸‘':'Earth','å¯…':'Wood','å¯':'Wood','è¾°':'Earth','å·³':'Fire',
                 'åˆ':'Fire','æœª':'Earth','ç”³':'Metal','é…‰':'Metal','æˆŒ':'Earth','äº¥':'Water'})[b]||'-';
      }
      stemNameEn(stemCn){
        const idx = this.STEMS_CN.indexOf(stemCn);
        if (idx === -1) return stemCn;
        const base = this.HEAVENLY_STEMS[idx];
        const elem = this.stemElem(stemCn);
        const elemZh = {Wood:'æœ¨',Fire:'ç«',Earth:'åœŸ',Metal:'é‡‘',Water:'æ°´'}[elem] || elem;
        return `${base}ï¼ˆ${elemZh}ï¼‰`;
      }
      branchNameEn(b){
        const map = {
          'å­':'å­ï¼ˆé¼ ï¼‰',
          'ä¸‘':'ä¸‘ï¼ˆç‰›ï¼‰',
          'å¯…':'å¯…ï¼ˆè™ï¼‰',
          'å¯':'å¯ï¼ˆå…”ï¼‰',
          'è¾°':'è¾°ï¼ˆé¾ï¼‰',
          'å·³':'å·³ï¼ˆè›‡ï¼‰',
          'åˆ':'åˆï¼ˆé¦¬ï¼‰',
          'æœª':'æœªï¼ˆç¾Šï¼‰',
          'ç”³':'ç”³ï¼ˆçŒ´ï¼‰',
          'é…‰':'é…‰ï¼ˆé›ï¼‰',
          'æˆŒ':'æˆŒï¼ˆç‹—ï¼‰',
          'äº¥':'äº¥ï¼ˆè±¬ï¼‰'
        };
        return map[b] || b;
      }
      nayin(stemCn,branch){
        const si=this.STEMS_CN.indexOf(stemCn), bi=this.EARTHLY_BRANCHES.indexOf(branch);
        return this.NAYIN[(si*2+bi)%this.NAYIN.length];
      }
    }

    const DayMasterText = {
      'ç”²':'ç”²æœ¨åƒä¸€æ£µå¤§æ¨¹ï¼Œå–œæ­¡å¾€ä¸Šé•·ã€å¾€å¤–æ‹“å±•ï¼Œä¸»å‹•ã€ç›´æ¥ï¼Œä¹Ÿæ¯”è¼ƒä¸å–œæ­¡è¢«é™åˆ¶ã€‚',
      'ä¹™':'ä¹™æœ¨åƒè—¤è”“èˆ‡èŠ±è‰ï¼Œæº«æŸ”ç´°è†©ï¼Œæ‡‚å¾—ç…§é¡§ä»–äººï¼Œä¹Ÿåœ¨æ„äººéš›å’Œè«§ã€‚',
      'ä¸™':'ä¸™ç«åƒå¤ªé™½ï¼Œå¤–é¡¯ã€ç†±æƒ…ã€è¬›ç¾©æ°£ï¼Œç¿’æ…£ç”¨è¡Œå‹•å’Œç†±åº¦å½±éŸ¿èº«é‚Šçš„äººã€‚',
      'ä¸':'ä¸ç«åƒç‡­å…‰èˆ‡çˆç«ï¼Œçœ‹èµ·ä¾†æº«å’Œï¼Œä½†å…§åœ¨æœ‰ç©©å®šçš„æº«åº¦ï¼Œé‡è¦–æ‰¿è«¾èˆ‡ç…§é¡§ã€‚',
      'æˆŠ':'æˆŠåœŸåƒé«˜å±±å¤§åœ°ï¼Œå¯é ã€ç©©é‡ï¼Œåšäº‹è¬›ç©¶é•·æœŸç´¯ç©èˆ‡å®‰å…¨æ„Ÿã€‚',
      'å·±':'å·±åœŸåƒç”°åœ°èˆ‡åœ’åœŸï¼Œå‹¤å‹ã€ç´°å¿ƒï¼Œé¡˜æ„ç‚ºå®¶äººèˆ‡å¤¥ä¼´ä»˜å‡ºã€‚',
      'åºš':'åºšé‡‘åƒåˆ©åŠèˆ‡ç¤¦çŸ³ï¼Œæœæ–·ã€ç›´æ¥ï¼Œæœ‰åŸå‰‡ï¼Œæœ‰æ™‚ä¹Ÿæ¯”è¼ƒä¸å–œæ­¡æ‹å½æŠ¹è§’ã€‚',
      'è¾›':'è¾›é‡‘åƒç å¯¶èˆ‡é£¾å“ï¼Œé‡è¦–å“è³ªã€ç´°ç¯€èˆ‡ç¾æ„Ÿï¼Œå°æ˜¯éå¥½å£æœ‰è‡ªå·±çš„æ¨™æº–ã€‚',
      'å£¬':'å£¬æ°´åƒå¤§æ²³èˆ‡æµ·æ´‹ï¼Œè‡ªç”±ã€å½ˆæ€§é«˜ï¼Œå–œæ­¡æµå‹•èˆ‡å¤šè®Šçš„ç”Ÿæ´»ç¯€å¥ã€‚',
      'ç™¸':'ç™¸æ°´åƒé›¨éœ²èˆ‡éœ§æ°£ï¼Œæ•æ„Ÿã€ç›´è¦ºå¼·ï¼Œå…§åœ¨ä¸–ç•Œè±å¯Œè€Œç´°è†©ã€‚'
    };

    const RelationText = {
      'ç”²':{
        traits:'åœ¨æ„Ÿæƒ…è£¡åä¸»å‹•ï¼Œé¡˜æ„æ‰¿æ“”ã€ä¹Ÿç¿’æ…£å¸¶é ­åšæ±ºå®šã€‚',
        tips:'ç·´ç¿’åœ¨é‡è¦é¸æ“‡å‰å¤šè½ã€å¤šå•ä¸€å¥å°æ–¹çš„æ„Ÿå—ï¼Œèƒ½è®“é—œä¿‚æ›´ç©©ã€‚'
      },
      'ä¹™':{
        traits:'å¾ˆå®¹æ˜“ç‚ºå°æ–¹è‘—æƒ³ï¼Œé¡˜æ„é·å°±ã€ç…§é¡§å°æ–¹çš„éœ€è¦ã€‚',
        tips:'è¨˜å¾—å…ˆç…§é¡§è‡ªå·±ï¼Œå†ç…§é¡§åˆ¥äººï¼ŒæŠŠçœŸå¯¦éœ€æ±‚èªªå‡ºå£ä¸¦ä¸æ˜¯è‡ªç§ã€‚'
      },
      'ä¸™':{
        traits:'å–œæ­¡ç†±åº¦èˆ‡ç«èŠ±ï¼Œå¸Œæœ›å¦ä¸€åŠèƒ½çµ¦ä½ å›æ‡‰èˆ‡æ¿€æƒ…ã€‚',
        tips:'åµæ¶æ™‚å…ˆè®“æƒ…ç·’å†·å»ï¼Œå†è«‡äº‹æƒ…ï¼Œé¿å…ä¸€æ™‚æƒ…ç·’èªªå‡ºå‚·äººçš„è©±ã€‚'
      },
      'ä¸':{
        traits:'ä¸ä¸€å®šå¾ˆå¤–é¡¯ï¼Œä½†åœ¨æ„çš„äººèº«ä¸Šæœƒé»˜é»˜çµ¦å¾ˆå¤šå¿ƒåŠ›èˆ‡æ”¯æŒã€‚',
        tips:'å¯ä»¥æ›´ä¸»å‹•è¡¨é”æ„›èˆ‡æ„Ÿè¬ï¼Œè®“å°æ–¹æ¸…æ¥šæ„Ÿå—åˆ°ä½ çš„åœ¨ä¹ã€‚'
      },
      'æˆŠ':{
        traits:'é‡è¦–è²¬ä»»èˆ‡æ‰¿è«¾ï¼Œæœƒä¸€ç›´æ€è€ƒå…©å€‹äººçš„æœªä¾†èˆ‡ç©©å®šã€‚',
        tips:'åœ¨å‹™å¯¦ä¹‹å¤–ï¼ŒåŠ ä¸€é»æµªæ¼«èˆ‡é©šå–œï¼Œèƒ½è®“é—œä¿‚æ›´æœ‰æº«åº¦ã€‚'
      },
      'å·±':{
        traits:'å®¹æ˜“æ“”å¿ƒå¾ˆå¤šç´°ç¯€ï¼Œå°é—œä¿‚çš„å®‰å…¨æ„Ÿä¹Ÿæ¯”è¼ƒæ•æ„Ÿã€‚',
        tips:'é©æ™‚æŠŠå£“åŠ›èªªå‡ºä¾†ï¼Œä¸è¦ç¨è‡ªæ‰›ä¸‹æ‰€æœ‰ï¼Œå­¸æœƒç›¸ä¿¡å°æ–¹çš„åŠ›é‡ã€‚'
      },
      'åºš':{
        traits:'è¬›æ±‚ç›´æ¥èˆ‡å¦ç™½ï¼Œä¸å–œæ­¡æ›–æ˜§èˆ‡æ‹–æ³¥å¸¶æ°´ã€‚',
        tips:'èªªçœŸè©±æ™‚ï¼Œå¯ä»¥å¤šä¸€é»æº«åº¦èˆ‡åŒç†ï¼Œæ•ˆæœæœƒæ¯”å–®ç´”çš„ã€Œå°éŒ¯ã€æ›´å¥½ã€‚'
      },
      'è¾›':{
        traits:'æ¨™æº–é«˜ã€è§€å¯Ÿç´°ï¼Œå°ç´°å¾®è®ŠåŒ–ç‰¹åˆ¥æ•éŠ³ã€‚',
        tips:'å…è¨±å½¼æ­¤æœ‰ä¸å®Œç¾çš„ç©ºé–“ï¼Œæ”¾é¬†ä¸€é»ï¼Œé—œä¿‚æœƒæ›´è¼•é¬†è‡ªåœ¨ã€‚'
      },
      'å£¬':{
        traits:'éœ€è¦ä¸€å®šçš„è‡ªç”±æ„Ÿèˆ‡ç©ºé–“ï¼Œå³ä½¿åœ¨é—œä¿‚è£¡ä¹Ÿå¸Œæœ›ä¿ç•™è‡ªæˆ‘ã€‚',
        tips:'æŠŠã€Œæƒ³è¦è‡ªç”±ã€è½‰åŒ–æˆã€Œä¸€èµ·å»é«”é©—æ–°äº‹ç‰©ã€ï¼Œé—œä¿‚æœƒæ›´æœ‰æ´»åŠ›ã€‚'
      },
      'ç™¸':{
        traits:'æƒ…ç·’ç´°è†©ï¼Œå¾ˆå®¹æ˜“æ„Ÿå—åˆ°æ°£æ°›çš„è®ŠåŒ–èˆ‡å°æ–¹çš„å°å¿ƒæ€ã€‚',
        tips:'åœ¨æƒ…ç·’å¾ˆæ»¿çš„æ™‚å€™ï¼Œå…ˆè®“è‡ªå·±ç©©ä¸‹ä¾†ï¼Œå†é€²å…¥é‡è¦å°è©±ã€‚'
      }
    };

    const ELEM_LABEL_TW = {
      Wood:'æœ¨', Fire:'ç«', Earth:'åœŸ', Metal:'é‡‘', Water:'æ°´'
    };

    function strongestWeakest(counts){
      const order=['Wood','Fire','Earth','Metal','Water'];
      let max = -1, min = 1e9, maxKey='Wood', minKey='Wood';
      order.forEach(k=>{
        const v = counts[k]||0;
        if(v>max){ max=v; maxKey=k; }
        if(v<min){ min=v; minKey=k; }
      });
      return {strongest:maxKey, weakest:minKey};
    }

    function buildProReport(ctx){
      const box = document.getElementById('professionalReport');
      if(!box || !ctx) return;
      const dmStemCn = ctx.day.stemCn;
      const rel = RelationText[dmStemCn] || {
        traits:'æ„Ÿæƒ…è£¡é‡è¦–çœŸèª èˆ‡äº’ç›¸æ”¯æŒã€‚',
        tips:'ä¿æŒé–‹æ”¾æºé€šï¼Œæ¯”æ²ˆé»˜çŒœæ¸¬æ›´æœ‰åŠ›é‡ã€‚'
      };
      const dmLine = DayMasterText[dmStemCn] || 'ä½ çš„æ—¥ä¸»å€‹æ€§ç›¸å°å¹³è¡¡ï¼Œå…·å‚™å½ˆæ€§èˆ‡é©æ‡‰åŠ›ã€‚';
      const {strongest, weakest} = strongestWeakest(ctx.elements);

      const strongZh = ELEM_LABEL_TW[strongest] || strongest;
      const weakZh   = ELEM_LABEL_TW[weakest]   || weakest;

      const parts = [];

      parts.push(`
        <div class="butler-section">
          <h4>ä¸€ã€æ—¥ä¸»æ€§æ ¼ç¸½è¦½</h4>
          <p><strong>æ—¥ä¸»ï¼š</strong>${ctx.day.stemCn}ï¼ˆ${ctx.day.stemEn}ï¼‰</p>
          <p>${dmLine}</p>
        </div>
      `);

      parts.push(`
        <div class="butler-section">
          <h4>äºŒã€äº”è¡Œèƒ½é‡åˆ†ä½ˆ</h4>
          <p>
            æœ¨ï¼š${ctx.elements.Wood}%ã€€ç«ï¼š${ctx.elements.Fire}%ã€€
            åœŸï¼š${ctx.elements.Earth}%ã€€é‡‘ï¼š${ctx.elements.Metal}%ã€€
            æ°´ï¼š${ctx.elements.Water}%ã€‚
          </p>
          <p>
            <strong>æ­¤ç›¤æœ€å¼·äº”è¡Œï¼š</strong>${strongZh}<br/>
            <strong>æ­¤ç›¤æœ€å¼±äº”è¡Œï¼š</strong>${weakZh}
          </p>
          <p>
            å¯¦å‹™ä¸Šï¼Œå¯ä»¥æŠŠæœ€å¼·çš„äº”è¡Œï¼Œç•¶æˆä½ åšæ±ºå®šæ™‚çš„ã€Œå„ªå‹¢è³‡æºã€ï¼Œ
            è€Œæœ€å¼±çš„äº”è¡Œï¼Œå‰‡æ˜¯éœ€è¦é€éç’°å¢ƒã€ç¿’æ…£èˆ‡äººéš›ä¾†æ…¢æ…¢è£œå¼·çš„æ–¹å‘ã€‚
          </p>
        </div>
      `);

      parts.push(`
        <div class="butler-section">
          <h4>ä¸‰ã€æ„Ÿæƒ…èˆ‡å©šå§»å‚¾å‘</h4>
          <p><strong>æ„Ÿæƒ…ç‰¹è³ªï¼š</strong>${rel.traits}</p>
          <p><strong>ä¿®æ­£å»ºè­°ï¼š</strong>${rel.tips}</p>
          <p>
            æ•´é«”ä¾†çœ‹ï¼Œåªè¦åœ¨æƒ…ç·’ç©©å®šã€ç”Ÿæ´»å£“åŠ›ä¸é‚£éº¼ç·Šç¹ƒçš„æ™‚å€™åšé—œä¿‚æ±ºå®šï¼Œ
            é€šå¸¸æœƒæ¯”åœ¨ç„¦æ…®ã€è²¡å‹™å£“åŠ›å¤§çš„æ™‚å€™ï¼Œæ›´å®¹æ˜“åšå‡ºå°å½¼æ­¤æœ‰åˆ©çš„é¸æ“‡ã€‚
          </p>
        </div>
      `);

      parts.push(`
        <div class="butler-section">
          <h4>å››ã€äº‹æ¥­æ–¹å‘èˆ‡å·¥ä½œç¿’æ€§</h4>
          <p>
            <strong>äº‹æ¥­é—œéµï¼š</strong>é€™å¼µå‘½ç›¤åå‘ã€Œé å¯¦åŠ›èˆ‡æ™‚é–“ç´¯ç©ã€ï¼Œ
            é©åˆç”¨å°ˆæ¥­ã€å£ç¢‘èˆ‡ç©©å®šè¼¸å‡ºä¾†æ›å–é•·æœŸæˆæœï¼Œè€Œä¸æ˜¯åªè¿½æ±‚çŸ­æœŸæš´è¡ã€‚
          </p>
          <p>
            è‹¥æœ¨ç«åæ—ºï¼Œé©åˆåœ¨äººç¾¤ã€è¡¨é”ã€å‰µæ„ç›¸é—œçš„é ˜åŸŸç™¼æ®ï¼›
            è‹¥é‡‘æ°´åæ—ºï¼Œå‰‡æ›´åˆ©æ–¼åˆ†æã€æŠ€è¡“ã€ç­–ç•¥è¦åŠƒèˆ‡å¹•å¾Œé‹ä½œã€‚
          </p>
        </div>
      `);

      parts.push(`
        <div class="butler-section">
          <h4>äº”ã€è²¡å¯Œç¯€å¥èˆ‡å¯¦éš›å»ºè­°</h4>
          <p>
            é€™è£¡å¼·èª¿çš„æ˜¯ã€Œç¾é‡‘æµæ„è­˜ã€ï¼šæœ‰ä¸€ä»½ç°¡å–®æ¸…æ¥šçš„æœˆåº¦é ç®—ã€å°é¡ç·Šæ€¥é å‚™é‡‘ï¼Œ
            ä»¥åŠä¸€å€‹è‡ªå·±èƒ½æ¥å—çš„ã€Œé¢¨éšªé‡‘é¡ä¸Šé™ã€ï¼Œèƒ½å¹«ä½ æ¸›å°‘å¾ˆå¤šç„¦æ…®ã€‚
          </p>
          <p>
            æœ€ç†æƒ³çš„è²¡å¯Œæ¨¡å¼ï¼Œæ˜¯å…ˆç©©å®šå¥½æœ¬æ¥­æ”¶å…¥èˆ‡å°ˆæ¥­ï¼Œå†æ…¢æ…¢æ“´å……ä¸€åˆ°å…©å€‹
            çœŸæ­£é©åˆè‡ªå·±å€‹æ€§çš„å‰¯æ¥­æˆ–è¢«å‹•æ”¶å…¥ï¼Œè€Œä¸æ˜¯åŒæ™‚é–‹å¤ªå¤šæˆ°ç·šã€‚
          </p>
        </div>
      `);

      parts.push(`
        <div class="butler-section">
          <h4>å…­ã€çŸ­æœŸè¡Œå‹•æ¸…å–®</h4>
          <ul>
            <li>é¸ä¸€å€‹ 30 å¤©å…§å¯å®Œæˆçš„å°ç›®æ¨™ï¼ˆäº‹æ¥­ã€é‡‘éŒ¢æˆ–å¥åº·çš†å¯ï¼‰ï¼Œå¯«ä¸‹ä¾†ä¸¦é‡åŒ–ã€‚</li>
            <li>æ¯é€±å›ºå®šä¸€å€‹ã€Œæª¢è¦–æ™‚æ®µã€ï¼Œå›é¡§æœ¬é€±ç‹€æ…‹èˆ‡ä¸‹é€±å®‰æ’ã€‚</li>
            <li>ç”¨é¡è‰²ã€ç’°å¢ƒä½ˆç½®èˆ‡æ´»å‹•ï¼Œåˆ»æ„åŠ å¼·ä½ çš„æœ€å¼·äº”è¡Œï¼Œè®“è‡ªå·±æ›´æœ‰åŠ›é‡ã€‚</li>
            <li>å¾ç°¡å–®å¯é‡è¤‡çš„å°ç¿’æ…£é–‹å§‹ï¼Œæ…¢æ…¢è£œè¶³å‘½ç›¤ä¸­æœ€å¼±çš„é‚£å€‹äº”è¡Œã€‚</li>
          </ul>
        </div>
      `);

      box.innerHTML = parts.join('\n');
      const sec = document.getElementById('butlerProfessional');
      if(sec) sec.style.display = 'block';
    }

    const calc = new BaziCalculator();

    function showError(msg){
      const e = $('error');
      if(!e) return;
      e.textContent = msg;
      e.style.display = 'block';
    }
    function clearError(){
      const e = $('error');
      if(e){ e.textContent=''; e.style.display='none'; }
    }

    function onGenerate(){
      clearError();
      const btn = $('genBtn');
      const textSpan = $('genBtnText');
      const loadSpan = $('genBtnLoading');
      const birthdate = $('birthdate').value;
      const timeStr = $('birthtime').value;
      const timeUnknown = $('timeUnknown').checked;

      if(!birthdate){
        showError('è«‹è¼¸å…¥å‡ºç”Ÿæ—¥æœŸã€‚');
        return;
      }
      const m = birthdate.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m){
        showError('æ—¥æœŸæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨ YYYY-MM-DDã€‚');
        return;
      }
      const year = parseInt(m[1],10), month=parseInt(m[2],10), day=parseInt(m[3],10);

      let hour = null, minute = null;
      if(!timeUnknown && timeStr){
        const tm = timeStr.match(/^(\d{2}):(\d{2})$/);
        if(tm){
          hour = parseInt(tm[1],10);
          minute = parseInt(tm[2],10);
        }
      }

      if(btn){ btn.disabled=true; }
      if(textSpan) textSpan.style.display='none';
      if(loadSpan) loadSpan.style.display='inline';

      try{
        const yearP = calc.yearPillar(year);
        const monthP = calc.monthPillar(year,month,day);
        const dayP = calc.dayPillar(year,month,day);
        const hasHour = hour!==null && !isNaN(hour);
        const hourP = hasHour ? calc.hourPillar(dayP.stemCn,hour) : null;

        const pillarsBox = $('bazi-pillars');
        if(pillarsBox){
          pillarsBox.innerHTML = '';
          const arr = [
            {label:'å¹´', p:yearP},
            {label:'æœˆ',p:monthP},
            {label:'æ—¥',p:dayP},
            {label:'æ™‚',p:hourP}
          ];
          arr.forEach(item=>{
            const div = document.createElement('div');
            div.className='pillar';
            if(item.p){
              div.innerHTML = `
                <div class="tit">${item.label}æŸ±</div>
                <div class="gz">${item.p.stemCn}${item.p.branch}</div>
                <div class="muted"></div>
              `;
            }else{
              div.innerHTML = `
                <div class="tit">${item.label}æŸ±</div>
                <div class="gz">â€”</div>
                <div class="muted">N/A</div>
              `;
            }
            pillarsBox.appendChild(div);
          });
        }

        // å¤©å¹²ï¼šåªé¡¯ç¤ºä¸­æ–‡ã€Œç”²ä¹™ä¸™ä¸â€¦ã€
        setText('year-stem',  yearP.stemCn);
        setText('month-stem', monthP.stemCn);
        setText('day-stem',   dayP.stemCn);
        setText('hour-stem',  hourP ? hourP.stemCn : 'â€”');

        // åœ°æ”¯ï¼šåªé¡¯ç¤ºä¸­æ–‡ã€Œå­ä¸‘å¯…å¯â€¦ã€
        setText('year-branch',  yearP.branch);
        setText('month-branch', monthP.branch);
        setText('day-branch',   dayP.branch);
        setText('hour-branch',  hourP ? hourP.branch : 'â€”');

        const yearElem = calc.stemElem(yearP.stemCn);
        const monthElem = calc.stemElem(monthP.stemCn);
        const dayElem = calc.stemElem(dayP.stemCn);
        const hourElem = hourP ? calc.stemElem(hourP.stemCn) : 'â€”';

        const ELEM_TW = {Wood:'æœ¨',Fire:'ç«',Earth:'åœŸ',Metal:'é‡‘',Water:'æ°´'};
        setText('year-element',ELEM_TW[yearElem] || yearElem);
        setText('month-element',ELEM_TW[monthElem] || monthElem);
        setText('day-element',ELEM_TW[dayElem] || dayElem);
        setText('hour-element',hourElem==='â€”' ? 'â€”' : (ELEM_TW[hourElem] || hourElem));

        const yearNa = calc.nayin(yearP.stemCn,yearP.branch);
        const monthNa = calc.nayin(monthP.stemCn,monthP.branch);
        const dayNa = calc.nayin(dayP.stemCn,dayP.branch);
        const hourNa = hourP?calc.nayin(hourP.stemCn,hourP.branch):'â€”';
        setText('year-nayin',yearNa);
        setText('month-nayin',monthNa);
        setText('day-nayin',dayNa);
        setText('hour-nayin',hourNa);

        const dateBox = $('bazi-date');
        if(dateBox){
          let timePart = timeUnknown ? 'æ™‚é–“ä¸è©³' : (hour!=null?`${String(hour).padStart(2,'0')}:${String(minute||0).padStart(2,'0')}`:'æ™‚é–“ä¸è©³');
          dateBox.textContent = `å‡ºç”Ÿï¼š${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')} Â· ${timePart}`;
        }

        const counts = {Wood:0,Fire:0,Earth:0,Metal:0,Water:0};
        function addElem(e){ if(e && counts.hasOwnProperty(e)) counts[e]++; }
        const all = [yearP,monthP,dayP].concat(hourP? [hourP] : []);
        all.forEach(p=>{
          const se = calc.stemElem(p.stemCn);
          const be = calc.branchElem(p.branch);
          addElem(se); addElem(be);
        });
        const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
        const pct = {};
        Object.keys(counts).forEach(k=>{
          pct[k] = Math.round(counts[k]/total*100);
        });

        function setBar(name,val){
          const bar = $('bar-'+name.toLowerCase());
          const txt = $('pct-'+name.toLowerCase());
          if(bar) bar.style.width = val + '%';
          if(txt) txt.textContent = val + '%';
        }
        setBar('wood',pct.Wood);
        setBar('fire',pct.Fire);
        setBar('earth',pct.Earth);
        setBar('metal',pct.Metal);
        setBar('water',pct.Water);

        const bw = $('bazi-elements-balance');
        const {strongest,weakest} = strongestWeakest(pct);
        if(bw){
          const sZh = ELEM_LABEL_TW[strongest] || strongest;
          const wZh = ELEM_LABEL_TW[weakest] || weakest;
          bw.textContent = `åœ¨é€™å¼µå‘½ç›¤ä¸­ï¼Œäº”è¡Œä»¥ã€Œ${sZh}ã€æœ€æ—ºï¼Œã€Œ${wZh}ã€ç›¸å°è¼ƒå¼±ã€‚`;
        }

        const ctx = {
          name: $('name').value || '',
          gender: $('gender').value || '',
          birth: {year,month,day,hour,minute,timeUnknown},
          year: {stemCn:yearP.stemCn, stemEn:yearP.stem, branch:yearP.branch, element:yearElem, nayin:yearNa},
          month:{stemCn:monthP.stemCn, stemEn:monthP.stem, branch:monthP.branch, element:monthElem, nayin:monthNa},
          day:  {stemCn:dayP.stemCn, stemEn:dayP.stem, branch:dayP.branch, element:dayElem, nayin:dayNa},
          hour: hourP?{stemCn:hourP.stemCn, stemEn:hourP.stem, branch:hourP.branch, element:hourElem, nayin:hourNa}:null,
          elements:pct
        };
        window.lastCtx = ctx;

        const resSec = $('result');
        if(resSec) resSec.style.display = 'block';
        buildProReport(ctx);

      }catch(e){
        console.error(e);
        showError('ç”¢ç”Ÿå‘½ç›¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
      }finally{
        if(btn){ btn.disabled=false; }
        if(textSpan) textSpan.style.display='inline';
        if(loadSpan) loadSpan.style.display='none';
      }
    }

    function appendChat(role,text){
      const box = $('chatMessages');
      if(!box) return;
      const div = document.createElement('div');
      div.style.marginBottom = '8px';
      div.style.whiteSpace = 'pre-wrap';
      if(role==='user'){
        div.style.textAlign='right';
        div.innerHTML = `<strong>ä½ ï¼š</strong>${text}`;
      }else{
        div.innerHTML = `<strong>Butlerï¼š</strong>${text}`;
      }
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function handleChatSend(){
      const input = $('chatInput');
      if(!input) return;
      const q = input.value.trim();
      if(!q) return;
      appendChat('user', q);
      input.value = '';

      const ctx = window.lastCtx;
      if(!ctx){
        appendChat('bot','è«‹å…ˆç”Ÿæˆä½ çš„å…«å­—å‘½ç›¤ï¼Œå†å°±æ„Ÿæƒ…ã€äº‹æ¥­ã€è²¡å¯Œæˆ–æ™‚é–“ç¯€å¥æå•ã€‚');
        return;
      }

      const dm = ctx.day.stemCn || 'æ—¥ä¸»';
      appendChat(
        'bot',
        `ä½ çš„æ—¥ä¸»æ˜¯ã€Œ${dm}ã€ï¼Œé€™é¡å‹åœ¨åšé‡å¤§æ±ºå®šæ™‚ï¼Œç‰¹åˆ¥è¦ç•™æ„ä¸‰ä»¶äº‹ï¼š\n\n` +
        `ä¸€ã€å…ˆçœ‹ç•¶ä¸‹ç‹€æ…‹æ˜¯å¦ç©©å®šï¼Œå†æ±ºå®šè¦ä¸è¦ã€ŒåŠ é€Ÿã€æˆ–ã€Œè½‰å½ã€ã€‚\n` +
        `äºŒã€ç›¡é‡é¸æ“‡ç¬¦åˆè‡ªå·±å¤©æ€§çš„è·¯ï¼Œè€Œä¸æ˜¯å‹‰å¼·è·Ÿé¢¨ã€‚\n` +
        `ä¸‰ã€æŠŠå¤§ç›®æ¨™æ‹†æˆå¹¾å€‹å°éšæ®µï¼Œå°±ä¸æœƒå› ç‚ºå£“åŠ›å¤ªå¤§è€Œå¡ä½ã€‚`
      );
    }

    function initChat(){
      const toggle = $('chatToggle');
      const panel = $('chatFloat');
      const closeBtn = $('chatClose');
      const sendBtn = $('chatSend');
      const input = $('chatInput');
      if(!toggle || !panel) return;
      toggle.addEventListener('click', ()=>{ panel.style.display = panel.style.display==='flex'?'none':'flex'; });
      if(closeBtn) closeBtn.addEventListener('click', ()=>{ panel.style.display='none'; });
      if(sendBtn) sendBtn.addEventListener('click', handleChatSend);
      if(input) input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleChatSend(); } });

      const header = panel.querySelector('.chat-float-header');
      if(header){
        let dragging=false, startX=0,startY=0,startLeft=0,startTop=0;
        header.addEventListener('mousedown',e=>{
          dragging=true;
          startX=e.clientX; startY=e.clientY;
          const rect=panel.getBoundingClientRect();
          startLeft=rect.left; startTop=rect.top;
          document.body.style.userSelect='none';
        });
        window.addEventListener('mousemove',e=>{
          if(!dragging) return;
          const dx=e.clientX-startX, dy=e.clientY-startY;
          panel.style.left = (startLeft+dx)+'px';
          panel.style.top = (startTop+dy)+'px';
          panel.style.right = 'auto';
          panel.style.bottom = 'auto';
        });
        window.addEventListener('mouseup',()=>{
          dragging=false;
          document.body.style.userSelect='';
        });
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = $('genBtn');
      if(btn) btn.addEventListener('click', onGenerate);
      initChat();

      const langSelect = $('langSelect');
      if (langSelect) {
        langSelect.value = CURRENT_LANG;
        langSelect.addEventListener('change', e => {
          const code = e.target.value;
          const url = LANG_PAGES[code];
          if (url) window.location.href = url;
        });
      }

      const loginForm = $('loginForm');
      const registerForm = $('registerForm');
      const resetBtn = $('resetBtn');
      const authError = $('authError');
      if(loginForm){
        loginForm.addEventListener('submit', e=>{
          e.preventDefault();
          if(authError){
            authError.textContent = 'ç™»å…¥ API å°šæœªä¸²æ¥ï¼Œè«‹ä¹‹å¾Œæ¥ä¸Šå¾Œç«¯æœå‹™ã€‚';
            authError.style.display='block';
          }
        });
      }
      if(registerForm){
        registerForm.addEventListener('submit', e=>{
          e.preventDefault();
          if(authError){
            authError.textContent = 'è¨»å†Š API å°šæœªä¸²æ¥ï¼Œè«‹ä¹‹å¾Œæ¥ä¸Šå¾Œç«¯æœå‹™ã€‚';
            authError.style.display='block';
          }
        });
      }
      if(resetBtn){
        resetBtn.addEventListener('click', ()=>{
          if(authError){
            authError.textContent = 'é‡è¨­å¯†ç¢¼æµç¨‹å°šæœªä¸²æ¥ï¼Œè«‹åœ¨æ­¤å¯¦ä½œä½ çš„é‡è¨­é‚è¼¯ã€‚';
            authError.style.display='block';
          }
        });
      }
    });
  })();
  </script>

<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Singapore';
  const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms-MY' };
  const getLocale = () => (localeMap[(window.state && window.state.lang) || 'zh-TW'] || 'zh-TW');

  window.applyI18n = (function(prev){
    return function(){
      if (typeof prev === 'function') prev();
      if (typeof window.tickNow === 'function') window.tickNow();
    };
  })(window.applyI18n);

  if (typeof window.tickNow !== 'function') {
    window.tickNow = function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const fmt = new Intl.DateTimeFormat(getLocale(), {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false, timeZone: TZ
      });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    };
  }

  function initBirthDefaults() {
    const bd = $('birthdate'); const bt = $('birthtime'); const unk = $('timeUnknown');
    const nowSG = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));

    if (bd && !bd.value){
      const y=nowSG.getFullYear(), m=String(nowSG.getMonth()+1).padStart(2,'0'), d=String(nowSG.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    if (bt){
      const hh=String(nowSG.getHours()).padStart(2,'0'), mm=String(nowSG.getMinutes()).padStart(2,'0');
      if (!bt.value) bt.value = `${hh}:${mm}`;
      const setUnknownState = ()=>{ const isUnknown = !!(unk && unk.checked); bt.disabled = isUnknown; if (isUnknown) bt.value = ''; };
      setUnknownState();
      if (unk && !unk._wired){
        unk._wired = true;
        unk.addEventListener('change', ()=>{
          if (unk.checked){
            bt.disabled = true; bt.value = '';
          } else {
            bt.disabled = false;
            if (!bt.value){
              const n = new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
              bt.value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
            }
          }
        });
      }
    }
  }

  initBirthDefaults();
  if (typeof window.tickNow === 'function') window.tickNow();
  if (!window._clock) window._clock = setInterval(()=>{ try{ window.tickNow(); }catch{} }, 60000);
})();
</script>
</body>
</html>
