<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
:root{
  --bg:#0b0f14; --bg-accent:#0e1520; --card:#11161dcc; --surface:#0f1624; --line:#1f2a36;
  --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --radius-sm:10px; --radius-lg:18px; --shadow:0 8px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.28);
  --container:1100px; --gap:12px; --pad:18px; --focus:0 0 0 2px rgba(212,175,55,0.2);
  --bp-s:520px; --bp-m:760px; --bp-l:900px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
             linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans TC","Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}
.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}
.site-header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.8); border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:var(--shadow-sm); font-weight:800; color:#ffe084}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}
.now{font-size:.9rem; color:var(--muted)}

.section{margin-top:18px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:var(--pad); margin:16px 0}
.h2{font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084; display:flex; gap:8px; align-items:center}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}
.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} .row.cols-2{grid-template-columns:1fr 1fr} }
input,select{width:100%; border-radius:12px; border:1px solid #243244; background:var(--bg-accent); color:var(--text); padding:12px 12px; font-size:15px; outline:0}
input::placeholder{color:#6f8092}
input:focus,select:focus{box-shadow:var(--focus); border-color:#3a4c63}
.btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}
.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width:520px){ .pillars{grid-template-columns:repeat(2,1fr)} }
.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width:420px){ .bazi-table th,.bazi-table td{padding:8px 10px} }
.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:80px 1fr 60px; gap:10px; align-items:center}
.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.muted{color:var(--muted)}
.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}
.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}
.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}
.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}   

    /* ===== Professional Report styles ===== */
.butler-section{
  border:1px solid #253245;
  background:var(--surface);
  border-radius:12px;
  padding:14px 14px;
  margin:12px 0;
}
.butler-section h4{
  margin:0 0 10px 0;
  color:var(--gold2);
  font-size:1.05rem;
}
.butler-section p{
  margin:8px 0;
  line-height:1.7;
}
.action-list{
  margin:8px 0 0 0;
  padding-left:1.2rem;
}
.action-list li{
  margin:8px 0;
  line-height:1.7;
}

    <section class="professionalReport">
              <!-- âœ… Professional Report (add this) -->
      <div class="card" id="butlerProfessional" style="display:none;">
        <div class="h2" data-i18n="pro.title">ğŸ§™â€â™‚ï¸ å¿ƒæ€œç®¡å®¶ Â· ä¸“ä¸šå‘½ç†åˆ†æ</div>
        <div id="professionalReport" class="analysis-content"></div>
      </div>
    </section>       

/* form focus simplification */
input:focus,select:focus,textarea:focus{outline:none!important; box-shadow:none!important; border-color:#243244!important}
button:focus,.btn:focus,a:focus{outline:none!important; box-shadow:none!important}
*{-webkit-tap-highlight-color:transparent}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !é‡è¦} }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å…«å­—ç°¡è©•</span>
    </a>
    <div style="display:flex; align-items:center; gap:10px;">
      <!-- Language selector -->
      <select id="langSelect" style="border-radius:999px; padding:6px 10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; font-size:0.85rem;">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>

      <span id="nowBox" class="now"></span>
    </div>
  </div>
</header>

  <main class="container">
    <!-- Input card -->
    <section class="card">
      <div class="h2">å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤</div>
      <div class="row cols-3">
        <div>
          <label class="muted">å§“åï¼ˆé¸å¡«ï¼‰</label>
          <input id="name" placeholder="ä½ çš„ç¨±å‘¼ï¼ˆç”¨æ–¼å€‹äººåŒ–ï¼‰" />
        </div>
        <div>
          <label class="muted">æ€§åˆ¥</label>
          <select id="gender">
            <option value="">ä¸é€éœ²</option>
            <option value="male">ç”·æ€§</option>
            <option value="female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted">æ›†æ³•</label>
          <select id="calendar">
            <option value="gregorian">é™½æ›†</option>
            <option value="lunar">è¾²æ›†ï¼ˆå°šæœªæ”¯æ´ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted">å‡ºç”Ÿæ™‚é–“</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span>å‡ºç”Ÿæ™‚é–“ä¸è©³</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText">ç”Ÿæˆå…«å­—</span>
            <span id="genBtnLoading" style="display:none">è¨ˆç®—ä¸­...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <!-- Result: pillars & elements -->
    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›¤</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <table class="bazi-table">
          <thead>
          <tr>
            <th></th>
            <th>å¹´æŸ±</th>
            <th>æœˆæŸ±</th>
            <th>æ—¥æŸ±</th>
            <th>æ™‚æŸ±</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>å¤©å¹²</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td>åœ°æ”¯</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td>äº”è¡Œ</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td>ç´éŸ³</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2">äº”è¡Œèƒ½é‡åˆ†æ</div>
        <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-wood"></i></div><span id="pct-wood">0%</span></div>
        <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-fire"></i></div><span id="pct-fire">0%</span></div>
        <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-earth"></i></div><span id="pct-earth">0%</span></div>
        <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-metal"></i></div><span id="pct-metal">0%</span></div>
        <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-water"></i></div><span id="pct-water">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- VIP segment -->
    <section class="card section">
      <h2 class="group-title">ğŸŒ™ VIP å€åŸŸ</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title">ğŸ— å‘½ç†ç©ºé–“ Â· å°ˆå±¬å…§å®¹</div>
          <ul>
            <li>æ„Ÿæƒ…ï¼šç·£åˆ†æ·±åº¦èˆ‡å©šå§»èµ°å‘</li>
            <li>äº‹æ¥­ï¼šè·æ¶¯ç™¼å±•èˆ‡å‰µæ¥­æ½›åŠ›</li>
            <li>è²¡å¯Œï¼šè²¡ä½ã€åè²¡èˆ‡é€²è²¡ç¯€å¥</li>
            <li>å¯µç‰©å‘½ç›¤ï¼šé™ªä¼´å‹•ç‰©çš„æ€§æ ¼èˆ‡èƒ½é‡</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title">ğŸŒ™ å¿ƒæ€œç©ºé–“ Â· éˆæ€§è¨˜éŒ„</div>
          <ul>
            <li>éˆæ€§ç­†è¨˜ï¼šç…§ç‰‡ã€å¤¢å¢ƒã€èªéŸ³èˆ‡ç¥ˆé¡˜æ–‡å­—</li>
            <li>èª²ç¨‹ï¼šå…«å­— / å¡”ç¾… / å æ˜Ÿ / éˆæ•¸</li>
            <li>å®¶æ—ç´€å¿µç³»çµ±ï¼šç‚ºè¦ªäººä¿ç•™ä¸€å€‹å°ˆå±¬ä½ç½®</li>
            <li>æ¯é€±èƒ½é‡ç·´ç¿’èˆ‡ç¥æ˜é¢¨æ ¼çš„å°ä»»å‹™</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px">ğŸ’ VIP ç™»å…¥</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head">å¸³è™Ÿç™»å…¥ / è¨»å†Š</div>
            <div class="body">
              <div class="row" id="authFields">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="é›»å­éƒµä»¶ Email">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 8 ç¢¼ï¼Œå«å¤§å°å¯«èˆ‡æ•¸å­—ç¬¦è™Ÿï¼‰">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit">ç™»å…¥</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button">ğŸ”‘ é‡è¨­å¯†ç¢¼</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit">å»ºç«‹æ–°å¸³è™Ÿ</button>
                <div class="muted">è¨»å†Šå¾Œå¯ç²å¾—ä¸€æ¬¡å…è²»è§£ç›¤é«”é©—ã€‚</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head">æœƒå“¡æœå‹™</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">
                  ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆä»˜ï¼‰
                </a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">
                  â† å›åˆ° Astro å•†åŸ
                </a>
              </div>
              <div class="muted">$9.9 / æœˆ Â· å‘½ç†ç©ºé–“ + å¿ƒæ€œç©ºé–“ + å…¨éƒ¨å¿ƒéˆèª²ç¨‹</div>
            </div>
          </div>
        </div>
      </section>
    </section>

<footer data-i18n="footer.copy">Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>

<!-- GPT / å¿ƒæ†ç®¡å®¶ï¼ˆçµ±ä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat.toggle">å•</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ†ç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å…§å®¹å€ï¼šä¿æŒç‚ºç©ºï¼Œè¨Šæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¼¸å…¥å€ -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¼¸å…¥å•é¡Œâ€¦"
      data-i18n-ph="chat.placeholder"
    />
    <button class="btn" id="chatSend" data-i18n="chat.send">ç™¼é€</button>
  </div>
</div>
<script src="/assets/bazi-language-pack/lang-switch.js"></script>
<!-- Main app -->
<script>
(() => {
  'use strict';
  const SG_TZ = 'Asia/Singapore';

  /* ========== HELPERS ========== */
  const $id = (id) => document.getElementById(id);
  const qs = (sel, root = document) => root.querySelector(sel);
  const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const show = (el) => { if (el) el.style.display = ""; };
  const hide = (el) => { if (el) el.style.display = "none"; };

  const escapeHTML = (str) =>
    String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

  const clampStr = (s, max = 1600) => {
    s = String(s ?? "");
    return s.length > max ? s.slice(0, max) + "â€¦" : s;
  };

  const isObj = (v) => v && typeof v === "object" && !Array.isArray(v);
  const deepGet = (obj, path) => {
    if (!obj || !path) return undefined;
    const parts = String(path).split(".");
    let cur = obj;
    for (const p of parts) {
      if (!cur) return undefined;
      cur = cur[p];
    }
    return cur;
  };

  /* ========== CONFIG ========== */
  const API_BASE = "https://throbbing-lab-1440.hello5xliving.workers.dev";
  const CHAT_ENDPOINT = "/api/chat";
  const LANG_KEY = "5x_lang"; // unify across pages
  const $ = $id; // alias so $('id') works everywhere

  const state = (window.state = window.state || {});
  state.lang = 'zh-TW';  // âœ… æ­¤é å›ºå®šç‚ºç¹é«”ä¸­æ–‡
  try { localStorage.setItem('5x_lang', 'zh-TW'); } catch {}

  /* ===== I18N core ===== */
  window.I18N = window.I18N || {};
  const I18N = window.I18N;
  window.ensure = (code, dict) => { I18N[code] = Object.assign({}, I18N[code] || {}, dict); };

  // Base pack (zh-TW)
  I18N['zh-TW'] = Object.assign({}, I18N['zh-TW'] || {}, {
    action:{
      weekly:'æ¯é€±',
      energy:'èƒ½é‡ç·´ç¿’',
      career:'è·æ¥­ç­–ç•¥ï¼šç©©æ­¥æ¨é€²ã€èšç„¦ç”¢å‡º',
      career2:'ç©©å®šè¼¸å‡ºèˆ‡å¾©ç›¤ï¼ˆæ‹†è§£ç›®æ¨™ â†’ é€±è¨ˆç•« â†’ å¾©ç›¤æ”¹é€²ï¼‰',
      relationship:'é—œä¿‚ç¶“ç‡Ÿï¼šçœŸèª æºé€šã€è¨­å®šç•Œé™ã€åŠæ™‚å›æ‡‰',
      wealth:'è²¡å¯Œï¼šé ç®—/ç¾é‡‘æµç®¡ç†ã€æŠ€èƒ½è®Šç¾ã€æ§é¢¨éšª'
    },
    brand:{ subtitle:'5xLiving Â· å…«å­—ç°¡è©•' },
    nav:{ langLabel:'èªè¨€' },
    lang:{ 'zh-CN':'ç°¡é«”ä¸­æ–‡','zh-TW':'ç¹é«”ä¸­æ–‡','en':'English','ja':'æ—¥æœ¬èª','th':'à¹„à¸—à¸¢','ms':'Bahasa Melayu' },
    app:{ title:'å…«å­—å‘½ç† Â· å¿«é€Ÿæ’ç›¤' },
    form:{ nameLabel:'å§“åï¼ˆå¯é¸ï¼‰', namePlaceholder:'ä½ çš„ç¨±å‘¼ï¼ˆç”¨æ–¼å€‹æ€§åŒ–ï¼‰', genderLabel:'æ€§åˆ¥',
      gender:{ hidden:'ä¸é€éœ²', male:'ç”·æ€§', female:'å¥³æ€§' },
      calendarLabel:'æ›†æ³•', calendar:{ gregorian:'é™½æ›†', lunar:'è¾²æ›†' },
      birthdateLabel:'å‡ºç”Ÿæ—¥æœŸ', birthtimeLabel:'å‡ºç”Ÿæ™‚é–“', timeUnknown:'å‡ºç”Ÿæ™‚é–“ä¸è©³'
    },
    btn:{ generate:'ç”Ÿæˆå…«å­—', loading:'è¨ˆç®—ä¸­...' },
    result:{ title:'æ‚¨çš„ç”Ÿè¾°å…«å­—å‘½ç›¤' },
    pillar:{ year:'å¹´æŸ±', month:'æœˆæŸ±', day:'æ—¥æŸ±', hour:'æ™‚æŸ±' },
    table:{ row:{ stem:'å¤©å¹²', branch:'åœ°æ”¯', fiveElem:'äº”è¡Œ', nayin:'ç´éŸ³' } },
    energy:{ title:'äº”è¡Œèƒ½é‡åˆ†æ' },
    elem:{ wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´', month:'æœˆ', fiveElements:'äº”è¡Œ' },
    pro:{ title:'ğŸ§™â€â™‚ï¸ å¿ƒæ†ç®¡å®¶ Â· å°ˆæ¥­å‘½ç†åˆ†æ', welcome:'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å°ˆæ¥­å‘½ç†é¡§å•ï¼Œå·²ç‚ºæ‚¨ç”Ÿæˆè©³ç´°åˆ†æå ±å‘Šã€‚æœ‰ä»€éº¼å…·é«”å•é¡Œå¯ä»¥éš¨æ™‚å•æˆ‘ã€‚' },
    chat:{ send:'ç™¼é€', placeholder:'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ...', toggle:'å•' },
    vip:{ title:'ğŸŒ™ æœƒå“¡å€åŸŸ VIP Segment',
      group:{ astrology:'ğŸ— å‘½ç†ç©ºé–“å°ˆå±¬å…§å®¹', spiritual:'ğŸŒ™ å¿ƒæ†ç©ºé–“å°ˆå±¬å…§å®¹' },
      astrology:{ match:'å§»ç·£æ–¹å‘ï¼šæˆ€æ„›ç·£åˆ†ã€å©šå§»èµ°å‹¢', career:'äº‹æ¥­æ–¹å‘ï¼šè·å ´ç™¼å±•ã€å‰µæ¥­æ½›åŠ›', wealth:'è²¡é‹æ–¹å‘ï¼šè²¡ä½åˆ†æã€ç†è²¡æ™‚æ©Ÿ', pet:'å¯µç‰©å‘½ç†ï¼šä¼´ä¾¶å‹•ç‰©çš„æ€§æ ¼èˆ‡ç·£åˆ†' },
      spiritual:{ record:'éˆæ€§è¨˜éŒ„ï¼šç…§ç‰‡ã€å¤¢å¢ƒã€è²éŸ³ã€é¡˜æœ›ç¥ˆç¦±', courses:'å‘½ç†èª²ç¨‹ï¼šå…«å­— / å¡”ç¾… / å æ˜Ÿ / éˆæ•¸', family:'å®¶æ—ç´€å¿µç³»çµ±ï¼šè¦ªäººéˆæ€§ç´€å¿µ & å»¶çºŒ', practice:'æ¯é€±èƒ½é‡ç·´ç¿’ / ç¥æ˜å„€å¼ä»»å‹™' },
      login:{ title:'ğŸ’ ç™»å…¥ VIP åŠŸèƒ½' }, services:{ header:'æœƒå“¡æœå‹™' }, upgrade:'ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆè²»ï¼‰', back:'â† è¿”å›å‘½ç†å•†åŸ',
      priceNote:'$9.9 / æœˆè²» VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ†ç©ºé–“ + éˆæ€§èª²ç¨‹ï¼‰'
    },
    auth:{ header:'å¸³æˆ¶ç™»å…¥ / è¨»å†Š', login:'ç™»å…¥å¸³æˆ¶', reset:'ğŸ”‘ é‡è¨­å¯†ç¢¼', register:'è¨»å†Šå¸³æˆ¶',
      freeTrialNote:'è¨»å†Šå¸³è™Ÿè´ˆé€ä¸€æ¬¡å…è²»é«”é©—', emailPlaceholder:'Emailï¼ˆé›»å­éƒµä»¶ï¼‰', passwordPlaceholder:'å¯†ç¢¼ Passwordï¼ˆè‡³å°‘ 8 ä½ï¼Œå«å¤§å°å¯«ã€æ•¸å­—ã€ç¬¦è™Ÿï¼‰'
    },
    footer:{ copy:'Â© 5XLiving â€¢ Astro Sanctuary' },
    err:{ fillBirthdate:'è«‹å¡«å¯«å‡ºç”Ÿæ—¥æœŸ', invalidDate:'ç„¡æ•ˆçš„æ—¥æœŸæ ¼å¼ï¼Œè«‹ç”¨ YYYY-MM-DD', generateFail:'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦' },
    ui:{ unknown:'æœªçŸ¥', timeUnknown:'æ™‚é–“ä¸è©³', hourSuffix:'{hh}:{mm}', birthSummary:'å‡ºç”Ÿæ—¥æœŸ: {y}å¹´{m}æœˆ{d}æ—¥ {timeText}', balance:'äº”è¡Œä¸­{strongest}æœ€å¼·ï¼Œ{weakest}æœ€å¼±ã€‚' },
    badge:{ noHour:'æœªç´å…¥æ™‚æŸ±' },
    report:{ hourUnknownTip:'âš ï¸ æç¤ºï¼šå› å‡ºç”Ÿæ™‚é–“ä¸è©³ï¼Œéƒ¨åˆ†åˆ†æåƒ…ä¾›åƒè€ƒã€‚', tipTitle:'æç¤º', generating:'æ­£åœ¨ç”Ÿæˆå°ˆæ¥­åˆ†æå ±å‘Š...', failed:'å ±å‘Šç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦' },
    reportTitles:{ overview:'ğŸ“Š å‘½ç›¤ç¸½è¦½', fiveElements:'ğŸŒ¿ äº”è¡Œåˆ†æ', tenGods:'âš¡ åç¥é…ç½®', useful:'ğŸ”‘ å–œç”¨ç¥', relationship:'ğŸ’• æ„Ÿæƒ…å©šå§»', career:'ğŸ’¼ äº‹æ¥­ç™¼å±•', wealth:'ğŸ’° è²¡é‹åˆ†æ', health:'ğŸŒ¡ï¸ å¥åº·é¤Šç”Ÿ', nearTerm:'ğŸ”® è¿‘æœŸé‹å‹¢', actions:'ğŸ“ è¡Œå‹•æ¸…å–®' },
    tenGodsNames:{ biJian:'æ¯”è‚©', jieCai:'åŠ«è²¡', shiShen:'é£Ÿç¥', shangGuan:'å‚·å®˜', zhengCai:'æ­£è²¡', pianCai:'åè²¡', zhengGuan:'æ­£å®˜', qiSha:'ä¸ƒæ®º', zhengYin:'æ­£å°', pianYin:'åå°' },
    tenGodsHints:{ biJian:'åŒé¡ä¹‹åŠ©èˆ‡ç«¶çˆ­ï¼Œåå‘è‡ªåŠ›èˆ‡ä¸¦è‚©ä¹‹äºº', jieCai:'åŒé¡åˆ†å¥ªè³‡æºï¼Œå®œåˆä½œå¿Œçˆ­æ¶', shiShen:'è¼¸å‡º/å‰µé€ /äº«å—ï¼Œåˆ©è¡¨é”èˆ‡ç”¢å‡º', shangGuan:'çªç ´/è¦å‰‡å¤–ä¹‹æ‰ï¼Œåˆ©å‰µæ–°ä½†å¿ŒçŠ¯ä¸Š', zhengCai:'æ­£æ¥­ä¹‹è²¡ï¼Œç©©å¥æ”¶å…¥ã€ç¾é‡‘æµ', pianCai:'åé–€ä¹‹è²¡ï¼Œæ©Ÿæœƒ/çŸ­æ‰“ï¼Œéœ€æ§é¢¨éšª', zhengGuan:'ç§©åºèˆ‡è¦å‰‡ï¼Œè·ä½èˆ‡åè­½', qiSha:'å£“åŠ›èˆ‡æŒ‘æˆ°ï¼ŒåŸ·è¡ŒåŠ›å¼·ï¼Œéœ€åˆ¶è¡¡', zhengYin:'æ­£çµ±è³‡æº/å­¸æ­·/é•·è¼©åŠ©åŠ›', pianYin:'éˆæ„Ÿ/åé–€è³‡æº/å­¸ç¿’åŠ›ï¼Œæ˜“æƒ³å¤š' },
    reportLabels:{ dayMaster:'æ—¥ä¸»å‘½ç†', strength:'æ—¥ä¸»å¼·å¼±', usefulSpirit:'å–œç”¨ç¥', elementCount:'äº”è¡Œå€‹æ•¸', elementStrength:'äº”è¡Œæ—ºè¡°', supportElements:'å¹«æ‰¶äº”è¡Œ', restrainElements:'å…‹æ´©äº”è¡Œ', missingElements:'äº”è¡Œæ‰€ç¼º', traits:'æ„Ÿæƒ…ç‰¹è³ª', marriageAdvice:'å©šå§»å»ºè­°', relationshipTips:'ç›¸è™•ä¹‹é“', suitableCareers:'é©åˆè¡Œæ¥­', careerAdvice:'ç™¼å±•å»ºè­°', favorableDirections:'æœ‰åˆ©æ–¹ä½', wealthCharacteristics:'è²¡é‹ç‰¹é»', wealthDirections:'æ±‚è²¡æ–¹å‘', financialAdvice:'ç†è²¡å»ºè­°', healthCharacteristics:'é«”è³ªç‰¹é»', healthTips:'æ³¨æ„äº‹é …', wellnessAdvice:'é¤Šç”Ÿå»ºè­°', overallFortune:'æ•´é«”é‹å‹¢', favorableTiming:'æœ‰åˆ©æ™‚æ©Ÿ', cautions:'æ³¨æ„äº‹é …', tenGods:'åç¥é…ç½®', symbolise:'è±¡å¾µå«ç¾©', analysis:'å°ç­–å»ºè­°' },
    wellness:{ default:'è¦å¾‹ä½œæ¯ã€é©é‡é‹å‹•ã€æƒ…ç·’ç©©å®šã€å°‘ç†¬å¤œ' },
    cautions:{ default:'é¿é–‹æƒ…ç·’æ±ºç­–ï¼Œæ§åˆ¶æ”¯å‡º' },
    fortune:{ steady:'å¹³ç©©èª¿æ•´æœŸ', upward:'å‹¢é ­å‘ä¸Šï¼Œåˆ©æ¨å»£/è¡¨é”', focus:'æ”¶æ–‚èšç„¦ï¼Œåˆ©åˆ¶åº¦èˆ‡åŸ·è¡Œ', study:'å­¸ç¿’èª¿ç ”æœŸï¼Œå…ˆè“„å¾Œç™¼', foundation:'æ‰“åŸºç¤ã€ç©©ç¯€å¥ç‚ºä¸»' },
    wealth:{ stable:'ä»¥ç©©å®šæ”¶å…¥ç‚ºä¸»ï¼Œé©åˆç´¯ç©å¼ç†è²¡', opportunity:'åè²¡æ©Ÿæœƒå¤šï¼Œæ³¨æ„ç¯€åˆ¶é¢¨éšª', steady:'è²¡é‹å¹³ç©©ï¼Œé‡åœ¨æŠ€èƒ½èˆ‡å£ç¢‘å¸¶å‹•æ”¶å…¥' },
    'report.dayMaster.jia':'ç”²æœ¨å‘½ï¼šæœ‰ç©æ¥µæ€§çš„é–‹æ‹“ç²¾ç¥ï¼Œç²¾åŠ›æ—ºç››', 'report.dayMaster.yi':'ä¹™æœ¨å‘½ï¼šæ€§æ ¼æŸ”é †ï¼Œå–œè¡Œå–„äº‹ï¼Œæœ‰åŒæƒ…å¿ƒ',
    'report.dayMaster.bing':'ä¸™ç«å‘½ï¼šç†±æƒ…è±ªçˆ½ï¼Œè‡ªä¿¡å¥½å‹ï¼Œå–„è¨€å¥è«‡', 'report.dayMaster.ding':'ä¸ç«å‘½ï¼šæ•¦åšæ¨¸å¯¦ï¼Œé‡ä¿¡å®ˆç¾©',
    'report.dayMaster.wu':'æˆŠåœŸå‘½ï¼šæœ‰ç©æ¥µæ€§ï¼Œåšä¸€è¡Œæ˜“å°äº‹ç‰©ç†±è¡·', 'report.dayMaster.ji':'å·±åœŸå‘½ï¼šå’Œç·©ï¼Œè¬¹æ…ï¼Œå¿ƒéˆæ‰‹å·§',
    'report.dayMaster.geng':'åºšé‡‘å‘½ï¼šç©æ¥µé€²å–ï¼Œå‹‡æ•¢æœæ±º', 'report.dayMaster.xin':'è¾›é‡‘å‘½ï¼šæ²‰è‘—å¦ç›´ç„¡ç§ï¼Œå¾…äººæ¥ç‰©èªçœŸ',
    'report.dayMaster.ren':'å£¬æ°´å‘½ï¼šå¿ƒèƒ¸å¯¬å»£ï¼Œæ©Ÿæ™ºéˆæ•ï¼Œå–œæ­¡è‡ªç”±ï¼Œè¨å­æŸç¸›', 'report.dayMaster.gui':'ç™¸æ°´å‘½ï¼šé€å¼·é ‘å›ºï¼Œæ˜¯åŠªåŠ›å®¶',
    'report.marriage.stable':'å©šå§»è¼ƒç‚ºç©©å®šï¼Œé©åˆå»ºç«‹é•·æœŸé—œä¿‚', 'report.marriage.experienced':'æ„Ÿæƒ…ç¶“æ­·å¯èƒ½è¼ƒå¤šï¼Œéœ€è¦æ‰¾åˆ°çœŸæ­£é©åˆçš„ä¼´ä¾¶', 'report.marriage.default':'å©šå§»éœ€è¦é›™æ–¹å…±åŒåŠªåŠ›ç¶“ç‡Ÿ',
    'report.career.leadership':'é©åˆç®¡ç†å´—ä½æˆ–è‡ªä¸»å‰µæ¥­ï¼Œæœ‰é ˜å°æ½›åŠ›', 'report.career.business':'é©åˆå•†æ¥­ã€é‡‘èé ˜åŸŸï¼Œè²¡é‹è¼ƒå¥½', 'report.career.creative':'é©åˆå‰µæ„ã€è—è¡“ã€æŠ€è¡“é¡å·¥ä½œ', 'report.career.steady':'ç©©ç´®ç©©æ‰“ï¼Œåœ¨å°ˆæ¥­é ˜åŸŸæ·±è€•ç™¼å±•',
    'report.health.tips.jia':'å®šæœŸæª¢æŸ¥è‚åŠŸèƒ½ï¼Œä¿è­·è¦–åŠ›','report.health.tips.yi':'æ³¨æ„æƒ…ç·’èª¿ç¯€ï¼Œé¿å…çœ¼éƒ¨ç–²å‹','report.health.tips.bing':'æ§åˆ¶æƒ…ç·’ï¼Œé¿å…ç†¬å¤œ','report.health.tips.ding':'ä¿è­‰å……è¶³ç¡çœ ï¼Œé¿å…éåº¦ç·Šå¼µ','report.health.tips.wu':'è¦å¾‹é£²é£Ÿï¼Œé¿å…æš´é£²æš´é£Ÿ','report.health.tips.ji':'æ³¨æ„é£²é£Ÿè¡›ç”Ÿï¼Œé¿å…æ½®æ¿•ç’°å¢ƒ','report.health.tips.geng':'æ³¨æ„ä¿æš–ï¼Œé¿å…ä¹¾ç‡¥ç’°å¢ƒ','report.health.tips.xin':'ä¿æŒç©ºæ°£æµé€šï¼Œé¿å…ç…™å¡µ','report.health.tips.ren':'ä¿æŒæ°´åˆ†å¹³è¡¡ï¼Œé¿å…å—æ¶¼ï¼Œæ³¨æ„è…è‡Ÿä¿é¤Š','report.health.tips.gui':'é©é‡é£²æ°´ï¼Œé¿å…éåº¦å‹ç´¯'
  });

  function t(path, lang = (window.state && window.state.lang) || 'zh-TW') {
    const pack = (window.I18N && window.I18N[lang]) || {};
    const baseTW = (window.I18N && window.I18N['zh-TW']) || {};
    const baseCN = (window.I18N && window.I18N['zh-CN']) || {};

    // 1ï¸âƒ£ å…ˆå˜—è©¦ã€Œæ‰å¹³ keyã€
    let v = pack[path];
    if (v != null && v !== '') return v;

    // 2ï¸âƒ£ å†å˜—è©¦åµŒå¥—å°è±¡
    v = deepGet(pack, path);
    if (v != null && v !== '') return v;

    // 3ï¸âƒ£ zh-TW æ‰å¹³ key
    v = baseTW[path];
    if (v != null && v !== '') return v;

    // 4ï¸âƒ£ zh-TW åµŒå¥—å°è±¡
    v = deepGet(baseTW, path);
    if (v != null && v !== '') return v;

    // 5ï¸âƒ£ æœ€å¾Œæ‰å›è½åˆ° zh-CNï¼ˆå¦‚æœä½ åŒé ä¹Ÿè¼‰å…¥äº†ï¼‰
    v = baseCN[path];
    if (v != null && v !== '') return v;

    v = deepGet(baseCN, path);
    if (v != null && v !== '') return v;

    const defaultMessages = {
      'reportLabels.symbolise': 'è±¡å¾µå«ç¾©',
      'reportLabels.analysis': 'å°ç­–å»ºè­°',
      'reportLabels.tenGods': 'åç¥é…ç½®',
      'reportLabels.dayMaster': 'æ—¥ä¸»å‘½ç†',
      'reportLabels.elementCount': 'äº”è¡Œå€‹æ•¸',
      'reportLabels.missingElements': 'äº”è¡Œæ‰€ç¼º',
      'reportLabels.suitableCareers': 'é©åˆè¡Œæ¥­',
      'reportLabels.careerAdvice': 'ç™¼å±•å»ºè­°',
      'reportLabels.favorableDirections': 'æœ‰åˆ©æ–¹ä½',
      'reportLabels.healthCharacteristics': 'é«”è³ªç‰¹é»',
      'reportLabels.healthTips': 'æ³¨æ„äº‹é …',
      'reportLabels.wellnessAdvice': 'é¤Šç”Ÿå»ºè­°',
      'reportLabels.overallFortune': 'æ•´é«”é‹å‹¢',
      'reportLabels.favorableTiming': 'æœ‰åˆ©æ™‚æ©Ÿ',
      'reportLabels.cautions': 'æ³¨æ„äº‹é …',
      'report.dayMaster.jia': 'ç”²æœ¨å‘½ï¼šæœ‰ç©æ¥µæ€§çš„é–‹æ‹“ç²¾ç¥ï¼Œç²¾åŠ›æ—ºç››',
      'report.career.steady': 'ç©©ç´®ç©©æ‰“ï¼Œåœ¨å°ˆæ¥­é ˜åŸŸæ·±è€•ç™¼å±•',
      'report.marriage.experienced': 'æ„Ÿæƒ…ç¶“æ­·å¯èƒ½è¼ƒå¤šï¼Œéœ€è¦æ‰¾åˆ°çœŸæ­£é©åˆçš„ä¼´ä¾¶',
      'wealth.steady': 'è²¡é‹å¹³ç©©ï¼Œé‡åœ¨æŠ€èƒ½èˆ‡å£ç¢‘å¸¶å‹•æ”¶å…¥',
    };

    return defaultMessages[path] || '';
  }
  window.t = t;

  function applyI18n(){
    const lang = state.lang || 'zh-TW';
    document.documentElement.lang = lang;

    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string' && val !== '') el.textContent = val;
    });
    document.querySelectorAll('option[data-i18n]').forEach(opt=>{
      const key = opt.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string' && val !== '') opt.textContent = val;
    });
    const setPh = (id, value) => { const el=$(id); if (el && typeof value === 'string' && value) el.placeholder = value; };
    setPh('name', t('form.namePlaceholder'));
    setPh('chatInput', t('chat.placeholder'));

    if (window.lastCtx && typeof window.buildProReport === 'function') window.buildProReport(window.lastCtx);
  }
  window.applyI18n = applyI18n;

  /* ===== Bazi calculator ===== */
  class BaziCalculator {
    constructor(){
      this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
      this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
      // âœ… ç´éŸ³æ”¹ç¹é«”
      this.NAYIN=[
        'æµ·ä¸­é‡‘','çˆä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','åŠé‹’é‡‘','å±±é ­ç«','æ¾—ä¸‹æ°´','åŸé ­åœŸ','ç™½è Ÿé‡‘','æ¥ŠæŸ³æœ¨',
        'æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é‚ç«','æ¾æŸæœ¨','é•·æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘',
        'ä½›ç‡ˆç«','å¤©æ²³æ°´','å¤§é©›åœŸ','é‡µé‡§é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'
      ];
    }
    yearPillar(year){ const s=(year-4)%10, b=(year-4)%12; return {stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]}; }
    solarMonthIndex(y,m,d){ const mmdd=m*100+d;
      const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
      let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
      const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
      return {index:idx, branch:branchBy[idx]};
    }
    monthPillar(year,month,day){
      const {index,branch}=this.solarMonthIndex(year,month,day);
      const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
      const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIdx=(startMap[yStemIdx]+(index-1))%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch};
    }
    dayPillar(year,month,day){
      const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
      const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
      const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
      return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
    }
    hourPillar(dayStem,hour){
      const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
      const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex=Math.floor((hour+1)/2)%12;
      const stemIdx=(startMap[dayIdx]+hourIndex)%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
    }
    stemElem(s){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[s]||'-'; }
    branchElem(b){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[b]||'-'; }
    nayin(s,b){ const si=this.HEAVENLY_STEMS.indexOf(s), bi=this.EARTHLY_BRANCHES.indexOf(b); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
    tenGods(dayStem, stems){
      const map={
        'ç”²':{'ç”²':'æ¯”è‚©','ä¹™':'åŠ«è²¡','ä¸™':'é£Ÿç¥','ä¸':'å‚·å®˜','æˆŠ':'åè²¡','å·±':'æ­£è²¡','åºš':'ä¸ƒæ®º','è¾›':'æ­£å®˜','å£¬':'åå°','ç™¸':'æ­£å°'},
        'ä¹™':{'ç”²':'åŠ«è²¡','ä¹™':'æ¯”è‚©','ä¸™':'å‚·å®˜','ä¸':'é£Ÿç¥','æˆŠ':'æ­£è²¡','å·±':'åè²¡','åºš':'æ­£å®˜','è¾›':'ä¸ƒæ®º','å£¬':'æ­£å°','ç™¸':'åå°'},
        'ä¸™':{'ç”²':'åå°','ä¹™':'æ­£å°','ä¸™':'æ¯”è‚©','ä¸':'åŠ«è²¡','æˆŠ':'é£Ÿç¥','å·±':'å‚·å®˜','åºš':'åè²¡','è¾›':'æ­£è²¡','å£¬':'ä¸ƒæ®º','ç™¸':'æ­£å®˜'},
        'ä¸':{'ç”²':'æ­£å°','ä¹™':'åå°','ä¸™':'åŠ«è²¡','ä¸':'æ¯”è‚©','æˆŠ':'å‚·å®˜','å·±':'é£Ÿç¥','åºš':'æ­£è²¡','è¾›':'åè²¡','å£¬':'æ­£å®˜','ç™¸':'ä¸ƒæ®º'},
        'æˆŠ':{'ç”²':'ä¸ƒæ®º','ä¹™':'æ­£å®˜','ä¸™':'åå°','ä¸':'æ­£å°','æˆŠ':'æ¯”è‚©','å·±':'åŠ«è²¡','åºš':'é£Ÿç¥','è¾›':'å‚·å®˜','å£¬':'åè²¡','ç™¸':'æ­£è²¡'},
        'å·±':{'ç”²':'æ­£å®˜','ä¹™':'ä¸ƒæ®º','ä¸™':'æ­£å°','ä¸':'åå°','æˆŠ':'åŠ«è²¡','å·±':'æ¯”è‚©','åºš':'å‚·å®˜','è¾›':'é£Ÿç¥','å£¬':'æ­£è²¡','ç™¸':'åè²¡'},
        'åºš':{'ç”²':'åè²¡','ä¹™':'æ­£è²¡','ä¸™':'ä¸ƒæ®º','ä¸':'æ­£å®˜','æˆŠ':'åå°','å·±':'æ­£å°','åºš':'æ¯”è‚©','è¾›':'åŠ«è²¡','å£¬':'é£Ÿç¥','ç™¸':'å‚·å®˜'},
        'è¾›':{'ç”²':'æ­£è²¡','ä¹™':'åè²¡','ä¸™':'æ­£å®˜','ä¸':'ä¸ƒæ®º','æˆŠ':'æ­£å°','å·±':'åå°','åºš':'åŠ«è²¡','è¾›':'æ¯”è‚©','å£¬':'å‚·å®˜','ç™¸':'é£Ÿç¥'},
        'å£¬':{'ç”²':'é£Ÿç¥','ä¹™':'å‚·å®˜','ä¸™':'åè²¡','ä¸':'æ­£è²¡','æˆŠ':'ä¸ƒæ®º','å·±':'æ­£å®˜','åºš':'åå°','è¾›':'æ­£å°','å£¬':'æ¯”è‚©','ç™¸':'åŠ«è²¡'},
        'ç™¸':{'ç”²':'å‚·å®˜','ä¹™':'é£Ÿç¥','ä¸™':'æ­£è²¡','ä¸':'åè²¡','æˆŠ':'æ­£å®˜','å·±':'ä¸ƒæ®º','åºš':'æ­£å°','è¾›':'åå°','å£¬':'åŠ«è²¡','ç™¸':'æ¯”è‚©'}
      };
      const m=map[dayStem]||{}; return stems.map(s=>m[s]||'-');
    }
  }

  /* ===== Analysis helpers ===== */
  function stemToPinyin(stem){
    const map = {'ç”²':'jia','ä¹™':'yi','ä¸™':'bing','ä¸':'ding','æˆŠ':'wu','å·±':'ji','åºš':'geng','è¾›':'xin','å£¬':'ren','ç™¸':'gui'};
    return map[stem] || String(stem).toLowerCase();
  }
  const controlChain = { 'æœ¨':'åœŸ', 'åœŸ':'æ°´', 'æ°´':'ç«', 'ç«':'é‡‘', 'é‡‘':'æœ¨' };
  const motherOf     = { 'æœ¨':'æ°´', 'ç«':'æœ¨', 'åœŸ':'ç«', 'é‡‘':'åœŸ', 'æ°´':'é‡‘' };

  const BaziAnalysis = {
    dayMasterLine(stem){ return t('report.dayMaster.'+stemToPinyin(stem)) || ''; },
    relation(dayStem){
      const dict={
        'ç”²':{traits:'æ„Ÿæƒ…è¼ƒç‚ºä¸»å‹•ï¼Œå–œæ­¡æŒæ¡ä¸»å°æ¬Šï¼Œä½†è¦æ³¨æ„çµ¦å°æ–¹ç©ºé–“',tips:'å­¸æœƒå‚¾è½å°æ–¹æ„è¦‹ï¼Œä¿æŒæºé€šå¹³è¡¡'},
        'ä¹™':{traits:'æ„Ÿæƒ…ç´°è†©æº«æŸ”ï¼Œéœ€è¦ç©©å®šçš„æƒ…æ„Ÿæ”¯æŒï¼Œä½†ä¸è¦éåº¦ä¾è³´å°æ–¹',tips:'å»ºç«‹è‡ªä¿¡ï¼Œæ˜ç¢ºè¡¨é”è‡ªå·±çš„éœ€æ±‚'},
        'ä¸™':{traits:'æ„Ÿæƒ…ç†±æƒ…å¥”æ”¾ï¼Œä½†å®¹æ˜“è¡å‹•ï¼Œè¦æ§åˆ¶æƒ…ç·’æ³¢å‹•',tips:'æ§åˆ¶æƒ…ç·’æ³¢å‹•ï¼Œé¿å…è¡å‹•è¨€è¡Œ'},
        'ä¸':{traits:'æ„Ÿæƒ…å°ˆä¸€åŸ·è‘—ï¼Œä½†å®¹æ˜“çŒœç–‘ï¼Œè¦é¿å…éåº¦çŒœç–‘',tips:'ä¿¡ä»»ä¼´ä¾¶ï¼Œæ¸›å°‘ä¸å¿…è¦çš„çŒœç–‘'},
        'æˆŠ':{traits:'æ„Ÿæƒ…ç©©é‡å‹™å¯¦ï¼Œé‡è¦–å®¶åº­ç©©å®šï¼Œä½†è¦å­¸æœƒè¡¨é”æƒ…æ„Ÿ',tips:'å­¸æœƒæµªæ¼«è¡¨é”ï¼Œå¢åŠ æƒ…æ„Ÿäº¤æµ'},
        'å·±':{traits:'æ„Ÿæƒ…ç´°è†©é«”è²¼ï¼Œä½†å®¹æ˜“ç¼ºä¹å®‰å…¨æ„Ÿï¼Œè¦å»ºç«‹è‡ªä¿¡å¿ƒ',tips:'åŸ¹é¤Šå®‰å…¨æ„Ÿï¼Œä¸è¦éåº¦ä¾è³´'},
        'åºš':{traits:'æ„Ÿæƒ…æœæ–·ç›´æ¥ï¼Œä¸å–œæ­¡æ‹–æ³¥å¸¶æ°´ï¼Œä½†è¦è€ƒæ…®å°æ–¹æ„Ÿå—',tips:'è€ƒæ…®å°æ–¹æ„Ÿå—ï¼Œé©ç•¶æ”¾æ…¢ç¯€å¥'},
        'è¾›':{traits:'æ„Ÿæƒ…è¿½æ±‚å®Œç¾ï¼Œå°ä¼´ä¾¶è¦æ±‚è¼ƒé«˜ï¼Œä½†è¦æ¥å—å°æ–¹ç¼ºé»',tips:'æ¥å—ä¸å®Œç¾ï¼Œé™ä½å°ä¼´ä¾¶çš„è¦æ±‚'},
        'å£¬':{traits:'æ„Ÿæƒ…è±å¯Œå¤šè®Šï¼Œéœ€è¦æ–°é®®æ„Ÿï¼Œä½†è¦ä¿æŒæ„Ÿæƒ…ç©©å®š',tips:'ä¿æŒæ„Ÿæƒ…ç©©å®šï¼ŒåŸ¹é¤Šå…±åŒèˆˆè¶£'},
        'ç™¸':{traits:'æ„Ÿæƒ…ç´°è†©æ•æ„Ÿï¼Œå®¹æ˜“æƒ…ç·’åŒ–ï¼Œä½†è¦å­¸æœƒæƒ…ç·’ç®¡ç†',tips:'å­¸æœƒæƒ…ç·’ç®¡ç†ï¼Œç†æ€§è™•ç†çŸ›ç›¾'}
      };
      return dict[dayStem]||{traits:'æ„Ÿæƒ…é‹å‹¢å¹³ç©©ï¼Œéœ€è¦ç”¨å¿ƒç¶“ç‡Ÿ',tips:'ç›¸äº’å°Šé‡ï¼ŒçœŸèª æºé€šæ˜¯é—œéµ'};
    },
    marriageAdvice(ten){
      if(ten.includes('æ­£å®˜')||ten.includes('æ­£è²¡')) return t('report.marriage.stable');
      if(ten.includes('ä¸ƒæ®º')||ten.includes('åè²¡')) return t('report.marriage.experienced');
      return t('report.marriage.default');
    },
    career(dayStem,ten){
      const map={ç”²:'ç®¡ç†å´—ä½ã€å‰µæ¥­é–‹æ‹“ã€å»ºç¯‰å·¥ç¨‹',ä¹™:'æ•™è‚²æ–‡åŒ–ã€å‰µæ„è¨­è¨ˆã€è«®è©¢é¡§å•',ä¸™:'å¸‚å ´è¡ŒéŠ·ã€å¨›æ¨‚ç”¢æ¥­ã€èƒ½æºè¡Œæ¥­',ä¸:'æŠ€è¡“ç ”ç™¼ã€é†«ç™‚æœå‹™ã€ç²¾å¯†è£½é€ ',æˆŠ:'é‡‘èæŠ•è³‡ã€æˆ¿åœ°ç”¢ã€è³‡æºç®¡ç†',å·±:'äººåŠ›è³‡æºã€æœå‹™è¡Œæ¥­ã€è¾²æ¥­ç›¸é—œ',åºš:'æ³•å¾‹è¡Œæ¥­ã€æ©Ÿæ¢°å·¥ç¨‹ã€è»è­¦è·æ¥­',è¾›:'é‡‘èåˆ†æã€ç²¾å¯†å„€å™¨ã€ç å¯¶è¡Œæ¥­',å£¬:'è²¿æ˜“ç‰©æµã€æ—…éŠè¡Œæ¥­ã€å‰µæ„ç”¢æ¥­',ç™¸:'ç ”ç©¶æ©Ÿæ§‹ã€å¿ƒç†è«®è©¢ã€è—è¡“å‰µä½œ'};
      let adv=t('report.career.steady');
      if(ten.includes('æ­£å®˜')||ten.includes('ä¸ƒæ®º')) adv=t('report.career.leadership');
      else if(ten.includes('æ­£è²¡')||ten.includes('åè²¡')) adv=t('report.career.business');
      else if(ten.includes('é£Ÿç¥')||ten.includes('å‚·å®˜')) adv=t('report.career.creative');
      return {suitable:map[dayStem]||t('report.career.steady'), advice:adv};
    },
    wealthDirs(dayStem){
      const dirs={ç”²:'æ±æ–¹ã€æ±å—æ–¹',ä¹™:'æ±æ–¹ã€å—æ–¹',ä¸™:'å—æ–¹',ä¸:'å—æ–¹ã€è¥¿å—æ–¹',æˆŠ:'ä¸­éƒ¨ã€æœ¬åœ°',å·±:'ä¸­éƒ¨ã€è¥¿å—æ–¹',åºš:'è¥¿æ–¹ã€è¥¿åŒ—æ–¹',è¾›:'è¥¿æ–¹ã€åŒ—æ–¹',å£¬:'åŒ—æ–¹',ç™¸:'åŒ—æ–¹ã€æ±æ–¹'};
      return dirs[dayStem]||'-';
    },
    health(dayStem){
      const c={ç”²:'è‚è†½ã€è¦–åŠ›ã€ç­‹éª¨',ä¹™:'è‚è‡ŸåŠŸèƒ½èˆ‡æƒ…ç·’èª¿ç¯€',ä¸™:'å¿ƒè¡€ç®¡èˆ‡çœ¼ç›ï¼Œæ³¨æ„æƒ…ç·’',ä¸:'å¿ƒè‡Ÿèˆ‡å¾ªç’°ï¼Œä¿è­‰ç¡çœ ',æˆŠ:'è„¾èƒƒæ¶ˆåŒ–ï¼Œè¦å¾‹é£²é£Ÿ',å·±:'è„¾èƒƒèˆ‡çš®è†šï¼Œæ³¨æ„è¡›ç”Ÿ',åºš:'å‘¼å¸ç³»çµ±èˆ‡å¤§è…¸ï¼Œé¿å…ä¹¾ç‡¥',è¾›:'è‚ºéƒ¨èˆ‡å‘¼å¸ï¼Œä¿æŒé€šé¢¨',å£¬:'è…è‡Ÿæ³Œå°¿ï¼Œæ°´åˆ†å¹³è¡¡',ç™¸:'è…èˆ‡è†€èƒ±ï¼Œé¿å…éå‹'};
      return c[dayStem]||'é«”è³ªè¼ƒç‚ºå¹³è¡¡ï¼Œæ³¨æ„ä½œæ¯';
    }
  };

  // AI integration (single definition + breaker) â€”â€” unchanged
  (function () {
    const LS_DOWN = 'ai:insight:downUntil';
    const now = () => Date.now();
    const downUntil = () => { try { return parseInt(localStorage.getItem(LS_DOWN)||'0',10)||0; } catch { return 0; } };
    const markDown = (ms = 180000) => { try { localStorage.setItem(LS_DOWN, String(now()+ms)); } catch {} };
    const clearDown = () => { try { localStorage.removeItem(LS_DOWN); } catch {} };

    async function fetchJSON(url, init={}, timeoutMs=15000){
      const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {...init, signal: ctrl.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function _aiExplain(section, ctx, {lang, temperature=0.7, seed=null}={}){
      if (!window.API_BASE) return null;
      const json = await fetchJSON(`${String(window.API_BASE).replace(/\/$/,'')}/bazi/insight`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ section, lang, temperature, seed, ctx })
      });
      if (json && (json.symbolise || json.analysis)) return json;
      return null;
    }

    window.aiExplain = async function (section, ctx, opts) {
      if (now() < downUntil()) return null;
      try {
        const out = await _aiExplain(section, ctx, opts||{});
        if (out) { clearDown(); return out; }
        markDown(); return null;
      } catch {
        markDown(); return null;
      }
    };

    window.injectAI = async function (section, symId, anaId, ctx, opts) {
      try {
        const out = await window.aiExplain(section, ctx, opts);
        if (!out) return;
        const $sym = document.getElementById(symId);
        const $ana = document.getElementById(anaId);
        if ($sym && out.symbolise) $sym.textContent = `${t('reportLabels.symbolise')}ï¼š${out.symbolise}`;
        if ($ana && out.analysis)  $ana.textContent = `${t('reportLabels.analysis')}ï¼š${out.analysis}`;
      } catch {}
    };

    window.forceAiInsightRetry = function () { try { localStorage.removeItem(LS_DOWN); } catch {} };
  })();

  /* ===== Renderers ===== */
  function renderPillars(labels){
    const titles=[t('pillar.year'),t('pillar.month'),t('pillar.day'),t('pillar.hour')];
    const box = $('bazi-pillars'); if(!box) return;
    box.innerHTML = labels.map((lab,i)=>`
      <div class="pillar"><div class="tit">${titles[i]}</div><div class="gz">${lab||'-'}</div></div>
    `).join('');
  }
  function renderTable(data){
    const keys=['year','month','day','hour'];
    const translateElem = (val)=>{
      const map = { 'æœ¨': t('elem.wood'), 'ç«': t('elem.fire'),'åœŸ': t('elem.earth'),'é‡‘': t('elem.metal'),'æ°´': t('elem.water') };
      return map[val] || val;
    };
    ['stem','branch','element','nayin'].forEach(row=>{
      keys.forEach((k, i)=>{
        const cell = $(k+'-'+row); if (!cell) return;
        let v = (Array.isArray(data[row]) ? data[row][i] : '-') ?? '-';
        if (row === 'element') v = translateElem(v);
        cell.textContent = v;
      });
    });
  }
  function renderBars(pcts){
    ['æœ¨','ç«','åœŸ','é‡‘','æ°´'].forEach(e=>{
      const pct=Math.max(0,Math.min(100,Math.round(pcts[e]||0)));
      const bar=$('bar-'+e), lab=$('pct-'+e);
      if(bar) bar.style.width=pct+'%';
      if(lab) lab.textContent=pct+'%';
    });
    const entries=Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
    if(entries.length){
      const strongest = entries[0][0], weakest = entries.at(-1)[0];
      const mapName = {æœ¨:t('elem.wood'),ç«:t('elem.fire'),åœŸ:t('elem.earth'),é‡‘:t('elem.metal'),æ°´:t('elem.water')};
      const tpl = (t('ui.balance') || '{strongest} æœ€æ—ºï¼Œ{weakest} åå¼±ã€‚');
      const txt = tpl.replace('{strongest}', mapName[strongest]).replace('{weakest}', mapName[weakest]);
      const el=$('bazi-elements-balance'); if(el) el.textContent=txt;
    }
  }

  /* ===== Pro Report ===== */
  function i18nDirs(s){
    if(!s) return '';
    const L = state.lang;
    const maps = {
      'zh-TW': {'æ±æ–¹':'æ±æ–¹','æ±å—æ–¹':'æ±å—æ–¹','å—æ–¹':'å—æ–¹','è¥¿å—æ–¹':'è¥¿å—æ–¹','è¥¿æ–¹':'è¥¿æ–¹','è¥¿åŒ—æ–¹':'è¥¿åŒ—æ–¹','åŒ—æ–¹':'åŒ—æ–¹','æ±åŒ—æ–¹':'æ±åŒ—æ–¹','ä¸­éƒ¨ã€æœ¬åœ°':'ä¸­éƒ¨/æœ¬åœ°'},
      'zh-CN': {'æ±æ–¹':'ä¸œæ–¹','æ±å—æ–¹':'ä¸œå—æ–¹','å—æ–¹':'å—æ–¹','è¥¿å—æ–¹':'è¥¿å—æ–¹','è¥¿æ–¹':'è¥¿æ–¹','è¥¿åŒ—æ–¹':'è¥¿åŒ—æ–¹','åŒ—æ–¹':'åŒ—æ–¹','æ±åŒ—æ–¹':'ä¸œåŒ—æ–¹','ä¸­éƒ¨ã€æœ¬åœ°':'ä¸­éƒ¨/æœ¬åœ°'},
      'en':    {'æ±æ–¹':'East','æ±å—æ–¹':'Southeast','å—æ–¹':'South','è¥¿å—æ–¹':'Southwest','è¥¿æ–¹':'West','è¥¿åŒ—æ–¹':'Northwest','åŒ—æ–¹':'North','æ±åŒ—æ–¹':'Northeast','ä¸­éƒ¨ã€æœ¬åœ°':'Center / Local'}
    };
    const map = maps[L] || maps['en'];
    return Object.keys(map).reduce((acc,k)=> acc.replaceAll(k, map[k]), s);
  }

  const TG_KEY = {
    'æ¯”è‚©':'tenGodsNames.biJian','åŠ«è²¡':'tenGodsNames.jieCai','é£Ÿç¥':'tenGodsNames.shiShen','å‚·å®˜':'tenGodsNames.shangGuan',
    'æ­£è²¡':'tenGodsNames.zhengCai','åè²¡':'tenGodsNames.pianCai','æ­£å®˜':'tenGodsNames.zhengGuan','ä¸ƒæ®º':'tenGodsNames.qiSha',
    'æ­£å°':'tenGodsNames.zhengYin','åå°':'tenGodsNames.pianYin'
  };
  function tenGodTipKey(cn){ const base = TG_KEY[cn]?.replace('tenGodsNames','tenGodsHints'); return base||''; }
  function tenGodsAdviceList(arr){
    const m = {
      'æ¯”è‚©':'Self-reliant; avoid stubbornness.','åŠ«è²¡':'Shares resources; curb impulse spends.','é£Ÿç¥':'Creative output; keep rhythm & health.',
      'å‚·å®˜':'Expressive/critical; mind your tone.','æ­£è²¡':'Stable income focus; budget first.','åè²¡':'Opportunistic gains; set risk limits.',
      'æ­£å®˜':'Rules/structure; keep flexibility.','ä¸ƒæ®º':'Decisive drive; avoid recklessness.','æ­£å°':'Learning/support; avoid over-protection.','åå°':'Insightful/unique; donâ€™t over-detach.'
    };
    return arr.map(cn => t(tenGodTipKey(cn)) || m[cn] || String(cn));
  }

  function supportElems(dm){
    const map = { ç”²:['æ°´','æœ¨'], ä¹™:['æ°´','æœ¨'], ä¸™:['æœ¨','ç«'], ä¸:['æœ¨','ç«'], æˆŠ:['ç«','åœŸ'], å·±:['ç«','åœŸ'], åºš:['åœŸ','é‡‘'], è¾›:['åœŸ','é‡‘'], å£¬:['é‡‘','æ°´'], ç™¸:['é‡‘','æ°´'] };
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function restrainElems(dm){
    const map = { ç”²:['é‡‘'], ä¹™:['é‡‘'], ä¸™:['æ°´'], ä¸:['æ°´'], æˆŠ:['æœ¨'], å·±:['æœ¨'], åºš:['ç«'], è¾›:['ç«'], å£¬:['åœŸ'], ç™¸:['åœŸ'] };
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function computeUseful(p){ // 2 weakest
    const arr = Object.entries({æœ¨:p.æœ¨||0,ç«:p.ç«||0,åœŸ:p.åœŸ||0,é‡‘:p.é‡‘||0,æ°´:p.æ°´||0}).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k])=>k);
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return arr.map(key);
  }

  /* ===== Pro report builder (TW) Â· 10 sections ===== */
  window.buildProReport = function buildProReport(ctx){
    const box = $('professionalReport');
    if (!box || !ctx) return;

    const dm = ctx.dayStem || '';
    const pctsCN = ctx.pcts || {};
    const ten = Array.isArray(ctx.tenGods) ? ctx.tenGods.filter(Boolean) : [];

    const elem = {
      Wood:  pctsCN['æœ¨'] || 0,
      Fire:  pctsCN['ç«'] || 0,
      Earth: pctsCN['åœŸ'] || 0,
      Metal: pctsCN['é‡‘'] || 0,
      Water: pctsCN['æ°´'] || 0,
    };

    function strongestWeakest(obj){
      const arr = Object.entries(obj || {});
      if (!arr.length) return { strongest:'', weakest:'' };
      arr.sort((a,b)=> b[1] - a[1]);
      return { strongest: arr[0][0], weakest: arr[arr.length - 1][0] };
    }

    const { strongest, weakest } = strongestWeakest(elem);

    const ELEM_LABEL_TW = { Wood:'æœ¨', Fire:'ç«', Earth:'åœŸ', Metal:'é‡‘', Water:'æ°´' };
    const strongestLabel = ELEM_LABEL_TW[strongest] || strongest || '-';
    const weakestLabel   = ELEM_LABEL_TW[weakest]   || weakest   || '-';

    const dmLine   = BaziAnalysis.dayMasterLine(dm) || 'ä½ çš„æ—¥ä¸»å€‹æ€§æ•´é«”æ¯”è¼ƒå¹³è¡¡ï¼Œä¹Ÿå…·æœ‰ä¸éŒ¯çš„é©æ‡‰åŠ›ã€‚';
    const rel      = BaziAnalysis.relation(dm);
    const marriage = BaziAnalysis.marriageAdvice(ten);
    const career   = BaziAnalysis.career(dm, ten);
    const wealthDir= BaziAnalysis.wealthDirs(dm);
    const healthFo = BaziAnalysis.health(dm);

    const supportKeys  = supportElems(dm);
    const restrainKeys = restrainElems(dm);
    const usefulKeys   = computeUseful({ æœ¨:pctsCN['æœ¨']||0, ç«:pctsCN['ç«']||0, åœŸ:pctsCN['åœŸ']||0, é‡‘:pctsCN['é‡‘']||0, æ°´:pctsCN['æ°´']||0 });

    const supportText  = supportKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';
    const restrainText = restrainKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';
    const usefulText   = usefulKeys.map(k=>t(k)).filter(Boolean).join('ã€') || '-';

    const elemLine = `
      æœ¨ï¼š${Math.round(elem.Wood)}% Â·
      ç«ï¼š${Math.round(elem.Fire)}% Â·
      åœŸï¼š${Math.round(elem.Earth)}% Â·
      é‡‘ï¼š${Math.round(elem.Metal)}% Â·
      æ°´ï¼š${Math.round(elem.Water)}%
    `.replace(/\s+/g,' ');

    let nearTermFocus  = t('fortune.foundation') || 'æ‰“åŸºç¤ã€ç©©ç¯€å¥ç‚ºä¸»';
    let nearTermAdvice = t('cautions.default')   || 'é¿é–‹æƒ…ç·’æ±ºç­–ï¼Œæ§åˆ¶æ”¯å‡ºã€‚';

    switch (strongest) {
      case 'Wood':
        nearTermFocus  = t('fortune.upward') || 'å‹¢é ­å‘ä¸Šï¼Œåˆ©æ¨å»£/è¡¨é”';
        nearTermAdvice = 'é©åˆå­¸ç¿’æ–°æŠ€èƒ½ã€æ‹“å±•äººè„ˆï¼Œæ¯é€±ç©©å®šæ¨é€²ä¸€å€‹ä¸­æœŸå°ˆæ¡ˆã€‚';
        break;
      case 'Fire':
        nearTermFocus  = t('fortune.upward') || 'å‹¢é ­å‘ä¸Šï¼Œåˆ©æ¨å»£/è¡¨é”';
        nearTermAdvice = 'é«˜èƒ½é‡é©åˆæ›å…‰ã€è«‡åˆ¤ã€ä¸Šç·šæ–°è¨ˆç•«ï¼ŒåŒæ™‚é¿å…ä¸€æ™‚è¡å‹•ã€‚';
        break;
      case 'Earth':
        nearTermFocus  = t('fortune.focus') || 'æ”¶æ–‚èšç„¦ï¼Œåˆ©åˆ¶åº¦èˆ‡åŸ·è¡Œ';
        nearTermAdvice = 'æ•´ç†æ™‚é–“èˆ‡è²¡å‹™çµæ§‹ï¼ŒæŠŠç²¾åŠ›é›†ä¸­åœ¨æœ€æœ‰å›å ±çš„ 1â€“2 å€‹æ–¹å‘ã€‚';
        break;
      case 'Metal':
        nearTermFocus  = t('fortune.focus') || 'æ”¶æ–‚èšç„¦ï¼Œåˆ©åˆ¶åº¦èˆ‡åŸ·è¡Œ';
        nearTermAdvice = 'é©åˆåˆ¶å®šè¦å‰‡ã€æµç¨‹ã€åˆç´„èˆ‡å‚™æ´æ–¹æ¡ˆï¼Œç‚ºä¸‹ä¸€éšæ®µæ‰“å¥½åˆ¶åº¦åŸºç¤ã€‚';
        break;
      case 'Water':
        nearTermFocus  = t('fortune.study') || 'å­¸ç¿’èª¿ç ”æœŸï¼Œå…ˆè“„å¾Œç™¼';
        nearTermAdvice = 'å¤šè§€å¯Ÿã€å¤šæ¯”è¼ƒï¼Œå…ˆè©¦å°æ­¥å¯¦é©—ï¼Œå†æ±ºå®šçœŸæ­£è¦æŠ¼æ³¨çš„æ–¹å‘ã€‚';
        break;
    }

    const title = {
      overview:     t('reportTitles.overview')     || 'ğŸ“Š å‘½ç›¤ç¸½è¦½',
      fiveElements: t('reportTitles.fiveElements') || 'ğŸŒ¿ äº”è¡Œåˆ†æ',
      tenGods:      t('reportTitles.tenGods')      || 'âš¡ åç¥é…ç½®',
      useful:       t('reportTitles.useful')       || 'ğŸ”‘ å–œç”¨ç¥',
      relation:     t('reportTitles.relationship') || 'ğŸ’• æ„Ÿæƒ…å©šå§»',
      career:       t('reportTitles.career')       || 'ğŸ’¼ äº‹æ¥­ç™¼å±•',
      wealth:       t('reportTitles.wealth')       || 'ğŸ’° è²¡é‹åˆ†æ',
      health:       t('reportTitles.health')       || 'ğŸŒ¡ï¸ å¥åº·é¤Šç”Ÿ',
      nearTerm:     t('reportTitles.nearTerm')     || 'ğŸ”® è¿‘æœŸé‹å‹¢',
      actions:      t('reportTitles.actions')      || 'ğŸ“ è¡Œå‹•æ¸…å–®',
    };

    const parts = [];

    parts.push(`
      <div class="butler-section">
        <h4>1. ${title.overview}</h4>
        <p><strong>${t('reportLabels.dayMaster') || 'æ—¥ä¸»å‘½ç†'}ï¼š</strong> ${dm || '-'} æ—¥ä¸»</p>
        <p>${dmLine}</p>
        ${ctx.unknown ? `<p>${t('report.hourUnknownTip') || 'âš ï¸ æç¤ºï¼šå› å‡ºç”Ÿæ™‚é–“ä¸è©³ï¼Œéƒ¨åˆ†åˆ†æåƒ…ä¾›åƒè€ƒã€‚'}</p>` : ''}
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>2. ${title.fiveElements}</h4>
        <p>${elemLine}</p>
        <p>
          <strong>æœ€æ—ºäº”è¡Œï¼š</strong> ${strongestLabel} &nbsp;&nbsp;
          <strong>ç›¸å°è¼ƒå¼±ï¼š</strong> ${weakestLabel}
        </p>
        <p>
          æœ€å¼·çš„äº”è¡Œä»£è¡¨ä½ æœ€è‡ªç„¶ã€æœ€å®¹æ˜“ç™¼æ®çš„æ–¹å¼ï¼›
          æœ€å¼±çš„äº”è¡Œæ˜¯å¯ä»¥æ…¢æ…¢è£œå¼·çš„é•·æœŸæˆé•·å€åŸŸï¼Œä¸éœ€è¦æ€¥è‘—ä¸€æ¬¡åˆ°ä½ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>3. ${title.tenGods}</h4>
        <p>
          é€™ä»½å¿«é€Ÿå ±å‘Šæ²’æœ‰é€ä¸€åˆ—å‡ºæ¯å€‹åç¥çš„æŠ€è¡“ç´°ç¯€ï¼Œ
          ä½†æ•´é«”æ ¼å±€é¡¯ç¤ºï¼Œä½ åœ¨<strong>è‡ªæˆ‘è¡¨é”ã€è³‡æºé‹ç”¨èˆ‡å°ä»–äººè²¬ä»»æ„Ÿ</strong>ä¹‹é–“ï¼Œ
          éœ€è¦æ‰¾åˆ°å¹³è¡¡ï¼šæ—¢ä¸èƒ½å®Œå…¨å¿½ç•¥è‡ªå·±ï¼Œä¹Ÿä¸é©åˆé•·æœŸå§”å±ˆè‡ªå·±ã€‚
        </p>
        <p>
          ç•¶ä½ æ„Ÿè¦ºç‰¹åˆ¥ç´¯æˆ–è¢«æ¶ˆè€—æ™‚ï¼Œå¯ä»¥å•è‡ªå·±ï¼š
          ã€Œç¾åœ¨é€™ä»¶äº‹ï¼Œæ˜¯ç‚ºäº†èª°ï¼Ÿæˆ‘æœ‰æ²’æœ‰æŠŠè‡ªå·±çš„åº•ç·šè¬›æ¸…æ¥šï¼Ÿã€
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>4. ${title.useful}</h4>
        <p><strong>å¹«æ‰¶äº”è¡Œï¼š</strong> ${supportText}</p>
        <p><strong>éœ€è¦è¢«æ”¶æ–‚ï¼å¹³è¡¡çš„äº”è¡Œï¼š</strong> ${restrainText}</p>
        <p><strong>ç•¶å‰å¯å„ªå…ˆè£œå¼·çš„æ–¹å‘ï¼š</strong> ${usefulText || 'æ•´é«”è¼ƒç‚ºå¹³å‡ï¼Œå¯ä¾ç”Ÿæ´»ç›®æ¨™éˆæ´»èª¿æ•´ã€‚'}</p>
        <p>
          ä½ å¯ä»¥é€éé¡è‰²ã€ç’°å¢ƒä½ˆç½®ã€å·¥ä½œå…§å®¹èˆ‡ç›¸è™•å°è±¡ï¼Œ
          æœ‰æ„è­˜åœ°å¼·åŒ–å–œç”¨çš„äº”è¡Œï¼Œä¾‹å¦‚ï¼š
          é¸æ“‡å°æ‡‰äº”è¡Œçš„é¡è‰²ã€æ–¹ä½èˆ‡æ´»å‹•ç¯€å¥ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>5. ${title.relation}</h4>
        <p><strong>æ„Ÿæƒ…é¢¨æ ¼ï¼š</strong> ${rel.traits}</p>
        <p><strong>é—œä¿‚å»ºè­°ï¼š</strong> ${rel.tips}</p>
        <p><strong>å©šå§»æç¤ºï¼š</strong> ${marriage}</p>
        <p>
          æ„Ÿæƒ…å°ä½ ä¾†èªªï¼Œä¸åªæ˜¯æµªæ¼«ï¼Œæ›´æ˜¯é•·æœŸçš„ã€Œåˆä½œé—œä¿‚ã€ï¼š
          åœ¨ç©©å®šçš„ç”Ÿæ´»ç¯€å¥ã€æ¸…æ¥šçš„é‚Šç•Œèˆ‡èª å¯¦æºé€šä¸‹ï¼Œé—œä¿‚æœƒé †å¾—å¤šã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>6. ${title.career}</h4>
        <p><strong>é©åˆé ˜åŸŸï¼š</strong> ${career.suitable}</p>
        <p><strong>è·æ¶¯å»ºè­°ï¼š</strong> ${career.advice}</p>
        <p>
          å°¤å…¶é©åˆä»¥<strong>ã€Œé•·æœŸæ·±è€• + å°ˆæ¥­å£ç¢‘ã€</strong>çš„æ–¹å¼å‰é€²ï¼Œ
          è®“åˆ¥äººä¸€æƒ³åˆ°æŸå€‹ä¸»é¡Œï¼Œå°±æœƒè‡ªç„¶è¯æƒ³åˆ°ä½ ï¼Œè€Œä¸æ˜¯åªé ä¸€å…©æ¬¡çŸ­æš«çš„æ©Ÿæœƒã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>7. ${title.wealth}</h4>
        <p><strong>æ±‚è²¡æ–¹å‘ï¼ˆæ–¹ä½åƒè€ƒï¼‰ï¼š</strong> ${wealthDir || '-'}</p>
        <p>
          è²¡é‹çš„é—œéµä¸åªæ˜¯ã€Œæœ‰æ²’æœ‰æ©Ÿæœƒã€ï¼Œè€Œæ˜¯ä½ å°ç¾é‡‘æµå’Œé¢¨éšªçš„æ•æ„Ÿåº¦ï¼š
          å»ºè­°å…ˆç©©ä½ä¸»è¦æ”¶å…¥ï¼Œå†ç‚ºé«˜é¢¨éšªå°ˆæ¡ˆè¨­å®šã€Œæå¤±ä¸Šé™ã€ã€‚
        </p>
        <p>
          å°ä½ ä¾†èªªï¼Œæœ€å¯æŒçºŒçš„è²¡å¯Œæ¨¡å¼ï¼Œæ˜¯ç”¨å°ˆæ¥­èˆ‡ä¿¡ä»»ç´¯ç©æ”¶å…¥ï¼Œ
          å†æ…¢æ…¢ç™¼å±•èˆ‡ä½ å€‹æ€§ç›¸ç¬¦çš„å‰¯æ¥­æˆ–é¡å¤–æ”¶å…¥ä¾†æºã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>8. ${title.health}</h4>
        <p><strong>èº«é«”é—œæ³¨é‡é»ï¼š</strong> ${healthFo}</p>
        <p>
          é¤Šç”Ÿä¸è¦è¤‡é›œï¼Œä¸€é–‹å§‹åªè¦åšåˆ°ï¼šè¦å¾‹ç¡çœ ã€ç°¡å–®é‹å‹•ã€é£²é£Ÿä¸éåº¦ï¼Œ
          å†åŠ ä¸Šä¸€ç¨®å¯ä»¥æŒçºŒçš„æƒ…ç·’å®£æ´©æ–¹å¼ï¼ˆå¯«æ—¥è¨˜ã€æ•£æ­¥ã€å†¥æƒ³ã€ç¥ˆç¦±ç­‰ï¼‰ï¼Œ
          å°ä½ æ•´é«”çš„èƒ½é‡éƒ½æœƒæœ‰å¾ˆå¤§å¹«åŠ©ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>9. ${title.nearTerm}</h4>
        <p><strong>è¿‘æœŸä¸»è»¸ï¼š</strong> ${nearTermFocus}</p>
        <p><strong>å»ºè­°ï¼š</strong> ${nearTermAdvice}</p>
        <p>
          ç•¶ä½ è¦ºå¾—æ–¹å‘æ··äº‚æˆ–å£“åŠ›è®Šå¤§æ™‚ï¼Œå¯ä»¥å…ˆæš«åœæ–°è¨ˆç•«ï¼Œ
          æŠŠç¾æœ‰äº‹æƒ…åˆ†ç´šï¼šå¿…è¦çš„å…ˆåšï¼Œæ¬¡è¦çš„å…ˆæ”¾ï¼Œ
          ç•™ä¸€é»ç©ºé–“çµ¦è‡ªå·±èª¿æ•´ç¯€å¥ï¼Œé‹å‹¢æœƒæ¯”è¼ƒé †æµã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>10. ${title.actions}</h4>
        <ul class="action-list">
          <li>åœ¨ 30 å¤©å…§ï¼Œåªé¸ä¸€å€‹æœ€é‡è¦çš„ç›®æ¨™ï¼ˆå·¥ä½œ / éŒ¢ / å¥åº·ï¼‰ï¼Œå¯«æ¸…æ¥šä¸¦è²¼åœ¨çœ‹å¾—åˆ°çš„åœ°æ–¹ã€‚</li>
          <li>æ¯é€±å›ºå®šé¸ä¸€å€‹æ™‚é–“é»ï¼Œæª¢æŸ¥è‡ªå·±åœ¨é€™å€‹ç›®æ¨™ä¸Šçš„å¯¦éš›é€²åº¦ï¼Œè€Œä¸æ˜¯åªçœ‹å¿ƒæƒ…ã€‚</li>
          <li>æœ‰æ„è­˜åœ°æ”¾å¤§ä½ æœ€å¼·çš„äº”è¡Œï¼ˆ${strongestLabel}ï¼‰ï¼Œç”¨é¡è‰²ã€ç’°å¢ƒå’Œäººéš›åœˆä¾†æ”¯æŒå®ƒã€‚</li>
          <li>é‡å°æœ€å¼±çš„äº”è¡Œï¼ˆ${weakestLabel}ï¼‰ï¼Œè¨­è¨ˆ 1â€“2 å€‹å¯ä»¥æ¯å¤©æˆ–æ¯é€±åšåˆ°çš„å°ç¿’æ…£ï¼Œä¸æ€¥è‘—æ±‚å¿«ï¼Œåªæ±‚ç©©å®šã€‚</li>
        </ul>
      </div>
    `);

    box.innerHTML = parts.join('\n');

    const sec = $('butlerProfessional');
    if (sec) sec.style.display = 'block';
  };

  /* ===== Gen + UI ===== */
  function showErr(msg){ const box=$('error'); if(!box) return; box.textContent=msg||t('err.generateFail'); box.style.display='block'; setTimeout(()=>{ box.style.display='none'; }, 4000); }
  function setGenLoading(v){ const btn=$('genBtn'), txt=$('genBtnText'), ld=$('genBtnLoading'); if(btn) btn.disabled=!!v; if(txt) txt.style.display=v?'none':'inline'; if(ld) ld.style.display=v?'inline':'none'; }

  function generate(){
    const birth = ($('birthdate')?.value||'').trim();
    if(!birth) return showErr(t('err.fillBirthdate'));
    if(!/^\d{4}-\d{2}-\d{2}$/.test(birth)) return showErr(t('err.invalidDate'));
    const [Y,M,D]=birth.split('-').map(n=>parseInt(n,10));
    const unknown = $('timeUnknown')?.checked;
    const timeVal = $('birthtime')?.value || '00:00';
    const hh = parseInt((timeVal.split(':')[0]||'0'),10) || 0;

    setGenLoading(true);
    try{
      const calc = new BaziCalculator();
      const y = calc.yearPillar(Y);
      const m = calc.monthPillar(Y,M,D);
      const d = calc.dayPillar(Y,M,D);
      const h = unknown ? {stem:'-',branch:'-'} : calc.hourPillar(d.stem, hh);

      renderPillars([y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, unknown ? (t('badge.noHour')||'-') : (h.stem+h.branch)]);

      const stems=[y.stem,m.stem,d.stem, unknown? '-' : h.stem];
      const branch=[y.branch,m.branch,d.branch, unknown? '-' : h.branch];
      const rawElems=[calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem), unknown? '-' : calc.stemElem(h.stem)];
      const nayin=[calc.nayin(y.stem,y.branch),calc.nayin(m.stem,m.branch),calc.nayin(d.stem,d.branch), unknown? '-' : calc.nayin(h.stem,h.branch)];
      renderTable({stem:stems,branch:branch,element:rawElems,nayin});

      const allElems = [calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem)]
        .concat(unknown?[]:[calc.stemElem(h.stem)])
        .concat([calc.branchElem(y.branch),calc.branchElem(m.branch),calc.branchElem(d.branch)])
        .concat(unknown?[]:[calc.branchElem(h.branch)]);
      const counts = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0}; allElems.forEach(e=>{ if(counts[e]!=null) counts[e]++; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
      const pcts = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, 100*v/total]));
      renderBars(pcts);

      const timeText = unknown ? (t('ui.timeUnknown')||'') :
        (t('ui.hourSuffix')||'{hh}:{mm}').replace('{hh}', String(hh).padStart(2,'0')).replace('{mm}', String(parseInt((timeVal.split(':')[1]||'0'),10)||0).padStart(2,'0'));
      const btxt = (t('ui.birthSummary')||'').replace('{y}',Y).replace('{m}',M).replace('{d}',D).replace('{timeText}', timeText);
      const bd=$('bazi-date'); if (bd) bd.textContent = btxt;

      const tg = calc.tenGods(d.stem, stems);
      const ctx = { pcts, dayStem: d.stem, tenGods: tg, unknown };
      window.lastCtx = ctx;

      $('result').style.display='block';
    }catch(e){ console.error(e); showErr(t('err.generateFail')); }
    finally{ setGenLoading(false); }
  }

  function onLangSelect(e){
    const lang = (e.target?.value) || 'zh-TW';
    try { localStorage.setItem('5x_lang', lang); } catch {}

    const LANG_PAGES = {
      'zh-TW': '/assets/bazi-language-pack/bazi-zh-TW.html', // âœ… æœ¬é ï¼ˆç¹é«”ï¼‰
      'zh-CN': '/bazi.html',
      'en':    '/assets/bazi-language-pack/bazi-en.html',
      'ja':    '/assets/bazi-language-pack/bazi-ja.html',
      'th':    '/assets/bazi-language-pack/bazi-th.html',
      'ms':    '/assets/bazi-language-pack/bazi-ms.html'
    };

    const target = LANG_PAGES[lang] || LANG_PAGES['zh-TW'];
    if (!target) return;

    if (!window.location.pathname.endsWith(target)) {
      window.location.href = target;
    }
  }

  function tickNow(){
    const box = $('nowBox'); if (!box) return;
    const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
    const loc = localeMap[state.lang || 'zh-TW'] || 'zh-TW';
    const fmt = new Intl.DateTimeFormat(loc, { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, timeZone: SG_TZ });
    box.textContent = fmt.format(new Date()) + ' (SGT)';
  }
  window.tickNow = tickNow;

  /* ===== Floating GPT Chat (ONLY this one) ===== */
  function initChat(){
    const fab   = $('ssChatFab');
    const panel = $('chatPanel');
    const close = $('chatClose');
    const body  = $('chatBody');
    const input = $('chatInput');
    const send  = $('chatSend');

    if (!fab || !panel || !close || !body || !input || !send) {
      console.warn('[chat] missing elements');
      return;
    }

    let chatHistory = [];

    const open = () => { panel.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(), 50); };
    const shut = () => { panel.setAttribute('aria-hidden','true'); };
    const toggle = () => {
      const hidden = panel.getAttribute('aria-hidden') !== 'false';
      hidden ? open() : shut();
    };

    fab.addEventListener('click', toggle);
    close.addEventListener('click', shut);

    function pushMsg(text, who='bot'){
      const div = document.createElement('div');
      div.className = who === 'me' ? 'ss-msg me' : 'ss-msg';
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
    }

    if (!initChat._welcomed){
      initChat._welcomed = true;
      pushMsg(t('pro.welcome') || 'ä½ å¥½ï¼Œæˆ‘æ˜¯å¿ƒæ†ç®¡å®¶ Â· GPTã€‚ä½ å¯ä»¥ç›´æ¥å•å…«å­—ã€äº‹æ¥­ã€æ„Ÿæƒ…ã€è²¡é‹ç­‰å•é¡Œã€‚', 'bot');
    }

    function buildBaziChatContext(){
      const ctx = window.lastCtx || null;
      const name = ($('name')?.value || '').trim();
      const gender = ($('gender')?.value || '').trim();
      const birth = ($('birthdate')?.value || '').trim();
      const timeUnknown = !!$('timeUnknown')?.checked;
      const birthtime = ($('birthtime')?.value || '').trim();

      return { name, gender, birthdate: birth, birthtime: timeUnknown ? '' : birthtime, timeUnknown, chart: ctx };
    }

    function extractReply(json){
      if (!json) return '';
      return (
        json.reply ||
        json.answer ||
        json.content ||
        json.message ||
        json.text ||
        (json.data && (json.data.reply || json.data.content || json.data.text)) ||
        ''
      );
    }

    async function callChatAPI(userText){
      const lang = (window.state && window.state.lang) || 'zh-TW';
      const ctx = buildBaziChatContext();

      if (!chatHistory.length){
        chatHistory.push({
          role: 'system',
          content:
`ä½ æ˜¯ã€Œå¿ƒæ†ç®¡å®¶ Â· GPTã€ï¼Œè² è²¬è§£è®€å…«å­—èˆ‡çµ¦å‡ºå¯åŸ·è¡Œå»ºè­°ã€‚
- èªè¨€ï¼š${lang}
- è‹¥ä½¿ç”¨è€…å°šæœªç”Ÿæˆå‘½ç›¤ï¼ˆchart ç‚ºç©ºï¼‰ï¼Œå…ˆæç¤ºä»–é»ã€Œç”Ÿæˆå…«å­—ã€å†å•ã€‚
- å›ç­”è¦å…·é«”ã€åˆ†é»ã€å¯è½åœ°ï¼›ä¸è¦è¼¸å‡ºç¨‹å¼ç¢¼ã€‚`
        });
      }

      chatHistory.push({ role:'user', content: userText });

      const url = String(API_BASE).replace(/\/$/,'') + CHAT_ENDPOINT;
      const payload = { lang, context: ctx, messages: chatHistory };

      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json().catch(()=>null);
      const reply = extractReply(json);

      if (reply) chatHistory.push({ role:'assistant', content: reply });
      return reply || 'ï¼ˆæ²’æœ‰æ‹¿åˆ°å›è¦†å…§å®¹ï¼Œæª¢æŸ¥ worker å›å‚³æ¬„ä½ï¼‰';
    }

    async function sendMsg(){
      const text = (input.value || '').trim();
      if (!text) return;

      input.value = '';
      pushMsg(text, 'me');
      pushMsg('â€¦', 'bot');
      const typingNode = body.lastElementChild;

      try{
        const reply = await callChatAPI(text);
        if (typingNode) typingNode.textContent = reply;
        else pushMsg(reply, 'bot');
      }catch(err){
        console.error('[chat] error', err);
        const msg = 'âš ï¸ GPT é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API_BASE / /api/chat æ˜¯å¦å¯ç”¨ã€‚';
        if (typingNode) typingNode.textContent = msg;
        else pushMsg(msg, 'bot');
      }
    }

    send.addEventListener('click', sendMsg);
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') sendMsg();
    });
  }

  function boot(){
    if (boot._didBoot) return; boot._didBoot = true;

    const langSel = $('langSelect');
    if (langSel) { langSel.value = state.lang; langSel.addEventListener('change', onLangSelect); }

    applyI18n();

    const unk = $('timeUnknown'), bt = $('birthtime');
    if (unk && bt){
      const sync = ()=>{ bt.disabled = !!unk.checked; bt.style.opacity = bt.disabled ? 0.5 : 1; };
      unk.addEventListener('change', sync); sync();
    }

    $('genBtn')?.addEventListener('click', generate);

    initChat();
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>

<!-- Clock + defaults keep-in-sync with language -->
<script>
(function(){
  function onLangSelect(e){
    const lang = (e.target?.value) || 'zh-CN';
    try { localStorage.setItem('5x_lang', lang); } catch {}

    const LANG_PAGES = {
      'zh-CN': 'bazi.html',
      'en':    'assets/bazi-language-pack/bazi-en.html',
      'zh-TW': 'assets/bazi-language-pack/bazi-zh-TW.html',
      'ja':    'assets/bazi-language-pack/bazi-ja.html',
      'th':    'assets/bazi-language-pack/bazi-th.html',
      'ms':    'assets/bazi-language-pack/bazi-ms.html'
    };

    const target = LANG_PAGES[lang] || LANG_PAGES['zh-CN'];
    const targetUrl = new URL(target, window.location.href);

    const curPath = window.location.pathname.replace(/\/+$/, '');
    const tgtPath = targetUrl.pathname.replace(/\/+$/, '');

    if (curPath !== tgtPath) window.location.href = targetUrl.href;
  }

  // expose for your existing boot() to use
  window.onLangSelect = onLangSelect;
})();
  
(function () {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Singapore';
  const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
  const getLocale = () => (localeMap[(window.state && window.state.lang) || 'zh-TW'] || 'zh-TW');

  window.applyI18n = (function(prev){
    return function(){
      if (typeof prev === 'function') prev();
      if (typeof window.tickNow === 'function') window.tickNow();
    };
  })(window.applyI18n);

  if (typeof window.tickNow !== 'function') {
    window.tickNow = function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const fmt = new Intl.DateTimeFormat(getLocale(), {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false, timeZone: TZ
      });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    };
  }

  function initBirthDefaults() {
    const bd = $('birthdate'); const bt = $('birthtime'); const unk = $('timeUnknown');
    const nowSG = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));

    if (bd && !bd.value){
      const y=nowSG.getFullYear(), m=String(nowSG.getMonth()+1).padStart(2,'0'), d=String(nowSG.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    if (bt){
      const hh=String(nowSG.getHours()).padStart(2,'0'), mm=String(nowSG.getMinutes()).padStart(2,'0');
      if (!bt.value) bt.value = `${hh}:${mm}`;
      const setUnknownState = ()=>{ const isUnknown = !!(unk && unk.checked); bt.disabled = isUnknown; if (isUnknown) bt.value = ''; };
      setUnknownState();
      if (unk && !unk._wired){
        unk._wired = true;
        unk.addEventListener('change', ()=>{
          if (unk.checked){
            bt.disabled = true; bt.value = '';
          } else {
            bt.disabled = false;
            if (!bt.value){
              const n = new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
              bt.value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
            }
          }
        });
      }
    }
  }

  initBirthDefaults();
  if (typeof window.tickNow === 'function') window.tickNow();
  if (!window._clock) window._clock = setInterval(()=>{ try{ window.tickNow(); }catch{} }, 60000);
})();
</script>
</body>
</html>

