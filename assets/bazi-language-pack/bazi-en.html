<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bazi ¬∑ Quick Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
/* ---- same visual style as CN version ---- */
:root{
  --bg:#0b0f14; --bg-accent:#0e1520; --card:#11161dcc; --surface:#0f1624; --line:#1f2a36;
  --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --radius-sm:10px; --radius-lg:18px; --shadow:0 8px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.28);
  --container:1100px; --gap:12px; --pad:18px; --focus:0 0 0 2px rgba(212,175,55,0.2);
  --bp-s:520px; --bp-m:760px; --bp-l:900px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
             linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}
.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}
.site-header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.8); border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:var(--shadow-sm); font-weight:800; color:#ffe084}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}
.now{font-size:.9rem; color:var(--muted)}

.section{margin-top:18px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:var(--pad); margin:16px 0}
.h2{font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084; display:flex; gap:8px; align-items:center}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}
.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} .row.cols-2{grid-template-columns:1fr 1fr} }
input,select{width:100%; border-radius:12px; border:1px solid #243244; background:var(--bg-accent); color:var(--text); padding:12px 12px; font-size:15px; outline:0}
input::placeholder{color:#6f8092}
input:focus,select:focus{box-shadow:var(--focus); border-color:#3a4c63}
.btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}
.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width:520px){ .pillars{grid-template-columns:repeat(2,1fr)} }
.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width:420px){ .bazi-table th,.bazi-table td{padding:8px 10px} }
.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:80px 1fr 60px; gap:10px; align-items:center}
.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.muted{color:var(--muted)}
.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}
.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}
.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}
.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

/* form focus simplification */
input:focus,select:focus,textarea:focus{outline:none!important; box-shadow:none!important; border-color:#243244!important}
button:focus,.btn:focus,a:focus{outline:none!important; box-shadow:none!important}
*{-webkit-tap-highlight-color:transparent}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important} }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving ¬∑ Bazi Brief</span>
    </a>
    <div style="display:flex; align-items:center; gap:10px;">
      <!-- Language selector -->
      <select id="langSelect" style="border-radius:999px; padding:6px 10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; font-size:0.85rem;">
        <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
        <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
        <option value="en">English</option>
        <option value="ja">Êó•Êú¨Ë™û</option>
        <option value="th">‡πÑ‡∏ó‡∏¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>

      <span id="nowBox" class="now"></span>
    </div>
  </div>
</header>

  <main class="container">
    <!-- Input card -->
    <section class="card">
      <div class="h2">Bazi ¬∑ Quick Chart</div>
      <div class="row cols-3">
        <div>
          <label class="muted">Name (optional)</label>
          <input id="name" placeholder="Your name (for personalization)" />
        </div>
        <div>
          <label class="muted">Gender</label>
          <select id="gender">
            <option value="">Prefer not to say</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div>
          <label class="muted">Calendar</label>
          <select id="calendar">
            <option value="gregorian">Gregorian</option>
            <option value="lunar">Lunar (not yet supported)</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted">Birth date</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted">Birth time</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span>Time unknown</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText">Generate Bazi</span>
            <span id="genBtnLoading" style="display:none">Calculating...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <!-- Result: pillars & elements -->
    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">Your Bazi Chart</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <table class="bazi-table">
          <thead>
          <tr>
            <th></th>
            <th>Year Pillar</th>
            <th>Month Pillar</th>
            <th>Day Pillar</th>
            <th>Hour Pillar</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Heavenly Stem</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td>Earthly Branch</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td>Five Elements</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td>Na Yin</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2">Five-Element Energy Analysis</div>
        <div class="bar-row"><span>Wood</span><div class="bar"><i id="bar-wood"></i></div><span id="pct-wood">0%</span></div>
        <div class="bar-row"><span>Fire</span><div class="bar"><i id="bar-fire"></i></div><span id="pct-fire">0%</span></div>
        <div class="bar-row"><span>Earth</span><div class="bar"><i id="bar-earth"></i></div><span id="pct-earth">0%</span></div>
        <div class="bar-row"><span>Metal</span><div class="bar"><i id="bar-metal"></i></div><span id="pct-metal">0%</span></div>
        <div class="bar-row"><span>Water</span><div class="bar"><i id="bar-water"></i></div><span id="pct-water">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- VIP segment -->
    <section class="card section">
      <h2 class="group-title">üåô VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title">üóù Mingli Space ¬∑ Exclusive</div>
          <ul>
            <li>Relationships: love affinity &amp; marriage trend</li>
            <li>Career: development &amp; entrepreneurship potential</li>
            <li>Wealth: wealth spot analysis &amp; timing</li>
            <li>Pet destiny: temperament &amp; affinity of companion animals</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title">üåô Xinlian Space ¬∑ Exclusive</div>
          <ul>
            <li>Spiritual records: photos, dreams, voice notes, prayers</li>
            <li>Courses: Bazi / Tarot / Astrology / Numerology</li>
            <li>Family memorial system: remembrance &amp; legacy</li>
            <li>Weekly energy practice &amp; deity-style ritual tasks</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px">üíé VIP Login</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head">Account Login / Register</div>
            <div class="body">
              <div class="row" id="authFields">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="Email">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="Password (‚â•8 chars, mixed case, numbers, symbols)">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit">Log in</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button">üîë Reset password</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit">Create account</button>
                <div class="muted">Sign up to receive one free reading trial.</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head">Member Services</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">
                  üíé Upgrade to VIP (monthly)
                </a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">
                  ‚Üê Back to Astro Store
                </a>
              </div>
              <div class="muted">$9.9 / month ¬∑ Mingli Space + Xinlian Space + spiritual courses</div>
            </div>
          </div>
        </div>
      </section>
    </section>

<footer data-i18n="footer.copy">¬© 5XLiving ‚Ä¢ Astro Sanctuary</footer>
</main>

<!-- GPT / Xinlian Butler (Unified Floating Chat) -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat.toggle">Ask</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      Xinlian Butler ¬∑ GPT
    </div>
    <div class="ss-close" id="chatClose">‚úï</div>
  </div>

  <!-- Chat body: keep empty; messages are appended by JS -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- Input area -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="Type your question‚Ä¶"
      data-i18n-ph="chat.placeholder"
    />
    <button class="btn" id="chatSend" data-i18n="chat.send">Send</button>
  </div>
</div>

<!-- Main app -->
<script>
(() => {
  'use strict';
  const SG_TZ = 'Asia/Singapore';

  /* ========== HELPERS ========== */
  const $id = (id) => document.getElementById(id);
  const qs = (sel, root = document) => root.querySelector(sel);
  const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  const show = (el) => { if (el) el.style.display = ""; };
  const hide = (el) => { if (el) el.style.display = "none"; };

  const escapeHTML = (str) =>
    String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");

  const clampStr = (s, max = 1600) => {
    s = String(s ?? "");
    return s.length > max ? s.slice(0, max) + "‚Ä¶" : s;
  };

  const isObj = (v) => v && typeof v === "object" && !Array.isArray(v);
  const deepGet = (obj, path) => {
    if (!obj || !path) return undefined;
    const parts = String(path).split(".");
    let cur = obj;
    for (const p of parts) {
      if (!cur) return undefined;
      cur = cur[p];
    }
    return cur;
  };

  /* ========== CONFIG ========== */
  const API_BASE = "https://throbbing-lab-1440.hello5xliving.workers.dev";
  const CHAT_ENDPOINT = "/api/chat";
  const LANG_KEY = "5x_lang"; // unify across pages
  const $ = $id; // alias so $('id') works everywhere

  const state = (window.state = window.state || {});
  state.lang = 'en';  // ‚úÖ This page is fixed to English
  try { localStorage.setItem(LANG_KEY, 'en'); } catch {}

  /* ===== I18N core ===== */
  window.I18N = window.I18N || {};
  const I18N = window.I18N;
  window.ensure = (code, dict) => { I18N[code] = Object.assign({}, I18N[code] || {}, dict); };

  // Base pack (EN)
  I18N['en'] = Object.assign({}, I18N['en'] || {}, {
    action:{
      weekly:'Weekly',
      energy:'Energy Practice',
      career:'Career strategy: steady progress, focused output',
      career2:'Consistent output & review (break goal ‚Üí weekly plan ‚Üí review & improve)',
      relationship:'Relationships: honest communication, boundaries, timely responses',
      wealth:'Wealth: budget/cashflow, monetize skills, manage risk'
    },
    brand:{ subtitle:'5xLiving ¬∑ BaZi Quick Reading' },
    nav:{ langLabel:'Language' },
    lang:{ 'zh-CN':'ÁÆÄ‰Ωì‰∏≠Êñá','zh-TW':'ÁπÅÈ´î‰∏≠Êñá','en':'English','ja':'Êó•Êú¨Ë™û','th':'‡πÑ‡∏ó‡∏¢','ms':'Bahasa Melayu' },

    app:{ title:'BaZi ¬∑ Quick Chart' },
    form:{
      nameLabel:'Name (optional)',
      namePlaceholder:'How should I address you? (for personalization)',
      genderLabel:'Gender',
      gender:{ hidden:'Prefer not to say', male:'Male', female:'Female' },
      calendarLabel:'Calendar',
      calendar:{ gregorian:'Gregorian (Solar)', lunar:'Lunar' },
      birthdateLabel:'Birth date',
      birthtimeLabel:'Birth time',
      timeUnknown:'Time unknown'
    },

    btn:{ generate:'Generate BaZi', loading:'Calculating‚Ä¶' },
    result:{ title:'Your BaZi (Four Pillars) Chart' },
    pillar:{ year:'Year Pillar', month:'Month Pillar', day:'Day Pillar', hour:'Hour Pillar' },
    table:{ row:{ stem:'Heavenly Stem', branch:'Earthly Branch', fiveElem:'Element', nayin:'NaYin' } },
    energy:{ title:'Five Elements Energy' },
    elem:{ wood:'Wood', fire:'Fire', earth:'Earth', metal:'Metal', water:'Water', month:'Month', fiveElements:'Five Elements' },

    // used by your HTML: data-i18n="chat_title"
    chat_title:'Xinlian Butler ¬∑ GPT',

    pro:{
      title:'Xinlian Butler ¬∑ Professional Reading',
      welcome:'Hi! I‚Äôm Xinlian Butler ¬∑ GPT. Generate your chart first, then ask about career, relationships, wealth, health, etc.'
    },
    chat:{ send:'Send', placeholder:'Type your question‚Ä¶', toggle:'Ask' },

    vip:{
      title:'VIP Area',
      group:{ astrology:'BaZi Space', spiritual:'Soul Sanctuary' },
      astrology:{
        match:'Love & Marriage: relationship outlook',
        career:'Career: job growth & entrepreneurship',
        wealth:'Wealth: money direction & timing',
        pet:'Pet Reading: personality & bond'
      },
      spiritual:{
        record:'Spiritual journal: photos, dreams, audio, prayers',
        courses:'Courses: BaZi / Tarot / Astrology / Numerology',
        family:'Family memorial system',
        practice:'Weekly practices / ritual tasks'
      },
      login:{ title:'VIP Login' },
      services:{ header:'Member Services' },
      upgrade:'Upgrade to VIP (Monthly)',
      back:'‚Üê Back to Store',
      priceNote:'$9.9 / month VIP (BaZi Space + Soul Sanctuary + Courses)'
    },

    auth:{
      header:'Login / Register',
      login:'Login',
      reset:'Reset password',
      register:'Register',
      freeTrialNote:'Register to get 1 free trial',
      emailPlaceholder:'Email',
      passwordPlaceholder:'Password (min 8 chars, include upper/lower/number/symbol)'
    },

    footer:{ copy:'¬© 5XLiving ‚Ä¢ Astro Sanctuary' },

    err:{
      fillBirthdate:'Please enter your birth date',
      invalidDate:'Invalid format. Use YYYY-MM-DD',
      generateFail:'Failed to generate. Please try again.'
    },

    ui:{
      unknown:'Unknown',
      timeUnknown:'Time unknown',
      hourSuffix:'{hh}:{mm}',
      birthSummary:'Birth: {y}-{m}-{d} {timeText}',
      balance:'Strongest: {strongest}. Weakest: {weakest}.'
    },

    badge:{ noHour:'Hour pillar omitted' },

    report:{
      hourUnknownTip:'Note: Because the birth time is unknown, parts of the analysis are for reference only.',
      tipTitle:'Tip',
      generating:'Generating your professional report‚Ä¶',
      failed:'Report generation failed. Please try again.'
    },

    reportTitles:{
      overview:'Chart Overview',
      fiveElements:'Five Elements',
      tenGods:'Ten Gods',
      useful:'Favorable Elements',
      relationship:'Love & Relationships',
      career:'Career',
      wealth:'Wealth',
      health:'Health',
      nearTerm:'Near-term Outlook',
      actions:'Action Checklist'
    },

    tenGodsNames:{
      biJian:'Peer (Bi Jian)',
      jieCai:'Rob Wealth (Jie Cai)',
      shiShen:'Eating God (Shi Shen)',
      shangGuan:'Hurting Officer (Shang Guan)',
      zhengCai:'Direct Wealth (Zheng Cai)',
      pianCai:'Indirect Wealth (Pian Cai)',
      zhengGuan:'Direct Officer (Zheng Guan)',
      qiSha:'Seven Killings (Qi Sha)',
      zhengYin:'Direct Resource (Zheng Yin)',
      pianYin:'Indirect Resource (Pian Yin)'
    },
    tenGodsHints:{
      biJian:'Peers, self-reliance, competition/cooperation.',
      jieCai:'Resource sharing/competition; watch impulsive spending.',
      shiShen:'Output/creativity/enjoyment; good for expression.',
      shangGuan:'Breakthrough & critique; innovate but mind authority.',
      zhengCai:'Stable income & cashflow; steady accumulation.',
      pianCai:'Opportunities/side income; set risk limits.',
      zhengGuan:'Rules, structure, position & reputation.',
      qiSha:'Pressure/challenges; strong execution, needs balance.',
      zhengYin:'Support, learning, mentors; steady resources.',
      pianYin:'Insight & unusual learning; avoid overthinking.'
    },

    reportLabels:{
      dayMaster:'Day Master',
      strength:'Strength',
      usefulSpirit:'Favorable Elements',
      elementCount:'Element Count',
      elementStrength:'Element Strength',
      supportElements:'Support Elements',
      restrainElements:'Balancing Elements',
      missingElements:'Missing Elements',
      traits:'Relationship Traits',
      marriageAdvice:'Marriage Advice',
      relationshipTips:'How to Get Along',
      suitableCareers:'Suitable Fields',
      careerAdvice:'Career Advice',
      favorableDirections:'Favorable Directions',
      wealthCharacteristics:'Wealth Style',
      wealthDirections:'Money Direction',
      financialAdvice:'Financial Advice',
      healthCharacteristics:'Body Focus',
      healthTips:'Health Tips',
      wellnessAdvice:'Wellness',
      overallFortune:'Overall Outlook',
      favorableTiming:'Favorable Timing',
      cautions:'Cautions',
      tenGods:'Ten Gods',
      symbolise:'Meaning',
      analysis:'Advice'
    },

    wellness:{ default:'Sleep regularly, move moderately, keep emotions stable, avoid late nights.' },
    cautions:{ default:'Avoid emotional decisions; control spending.' },

    fortune:{
      steady:'A period of steady adjustment',
      upward:'Momentum rising; good for exposure/output',
      focus:'Focus & structure; good for execution',
      study:'Study/research first; build then launch',
      foundation:'Build foundations; keep a steady rhythm'
    },

    wealth:{
      stable:'Mainly stable income; good for accumulation-style planning',
      opportunity:'More opportunity gains; control risk and impulses',
      steady:'Steady wealth; rely on skills & reputation to grow income'
    },

    // Day Master text
    'report.dayMaster.jia':'Jia Wood: proactive pioneer spirit; energetic and resilient.',
    'report.dayMaster.yi':'Yi Wood: gentle, flexible, compassionate; grows through consistency.',
    'report.dayMaster.bing':'Bing Fire: warm, confident, expressive; thrives when you take the lead.',
    'report.dayMaster.ding':'Ding Fire: refined and steady; values trust and meaningful connections.',
    'report.dayMaster.wu':'Wu Earth: pragmatic and grounded; strong at building stable foundations.',
    'report.dayMaster.ji':'Ji Earth: careful and supportive; good at planning and fine execution.',
    'report.dayMaster.geng':'Geng Metal: bold and decisive; strong willpower and action focus.',
    'report.dayMaster.xin':'Xin Metal: precise and principled; values quality and standards.',
    'report.dayMaster.ren':'Ren Water: broad-minded and adaptable; quick thinking, freedom-loving.',
    'report.dayMaster.gui':'Gui Water: sensitive and persistent; strong inner drive, can overthink.',

    // Marriage/Career/Health preset lines
    'report.marriage.stable':'Relationships tend to be stable; suitable for building long-term commitment.',
    'report.marriage.experienced':'You may have more relationship experiences; choose a truly compatible partner.',
    'report.marriage.default':'Marriage/long-term relationships require mutual effort and communication.',

    'report.career.leadership':'Good for leadership roles or entrepreneurship; build structure and reputation.',
    'report.career.business':'Good for business/finance; focus on cashflow and discipline.',
    'report.career.creative':'Good for creative/tech output; build portfolio and consistent delivery.',
    'report.career.steady':'Step by step‚Äîdeepen expertise and grow through professional reputation.',

    'report.health.tips.jia':'Check liver health regularly; protect eyesight.',
    'report.health.tips.yi':'Manage emotions; reduce eye strain.',
    'report.health.tips.bing':'Regulate emotions; avoid staying up late.',
    'report.health.tips.ding':'Ensure sufficient sleep; reduce stress overload.',
    'report.health.tips.wu':'Eat regularly; avoid overeating.',
    'report.health.tips.ji':'Food hygiene matters; avoid damp environments.',
    'report.health.tips.geng':'Keep warm; avoid overly dry environments.',
    'report.health.tips.xin':'Ventilation matters; avoid smoke/dust.',
    'report.health.tips.ren':'Maintain hydration balance; keep kidneys supported.',
    'report.health.tips.gui':'Drink enough water; avoid overwork.'
  });

  function t(path, lang = (window.state && window.state.lang) || 'en') {
    const pack = (window.I18N && window.I18N[lang]) || {};
    const baseEN = (window.I18N && window.I18N['en']) || {};
    const baseTW = (window.I18N && window.I18N['zh-TW']) || {};
    const baseCN = (window.I18N && window.I18N['zh-CN']) || {};

    // 1) flat key (current lang)
    let v = pack[path];
    if (v != null && v !== '') return v;

    // 2) nested object (current lang)
    v = deepGet(pack, path);
    if (v != null && v !== '') return v;

    // 3) EN fallback flat
    v = baseEN[path];
    if (v != null && v !== '') return v;

    // 4) EN fallback nested
    v = deepGet(baseEN, path);
    if (v != null && v !== '') return v;

    // 5) TW fallback (optional)
    v = baseTW[path];
    if (v != null && v !== '') return v;
    v = deepGet(baseTW, path);
    if (v != null && v !== '') return v;

    // 6) CN fallback (optional)
    v = baseCN[path];
    if (v != null && v !== '') return v;
    v = deepGet(baseCN, path);
    if (v != null && v !== '') return v;

    const defaults = {
      'reportLabels.symbolise': 'Meaning',
      'reportLabels.analysis': 'Advice',
      'reportLabels.tenGods': 'Ten Gods',
      'reportLabels.dayMaster': 'Day Master',
      'reportLabels.elementCount': 'Element Count',
      'reportLabels.missingElements': 'Missing Elements',
      'reportLabels.suitableCareers': 'Suitable Fields',
      'reportLabels.careerAdvice': 'Career Advice',
      'reportLabels.favorableDirections': 'Favorable Directions',
      'reportLabels.healthCharacteristics': 'Body Focus',
      'reportLabels.healthTips': 'Health Tips',
      'reportLabels.wellnessAdvice': 'Wellness',
      'reportLabels.overallFortune': 'Overall Outlook',
      'reportLabels.favorableTiming': 'Favorable Timing',
      'reportLabels.cautions': 'Cautions',
      'report.career.steady': 'Step by step‚Äîdeepen expertise and grow through reputation.',
      'report.marriage.experienced': 'You may have more relationship experiences; choose a compatible partner.',
      'wealth.steady': 'Steady wealth; rely on skills & reputation to grow income.'
    };
    return defaults[path] || '';
  }
  window.t = t;

  function applyI18n(){
    const lang = state.lang || 'en';
    document.documentElement.lang = lang;

    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string' && val !== '') el.textContent = val;
    });

    document.querySelectorAll('option[data-i18n]').forEach(opt=>{
      const key = opt.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string' && val !== '') opt.textContent = val;
    });

    const setPh = (id, value) => { const el=$(id); if (el && typeof value === 'string' && value) el.placeholder = value; };
    setPh('name', t('form.namePlaceholder'));
    setPh('chatInput', t('chat.placeholder'));

    if (window.lastCtx && typeof window.buildProReport === 'function') window.buildProReport(window.lastCtx);
  }
  window.applyI18n = applyI18n;

  /* ===== BaZi calculator ===== */
  class BaziCalculator {
    constructor(){
      this.HEAVENLY_STEMS=['Áî≤','‰πô','‰∏ô','‰∏Å','Êàä','Â∑±','Â∫ö','Ëæõ','Â£¨','Áô∏'];
      this.EARTHLY_BRANCHES=['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];

      // ‚úÖ NaYin translated to English
      this.NAYIN=[
        'Metal in the Sea','Fire in the Furnace','Wood of the Great Forest','Earth by the Roadside','Sword-edge Metal',
        'Fire on the Mountain Top','Water in the Mountain Stream','Earth on the City Wall','White Wax Metal','Willow Wood',
        'Spring Water','Roof-top Earth','Thunderbolt Fire','Pine & Cypress Wood','Long-flowing Water',
        'Sand/Gravel Metal','Fire at the Foot of the Mountain','Plain Wood','Earth on the Wall','Gold Leaf Metal',
        'Buddha Lamp Fire','Heavenly River Water','Great Post Station Earth','Hairpin/Bracelet Metal','Mulberry Wood',
        'Great Stream Water','Sand Earth','Heavenly Fire','Pomegranate Wood','Great Sea Water'
      ];
    }
    yearPillar(year){ const s=(year-4)%10, b=(year-4)%12; return {stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]}; }
    solarMonthIndex(y,m,d){ const mmdd=m*100+d;
      const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
      let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
      const branchBy={1:'ÂØÖ',2:'ÂçØ',3:'Ëæ∞',4:'Â∑≥',5:'Âçà',6:'Êú™',7:'Áî≥',8:'ÈÖâ',9:'Êàå',10:'‰∫•',11:'Â≠ê',12:'‰∏ë'};
      return {index:idx, branch:branchBy[idx]};
    }
    monthPillar(year,month,day){
      const {index,branch}=this.solarMonthIndex(year,month,day);
      const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
      const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIdx=(startMap[yStemIdx]+(index-1))%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch};
    }
    dayPillar(year,month,day){
      const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
      const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
      const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
      return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
    }
    hourPillar(dayStem,hour){
      const branchMap={23:'Â≠ê',0:'Â≠ê',1:'‰∏ë',2:'‰∏ë',3:'ÂØÖ',4:'ÂØÖ',5:'ÂçØ',6:'ÂçØ',7:'Ëæ∞',8:'Ëæ∞',9:'Â∑≥',10:'Â∑≥',11:'Âçà',12:'Âçà',13:'Êú™',14:'Êú™',15:'Áî≥',16:'Áî≥',17:'ÈÖâ',18:'ÈÖâ',19:'Êàå',20:'Êàå',21:'‰∫•',22:'‰∫•'};
      const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex=Math.floor((hour+1)/2)%12;
      const stemIdx=(startMap[dayIdx]+hourIndex)%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
    }
    stemElem(s){ return ({Áî≤:'Êú®',‰πô:'Êú®',‰∏ô:'ÁÅ´',‰∏Å:'ÁÅ´',Êàä:'Âúü',Â∑±:'Âúü',Â∫ö:'Èáë',Ëæõ:'Èáë',Â£¨:'Ê∞¥',Áô∏:'Ê∞¥'})[s]||'-'; }
    branchElem(b){ return ({Â≠ê:'Ê∞¥',‰∏ë:'Âúü',ÂØÖ:'Êú®',ÂçØ:'Êú®',Ëæ∞:'Âúü',Â∑≥:'ÁÅ´',Âçà:'ÁÅ´',Êú™:'Âúü',Áî≥:'Èáë',ÈÖâ:'Èáë',Êàå:'Âúü',‰∫•:'Ê∞¥'})[b]||'-'; }
    nayin(s,b){ const si=this.HEAVENLY_STEMS.indexOf(s), bi=this.EARTHLY_BRANCHES.indexOf(b); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
    tenGods(dayStem, stems){
      const map={
        'Áî≤':{'Áî≤':'ÊØîËÇ©','‰πô':'Âä´Ë≤°','‰∏ô':'È£üÁ•û','‰∏Å':'ÂÇ∑ÂÆò','Êàä':'ÂÅèË≤°','Â∑±':'Ê≠£Ë≤°','Â∫ö':'‰∏ÉÊÆ∫','Ëæõ':'Ê≠£ÂÆò','Â£¨':'ÂÅèÂç∞','Áô∏':'Ê≠£Âç∞'},
        '‰πô':{'Áî≤':'Âä´Ë≤°','‰πô':'ÊØîËÇ©','‰∏ô':'ÂÇ∑ÂÆò','‰∏Å':'È£üÁ•û','Êàä':'Ê≠£Ë≤°','Â∑±':'ÂÅèË≤°','Â∫ö':'Ê≠£ÂÆò','Ëæõ':'‰∏ÉÊÆ∫','Â£¨':'Ê≠£Âç∞','Áô∏':'ÂÅèÂç∞'},
        '‰∏ô':{'Áî≤':'ÂÅèÂç∞','‰πô':'Ê≠£Âç∞','‰∏ô':'ÊØîËÇ©','‰∏Å':'Âä´Ë≤°','Êàä':'È£üÁ•û','Â∑±':'ÂÇ∑ÂÆò','Â∫ö':'ÂÅèË≤°','Ëæõ':'Ê≠£Ë≤°','Â£¨':'‰∏ÉÊÆ∫','Áô∏':'Ê≠£ÂÆò'},
        '‰∏Å':{'Áî≤':'Ê≠£Âç∞','‰πô':'ÂÅèÂç∞','‰∏ô':'Âä´Ë≤°','‰∏Å':'ÊØîËÇ©','Êàä':'ÂÇ∑ÂÆò','Â∑±':'È£üÁ•û','Â∫ö':'Ê≠£Ë≤°','Ëæõ':'ÂÅèË≤°','Â£¨':'Ê≠£ÂÆò','Áô∏':'‰∏ÉÊÆ∫'},
        'Êàä':{'Áî≤':'‰∏ÉÊÆ∫','‰πô':'Ê≠£ÂÆò','‰∏ô':'ÂÅèÂç∞','‰∏Å':'Ê≠£Âç∞','Êàä':'ÊØîËÇ©','Â∑±':'Âä´Ë≤°','Â∫ö':'È£üÁ•û','Ëæõ':'ÂÇ∑ÂÆò','Â£¨':'ÂÅèË≤°','Áô∏':'Ê≠£Ë≤°'},
        'Â∑±':{'Áî≤':'Ê≠£ÂÆò','‰πô':'‰∏ÉÊÆ∫','‰∏ô':'Ê≠£Âç∞','‰∏Å':'ÂÅèÂç∞','Êàä':'Âä´Ë≤°','Â∑±':'ÊØîËÇ©','Â∫ö':'ÂÇ∑ÂÆò','Ëæõ':'È£üÁ•û','Â£¨':'Ê≠£Ë≤°','Áô∏':'ÂÅèË≤°'},
        'Â∫ö':{'Áî≤':'ÂÅèË≤°','‰πô':'Ê≠£Ë≤°','‰∏ô':'‰∏ÉÊÆ∫','‰∏Å':'Ê≠£ÂÆò','Êàä':'ÂÅèÂç∞','Â∑±':'Ê≠£Âç∞','Â∫ö':'ÊØîËÇ©','Ëæõ':'Âä´Ë≤°','Â£¨':'È£üÁ•û','Áô∏':'ÂÇ∑ÂÆò'},
        'Ëæõ':{'Áî≤':'Ê≠£Ë≤°','‰πô':'ÂÅèË≤°','‰∏ô':'Ê≠£ÂÆò','‰∏Å':'‰∏ÉÊÆ∫','Êàä':'Ê≠£Âç∞','Â∑±':'ÂÅèÂç∞','Â∫ö':'Âä´Ë≤°','Ëæõ':'ÊØîËÇ©','Â£¨':'ÂÇ∑ÂÆò','Áô∏':'È£üÁ•û'},
        'Â£¨':{'Áî≤':'È£üÁ•û','‰πô':'ÂÇ∑ÂÆò','‰∏ô':'ÂÅèË≤°','‰∏Å':'Ê≠£Ë≤°','Êàä':'‰∏ÉÊÆ∫','Â∑±':'Ê≠£ÂÆò','Â∫ö':'ÂÅèÂç∞','Ëæõ':'Ê≠£Âç∞','Â£¨':'ÊØîËÇ©','Áô∏':'Âä´Ë≤°'},
        'Áô∏':{'Áî≤':'ÂÇ∑ÂÆò','‰πô':'È£üÁ•û','‰∏ô':'Ê≠£Ë≤°','‰∏Å':'ÂÅèË≤°','Êàä':'Ê≠£ÂÆò','Â∑±':'‰∏ÉÊÆ∫','Â∫ö':'Ê≠£Âç∞','Ëæõ':'ÂÅèÂç∞','Â£¨':'Âä´Ë≤°','Áô∏':'ÊØîËÇ©'}
      };
      const m=map[dayStem]||{}; return stems.map(s=>m[s]||'-');
    }
  }

  /* ===== Analysis helpers ===== */
  function stemToPinyin(stem){
    const map = {'Áî≤':'jia','‰πô':'yi','‰∏ô':'bing','‰∏Å':'ding','Êàä':'wu','Â∑±':'ji','Â∫ö':'geng','Ëæõ':'xin','Â£¨':'ren','Áô∏':'gui'};
    return map[stem] || String(stem).toLowerCase();
  }
  const controlChain = { 'Êú®':'Âúü', 'Âúü':'Ê∞¥', 'Ê∞¥':'ÁÅ´', 'ÁÅ´':'Èáë', 'Èáë':'Êú®' };
  const motherOf     = { 'Êú®':'Ê∞¥', 'ÁÅ´':'Êú®', 'Âúü':'ÁÅ´', 'Èáë':'Âúü', 'Ê∞¥':'Èáë' };

  const BaziAnalysis = {
    dayMasterLine(stem){ return t('report.dayMaster.'+stemToPinyin(stem)) || ''; },

    relation(dayStem){
      const dict={
        'Áî≤':{traits:'Proactive in love; likes to lead. Remember to give the other person space.',tips:'Listen first, then respond. Keep communication balanced.'},
        '‰πô':{traits:'Gentle and sensitive; needs stable emotional support. Avoid over-dependence.',tips:'Build confidence and express needs clearly.'},
        '‰∏ô':{traits:'Passionate and expressive; can be impulsive when emotions rise.',tips:'Slow down before reacting; choose timing and words carefully.'},
        '‰∏Å':{traits:'Loyal and devoted; may overthink or become suspicious under stress.',tips:'Practice trust; reduce unnecessary guessing.'},
        'Êàä':{traits:'Stable and practical; values long-term security but may look ‚Äútoo serious‚Äù.',tips:'Add warmth/romance and emotional expression.'},
        'Â∑±':{traits:'Caring and attentive; may lack a sense of safety at times.',tips:'Create emotional security through routines and clear agreements.'},
        'Â∫ö':{traits:'Direct and decisive; dislikes ambiguity. Be mindful of the other person‚Äôs feelings.',tips:'Keep honesty, but soften delivery and pace.'},
        'Ëæõ':{traits:'High standards; seeks quality and refinement in relationships.',tips:'Accept imperfections; focus on shared growth.'},
        'Â£¨':{traits:'Needs freshness and freedom; emotions can change quickly.',tips:'Build stable habits and shared interests to anchor the bond.'},
        'Áô∏':{traits:'Sensitive and intuitive; can be emotional when overwhelmed.',tips:'Learn emotion regulation; handle conflict with calm structure.'}
      };
      return dict[dayStem]||{traits:'Overall steady; relationship improves with intentional care.',tips:'Mutual respect and honest communication are key.'};
    },

    marriageAdvice(ten){
      if(ten.includes('Ê≠£ÂÆò')||ten.includes('Ê≠£Ë≤°')) return t('report.marriage.stable');
      if(ten.includes('‰∏ÉÊÆ∫')||ten.includes('ÂÅèË≤°')) return t('report.marriage.experienced');
      return t('report.marriage.default');
    },

    career(dayStem,ten){
      const map={
        Áî≤:'Leadership, entrepreneurship, operations, building/engineering',
        ‰πô:'Education, creative design, consulting, branding/content',
        ‰∏ô:'Marketing, sales, media/entertainment, energy-related industries',
        ‰∏Å:'R&D/tech, healthcare/service, precision/craft',
        Êàä:'Finance, real estate, asset/resource management',
        Â∑±:'HR, service industries, admin, agriculture-related',
        Â∫ö:'Law, machinery/engineering, security/military/police',
        Ëæõ:'Finance analysis, precision instruments, luxury/jewelry',
        Â£¨:'Trade/logistics, travel, creative industries',
        Áô∏:'Research, psychology/coaching, arts/creative writing'
      };
      let adv = t('report.career.steady');
      if(ten.includes('Ê≠£ÂÆò')||ten.includes('‰∏ÉÊÆ∫')) adv=t('report.career.leadership');
      else if(ten.includes('Ê≠£Ë≤°')||ten.includes('ÂÅèË≤°')) adv=t('report.career.business');
      else if(ten.includes('È£üÁ•û')||ten.includes('ÂÇ∑ÂÆò')) adv=t('report.career.creative');
      return {suitable:map[dayStem]||'Build stable skills and long-term reputation.', advice:adv};
    },

    wealthDirs(dayStem){
      const dirs={Áî≤:'Êù±Êñπ„ÄÅÊù±ÂçóÊñπ',‰πô:'Êù±Êñπ„ÄÅÂçóÊñπ',‰∏ô:'ÂçóÊñπ',‰∏Å:'ÂçóÊñπ„ÄÅË•øÂçóÊñπ',Êàä:'‰∏≠ÈÉ®„ÄÅÊú¨Âú∞',Â∑±:'‰∏≠ÈÉ®„ÄÅË•øÂçóÊñπ',Â∫ö:'Ë•øÊñπ„ÄÅË•øÂåóÊñπ',Ëæõ:'Ë•øÊñπ„ÄÅÂåóÊñπ',Â£¨:'ÂåóÊñπ',Áô∏:'ÂåóÊñπ„ÄÅÊù±Êñπ'};
      return dirs[dayStem]||'-';
    },

    health(dayStem){
      const c={
        Áî≤:'Liver/gallbladder, eyesight, tendons',
        ‰πô:'Liver function & emotional regulation',
        ‰∏ô:'Cardio & eyes; manage emotions',
        ‰∏Å:'Heart/circulation; prioritize sleep',
        Êàä:'Digestive system; eat regularly',
        Â∑±:'Digestion & skin; hygiene matters',
        Â∫ö:'Respiratory system & large intestine; avoid dryness',
        Ëæõ:'Lungs/respiration; keep air clean',
        Â£¨:'Kidneys/urinary; hydration balance',
        Áô∏:'Kidneys/bladder; avoid overwork'
      };
      return c[dayStem]||'Overall balanced‚Äîkeep sleep and routine steady.';
    }
  };

  // AI integration (single definition + breaker) ‚Äî‚Äî unchanged
  (function () {
    const LS_DOWN = 'ai:insight:downUntil';
    const now = () => Date.now();
    const downUntil = () => { try { return parseInt(localStorage.getItem(LS_DOWN)||'0',10)||0; } catch { return 0; } };
    const markDown = (ms = 180000) => { try { localStorage.setItem(LS_DOWN, String(now()+ms)); } catch {} };
    const clearDown = () => { try { localStorage.removeItem(LS_DOWN); } catch {} };

    async function fetchJSON(url, init={}, timeoutMs=15000){
      const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {...init, signal: ctrl.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function _aiExplain(section, ctx, {lang, temperature=0.7, seed=null}={}){
      if (!window.API_BASE) return null;
      const json = await fetchJSON(`${String(window.API_BASE).replace(/\/$/,'')}/bazi/insight`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ section, lang, temperature, seed, ctx })
      });
      if (json && (json.symbolise || json.analysis)) return json;
      return null;
    }

    window.aiExplain = async function (section, ctx, opts) {
      if (now() < downUntil()) return null;
      try {
        const out = await _aiExplain(section, ctx, opts||{});
        if (out) { clearDown(); return out; }
        markDown(); return null;
      } catch {
        markDown(); return null;
      }
    };

    window.injectAI = async function (section, symId, anaId, ctx, opts) {
      try {
        const out = await window.aiExplain(section, ctx, opts);
        if (!out) return;
        const $sym = document.getElementById(symId);
        const $ana = document.getElementById(anaId);
        if ($sym && out.symbolise) $sym.textContent = `${t('reportLabels.symbolise')}Ôºö${out.symbolise}`;
        if ($ana && out.analysis)  $ana.textContent = `${t('reportLabels.analysis')}Ôºö${out.analysis}`;
      } catch {}
    };

    window.forceAiInsightRetry = function () { try { localStorage.removeItem(LS_DOWN); } catch {} };
  })();

  /* ===== Renderers ===== */
  function renderPillars(labels){
    const titles=[t('pillar.year'),t('pillar.month'),t('pillar.day'),t('pillar.hour')];
    const box = $('bazi-pillars'); if(!box) return;
    box.innerHTML = labels.map((lab,i)=>`
      <div class="pillar"><div class="tit">${titles[i]}</div><div class="gz">${lab||'-'}</div></div>
    `).join('');
  }

  function renderTable(data){
    const keys=['year','month','day','hour'];
    const translateElem = (val)=>{
      const map = { 'Êú®': t('elem.wood'), 'ÁÅ´': t('elem.fire'),'Âúü': t('elem.earth'),'Èáë': t('elem.metal'),'Ê∞¥': t('elem.water') };
      return map[val] || val;
    };
    ['stem','branch','element','nayin'].forEach(row=>{
      keys.forEach((k, i)=>{
        const cell = $(k+'-'+row); if (!cell) return;
        let v = (Array.isArray(data[row]) ? data[row][i] : '-') ?? '-';
        if (row === 'element') v = translateElem(v);
        cell.textContent = v;
      });
    });
  }

  function renderBars(pcts){
    ['Êú®','ÁÅ´','Âúü','Èáë','Ê∞¥'].forEach(e=>{
      const pct=Math.max(0,Math.min(100,Math.round(pcts[e]||0)));
      const bar=$('bar-'+e), lab=$('pct-'+e);
      if(bar) bar.style.width=pct+'%';
      if(lab) lab.textContent=pct+'%';
    });
    const entries=Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
    if(entries.length){
      const strongest = entries[0][0], weakest = entries.at(-1)[0];
      const mapName = {Êú®:t('elem.wood'),ÁÅ´:t('elem.fire'),Âúü:t('elem.earth'),Èáë:t('elem.metal'),Ê∞¥:t('elem.water')};
      const tpl = (t('ui.balance') || 'Strongest: {strongest}. Weakest: {weakest}.');
      const txt = tpl.replace('{strongest}', mapName[strongest]).replace('{weakest}', mapName[weakest]);
      const el=$('bazi-elements-balance'); if(el) el.textContent=txt;
    }
  }

  /* ===== Pro Report ===== */
  function i18nDirs(s){
    if(!s) return '';
    const L = state.lang;
    const maps = {
      'zh-TW': {'Êù±Êñπ':'Êù±Êñπ','Êù±ÂçóÊñπ':'Êù±ÂçóÊñπ','ÂçóÊñπ':'ÂçóÊñπ','Ë•øÂçóÊñπ':'Ë•øÂçóÊñπ','Ë•øÊñπ':'Ë•øÊñπ','Ë•øÂåóÊñπ':'Ë•øÂåóÊñπ','ÂåóÊñπ':'ÂåóÊñπ','Êù±ÂåóÊñπ':'Êù±ÂåóÊñπ','‰∏≠ÈÉ®„ÄÅÊú¨Âú∞':'‰∏≠ÈÉ®/Êú¨Âú∞'},
      'zh-CN': {'Êù±Êñπ':'‰∏úÊñπ','Êù±ÂçóÊñπ':'‰∏úÂçóÊñπ','ÂçóÊñπ':'ÂçóÊñπ','Ë•øÂçóÊñπ':'Ë•øÂçóÊñπ','Ë•øÊñπ':'Ë•øÊñπ','Ë•øÂåóÊñπ':'Ë•øÂåóÊñπ','ÂåóÊñπ':'ÂåóÊñπ','Êù±ÂåóÊñπ':'‰∏úÂåóÊñπ','‰∏≠ÈÉ®„ÄÅÊú¨Âú∞':'‰∏≠ÈÉ®/Êú¨Âú∞'},
      'en':    {'Êù±Êñπ':'East','Êù±ÂçóÊñπ':'Southeast','ÂçóÊñπ':'South','Ë•øÂçóÊñπ':'Southwest','Ë•øÊñπ':'West','Ë•øÂåóÊñπ':'Northwest','ÂåóÊñπ':'North','Êù±ÂåóÊñπ':'Northeast','‰∏≠ÈÉ®„ÄÅÊú¨Âú∞':'Center / Local'}
    };
    const map = maps[L] || maps['en'];
    return Object.keys(map).reduce((acc,k)=> acc.replaceAll(k, map[k]), s);
  }

  const TG_KEY = {
    'ÊØîËÇ©':'tenGodsNames.biJian','Âä´Ë≤°':'tenGodsNames.jieCai','È£üÁ•û':'tenGodsNames.shiShen','ÂÇ∑ÂÆò':'tenGodsNames.shangGuan',
    'Ê≠£Ë≤°':'tenGodsNames.zhengCai','ÂÅèË≤°':'tenGodsNames.pianCai','Ê≠£ÂÆò':'tenGodsNames.zhengGuan','‰∏ÉÊÆ∫':'tenGodsNames.qiSha',
    'Ê≠£Âç∞':'tenGodsNames.zhengYin','ÂÅèÂç∞':'tenGodsNames.pianYin'
  };
  function tenGodTipKey(cn){ const base = TG_KEY[cn]?.replace('tenGodsNames','tenGodsHints'); return base||''; }

  function tenGodsAdviceList(arr){
    const fallback = {
      'ÊØîËÇ©':'Self-reliant; avoid stubbornness.',
      'Âä´Ë≤°':'Shares resources; curb impulse spending.',
      'È£üÁ•û':'Creative output; keep rhythm & health.',
      'ÂÇ∑ÂÆò':'Expressive/critical; mind your tone.',
      'Ê≠£Ë≤°':'Stable income focus; budget first.',
      'ÂÅèË≤°':'Opportunistic gains; set risk limits.',
      'Ê≠£ÂÆò':'Rules/structure; keep flexibility.',
      '‰∏ÉÊÆ∫':'Decisive drive; avoid recklessness.',
      'Ê≠£Âç∞':'Learning/support; avoid over-protection.',
      'ÂÅèÂç∞':'Insightful/unique; don‚Äôt over-detach.'
    };
    return arr.map(cn => t(tenGodTipKey(cn)) || fallback[cn] || String(cn));
  }

  function supportElems(dm){
    const map = { Áî≤:['Ê∞¥','Êú®'], ‰πô:['Ê∞¥','Êú®'], ‰∏ô:['Êú®','ÁÅ´'], ‰∏Å:['Êú®','ÁÅ´'], Êàä:['ÁÅ´','Âúü'], Â∑±:['ÁÅ´','Âúü'], Â∫ö:['Âúü','Èáë'], Ëæõ:['Âúü','Èáë'], Â£¨:['Èáë','Ê∞¥'], Áô∏:['Èáë','Ê∞¥'] };
    const key = (x)=>({Êú®:'elem.wood',ÁÅ´:'elem.fire',Âúü:'elem.earth',Èáë:'elem.metal',Ê∞¥:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function restrainElems(dm){
    const map = { Áî≤:['Èáë'], ‰πô:['Èáë'], ‰∏ô:['Ê∞¥'], ‰∏Å:['Ê∞¥'], Êàä:['Êú®'], Â∑±:['Êú®'], Â∫ö:['ÁÅ´'], Ëæõ:['ÁÅ´'], Â£¨:['Âúü'], Áô∏:['Âúü'] };
    const key = (x)=>({Êú®:'elem.wood',ÁÅ´:'elem.fire',Âúü:'elem.earth',Èáë:'elem.metal',Ê∞¥:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function computeUseful(p){ // 2 weakest
    const arr = Object.entries({Êú®:p.Êú®||0,ÁÅ´:p.ÁÅ´||0,Âúü:p.Âúü||0,Èáë:p.Èáë||0,Ê∞¥:p.Ê∞¥||0}).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k])=>k);
    const key = (x)=>({Êú®:'elem.wood',ÁÅ´:'elem.fire',Âúü:'elem.earth',Èáë:'elem.metal',Ê∞¥:'elem.water'})[x];
    return arr.map(key);
  }

  /* ===== Pro report builder (EN) ¬∑ 10 sections ===== */
  window.buildProReport = function buildProReport(ctx){
    const box = $('professionalReport');
    if (!box || !ctx) return;

    const dm = ctx.dayStem || '';
    const pctsCN = ctx.pcts || {};
    const ten = Array.isArray(ctx.tenGods) ? ctx.tenGods.filter(Boolean) : [];

    const elem = {
      Wood:  pctsCN['Êú®'] || 0,
      Fire:  pctsCN['ÁÅ´'] || 0,
      Earth: pctsCN['Âúü'] || 0,
      Metal: pctsCN['Èáë'] || 0,
      Water: pctsCN['Ê∞¥'] || 0,
    };

    function strongestWeakest(obj){
      const arr = Object.entries(obj || {});
      if (!arr.length) return { strongest:'', weakest:'' };
      arr.sort((a,b)=> b[1] - a[1]);
      return { strongest: arr[0][0], weakest: arr[arr.length - 1][0] };
    }

    const { strongest, weakest } = strongestWeakest(elem);

    const ELEM_LABEL_EN = { Wood:'Wood', Fire:'Fire', Earth:'Earth', Metal:'Metal', Water:'Water' };
    const strongestLabel = ELEM_LABEL_EN[strongest] || strongest || '-';
    const weakestLabel   = ELEM_LABEL_EN[weakest]   || weakest   || '-';

    const dmLine   = BaziAnalysis.dayMasterLine(dm) || 'Your Day Master profile is relatively balanced and adaptive.';
    const rel      = BaziAnalysis.relation(dm);
    const marriage = BaziAnalysis.marriageAdvice(ten);
    const career   = BaziAnalysis.career(dm, ten);
    const wealthDir= i18nDirs(BaziAnalysis.wealthDirs(dm));
    const healthFo = BaziAnalysis.health(dm);

    const supportKeys  = supportElems(dm);
    const restrainKeys = restrainElems(dm);
    const usefulKeys   = computeUseful({ Êú®:pctsCN['Êú®']||0, ÁÅ´:pctsCN['ÁÅ´']||0, Âúü:pctsCN['Âúü']||0, Èáë:pctsCN['Èáë']||0, Ê∞¥:pctsCN['Ê∞¥']||0 });

    const supportText  = supportKeys.map(k=>t(k)).filter(Boolean).join(', ') || '-';
    const restrainText = restrainKeys.map(k=>t(k)).filter(Boolean).join(', ') || '-';
    const usefulText   = usefulKeys.map(k=>t(k)).filter(Boolean).join(', ') || '-';

    const elemLine = `
      Wood: ${Math.round(elem.Wood)}% ¬∑
      Fire: ${Math.round(elem.Fire)}% ¬∑
      Earth: ${Math.round(elem.Earth)}% ¬∑
      Metal: ${Math.round(elem.Metal)}% ¬∑
      Water: ${Math.round(elem.Water)}%
    `.replace(/\s+/g,' ');

    let nearTermFocus  = t('fortune.foundation') || 'Build foundations; keep a steady rhythm';
    let nearTermAdvice = t('cautions.default')   || 'Avoid emotional decisions; control spending.';

    switch (strongest) {
      case 'Wood':
        nearTermFocus  = t('fortune.upward') || 'Momentum rising; good for exposure/output';
        nearTermAdvice = 'Learn a new skill, expand network, and push one medium-term project weekly.';
        break;
      case 'Fire':
        nearTermFocus  = t('fortune.upward') || 'Momentum rising; good for exposure/output';
        nearTermAdvice = 'Good for launching, pitching, negotiating‚Äîavoid impulsive choices.';
        break;
      case 'Earth':
        nearTermFocus  = t('fortune.focus') || 'Focus & structure; good for execution';
        nearTermAdvice = 'Restructure time and money: concentrate on the top 1‚Äì2 highest-return directions.';
        break;
      case 'Metal':
        nearTermFocus  = t('fortune.focus') || 'Focus & structure; good for execution';
        nearTermAdvice = 'Set rules/process/contracts and backup plans to stabilize the next stage.';
        break;
      case 'Water':
        nearTermFocus  = t('fortune.study') || 'Study/research first; build then launch';
        nearTermAdvice = 'Observe and compare first. Run small experiments before committing big resources.';
        break;
    }

    const title = {
      overview:     t('reportTitles.overview')     || 'Chart Overview',
      fiveElements: t('reportTitles.fiveElements') || 'Five Elements',
      tenGods:      t('reportTitles.tenGods')      || 'Ten Gods',
      useful:       t('reportTitles.useful')       || 'Favorable Elements',
      relation:     t('reportTitles.relationship') || 'Love & Relationships',
      career:       t('reportTitles.career')       || 'Career',
      wealth:       t('reportTitles.wealth')       || 'Wealth',
      health:       t('reportTitles.health')       || 'Health',
      nearTerm:     t('reportTitles.nearTerm')     || 'Near-term Outlook',
      actions:      t('reportTitles.actions')      || 'Action Checklist',
    };

    const parts = [];

    parts.push(`
      <div class="butler-section">
        <h4>1. ${title.overview}</h4>
        <p><strong>${t('reportLabels.dayMaster') || 'Day Master'}:</strong> ${dm || '-'}</p>
        <p>${dmLine}</p>
        ${ctx.unknown ? `<p>${t('report.hourUnknownTip') || 'Note: Because the birth time is unknown, parts of the analysis are for reference only.'}</p>` : ''}
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>2. ${title.fiveElements}</h4>
        <p>${elemLine}</p>
        <p><strong>Strongest:</strong> ${strongestLabel} &nbsp;&nbsp; <strong>Weakest:</strong> ${weakestLabel}</p>
        <p>
          Your strongest element reflects your most natural performance style.
          The weakest element is a long-term growth area‚Äîimprove it steadily, not all at once.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>3. ${title.tenGods}</h4>
        <p>
          This quick report doesn‚Äôt list every Ten-God detail, but your structure suggests a key theme:
          balance <strong>self-expression, resource management, and responsibility to others</strong>.
        </p>
        <p>
          When you feel drained, ask: ‚ÄúWho is this for?‚Äù and ‚ÄúDid I communicate my boundary clearly?‚Äù
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>4. ${title.useful}</h4>
        <p><strong>Support elements:</strong> ${supportText}</p>
        <p><strong>Balancing elements:</strong> ${restrainText}</p>
        <p><strong>Priority to strengthen now:</strong> ${usefulText || 'Overall balanced; adjust based on current goals.'}</p>
        <p>
          Strengthen favorable elements through colors, environment, routines, and the type of work you do.
          Make it practical: pick one habit and keep it consistent.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>5. ${title.relation}</h4>
        <p><strong>Relationship traits:</strong> ${rel.traits}</p>
        <p><strong>How to get along:</strong> ${rel.tips}</p>
        <p><strong>Marriage note:</strong> ${marriage}</p>
        <p>
          Love is not only romance‚Äîit‚Äôs long-term cooperation.
          Clear boundaries + honest communication + stable life rhythm makes your relationships smoother.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>6. ${title.career}</h4>
        <p><strong>Suitable fields:</strong> ${career.suitable}</p>
        <p><strong>Career advice:</strong> ${career.advice}</p>
        <p>
          Your best strategy is <strong>long-term depth + professional reputation</strong>.
          Aim to become ‚Äúthe person people think of‚Äù for a specific topic.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>7. ${title.wealth}</h4>
        <p><strong>Money direction (reference):</strong> ${wealthDir || '-'}</p>
        <p>
          Wealth is not only ‚Äúopportunity‚Äù‚Äîit‚Äôs cashflow discipline and risk awareness.
          Stabilize core income first, then set a clear loss limit for high-risk moves.
        </p>
        <p>
          Your most sustainable wealth model: grow income through skill + trust,
          then expand a side stream that matches your strengths.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>8. ${title.health}</h4>
        <p><strong>Body focus:</strong> ${healthFo}</p>
        <p>
          Keep wellness simple: stable sleep, light exercise, and not overeating.
          Add one consistent emotional outlet (journaling, walking, meditation, prayer, etc.).
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>9. ${title.nearTerm}</h4>
        <p><strong>Main theme:</strong> ${nearTermFocus}</p>
        <p><strong>Advice:</strong> ${nearTermAdvice}</p>
        <p>
          When things feel messy, pause new projects.
          Rank tasks: must-do first, nice-to-have later. Leave space to recover your rhythm.
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>10. ${title.actions}</h4>
        <ul class="action-list">
          <li>Within 30 days, pick ONE most important goal (work / money / health). Write it down where you can see it daily.</li>
          <li>Once a week, review real progress‚Äînot just mood. Adjust your next week plan.</li>
          <li>Lean into your strongest element (${strongestLabel}) using environment, routines, and supportive people.</li>
          <li>For your weakest element (${weakestLabel}), build 1‚Äì2 small habits you can keep weekly. No rush‚Äîconsistency wins.</li>
        </ul>
      </div>
    `);

    box.innerHTML = parts.join('\n');

    const sec = $('butlerProfessional');
    if (sec) sec.style.display = 'block';
  };

  /* ===== Gen + UI ===== */
  function showErr(msg){
    const box=$('error'); if(!box) return;
    box.textContent = msg || t('err.generateFail');
    box.style.display='block';
    setTimeout(()=>{ box.style.display='none'; }, 4000);
  }
  function setGenLoading(v){
    const btn=$('genBtn'), txt=$('genBtnText'), ld=$('genBtnLoading');
    if(btn) btn.disabled=!!v;
    if(txt) txt.style.display=v?'none':'inline';
    if(ld) ld.style.display=v?'inline':'none';
  }

  function generate(){
    const birth = ($('birthdate')?.value||'').trim();
    if(!birth) return showErr(t('err.fillBirthdate'));
    if(!/^\d{4}-\d{2}-\d{2}$/.test(birth)) return showErr(t('err.invalidDate'));

    const [Y,M,D]=birth.split('-').map(n=>parseInt(n,10));
    const unknown = $('timeUnknown')?.checked;
    const timeVal = $('birthtime')?.value || '00:00';
    const hh = parseInt((timeVal.split(':')[0]||'0'),10) || 0;

    setGenLoading(true);
    try{
      const calc = new BaziCalculator();
      const y = calc.yearPillar(Y);
      const m = calc.monthPillar(Y,M,D);
      const d = calc.dayPillar(Y,M,D);
      const h = unknown ? {stem:'-',branch:'-'} : calc.hourPillar(d.stem, hh);

      renderPillars([y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, unknown ? (t('badge.noHour')||'-') : (h.stem+h.branch)]);

      const stems=[y.stem,m.stem,d.stem, unknown? '-' : h.stem];
      const branch=[y.branch,m.branch,d.branch, unknown? '-' : h.branch];
      const rawElems=[calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem), unknown? '-' : calc.stemElem(h.stem)];
      const nayin=[calc.nayin(y.stem,y.branch),calc.nayin(m.stem,m.branch),calc.nayin(d.stem,d.branch), unknown? '-' : calc.nayin(h.stem,h.branch)];
      renderTable({stem:stems,branch:branch,element:rawElems,nayin});

      const allElems = [calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem)]
        .concat(unknown?[]:[calc.stemElem(h.stem)])
        .concat([calc.branchElem(y.branch),calc.branchElem(m.branch),calc.branchElem(d.branch)])
        .concat(unknown?[]:[calc.branchElem(h.branch)]);
      const counts = {Êú®:0,ÁÅ´:0,Âúü:0,Èáë:0,Ê∞¥:0}; allElems.forEach(e=>{ if(counts[e]!=null) counts[e]++; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
      const pcts = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, 100*v/total]));
      renderBars(pcts);

      const timeText = unknown ? (t('ui.timeUnknown')||'Time unknown') :
        (t('ui.hourSuffix')||'{hh}:{mm}')
          .replace('{hh}', String(hh).padStart(2,'0'))
          .replace('{mm}', String(parseInt((timeVal.split(':')[1]||'0'),10)||0).padStart(2,'0'));

      const btxt = (t('ui.birthSummary')||'Birth: {y}-{m}-{d} {timeText}')
        .replace('{y}',Y).replace('{m}',M).replace('{d}',D).replace('{timeText}', timeText);

      const bd=$('bazi-date'); if (bd) bd.textContent = btxt;

      const tg = calc.tenGods(d.stem, stems);
      const ctx = { pcts, dayStem: d.stem, tenGods: tg, unknown };
      window.lastCtx = ctx;

      $('result').style.display='block';
    }catch(e){
      console.error(e);
      showErr(t('err.generateFail'));
    } finally {
      setGenLoading(false);
    }
  }

  function onLangSelect(e){
    const lang = (e.target?.value) || 'en';
    try { localStorage.setItem(LANG_KEY, lang); } catch {}

    const LANG_PAGES = {
      'en':    '/assets/bazi-language-pack/bazi-en.html',  // ‚úÖ this page (English)
      'zh-TW': '/assets/bazi-language-pack/bazi-zh-TW.html',
      'zh-CN': '/bazi.html',
      'ja':    '/assets/bazi-language-pack/bazi-ja.html',
      'th':    '/assets/bazi-language-pack/bazi-th.html',
      'ms':    '/assets/bazi-language-pack/bazi-ms.html'
    };

    const target = LANG_PAGES[lang] || LANG_PAGES['en'];
    if (!target) return;

    if (!window.location.pathname.endsWith(target)) {
      window.location.href = target;
    }
  }

  function tickNow(){
    const box = $('nowBox'); if (!box) return;
    const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
    const loc = localeMap[state.lang || 'en'] || 'en-US';
    const fmt = new Intl.DateTimeFormat(loc, { weekday:'short', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, timeZone: SG_TZ });
    box.textContent = fmt.format(new Date()) + ' (SGT)';
  }
  window.tickNow = tickNow;

  /* ===== Floating GPT Chat (ONLY this one) ===== */
  function initChat(){
    const fab   = $('ssChatFab');
    const panel = $('chatPanel');
    const close = $('chatClose');
    const body  = $('chatBody');
    const input = $('chatInput');
    const send  = $('chatSend');

    if (!fab || !panel || !close || !body || !input || !send) {
      console.warn('[chat] missing elements');
      return;
    }

    let chatHistory = [];

    const open = () => { panel.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(), 50); };
    const shut = () => { panel.setAttribute('aria-hidden','true'); };
    const toggle = () => {
      const hidden = panel.getAttribute('aria-hidden') !== 'false';
      hidden ? open() : shut();
    };

    fab.addEventListener('click', toggle);
    close.addEventListener('click', shut);

    function pushMsg(text, who='bot'){
      const div = document.createElement('div');
      div.className = who === 'me' ? 'ss-msg me' : 'ss-msg';
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
    }

    if (!initChat._welcomed){
      initChat._welcomed = true;
      pushMsg(t('pro.welcome') || 'Hi! I‚Äôm Xinlian Butler ¬∑ GPT. Generate your chart first, then ask me anything.', 'bot');
    }

    function buildBaziChatContext(){
      const ctx = window.lastCtx || null;
      const name = ($('name')?.value || '').trim();
      const gender = ($('gender')?.value || '').trim();
      const birth = ($('birthdate')?.value || '').trim();
      const timeUnknown = !!$('timeUnknown')?.checked;
      const birthtime = ($('birthtime')?.value || '').trim();

      return { name, gender, birthdate: birth, birthtime: timeUnknown ? '' : birthtime, timeUnknown, chart: ctx };
    }

    function extractReply(json){
      if (!json) return '';
      return (
        json.reply ||
        json.answer ||
        json.content ||
        json.message ||
        json.text ||
        (json.data && (json.data.reply || json.data.content || json.data.text)) ||
        ''
      );
    }

    async function callChatAPI(userText){
      const lang = (window.state && window.state.lang) || 'en';
      const ctx = buildBaziChatContext();

      if (!chatHistory.length){
        chatHistory.push({
          role: 'system',
          content:
`You are ‚ÄúXinlian Butler ¬∑ GPT‚Äù, responsible for BaZi interpretation and actionable advice.
- Language: ${lang}
- If the user has not generated the chart (chart is empty), ask them to click ‚ÄúGenerate BaZi‚Äù first.
- Be specific, bullet-pointed, and practical; do NOT output code.`
        });
      }

      chatHistory.push({ role:'user', content: userText });

      const url = String(API_BASE).replace(/\/$/,'') + CHAT_ENDPOINT;
      const payload = { lang, context: ctx, messages: chatHistory };

      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json().catch(()=>null);
      const reply = extractReply(json);

      if (reply) chatHistory.push({ role:'assistant', content: reply });
      return reply || '(No reply content returned ‚Äî check your worker response fields.)';
    }

    async function sendMsg(){
      const text = (input.value || '').trim();
      if (!text) return;

      input.value = '';
      pushMsg(text, 'me');
      pushMsg('‚Ä¶', 'bot');
      const typingNode = body.lastElementChild;

      try{
        const reply = await callChatAPI(text);
        if (typingNode) typingNode.textContent = reply;
        else pushMsg(reply, 'bot');
      }catch(err){
        console.error('[chat] error', err);
        const msg = '‚ö†Ô∏è GPT connection failed. Check API_BASE and /api/chat.';
        if (typingNode) typingNode.textContent = msg;
        else pushMsg(msg, 'bot');
      }
    }

    send.addEventListener('click', sendMsg);
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') sendMsg();
    });
  }

  function boot(){
    if (boot._didBoot) return; boot._didBoot = true;

    const langSel = $('langSelect');
    if (langSel) { langSel.value = state.lang; langSel.addEventListener('change', onLangSelect); }

    applyI18n();

    const unk = $('timeUnknown'), bt = $('birthtime');
    if (unk && bt){
      const sync = ()=>{ bt.disabled = !!unk.checked; bt.style.opacity = bt.disabled ? 0.5 : 1; };
      unk.addEventListener('change', sync); sync();
    }

    $('genBtn')?.addEventListener('click', generate);

    initChat();
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>

<!-- Clock + defaults keep-in-sync with language -->
<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Singapore';
  const localeMap = { 'zh-CN':'zh-CN','zh-TW':'zh-TW','en':'en-US','ja':'ja-JP','th':'th-TH','ms':'ms' };
  const getLocale = () => (localeMap[(window.state && window.state.lang) || 'en'] || 'en-US');

  window.applyI18n = (function(prev){
    return function(){
      if (typeof prev === 'function') prev();
      if (typeof window.tickNow === 'function') window.tickNow();
    };
  })(window.applyI18n);

  if (typeof window.tickNow !== 'function') {
    window.tickNow = function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const fmt = new Intl.DateTimeFormat(getLocale(), {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false, timeZone: TZ
      });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    };
  }

  function initBirthDefaults() {
    const bd = $('birthdate'); const bt = $('birthtime'); const unk = $('timeUnknown');
    const nowSG = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));

    if (bd && !bd.value){
      const y=nowSG.getFullYear(), m=String(nowSG.getMonth()+1).padStart(2,'0'), d=String(nowSG.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    if (bt){
      const hh=String(nowSG.getHours()).padStart(2,'0'), mm=String(nowSG.getMinutes()).padStart(2,'0');
      if (!bt.value) bt.value = `${hh}:${mm}`;
      const setUnknownState = ()=>{ const isUnknown = !!(unk && unk.checked); bt.disabled = isUnknown; if (isUnknown) bt.value = ''; };
      setUnknownState();
      if (unk && !unk._wired){
        unk._wired = true;
        unk.addEventListener('change', ()=>{
          if (unk.checked){
            bt.disabled = true; bt.value = '';
          } else {
            bt.disabled = false;
            if (!bt.value){
              const n = new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
              bt.value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
            }
          }
        });
      }
    }
  }

  initBirthDefaults();
  if (typeof window.tickNow === 'function') window.tickNow();
  if (!window._clock) window._clock = setInterval(()=>{ try{ window.tickNow(); }catch{} }, 60000);
})();
</script>
</body>
</html>
