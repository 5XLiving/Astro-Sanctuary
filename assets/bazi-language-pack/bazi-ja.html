<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å››æŸ±æ¨å‘½ï¼ˆå…«å­—ï¼‰Â· ã‚¯ã‚¤ãƒƒã‚¯é‘‘å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
/* ---- same visual style as CN version ---- */
:root{
  --bg:#0b0f14; --bg-accent:#0e1520; --card:#11161dcc; --surface:#0f1624; --line:#1f2a36;
  --text:#e8edf3; --muted:#98a7b7; --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --radius-sm:10px; --radius-lg:18px; --shadow:0 8px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.28);
  --container:1100px; --gap:12px; --pad:18px; --focus:0 0 0 2px rgba(212,175,55,0.2);
  --bp-s:520px; --bp-m:760px; --bp-l:900px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
             linear-gradient(180deg, #0b0f14, #0b0f14);
  font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect width="100" height="100" fill="%23d4af37"/></svg>') center/cover no-repeat;
  filter:brightness(0.45) saturate(0.9) blur(2px);
}
.container{max-width:var(--container); margin:0 auto; padding:24px 16px 80px}
.site-header{position:sticky; top:0; z-index:10; background:rgba(11,15,20,.8); border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:var(--shadow-sm); font-weight:800; color:#ffe084}
.title{font-family:"Noto Serif SC",serif; font-weight:700; letter-spacing:0.02em; font-size:1.1rem}
.now{font-size:.9rem; color:var(--muted)}

.section{margin-top:18px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); padding:var(--pad); margin:16px 0}
.h2{font-size:1.2rem; margin:0 0 12px 0; font-weight:800; color:#ffe084; display:flex; gap:8px; align-items:center}
.h2::before{content:""; width:4px; height:18px; background:var(--brand); border-radius:2px}
.row{display:grid; gap:var(--gap); grid-template-columns:1fr}
@media (min-width:760px){ .row.cols-3{grid-template-columns:1fr 1fr 1fr} .row.cols-2{grid-template-columns:1fr 1fr} }
input,select{width:100%; border-radius:12px; border:1px solid #243244; background:var(--bg-accent); color:var(--text); padding:12px 12px; font-size:15px; outline:0}
input::placeholder{color:#6f8092}
input:focus,select:focus{box-shadow:var(--focus); border-color:#3a4c63}
.btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:12px; border:1px solid #e6c76e; background:linear-gradient(180deg,#fff9e6,#e6c76e); color:#191919; font-weight:800; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(230,199,110,.5)}
.btn[disabled]{opacity:.6; cursor:not-allowed}
.btn.ghost{background:transparent; color:var(--gold2); border:1px solid rgba(212,175,55,.45); box-shadow:none}
.btn.block{display:block; width:100%}
.pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px}
.pillar{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:14px 10px; text-align:center}
.pillar .tit{color:#9aa3b2; font-size:0.85rem; margin-bottom:6px}
.pillar .gz{font-size:1.5rem; font-weight:800; color:var(--gold2)}
@media (max-width:520px){ .pillars{grid-template-columns:repeat(2,1fr)} }
.bazi-table{width:100%; border-collapse:collapse; margin-top:12px; background:var(--surface); border-radius:8px; overflow:hidden}
.bazi-table th,.bazi-table td{padding:10px 12px; border:1px solid #253245; text-align:center; vertical-align:middle}
.bazi-table th{background:rgba(212,175,55,.1); color:var(--gold2)}
.bazi-table-wrap{overflow:auto}
@media (max-width:420px){ .bazi-table th,.bazi-table td{padding:8px 10px} }
.bar{height:10px; background:#0d1420; border:1px solid #233146; border-radius:999px; overflow:hidden; margin:6px 0}
.bar i{display:block; height:100%; background:linear-gradient(90deg,#ffe084,#f2d27a); width:0%; transition:width 0.5s ease}
.bar-row{display:grid; grid-template-columns:80px 1fr 60px; gap:10px; align-items:center}
.error-message{background:rgba(255,90,95,.1); border:1px solid #ff5a5f; border-radius:8px; padding:10px; display:none; margin-top:10px}
.muted{color:var(--muted)}
.time-row{display:flex; align-items:center; gap:10px}
.time-row .time-unknown{display:flex; align-items:center; gap:6px; white-space:nowrap}
.time-row input[type="time"]{width:auto !important; flex:0 0 160px; min-width:140px}
.gen-wrap{display:flex; align-items:flex-end; justify-content:flex-end}
#genBtn{width:auto !important}
.analysis-grid{display:grid; gap:16px; margin-top:20px}
.analysis-card{background:var(--surface); border:1px solid #253245; border-radius:12px; padding:16px}
.analysis-card h3{color:var(--gold2); margin:0 0 12px 0; font-size:1.1rem}
.analysis-content{line-height:1.6}
.columns{display:grid; gap:12px; grid-template-columns:1fr}
@media (min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
.list-block{border:1px solid #263448; background:var(--bg-accent); border-radius:12px; padding:16px}
.list-block ul{margin:0.2rem 0 0 0; padding-left:1.1rem}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px}
.astro-auth{max-width:980px; margin:28px auto; padding:20px 18px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,.35)}
.auth-grid{display:grid; gap:18px; grid-template-columns:1.2fr .8fr}
@media (max-width:860px){ .auth-grid{grid-template-columns:1fr} }
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(212,175,55,.22); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel .head{padding:16px 18px; border-bottom:1px solid rgba(212,175,55,.22); color:var(--gold); font-weight:700; letter-spacing:0.3px}
.panel .body{padding:18px}
.spacer{height:12px}

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}    

/* form focus simplification */
input:focus,select:focus,textarea:focus{outline:none!important; box-shadow:none!important; border-color:#243244!important}
button:focus,.btn:focus,a:focus{outline:none!important; box-shadow:none!important}
*{-webkit-tap-highlight-color:transparent}

footer{color:#6c7b8c; font-size:0.85rem; text-align:center; padding:30px 0; margin-top:40px}
@media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important} }
  </style>
</head>
<body>
<header class="site-header">
  <div class="head-inner container">
    <a class="brand" href="https://astro.5xliving.com/" target="_self">
      <span class="brand-badge">5X</span>
      <span class="title">5xLiving Â· å››æŸ±æ¨å‘½ã‚¯ã‚¤ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ</span>
    </a>
    <div style="display:flex; align-items:center; gap:10px;">
      <!-- Language selector -->
      <select id="langSelect" style="border-radius:999px; padding:6px 10px; border:1px solid #243244; background:#0e1520; color:#e8edf3; font-size:0.85rem;">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="th">à¹„à¸—à¸¢</option>
        <option value="ms">Bahasa Melayu</option>
      </select>

      <span id="nowBox" class="now"></span>
    </div>
  </div>
</header>

  <main class="container">
    <!-- Input card -->
    <section class="card">
      <div class="h2">å››æŸ±æ¨å‘½ Â· ã‚¯ã‚¤ãƒƒã‚¯é‘‘å®š</div>
      <div class="row cols-3">
        <div>
          <label class="muted">ãŠåå‰ï¼ˆä»»æ„ï¼‰</label>
          <input id="name" placeholder="å€‹åˆ¥è¡¨ç¤ºã®ãŸã‚ã®ãŠåå‰" />
        </div>
        <div>
          <label class="muted">æ€§åˆ¥</label>
          <select id="gender">
            <option value="">ç„¡å›ç­”</option>
            <option value="male">ç”·æ€§</option>
            <option value="female">å¥³æ€§</option>
          </select>
        </div>
        <div>
          <label class="muted">æš¦</label>
          <select id="calendar">
            <option value="gregorian">è¥¿æš¦</option>
            <option value="lunar">æ—§æš¦ï¼ˆæœªå¯¾å¿œï¼‰</option>
          </select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div>
          <label class="muted">ç”Ÿå¹´æœˆæ—¥</label>
          <input type="date" id="birthdate" />
        </div>
        <div>
          <label class="muted">å‡ºç”Ÿæ™‚åˆ»</label>
          <div class="time-row">
            <input type="time" id="birthtime" />
            <label class="muted time-unknown">
              <input type="checkbox" id="timeUnknown" />
              <span>æ™‚åˆ»ä¸æ˜</span>
            </label>
          </div>
        </div>
        <div class="gen-wrap">
          <button class="btn" id="genBtn" type="button">
            <span id="genBtnText">å‘½å¼ã‚’ä½œæˆ</span>
            <span id="genBtnLoading" style="display:none">è¨ˆç®—ä¸­...</span>
          </button>
        </div>
      </div>
      <div id="error" class="error-message"></div>
    </section>

    <!-- Result: pillars & elements -->
    <section id="result" style="display:none;">
      <div class="card">
        <div class="h2">ã‚ãªãŸã®å››æŸ±ï¼ˆå…«å­—ï¼‰ãƒãƒ£ãƒ¼ãƒˆ</div>
        <div class="pillars" id="bazi-pillars"></div>
        <div class="muted" id="bazi-date" style="margin-top:6px"></div>
        <table class="bazi-table">
          <thead>
          <tr>
            <th></th>
            <th>å¹´æŸ±</th>
            <th>æœˆæŸ±</th>
            <th>æ—¥æŸ±</th>
            <th>æ™‚æŸ±</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>å¤©å¹²</td>
            <td id="year-stem">-</td><td id="month-stem">-</td><td id="day-stem">-</td><td id="hour-stem">-</td>
          </tr>
          <tr>
            <td>åœ°æ”¯</td>
            <td id="year-branch">-</td><td id="month-branch">-</td><td id="day-branch">-</td><td id="hour-branch">-</td>
          </tr>
          <tr>
            <td>äº”è¡Œ</td>
            <td id="year-element">-</td><td id="month-element">-</td><td id="day-element">-</td><td id="hour-element">-</td>
          </tr>
          <tr>
            <td>ç´éŸ³</td>
            <td id="year-nayin">-</td><td id="month-nayin">-</td><td id="day-nayin">-</td><td id="hour-nayin">-</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="h2">äº”è¡Œãƒãƒ©ãƒ³ã‚¹è§£æ</div>
        <div class="bar-row"><span>æœ¨</span><div class="bar"><i id="bar-wood"></i></div><span id="pct-wood">0%</span></div>
        <div class="bar-row"><span>ç«</span><div class="bar"><i id="bar-fire"></i></div><span id="pct-fire">0%</span></div>
        <div class="bar-row"><span>åœŸ</span><div class="bar"><i id="bar-earth"></i></div><span id="pct-earth">0%</span></div>
        <div class="bar-row"><span>é‡‘</span><div class="bar"><i id="bar-metal"></i></div><span id="pct-metal">0%</span></div>
        <div class="bar-row"><span>æ°´</span><div class="bar"><i id="bar-water"></i></div><span id="pct-water">0%</span></div>
        <div id="bazi-elements-balance" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- VIP segment -->
    <section class="card section">
      <h2 class="group-title">ğŸŒ™ VIP ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title">ğŸ— å‘½ç†ã‚¹ãƒšãƒ¼ã‚¹ Â· ä¼šå“¡é™å®š</div>
          <ul>
            <li>æ‹æ„›ãƒ»çµå©šï¼šã”ç¸ã®å‚¾å‘ãƒ»ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚¿ã‚¤ãƒ—ãƒ»çµå©šã‚¿ã‚¤ãƒŸãƒ³ã‚°</li>
            <li>ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢ï¼šé©è·ãƒ»ç‹¬ç«‹ãƒ»å‰¯æ¥­ã®å¯èƒ½æ€§</li>
            <li>é‡‘é‹ï¼šè²¡ã®å…¥ã‚Šæ–¹ãƒ»è²¯è“„ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»é‹æ°—ã®æ³¢</li>
            <li>ãƒšãƒƒãƒˆã®å‘½å¼ï¼šæ€§æ ¼ãƒ»æ°—è³ªãƒ»ã‚ãªãŸã¨ã®ç›¸æ€§</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title">ğŸŒ™ å¿ƒæ€œã‚¹ãƒšãƒ¼ã‚¹ Â· ä¼šå“¡é™å®š</div>
          <ul>
            <li>ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«è¨˜éŒ²ï¼šå†™çœŸãƒ»å¤¢ãƒ»ãƒœã‚¤ã‚¹ãƒ¡ãƒ¢ãƒ»ç¥ˆã‚Šã®è¨€è‘‰ã‚’ä¿å­˜</li>
            <li>è¬›åº§ï¼šå››æŸ±æ¨å‘½ / ã‚¿ãƒ­ãƒƒãƒˆ / è¥¿æ´‹å æ˜Ÿè¡“ / æ•°ç§˜è¡“ ãªã©</li>
            <li>å®¶æ—ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ï¼šã”å…ˆç¥–ãƒ»æ•…äººã®è¨˜æ†¶ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</li>
            <li>æ¯é€±ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¯ãƒ¼ã‚¯ &amp; ç¥æ§˜ã‚¹ã‚¿ã‚¤ãƒ«ã®å®Ÿè·µã‚¿ã‚¹ã‚¯</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px">ğŸ’ VIP ãƒ­ã‚°ã‚¤ãƒ³</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</div>
            <div class="body">
              <div class="row one">
                <button class="btn ghost block" id="toggleAuthFields" type="button">
                  ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ / ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                </button>
              </div>
              <div class="spacer"></div>
              <div class="row" id="authFields" style="display:none;">
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šãƒ»å¤§å°è‹±å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ï¼‰">
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>
                <div class="muted">ç™»éŒ²ã™ã‚‹ã¨ã€å‘½ç†ã‚µãƒ¼ãƒ“ã‚¹ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’ 1 å›å—ã‘å–ã‚Œã¾ã™ã€‚</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head">ä¼šå“¡ã‚µãƒ¼ãƒ“ã‚¹</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer">
                  ğŸ’ æœˆé¡ VIP ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                </a>
              </div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer">
                  â† Astro ã‚·ãƒ§ãƒƒãƒ—ã«æˆ»ã‚‹
                </a>
              </div>
              <div class="muted">æœˆé¡ 9.9 ãƒ‰ãƒ« Â· å‘½ç†ã‚¹ãƒšãƒ¼ã‚¹ + å¿ƒæ€œã‚¹ãƒšãƒ¼ã‚¹ + ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«è¬›åº§</div>
            </div>
          </div>
        </div>
      </section>
    </section>

<footer data-i18n="footer.copy">Â© 5XLiving â€¢ ã‚¢ã‚¹ãƒˆãƒ­ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª</footer>
</main>

<!-- Xinlian Butler Â· GPT (Unified Floating Chat) -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat.toggle">è³ªå•</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPT</div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- Chat messages are appended by JS -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- Input -->
  <div class="ss-chat-input">
    <input id="chatInput" placeholder="è³ªå•ã‚’å…¥åŠ›â€¦" data-i18n-ph="chat.placeholder" />
    <button class="btn" id="chatSend" data-i18n="chat.send">é€ä¿¡</button>
  </div>
</div>
<script src="/assets/bazi-language-pack/lang-switch.js"></script>
<script>
(() => {
  'use strict';

  /* ===================== BASIC HELPERS ===================== */
  const SG_TZ = 'Asia/Singapore';
  const $id = (id) => document.getElementById(id);
  const $ = $id;

  const deepGet = (obj, path) => {
    if (!obj || !path) return undefined;
    const parts = String(path).split(".");
    let cur = obj;
    for (const p of parts) { if (!cur) return undefined; cur = cur[p]; }
    return cur;
  };

  /* ===================== CONFIG ===================== */
  const API_BASE = "https://throbbing-lab-1440.hello5xliving.workers.dev";
  const CHAT_ENDPOINT = "/api/chat";
  const LANG_KEY = "5x_lang";

  const state = (window.state = window.state || {});
  state.lang = 'ja';                 // âœ… This page is locked to Japanese
  try { localStorage.setItem(LANG_KEY, 'ja'); } catch {}

  /* ===================== I18N (JA ONLY) ===================== */
  window.I18N = window.I18N || {};
  const I18N = window.I18N;

  I18N['ja'] = Object.assign({}, I18N['ja'] || {}, {
    action:{
      weekly:'é€±é–“',
      energy:'ã‚¨ãƒãƒ«ã‚®ãƒ¼å®Ÿè·µ',
      career:'ã‚­ãƒ£ãƒªã‚¢æˆ¦ç•¥ï¼šå …å®Ÿã«é€²ã‚ã€æˆæœã‚’ä¸€ç‚¹é›†ä¸­ã§å‡ºã™',
      career2:'ç¶™ç¶šã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼†æŒ¯ã‚Šè¿”ã‚Šï¼ˆç›®æ¨™â†’é€±è¨ˆç”»â†’ãƒ¬ãƒ“ãƒ¥ãƒ¼â†’æ”¹å–„ï¼‰',
      relationship:'äººé–“é–¢ä¿‚ï¼šç‡ç›´ãªå¯¾è©±ã€å¢ƒç•Œç·šã€é©åˆ‡ãªè¿”ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°',
      wealth:'ãŠé‡‘ï¼šäºˆç®—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã€ã‚¹ã‚­ãƒ«åç›ŠåŒ–ã€ãƒªã‚¹ã‚¯ç®¡ç†'
    },
    brand:{ subtitle:'5xLiving Â· å…«å­—ã‚¯ã‚¤ãƒƒã‚¯é‘‘å®š' },

    app:{ title:'å…«å­— Â· ã‚¯ã‚¤ãƒƒã‚¯å‘½ç›¤' },
    form:{
      nameLabel:'ãŠåå‰ï¼ˆä»»æ„ï¼‰',
      namePlaceholder:'å‘¼ã³æ–¹ï¼ˆä»»æ„ï¼šå›ç­”ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºç”¨ï¼‰',
      genderLabel:'æ€§åˆ¥',
      gender:{ hidden:'å›ç­”ã—ãªã„', male:'ç”·æ€§', female:'å¥³æ€§' },
      calendarLabel:'æš¦',
      calendar:{ gregorian:'è¥¿æš¦ï¼ˆå¤ªé™½æš¦ï¼‰', lunar:'æ—§æš¦ï¼ˆå¤ªé™°æš¦ï¼‰' },
      birthdateLabel:'ç”Ÿå¹´æœˆæ—¥',
      birthtimeLabel:'å‡ºç”Ÿæ™‚åˆ»',
      timeUnknown:'å‡ºç”Ÿæ™‚é–“ä¸æ˜'
    },

    btn:{ generate:'å…«å­—ã‚’ç”Ÿæˆ', loading:'è¨ˆç®—ä¸­â€¦' },
    result:{ title:'ã‚ãªãŸã®å…«å­—ï¼ˆå››æŸ±ï¼‰' },
    pillar:{ year:'å¹´æŸ±', month:'æœˆæŸ±', day:'æ—¥æŸ±', hour:'æ™‚æŸ±' },
    table:{ row:{ stem:'å¤©å¹²', branch:'åœ°æ”¯', fiveElem:'äº”è¡Œ', nayin:'ç´éŸ³' } },
    energy:{ title:'äº”è¡Œãƒãƒ©ãƒ³ã‚¹' },
    elem:{ wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´', month:'æœˆ', fiveElements:'äº”è¡Œ' },

    chat_title:'å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPT',
    pro:{
      title:'å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· ãƒ—ãƒ­é‘‘å®š',
      welcome:'ã“ã‚“ã«ã¡ã¯ã€‚å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPTã§ã™ã€‚ã¾ãšå‘½ç›¤ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰ã€ä»•äº‹ãƒ»æ‹æ„›ãƒ»é‡‘é‹ãƒ»å¥åº·ãªã©ã‚’è³ªå•ã—ã¦ãã ã•ã„ã€‚'
    },
    chat:{ send:'é€ä¿¡', placeholder:'è³ªå•ã‚’å…¥åŠ›â€¦', toggle:'è³ªå•' },

    vip:{
      title:'VIPã‚¨ãƒªã‚¢',
      group:{ astrology:'å…«å­—ã‚¹ãƒšãƒ¼ã‚¹', spiritual:'ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª' },
      astrology:{
        match:'æ‹æ„›ï¼†çµå©šï¼šç›¸æ€§ã¨è¦‹é€šã—',
        career:'ã‚­ãƒ£ãƒªã‚¢ï¼šæ˜‡é€²ãƒ»è»¢è·ãƒ»èµ·æ¥­',
        wealth:'é‡‘é‹ï¼šæ–¹å‘æ€§ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°',
        pet:'ãƒšãƒƒãƒˆé‘‘å®šï¼šæ€§æ ¼ã¨çµ†'
      },
      spiritual:{
        record:'ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«æ—¥è¨˜ï¼šå†™çœŸãƒ»å¤¢ãƒ»éŸ³å£°ãƒ»ç¥ˆã‚Š',
        courses:'è¬›åº§ï¼šå…«å­—ï¼ã‚¿ãƒ­ãƒƒãƒˆï¼å æ˜Ÿè¡“ï¼æ•°ç§˜è¡“',
        family:'å®¶æ—ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ãƒ»ã‚·ã‚¹ãƒ†ãƒ ',
        practice:'é€±é–“ã®å®Ÿè·µï¼å„€å¼ã‚¿ã‚¹ã‚¯'
      },
      login:{ title:'VIPãƒ­ã‚°ã‚¤ãƒ³' },
      services:{ header:'ä¼šå“¡ã‚µãƒ¼ãƒ“ã‚¹' },
      upgrade:'VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆæœˆé¡ï¼‰',
      back:'â† ã‚¹ãƒˆã‚¢ã¸æˆ»ã‚‹',
      priceNote:'æœˆé¡ $9.9ï¼ˆå…«å­—ã‚¹ãƒšãƒ¼ã‚¹ï¼‹ã‚½ã‚¦ãƒ«ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒªï¼‹å…¨è¬›åº§ï¼‰'
    },

    auth:{
      header:'ãƒ­ã‚°ã‚¤ãƒ³ï¼ç™»éŒ²',
      login:'ãƒ­ã‚°ã‚¤ãƒ³',
      reset:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š',
      register:'æ–°è¦ç™»éŒ²',
      freeTrialNote:'ç™»éŒ²ã§ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«1å›',
      emailPlaceholder:'ãƒ¡ãƒ¼ãƒ«',
      passwordPlaceholder:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼šå¤§/å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚€ï¼‰'
    },

    footer:{ copy:'Â© 5XLiving â€¢ ã‚¢ã‚¹ãƒˆãƒ­ãƒ»ã‚µãƒ³ã‚¯ãƒãƒ¥ã‚¢ãƒª' },

    err:{
      fillBirthdate:'ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
      invalidDate:'å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚YYYY-MM-DDã§å…¥åŠ›ã—ã¦ãã ã•ã„',
      generateFail:'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
    },

    ui:{
      timeUnknown:'å‡ºç”Ÿæ™‚é–“ä¸æ˜',
      hourSuffix:'{hh}:{mm}',
      birthSummary:'å‡ºç”Ÿï¼š{y}-{m}-{d} {timeText}',
      balance:'æœ€ã‚‚å¼·ã„ï¼š{strongest}ã€‚æœ€ã‚‚å¼±ã„ï¼š{weakest}ã€‚'
    },

    badge:{ noHour:'æ™‚æŸ±ãªã—' },

    report:{
      hourUnknownTip:'æ³¨æ„ï¼šå‡ºç”Ÿæ™‚é–“ãŒä¸æ˜ã®ãŸã‚ã€ä¸€éƒ¨ã®è§£é‡ˆã¯å‚è€ƒç¨‹åº¦ã«ãªã‚Šã¾ã™ã€‚',
      tipTitle:'ãƒ’ãƒ³ãƒˆ',
      generating:'ãƒ—ãƒ­é‘‘å®šãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­â€¦',
      failed:'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
    },

    reportTitles:{
      overview:'å‘½ç›¤ã®æ¦‚è¦',
      fiveElements:'äº”è¡Œ',
      tenGods:'åç¥',
      useful:'å–œç”¨ã®æ–¹å‘',
      relationship:'æ‹æ„›ãƒ»äººé–“é–¢ä¿‚',
      career:'ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢',
      wealth:'é‡‘é‹',
      health:'å¥åº·',
      nearTerm:'ç›´è¿‘ã®æµã‚Œ',
      actions:'è¡Œå‹•ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ'
    },

    tenGodsNames:{
      biJian:'æ¯”è‚©ï¼ˆä»²é–“ãƒ»è‡ªç«‹ï¼‰',
      jieCai:'åŠ«è²¡ï¼ˆå¥ªã†ãƒ»ç«¶äº‰ï¼‰',
      shiShen:'é£Ÿç¥ï¼ˆè¡¨ç¾ãƒ»æ¥½ã—ã¿ï¼‰',
      shangGuan:'å‚·å®˜ï¼ˆçªç ´ãƒ»æ‰¹è©•ï¼‰',
      zhengCai:'æ­£è²¡ï¼ˆå®‰å®šåå…¥ï¼‰',
      pianCai:'åè²¡ï¼ˆãƒãƒ£ãƒ³ã‚¹è²¡ï¼‰',
      zhengGuan:'æ­£å®˜ï¼ˆç§©åºãƒ»è‚©æ›¸ï¼‰',
      qiSha:'ä¸ƒæ®ºï¼ˆåœ§åŠ›ãƒ»å®Ÿè¡Œï¼‰',
      zhengYin:'æ­£å°ï¼ˆå­¦ã³ãƒ»æ”¯æ´ï¼‰',
      pianYin:'åå°ï¼ˆç›´æ„Ÿãƒ»ç‹¬å­¦ï¼‰'
    },
    tenGodsHints:{
      biJian:'ä»²é–“ã€è‡ªå·±ç¢ºç«‹ã€å”åŠ›ã¨ç«¶äº‰ã€‚',
      jieCai:'å–ã‚Šåˆã„ï¼åˆ†ã‘åˆã„ã€‚è¡å‹•è²·ã„ã«æ³¨æ„ã€‚',
      shiShen:'ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã€å‰µä½œã€æ¥½ã—ã¿ã€‚è¡¨ç¾ã«å¼·ã„ã€‚',
      shangGuan:'é©æ–°ã¨æ‰¹è©•ã€‚æ¨©å¨ã¨ã®è¡çªã«æ³¨æ„ã€‚',
      zhengCai:'å®‰å®šåå…¥ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã€‚ã‚³ãƒ„ã‚³ãƒ„è“„ç©ã€‚',
      pianCai:'å‰¯åå…¥ãƒ»æ©Ÿä¼šã€‚ãƒªã‚¹ã‚¯ä¸Šé™ã‚’æ±ºã‚ã‚‹ã€‚',
      zhengGuan:'ãƒ«ãƒ¼ãƒ«ã€æ§‹é€ ã€åœ°ä½ã€ä¿¡ç”¨ã€‚',
      qiSha:'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã¨èª²é¡Œã€‚å®Ÿè¡ŒåŠ›ãŒå¼·ã„ãŒãƒãƒ©ãƒ³ã‚¹ãŒå¿…è¦ã€‚',
      zhengYin:'æ”¯æ´ã€å­¦ç¿’ã€ãƒ¡ãƒ³ã‚¿ãƒ¼ã€‚å®‰å®šã—ãŸè³‡æºã€‚',
      pianYin:'æ´å¯Ÿã¨ç‹¬è‡ªå­¦ç¿’ã€‚è€ƒãˆã™ãã«æ³¨æ„ã€‚'
    },

    reportLabels:{
      dayMaster:'æ—¥ä¸»',
      symbolise:'æ„å‘³',
      analysis:'åŠ©è¨€',
      suitableCareers:'é©è·é ˜åŸŸ',
      careerAdvice:'ã‚­ãƒ£ãƒªã‚¢åŠ©è¨€',
      favorableDirections:'å‰æ–¹ï¼ˆå‚è€ƒï¼‰',
      healthCharacteristics:'èº«ä½“ã®ãƒã‚¤ãƒ³ãƒˆ',
      healthTips:'å¥åº·ãƒ’ãƒ³ãƒˆ',
      wellnessAdvice:'ã‚¦ã‚§ãƒ«ãƒã‚¹',
      overallFortune:'ç·åˆã®æµã‚Œ',
      favorableTiming:'è‰¯ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°',
      cautions:'æ³¨æ„ç‚¹'
    },

    cautions:{ default:'æ„Ÿæƒ…ã§æ±ºã‚ãªã„ã€‚æ”¯å‡ºã‚’ç®¡ç†ã™ã‚‹ã€‚' },

    fortune:{
      upward:'ä¸Šæ˜‡æ°—æµï¼šéœ²å‡ºãƒ»ç™ºä¿¡ãƒ»æˆæœã«è¿½ã„é¢¨',
      focus:'é›†ä¸­ã¨æ•´å‚™ï¼šå®Ÿè¡Œãƒ»é‹ç”¨ã«å¼·ã„',
      study:'ã¾ãšèª¿æŸ»ï¼šä½œã£ã¦ã‹ã‚‰å‡ºã™',
      foundation:'åœŸå°å›ºã‚ï¼šä¸€å®šã®ãƒªã‚ºãƒ ã§ç©ã¿ä¸Šã’ã‚‹'
    },

    // Day Master lines
    'report.dayMaster.jia':'ç”²æœ¨ï¼šé–‹æ‹“è€…ã‚¿ã‚¤ãƒ—ã€‚å‰å‘ãã§ç²˜ã‚Šå¼·ã„ã€‚',
    'report.dayMaster.yi':'ä¹™æœ¨ï¼šã—ãªã‚„ã‹ã§æ€ã„ã‚„ã‚Šæ·±ã„ã€‚ç¶™ç¶šã§ä¼¸ã³ã‚‹ã€‚',
    'report.dayMaster.bing':'ä¸™ç«ï¼šæ˜ã‚‹ãè‡ªä¿¡å®¶ã€‚ä¸»å°ã™ã‚‹ã¨è¼ãã€‚',
    'report.dayMaster.ding':'ä¸ç«ï¼šç¹Šç´°ã§ç€å®Ÿã€‚ä¿¡é ¼ã¨æ·±ã„ç¸ã‚’å¤§åˆ‡ã«ã™ã‚‹ã€‚',
    'report.dayMaster.wu':'æˆŠåœŸï¼šç¾å®Ÿçš„ã§å®‰å®šå¿—å‘ã€‚åœŸå°ä½œã‚ŠãŒå¾—æ„ã€‚',
    'report.dayMaster.ji':'å·±åœŸï¼šä¸å¯§ã§æ”¯ãˆã‚‹åŠ›ã€‚è¨ˆç”»ã¨å®Ÿå‹™ã«å¼·ã„ã€‚',
    'report.dayMaster.geng':'åºšé‡‘ï¼šæ±ºæ–­ãŒæ—©ã„ã€‚æ„å¿—ã¨è¡Œå‹•åŠ›ãŒå¼·ã„ã€‚',
    'report.dayMaster.xin':'è¾›é‡‘ï¼šç²¾å¯†ã§ç­‹ãŒé€šã‚‹ã€‚å“è³ªã¨åŸºæº–ã‚’é‡è¦–ã€‚',
    'report.dayMaster.ren':'å£¬æ°´ï¼šæŸ”è»Ÿã§ç™ºæƒ³ãŒé€Ÿã„ã€‚è‡ªç”±ã‚’å¥½ã‚€ã€‚',
    'report.dayMaster.gui':'ç™¸æ°´ï¼šç¹Šç´°ã§ç²˜ã‚Šå¼·ã„ã€‚å†…é¢ã®æ¨é€²åŠ›ãŒå¼·ã„ãŒè€ƒãˆã™ãæ³¨æ„ã€‚',

    // Presets
    'report.marriage.stable':'é–¢ä¿‚ã¯å®‰å®šã—ã‚„ã™ãã€é•·æœŸã®ç´„æŸã‚’ç¯‰ãã‚„ã™ã„å‚¾å‘ã€‚',
    'report.marriage.experienced':'æ‹æ„›çµŒé¨“ãŒå¢—ãˆã‚„ã™ã„ã€‚ç›¸æ€§ã®è‰¯ã•ã‚’è¦‹æ¥µã‚ã¦é¸ã¶ã¨è‰¯ã„ã€‚',
    'report.marriage.default':'é•·æœŸé–¢ä¿‚ã¯ã€ãŠäº’ã„ã®åŠªåŠ›ã¨å¯¾è©±ãŒéµã€‚',

    'report.career.leadership':'ãƒªãƒ¼ãƒ€ãƒ¼è·ã‚„èµ·æ¥­ã«é©æ€§ã€‚ä»•çµ„ã¿ã¨ä¿¡ç”¨ã‚’ç©ã¿ä¸Šã’ã‚‹ã€‚',
    'report.career.business':'å•†å£²ãƒ»é‡‘èã«é©æ€§ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã¨è¦å¾‹ãŒé‡è¦ã€‚',
    'report.career.creative':'å‰µä½œãƒ»ãƒ†ãƒƒã‚¯ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã«é©æ€§ã€‚å®Ÿç¸¾ã¨ç¶™ç¶šç™ºä¿¡ãŒéµã€‚',
    'report.career.steady':'ä¸€æ­©ãšã¤ï¼šå°‚é–€æ€§ã‚’æ·±ã‚ã€è©•åˆ¤ã§ä¼¸ã°ã™ã€‚'
  });

  function t(path, lang = (window.state && window.state.lang) || 'ja') {
    const pack = (window.I18N && window.I18N[lang]) || {};
    const baseJA = (window.I18N && window.I18N['ja']) || {};

    let v = pack[path];
    if (v != null && v !== '') return v;

    v = deepGet(pack, path);
    if (v != null && v !== '') return v;

    v = baseJA[path];
    if (v != null && v !== '') return v;

    v = deepGet(baseJA, path);
    if (v != null && v !== '') return v;

    return '';
  }
  window.t = t;

  function applyI18n(){
    const lang = state.lang || 'ja';
    document.documentElement.lang = lang;

    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      if (typeof val === 'string' && val !== '') el.textContent = val;
    });

    const setPh = (id, value) => { const el=$(id); if (el && typeof value === 'string' && value) el.placeholder = value; };
    setPh('name', t('form.namePlaceholder'));
    setPh('chatInput', t('chat.placeholder'));

    if (window.lastCtx && typeof window.buildProReport === 'function') window.buildProReport(window.lastCtx);
  }
  window.applyI18n = applyI18n;

  /* ===================== BAZI CALCULATOR ===================== */
  class BaziCalculator {
    constructor(){
      this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
      this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];

      // NaYin (Japanese)
      this.NAYIN=[
        'æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯å‚åœŸ','å‰£é‹’é‡‘',
        'å±±é ­ç«','æ¾—ä¸‹æ°´','åŸé ­åœŸ','ç™½è‹é‡‘','æ¥ŠæŸ³æœ¨',
        'æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é‚ç«','æ¾æŸæœ¨','é•·æµæ°´',
        'ç ‚ä¸­é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘',
        'è¦†ç¯ç«','å¤©æ²³æ°´','å¤§é§…åœŸ','é‡µé‡§é‡‘','æ¡‘æŸ˜æœ¨',
        'å¤§æ¸“æ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'
      ];
    }
    yearPillar(year){ const s=(year-4)%10, b=(year-4)%12; return {stem:this.HEAVENLY_STEMS[(s+10)%10], branch:this.EARTHLY_BRANCHES[(b+12)%12]}; }
    solarMonthIndex(y,m,d){
      const mmdd=m*100+d;
      const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
      let idx=11; for(const [thr,val] of gates){ if(mmdd>=thr) idx=val; }
      const branchBy={1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',11:'å­',12:'ä¸‘'};
      return {index:idx, branch:branchBy[idx]};
    }
    monthPillar(year,month,day){
      const {index,branch}=this.solarMonthIndex(year,month,day);
      const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
      const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
      const stemIdx=(startMap[yStemIdx]+(index-1))%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch};
    }
    dayPillar(year,month,day){
      const baseUTC=Date.UTC(1900,0,31), targetUTC=Date.UTC(year,month-1,day);
      const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
      const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
      return {stem:this.HEAVENLY_STEMS[(stemIdx+10)%10],branch:this.EARTHLY_BRANCHES[(branchIdx+12)%12]};
    }
    hourPillar(dayStem,hour){
      const branchMap={23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'};
      const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
      const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
      const hourIndex=Math.floor((hour+1)/2)%12;
      const stemIdx=(startMap[dayIdx]+hourIndex)%10;
      return {stem:this.HEAVENLY_STEMS[stemIdx], branch:branchMap[hour]};
    }
    stemElem(s){ return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[s]||'-'; }
    branchElem(b){ return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[b]||'-'; }
    nayin(s,b){ const si=this.HEAVENLY_STEMS.indexOf(s), bi=this.EARTHLY_BRANCHES.indexOf(b); return this.NAYIN[(si*2+bi)%this.NAYIN.length]; }
    tenGods(dayStem, stems){
      const map={
        'ç”²':{'ç”²':'æ¯”è‚©','ä¹™':'åŠ«è²¡','ä¸™':'é£Ÿç¥','ä¸':'å‚·å®˜','æˆŠ':'åè²¡','å·±':'æ­£è²¡','åºš':'ä¸ƒæ®º','è¾›':'æ­£å®˜','å£¬':'åå°','ç™¸':'æ­£å°'},
        'ä¹™':{'ç”²':'åŠ«è²¡','ä¹™':'æ¯”è‚©','ä¸™':'å‚·å®˜','ä¸':'é£Ÿç¥','æˆŠ':'æ­£è²¡','å·±':'åè²¡','åºš':'æ­£å®˜','è¾›':'ä¸ƒæ®º','å£¬':'æ­£å°','ç™¸':'åå°'},
        'ä¸™':{'ç”²':'åå°','ä¹™':'æ­£å°','ä¸™':'æ¯”è‚©','ä¸':'åŠ«è²¡','æˆŠ':'é£Ÿç¥','å·±':'å‚·å®˜','åºš':'åè²¡','è¾›':'æ­£è²¡','å£¬':'ä¸ƒæ®º','ç™¸':'æ­£å®˜'},
        'ä¸':{'ç”²':'æ­£å°','ä¹™':'åå°','ä¸™':'åŠ«è²¡','ä¸':'æ¯”è‚©','æˆŠ':'å‚·å®˜','å·±':'é£Ÿç¥','åºš':'æ­£è²¡','è¾›':'åè²¡','å£¬':'æ­£å®˜','ç™¸':'ä¸ƒæ®º'},
        'æˆŠ':{'ç”²':'ä¸ƒæ®º','ä¹™':'æ­£å®˜','ä¸™':'åå°','ä¸':'æ­£å°','æˆŠ':'æ¯”è‚©','å·±':'åŠ«è²¡','åºš':'é£Ÿç¥','è¾›':'å‚·å®˜','å£¬':'åè²¡','ç™¸':'æ­£è²¡'},
        'å·±':{'ç”²':'æ­£å®˜','ä¹™':'ä¸ƒæ®º','ä¸™':'æ­£å°','ä¸':'åå°','æˆŠ':'åŠ«è²¡','å·±':'æ¯”è‚©','åºš':'å‚·å®˜','è¾›':'é£Ÿç¥','å£¬':'æ­£è²¡','ç™¸':'åè²¡'},
        'åºš':{'ç”²':'åè²¡','ä¹™':'æ­£è²¡','ä¸™':'ä¸ƒæ®º','ä¸':'æ­£å®˜','æˆŠ':'åå°','å·±':'æ­£å°','åºš':'æ¯”è‚©','è¾›':'åŠ«è²¡','å£¬':'é£Ÿç¥','ç™¸':'å‚·å®˜'},
        'è¾›':{'ç”²':'æ­£è²¡','ä¹™':'åè²¡','ä¸™':'æ­£å®˜','ä¸':'ä¸ƒæ®º','æˆŠ':'æ­£å°','å·±':'åå°','åºš':'åŠ«è²¡','è¾›':'æ¯”è‚©','å£¬':'å‚·å®˜','ç™¸':'é£Ÿç¥'},
        'å£¬':{'ç”²':'é£Ÿç¥','ä¹™':'å‚·å®˜','ä¸™':'åè²¡','ä¸':'æ­£è²¡','æˆŠ':'ä¸ƒæ®º','å·±':'æ­£å®˜','åºš':'åå°','è¾›':'æ­£å°','å£¬':'æ¯”è‚©','ç™¸':'åŠ«è²¡'},
        'ç™¸':{'ç”²':'å‚·å®˜','ä¹™':'é£Ÿç¥','ä¸™':'æ­£è²¡','ä¸':'åè²¡','æˆŠ':'æ­£å®˜','å·±':'ä¸ƒæ®º','åºš':'æ­£å°','è¾›':'åå°','å£¬':'åŠ«è²¡','ç™¸':'æ¯”è‚©'}
      };
      const m=map[dayStem]||{};
      return stems.map(s=>m[s]||'-');
    }
  }

  /* ===================== ANALYSIS HELPERS ===================== */
  function stemToPinyin(stem){
    const map = {'ç”²':'jia','ä¹™':'yi','ä¸™':'bing','ä¸':'ding','æˆŠ':'wu','å·±':'ji','åºš':'geng','è¾›':'xin','å£¬':'ren','ç™¸':'gui'};
    return map[stem] || String(stem).toLowerCase();
  }

  const BaziAnalysis = {
    dayMasterLine(stem){ return t('report.dayMaster.'+stemToPinyin(stem)) || ''; },

    relation(dayStem){
      const dict={
        'ç”²':{traits:'æ‹æ„›ã§ã¯ä¸»å°ã—ã‚„ã™ã„ã‚¿ã‚¤ãƒ—ã€‚ç›¸æ‰‹ã®ä½™ç™½ã‚‚å¤§åˆ‡ã«ã€‚',tips:'ã¾ãšè´ã„ã¦ã‹ã‚‰è¿”ã™ã€‚å¯¾è©±ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã€‚'},
        'ä¹™':{traits:'å„ªã—ãç¹Šç´°ã€‚å®‰å®šã—ãŸå®‰å¿ƒæ„ŸãŒå¿…è¦ã€‚ä¾å­˜ã—ã™ãã«æ³¨æ„ã€‚',tips:'è‡ªä¿¡ã‚’è‚²ã¦ã€å¿…è¦ã‚’è¨€è‘‰ã§ä¼ãˆã‚‹ã€‚'},
        'ä¸™':{traits:'æƒ…ç†±çš„ã§è¡¨ç¾ãŒå¼·ã„ã€‚æ„Ÿæƒ…ãŒä¸ŠãŒã‚‹ã¨è¡å‹•çš„ã«ãªã‚Šã‚„ã™ã„ã€‚',tips:'åå¿œã™ã‚‹å‰ã«ä¸€å‘¼å¸ã€‚è¨€è‘‰ã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é¸ã¶ã€‚'},
        'ä¸':{traits:'ä¸€é€”ã§çŒ®èº«çš„ã€‚ã‚¹ãƒˆãƒ¬ã‚¹æ™‚ã«è€ƒãˆã™ãã‚„ç–‘å¿ƒãŒå‡ºã‚„ã™ã„ã€‚',tips:'ä¿¡é ¼ã®ç·´ç¿’ã€‚éåº¦ãªæ†¶æ¸¬ã‚’æ¸›ã‚‰ã™ã€‚'},
        'æˆŠ':{traits:'ç¾å®Ÿçš„ã§å®‰å®šå¿—å‘ã€‚å®‰å¿ƒã‚’é‡è¦–ã™ã‚‹ãŒâ€œå …ã„â€å°è±¡ã«ãªã‚Šã‚„ã™ã„ã€‚',tips:'æ¸©ã‹ã•ã¨ãƒ­ãƒãƒ³ã‚’æ„è­˜ã—ã¦è¡¨ç¾ã™ã‚‹ã€‚'},
        'å·±':{traits:'æ°—é…ã‚Šä¸Šæ‰‹ã€‚ã¨ãã«å®‰å¿ƒæ„Ÿä¸è¶³ã‚’æ„Ÿã˜ã‚„ã™ã„ã€‚',tips:'ç¿’æ…£ã¨ç´„æŸã§å®‰å¿ƒã‚’ä½œã‚‹ã€‚'},
        'åºš':{traits:'ç‡ç›´ã§æ±ºæ–­ãŒæ—©ã„ã€‚æ›–æ˜§ã•ãŒè‹¦æ‰‹ã€‚ç›¸æ‰‹ã®æ°—æŒã¡ã«é…æ…®ã‚’ã€‚',tips:'æ­£ç›´ã•ã¯ä¿ã¡ã¤ã¤ã€è¨€ã„æ–¹ã¨é€Ÿåº¦ã‚’æŸ”ã‚‰ã‹ãã€‚'},
        'è¾›':{traits:'åŸºæº–ãŒé«˜ãã€è³ªã‚’æ±‚ã‚ã‚‹ã€‚',tips:'å®Œç’§ã‚’æ±‚ã‚ã™ããšã€å…±ã«æˆé•·ã«ç„¦ç‚¹ã€‚'},
        'å£¬':{traits:'æ–°é®®ã•ã¨è‡ªç”±ãŒå¿…è¦ã€‚æ°—åˆ†ãŒå¤‰ã‚ã‚Šã‚„ã™ã„ã€‚',tips:'ç¿’æ…£ã¨å…±é€šã®æ¥½ã—ã¿ã§é–¢ä¿‚ã‚’å®‰å®šã•ã›ã‚‹ã€‚'},
        'ç™¸':{traits:'ç¹Šç´°ã§ç›´æ„Ÿçš„ã€‚åœ§ãŒã‹ã‹ã‚‹ã¨æ„Ÿæƒ…çš„ã«ãªã‚Šã‚„ã™ã„ã€‚',tips:'æ„Ÿæƒ…ã®æ•´ãˆæ–¹ã‚’è¦šãˆã‚‹ã€‚è¡çªã¯è½ã¡ç€ã„ã¦æ§‹é€ åŒ–ã€‚'}
      };
      return dict[dayStem]||{traits:'å…¨ä½“çš„ã«å …å®Ÿã€‚æ„è­˜çš„ãªã‚±ã‚¢ã§é–¢ä¿‚ãŒæ•´ã†ã€‚',tips:'ç›¸äº’å°Šé‡ã¨ç‡ç›´ãªå¯¾è©±ãŒéµã€‚'};
    },

    marriageAdvice(ten){
      if(ten.includes('æ­£å®˜')||ten.includes('æ­£è²¡')) return t('report.marriage.stable');
      if(ten.includes('ä¸ƒæ®º')||ten.includes('åè²¡')) return t('report.marriage.experienced');
      return t('report.marriage.default');
    },

    career(dayStem,ten){
      const map={
        ç”²:'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã€èµ·æ¥­ã€é‹ç”¨ãƒ»ç¾å ´ã€å»ºç¯‰ãƒ»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°',
        ä¹™:'æ•™è‚²ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚³ãƒ³ã‚µãƒ«ã€ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
        ä¸™:'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€å–¶æ¥­ã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€ã‚¨ãƒãƒ«ã‚®ãƒ¼é–¢é€£',
        ä¸:'ç ”ç©¶é–‹ç™ºï¼ITã€åŒ»ç™‚ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã€ç²¾å¯†ãƒ»è·äººç³»',
        æˆŠ:'é‡‘èã€ä¸å‹•ç”£ã€è³‡ç”£ãƒ»è³‡æºç®¡ç†',
        å·±:'äººäº‹ã€ã‚µãƒ¼ãƒ“ã‚¹æ¥­ã€äº‹å‹™ã€è¾²æ¥­é–¢é€£',
        åºš:'æ³•å‹™ã€æ©Ÿæ¢°ï¼å·¥å­¦ã€å®‰å…¨ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£',
        è¾›:'é‡‘èåˆ†æã€ç²¾å¯†æ©Ÿå™¨ã€ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼ï¼å®é£¾',
        å£¬:'è²¿æ˜“ãƒ»ç‰©æµã€æ—…è¡Œã€ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ç”£æ¥­',
        ç™¸:'ç ”ç©¶ã€å¿ƒç†ãƒ»ã‚³ãƒ¼ãƒãƒ³ã‚°ã€èŠ¸è¡“ãƒ»æ–‡ç« '
      };
      let adv = t('report.career.steady');
      if(ten.includes('æ­£å®˜')||ten.includes('ä¸ƒæ®º')) adv=t('report.career.leadership');
      else if(ten.includes('æ­£è²¡')||ten.includes('åè²¡')) adv=t('report.career.business');
      else if(ten.includes('é£Ÿç¥')||ten.includes('å‚·å®˜')) adv=t('report.career.creative');
      return { suitable: map[dayStem] || 'å …å®Ÿã«ã‚¹ã‚­ãƒ«ã‚’ç©ã¿ã€é•·æœŸã®ä¿¡ç”¨ã‚’è‚²ã¦ã‚‹ã€‚', advice: adv };
    },

    // Directions (reference)
    wealthDirs(dayStem){
      const dirs={
        ç”²:'æ±ï¼å—æ±',
        ä¹™:'æ±ï¼å—',
        ä¸™:'å—',
        ä¸:'å—ï¼å—è¥¿',
        æˆŠ:'ä¸­å¤®ï¼åœ°å…ƒ',
        å·±:'ä¸­å¤®ï¼åœ°å…ƒï¼å—è¥¿',
        åºš:'è¥¿ï¼åŒ—è¥¿',
        è¾›:'è¥¿ï¼åŒ—',
        å£¬:'åŒ—',
        ç™¸:'åŒ—ï¼æ±'
      };
      return dirs[dayStem] || '-';
    },

    health(dayStem){
      const c={
        ç”²:'è‚ãƒ»èƒ†ã€ç›®ã€è…±',
        ä¹™:'è‚æ©Ÿèƒ½ã¨æ„Ÿæƒ…ã®æ•´ãˆ',
        ä¸™:'å¿ƒè‡“ãƒ»è¡€æµã¨ç›®ã€‚æ„Ÿæƒ…ã®èµ·ä¼ã«æ³¨æ„',
        ä¸:'å¿ƒè‡“ãƒ»å¾ªç’°ã€‚ç¡çœ ã‚’å„ªå…ˆ',
        æˆŠ:'æ¶ˆåŒ–å™¨ã€‚é£Ÿäº‹ãƒªã‚ºãƒ ã‚’æ•´ãˆã‚‹',
        å·±:'æ¶ˆåŒ–ã¨çš®è†šã€‚è¡›ç”Ÿã¨ä¿æ¹¿',
        åºš:'å‘¼å¸å™¨ã¨å¤§è…¸ã€‚ä¹¾ç‡¥ã«æ³¨æ„',
        è¾›:'è‚ºãƒ»å‘¼å¸ã€‚ç©ºæ°—ç’°å¢ƒã‚’æ•´ãˆã‚‹',
        å£¬:'è…ãƒ»æ³Œå°¿ã€‚æ°´åˆ†ãƒãƒ©ãƒ³ã‚¹',
        ç™¸:'è…ãƒ»è†€èƒ±ã€‚éåŠ´ã«æ³¨æ„'
      };
      return c[dayStem] || 'å…¨ä½“ã¯ãƒãƒ©ãƒ³ã‚¹å‹ã€‚ç¡çœ ã¨ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’å®‰å®šã•ã›ã‚‹ã€‚';
    }
  };

  /* ===================== AI INSIGHT (UNCHANGED) ===================== */
  (function () {
    const LS_DOWN = 'ai:insight:downUntil';
    const now = () => Date.now();
    const downUntil = () => { try { return parseInt(localStorage.getItem(LS_DOWN)||'0',10)||0; } catch { return 0; } };
    const markDown = (ms = 180000) => { try { localStorage.setItem(LS_DOWN, String(now()+ms)); } catch {} };
    const clearDown = () => { try { localStorage.removeItem(LS_DOWN); } catch {} };

    async function fetchJSON(url, init={}, timeoutMs=15000){
      const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {...init, signal: ctrl.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function _aiExplain(section, ctx, {lang, temperature=0.7, seed=null}={}){
      if (!window.API_BASE) return null;
      const json = await fetchJSON(`${String(window.API_BASE).replace(/\/$/,'')}/bazi/insight`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ section, lang, temperature, seed, ctx })
      });
      if (json && (json.symbolise || json.analysis)) return json;
      return null;
    }

    window.aiExplain = async function (section, ctx, opts) {
      if (now() < downUntil()) return null;
      try {
        const out = await _aiExplain(section, ctx, opts||{});
        if (out) { clearDown(); return out; }
        markDown(); return null;
      } catch {
        markDown(); return null;
      }
    };

    window.injectAI = async function (section, symId, anaId, ctx, opts) {
      try {
        const out = await window.aiExplain(section, ctx, opts);
        if (!out) return;
        const $sym = document.getElementById(symId);
        const $ana = document.getElementById(anaId);
        if ($sym && out.symbolise) $sym.textContent = `${t('reportLabels.symbolise')}ï¼š${out.symbolise}`;
        if ($ana && out.analysis)  $ana.textContent = `${t('reportLabels.analysis')}ï¼š${out.analysis}`;
      } catch {}
    };

    window.forceAiInsightRetry = function () { try { localStorage.removeItem(LS_DOWN); } catch {} };
  })();

  /* ===================== RENDERERS ===================== */
  function renderPillars(labels){
    const titles=[t('pillar.year'),t('pillar.month'),t('pillar.day'),t('pillar.hour')];
    const box = $('bazi-pillars'); if(!box) return;
    box.innerHTML = labels.map((lab,i)=>`
      <div class="pillar"><div class="tit">${titles[i]}</div><div class="gz">${lab||'-'}</div></div>
    `).join('');
  }

  function renderTable(data){
    const keys=['year','month','day','hour'];
    const translateElem = (val)=>{
      const map = { 'æœ¨': t('elem.wood'), 'ç«': t('elem.fire'),'åœŸ': t('elem.earth'),'é‡‘': t('elem.metal'),'æ°´': t('elem.water') };
      return map[val] || val;
    };
    ['stem','branch','element','nayin'].forEach(row=>{
      keys.forEach((k, i)=>{
        const cell = $(k+'-'+row); if (!cell) return;
        let v = (Array.isArray(data[row]) ? data[row][i] : '-') ?? '-';
        if (row === 'element') v = translateElem(v);
        cell.textContent = v;
      });
    });
  }

  function renderBars(pcts){
    ['æœ¨','ç«','åœŸ','é‡‘','æ°´'].forEach(e=>{
      const pct=Math.max(0,Math.min(100,Math.round(pcts[e]||0)));
      const bar=$('bar-'+e), lab=$('pct-'+e);
      if(bar) bar.style.width=pct+'%';
      if(lab) lab.textContent=pct+'%';
    });
    const entries=Object.entries(pcts).sort((a,b)=>b[1]-a[1]);
    if(entries.length){
      const strongest = entries[0][0], weakest = entries.at(-1)[0];
      const mapName = {æœ¨:t('elem.wood'),ç«:t('elem.fire'),åœŸ:t('elem.earth'),é‡‘:t('elem.metal'),æ°´:t('elem.water')};
      const tpl = (t('ui.balance') || 'æœ€ã‚‚å¼·ã„ï¼š{strongest}ã€‚æœ€ã‚‚å¼±ã„ï¼š{weakest}ã€‚');
      const txt = tpl.replace('{strongest}', mapName[strongest]).replace('{weakest}', mapName[weakest]);
      const el=$('bazi-elements-balance'); if(el) el.textContent=txt;
    }
  }

  /* ===================== PRO REPORT (JA, 10 SECTIONS) ===================== */
  function supportElems(dm){
    const map = { ç”²:['æ°´','æœ¨'], ä¹™:['æ°´','æœ¨'], ä¸™:['æœ¨','ç«'], ä¸:['æœ¨','ç«'], æˆŠ:['ç«','åœŸ'], å·±:['ç«','åœŸ'], åºš:['åœŸ','é‡‘'], è¾›:['åœŸ','é‡‘'], å£¬:['é‡‘','æ°´'], ç™¸:['é‡‘','æ°´'] };
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function restrainElems(dm){
    const map = { ç”²:['é‡‘'], ä¹™:['é‡‘'], ä¸™:['æ°´'], ä¸:['æ°´'], æˆŠ:['æœ¨'], å·±:['æœ¨'], åºš:['ç«'], è¾›:['ç«'], å£¬:['åœŸ'], ç™¸:['åœŸ'] };
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return (map[dm]||[]).map(key);
  }
  function computeUseful(p){ // two weakest elements
    const arr = Object.entries({æœ¨:p.æœ¨||0,ç«:p.ç«||0,åœŸ:p.åœŸ||0,é‡‘:p.é‡‘||0,æ°´:p.æ°´||0})
      .sort((a,b)=>a[1]-b[1])
      .slice(0,2)
      .map(([k])=>k);
    const key = (x)=>({æœ¨:'elem.wood',ç«:'elem.fire',åœŸ:'elem.earth',é‡‘:'elem.metal',æ°´:'elem.water'})[x];
    return arr.map(key);
  }

  window.buildProReport = function buildProReport(ctx){
    const box = $('professionalReport');
    if (!box || !ctx) return;

    const dm = ctx.dayStem || '';
    const pctsCN = ctx.pcts || {};
    const ten = Array.isArray(ctx.tenGods) ? ctx.tenGods.filter(Boolean) : [];

    const elem = {
      Wood:  pctsCN['æœ¨'] || 0,
      Fire:  pctsCN['ç«'] || 0,
      Earth: pctsCN['åœŸ'] || 0,
      Metal: pctsCN['é‡‘'] || 0,
      Water: pctsCN['æ°´'] || 0,
    };

    function strongestWeakest(obj){
      const arr = Object.entries(obj || {});
      if (!arr.length) return { strongest:'', weakest:'' };
      arr.sort((a,b)=> b[1] - a[1]);
      return { strongest: arr[0][0], weakest: arr[arr.length - 1][0] };
    }

    const { strongest, weakest } = strongestWeakest(elem);
    const strongestLabel = strongest || '-';
    const weakestLabel   = weakest   || '-';

    const dmLine   = BaziAnalysis.dayMasterLine(dm) || 'æ—¥ä¸»ã®æ€§è³ªã¯ã€çŠ¶æ³ã«åˆã‚ã›ã¦é©å¿œã§ãã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚';
    const rel      = BaziAnalysis.relation(dm);
    const marriage = BaziAnalysis.marriageAdvice(ten);
    const career   = BaziAnalysis.career(dm, ten);
    const wealthDir= BaziAnalysis.wealthDirs(dm);
    const healthFo = BaziAnalysis.health(dm);

    const supportText  = supportElems(dm).map(k=>t(k)).filter(Boolean).join('ã€') || '-';
    const restrainText = restrainElems(dm).map(k=>t(k)).filter(Boolean).join('ã€') || '-';
    const usefulText   = computeUseful({ æœ¨:pctsCN['æœ¨']||0, ç«:pctsCN['ç«']||0, åœŸ:pctsCN['åœŸ']||0, é‡‘:pctsCN['é‡‘']||0, æ°´:pctsCN['æ°´']||0 })
      .map(k=>t(k)).filter(Boolean).join('ã€') || '-';

    const elemLine = `
      æœ¨: ${Math.round(elem.Wood)}% Â·
      ç«: ${Math.round(elem.Fire)}% Â·
      åœŸ: ${Math.round(elem.Earth)}% Â·
      é‡‘: ${Math.round(elem.Metal)}% Â·
      æ°´: ${Math.round(elem.Water)}%
    `.replace(/\s+/g,' ');

    let nearTermFocus  = t('fortune.foundation') || 'åœŸå°å›ºã‚ï¼šä¸€å®šã®ãƒªã‚ºãƒ ã§ç©ã¿ä¸Šã’ã‚‹';
    let nearTermAdvice = t('cautions.default')   || 'æ„Ÿæƒ…ã§æ±ºã‚ãªã„ã€‚æ”¯å‡ºã‚’ç®¡ç†ã™ã‚‹ã€‚';

    switch (strongest) {
      case 'Wood':
      case 'Fire':
        nearTermFocus  = t('fortune.upward') || 'ä¸Šæ˜‡æ°—æµï¼šéœ²å‡ºãƒ»ç™ºä¿¡ãƒ»æˆæœã«è¿½ã„é¢¨';
        nearTermAdvice = strongest === 'Wood'
          ? 'æ–°ã—ã„ã‚¹ã‚­ãƒ«ã‚’1ã¤å­¦ã³ã€äººè„ˆã‚’åºƒã’ã€é€±1ã§ä¸­æœŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰é€²ã•ã›ã‚‹ã€‚'
          : 'ææ¡ˆãƒ»äº¤æ¸‰ãƒ»ç™ºè¡¨ã«è¿½ã„é¢¨ã€‚è¡å‹•çš„ãªæ±ºæ–­ã¯é¿ã‘ã‚‹ã€‚';
        break;
      case 'Earth':
      case 'Metal':
        nearTermFocus  = t('fortune.focus') || 'é›†ä¸­ã¨æ•´å‚™ï¼šå®Ÿè¡Œãƒ»é‹ç”¨ã«å¼·ã„';
        nearTermAdvice = strongest === 'Earth'
          ? 'æ™‚é–“ã¨ãŠé‡‘ã‚’æ•´ç†ï¼šæœ€ã‚‚ãƒªã‚¿ãƒ¼ãƒ³ã®é«˜ã„1ã€œ2æ–¹å‘ã«é›†ä¸­ã™ã‚‹ã€‚'
          : 'ãƒ«ãƒ¼ãƒ«ãƒ»æ‰‹é †ãƒ»å¥‘ç´„ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§å®‰å®šåŒ–ã•ã›ã‚‹ã€‚';
        break;
      case 'Water':
        nearTermFocus  = t('fortune.study') || 'ã¾ãšèª¿æŸ»ï¼šä½œã£ã¦ã‹ã‚‰å‡ºã™';
        nearTermAdvice = 'ã¾ãšè¦³å¯Ÿã¨æ¯”è¼ƒã€‚å°ã•ãè©¦ã—ã¦ã‹ã‚‰å¤§ããæŠ•ä¸‹ã™ã‚‹ã€‚';
        break;
    }

    const title = {
      overview:     t('reportTitles.overview')     || 'å‘½ç›¤ã®æ¦‚è¦',
      fiveElements: t('reportTitles.fiveElements') || 'äº”è¡Œ',
      tenGods:      t('reportTitles.tenGods')      || 'åç¥',
      useful:       t('reportTitles.useful')       || 'å–œç”¨ã®æ–¹å‘',
      relation:     t('reportTitles.relationship') || 'æ‹æ„›ãƒ»äººé–“é–¢ä¿‚',
      career:       t('reportTitles.career')       || 'ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢',
      wealth:       t('reportTitles.wealth')       || 'é‡‘é‹',
      health:       t('reportTitles.health')       || 'å¥åº·',
      nearTerm:     t('reportTitles.nearTerm')     || 'ç›´è¿‘ã®æµã‚Œ',
      actions:      t('reportTitles.actions')      || 'è¡Œå‹•ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
    };

    const parts = [];

    parts.push(`
      <div class="butler-section">
        <h4>1. ${title.overview}</h4>
        <p><strong>${t('reportLabels.dayMaster') || 'æ—¥ä¸»'}:</strong> ${dm || '-'}</p>
        <p>${dmLine}</p>
        ${ctx.unknown ? `<p>${t('report.hourUnknownTip')}</p>` : ''}
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>2. ${title.fiveElements}</h4>
        <p>${elemLine}</p>
        <p><strong>æœ€ã‚‚å¼·ã„:</strong> ${strongestLabel} &nbsp;&nbsp; <strong>æœ€ã‚‚å¼±ã„:</strong> ${weakestLabel}</p>
        <p>
          å¼·ã„è¦ç´ ã¯ã€Œè‡ªç„¶ã¨ç™ºæ®ã§ãã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã€ã‚’ç¤ºã—ã¾ã™ã€‚
          å¼±ã„è¦ç´ ã¯é•·æœŸã®ä¼¸ã³ã—ã‚â€”â€”ä¸€æ°—ã«å¤‰ãˆãšã€å°‘ã—ãšã¤è‚²ã¦ã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>3. ${title.tenGods}</h4>
        <p>
          ã“ã®ã‚¯ã‚¤ãƒƒã‚¯ç‰ˆã§ã¯åç¥ã®å…¨ã¦ã‚’åˆ—æŒ™ã—ã¾ã›ã‚“ãŒã€ã‚ãªãŸã®æµã‚Œã®æ ¸ã¯
          <strong>è¡¨ç¾ãƒ»è³‡æºç®¡ç†ãƒ»è²¬ä»»</strong>ã®ãƒãƒ©ãƒ³ã‚¹ã§ã™ã€‚
        </p>
        <p>
          æ¶ˆè€—ã—ãŸæ™‚ã¯è‡ªå•ã—ã¦ãã ã•ã„ï¼šã€Œã“ã‚Œã¯èª°ã®ãŸã‚ï¼Ÿã€ ã€Œå¢ƒç•Œç·šã¯è¨€è‘‰ã§ä¼ãˆãŸï¼Ÿã€
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>4. ${title.useful}</h4>
        <p><strong>è£œã†ã¨ä¼¸ã³ã‚‹è¦ç´ :</strong> ${supportText}</p>
        <p><strong>æ•´ãˆã‚‹è¦ç´ :</strong> ${restrainText}</p>
        <p><strong>ä»Šã„ã¡ã°ã‚“è‚²ã¦ãŸã„è¦ç´ :</strong> ${usefulText}</p>
        <p>
          å–œç”¨ã¯ã€Œè‰²ãƒ»ç’°å¢ƒãƒ»ç¿’æ…£ãƒ»ä»•äº‹å†…å®¹ã€ã§å®Ÿå‹™çš„ã«å–ã‚Šå…¥ã‚Œã‚‹ã®ãŒã‚³ãƒ„ã€‚
          ã¾ãšã¯1ã¤ã®ç¿’æ…£ã‚’æ±ºã‚ã¦ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>5. ${title.relation}</h4>
        <p><strong>æ‹æ„›å‚¾å‘:</strong> ${rel.traits}</p>
        <p><strong>ã†ã¾ãã„ãã‚³ãƒ„:</strong> ${rel.tips}</p>
        <p><strong>çµå©šãƒ¡ãƒ¢:</strong> ${marriage}</p>
        <p>
          æ„›ã¯ãƒ­ãƒãƒ³ã‚¹ã ã‘ã§ã¯ãªãã€é•·æœŸã®å”åŠ›é–¢ä¿‚ã§ã™ã€‚
          å¢ƒç•Œç·šï¼‹ç‡ç›´ãªå¯¾è©±ï¼‹ç”Ÿæ´»ãƒªã‚ºãƒ ã®å®‰å®šã§ã€é–¢ä¿‚ã¯æ•´ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>6. ${title.career}</h4>
        <p><strong>${t('reportLabels.suitableCareers') || 'é©è·é ˜åŸŸ'}:</strong> ${career.suitable}</p>
        <p><strong>${t('reportLabels.careerAdvice') || 'ã‚­ãƒ£ãƒªã‚¢åŠ©è¨€'}:</strong> ${career.advice}</p>
        <p>
          ä¼¸ã³ã‚‹æˆ¦ç•¥ã¯ <strong>é•·æœŸã®æ·±ã•ï¼‹å°‚é–€ã®è©•åˆ¤</strong>ã€‚
          ã€Œãã®ãƒ†ãƒ¼ãƒãªã‚‰ã‚ãªãŸã€ã¨è¨€ã‚ã‚Œã‚‹ä¸€ç‚¹ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>7. ${title.wealth}</h4>
        <p><strong>${t('reportLabels.favorableDirections') || 'å‰æ–¹ï¼ˆå‚è€ƒï¼‰'}:</strong> ${wealthDir}</p>
        <p>
          é‡‘é‹ã¯ã€Œæ©Ÿä¼šã€ã ã‘ã§ãªãã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã®è¦å¾‹ã¨ãƒªã‚¹ã‚¯æ„Ÿè¦šã§ã™ã€‚
          ã¾ãšä¸»åå…¥ã‚’å®‰å®šã•ã›ã€ãã®å¾Œã«é«˜ãƒªã‚¹ã‚¯ã®ä¸Šé™ï¼ˆæå¤±ãƒ©ã‚¤ãƒ³ï¼‰ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ã€‚
        </p>
        <p>
          æœ€ã‚‚æŒç¶šã™ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼šã‚¹ã‚­ãƒ«Ã—ä¿¡é ¼ã§åå…¥ã‚’ä¼¸ã°ã—ã€
          ãã®å¾Œã«å¼·ã¿ã¨ä¸€è‡´ã™ã‚‹å‰¯åå…¥ã‚’è¶³ã™ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>8. ${title.health}</h4>
        <p><strong>${t('reportLabels.healthCharacteristics') || 'èº«ä½“ã®ãƒã‚¤ãƒ³ãƒˆ'}:</strong> ${healthFo}</p>
        <p>
          å¥åº·ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼šç¡çœ ã®å®‰å®šã€è»½ã„é‹å‹•ã€é£Ÿã¹éãã‚’é¿ã‘ã‚‹ã€‚
          æ„Ÿæƒ…ã®å‡ºå£ã‚’1ã¤ï¼ˆè¨˜éŒ²ã€æ•£æ­©ã€ç‘æƒ³ã€ç¥ˆã‚Šç­‰ï¼‰æŒã¤ã¨æ•´ã„ã¾ã™ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>9. ${title.nearTerm}</h4>
        <p><strong>ä¸»ãƒ†ãƒ¼ãƒ:</strong> ${nearTermFocus}</p>
        <p><strong>${t('reportLabels.analysis') || 'åŠ©è¨€'}:</strong> ${nearTermAdvice}</p>
        <p>
          ç‰©äº‹ãŒæ•£ã‚‰ã‹ã£ãŸã‚‰ã€æ–°è¦ã‚’å¢—ã‚„ã™å‰ã«æ•´ç†ã€‚
          é‡è¦åº¦ã§ä¸¦ã¹æ›¿ãˆã€å›å¾©ã®ä½™ç™½ã‚’ç¢ºä¿ã—ã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>
    `);

    parts.push(`
      <div class="butler-section">
        <h4>10. ${title.actions}</h4>
        <ul class="action-list">
          <li>30æ—¥ä»¥å†…ã«æœ€é‡è¦ç›®æ¨™ã‚’1ã¤æ±ºã‚ã‚‹ï¼ˆä»•äº‹ï¼ãŠé‡‘ï¼å¥åº·ï¼‰ã€‚æ¯æ—¥è¦‹ãˆã‚‹å ´æ‰€ã«æ›¸ãã€‚</li>
          <li>é€±1å›ã€æ°—åˆ†ã§ã¯ãªãã€Œå®Ÿç¸¾ã€ã§æŒ¯ã‚Šè¿”ã‚Šã€æ¬¡é€±ã®è¨ˆç”»ã‚’å¾®èª¿æ•´ã™ã‚‹ã€‚</li>
          <li>å¼·ã„è¦ç´ ï¼ˆ${strongestLabel}ï¼‰ã‚’ã€ç’°å¢ƒãƒ»ç¿’æ…£ãƒ»äººé¸ã§æ´»ã‹ã™ã€‚</li>
          <li>å¼±ã„è¦ç´ ï¼ˆ${weakestLabel}ï¼‰ã¯ã€é€±1ã€œ2å€‹ã®å°ç¿’æ…£ã§è‚²ã¦ã‚‹ã€‚ç¶™ç¶šãŒå‹ã¡ã€‚</li>
        </ul>
      </div>
    `);

    box.innerHTML = parts.join('\n');
    const sec = $('butlerProfessional');
    if (sec) sec.style.display = 'block';
  };

  /* ===================== GENERATE + UI ===================== */
  function showErr(msg){
    const box=$('error'); if(!box) return;
    box.textContent = msg || t('err.generateFail');
    box.style.display='block';
    setTimeout(()=>{ box.style.display='none'; }, 4000);
  }
  function setGenLoading(v){
    const btn=$('genBtn'), txt=$('genBtnText'), ld=$('genBtnLoading');
    if(btn) btn.disabled=!!v;
    if(txt) txt.style.display=v?'none':'inline';
    if(ld) ld.style.display=v?'inline':'none';
  }

  function generate(){
    const birth = ($('birthdate')?.value||'').trim();
    if(!birth) return showErr(t('err.fillBirthdate'));
    if(!/^\d{4}-\d{2}-\d{2}$/.test(birth)) return showErr(t('err.invalidDate'));

    const [Y,M,D]=birth.split('-').map(n=>parseInt(n,10));
    const unknown = $('timeUnknown')?.checked;
    const timeVal = $('birthtime')?.value || '00:00';
    const hh = parseInt((timeVal.split(':')[0]||'0'),10) || 0;

    setGenLoading(true);
    try{
      const calc = new BaziCalculator();
      const y = calc.yearPillar(Y);
      const m = calc.monthPillar(Y,M,D);
      const d = calc.dayPillar(Y,M,D);
      const h = unknown ? {stem:'-',branch:'-'} : calc.hourPillar(d.stem, hh);

      renderPillars([y.stem+y.branch, m.stem+m.branch, d.stem+d.branch, unknown ? (t('badge.noHour')||'-') : (h.stem+h.branch)]);

      const stems=[y.stem,m.stem,d.stem, unknown? '-' : h.stem];
      const branch=[y.branch,m.branch,d.branch, unknown? '-' : h.branch];
      const rawElems=[calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem), unknown? '-' : calc.stemElem(h.stem)];
      const nayin=[calc.nayin(y.stem,y.branch),calc.nayin(m.stem,m.branch),calc.nayin(d.stem,d.branch), unknown? '-' : calc.nayin(h.stem,h.branch)];
      renderTable({stem:stems,branch:branch,element:rawElems,nayin});

      const allElems = [calc.stemElem(y.stem),calc.stemElem(m.stem),calc.stemElem(d.stem)]
        .concat(unknown?[]:[calc.stemElem(h.stem)])
        .concat([calc.branchElem(y.branch),calc.branchElem(m.branch),calc.branchElem(d.branch)])
        .concat(unknown?[]:[calc.branchElem(h.branch)]);

      const counts = {æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
      allElems.forEach(e=>{ if(counts[e]!=null) counts[e]++; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
      const pcts = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, 100*v/total]));
      renderBars(pcts);

      const timeText = unknown ? (t('ui.timeUnknown')||'å‡ºç”Ÿæ™‚é–“ä¸æ˜') :
        (t('ui.hourSuffix')||'{hh}:{mm}')
          .replace('{hh}', String(hh).padStart(2,'0'))
          .replace('{mm}', String(parseInt((timeVal.split(':')[1]||'0'),10)||0).padStart(2,'0'));

      const btxt = (t('ui.birthSummary')||'å‡ºç”Ÿï¼š{y}-{m}-{d} {timeText}')
        .replace('{y}',Y).replace('{m}',M).replace('{d}',D).replace('{timeText}', timeText);

      const bd=$('bazi-date'); if (bd) bd.textContent = btxt;

      const tg = calc.tenGods(d.stem, stems);
      const ctx = { pcts, dayStem: d.stem, tenGods: tg, unknown };
      window.lastCtx = ctx;

      $('result').style.display='block';
    }catch(e){
      console.error(e);
      showErr(t('err.generateFail'));
    } finally {
      setGenLoading(false);
    }
  }

  /* ===================== CLOCK ===================== */
  function tickNow(){
    const box = $('nowBox'); if (!box) return;
    const fmt = new Intl.DateTimeFormat('ja-JP', {
      weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', hour12:false, timeZone: SG_TZ
    });
    box.textContent = fmt.format(new Date()) + ' (SGT)';
  }
  window.tickNow = tickNow;

  /* ===================== FLOATING GPT CHAT ===================== */
  function initChat(){
    const fab   = $('ssChatFab');
    const panel = $('chatPanel');
    const close = $('chatClose');
    const body  = $('chatBody');
    const input = $('chatInput');
    const send  = $('chatSend');

    if (!fab || !panel || !close || !body || !input || !send) {
      console.warn('[chat] missing elements');
      return;
    }

    let chatHistory = [];

    const open = () => { panel.setAttribute('aria-hidden','false'); setTimeout(()=>input.focus(), 50); };
    const shut = () => { panel.setAttribute('aria-hidden','true'); };
    const toggle = () => {
      const hidden = panel.getAttribute('aria-hidden') !== 'false';
      hidden ? open() : shut();
    };

    fab.addEventListener('click', toggle);
    close.addEventListener('click', shut);

    function pushMsg(text, who='bot'){
      const div = document.createElement('div');
      div.className = who === 'me' ? 'ss-msg me' : 'ss-msg';
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
    }

    if (!initChat._welcomed){
      initChat._welcomed = true;
      pushMsg(t('pro.welcome') || 'ã“ã‚“ã«ã¡ã¯ã€‚å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPTã§ã™ã€‚ã¾ãšå‘½ç›¤ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰ã€ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚', 'bot');
    }

    function buildBaziChatContext(){
      const ctx = window.lastCtx || null;
      const name = ($('name')?.value || '').trim();
      const gender = ($('gender')?.value || '').trim();
      const birth = ($('birthdate')?.value || '').trim();
      const timeUnknown = !!$('timeUnknown')?.checked;
      const birthtime = ($('birthtime')?.value || '').trim();

      return { name, gender, birthdate: birth, birthtime: timeUnknown ? '' : birthtime, timeUnknown, chart: ctx };
    }

    function extractReply(json){
      if (!json) return '';
      return (
        json.reply ||
        json.answer ||
        json.content ||
        json.message ||
        json.text ||
        (json.data && (json.data.reply || json.data.content || json.data.text)) ||
        ''
      );
    }

    async function callChatAPI(userText){
      const lang = 'ja';
      const ctx = buildBaziChatContext();

      if (!chatHistory.length){
        chatHistory.push({
          role: 'system',
          content:
`ã‚ãªãŸã¯ã€Œå¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPTã€ã€‚å…«å­—ã®è§£é‡ˆã¨ã€å®Ÿè¡Œã§ãã‚‹åŠ©è¨€ã‚’æä¾›ã—ã¾ã™ã€‚
- è¨€èªï¼šja
- ã‚‚ã—å‘½ç›¤ãŒæœªç”Ÿæˆï¼ˆchartãŒç©ºï¼‰ãªã‚‰ã€ã¾ãšã€Œå…«å­—ã‚’ç”Ÿæˆã€ã‚’æŠ¼ã™ã‚ˆã†æ¡ˆå†…ã™ã‚‹ã€‚
- å…·ä½“çš„ãƒ»ç®‡æ¡æ›¸ããƒ»å®Ÿç”¨é‡è¦–ã€‚ã‚³ãƒ¼ãƒ‰ã¯å‡ºåŠ›ã—ãªã„ã€‚`
        });
      }

      chatHistory.push({ role:'user', content: userText });

      const url = String(API_BASE).replace(/\/$/,'') + CHAT_ENDPOINT;
      const payload = { lang, context: ctx, messages: chatHistory };

      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json().catch(()=>null);
      const reply = extractReply(json);

      if (reply) chatHistory.push({ role:'assistant', content: reply });
      return reply || 'ï¼ˆè¿”ä¿¡å†…å®¹ãŒç©ºã§ã™ã€‚Workerã®è¿”å´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰';
    }

    async function sendMsg(){
      const text = (input.value || '').trim();
      if (!text) return;

      input.value = '';
      pushMsg(text, 'me');
      pushMsg('â€¦', 'bot');
      const typingNode = body.lastElementChild;

      try{
        const reply = await callChatAPI(text);
        if (typingNode) typingNode.textContent = reply;
        else pushMsg(reply, 'bot');
      }catch(err){
        console.error('[chat] error', err);
        const msg = 'âš ï¸ GPTæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚API_BASE ã¨ /api/chat ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        if (typingNode) typingNode.textContent = msg;
        else pushMsg(msg, 'bot');
      }
    }

    send.addEventListener('click', sendMsg);
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') sendMsg();
    });
  }

  function onLangSelect(e){
  const lang = (e.target?.value) || 'zh-CN';
  try { localStorage.setItem('5x_lang', lang); } catch {}

  // Use RELATIVE paths (no leading "/") so it works in subfolders too.
  const LANG_PAGES = {
    'zh-CN': 'bazi.html',
    'en':    'assets/bazi-language-pack/bazi-en.html',
    'zh-TW': 'assets/bazi-language-pack/bazi-zh-TW.html',
    'ja':    'assets/bazi-language-pack/bazi-ja.html',
    'th':    'assets/bazi-language-pack/bazi-th.html',
    'ms':    'assets/bazi-language-pack/bazi-ms.html'
  };

  const target = LANG_PAGES[lang] || LANG_PAGES['zh-CN'];

  // Resolve relative to CURRENT page location (safe for subfolders)
  const targetUrl = new URL(target, window.location.href);

  // Compare normalized pathnames to avoid loops
  const curPath = window.location.pathname.replace(/\/+$/, '');
  const tgtPath = targetUrl.pathname.replace(/\/+$/, '');

  if (curPath !== tgtPath) window.location.href = targetUrl.href;
}

  /* ===================== BOOT ===================== */
  function boot(){
    if (boot._didBoot) return; boot._didBoot = true;

    applyI18n();

    const unk = $('timeUnknown'), bt = $('birthtime');
    if (unk && bt){
      const sync = ()=>{ bt.disabled = !!unk.checked; bt.style.opacity = bt.disabled ? 0.5 : 1; };
      unk.addEventListener('change', sync); sync();
    }

    $('genBtn')?.addEventListener('click', generate);

    initChat();
    tickNow();
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>

<!-- Clock + Birthdate defaults (JA) -->
<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const TZ = 'Asia/Singapore';

  window.applyI18n = (function(prev){
    return function(){
      if (typeof prev === 'function') prev();
      if (typeof window.tickNow === 'function') window.tickNow();
    };
  })(window.applyI18n);

  if (typeof window.tickNow !== 'function') {
    window.tickNow = function tickNow(){
      const box = $('nowBox'); if (!box) return;
      const fmt = new Intl.DateTimeFormat('ja-JP', {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false, timeZone: TZ
      });
      box.textContent = fmt.format(new Date()) + ' (SGT)';
    };
  }

  function initBirthDefaults() {
    const bd = $('birthdate'); const bt = $('birthtime'); const unk = $('timeUnknown');
    const nowSG = new Date(new Date().toLocaleString('ja-JP', { timeZone: TZ }));

    if (bd && !bd.value){
      const y=nowSG.getFullYear(), m=String(nowSG.getMonth()+1).padStart(2,'0'), d=String(nowSG.getDate()).padStart(2,'0');
      bd.value = `${y}-${m}-${d}`;
    }

    if (bt){
      const hh=String(nowSG.getHours()).padStart(2,'0'), mm=String(nowSG.getMinutes()).padStart(2,'0');
      if (!bt.value) bt.value = `${hh}:${mm}`;
      const setUnknownState = ()=>{ const isUnknown = !!(unk && unk.checked); bt.disabled = isUnknown; if (isUnknown) bt.value = ''; };
      setUnknownState();
      if (unk && !unk._wired){
        unk._wired = true;
        unk.addEventListener('change', ()=>{
          if (unk.checked){
            bt.disabled = true; bt.value = '';
          } else {
            bt.disabled = false;
            if (!bt.value){
              const n = new Date(new Date().toLocaleString('ja-JP',{timeZone:TZ}));
              bt.value = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
            }
          }
        });
      }
    }
  }

  initBirthDefaults();
  if (typeof window.tickNow === 'function') window.tickNow();
  if (!window._clock) window._clock = setInterval(()=>{ try{ window.tickNow(); }catch{} }, 60000);
})();
</script>
</body>
</html>

