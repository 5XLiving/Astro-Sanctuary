<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title data-i18n="title">私人记忆影壁 · 5XLiving</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#9aa3b2;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#0b0f14;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
.container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}
header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
.head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
.title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em}
.lang{display:flex;align-items:center;gap:8px}
.lang label{color:var(--muted);font-size:.9rem}
.lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section{margin-top:18px}
.row{display:grid;gap:12px}
@media(min-width:760px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-2{grid-template-columns:1fr 1fr}}
input,select,button,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px 12px;font-size:15px}
.btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.h2{font-size:1.15rem;margin:0 0 .5rem;font-weight:700;color:#ffe084}
.muted{color:#9aa3b2}
footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0;margin-top:30px}

/* 影壁样式 */
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
.toolbar .btn{height:42px}
.filter-bar{display:flex;flex:1;gap:10px;align-items:center}
.memory-list{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
@media(min-width:640px){.memory-list{grid-template-columns:repeat(2,1fr)}}
@media(min-width:980px){.memory-list{grid-template-columns:repeat(3,1fr)}}
.memory-card{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.memory-card .label{font-size:.9rem;color:#9aa3b2;margin-bottom:6px}
.memory-card img, .memory-card video{width:100%;border-radius:10px;margin:6px 0;display:block}
.memory-card audio{width:100%;margin:6px 0}
.memory-card .text-block{white-space:pre-wrap;line-height:1.7;background:#0f1624;border:1px solid #253245;border-radius:10px;padding:10px}

/* 锁定提示 */
.locked-msg{margin-top:12px;border:1px dashed #33465e;border-radius:12px;padding:12px 14px;color:#a7b5c5;text-align:center}
.unlock-button{display:inline-grid;place-items:center;margin-top:8px;padding:10px 14px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700;text-decoration:none}

/* Chat */
.ss-chat-fab{position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;border:1px solid #e6c76e;box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer}
.ss-chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-height:70vh;display:none;flex-direction:column;overflow:hidden;z-index:50;background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)}
.ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244;color:#ffe084;font-weight:700}
.ss-chat-body{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:120px}
.ss-chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #243244}
.ss-chat-input input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0f1522;color:#eaf0ff}
.ss-chat-input button{padding:10px 12px;border-radius:10px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:700}
.ss-msg{background:#101a28;border:1px solid #223047;padding:8px 10px;border-radius:10px;max-width:95%}
.ss-msg.me{margin-left:auto;background:#1a2433;border-color:#2b3a51}

/* Chat 字号微调 */
.ss-chat-panel { font-size: 15.5px; }
.ss-chat-head  { font-size: 16.5px; }
.ss-chat-body { gap: 10px; }
.ss-msg{ font-size: 15.5px; line-height: 1.65; padding: 10px 12px; border-radius: 12px; }
.ss-msg.me{ font-size: 15.5px; line-height: 1.65; padding: 10px 12px; border-radius: 12px; }
.ss-chat-input input{ font-size: 15.5px; height: 44px; padding: 10px 12px; }
.ss-chat-input button{ font-size: 15.5px; height: 44px; padding: 0 14px; }
@media (max-width: 480px){
  .ss-chat-panel { font-size: 16px; }
  .ss-msg, .ss-msg.me { font-size: 16px; line-height: 1.7; }
  .ss-chat-input input, .ss-chat-input button { height: 46px; font-size: 16px; }
}
</style>
</head>

<body>
<header>
  <div class="head-inner container">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand">Soul Sanctuary</div>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="lang_label">语言</label>
      <select id="langSelect">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<main class="container">
  <!-- 影壁表单/工具栏 -->
  <div class="card">
    <div class="h2" data-i18n="wall_title">私人记忆影壁 · Page 1</div>

    <div class="toolbar">
      <div class="filter-bar" role="search">
        <label for="typeFilter" class="muted" data-i18n="filter_label">筛选类型</label>
        <select id="typeFilter" aria-label="Filter">
          <option value="all" data-i18n="filter_all">全部</option>
          <option value="photo" data-i18n="filter_photo">📷 照片</option>
          <option value="video" data-i18n="filter_video">📹 视频</option>
          <option value="audio" data-i18n="filter_audio">🎙️ 语音</option>
          <option value="note" data-i18n="filter_note">📝 笔记</option>
          <option value="journal" data-i18n="filter_journal">📓 记事本</option>
        </select>
        <input type="search" id="searchInput" data-i18n-ph="ph_search" placeholder="搜索人物或内容…" />
      </div>

      <button id="btnAdd" class="btn" data-i18n="btn_add">+ 新增记忆</button>
      <button id="btnExport" class="btn" data-i18n="btn_export">导出JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer" data-i18n="btn_import">导入JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>

    <div class="memory-list" id="memoryList" aria-live="polite"></div>

    <div id="nextPageSection" class="locked-msg">
      <p data-i18n="upgrade_tip">需要更多空间吗？解锁 Page 2 获取 500 额外记忆卡</p>
      <a class="unlock-button" href="https://yourshop.myshopify.com/products/unlock-page-2" target="_blank" data-i18n="btn_unlock">
        🔓 解锁 Page 2 · $2.90 SGD
      </a>
    </div>
  </div>
</main>

<footer>© 5XLiving • Astro Sanctuary</footer>

<!-- Chat 浮窗 -->
<div class="ss-chat-fab" id="ssChatFab" title="Concierge" data-i18n="chat_fab">问</div>
<div class="ss-chat-panel" id="ssChatPanel" role="dialog" aria-label="Concierge">
  <div class="ss-chat-head">
    <div id="ssChatTitle" data-i18n="chat_title">心怜管家 · Chat</div>
    <div id="ssChatClose" style="cursor:pointer">✕</div>
  </div>
  <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
  <div class="ss-chat-input">
    <input id="ssChatInput" type="text" data-i18n-ph="chat_ph" placeholder="问点什么吧…"/>
    <button id="ssChatSend" data-i18n="chat_send">发送</button>
  </div>
</div>

<script>
/* ===== 配置 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers
const LANG_KEY = "site_lang";

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
const getLang = () => localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN";
const setLang = v => { localStorage.setItem(LANG_KEY, v); document.documentElement.lang = v; };

/* ===== i18n（影壁用） ===== */
const i18n = {
  "zh-CN": {
    title:"私人记忆影壁 · 5XLiving", brand:"Soul Sanctuary", lang_label:"语言",
    wall_title:"私人记忆影壁 · Page 1",
    filter_label:"筛选类型", filter_all:"全部", filter_photo:"📷 照片", filter_video:"📹 视频", filter_audio:"🎙️ 语音", filter_note:"📝 笔记", filter_journal:"📓 记事本",
    ph_search:"搜索人物或内容…",
    btn_add:"+ 新增记忆", btn_export:"导出JSON", btn_import:"导入JSON",
    upgrade_tip:"需要更多空间吗？解锁 Page 2 获取 500 额外记忆卡", btn_unlock:"🔓 解锁 Page 2 · $2.90 SGD",
    chat_fab:"问", chat_title:"心怜管家 · Chat", chat_ph:"想了解什么？（如：如何开始免费体验）", chat_send:"发送",
    neterr:"网络异常，请稍后再试。", retry:"抱歉，暂时无法生成，请稍后再试。",
    add_title:"新增记忆", add_person:"人物", add_status:"状态", add_alive:"在世", add_passed:"已过世",
    add_type:"类型", add_text:"文字描述（可选）", add_file:"图片/视频/音频文件（可选）", add_save:"保存", add_cancel:"取消"
  },
  "en": {
    title:"Personal Memory Wall · 5XLiving", brand:"Soul Sanctuary", lang_label:"Language",
    wall_title:"Personal Memory Wall · Page 1",
    filter_label:"Filter", filter_all:"All", filter_photo:"📷 Photo", filter_video:"📹 Video", filter_audio:"🎙️ Audio", filter_note:"📝 Note", filter_journal:"📓 Journal",
    ph_search:"Search by person or content…",
    btn_add:"+ Add Memory", btn_export:"Export JSON", btn_import:"Import JSON",
    upgrade_tip:"Need more space? Unlock Page 2 for 500 extra cards.", btn_unlock:"🔓 Unlock Page 2 · $2.90 SGD",
    chat_fab:"Chat", chat_title:"Concierge · Chat", chat_ph:"Ask me anything (e.g., how to start a free trial)", chat_send:"Send",
    neterr:"Network error. Try again later.", retry:"Sorry, couldn’t respond now.",
    add_title:"Add Memory", add_person:"Person", add_status:"Status", add_alive:"Alive", add_passed:"Passed",
    add_type:"Type", add_text:"Text (optional)", add_file:"Media file (optional)", add_save:"Save", add_cancel:"Cancel"
  },
  "ms": {
    title:"Dinding Memori Peribadi · 5XLiving", brand:"Soul Sanctuary", lang_label:"Bahasa",
    wall_title:"Dinding Memori Peribadi · Page 1",
    filter_label:"Tapis", filter_all:"Semua", filter_photo:"📷 Foto", filter_video:"📹 Video", filter_audio:"🎙️ Audio", filter_note:"📝 Nota", filter_journal:"📓 Jurnal",
    ph_search:"Cari mengikut orang atau kandungan…",
    btn_add:"+ Tambah Memori", btn_export:"Eksport JSON", btn_import:"Import JSON",
    upgrade_tip:"Perlu ruang tambahan? Buka Page 2 (500 kad).", btn_unlock:"🔓 Buka Page 2 · $2.90 SGD",
    chat_fab:"Sembang", chat_title:"Concierge · Chat", chat_ph:"Tanya apa sahaja", chat_send:"Hantar",
    neterr:"Ralat rangkaian. Cuba lagi.", retry:"Maaf, gagal balas.",
    add_title:"Tambah Memori", add_person:"Individu", add_status:"Status", add_alive:"Hidup", add_passed:"Meninggal",
    add_type:"Jenis", add_text:"Teks (opsyenal)", add_file:"Fail media (opsyenal)", add_save:"Simpan", add_cancel:"Batal"
  }
};
function t(key){ const L=i18n[getLang()]||i18n["zh-CN"]; return L[key] || (i18n["zh-CN"][key]||key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n"); el.textContent = t(k);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const k=el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(k));
  });
  const titleEl=document.querySelector("title[data-i18n], title[data-i18n='title']");
  if(titleEl){ titleEl.textContent=t("title"); }
}

/* ===== Chat 浮窗 ===== */
(function(){
  const fab=$('ssChatFab'), panel=$('ssChatPanel'), body=$('ssChatBody'), input=$('ssChatInput'), send=$('ssChatSend'), closeBtn=$('ssChatClose');
  function addMsg(text,me=false){const d=document.createElement('div');d.className='ss-msg'+(me?' me':'');d.textContent=text;body.appendChild(d);body.scrollTop=body.scrollHeight;}
  async function askChat(prompt){
    addMsg(prompt,true); input.value='';
    try{
      const r=await fetch(`${API_BASE}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[
        {role:'system',content:'你是“心怜管家”，语气温暖专业、简洁有条理，提供网站导航与一般咨询。'},
        {role:'user',content:prompt}
      ]})});
      let data={}; try{data=await r.json()}catch{}
      const reply=data.reply??data.text??data?.choices?.[0]?.message?.content??'';
      addMsg(reply||t('retry'));
    }catch{ addMsg(t('neterr')); }
  }
  fab.addEventListener('click',()=>{panel.style.display='flex';input.focus()});
  closeBtn.addEventListener('click',()=>panel.style.display='none');
  send.addEventListener('click',()=>{const v=input.value.trim();if(v)askChat(v)});
  input.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=input.value.trim();if(v)askChat(v)}});
})();

/* ===== 影壁逻辑（本地存储 personalMemories） ===== */
const PAGE_SIZE = 500;
const PAGE_INDEX = 1;
const start = (PAGE_INDEX - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;

function readMemories(){
  try{ return JSON.parse(localStorage.getItem('personalMemories')) || []; }
  catch{ return []; }
}
function writeMemories(arr){
  localStorage.setItem('personalMemories', JSON.stringify(arr||[]));
}

const memoryList = $('memoryList');
const typeFilter = $('typeFilter');
const searchInput = $('searchInput');

function renderMemories(){
  const memories = readMemories();
  memoryList.innerHTML = '';
  const filterType = typeFilter.value;
  const keyword = (searchInput.value||'').trim().toLowerCase();

  const filtered = memories
    .map((m,i)=>({...m, __index:i}))
    .filter((m,i)=> i>=start && i<end)
    .filter(m=>{
      const matchType = (filterType==='all' || m.type===filterType);
      const p = (m.person||'').toLowerCase();
      const tx = (m.text||'').toLowerCase();
      const matchKeyword = (!keyword || p.includes(keyword) || tx.includes(keyword));
      return matchType && matchKeyword;
    });

  if (!filtered.length){
    const empty = document.createElement('div');
    empty.className='muted';
    empty.style.padding='8px 2px';
    empty.textContent = '（暂无记录，点击“新增记忆”创建一条吧）';
    memoryList.appendChild(empty);
    return;
  }

  filtered.forEach(memory=>{
    const card = document.createElement('div');
    card.className='memory-card';

    let mediaHTML = '';
    if (memory.type==='photo' && memory.fileData){
      mediaHTML = `<img src="${memory.fileData}" alt="照片" />`;
    }else if (memory.type==='video' && memory.fileData){
      mediaHTML = `<video controls src="${memory.fileData}"></video>`;
    }else if (memory.type==='audio' && memory.fileData){
      mediaHTML = `<audio controls src="${memory.fileData}"></audio>`;
    }

    let textHTML='';
    if (memory.type==='note' || memory.type==='journal'){
      textHTML = `<div class="text-block">${memory.text||''}</div>`;
    }else if (memory.text){
      textHTML = `<div class="text-block">${memory.text}</div>`;
    }

    card.innerHTML = `
      <div class="label">👤 ${memory.person||'-'}（${memory.status==='alive'?'在世':'已过世'}）</div>
      <div class="label">📌 类型：${memory.type||'-'}</div>
      ${mediaHTML}
      ${textHTML}
    `;
    memoryList.appendChild(card);
  });
}
renderMemories();
typeFilter.addEventListener('change', renderMemories);
searchInput.addEventListener('input', renderMemories);

/* ==== 新增 / 导入 / 导出 ==== */
$('btnExport').addEventListener('click', ()=>{
  const data = JSON.stringify(readMemories(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'personalMemories.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

$('importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const arr = JSON.parse(text);
    if (!Array.isArray(arr)) throw new Error('Invalid JSON');
    writeMemories(arr);
    renderMemories();
    alert('导入完成');
  }catch(err){
    alert('导入失败：' + (err?.message||''));
  }finally{
    e.target.value = '';
  }
});

/* 简易新增面板（原生 prompt，轻量无弹窗框架） */
$('btnAdd').addEventListener('click', async ()=>{
  const person = prompt(t('add_person'));
  if (person===null) return;
  const status = prompt(`${t('add_status')}（${t('add_alive')}/${t('add_passed')}）：`)||'alive';
  const type = prompt(`${t('add_type')}（photo/video/audio/note/journal）：`)||'note';
  const text = prompt(t('add_text'))||'';
  // 媒体文件请用“导入JSON”或在别处上传后填 URL；这里走最轻体验，留空即可
  const fileData = '';

  const arr = readMemories();
  arr.unshift({person, status: (status==='已过世' || status.toLowerCase()==='passed')?'passed':'alive', type, text, fileData});
  writeMemories(arr);
  renderMemories();
});

/* ===== 语言切换 ===== */
const sel = $('langSelect');
sel.value = getLang();
applyI18n();
sel.addEventListener('change', ()=>{
  setLang(sel.value);
  applyI18n();
  renderMemories();
});

/* 初次进入也应用语言（若 localStorage 有值） */
document.documentElement.lang = getLang();
applyI18n();
</script>
</body>
</html>
