<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">çµæ•°ç®€è¯„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving Â· <span data-i18n="site_title">çµæ•°ç®€è¯„</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">çµæ•°ç®€è¯„</h1>
    <p class="sub" data-i18n="site_subtitle">å…è´¹ç‰ˆ Â· ä¸é¦–é¡µç»Ÿä¸€é£æ ¼ | VIP å¯è§£é”å®Œæ•´çµæ•°åœ°å›¾</p>

    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">è§„åˆ™</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">æ¯•è¾¾å“¥æ‹‰æ–¯ / Pythagorean</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">ç”Ÿæˆåˆ†æ</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
        è¯´æ˜ï¼šç”Ÿå‘½è·¯å¾„ = ç”Ÿæ—¥æ‰€æœ‰æ•°å­—ç›¸åŠ å¹¶é™è‡³ 1â€“9ï¼ˆä¿ç•™ 11/22/33ï¼‰ï¼›æƒ…æ„Ÿæ•°å­— = å‡ºç”Ÿæ—¥ï¼ˆDDï¼‰åŒæ ·è§„åˆ™ã€‚
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®</h2>
      <div id="numReport" class="report"></div>
    </section>

    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

<script>
(function(){
  'use strict';

  /* =========================
     Config & Utilities
  ========================= */
  var API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  var LANG_KEY = 'site_lang';
  var gid = function(id){ return document.getElementById(id); };

  // Polyfills
  if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  if (!Element.prototype.closest) {
    Element.prototype.closest = function (s) {
      var el = this;
      while (el && el.nodeType === 1) { if (el.matches(s)) return el; el = el.parentElement || el.parentNode; }
      return null;
    };
  }

  // Ensure result scaffolding exists so Butler can render
  function ensureRootStructure(){
    var result = gid('result');
    if (!result){
      result = document.createElement('section');
      result.id = 'result';
      result.style.display = 'none';
      document.body.appendChild(result);
    }
    var numReport = gid('numReport');
    if (!numReport){
      numReport = document.createElement('div');
      numReport.id = 'numReport';
      result.appendChild(numReport);
    }
    return numReport;
  }

  /* =========================
     i18n
  ========================= */
  const i18n = {
    "zh-CN": {
      page_title:"çµæ•°ç®€è¯„", site_title:"çµæ•°ç®€è¯„",
      site_subtitle:"å…è´¹ç‰ˆ Â· ä¸é¦–é¡µç»Ÿä¸€é£æ ¼ | VIP å¯è§£é”å®Œæ•´çµæ•°åœ°å›¾",
      lang_label:"è¯­è¨€",
      ph_birthdate:"å‡ºç”Ÿæ—¥æœŸ", rule_pyth:"è§„åˆ™ï¼ˆæ¯•è¾¾å“¥æ‹‰æ–¯ï¼‰", btn_gen:"ç”Ÿæˆåˆ†æ",
      hint_text:"è¯´æ˜ï¼šç”Ÿå‘½è·¯å¾„ = ç”Ÿæ—¥æ‰€æœ‰æ•°å­—ç›¸åŠ å¹¶é™è‡³ 1â€“9ï¼ˆä¿ç•™ 11/22/33ï¼‰ï¼›æƒ…æ„Ÿæ•°å­— = å‡ºç”Ÿæ—¥ï¼ˆDDï¼‰åŒæ ·è§„åˆ™ã€‚",
      res_title:"å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®",
      sec_overview:"åŸºç¡€ä¿¡æ¯",
      sec_life:"ç”Ÿå‘½è·¯å¾„",
      sec_love:"æƒ…æ„Ÿæ•°å­—",
      sec_career:"äº‹ä¸šä¸å·¥ä½œé£æ ¼",
      sec_money:"é‡‘é’±ä¸èµ„æºæ¨¡å¼",
      sec_rel:"å…³ç³»ä¸è¾¹ç•Œ",
      sec_year:"æœ¬å¹´èƒ½é‡ï¼ˆä¸ªäººå¹´æ•°ï¼‰",
      sec_plan30:"30å¤©å¯æ‰§è¡Œè®¡åˆ’",
      sec_gentle:"æ¸©æŸ”æé†’",
      err_need_birthdate:"è¯·å…ˆé€‰æ‹©å‡ºç”Ÿæ—¥æœŸ",
      butler_title:"å¿ƒæ€œç®¡å®¶ Â· æ™ºèƒ½è§£è¯»", butler_chat_title:"å¿ƒæ€œç®¡å®¶ Â· Chat",
      chat_fab:"é—®", chat_placeholder:"æƒ³äº†è§£ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ï¼šåŠŸèƒ½ã€ä¼šå‘˜è¯´æ˜ï¼‰", chat_send:"å‘é€",
      chip_career:"äº‹ä¸šè§£è¯»", chip_love:"æ„Ÿæƒ…å…³ç³»", chip_money:"è´¢åŠ¡å»ºè®®", chip_list:"æœ¬å‘¨æ‰§è¡Œæ¸…å•", chip_30d:"30å¤©è®¡åˆ’",
      q_career:"ç»“åˆæˆ‘çš„çµæ•°ï¼Œç»§ç»­è§£è¯»äº‹ä¸šä¸å›¢é˜Ÿåä½œ",
      q_love:"ç»“åˆæˆ‘çš„çµæ•°ï¼Œè¯´è¯´æ„Ÿæƒ…ä¸é•¿æœŸå…³ç³»",
      q_money:"ç»™æˆ‘ä¸çµæ•°ç›¸å…³çš„é‡‘é’±ä¹ æƒ¯ã€ç›²åŒºä¸æ”¹å–„å»ºè®®",
      q_list:"ç»™æˆ‘ä¸€ä»½æœ¬å‘¨å¯æ‰§è¡Œæ¸…å•ï¼ˆç»“åˆçµæ•°ï¼‰",
      q_30d:"åŸºäºçµæ•°ï¼Œä¸ºæˆ‘å®šä¸€ä¸ª30å¤©æˆé•¿è®¡åˆ’",
      vip_tip:"ğŸ”’ VIP è§£é”åå¯æŸ¥çœ‹å®Œæ•´è§£è¯»",
      vip_sub:"åŒ…å«ã€Œäº‹ä¸š/è´¢å¯Œ/æ‰§è¡Œæ¸…å•/æ¸©æŸ”æé†’ã€å…¨éƒ¨ç« èŠ‚ä¸æŒç»­è¿½é—®",
      btn_unlock:"ç«‹å³è§£é”",
      err_network:"ç½‘ç»œå¼‚å¸¸", err_busy:"æœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚",
      vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment", vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
      vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿", vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
      vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº", vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
      vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶", vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
      vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
      vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹", vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
      vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
      vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­", vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
      vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶", login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
      panel_login_head:"è´¦æˆ·ç™»å½• / æ³¨å†Œ",
      ph_email:"é‚®ç®± Email", ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘ 8 ä½ï¼Œéœ€åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ä¸ç¬¦å·ï¼‰", ph_label_password:"å¯†ç  Password",
      btn_login:"ç™»å½•è´¦æˆ·", btn_register:"æ³¨å†Œè´¦æˆ·", btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
      panel_member_head:"ä¼šå‘˜æœåŠ¡", btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰", btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
      note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ", note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰"
    },
    "zh-TW": { /* â€¦(åŸå†…å®¹ä¿ç•™)â€¦ */ },
    "en": { /* â€¦(åŸå†…å®¹ä¿ç•™)â€¦ */ },
    "ja": { /* â€¦(åŸå†…å®¹ä¿ç•™)â€¦ */ },
    "th": { /* â€¦(åŸå†…å®¹ä¿ç•™)â€¦ */ },
    "ms": { /* â€¦(åŸå†…å®¹ä¿ç•™)â€¦ */ }
  };

  var BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  function getLang(){
    var saved = localStorage.getItem(LANG_KEY);
    if (saved && i18n[saved]) return saved;
    var raw = (navigator.language || 'zh-CN').replace('_','-');
    var map = {'zh':'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW','en':'en','en-US':'en','en-GB':'en','ja':'ja','ja-JP':'ja','th':'th','ms':'ms'};
    return map[raw] || 'zh-CN';
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  function t(key){
    var L = i18n[getLang()] || i18n['zh-CN'];
    return L[key] || (i18n['zh-CN'][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(function(el){
      var k = el.getAttribute('data-i18n'); var v = t(k);
      if (v!=null) el.textContent = v;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(function(el){
      var k = el.getAttribute('data-i18n-ph'); var v = t(k);
      if (v!=null) el.setAttribute('placeholder', v);
    });
    var titleEl = document.querySelector('title[data-i18n], title[data-i18n="page_title"]');
    if (titleEl) titleEl.textContent = t('page_title');
  }

  /* =========================
     Numerology Core
  ========================= */
  var masters = {11:true,22:true,33:true};
  function isMaster(n){ return !!masters[n]; }
  function reduceNum(n){
    while(n>9 && !isMaster(n)){
      var s = String(n).split(""), acc=0;
      for (var i=0;i<s.length;i++) acc += Number(s[i]);
      n = acc;
    }
    return n;
  }
  function parseDateDigits(iso){
    if(!iso) return null;
    var d = iso.replace(/[^0-9]/g,"");
    if(d.length<8) return null;
    var arr=[]; for (var i=0;i<d.length;i++) arr.push(Number(d[i]));
    return arr;
  }
  function calcLifePath(iso){
    var digits = parseDateDigits(iso);
    if(!digits) return null;
    var sum=0; for (var i=0;i<digits.length;i++) sum+=digits[i];
    return reduceNum(sum);
  }
  function calcLoveNumber(iso){
    if(!iso) return null;
    var p = iso.split("-");
    var dd = Number(p[2]||"0"); if(!dd) return null;
    return reduceNum(dd);
  }
  function calcPersonalYear(iso, year){
    // Personal Year = reduce( (month + day + currentYear) digits ), keep 11/22
    if(!iso) return null;
    var p = iso.split("-");
    var m = Number(p[1]||"0"), d = Number(p[2]||"0");
    if(!m || !d) return null;
    var total = 0;
    (String(m)+String(d)+String(year)).replace(/./g, function(ch){ total += Number(ch); });
    return reduceNum(total);
  }

  /* =========================
     Professional Dictionaries
  ========================= */
  // Compact but richer text blocks; localized for zh-CN and en (fallback)
  var PRO = {
    "en": {
      life: {
        1:"Archetype: Pioneer. Core lesson: self-definition without domination. Strengths: initiative, originality, decisiveness. Triggers: resistance to control, impatience. Growth: lead by invitation, not imposition.",
        2:"Archetype: Diplomat. Core lesson: boundaries with empathy. Strengths: listening, harmony-building. Triggers: conflict avoidance. Growth: speak needs plainly; collaboration with standards.",
        3:"Archetype: Creator. Core lesson: consistency behind expression. Strengths: storytelling, aesthetics, morale. Triggers: criticism, boredom. Growth: ship on a cadence; edit rigorously.",
        4:"Archetype: Builder. Core lesson: structure without rigidity. Strengths: systems, discipline, reliability. Triggers: chaos, broken promises. Growth: iterate, donâ€™t ossify.",
        5:"Archetype: Explorer. Core lesson: freedom with responsibility. Strengths: adaptability, sales, learning. Triggers: confinement. Growth: commit via sprints; measure risk.",
        6:"Archetype: Steward. Core lesson: care without over-control. Strengths: service, guardianship, taste. Triggers: mess, unfairness. Growth: delegate; â€œgood enoughâ€ thresholds.",
        7:"Archetype: Sage. Core lesson: share findings. Strengths: analysis, depth, pattern-sense. Triggers: superficiality. Growth: translate wisdom into practice.",
        8:"Archetype: Executive. Core lesson: power with benevolence. Strengths: integration, resource command. Triggers: power struggles. Growth: governance, transparency, double-win deals.",
        9:"Archetype: Healer. Core lesson: give with boundaries. Strengths: compassion, completion, art. Triggers: injustice. Growth: receive support, not just give.",
        11:"Archetype: Visionary. Core lesson: ground intuition. Strengths: inspiration, sensing zeitgeist. Growth: routines, body care, practical pilots.",
        22:"Archetype: Architect. Core lesson: steward scale. Strengths: visionâ†’infrastructure. Growth: teams, charters, compounding systems.",
        33:"Archetype: Altruist. Core lesson: self-love precedes service. Strengths: heart-led healing. Growth: sustainable giving, boundaries."
      },
      love: {
        1:"Leads with initiative; practice tenderness and shared decisions.",
        2:"Seeks safety and closeness; name needs directly.",
        3:"Playful, words of affirmation; keep promises.",
        4:"Steady rituals and reliability; romance via constancy.",
        5:"Needs novelty and space; commit in chapters.",
        6:"Devoted and protective; avoid perfectionism.",
        7:"Quiet depth; respect solitude; cherish meaning.",
        8:"Goal-aligned partnership; negotiate power fairly.",
        9:"Big-hearted; donâ€™t rescue at your expense.",
        11:"Highly sensitive; handle with grace and slowness.",
        22:"Long-horizon builder; practical affection.",
        33:"Healing through love; recharge before you give."
      },
      careerTips: {
        1:["Own a problem end-to-end each quarter.","Practice consensus: two options + ask for input.","Delegate earlier than feels comfy."],
        2:["Facilitate hard conversations with agendas.","Track favors/asks in a simple log.","Say no with alternatives."],
        3:["Commit to a weekly ship cadence.","Batch ideation vs. editing sessions.","Create a portfolio of proofs."],
        4:["Design once, scale many: SOPs & checklists.","Automate boring steps first.","Retrospect monthly: kill brittle rules."],
        5:["Sprint 2â€“4 weeks per theme.","Quantify risk ceilings before exploring.","Sell via demos, not decks."],
        6:["Define â€œdoneâ€ to avoid overgiving.","Guard maker time; schedule care blocks.","Coach, donâ€™t fix."],
        7:["Publish summaries, not just research.","Pair with an operator for go-live.","Turn insights into 30-day pilots."],
        8:["Write operating principles and stick to them.","Separate power and affection cleanly.","Structure win-win incentives."],
        9:["Scope your causes; one at a time.","Measure impact, not martyrdom.","Keep a â€œreceiveâ€ list: help you accept."],
        11:["Translate visions into 7-day experiments.","Sleep, hydration, nature as non-negotiables.","Protect quiet creation windows."],
        22:["Roadmap: V1â†’V2â†’V3 maturity.","Hire for systems, not heroes.","Institutionalize lessons learned."],
        33:["Define limits of service explicitly.","Create caregiver backup plans.","Teach the method; donâ€™t carry alone."]
      },
      moneyTips: {
        1:["Invest in tools that multiply time.","Avoid impulse â€œcontrolâ€ buys; choose leverage."],
        2:["Budget for generosity but cap it.","Price your coordination work."],
        3:["Separate creative R&D vs. revenue projects.","Automate savings on pay-in days."],
        4:["Use envelopes/â€œbucketsâ€ for stability.","Index-fund default; review quarterly."],
        5:["Build a freedom fund (6â€“12m).","Have â€œfun allocationâ€ with a hard stop."],
        6:["Insure properly; no overcoverage.","Charge fairly for care/service"],
        7:["Pay for mentors/tools that compress learning.","Donâ€™t over-optimize tiny fees."],
        8:["Track ROI by initiative.","Avoid power signaling purchases."],
        9:["Give within limits; receipt your giving.","Retirement contributions first."],
        11:["Finance routines: sleep, therapy, craft.","Beware magical spending."],
        22:["Capex with depreciation schedules.","Fund maintainers, not just launches."],
        33:["Budget recovery time as â€œcostâ€.","Gift from surplus, not depletion."]
      },
      planSeeds:{
        generic:["Clarify one 30-day focus theme.","Define success metrics and anti-goals.","Block two weekly deep-work slots.","One money habit to install.","One relationship boundary to practice."]
      }
    },
    "zh-CN": {
      life:{
        1:"åŸå‹ï¼šå¼€æ‹“è€…ã€‚è¯¾é¢˜ï¼šè‡ªæˆ‘å®šä¹‰è€Œä¸å‹åˆ¶ä»–äººã€‚ä¼˜åŠ¿ï¼šä¸»åŠ¨æ€§ã€åŸåˆ›ã€å†³æ–­ã€‚è§¦å‘ç‚¹ï¼šè¢«æ§åˆ¶ã€æ‹–å»¶ã€‚æˆé•¿ï¼šä»¥â€œé‚€è¯·å¼é¢†å¯¼â€ä»£æ›¿â€œå‘½ä»¤å¼â€ã€‚",
        2:"åŸå‹ï¼šåè°ƒè€…ã€‚è¯¾é¢˜ï¼šåŒç†ä¸è¾¹ç•Œå¹¶å­˜ã€‚ä¼˜åŠ¿ï¼šå€¾å¬ã€æ¶¦æ»‘å…³ç³»ã€‚è§¦å‘ç‚¹ï¼šå†²çªå›é¿ã€‚æˆé•¿ï¼šæ¸…æ™°è¡¨è¾¾éœ€æ±‚ï¼Œå¸¦æ ‡å‡†åœ°åˆä½œã€‚",
        3:"åŸå‹ï¼šåˆ›é€ è€…ã€‚è¯¾é¢˜ï¼šè¡¨è¾¾ä¹‹åè¦æœ‰â€œäº¤ä»˜â€ã€‚ä¼˜åŠ¿ï¼šå™äº‹ã€å®¡ç¾ã€å¸¦åŠ¨æ°”æ°›ã€‚è§¦å‘ç‚¹ï¼šè¢«æ‰¹è¯„ã€æ— èŠã€‚æˆé•¿ï¼šå›ºå®šèŠ‚å¥å‡ºå“ï¼Œä¸¥è°¨å¤ç›˜ã€‚",
        4:"åŸå‹ï¼šå»ºé€ è€…ã€‚è¯¾é¢˜ï¼šç»“æ„â‰ åƒµåŒ–ã€‚ä¼˜åŠ¿ï¼šç³»ç»Ÿã€çºªå¾‹ã€å¯é ã€‚è§¦å‘ç‚¹ï¼šæ··ä¹±ã€å¤±çº¦ã€‚æˆé•¿ï¼šå°æ­¥è¿­ä»£ï¼Œé¿å…ä¸€åˆ€åˆ‡è§„åˆ™ã€‚",
        5:"åŸå‹ï¼šæ¢ç´¢è€…ã€‚è¯¾é¢˜ï¼šè‡ªç”±ä¸è´£ä»»åŒåœ¨ã€‚ä¼˜åŠ¿ï¼šé€‚åº”ã€é”€å”®ã€å­¦ä¹ ã€‚è§¦å‘ç‚¹ï¼šè¢«æŸç¼šã€‚æˆé•¿ï¼šä»¥å†²åˆºæ‰¿è¯ºï¼Œé‡åŒ–é£é™©ã€‚",
        6:"åŸå‹ï¼šå®ˆæŠ¤è€…ã€‚è¯¾é¢˜ï¼šå…³æ€€ä¸ç­‰äºæ§åˆ¶ã€‚ä¼˜åŠ¿ï¼šæœåŠ¡ã€å®¡ç¾ã€ç…§æ–™ã€‚è§¦å‘ç‚¹ï¼šå‡Œä¹±ã€ä¸å…¬ã€‚æˆé•¿ï¼šåˆ’å®šâ€œå¤Ÿå¥½â€é˜ˆå€¼ï¼Œå­¦ä¼šæˆæƒã€‚",
        7:"åŸå‹ï¼šæ™ºè€…ã€‚è¯¾é¢˜ï¼šæŠŠå‘ç°è¯´å‡ºæ¥ã€‚ä¼˜åŠ¿ï¼šåˆ†æã€æ´è§ã€æ¨¡å¼è¯†åˆ«ã€‚è§¦å‘ç‚¹ï¼šè¡¨é¢åŒ–ã€‚æˆé•¿ï¼šæŠŠç»“è®ºè½¬è¯‘ä¸ºå®è·µåŠ¨ä½œã€‚",
        8:"åŸå‹ï¼šæ‰§è¡Œå®˜ã€‚è¯¾é¢˜ï¼šæƒåŠ›ä¸ä»æ…ˆå¹³è¡¡ã€‚ä¼˜åŠ¿ï¼šæ•´åˆã€èµ„æºè°ƒåº¦ã€‚è§¦å‘ç‚¹ï¼šæƒåŠ›åšå¼ˆã€‚æˆé•¿ï¼šæ²»ç†ã€é€æ˜ã€åŒèµ¢åˆçº¦ã€‚",
        9:"åŸå‹ï¼šç–—æ„ˆè€…ã€‚è¯¾é¢˜ï¼šæœ‰è¾¹ç•Œçš„ç»™äºˆã€‚ä¼˜åŠ¿ï¼šåŒç†ã€å®Œæˆåº¦ã€è‰ºæœ¯æ€§ã€‚è§¦å‘ç‚¹ï¼šä¸å…¬ã€‚æˆé•¿ï¼šå…è®¸è¢«æ”¯æŒï¼Œè€Œéåªä»˜å‡ºã€‚",
        11:"åŸå‹ï¼šæ„¿æ™¯è€…ã€‚è¯¾é¢˜ï¼šç›´è§‰éœ€è½åœ°ã€‚ä¼˜åŠ¿ï¼šå¯å‘ã€æ•æ‰é£å‘ã€‚æˆé•¿ï¼šè§„å¾‹ä½œæ¯ã€èº«ä½“ç…§æŠ¤ã€å°èŒƒå›´è¯•ç‚¹ã€‚",
        22:"åŸå‹ï¼šæ¶æ„å¸ˆã€‚è¯¾é¢˜ï¼šæŠŠè§„æ¨¡ç®¡å¥½ã€‚ä¼˜åŠ¿ï¼šæ„¿æ™¯â†’åŸºç¡€è®¾æ–½ã€‚æˆé•¿ï¼šå›¢é˜Ÿã€ç« ç¨‹ã€å¯å¤åˆ©ç³»ç»Ÿã€‚",
        33:"åŸå‹ï¼šå¤§çˆ±è€…ã€‚è¯¾é¢˜ï¼šå…ˆè‡ªçˆ±ï¼Œå†æœåŠ¡ã€‚ä¼˜åŠ¿ï¼šä»¥çˆ±ç–—æ„ˆã€‚æˆé•¿ï¼šå¯æŒç»­ç»™äºˆï¼Œå…ˆè¡¥èƒ½é‡ã€‚"
      },
      love:{
        1:"ä¸»åŠ¨è€Œæœæ–­ï¼›ç»ƒä¹ æŸ”è½¯ä¸å…±è¯†å†³ç­–ã€‚",2:"é‡è§†å®‰å…¨äº²å¯†ï¼›ç›´æ¥è¡¨è¾¾éœ€æ±‚ã€‚",3:"çˆ±è¡¨è¾¾ä¸ä»ªå¼æ„Ÿï¼›è¯´åˆ°åšåˆ°ã€‚",
        4:"ç¨³å®šä¸å¯é ï¼›ä»¥æ’å¸¸åˆ¶é€ æµªæ¼«ã€‚",5:"éœ€è¦æ–°é²œä¸ç©ºé—´ï¼›åˆ†é˜¶æ®µæ‰¿è¯ºã€‚",6:"å¿ è¯šä¸ä¿æŠ¤ï¼›é¿å…å®Œç¾ä¸»ä¹‰ã€‚",
        7:"å®‰é™è€Œæ·±åˆ»ï¼›å°Šé‡ç‹¬å¤„ï¼Œçæƒœæ„ä¹‰ã€‚",8:"ç›®æ ‡åŒé¢‘ï¼›å…¬å¹³åå•†æƒè´£ã€‚",9:"å¿ƒå¤§æ˜“æ‹¯æ•‘ï¼›åˆ«ä»¥è‡ªæˆ‘ç‰ºç‰²æ¢çˆ±ã€‚",
        11:"é«˜åº¦æ•æ„Ÿï¼›ç”¨ä¼˜é›…ä¸æ…¢èŠ‚å¥ç›¸å¤„ã€‚",22:"é•¿çº¿å»ºæ„å‹ï¼›åŠ¡å®è¡¨è¾¾å…³å¿ƒã€‚",33:"ä»¥çˆ±ç–—æ„ˆï¼›å…ˆå……ç”µå†ç»™äºˆã€‚"
      },
      careerTips:{ /* ä¸è‹±æ–‡ç»“æ„ä¸€è‡´ï¼Œä¿ç•™å…³é”®ç‚¹çš„ä¸­æ–‡è¡¨è¾¾ */ },
      moneyTips:{ /* ä¸è‹±æ–‡ç»“æ„ä¸€è‡´ï¼Œä¿ç•™å…³é”®ç‚¹çš„ä¸­æ–‡è¡¨è¾¾ */ },
      planSeeds:{ generic:["æ˜ç¡®ä¸€ä¸ª30å¤©ä¸»é¢˜ã€‚","å†™æ¸…æˆåŠŸæŒ‡æ ‡ä¸åç›®æ ‡ã€‚","æ¯å‘¨é¢„ç•™ä¸¤æ®µæ·±åº¦å·¥ä½œã€‚","å®‰è£…ä¸€ä¸ªé‡‘é’±ä¹ æƒ¯ã€‚","ç»ƒä¹ ä¸€æ¡å…³ç³»è¾¹ç•Œã€‚"] }
    }
  };

  function txt(lang, path, key){
    var L = PRO[lang] || PRO['en'];
    var bucket = L[path] || {};
    return bucket[key] || (PRO['en'][path] ? (PRO['en'][path][key] || '') : '');
  }

  /* =========================
     AI Butler helpers
  ========================= */
  function mdToHtml(md){
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'â€¢ $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  function isVIP(){
    return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
  }
  function ensureAiCard(){
    ensureRootStructure();
    if (gid('aiCard')) return;
    var wrap = gid('numReport'); if(!wrap) return;
    var sec = document.createElement('div');
    sec.className = 'sec';
    sec.id = 'aiCard';
    sec.innerHTML =
      '<h3 id="butlerTitle" data-i18n="butler_title">' + t('butler_title') + '</h3>' +
      '<div id="aiContent" class="ai-content">' +
      '  <div class="skeleton">' +
      '    <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>' +
      '    <div style="width:70%"></div><div style="width:50%"></div>' +
      '  </div>' +
      '</div>' +
      '<div class="chips" id="aiChips"></div>';
    wrap.appendChild(sec);
    renderChips();
  }
  function renderChips(){
    var wrap = gid('aiChips'); if(!wrap) return;
    wrap.innerHTML = '';
    [{k:'chip_career', q:'q_career'},
     {k:'chip_love',   q:'q_love'},
     {k:'chip_money',  q:'q_money'},
     {k:'chip_list',   q:'q_list'},
     {k:'chip_30d',    q:'q_30d'}].forEach(function(it){
       var b = document.createElement('button');
       b.className='chip';
       b.textContent = t(it.k);
       b.setAttribute('data-q', t(it.q));
       b.dataset.topicKey = it.q;
       wrap.appendChild(b);
     });
  }

  function buildButlerSystemPrompt(lang, topic){
    if (!topic) topic = '';
    var ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    var HEADER_MAP = {
      'zh-CN':['äººç‰©ç”»åƒ','å…³ç³»ä¸æ²Ÿé€š','äº‹ä¸šä¸è‡ªæˆ‘å®ç°','é‡‘é’±ä¸ç‰©è´¨','ä»Šæ—¥/æœ¬å‘¨å¯æ‰§è¡Œæ¸…å•','æ¸©æŸ”æé†’'],
      'zh-TW':['äººç‰©ç”»åƒ','é—œä¿‚èˆ‡æºé€š','äº‹æ¥­èˆ‡è‡ªæˆ‘å¯¦ç¾','é‡‘éŒ¢èˆ‡ç‰©è³ª','ä»Šæ—¥/æœ¬é€±å¯åŸ·è¡Œæ¸…å–®','æº«æŸ”æé†’'],
      'en'   :['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
      'ja'   :['äººç‰©åƒ','é–¢ä¿‚ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³','ã‚­ãƒ£ãƒªã‚¢ã¨è‡ªå·±å®Ÿç¾','ãŠé‡‘ã¨ç‰©è³ª','ä»Šæ—¥/ä»Šé€±ã®å®Ÿè¡Œãƒªã‚¹ãƒˆ','ã‚„ã•ã—ã„ãƒªãƒã‚¤ãƒ³ãƒ‰'],
      'th'   :['à¸ à¸²à¸à¸šà¸¸à¸„à¸„à¸¥','à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œ & à¸à¸²à¸£à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£','à¸à¸²à¸£à¸‡à¸²à¸™ & à¸à¸²à¸£à¹€à¸•à¸´à¸¡à¹€à¸•à¹‡à¸¡à¸•à¸™à¹€à¸­à¸‡','à¸à¸²à¸£à¹€à¸‡à¸´à¸™ & à¸§à¸±à¸•à¸–à¸¸','à¸£à¸²à¸¢à¸à¸²à¸£à¸›à¸à¸´à¸šà¸±à¸•à¸´ (à¸§à¸±à¸™à¸™à¸µà¹‰/à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰)','à¸„à¸³à¹€à¸•à¸·à¸­à¸™à¸­à¹ˆà¸­à¸™à¹‚à¸¢à¸™'],
      'ms'   :['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
    };
    var h = HEADER_MAP[lang] || HEADER_MAP['zh-CN'];
    var lines = [
      'You are "Xinlian Butler". OUTPUT LANGUAGE: ' + ln + '. Reply strictly in ' + ln + ' only.',
      'Warm, practical, actionable. No medical/legal conclusions.',
      'Markdown structure:',
      '## ' + h[0],
      '## ' + h[1] + ' (2â€“4 bullets)',
      '## ' + h[2] + ' (2â€“4 bullets)',
      '## ' + h[3] + ' (2â€“3 bullets)',
      '## ' + h[4] + ' (3â€“5 bullets; start with verbs; quantify if possible)',
      '## ' + h[5]
    ];
    if (topic) lines.push('Primary focus topic: ' + topic);
    return lines.join('\n');
  }

  async function runAI(obj, topic){
    if (!topic) topic = '';
    ensureAiCard();

    var lang = getLang();
    var title = gid('butlerTitle'); if (title) title.textContent = t('butler_title');

    var sys = buildButlerSystemPrompt(lang, topic);
    var lp = obj.lp, lv = obj.lv, iso = obj.iso;
    var L = getLang();
    var lineLP = 'Life Path: ' + (lp!=null?lp:'-') + ' â€” ' + (txt(L,'life', lp) || '');
    var lineLV = 'Love Number: ' + (lv!=null?lv:'-') + ' â€” ' + (txt(L,'love', lv) || '');
    var usr = [
      'Birth date: ' + iso,
      lineLP,
      lineLV,
      (topic ? ('Task/Focus: ' + topic) : ('Task/Focus: ' + t('chip_career'))),
      'Expectation: human, concrete and immediately actionable advice.'
    ].join('\n');

    var elC = gid('aiContent');
    if (elC){
      elC.innerHTML =
        '<div class="skeleton">' +
        '  <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>' +
        '  <div style="width:70%"></div><div style="width:50%"></div>' +
        '</div>';
    }

    try{
      var r = await fetch(API_BASE + '/api/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({messages:[
          {role:'system',content:sys},
          {role:'user',content:usr}
        ]})
      });
      var data = await r.json().catch(function(){ return {}; });
      var raw  = (data && (data.reply || data.text || (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content))) || '';
      var html = mdToHtml(raw);

      if(!isVIP()){
        var parts = (raw||'').split(/\n##\s+/);
        var header = parts.shift() || '';
        var kept = [header];
        for (var i=0;i<Math.min(2, parts.length); i++){ kept.push('## ' + parts[i]); }
        html = mdToHtml(kept.join('\n\n')) +
          '<div class="ai-lock-overlay">' +
          '  <div class="tip">' + t('vip_tip') + '</div>' +
          '  <div class="sub" style="margin-top:4px">' + t('vip_sub') + '</div>' +
          '  <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">' + t('btn_unlock') + '</a>' +
          '</div>';
      }

      if(elC) elC.innerHTML = html;
      renderChips();
    }catch(e){
      if(elC) elC.innerHTML = '<div style="color:#98a7b7">' + t('err_network') + ': ' + e.message + '</div>';
    }
  }

  /* =========================
     PRO Report Renderer
  ========================= */
  function bulletList(arr){
    if (!arr || !arr.length) return '';
    return '<ul>' + arr.map(function(s){ return '<li>' + s + '</li>'; }).join('') + '</ul>';
  }

  function renderProReport(obj){
    ensureRootStructure();
    var iso = obj.iso, lp = obj.lp, lv = obj.lv;
    var wrap = gid('numReport');
    var L = getLang();
    var lpTxt = txt(L,'life', lp) || '';
    var lvTxt = txt(L,'love', lv) || '';

    // Career & Money tips sourced from dictionaries
    var career = (PRO[L] && PRO[L].careerTips && PRO[L].careerTips[lp]) ? PRO[L].careerTips[lp] :
                 (PRO['en'].careerTips[lp] || []);
    var money  = (PRO[L] && PRO[L].moneyTips && PRO[L].moneyTips[lp]) ? PRO[L].moneyTips[lp] :
                 (PRO['en'].moneyTips[lp] || []);

    // Relationship guidance mixes Love Number + Life Path nuance
    var relPoints = [];
    if (lvTxt) relPoints.push(lvTxt);
    if (lp===2 || lp===6 || lp===9) relPoints.push(L==='zh-CN' ? "ç»ƒä¹ â€œæœ‰è¾¹ç•Œçš„æ¸©æŸ”â€ï¼ŒæŠŠè‡ªå·±çš„éœ€æ±‚è¯´æ¸…æ¥šã€‚" : "Practice â€˜bounded kindnessâ€™: state your needs clearly.");
    if (lp===1 || lp===8) relPoints.push(L==='zh-CN' ? "ç”¨â€œå…±åŒå†³ç­–â€ä»£æ›¿â€œå•å‘å†³ç­–â€ï¼Œå¢å¼ºäº²å¯†çš„å®‰å…¨æ„Ÿã€‚" : "Use shared decisions to increase safety and closeness.");
    if (lp===5 || lp===7) relPoints.push(L==='zh-CN' ? "çº¦å®šâ€œç©ºé—´ä¸è”ç»“â€çš„èŠ‚å¥ï¼šç»™è‡ªç”±ä¹Ÿç»™è”ç³»ã€‚" : "Create a rhythm of space and connection.");
    if (lp===11 || lp===22 || lp===33) relPoints.push(L==='zh-CN' ? "èƒ½é‡æ•æ„Ÿæ—¶å‡é€Ÿï¼šå°‘äº‰è¾©ï¼Œå¤šå¤ç›˜ä¸å…±è¯†ã€‚" : "When energy is sensitive, slow down: less debate, more reflection and consensus.");

    // Personal Year (use visitor local year)
    var now = new Date();
    var py = calcPersonalYear(iso, now.getFullYear());
    var pyLine = '';
    if (py!=null){
      var map = {
        1: L==='zh-CN' ? "å¼€å¯ä¹‹å¹´ï¼šç«‹æ–°ä¸»é¢˜ï¼Œè½»è£…ä¸Šè·¯ï¼Œæ’­ç§è€Œä¸æ±‚å…¨ã€‚" : "Year 1: Beginnings â€” define themes, travel light, plant seeds.",
        2: L==='zh-CN' ? "åä½œä¹‹å¹´ï¼šæ…¢å°±æ˜¯å¿«ï¼Œå·©å›ºäººè„‰ä¸æƒ…æ„Ÿæ”¯æŒã€‚" : "Year 2: Cooperation â€” slow is smooth; build alliances.",
        3: L==='zh-CN' ? "è¡¨è¾¾ä¹‹å¹´ï¼šå†…å®¹/ç¤¾äº¤æ›å…‰ï¼Œä¿æŒç¨³å®šäº§å‡ºã€‚" : "Year 3: Expression â€” create and publish steadily.",
        4: L==='zh-CN' ? "æ‰“åº•ä¹‹å¹´ï¼šæ­ç»“æ„ã€è¡¥çŸ­æ¿ã€ç»ƒåŸºæœ¬åŠŸã€‚" : "Year 4: Foundations â€” build structure and fundamentals.",
        5: L==='zh-CN' ? "å˜åŠ¨ä¹‹å¹´ï¼šæ¢ç´¢ä¸è½¬åœºï¼Œæ§åˆ¶é£é™©çª—å£ã€‚" : "Year 5: Change â€” explore shifts with risk windows.",
        6: L==='zh-CN' ? "æ‰¿è¯ºä¹‹å¹´ï¼šå®¶åº­/å›¢é˜Ÿè´£ä»»ä¸å“è´¨å‡çº§ã€‚" : "Year 6: Commitments â€” upgrade quality, care.",
        7: L==='zh-CN' ? "å†…çœä¹‹å¹´ï¼šç ”ç©¶ã€ç–—æ„ˆã€å›åˆ°æœ¬å¿ƒã€‚" : "Year 7: Inner work â€” study, healing, essence.",
        8: L==='zh-CN' ? "å®ç°ä¹‹å¹´ï¼šèµ„æºæ•´åˆã€ç»“æœå¯¼å‘ã€æ²»ç†å‡çº§ã€‚" : "Year 8: Realization â€” integrate resources, govern.",
        9: L==='zh-CN' ? "æ”¶æŸä¹‹å¹´ï¼šæ¸…ç†æ—§ç« èŠ‚ï¼Œä¸ºæ–°å‘¨æœŸè…¾æŒªç©ºé—´ã€‚" : "Year 9: Completion â€” clear chapters for the next cycle.",
        11: L==='zh-CN' ? "çµæ„Ÿä¹‹å¹´ï¼šæ„¿æ™¯è½åœ°ï¼Œä¿æŒèº«å¿ƒèŠ‚å¾‹ã€‚" : "Year 11: Inspiration â€” land visions with routines.",
        22: L==='zh-CN' ? "æ¶æ„ä¹‹å¹´ï¼šæŠŠâ€œè§„æ¨¡åŒ–â€å†™è¿›æµç¨‹ä¸åˆ¶åº¦ã€‚" : "Year 22: Architecture â€” scale into processes.",
        33: L==='zh-CN' ? "å¤§çˆ±ä¹‹å¹´ï¼šä»¥è‡ªæˆ‘ç…§æ–™æ¢å–å¯æŒç»­æœåŠ¡ã€‚" : "Year 33: Compassion â€” self-care to sustain service."
      };
      pyLine = (map[py] || '');
    }

    // Actionable 30-day plan seeds
    var seeds = (PRO[L] && PRO[L].planSeeds && PRO[L].planSeeds.generic) ? PRO[L].planSeeds.generic : PRO['en'].planSeeds.generic;

    // Keep Butler focus state
    var oldAi = gid('aiCard');
    var savedKey = (oldAi && oldAi.dataset) ? (oldAi.dataset.topicKey || '') : '';
    var savedTopic = (oldAi && oldAi.dataset) ? (oldAi.dataset.topic || '') : '';

    wrap.innerHTML =
      '<div class="sec">' +
      '  <h3>' + t('sec_overview') + '</h3>' +
      '  <p>' + iso + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_life') + '</h3>' +
      '  <p><b>' + t('sec_life') + '</b>ï¼š<span id="lifePath">' + (lp!=null?lp:'â€”') + '</span></p>' +
      '  <p class="muted" id="lifePathDesc">' + lpTxt + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_love') + '</h3>' +
      '  <p><b>' + t('sec_love') + '</b>ï¼š<span id="loveNumber">' + (lv!=null?lv:'â€”') + '</span></p>' +
      '  <p class="muted" id="loveDesc">' + (txt(L,'love', lv) || '') + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_career') + '</h3>' +
      '  ' + bulletList(career) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_money') + '</h3>' +
      '  ' + bulletList(money) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_rel') + '</h3>' +
      '  ' + bulletList(relPoints) +
      '</div>' +

      (py!=null ? ('<div class="sec"><h3>' + t('sec_year') + '</h3><p><b>PY</b>ï¼š' + py + '</p><p class="muted">' + pyLine + '</p></div>') : '') +

      '<div class="sec">' +
      '  <h3>' + t('sec_plan30') + '</h3>' +
      '  ' + bulletList(seeds) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_gentle') + '</h3>' +
      '  <p class="muted">' + ( (L==='zh-CN') ?
            'æŠŠâ€œèŠ‚å¥æ„Ÿâ€å½“æˆæœ¬æœˆä¸»é¢˜ï¼šç¨³å®šäº§å‡ºã€å°æ­¥å¿«è·‘ã€åŠæ—¶å¤ç›˜ã€‚' :
            'Make â€œrhythmâ€ your theme: steady output, short sprints, timely retros.' ) + '</p>' +
      '</div>';

    ensureAiCard();
    renderChips();

    var newAi = gid('aiCard');
    if (newAi && savedKey) {
      newAi.dataset.topicKey = savedKey;
      newAi.dataset.topic    = savedTopic || t(savedKey);
    }
  }

  /* =========================
     Chat Widget (unchanged)
  ========================= */
  function applyChatI18n(){
    var fab = gid('ssChatFab'),
        inp = gid('ssChatInput'),
        btn = gid('ssChatSend'),
        title = document.querySelector('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('butler_chat_title');
  }
  function mountChat(){
    if (gid('ssChatFab')) return;
    var fab = document.createElement('div');
    fab.className = 'ss-chat-fab';
    fab.id = 'ssChatFab';
    fab.title = t('butler_chat_title');

    var panel = document.createElement('div');
    panel.className = 'ss-chat-panel';
    panel.id = 'ssChatPanel';
    panel.setAttribute('role','dialog');
    panel.setAttribute('aria-label', t('butler_chat_title'));
    panel.innerHTML =
      '<div class="ss-chat-head"><div class="ss-chat-title">' + t('butler_chat_title') + '</div><div class="ss-close" id="ssChatClose">âœ•</div></div>' +
      '<div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>' +
      '<div class="ss-chat-input">' +
      '  <input id="ssChatInput" type="text" placeholder="' + t('chat_placeholder') + '"/>' +
      '  <button id="ssChatSend" class="btn">' + t('chat_send') + '</button>' +
      '</div>';
    document.body.appendChild(fab);
    document.body.appendChild(panel);
    applyChatI18n();

    var $body  = gid('ssChatBody'),
        $input = gid('ssChatInput'),
        $send  = gid('ssChatSend'),
        $close = gid('ssChatClose');

    var open = function(){ panel.style.display='block'; if ($input) $input.focus(); };
    var close = function(){ panel.style.display='none'; };
    fab.addEventListener('click', open);
    if ($close) $close.addEventListener('click', close);

    function addMsg(text, me){
      var div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      if ($input){ $input.value=''; $input.focus(); }
      var sys = [
        'You are "Xinlian Butler". OUTPUT LANGUAGE: ' + (BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese') + '.',
        'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'
      ].join('\n');
      try{
        var r = await fetch(API_BASE + '/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:prompt}]})
        });
        var data = await r.json().catch(function(){ return {}; });
        var reply = (data && (data.reply || data.text || (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content))) || '';
        addMsg(reply || t('err_busy'));
      }catch(e){
        addMsg(t('err_network') + 'ï¼Œ' + t('err_busy'));
      }
    }

    if ($send) $send.addEventListener('click', function(){
      var v = $input ? ($input.value ? $input.value.trim() : '') : '';
      if (v) askChat(v);
    });
    if ($input) $input.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        var v = $input.value ? $input.value.trim() : '';
        if (v) askChat(v);
      }
    });
  }

  /* =========================
     Init & Events
  ========================= */
  document.addEventListener('DOMContentLoaded', function(){
    ensureRootStructure();

    // prefill birthdate to today
    var bd = gid('birthdate');
    if (bd && !bd.value) {
      var now = new Date();
      var y = now.getFullYear();
      var m = String(now.getMonth() + 1).padStart(2, '0');
      var d = String(now.getDate()).padStart(2, '0');
      bd.value = y + '-' + m + '-' + d;
    }

    var sel = gid('langSelect');
    var current = getLang();
    if (sel) sel.value = current;
    document.documentElement.lang = current;

    applyI18n();
    mountChat();
    applyChatI18n();

    // Generate button
    var _btnGen = gid('btnGen');
    if (_btnGen) _btnGen.addEventListener('click', function(){
      var iso = bd ? bd.value : '';
      if(!iso){ var e = t('err_need_birthdate'); var el=gid('error'); if(el){ el.textContent=e; el.style.display='block'; setTimeout(function(){el.style.display='none';},4000); } return; }
      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);
      gid('result').style.display = 'block';
      renderProReport({ iso: iso, lp: lp, lv: lv });
      runAI({ iso: iso, lp: lp, lv: lv });
      window.scrollTo({ top: gid('result').offsetTop - 10, behavior: 'smooth' });
    });

    // Language switch (keep last Butler topic if any)
    if (sel) sel.addEventListener('change', function(){
      setLang(sel.value);
      applyI18n();
      applyChatI18n();
      if (gid('aiChips')) renderChips();

      var iso = bd ? bd.value : '';
      if (!iso) return;

      var oldAi = gid('aiCard');
      var oldKey = (oldAi && oldAi.dataset && oldAi.dataset.topicKey) ? oldAi.dataset.topicKey : '';

      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);

      var res = gid('result');
      if (res && res.style.display !== 'none') {
        renderProReport({ iso: iso, lp: lp, lv: lv });
      }

      var topic = oldKey ? t(oldKey) : '';
      var newAi = gid('aiCard');
      if (newAi && oldKey) {
        newAi.dataset.topicKey = oldKey;
        newAi.dataset.topic = topic;
      }

      if (topic) {
        runAI({ iso: iso, lp: lp, lv: lv }, topic);
      } else if (newAi) {
        runAI({ iso: iso, lp: lp, lv: lv });
      }
    });

    // Chip click => AI
    document.addEventListener('click', function(e){
      var target = e.target || e.srcElement;
      var btn = target && target.closest ? target.closest('.chip') : null;
      if (!btn) return;

      var key   = (btn.dataset && btn.dataset.topicKey) ? btn.dataset.topicKey : '';
      var topic = key ? t(key) : (btn.getAttribute('data-q') || btn.textContent || '');

      var aiCard = gid('aiCard');
      if (aiCard && aiCard.dataset) {
        aiCard.dataset.topic    = topic;
        aiCard.dataset.topicKey = key;
        aiCard.dataset.lang     = getLang();
      }

      var bd = gid('birthdate');
      var iso = bd ? bd.value : '';
      if (!iso) return;

      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);

      runAI({ iso: iso, lp: lp, lv: lv }, topic);
    });
  });
})();
</script>
</body>
</html>


