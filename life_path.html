<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">灵数简评</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- 5XLiving · 基线样式 -->
  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* —— 统一头部 —— */
    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* —— 页面结构 & 按钮 —— */
    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    /* —— 报告皮肤 —— */
    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    /* —— Butler Chat 悬浮球 —— */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* —— Butler Insight 内部样式（与 5xliving 保持一致） —— */
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  </style>
</head>
<body>
  <!-- 统一头部 -->
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="site_title">灵数简评</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">灵数简评</h1>
    <p class="sub" data-i18n="site_subtitle">免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图</p>

    <!-- 表单 -->
    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">出生日期</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">规则</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">毕达哥拉斯 / Pythagorean</option>
            <option value="c" disabled data-i18n="rule_chal">迦勒底 / Chaldean（即将支持）</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">生成分析</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
        说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <!-- 结果（与 5xliving 的 .report/.sec 一致） -->
    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">分析结果</h2>
      <div id="numReport" class="report"></div>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

<script>
(function(){
  'use strict';

  /* ====== 常量 ====== */
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  const LANG_KEY = 'site_lang';
  const gid = id => document.getElementById(id);

  /* ====== i18n 文案（含 Butler/Chat 词条） ====== */
  const I18N = {
    "zh-CN":{
      page_title:"命理供门 · 灵数简评（免费版）",
      site_title:"灵数简评",
      site_subtitle:"免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图",
      lang_label:"语言",
      ph_birthdate:"出生日期",
      rule_pyth:"毕达哥拉斯 / Pythagorean",
      rule_chal:"迦勒底 / Chaldean（即将支持）",
      btn_gen:"生成分析",
      hint_text:"说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。",
      res_title:"分析结果",
      sec_overview:"概览",
      sec_life:"生命路径数",
      sec_love:"情感数字",
      err_need_birthdate:"请先选择出生日期",
      /* Butler */
      butler_title:"心怜管家 · 智能解读", butler_chat_title:"心怜管家 · Chat",
      chip_career:"事业解读", chip_love:"感情关系", chip_money:"财务建议", chip_list:"本周执行清单", chip_30d:"30天计划",
      q_career:"结合我的灵数，继续解读事业与团队协作", q_love:"结合我的灵数，说说感情与长期关系", q_money:"给我与灵数相关的金钱习惯、盲区与改善建议", q_list:"给我一份本周可执行清单（结合灵数）", q_30d:"基于灵数，为我定一个30天成长计划",
      vip_tip:"🔒 VIP 解锁后可查看完整解读", vip_sub:"包含「事业/财富/执行清单/温柔提醒」全部章节与持续追问", btn_unlock:"立即解锁",
      err_network:"网络异常", err_busy:"服务暂时繁忙，请稍后重试。", chat_fab:"问", chat_placeholder:"想了解什么？（如：功能、会员说明）", chat_send:"发送"
    },
    "zh-TW":{
      page_title:"命理供門 · 靈數簡評（免費版）",
      site_title:"靈數簡評",
      site_subtitle:"免費版 · 與首頁同風格 | VIP 解鎖完整靈數地圖",
      lang_label:"語言",
      ph_birthdate:"出生日期",
      rule_pyth:"畢達哥拉斯 / Pythagorean",
      rule_chal:"迦勒底 / Chaldean（即將支援）",
      btn_gen:"生成分析",
      hint_text:"說明：生命路徑 = 生日數字總合降至 1–9（保留 11/22/33）；情感數字 = 出生日（DD）。",
      res_title:"分析結果",
      sec_overview:"總覽",
      sec_life:"生命路徑數",
      sec_love:"情感數字",
      err_need_birthdate:"請先選擇出生日期",
      butler_title:"心怜管家 · 智能解讀", butler_chat_title:"心怜管家 · Chat",
      chip_career:"事業解讀", chip_love:"感情關係", chip_money:"財務建議", chip_list:"本週執行清單", chip_30d:"30天計畫",
      q_career:"結合我的靈數，繼續解讀事業與團隊協作", q_love:"結合我的靈數，談談感情與長期關係", q_money:"給我與靈數相關的金錢習慣、盲點與改善建議", q_list:"給我一份本週可執行清單（結合靈數）", q_30d:"基於靈數，訂一個30天成長計畫",
      vip_tip:"🔒 升級 VIP 以查看完整解讀", vip_sub:"包含「事業／財富／執行清單／溫柔提醒」所有章節與持續追問", btn_unlock:"立即解鎖",
      err_network:"網路異常", err_busy:"服務繁忙，請稍後再試。", chat_fab:"問", chat_placeholder:"想了解什麼？（例如：功能、會員說明）", chat_send:"傳送"
    },
    "en":{
      page_title:"Numerology · Quick Reading (Free)",
      site_title:"Numerology Quick Reading",
      site_subtitle:"Free · Unified style | VIP unlocks full numerology map",
      lang_label:"Language",
      ph_birthdate:"Birth date",
      rule_pyth:"Pythagorean",
      rule_chal:"Chaldean (coming soon)",
      btn_gen:"Generate",
      hint_text:"Life Path = sum of all birthdate digits reduced to 1–9 (keep 11/22/33). Love Number = day (DD), same rule.",
      res_title:"Results",
      sec_overview:"Overview",
      sec_life:"Life Path",
      sec_love:"Love Number",
      err_need_birthdate:"Please pick your birth date first",
      butler_title:"Xinlian Butler · Insight", butler_chat_title:"Xinlian Butler · Chat",
      chip_career:"Career", chip_love:"Relationships", chip_money:"Money Advice", chip_list:"Weekly To-Dos", chip_30d:"30-Day Plan",
      q_career:"Using my numbers, continue with career and teamwork insights", q_love:"Using my numbers, talk about love and long-term relationships", q_money:"Money habits, blind spots and improvements based on my numbers", q_list:"An actionable list for this week (use my numbers)", q_30d:"A 30-day growth plan informed by my numbers",
      vip_tip:"🔒 Unlock VIP to read the full analysis", vip_sub:"Includes Career/Wealth/Action List/Gentle Reminder + follow-ups", btn_unlock:"Unlock now",
      err_network:"Network error", err_busy:"Service is busy. Please try again later.", chat_fab:"Chat", chat_placeholder:"What would you like to know? (e.g., features, membership)", chat_send:"Send"
    },
    "ja":{
      page_title:"数秘術 · クイック鑑定（無料）",
      site_title:"数秘術 · クイック鑑定",
      site_subtitle:"無料版・統一デザイン｜VIPで完全版マップ",
      lang_label:"言語",
      ph_birthdate:"誕生日",
      rule_pyth:"ピタゴラス式",
      rule_chal:"カルデアン（準備中）",
      btn_gen:"鑑定する",
      hint_text:"ライフパス＝生年月日の全桁合計を1–9に縮約（11/22/33は維持）。ラブナンバー＝誕生日DD、同様。",
      res_title:"結果",
      sec_overview:"概要",
      sec_life:"ライフパス",
      sec_love:"ラブナンバー",
      err_need_birthdate:"まず誕生日を選択してください",
      butler_title:"心怜バトラー · インサイト", butler_chat_title:"心怜バトラー · チャット",
      chip_career:"キャリア", chip_love:"人間関係", chip_money:"お金のアドバイス", chip_list:"今週のタスク", chip_30d:"30日プラン",
      q_career:"私の数を使って、キャリアやチームワークの洞察を続けて", q_love:"私の数を使って、恋愛や長期的な関係について", q_money:"数秘に基づく金銭習慣・盲点・改善案を", q_list:"今週の実行リスト（数秘を活用）", q_30d:"数秘に基づく30日間の成長プランを",
      vip_tip:"🔒 VIPで全文表示を解放", vip_sub:"キャリア／金銭／行動リスト／優しいリマインド＋追質問", btn_unlock:"今すぐ解放",
      err_network:"ネットワークエラー", err_busy:"混み合っています。しばらくしてからお試しください。", chat_fab:"問", chat_placeholder:"何を知りたいですか？（機能・会員など）", chat_send:"送信"
    },
    "th":{
      page_title:"ตัวเลขชีวิต · แบบย่อ (ฟรี)",
      site_title:"ตัวเลขชีวิต · แบบย่อ",
      site_subtitle:"ฟรี · สไตล์เดียวกับหน้าแรก | VIP ปลดล็อกแผนที่ตัวเลขเต็ม",
      lang_label:"ภาษา",
      ph_birthdate:"วันเกิด",
      rule_pyth:"พีทาโกรัส",
      rule_chal:"ชาลเดียน (เร็วๆ นี้)",
      btn_gen:"ดูผล",
      hint_text:"Life Path = ผลรวมตัวเลขวันเกิดทั้งหมด เหลือ 1–9 (คง 11/22/33); Love Number = วัน (DD) กติกาเดียวกัน",
      res_title:"ผลลัพธ์",
      sec_overview:"ภาพรวม",
      sec_life:"Life Path",
      sec_love:"Love Number",
      err_need_birthdate:"กรุณาเลือกวันเกิดก่อน",
      butler_title:"ผู้ช่วยซินเหลียน · บทวิเคราะห์", butler_chat_title:"ผู้ช่วยซินเหลียน · แชต",
      chip_career:"การงาน", chip_love:"ความสัมพันธ์", chip_money:"คำแนะนำการเงิน", chip_list:"รายการทำสัปดาห์นี้", chip_30d:"แผน 30 วัน",
      q_career:"อิงตัวเลขของฉัน ช่วยวิเคราะห์งานและทีมต่อ", q_love:"อิงตัวเลขของฉัน พูดถึงความรัก/ความสัมพันธ์ระยะยาว", q_money:"นิสัยการเงิน จุดบอด และแนวทางปรับปรุงตามตัวเลขของฉัน", q_list:"ลิสต์ปฏิบัติสัปดาห์นี้ (อิงตัวเลข)", q_30d:"แผนพัฒนา 30 วันตามตัวเลข",
      vip_tip:"🔒 ปลดล็อก VIP เพื่ออ่านฉบับเต็ม", vip_sub:"รวมงาน/การเงิน/ลิสต์ลงมือทำ/เตือนอย่างอ่อนโยน + ถามต่อ", btn_unlock:"ปลดล็อกทันที",
      err_network:"เครือข่ายผิดพลาด", err_busy:"ระบบหนาแน่น โปรดลองใหม่ภายหลัง", chat_fab:"ถาม", chat_placeholder:"อยากทราบเรื่องใด? (เช่น ฟีเจอร์/สมาชิก)", chat_send:"ส่ง"
    },
    "ms":{
      page_title:"Numerologi · Ringkas (Percuma)",
      site_title:"Numerologi Ringkas",
      site_subtitle:"Percuma · Gaya seragam | VIP membuka peta numerologi penuh",
      lang_label:"Bahasa",
      ph_birthdate:"Tarikh lahir",
      rule_pyth:"Pythagorean",
      rule_chal:"Chaldean (akan datang)",
      btn_gen:"Jana",
      hint_text:"Life Path = jumlah semua digit tarikh lahir dikurang ke 1–9 (kekal 11/22/33); Love Number = hari (DD), peraturan sama",
      res_title:"Keputusan",
      sec_overview:"Gambaran",
      sec_life:"Life Path",
      sec_love:"Love Number",
      err_need_birthdate:"Sila pilih tarikh lahir terlebih dahulu",
      butler_title:"Xinlian Butler · Analisis", butler_chat_title:"Xinlian Butler · Chat",
      chip_career:"Kerjaya", chip_love:"Hubungan", chip_money:"Nasihat Kewangan", chip_list:"Senarai Mingguan", chip_30d:"Pelan 30 Hari",
      q_career:"Berdasarkan nombor saya, teruskan dengan wawasan kerjaya & kerja berpasukan", q_love:"Berdasarkan nombor saya, bincang cinta & hubungan jangka panjang", q_money:"Tabiat wang, titik buta & penambahbaikan berasaskan nombor", q_list:"Senarai tindakan minggu ini (guna nombor saya)", q_30d:"Pelan 30 hari berdasarkan nombor",
      vip_tip:"🔒 Buka VIP untuk melihat analisis penuh", vip_sub:"Termasuk Kerjaya/Kekayaan/Senarai Tindakan/Peringatan Lembut + soalan susulan", btn_unlock:"Buka sekarang",
      err_network:"Ralat rangkaian", err_busy:"Perkhidmatan sibuk. Cuba lagi kemudian.", chat_fab:"Chat", chat_placeholder:"Apa yang anda ingin tahu? (cth: fungsi/keahlian)", chat_send:"Hantar"
    }
  };
  const BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  function getLang(){
    const saved = localStorage.getItem(LANG_KEY);
    if (saved && I18N[saved]) return saved;
    const raw = (navigator.language || 'zh-CN').replace('_','-');
    const map = {'zh':'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW','en':'en','en-US':'en','en-GB':'en','ja':'ja','ja-JP':'ja','th':'th','ms':'ms'};
    return map[raw] || 'zh-CN';
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  function t(key){
    const L = I18N[getLang()] || I18N['zh-CN'];
    return L[key] || (I18N['zh-CN'][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      if (val!=null) el.textContent = val;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const key = el.getAttribute('data-i18n-ph');
      const val = t(key);
      if (val!=null) el.setAttribute('placeholder', val);
    });
    const titleEl = document.querySelector('title[data-i18n]');
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute('data-i18n'));
  }

  /* ====== 灵数计算 ====== */
  const masters = new Set([11,22,33]);
  function reduceNum(n){
    while(n>9 && !masters.has(n)){
      n = String(n).split("").reduce((s,d)=>s+Number(d),0);
    }
    return n;
  }
  function parseDateDigits(iso){
    if(!iso) return null;
    const d = iso.replace(/[^0-9]/g,"");
    if(d.length<8) return null;
    return d.split("").map(Number);
  }
  function calcLifePath(iso){
    const digits = parseDateDigits(iso);
    if(!digits) return null;
    const sum = digits.reduce((s,v)=>s+v,0);
    return reduceNum(sum);
  }
  function calcLoveNumber(iso){
    if(!iso) return null;
    const dd = Number(iso.split("-")[2]||"0");
    if(!dd) return null;
    return reduceNum(dd);
  }

  /* ====== 简要文案 ====== */
  const brief = {
    lp:{1:"独立、自主、领导力强，适合开创型路线；注意别过度强势。",2:"温和、协调、敏感度高，擅长合作与倾听；需避免过度迎合。",3:"表达力强、社交与创意并重；注意分心，持之以恒是关键。",4:"务实、结构感强，重秩序与稳定；留意僵化与保守。",5:"自由、变化、探索；管理好节奏与边界，避免过度冒险。",6:"责任、关怀、美感；注意完美主义与过度操心。",7:"内省、研究、灵性与洞察；学会表达与连接。",8:"野心、成就、资源整合；需平衡权力与良善。",9:"人文、疗愈、艺术与包容；设立界限，避免过度牺牲。",11:"灵感使命、直觉超感；落地执行与规律作息很重要。",22:"大师建构、把抽象化为实务；请善用团队与耐心。",33:"无条件爱、服务与疗愈；先照顾好自己再照亮他人。"},
    love:{1:"在关系中追求主导与效率，学会柔软与倾听能更稳。",2:"渴望亲密与安全感，细腻体贴；避免过度依附。",3:"需要表达与玩心，爱情里重视互动与仪式感。",4:"以责任与承诺为核心，慢热但踏实可靠。",5:"热爱自由与新鲜感，需要尊重空间的伴侣。",6:"愿意照顾与付出，向往家庭与稳定美好生活。",7:"重视精神连接与灵魂共鸣，需要被理解的安静角落。",8:"在关系里也讲目标与效率，需要势均力敌的伙伴。",9:"包容与付出，但要学会不拯救、不内耗。",11:"感应敏锐、灵魂契合度要求高，情绪需要温柔对待。",22:"关系中的大格局与长期建构者，务实又愿景导向。",33:"以爱疗愈的能量流动，先自爱，后相爱。"}
  };

  /* ====== 结果渲染（.report/.sec） ====== */
  function renderReport({iso, lp, lv}){
    const wrap = gid('numReport');
    wrap.innerHTML = `
      <div class="sec">
        <h3>${t('sec_overview')}</h3>
        <p>${iso}</p>
      </div>
      <div class="sec">
        <h3>${t('sec_life')}</h3>
        <p><b>${t('sec_life')}</b>：<span id="lifePath">${lp??'—'}</span></p>
        <p class="muted" id="lifePathDesc">${lp?brief.lp[lp]:''}</p>
      </div>
      <div class="sec">
        <h3>${t('sec_love')}</h3>
        <p><b>${t('sec_love')}</b>：<span id="loveNumber">${lv??'—'}</span></p>
        <p class="muted" id="loveDesc">${lv?brief.love[lv]:''}</p>
      </div>
    `;
    ensureAiCard(); // Butler 区块，放在同皮肤里
  }

  /* ====== Butler Insight（与 5xliving 一致） ====== */
  function mdToHtml(md){
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  function isVIP(){
    return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
  }
  function ensureAiCard(){
    if (gid('aiCard')) return;
    const wrap = gid('numReport'); if(!wrap) return;
    const sec = document.createElement('div');
    sec.className = 'sec';
    sec.id = 'aiCard';
    sec.innerHTML = `
      <h3 id="butlerTitle" data-i18n="butler_title">${t('butler_title')}</h3>
      <div id="aiContent" class="ai-content">
        <div class="skeleton">
          <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
          <div style="width:70%"></div><div style="width:50%"></div>
        </div>
      </div>
      <div class="chips" id="aiChips"></div>`;
    wrap.appendChild(sec);
    renderChips();
  }
  function renderChips(){
    const wrap = gid('aiChips'); if(!wrap) return;
    wrap.innerHTML = '';
    [
      {k:'chip_career', q:'q_career'},
      {k:'chip_love',   q:'q_love'},
      {k:'chip_money',  q:'q_money'},
      {k:'chip_list',   q:'q_list'},
      {k:'chip_30d',    q:'q_30d'},
    ].forEach(it=>{
      const b=document.createElement('button');
      b.className='chip';
      b.textContent=t(it.k);
      b.setAttribute('data-q', t(it.q));
      wrap.appendChild(b);
    });
  }
  function buildButlerSystemPrompt(lang){
    const ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    const HEADER_MAP = {
      'zh-CN':['人物画像','关系与沟通','事业与自我实现','金钱与物质','今日/本周可执行清单','温柔提醒'],
      'zh-TW':['人物画像','關係與溝通','事業與自我實現','金錢與物質','今日/本週可執行清單','溫柔提醒'],
      'en':['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
      'ja':['人物像','関係とコミュニケーション','キャリアと自己実現','お金と物質','今日/今週の実行リスト','やさしいリマインド'],
      'th':['ภาพบุคคล','ความสัมพันธ์ & การสื่อสาร','การงาน & การเติมเต็มตนเอง','การเงิน & วัตถุ','รายการปฏิบัติ (วันนี้/สัปดาห์นี้)','คำเตือนอ่อนโยน'],
      'ms':['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
    };
    const h = HEADER_MAP[lang] || HEADER_MAP['zh-CN'];
    return [
      `You are "Xinlian Butler". OUTPUT LANGUAGE: ${ln}. Reply strictly in ${ln} only.`,
      'Warm, practical, actionable. No medical/legal conclusions.',
      'Markdown structure:',
      `## ${h[0]}`,
      `## ${h[1]} (2–4 bullets)`,
      `## ${h[2]} (2–4 bullets)`,
      `## ${h[3]} (2–3 bullets)`,
      `## ${h[4]} (3–5 bullets; start with verbs; quantify if possible)`,
      `## ${h[5]}`
    ].join('\n');
  }
  async function runAI({iso,lp,lv}){
    ensureAiCard();
    const lang = getLang();
    gid('butlerTitle').textContent = t('butler_title');

    const sys = buildButlerSystemPrompt(lang);
    const usr = [
      `Birth date: ${iso}`,
      `Life Path: ${lp??'-'} — ${lp?brief.lp[lp]||'':''}`,
      `Love Number: ${lv??'-'} — ${lv?brief.love[lv]||'':''}`,
      `Expectation: human, concrete and immediately actionable advice.`
    ].join('\n');

    const elC = gid('aiContent');
    if (elC){
      elC.innerHTML = `<div class="skeleton">
        <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>
        <div style="width:70%"></div><div style="width:50%"></div>
      </div>`;
    }

    try{
      const r = await fetch(API_BASE+'/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:usr}]})
      });
      const data = await r.json().catch(()=>({}));
      const raw = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      let html = mdToHtml(raw);

      if(!isVIP()){
        const parts = raw.split(/\n##\s+/);
        const header = parts.shift() || '';
        const kept = [header, ...(parts.slice(0,2).map(p=>'## '+p))].join('\n\n');
        html = mdToHtml(kept) + `
          <div class="ai-lock-overlay">
            <div class="tip">${t('vip_tip')}</div>
            <div class="sub" style="margin-top:4px">${t('vip_sub')}</div>
            <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">${t('btn_unlock')}</a>
          </div>`;
      }
      if(elC) elC.innerHTML = html;
      renderChips();
    }catch(e){
      if(elC) elC.innerHTML = `<div style="color:#98a7b7">${t('err_network')}: ${e.message}</div>`;
    }
  }

  // 芯片追问
  document.addEventListener('click',(e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    const q = chip.getAttribute('data-q') || chip.textContent;
    const el = gid('aiContent'); if(!el) return;
    el.innerHTML += `<br/><br/><b>—</b> ${q}<br/>`;
    const sys = buildButlerSystemPrompt(getLang());
    fetch(API_BASE+'/api/chat',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages:[
        {role:'system',content:sys+'\n(Continue previous tone. Add concrete steps.)'},
        {role:'user',content:q}
      ]})
    }).then(r=>r.json()).then(data=>{
      const txt=data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      el.innerHTML += mdToHtml('\n\n'+(txt || ('\n\n'+t('err_busy'))));
    }).catch(err=>{
      el.innerHTML += `<div style="color:#98a7b7">${t('err_network')}: ${err.message}</div>`;
    });
  });

  /* ====== 表单交互 ====== */
  function showErr(msg){ const e=gid('error'); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none',4000); }
  function generateReport(){
    const iso = gid('birthdate').value;
    if(!iso) return showErr(t('err_need_birthdate'));
    const lp = calcLifePath(iso);
    const lv = calcLoveNumber(iso);
    gid('result').style.display = 'block';
    renderReport({iso,lp,lv});
    runAI({iso,lp,lv});
    window.scrollTo({top: gid('result').offsetTop-10, behavior:'smooth'});
  }
  gid('btnGen')?.addEventListener('click', generateReport);

  /* ====== Butler Chat 悬浮球 ====== */
  function applyChatI18n(){
    const fab = gid('ssChatFab'), inp=gid('ssChatInput'), btn=gid('ssChatSend'), title=document.querySelector('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('butler_chat_title');
  }
  function mountChat(){
    if (gid('ssChatFab')) return;
    const fab=document.createElement('div'); fab.className='ss-chat-fab'; fab.id='ssChatFab'; fab.title=t('butler_chat_title');
    const panel=document.createElement('div'); panel.className='ss-chat-panel'; panel.id='ssChatPanel'; panel.setAttribute('role','dialog'); panel.setAttribute('aria-label',t('butler_chat_title'));
    panel.innerHTML = `
      <div class="ss-chat-head"><div class="ss-chat-title">${t('butler_chat_title')}</div><div class="ss-close" id="ssChatClose">✕</div></div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')}"/>
        <button id="ssChatSend" class="btn">${t('chat_send')}</button>
      </div>`;
    document.body.appendChild(fab); document.body.appendChild(panel);
    applyChatI18n();

    const $body=gid('ssChatBody'), $input=gid('ssChatInput'), $send=gid('ssChatSend'), $close=gid('ssChatClose');
    const open=()=>{ panel.style.display='block'; $input&&$input.focus(); };
    const close=()=>{ panel.style.display='none'; };
    fab.addEventListener('click',open); $close&&$close.addEventListener('click',close);

    function addMsg(text,me=false){ const div=document.createElement('div'); div.className='ss-msg'+(me?' me':''); div.textContent=text; $body.appendChild(div); $body.scrollTop=$body.scrollHeight; }
    async function askChat(prompt){
      addMsg(prompt,true); if($input){ $input.value=''; $input.focus(); }
      const sys = [
        `You are "Xinlian Butler". OUTPUT LANGUAGE: ${BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese'}.`,
        'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'
      ].join('\n');
      try{
        const r=await fetch(`${API_BASE}/api/chat`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:prompt}]})
        });
        const data = await r.json().catch(()=>({})); const reply = data?.reply??data?.text??data?.choices?.[0]?.message?.content??'';
        addMsg(reply || t('err_busy'));
      }catch(e){ addMsg(`${t('err_network')}，${t('err_busy')}`); }
    }
    $send&&$send.addEventListener('click',()=>{ const v=$input?.value.trim(); if(v) askChat(v); });
    $input&&$input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});
  }

  /* ====== 页面初始化 ====== */
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = gid('langSelect'); const current = getLang(); sel.value = current; document.documentElement.lang = current;
    applyI18n(); applyChatI18n();
    sel.addEventListener('change', ()=>{ setLang(sel.value); applyI18n(); applyChatI18n(); });
    mountChat();
  });

})();
</script>
</body>
</html>
