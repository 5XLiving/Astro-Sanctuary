<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">灵数简评</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* 头部 */
    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* 基础块 */
    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    /* 会员区 */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* 聊天 */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    /* AI 文案区 */
    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}

    .error{color:#ff6b6b;margin-top:8px;display:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .block{width:100%}
    .footnote{color:var(--muted);font-size:.85rem;margin-top:8px}
  </style>
</head>
<body>
  <!-- 头部 -->
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="site_title">灵数简评</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">灵数简评</h1>
    <p class="sub" data-i18n="site_subtitle">免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图</p>

    <!-- 表单 -->
    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">出生日期</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">规则</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">毕达哥拉斯 / Pythagorean</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">生成分析</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
        说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <!-- 结果 -->
    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">心怜管家解读与建议</h2>
      <div id="numReport" class="report"></div>
    </section>

    <!-- 会员区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

<script>
(function(){
'use strict';

/* ===== 基础常量 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const LANG_KEY = 'site_lang';
const gid = id => document.getElementById(id);

/* ===== i18n（保留你的键，并补全必要项） ===== */
const translations = {
  "zh-CN": {
    "page_title":"灵数简评", "site_title":"灵数简评",
    "site_subtitle":"免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图",
    "lang_label":"语言", "ph_birthdate":"出生日期", "rule_pyth":"规则", "btn_gen":"生成分析",
    "hint_text":"说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。",
    "res_title":"心怜管家解读与建议",
    "vip_title":"🌙 会员区域 VIP Segment","vip_mingli":"🗝 命理空间专属内容",
    "vip_love":"姻缘方向：恋爱缘分、婚姻走势","vip_career":"事业方向：职场发展、创业潜力",
    "vip_wealth":"财运方向：财位分析、理财时机","vip_pet":"宠物命理：伴侣动物的性格与缘分",
    "vip_hepan":"合盘分析：婚期择日、新生择时","vip_name":"测名分析：公司名、宝宝名、命名改运",
    "vip_fengshui":"财位合盘：住家 / 办公室动线配合",
    "vip_xinlian":"🌙 心怜空间专属内容","vip_record":"灵性记录：照片、梦境、声音、愿望祈祷",
    "vip_course":"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    "vip_memorial":"家族纪念系统：亲人灵性纪念 & 延续","vip_tasks":"每周能量练习 / 神明仪式任务",
    "vip_shop":"能量商城专属折扣 & 御守订制","login_title":"💎 登入 VIP 功能",
    "panel_login_head":"账户登录 / 注册","ph_email":"邮箱 Email",
    "ph_label_password":"密码 Password","ph_password":"密码 Password（至少8位，含大小写数字符号）",
    "btn_login":"登入账户","btn_reset":"🔑 重设密码","btn_register":"注册账户",
    "note_price":"注册账号赠送一次免费体验","panel_member_head":"会员服务",
    "btn_upgrade":"💎 升级为 VIP（月费）","btn_backshop":"← 返回命理商城",
    "note_price1":"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
    "chat_fab":"问","chat_placeholder":"输入您的问题...","chat_send":"发送",
    "ai_title":"心怜管家解读","ai_local_note":"（已切换本地解读源：网络波动）"
  },
  "en": {
    "page_title":"Numerology Report","site_title":"Numerology Report",
    "site_subtitle":"Free version · VIP unlocks full numerology map",
    "lang_label":"Language","ph_birthdate":"Birth Date","rule_pyth":"Rule","btn_gen":"Generate",
    "hint_text":"Life Path = sum digits of YYYYMMDD reduced to 1–9 (keep 11/22/33); Love Number = DD reduced.",
    "res_title":"Insights & Advice","chat_fab":"Chat","chat_placeholder":"Type your question...","chat_send":"Send",
    "ai_title":"Xinlian Butler · Insights","ai_local_note":"(Using local generator due to network)"
  }
};
/* 语言工具 */
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){ const pack = translations[getLang()] || translations["zh-CN"]; return pack[key] || (translations["zh-CN"][key] || key); }
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{ el.textContent = t(el.getAttribute("data-i18n")); });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{ el.setAttribute("placeholder", t(el.getAttribute("data-i18n-ph"))); });
  const titleEl = document.querySelector("title[data-i18n]"); if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
function applyChatI18n(){
  const fab = gid('ssChatFab'); const inp = gid('ssChatInput'); const btn = gid('ssChatSend'); const title = document.querySelector('.ss-chat-title');
  if (fab) fab.textContent = t('chat_fab'); if (inp) inp.placeholder = t('chat_placeholder'); if (btn) btn.textContent = t('chat_send'); if (title) title.textContent = '心怜管家 · Chat';
}

/* ===== 错误提示 ===== */
function showErr(msg){ const e=gid('error'); if(!e) return; e.textContent=msg; e.style.display='block'; setTimeout(()=>{e.style.display='none';}, 4000); }
function hideErr(){ const e=gid('error'); if(e){ e.style.display='none'; e.textContent=''; }}

/* ===== 结构保障 ===== */
function ensureRootStructure(){
  let result=gid('result');
  if(!result){
    result=document.createElement('section');
    result.id='result'; result.className='card'; result.style.display='none';
    const main=document.querySelector('main')||document.body; main.appendChild(result);
    const h2=document.createElement('h2'); h2.style.cssText='margin:0 0 10px;color:var(--gold)'; h2.setAttribute('data-i18n','res_title'); h2.textContent=t('res_title');
    result.appendChild(h2);
  }
  let numReport=gid('numReport');
  if(!numReport){ numReport=document.createElement('div'); numReport.id='numReport'; numReport.className='report'; result.appendChild(numReport); }
  return numReport;
}

/* ===== 灵数核心 ===== */
const masters={11:1,22:1,33:1};
const isMaster=n=>!!masters[n];
function reduceNum(n){while(n>9&&!isMaster(n)){n=String(n).split('').reduce((a,b)=>a+Number(b),0);}return n;}
function parseDateDigits(iso){if(!iso)return null;const d=iso.replace(/[^0-9]/g,'');if(d.length<8)return null;return d.split('').map(Number);}
function calcLifePath(iso){const d=parseDateDigits(iso);if(!d)return null;return reduceNum(d.reduce((a,b)=>a+b,0));}
function calcLoveNumber(iso){if(!iso)return null;const p=iso.split('-');const dd=Number(p[2]||'0');if(!dd)return null;return reduceNum(dd);}

/* ===== 渲染报告（保留你的结构，并更有内容） ===== */
function renderProReport(obj){
  const wrap=ensureRootStructure();
  const {iso,lp,lv} = obj;
  wrap.innerHTML = `
    <div class="sec">
      <h3>基础信息</h3>
      <p>出生日期: ${iso}</p>
    </div>
    <div class="sec">
      <h3>生命路径数字</h3>
      <p>${lp} ${isMaster(lp) ? '(大师数字)' : ''}</p>
    </div>
    <div class="sec">
      <h3>情感数字</h3>
      <p>${lv} ${isMaster(lv) ? '(大师数字)' : ''}</p>
    </div>
  `;
}

/* ===== 本地兜底文案（更像 AI 输出） ===== */
function localNumerologyInsight({lp,lv}){
  const tone = {
    1:'独立/开创，行动要快但别忘记复盘。',
    2:'温和/协作，设置界线让能量不被耗散。',
    3:'表达/创意，给自己固定“输出小仪式”。',
    4:'秩序/稳固，把长期目标拆成周清单。',
    5:'变化/探索，设定“可控试错”的护栏。',
    6:'照护/责任，先照顾自己，再照顾世界。',
    7:'洞察/研究，给直觉找数据作同盟。',
    8:'权衡/成就，目标要量化，节律要稳定。',
    9:'利他/整合，保留独处时间补能。',
    11:'灵感/觉察，练习把灵感写成行动句。',
    22:'宏观/落地，给愿景配里程碑与预算。',
    33:'疗愈/服务，先界线后奉献，避免透支。'
  };
  const key = (n)=>tone[n]||'保持节律与专注，持续小步快跑。';
  return `
<h3>核心画像</h3>
<p>生命路径 <b>${lp}</b>${isMaster(lp)?'（大师数字）':''} 与情感数字 <b>${lv}</b>${isMaster(lv)?'（大师数字）':''} 的组合，显示你的长期驱动力与亲密/情绪表达方式的互动。</p>

<h3>优势与盲点</h3>
<p>• 生命路径：${key(lp)}<br>• 情感数字：${key(lv)}</p>

<h3>今日/本周可执行</h3>
<p>• 设一个 25 分钟的“单点小冲刺”。<br>• 把一个目标写出“完成定义”。<br>• 用手机闹钟设置一个固定节律（每日/每周）。</p>
  `;
}

/* ===== 调用 AI（重试 + 兜底） ===== */
async function fetchWithRetry(url, options, tries=3){
  let err;
  for(let i=0;i<tries;i++){
    try{
      const r = await fetch(url, options);
      if(r.ok) return r;
      err = new Error('HTTP '+r.status);
    }catch(e){ err = e; }
    await new Promise(res=>setTimeout(res, 500*Math.pow(2,i)));
  }
  throw err;
}

function mdToHtml(md){
  return (md||'')
   .replace(/^##\s+(.*)$/gim,'<h3>$1</h3>')
   .replace(/^###\s+(.*)$/gim,'<h4>$1</h4>')
   .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
   .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
   .replace(/\n{2,}/g,'\n\n')
   .replace(/\n/g,'<br/>');
}

async function runAI(obj){
  const wrap = ensureRootStructure();
  const sec = document.createElement('div'); sec.className='sec';
  sec.innerHTML = `<h3>${t('ai_title')}</h3>
    <div class="skeleton"><div></div><div></div><div></div></div>`;
  wrap.appendChild(sec);

  const sys = '你是“心怜管家”，专业灵数解读师。生成结构化建议：## 核心画像 ## 优势与盲点 ## 今日/本周可执行（动词开头，量化）。语气温暖、可执行。';
  const user = `出生日期: ${obj.iso}
生命路径: ${obj.lp}${isMaster(obj.lp)?'（大师数字）':''}
情感数字: ${obj.lv}${isMaster(obj.lv)?'（大师数字）':''}`;

  try{
    const r = await fetchWithRetry(`${API_BASE}/api/chat`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:user}]})
    }, 3);

    const data = await r.json().catch(()=>({}));
    const raw = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
    sec.innerHTML = `<h3>${t('ai_title')}</h3><div class="ai-content">${mdToHtml(raw||'')}</div>`;
    if(!raw){ throw new Error('empty'); }
  }catch(e){
    // 兜底：本地规则生成 + 温柔脚注
    const local = localNumerologyInsight(obj);
    sec.innerHTML = `<h3>${t('ai_title')}</h3><div class="ai-content">${local}</div>
      <div class="footnote">${t('ai_local_note')}</div>`;
    console.warn('AI fallback:', e?.message||e);
  }
}

/* ===== 聊天组件（保留你的 UI，支持多语言） ===== */
function mountChat(){
  if(gid('ssChatFab')) return;
  const fab = document.createElement('div'); fab.id='ssChatFab'; fab.className='ss-chat-fab'; fab.title='心怜管家';
  const panel = document.createElement('div'); panel.id='ssChatPanel'; panel.className='ss-chat-panel'; panel.style.display='none';
  panel.innerHTML = `
    <div class="ss-chat-head"><div class="ss-chat-title">心怜管家 · Chat</div><div class="ss-close" id="ssChatClose">✕</div></div>
    <div class="ss-chat-body" id="ssChatBody"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" />
      <button id="ssChatSend" class="btn">${t('chat_send')}</button>
    </div>`;
  document.body.appendChild(fab); document.body.appendChild(panel);
  applyChatI18n();

  const body = gid('ssChatBody'), input = gid('ssChatInput');
  const open=()=>{ panel.style.display='block'; input&&input.focus(); };
  const close=()=>{ panel.style.display='none'; };
  fab.onclick=open; gid('ssChatClose').onclick=close;

  function add(text,me=false){ const d=document.createElement('div'); d.className='ss-msg'+(me?' me':''); d.textContent=text; body.appendChild(d); body.scrollTop=body.scrollHeight; }

  gid('ssChatSend').onclick = async ()=>{
    const v = (input?.value||'').trim(); if(!v) return;
    add(v,true); input.value='';
    try{
      const r = await fetchWithRetry(`${API_BASE}/api/chat`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({messages:[
          {role:'system',content:'你是“心怜管家”，回答网站导航/功能/会员相关问题，语气温暖简洁。'},
          {role:'user',content:v}
        ]})
      },2);
      const data = await r.json().catch(()=>({}));
      const reply = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '稍后再试。';
      add(reply);
    }catch(e){
      add('网络有点忙，我稍后再回答。');
    }
  };
}

/* ===== 登录/注册（保留你的接口占位，稳健提示） ===== */
async function safeJson(resp){ try{return await resp.json();}catch{return {ok:false,msg:'upstream_error'};} }
async function loginFlow(email,password){
  try{
    const res = await safeJson(await fetch(`${API_BASE}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
    if(res.ok){ localStorage.setItem('vipEmail',res.email||email); alert('登录成功'); return; }
    if(res.msg==='no_account') return showErr('账户不存在');
    if(res.msg==='wrong_pwd') return showErr('密码错误');
    showErr('登录失败：'+(res.msg||''));
  }catch(e){ showErr('网络错误：'+e.message); }
}
async function registerFlow(email,password){
  try{
    const res = await safeJson(await fetch(`${API_BASE}/api/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})}));
    if(res.ok){ alert('注册成功！请登录。'); return; }
    showErr('注册失败：'+(res.msg||'')); 
  }catch(e){ showErr('网络错误：'+e.message); }
}

/* ===== 初始化 ===== */
function initLangUI(){
  const select = gid('langSelect'); const current = getLang();
  if(select){ select.value = current; select.addEventListener('change', ()=>{ setLang(select.value); applyI18n(); applyChatI18n(); }); }
  applyI18n();
}

function initAuthHandlers(){
  gid('loginForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); const email=gid('email').value; const pwd=gid('password').value; if(!email||!pwd){showErr('请填写邮箱和密码');return;} await loginFlow(email,pwd); });
  gid('registerForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); const email=gid('email').value; const pwd=gid('password').value; if(!email||!pwd){showErr('请填写邮箱和密码');return;} if(pwd.length<8){showErr('密码至少需要8位字符');return;} await registerFlow(email,pwd); });
  gid('resetBtn')?.addEventListener('click', ()=>alert('密码重置功能即将开放'));
}

document.addEventListener('DOMContentLoaded', ()=>{
  initLangUI();
  ensureRootStructure();
  mountChat();
  initAuthHandlers();

  const bd=gid('birthdate'), btn=gid('btnGen');
  function generateNow(){
    const iso=bd?bd.value:'';
    if(!iso){ showErr('请选择出生日期'); return; }
    hideErr();
    const lp=calcLifePath(iso), lv=calcLoveNumber(iso);
    if(!lp||!lv){ showErr('日期格式错误，请检查输入'); return; }
    gid('result').style.display='block';
    renderProReport({iso,lp,lv});
    runAI({iso,lp,lv});
    gid('result').scrollIntoView({behavior:'smooth',block:'start'});
  }
  btn?.addEventListener('click', generateNow);
  bd?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') generateNow(); });
});
})();
</script>
</body>
</html>
