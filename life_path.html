
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">灵数简评</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    /* 头部 */
    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    /* 基础块 */
    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    /* 会员区 */
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    /* 聊天 */
    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    /* 把 AI 解读区块的间距压紧一点 */
    .sec.ai-block h3 {
      margin-top: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .sec.ai-block p {
      margin: 0.35rem 0;
    }

    .sec.ai-block ul {
      margin: 0.4rem 0 0.6rem;
      padding-left: 1.2rem;
    }

    .sec.ai-block li {
      margin: 0.20rem 0;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}

    .error{color:#ff6b6b;margin-top:8px;display:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    .block{width:100%}
    .footnote{color:var(--muted);font-size:.85rem;margin-top:8px}
  </style>
</head>
<body>
  <!-- 头部 -->
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="site_title">灵数简评</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">灵数简评</h1>
    <p class="sub" data-i18n="site_subtitle">免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图</p>

    <!-- 表单 -->
    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">出生日期</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">毕达哥拉斯</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">毕达哥拉斯 / Pythagorean</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">生成分析</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <!-- 结果 -->
    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">心怜管家解读与建议</h2>
      <div id="numReport" class="report"></div>
    </section>

    <!-- 会员区 -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>

      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
              <div id="life-path-block"></div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

<script>
(function(){
'use strict';

/* ===== 基础常量 ===== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const LANG_KEY = 'site_lang';
const gid = id => document.getElementById(id);
window.lastNumCtx = null;  // 记住最近一次的 numerology 结果  

/* ===== i18n ===== */
const translations = {
  "zh-CN": {
    "page_title":"灵数简评", "site_title":"灵数简评",
    "site_subtitle":"免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图",
    "lang_label":"语言", "ph_birthdate":"出生日期", "rule_pyth":"毕达哥拉斯", "btn_gen":"生成分析",
    "res_title":"心怜管家解读与建议",
    "vip_title":"🌙 会员区域 VIP Segment","vip_mingli":"🗝 命理空间专属内容",
    "vip_love":"姻缘方向：恋爱缘分、婚姻走势","vip_career":"事业方向：职场发展、创业潜力",
    "vip_wealth":"财运方向：财位分析、理财时机","vip_pet":"宠物命理：伴侣动物的性格与缘分",
    "vip_hepan":"合盘分析：婚期择日、新生择时","vip_name":"测名分析：公司名、宝宝名、命名改运",
    "vip_fengshui":"财位合盘：住家 / 办公室动线配合",
    "vip_xinlian":"🌙 心怜空间专属内容","vip_record":"灵性记录：照片、梦境、声音、愿望祈祷",
    "vip_course":"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    "vip_memorial":"家族纪念系统：亲人灵性纪念 & 延续","vip_tasks":"每周能量练习 / 神明仪式任务",
    "vip_shop":"能量商城专属折扣 & 御守订制","login_title":"💎 登入 VIP 功能",
    "panel_login_head":"账户登录 / 注册","ph_email":"邮箱 Email",
    "ph_label_password":"密码 Password","ph_password":"密码 Password（至少8位，含大小写数字符号）",
    "btn_login":"登入账户","btn_reset":"🔑 重设密码","btn_register":"注册账户",
    "note_price":"注册账号赠送一次免费体验","panel_member_head":"会员服务",
    "btn_upgrade":"💎 升级为 VIP（月费）","btn_backshop":"← 返回命理商城",
    "note_price1":"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",
    "chat_fab":"问","chat_placeholder":"输入您的问题...","chat_send":"发送",
    "ai_title":"心怜管家解读","ai_local_note":"（已切换本地解读源：网络波动）",
    "sec_basic":"基础信息",
    "sec_lp":"生命路径数字",
    "sec_love":"情感数字",
    "hint_text":"生命路径 = 将西元年/月/日所有数字相加并缩减为 1–9，11 / 22 / 33 保留为大师数字；情感数字 = 出生日（DD）缩减为 1–9。"
  },
  "zh-TW": {
    "page_title":"靈數簡評","site_title":"靈數簡評",
    "site_subtitle":"免費版 · 與首頁風格一致｜VIP 可解鎖完整靈數地圖",
    "lang_label":"語言","ph_birthdate":"出生日期","rule_pyth":"畢達哥拉斯","btn_gen":"生成解析",
    "res_title":"心憐管家解讀與建議",
    "vip_title":"🌙 會員區域 VIP Segment","vip_mingli":"🗝 命理空間專屬內容",
    "vip_love":"姻緣方向：戀愛緣分、婚姻走勢","vip_career":"事業方向：職場發展、創業潛力",
    "vip_wealth":"財運方向：財位分析、理財時機","vip_pet":"寵物命理：伴侶動物的性格與緣分",
    "vip_hepan":"合盤分析：婚期擇日、新生擇時","vip_name":"測名分析：公司名、寶寶名、命名改運",
    "vip_fengshui":"財位合盤：住家／辦公室動線配合",
    "vip_xinlian":"🌙 心憐空間專屬內容","vip_record":"靈性記錄：照片、夢境、聲音、願望祈禱",
    "vip_course":"命理課程：八字／塔羅／占星／靈數／人類圖",
    "vip_memorial":"家族紀念系統：親人靈性紀念＆延續","vip_tasks":"每週能量練習／神明儀式任務",
    "vip_shop":"能量商城專屬折扣＆御守訂製","login_title":"💎 登入 VIP 功能",
    "panel_login_head":"帳號登入／註冊","ph_email":"信箱 Email",
    "ph_label_password":"密碼 Password","ph_password":"密碼 Password（至少 8 位，含大小寫與數字符號）",
    "btn_login":"登入帳號","btn_reset":"🔑 重設密碼","btn_register":"註冊帳號",
    "note_price":"註冊帳號贈送一次免費體驗","panel_member_head":"會員服務",
    "btn_upgrade":"💎 升級為 VIP（月費）","btn_backshop":"← 返回命理商城",
    "note_price1":"$9.9 / 月費 VIP（命理空間＋心憐空間＋靈性課程）",
    "chat_fab":"問","chat_placeholder":"輸入您的問題…","chat_send":"送出",
    "ai_title":"心憐管家解讀","ai_local_note":"（已切換本地解讀源：網路波動）",
    "sec_basic":"基礎資訊",
    "sec_lp":"生命路徑數字",
    "sec_love":"情感數字",
    "hint_text":"生命路徑 = 將西元年／月／日所有數字相加並縮減為 1–9，11 / 22 / 33 保留為大師數；情感數字 = 出生日（DD）縮減為 1–9。"
  },
  "en": {
    "page_title":"Numerology Report","site_title":"Numerology Report",
    "site_subtitle":"Free version · VIP unlocks full numerology map",
    "lang_label":"Language","ph_birthdate":"Birth Date","rule_pyth":"Pythagorean","btn_gen":"Generate",
    "hint_text":"Life Path = sum of all digits in YYYYMMDD reduced to 1–9 (keep 11/22/33); Love Number = day (DD) reduced to 1–9.",
    "res_title":"Insights & Advice",
    "vip_title":"🌙 VIP Segment","vip_mingli":"🗝 Astro Space · Exclusive",
    "vip_love":"Love: attraction patterns & marriage flow","vip_career":"Career: work style & business potential",
    "vip_wealth":"Wealth: money flow & timing","vip_pet":"Pet energy: temperament & bond with you",
    "vip_hepan":"Synastry: wedding date / baby timing","vip_name":"Names: company / baby / renaming for luck",
    "vip_fengshui":"Wealth & space: home / office layout sync",
    "vip_xinlian":"🌙 Xinlian Space · Exclusive","vip_record":"Soul records: photos, dreams, voice, wishes",
    "vip_course":"Courses: Bazi / Tarot / Astrology / Numerology / Human Design",
    "vip_memorial":"Family memorial system","vip_tasks":"Weekly energy practice / ritual tasks",
    "vip_shop":"Energy shop discounts & amulets","login_title":"💎 VIP Login",
    "panel_login_head":"Account Login / Register","ph_email":"Email",
    "ph_label_password":"Password","ph_password":"Password (min 8 chars, mixed case & symbols)",
    "btn_login":"Login","btn_reset":"🔑 Reset Password","btn_register":"Register",
    "note_price":"New account comes with one free trial","panel_member_head":"Membership",
    "btn_upgrade":"💎 Upgrade to VIP (Monthly)","btn_backshop":"← Back to Astro Shop",
    "note_price1":"$9.9 / month VIP (Astro + Xinlian + Courses)",
    "chat_fab":"Chat","chat_placeholder":"Type your question...","chat_send":"Send",
    "ai_title":"Xinlian Butler · Insights","ai_local_note":"(Using local generator due to network)",
    "sec_basic":"Basic Information",
    "sec_lp":"Life Path Number",
    "sec_love":"Love Number"
  },
  "ja": {
    "page_title":"数秘術レポート（簡易版）","site_title":"数秘術レポート",
    "site_subtitle":"無料版 · VIP 会員で完全な数秘マップを解放",
    "lang_label":"言語","ph_birthdate":"生年月日","rule_pyth":"ピタゴラス方式","btn_gen":"解析を生成",
    "hint_text":"ライフパスナンバー = 生年月日の数字（YYYYMMDD）をすべて足して 1〜9 に縮約（11/22/33 はマスターナンバーとして保持）。ラブナンバー = 誕生日（DD）を 1〜9 に縮約。",
    "res_title":"インサイトとアドバイス",
    "vip_title":"🌙 会員エリア VIP Segment","vip_mingli":"🗝 命理スペース限定コンテンツ",
    "vip_love":"恋愛・結婚：ご縁の流れとパターン","vip_career":"仕事・キャリア：適性と起業の可能性",
    "vip_wealth":"お金・豊かさ：収入の流れとタイミング","vip_pet":"ペット：性格とあなたとのご縁",
    "vip_hepan":"相性・シナストリー：結婚日／出産タイミング","vip_name":"命名鑑定：会社名・赤ちゃんの名前・改名",
    "vip_fengshui":"財位・空間：自宅／オフィス動線との調和",
    "vip_xinlian":"🌙 心憐スペース限定コンテンツ","vip_record":"スピリチュアル記録：写真・夢・声・祈り",
    "vip_course":"コース：四柱推命／タロット／占星術／数秘術／ヒューマンデザイン",
    "vip_memorial":"家族メモリアルシステム","vip_tasks":"毎週のエネルギーワーク／儀式タスク",
    "vip_shop":"エナジーショップ割引＆お守りカスタム","login_title":"💎 VIP ログイン",
    "panel_login_head":"ログイン／登録","ph_email":"メールアドレス",
    "ph_label_password":"パスワード","ph_password":"パスワード（8文字以上・英数字と記号）",
    "btn_login":"ログイン","btn_reset":"🔑 パスワード再設定","btn_register":"新規登録",
    "note_price":"新規登録で 1 回無料体験","panel_member_head":"会員サービス",
    "btn_upgrade":"💎 VIP（月額）へアップグレード","btn_backshop":"← 占いショップへ戻る",
    "note_price1":"$9.9 / 月 · VIP（命理スペース＋心憐スペース＋コース）",
    "chat_fab":"Chat","chat_placeholder":"ご質問を入力してください…","chat_send":"送信",
    "ai_title":"心憐バトラー・リーディング","ai_local_note":"（ネットワーク不安定のためローカル解釈を使用）",
    "sec_basic":"基本情報",
    "sec_lp":"ライフパスナンバー",
    "sec_love":"感情／恋愛ナンバー"
  },
  "th": {
    "page_title":"รายงานตัวเลขศาสตร์แบบย่อ","site_title":"รายงานตัวเลขศาสตร์",
    "site_subtitle":"เวอร์ชันฟรี · VIP ปลดล็อกแผนที่ตัวเลขเต็มรูปแบบ",
    "lang_label":"ภาษา","ph_birthdate":"วันเดือนปีเกิด","rule_pyth":"ระบบพิทาโกรัส","btn_gen":"สร้างคำทำนาย",
    "hint_text":"เลขเส้นทางชีวิต = ผลรวมตัวเลขของวันเดือนปีเกิด (YYYYMMDD) ลดให้เหลือ 1–9 โดยเก็บ 11/22/33 เป็นเลขมาสเตอร์; เลขความรัก = วันเกิด (DD) ลดให้เหลือ 1–9.",
    "res_title":"มุมมองและคำแนะนำ",
    "vip_title":"🌙 พื้นที่สมาชิก VIP","vip_mingli":"🗝 เนื้อหาพิเศษในโซนดวง",
    "vip_love":"ความรักและคู่ครอง","vip_career":"การงานและธุรกิจ",
    "vip_wealth":"การเงินและจังหวะรายได้","vip_pet":"สัตว์เลี้ยงและสายสัมพันธ์",
    "vip_hepan":"ความเข้ากันของดวง / วันแต่งงาน / เวลาเกิดลูก","vip_name":"วิเคราะห์ชื่อบริษัท / ลูก / การเปลี่ยนชื่อ",
    "vip_fengshui":"ฮวงจุ้ยด้านการเงิน：บ้าน / สำนักงาน",
    "vip_xinlian":"🌙 พื้นที่ Xinlian พิเศษ","vip_record":"บันทึกจิตวิญญาณ：รูปภาพ ความฝัน เสียง คำอธิษฐาน",
    "vip_course":"คอร์ส：ดวงจีน / ไพ่ยิปซี / โหราศาสตร์ / ตัวเลข / Human Design",
    "vip_memorial":"ระบบระลึกถึงครอบครัว","vip_tasks":"แบบฝึกพลังงานประจำสัปดาห์ / งานพิธีกรรม",
    "vip_shop":"ส่วนลดร้านพลังงาน & เครื่องราง","login_title":"💎 เข้าสู่ระบบ VIP",
    "panel_login_head":"เข้าสู่ระบบ / สมัครสมาชิก","ph_email":"อีเมล",
    "ph_label_password":"รหัสผ่าน","ph_password":"รหัสผ่าน (อย่างน้อย 8 ตัวอักษร)",
    "btn_login":"เข้าสู่ระบบ","btn_reset":"🔑 รีเซ็ตรหัสผ่าน","btn_register":"สมัครสมาชิก",
    "note_price":"สมัครใหม่รับสิทธิ์ทดลองฟรี 1 ครั้ง","panel_member_head":"บริการสมาชิก",
    "btn_upgrade":"💎 อัปเกรดเป็น VIP (รายเดือน)","btn_backshop":"← กลับสู่ร้านค้า",
    "note_price1":"$9.9 / เดือน VIP (ดวง + Xinlian + คอร์ส)",
    "chat_fab":"ถาม","chat_placeholder":"พิมพ์คำถามของคุณ...","chat_send":"ส่ง",
    "ai_title":"ผู้ช่วย Xinlian · คำอธิบาย","ai_local_note":"(ใช้ผลลัพธ์แบบออฟไลน์ชั่วคราว)",
    "sec_basic":"ข้อมูลพื้นฐาน",
    "sec_lp":"เลขเส้นทางชีวิต",
    "sec_love":"เลขด้านอารมณ์ / ความรัก"
  },
  "ms": {
    "page_title":"Laporan Numerologi Ringkas","site_title":"Laporan Numerologi",
    "site_subtitle":"Versi percuma · VIP membuka peta numerologi penuh",
    "lang_label":"Bahasa","ph_birthdate":"Tarikh lahir","rule_pyth":"Sistem Pythagorean","btn_gen":"Jana Analisis",
    "hint_text":"Life Path = jumlah semua digit dalam tarikh lahir (YYYYMMDD) dikurangkan kepada 1–9, kekalkan 11/22/33; Nombor Cinta = hari (DD) dikurangkan kepada 1–9.",
    "res_title":"Pandangan & Nasihat",
    "vip_title":"🌙 Segmen VIP","vip_mingli":"🗝 Kandungan Eksklusif Ruang Astrologi",
    "vip_love":"Cinta: pola tarikan & aliran perkahwinan","vip_career":"Kerjaya: gaya kerja & potensi bisnes",
    "vip_wealth":"Kewangan: aliran rezeki & masa yang sesuai","vip_pet":"Haiwan peliharaan: sikap & kaitan dengan anda",
    "vip_hepan":"Padanan carta: tarikh kahwin / masa kelahiran anak","vip_name":"Analisis nama: syarikat / bayi / penukaran nama",
    "vip_fengshui":"Fengshui rezeki: rumah / pejabat",
    "vip_xinlian":"🌙 Ruang Xinlian Eksklusif","vip_record":"Rekod spiritual: gambar, mimpi, suara, doa",
    "vip_course":"Kursus: Bazi / Tarot / Astrologi / Numerologi / Human Design",
    "vip_memorial":"Sistem memorial keluarga","vip_tasks":"Latihan tenaga mingguan / tugasan ritual",
    "vip_shop":"Diskaun kedai tenaga & azimat","login_title":"💎 Log Masuk VIP",
    "panel_login_head":"Log masuk / Daftar","ph_email":"Emel",
    "ph_label_password":"Kata laluan","ph_password":"Kata laluan (min 8 aksara dengan huruf & simbol)",
    "btn_login":"Log masuk","btn_reset":"🔑 Tetap semula kata laluan","btn_register":"Daftar",
    "note_price":"Akaun baharu menerima satu sesi percubaan percuma","panel_member_head":"Perkhidmatan ahli",
    "btn_upgrade":"💎 Naik taraf ke VIP (Bulanan)","btn_backshop":"← Kembali ke kedai",
    "note_price1":"$9.9 / bulan VIP (Ruang Astro + Xinlian + Kursus)",
    "chat_fab":"Chat","chat_placeholder":"Tulis soalan anda...","chat_send":"Hantar",
    "ai_title":"Xinlian Butler · Insight","ai_local_note":"(Menggunakan penjana tempatan kerana rangkaian)",
    "sec_basic":"Maklumat Asas",
    "sec_lp":"Nombor Life Path",
    "sec_love":"Nombor Cinta"
  }
};

/* 语言工具 */
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){
  const pack = translations[getLang()] || translations["zh-CN"];
  return pack[key] || (translations["zh-CN"][key] || key);
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl){
    const key = titleEl.getAttribute("data-i18n");
    titleEl.textContent = t(key);
  }
}
function applyChatI18n(){
  const fab = gid('ssChatFab');
  const inp = gid('ssChatInput');
  const btn = gid('ssChatSend');
  const title = document.querySelector('.ss-chat-title');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
  if (title) title.textContent = '心怜管家 · Chat';
}

/* ===== 错误提示 ===== */
function showErr(msg){
  const e=gid('error'); if(!e) return;
  e.textContent=msg; e.style.display='block';
  setTimeout(()=>{e.style.display='none';}, 4000);
}
function hideErr(){
  const e=gid('error'); if(e){ e.style.display='none'; e.textContent=''; }
}

/* ===== 结构保障 ===== */
function ensureRootStructure(){
  let result=gid('result');
  if(!result){
    result=document.createElement('section');
    result.id='result'; result.className='card'; result.style.display='none';
    const main=document.querySelector('main')||document.body;
    main.appendChild(result);
    const h2=document.createElement('h2');
    h2.style.cssText='margin:0 0 10px;color:var(--gold)';
    h2.setAttribute('data-i18n','res_title');
    h2.textContent=t('res_title');
    result.appendChild(h2);
  }
  let numReport=gid('numReport');
  if(!numReport){
    numReport=document.createElement('div');
    numReport.id='numReport';
    numReport.className='report';
    result.appendChild(numReport);
  }
  return numReport;
}

/* ===== 灵数核心 ===== */
const masters={11:1,22:1,33:1};
const isMaster=n=>!!masters[n];
function reduceNum(n){
  while(n>9 && !isMaster(n)){
    n = String(n).split('').reduce((a,b)=>a+Number(b),0);
  }
  return n;
}
function parseDateDigits(iso){
  if(!iso) return null;
  const d=iso.replace(/[^0-9]/g,'');
  if(d.length<8) return null;
  return d.split('').map(Number);
}
function calcLifePath(iso){
  const d=parseDateDigits(iso);
  if(!d) return null;
  return reduceNum(d.reduce((a,b)=>a+b,0));
}
function calcLoveNumber(iso){
  if(!iso) return null;
  const p=iso.split('-');
  const dd=Number(p[2]||'0');
  if(!dd) return null;
  return reduceNum(dd);
}

/* ===== 渲染基础摘要（数字 + 简短说明） ===== */
function renderProReport(obj){
  const wrap = ensureRootStructure();
  const { iso, lp, lv } = obj;
  const lang = getLang() || 'zh-CN';

  const basicTitle = t('sec_basic');
  const lpTitle = t('sec_lp');
  const loveTitle = t('sec_love');

  let birthLabel, lpLabel, loveLabel;
  switch (lang) {
    case 'zh-TW':
      birthLabel = '出生日期：';
      lpLabel = '生命路徑 ';
      loveLabel = '情感數字 ';
      break;
    case 'zh-CN':
      birthLabel = '出生日期：';
      lpLabel = '生命路径 ';
      loveLabel = '情感数字 ';
      break;
    case 'ja':
      birthLabel = '生年月日：';
      lpLabel = 'ライフパスナンバー ';
      loveLabel = '感情／恋愛ナンバー ';
      break;
    default:
      birthLabel = 'Birth date: ';
      lpLabel = 'Life Path ';
      loveLabel = 'Love Number ';
  }

  const lpTag = isMaster(lp)
    ? (lang.startsWith('zh') ? '（大师数字）' : '(Master Number)')
    : '';
  const lvTag = isMaster(lv)
    ? (lang.startsWith('zh') ? '（大师数字）' : '(Master Number)')
    : '';

  let tones;
  if (lang === 'ja') {
    tones = {
      1:'主体性が強く、リーダーシップを発揮しやすい数字です。頼ること・人に任せることも学びになります。',
      2:'人の気持ちに敏感で、調整役になりやすいタイプです。境界線を持つことでエネルギーを守れます。',
      3:'表現力とクリエイティブな感性が豊かです。楽しみながらアウトプットすると運気が動きます。',
      4:'安定・秩序・土台づくりの数字です。長期的な仕組みづくりに向いていますが、心配しすぎに注意。',
      5:'変化と自由を求める探究者タイプです。環境を変えることで大きく成長しますが、自律のバランスも大切。',
      6:'責任感が強く、家族や周囲を守ろうとする優しさがあります。まず自分を満たすことがテーマになります。',
      7:'物事を深く考え、探求したい気持ちが強い数字です。直感とデータの両方を大事にすると安定します。',
      8:'成果・達成・マネジメントの数字です。リーダーシップやお金の扱いに学びがあります。',
      9:'共感力が高く、人のために動きやすいヒューマニストです。抱え込みすぎない手放しが大事なテーマです。',
      11:'直感とインスピレーションが強いマスターナンバーです。 grounding（地に足をつけること）が鍵になります。',
      22:'大きなビジョンを現実に落とし込む力を持つマスターナンバーです。段階的な計画が成功のポイントです。',
      33:'奉仕・癒し・教えるエネルギーが強い数字です。自分を犠牲にし過ぎないことが最大のテーマになります。'
    };
  } else if (lang.startsWith('zh')) {
    tones = {
      1:'独立、开创，很适合带头；需要学习的是「请人帮忙」。',
      2:'温和、敏感，擅长协调关系；需要界线感避免被消耗。',
      3:'表达力与创意强，适合说写演；要避免分心与半途而废。',
      4:'重视秩序与安全，适合搭建系统；有时会过度紧绷与担心。',
      5:'热爱自由与变化，适合探索与流动；需要自律来避免失控。',
      6:'在乎责任与承诺，有「照顾人」的天性；要学会先照顾自己。',
      7:'内在思考很多，喜欢研究与深度；需要信任直觉与身体感受。',
      8:'目标感强，适合理财与管理；也要学习柔软与分享。',
      9:'包容、共情，容易为别人付出；要留意情绪累积与逃避。',
      11:'灵感强、感受细腻，是「天线型」；需要稳扎地气与现实结构。',
      22:'有把愿景落地的能力，适合大项目；要分阶段执行，避免过压。',
      33:'带有疗愈与服务使命，但要先照顾好自己，才不会过度透支。'
    };
  } else {
    tones = {
      1:'Independent, pioneering, and needs room to lead.',
      2:'Gentle, cooperative, and sensitive to atmosphere.',
      3:'Expressive, creative, and thrives when sharing ideas.',
      4:'Structured, practical, and strong with systems.',
      5:'Dynamic, curious, and grows through change and travel.',
      6:'Caring, responsible, and focused on home and loved ones.',
      7:'Analytical, intuitive, and drawn to research or spirituality.',
      8:'Ambitious, strategic, and attracted to leadership and results.',
      9:'Compassionate, big-picture, and humanitarian.',
      11:'Highly intuitive and visionary, needs good energetic boundaries.',
      22:'Big-scale builder who can turn vision into concrete impact.',
      33:'Healing, teaching, and service-oriented, but must avoid self-sacrifice.'
    };
  }

  const lpNote = tones[lp] || '';
  const lvNote = tones[lv] || '';

  wrap.innerHTML = `
    <div class="sec">
      <h3>${basicTitle}</h3>
      <p>${birthLabel}${iso}</p>
    </div>
    <div class="sec">
      <h3>${lpTitle}</h3>
      <p>${lpLabel}<b>${lp}</b> ${lpTag}</p>
      ${lpNote ? `<p>${lpNote}</p>` : ''}
    </div>
    <div class="sec">
      <h3>${loveTitle}</h3>
      <p>${loveLabel}<b>${lv}</b> ${lvTag}</p>
      ${lvNote ? `<p>${lvNote}</p>` : ''}
    </div>
  `;
}

/* ===== 本地兜底文案（AI 掉线 / 限流时用） ===== */
function localNumerologyInsight({ iso, lp, lv }) {
  const lang = (typeof getLang === 'function' ? getLang() : 'en') || 'en';
  const isZh = lang.startsWith('zh');
  const isJa = lang === 'ja';

  function isMaster(n) {
    return n === 11 || n === 22 || n === 33;
  }

  // ===== 中文特例：3 / 3 组合，用长版 =====
  if (isZh && lp === 3 && lv === 3) {
    return `
<h3>核心画像</h3>
<p>
生命路径 <b>3</b> 与情感数字 <b>3</b> 的组合，是一个「内外如一的表达者」结构：
你的长期驱动力走表达与创意，情绪运作方式也通过表达来消化、疗愈与连接。
当你一边做、一边讲、一边写时，整体能量是最顺的。
</p>
<p>
当环境允许你做自己、愿意听你说，你会自然绽放：点子多、画面感强、故事感很足，
也很容易用一句话就安抚到别人。但如果长期被打断、被否定，你的表达能量会往内收，
变成自我怀疑、拖延，或什么都不想说。
</p>

<h3>性格与天赋</h3>
<p>
<b>生命路径 3</b> 让你自带一个「小舞台」：你适合说、写、分享过程，
把抽象的东西变成别人听得懂的例子与故事。你很适合：
</p>
<ul>
  <li><b>做内容：</b>文字、脚本、教学、顾问说明、简报、企划包装；</li>
  <li><b>做桥梁：</b>帮别人翻译复杂资讯，变成简单步骤或图像；</li>
  <li><b>做气氛：</b>用幽默、比喻、玩笑，让场面松下来、人放松下来。</li>
</ul>
<p>
你的学习方式也很 3 号：不是闷头看书，而是「讲出来就更懂」。
只要你允许自己边输出边修正，专业度会在说明的过程中快速累积。
</p>

<h3>感情与关系</h3>
<p>
<b>情感数字 3</b> 代表你在亲密关系里，也是走「表达型」路线：
快乐会想分享，受伤会想说出来或写出来。
你需要的是可以一起聊天、交换想法、分享日常细节的连结，而不是只有「一起做事却不说话」。
</p>
<p>
当另一方肯听你讲，也愿意分享自己的内心时，你会很有安全感；
但如果长期被敷衍、被忽略，你会：
</p>
<ul>
  <li>一开始讲很多、解释很多，试图让对方懂你；</li>
  <li>后来突然安静、收回话语权，觉得「讲了也没有用」。</li>
</ul>
<p>
重点不是叫你闭嘴，而是：用比较「有边界」的方式表达——先说「我现在的感受是……」，再慢慢讲细节，
而不是一次把所有东西全部倒出来。
</p>

<h3>优势与盲点</h3>
<p><b>优势：</b></p>
<ul>
  <li><b>表达与故事力：</b>能把复杂主题讲成别人听得懂的故事与画面。</li>
  <li><b>创意与联想力：</b>看到一个点，可以联想到一整串画面与可能性。</li>
  <li><b>疗愈式幽默感：</b>你状态好时，吐槽、玩笑都带一点疗愈效果。</li>
  <li><b>边做边说的整合力：</b>讲解的过程，就是帮自己整理逻辑的过程。</li>
</ul>
<p><b>需要留意：</b></p>
<ul>
  <li><b>容易分心、项目做一半：</b>点子太多，如果没有「完成定义」，很难收尾。</li>
  <li><b>情绪拉着走：</b>别人有沒有回应，很容易被当成「我到底好不好」。</li>
  <li><b>被误解时会用力过猛：</b>越想解释清楚，别人越跟不上。</li>
</ul>

<h3>阶段课题与疗愈</h3>
<p>
重要课题是「让表达有结构」，而不是「不要表达」。
当你为自己的输出设定边界与节奏时，3 号能量会变成很有力量的工具，而不是让你累的来源。
</p>

<h3>今日／本周可执行</h3>
<ul>
  <li><b>1）25 分钟单点小冲刺：</b>只做一件事，例如写一段文案或整理一页内容。</li>
  <li><b>2）写下一个目标的完成定义：</b>例如「这页有三段说明＋一个按钮就算完成」。</li>
  <li><b>3）每天三行日记：</b>今天的观察、感谢的事、最困扰的一点。</li>
  <li><b>4）练习一句情绪用语：</b>「我现在有点乱，想先理一下再说」。</li>
</ul>
    `;
  }

  // ===== 中文特例：1 / 8 组合，用长版 =====
  if (isZh && lp === 1 && lv === 8) {
    return `
<h3>核心画像</h3>
<p>
生命路径 <b>1</b> 搭配情感数字 <b>8</b>，是一组「内在开创、情绪经营」的组合。
你的人生主线是：走在前面、做决定、开路；同时在关系与情绪上，又很在意责任、稳固和实际成果。
</p>

<h3>性格与天赋</h3>
<p>
<b>生命路径 1</b> 代表你适合当发起者与带头的人：
</p>
<ul>
  <li>敢先动手试，遇到新东西也能很快上手；</li>
  <li>有自己的想法，不适合完全照着别人模式复制；</li>
  <li>喜欢知道方向，一旦确定「要这样做」，就会直接冲。</li>
</ul>

<h3>感情与关系</h3>
<p>
<b>情感数字 8</b> 让你在关系里，很难只谈感觉，你会看：
</p>
<ul>
  <li>对方有没有一起承担现实（时间、金钱、家务、未来）；</li>
  <li>关键时刻愿不愿意站出来，而不是让你一个人扛；</li>
  <li>两个人是不是在往同一个目标走。</li>
</ul>

<h3>优势与盲点</h3>
<p><b>优势：</b></p>
<ul>
  <li>方向感强，能够带着团队或家庭往前走；</li>
  <li>对目标、数字、成果很敏感，适合做决策与规划；</li>
  <li>抗压性不错，遇到事会先想办法，而不是马上放弃。</li>
</ul>
<p><b>盲点：</b></p>
<ul>
  <li>习惯自己扛太多，久了会觉得「没有人可以依靠」。</li>
  <li>容易把自我价值绑在成绩或收入上。</li>
  <li>主导感太强时，别人会觉得「被管理」多过「被支持」。</li>
</ul>

<h3>阶段课题与疗愈</h3>
<p>
这一组数字的课题，是练习「在保持领导力的同时，也允许自己被支持」。
不是什么都自己来，而是学会：
</p>
<ul>
  <li>把目标讲清楚，然后合理分工；</li>
  <li>在关系里承认「我也会累、我也需要被照顾」；</li>
  <li>接受不完美版本，而不是一直等 100 分才敢交付。</li>
</ul>

<h3>今日／本周可执行</h3>
<ul>
  <li><b>1）选一件最重要却被你拖延的事，给自己 25 分钟只做这一件。</b></li>
  <li><b>2）写下一个短期目标＋具体数字：</b>例如「本周完成 1 个页面／本月完成 3 次测试」。</li>
  <li><b>3）刻意把一件小事交给别人帮忙做，不是因为你做不到，而是练习建立系统。</li>
  <li><b>4）安排 20 分钟「非效率时间」：</b>散步、发呆或听歌，不看报表、不看数字。</li>
</ul>
    `;
  }

  // ===== 日文版统一简化版 =====
  if (isJa) {
    const tone = {
      1:'主体性・リーダーシップの数字です。ひとりで抱え込みすぎないことがテーマになります。',
      2:'人の気持ちに敏感で、調整役になりやすいタイプです。境界線を引くことが大切です。',
      3:'表現力とクリエイティブな感性が豊かな数字です。楽しくアウトプットすると運気が動きます。',
      4:'安定・土台づくりの数字です。コツコツ積み上げる力がある一方、心配しすぎに注意です。',
      5:'変化と自由を求める探検家タイプです。新しい体験がそのまま成長につながります。',
      6:'責任感が強く、人を守ろうとする優しさがあります。まず自分のケアがテーマです。',
      7:'物事を深く考える研究者タイプです。直感とロジックの両方を大切にすると安定します。',
      8:'達成・マネジメントの数字です。目標設定とペース配分が鍵になります。',
      9:'人の痛みに共感しやすいヒューマニストです。抱え込みすぎず手放すことが課題です。',
      11:'直感とインスピレーションが強いマスターナンバーです。地に足をつける習慣が重要です。',
      22:'大きなビジョンを現実にする力を持つマスターナンバーです。ステップ分けが成功ポイントです。',
      33:'癒しと奉仕のエネルギーが強い数字です。自己犠牲にならない境界線づくりがテーマです。'
    };
    const key = n => tone[n] || '自分のペースで、小さな一歩を丁寧に続けていきましょう。';

    return `
<h3>コアイメージ</h3>
<p>ライフパス <b>${lp}</b>${isMaster(lp)?'（マスターナンバー）':''} と感情／恋愛ナンバー <b>${lv}</b>${isMaster(lv)?'（マスターナンバー）':''} の組み合わせは、あなたの長期的なテーマと、感情・親密さの扱い方を表しています。</p>

<h3>強みとブラインドスポット</h3>
<p>• ライフパス：${key(lp)}<br>• 感情／恋愛：${key(lv)}</p>

<h3>今日〜今週のアクション</h3>
<p>• 25 分だけ「一つのことだけに集中する時間」をつくる。<br>
• 直近の目標を 1 つ選び、「いつ終わりとみなすか（完了条件）」を書き出す。<br>
• 毎日／毎週決まった時間にアラームをセットし、「リセット時間」として使う。</p>
    `;
  }

  // ===== 英文特例：3 / 3 组合，用长版 =====
  if (!isZh && !isJa && lp === 3 && lv === 3) {
    return `
<h3>Core Pattern</h3>
<p>
With Life Path <b>3</b> and Love Number <b>3</b>, you are a double–expression type.
Your long-term drive and your emotional style both run through speaking, writing,
sharing, and creating. When you can turn your inner world into words, stories or
creative output, your system starts to relax and your energy flows.
</p>
<p>
When people give you space to be yourself and actually listen, you naturally light up:
ideas come quickly, images are vivid, and you can often say one sentence that
shifts the whole mood. When you feel ignored or shut down for too long, this
same energy can collapse inward into self-doubt, overthinking, or simply not
wanting to talk anymore.
</p>

<h3>Personality & Talents</h3>
<p>
Life Path <b>3</b> makes you a natural communicator. You are good at:
</p>
<ul>
  <li>turning complex or heavy topics into something people can understand;</li>
  <li>using stories, jokes, or metaphors to soften tense situations;</li>
  <li>learning by explaining — the more you talk it through, the clearer it becomes.</li>
</ul>
<p>
You are not meant to be a silent worker in the corner.
Your growth comes from <b>creating and sharing</b> — even if it feels imperfect at first.
When you allow yourself to “publish messy”, your skill and confidence grow very fast.
</p>

<h3>Love & Emotional Style</h3>
<p>
With Love Number <b>3</b>, emotional connection for you means:
</p>
<ul>
  <li>talking about daily details, not just big events;</li>
  <li>sharing how you feel in the moment, not storing everything inside;</li>
  <li>having someone who can listen, respond, and play with ideas together.</li>
</ul>
<p>
You don’t need drama; you need <b>responsive presence</b>.
If a partner keeps dismissing, interrupting, or changing the topic,
you may start with over-explaining, then suddenly go quiet and pull back.
</p>
<p>
Your key practice here is <b>clean, simple emotional language</b>:
instead of pouring everything out at once, start with sentences like
“I feel a bit overloaded right now, can we slow down?” or
“I feel unseen when this happens…”.
This keeps 3-energy expressive without burning you out.
</p>

<h3>Strengths & Blind Spots</h3>
<p><b>Strengths</b></p>
<ul>
  <li>Strong verbal / written expression; you can “translate” between worlds.</li>
  <li>Creative problem-solving — you see multiple angles and options.</li>
  <li>Natural mood-shifter: your presence, humour, or honesty changes the room.</li>
  <li>Integration through sharing: talking or writing things out is your real thinking process.</li>
</ul>
<p><b>Watch-outs</b></p>
<ul>
  <li>Too many ideas, not enough completion — projects can pile up at 60–80% done.</li>
  <li>Emotional state tied too strongly to feedback and reactions from others.</li>
  <li>When misunderstood, you may talk faster or more, which makes people shut down.</li>
</ul>

<h3>Current Lesson</h3>
<p>
The big lesson for a 3-3 pattern is not “talk less”, but
<b>give your expression structure</b>.
Clear containers — one page, one topic, one time block — turn your talent into
results instead of mental overload.
</p>

<h3>Action Steps for This Week</h3>
<ul>
  <li>
    Choose <b>one</b> thing you care about and give it a 25-minute no-distraction sprint.
    No multi-tasking, no perfecting — just move it forward.
  </li>
  <li>
    Define what “done” means for a small project
    (for example: “three short sections and one call-to-action button”).
  </li>
  <li>
    Start a 3-line daily note: today’s observation, one thing you are grateful for,
    and one thing that is bothering you.
  </li>
  <li>
    Practice one clean sentence when emotions rise:
    “I need a moment to sort my thoughts before I answer.”
  </li>
</ul>
    `;
  }

  // ===== 中文通用版（其他组合）=====
  if (isZh) {
    const tone = {
      1:'独立 / 开创，行动力强，要记得边冲边复盘。',
      2:'温和 / 协作，适合做协调者，但要保护好自己的界线。',
      3:'表达 / 创意，越输出越清晰，避免只想不做。',
      4:'秩序 / 稳固，适合搭建系统，小心完美主义卡住自己。',
      5:'变化 / 探索，需要自由，也需要一点点自律来守住底线。',
      6:'照顾 / 责任，天生会为别人着想，先照顾好自己才走得远。',
      7:'洞察 / 研究，想很多，适合深度分析，也要相信身体感受。',
      8:'成就 / 管理，目标感强，学习「不是所有事都要现在完成」。',
      9:'共情 / 大局，容易为别人付出，也要练习轻轻放手。',
      11:'灵感 / 觉察，天线很敏锐，需要稳定的生活节奏来落地。',
      22:'宏观 / 落地，大计划的执行者，用小步骤来拆大愿景。',
      33:'疗愈 / 服务，很想帮人，也要先让自己处在被滋养的位置。'
    };
    const key = n => tone[n] || '保持节律与专注，持续小步快跑。';

    return `
<h3>核心画像</h3>
<p>出生日期：${iso}</p>
<p>生命路径 <b>${lp}</b>${isMaster(lp)?'（大师数字）':''} ＋ 情感数字 <b>${lv}</b>${isMaster(lv)?'（大师数字）':''}，代表你的人生主题与情绪表达方式如何互相影响。</p>

<h3>优势与盲点</h3>
<p>• 生命路径：${key(lp)}<br>• 情感数字：${key(lv)}</p>

<h3>今日 / 本周可执行</h3>
<ul>
  <li>用 25 分钟只做一件对你来说重要的小任务。</li>
  <li>写下一个具体目标，并标记「做到什么程度就算完成」。</li>
  <li>安排一个固定时间段（每天或每周同一时间），当作自己的 reset 仪式。</li>
</ul>
    `;
  }

  // ===== 其他语言：英文兜底 =====
  const tone = {
    1:'Independent / pioneering — move fast, but remember to review and adjust.',
    2:'Gentle / cooperative — set boundaries so your energy is not drained.',
    3:'Expressive / creative — share your ideas regularly to stay in flow.',
    4:'Structured / practical — break long-term goals into weekly checklists.',
    5:'Dynamic / curious — grow through change, but keep a simple routine as an anchor.',
    6:'Caring / responsible — care for yourself first, then for the world.',
    7:'Analytical / intuitive — let data and intuition work together.',
    8:'Ambitious / strategic — keep goals measurable and your rhythm steady.',
    9:'Compassionate / big-picture — protect alone-time to recharge.',
    11:'Highly intuitive and visionary, needs good energetic boundaries.',
    22:'Big-scale builder who can turn vision into concrete impact.',
    33:'Healing, teaching, and service-oriented, but must avoid self-sacrifice.'
  };
  const key = n => tone[n] || 'Keep your rhythm and focus, and continue with small consistent steps.';

  return `
<h3>Core Profile</h3>
<p>Birth date: ${iso}</p>
<p>Life Path <b>${lp}</b>${isMaster(lp)?' (Master Number)':''} + Love Number <b>${lv}</b>${isMaster(lv)?' (Master Number)':''} describe your main life drive and your emotional / intimacy style.</p>

<h3>Strengths & Blind Spots</h3>
<p>• Life Path: ${key(lp)}<br>
• Love Number: ${key(lv)}</p>

<h3>Action Steps for Today / This Week</h3>
<ul>
  <li>Block 25 minutes for a single-focus sprint on one meaningful task.</li>
  <li>Write down one clear goal and what “done” looks like for you.</li>
  <li>Choose a fixed time each day or week as your reset ritual.</li>
</ul>
  `;
}

/* ===== 调用 AI（重试 + 兜底，生成完整多段报告） ===== */
async function fetchWithRetry(url, options, tries = 3){
  let lastErr;
  for (let i = 0; i < tries; i++){
    try{
      const resp = await fetch(url, options);

      if (resp.status === 429) {
        return resp;
      }
      if (resp.ok) {
        return resp;
      }
      lastErr = new Error('HTTP ' + resp.status);
    }catch(e){
      lastErr = e;
    }
    await new Promise(res => setTimeout(res, 500 * Math.pow(2, i)));
  }
  throw lastErr;
}

function mdToHtml(md){
  return (md||'')
   .replace(/^##\s+(.*)$/gim,'<h3>$1</h3>')
   .replace(/^###\s+(.*)$/gim,'<h4>$1</h4>')
   .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
   .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
   .replace(/\n{2,}/g,'\n\n')
   .replace(/\n/g,'<br/>');
}

/* ===== 语言专属 System Prompt ===== */
function buildSystemPrompt(lang){
  switch(lang){
    case 'ja':
      return `
あなたは「心憐バトラー」というプロの数秘リーダーです。
出力は **すべて日本語** で書いてください。他の言語は混ぜないでください。

レポート構成は必ず次の 6 章にしてください（見出しも日本語）：

## コアイメージ
全体的な雰囲気・人生の主軸・この人らしさをまとめる。

## 性格と才能
ライフパスナンバーから読み取れる性格の強み・才能・日常のスタイルを説明する。

## 感情と人間関係
感情／恋愛ナンバーから、親密な関係のスタイル、コミュニケーション、安心感のポイントを説明する。

## 仕事と豊かさ
向いている働き方、お金との付き合い方、つまずきやすいポイントと調整のヒントを書く。

## 今のテーマと癒し
考えすぎずに受け取れるよう、やさしい言葉で課題や成長テーマをまとめ、癒しのヒントを添える。

## 今日〜今週のアクション
3〜5 個の箇条書きで、すぐ試せる行動を提案する。
・1 行は必ず動詞から始める（例：「○分だけ〜する」「〜を3つ書き出す」など）
・できるだけ具体的な時間・回数を書く。

【重要な禁止事項】
- 「1 はこういう数字、2 はこういう数字…」といった教科書的な数字一覧だけで終わらせないこと。
- 同じライフパス／感情ナンバーの組み合わせでも、毎回コピペの文章にしないこと。
  角度・例え話・行動提案を変えて、別の人として描写すること。
- 抽象的なスピリチュアル用語だけでなく、日常のシーンや具体的な行動に落とし込むこと。

トーン：あたたかく、具体的で、実行しやすい内容にしてください。
恐怖をあおる表現や「運命だから仕方ない」という決めつけは避けてください。`;

    case 'th':
      return `
คุณคือ "Xinlian Butler" นักอ่านตัวเลขศาสตร์มืออาชีพ
ให้ตอบ **เป็นภาษาไทยทั้งหมด** ห้ามผสมภาษาอื่นในหัวข้อหรือเนื้อหา

โครงสร้างรายงานต้องมี 6 หัวข้อดังนี้ (ใช้หัวข้อภาษาไทย):

## ภาพรวมตัวตน
อธิบายบรรยากาศโดยรวม แก่นชีวิต และความเป็นตัวตนของเขา/เธอ

## บุคลิกและพรสวรรค์
อธิบายจุดแข็ง พรสวรรค์ และสไตล์การใช้ชีวิตจากเลขเส้นทางชีวิต (Life Path)

## ความรู้สึกและความสัมพันธ์
อธิบายวิธีแสดงออกทางอารมณ์ การสื่อสาร ความต้องการด้านความปลอดภัย จากเลขความรัก (Love Number)

## การงานและความมั่งคั่ง
เล่าถึงสไตล์การทำงาน วิธีหาเงิน จุดที่ติดขัดบ่อย และแนวทางปรับตัว

## บทเรียนในช่วงนี้และการเยียวยา
ชี้จุดบอดและบทเรียนช่วงนี้ด้วยน้ำเสียงนุ่มนวล ไม่ใช่การข่มขู่ และให้คำแนะนำแบบเยียวยา

## สิ่งที่ทำได้วันนี้ / สัปดาห์นี้
เขียนเป็นข้อย่อย 3–5 ข้อ
- แต่ละข้อขึ้นต้นด้วยคำกริยา (เช่น “เขียน…”, “กันเวลา…นาที”)
- ทำให้เป็นรูปธรรม เช่น จำนวนครั้ง เวลา นาที เป็นต้น

【ข้อห้ามสำคัญ】
- ห้ามเขียนแค่คำอธิบายตำรา เช่น “เลข 1 คือ…, เลข 2 คือ…” แบบลิสต์จบ ๆ
- ถึงแม้เลข Life Path / Love Number จะเหมือนกัน แต่ต้องไม่ใช้ข้อความชุดเดียวกันทั้งดุ้น
  ต้องเปลี่ยนมุมมอง ตัวอย่างสถานการณ์ และข้อเสนอแนะ ให้รู้สึกว่าเป็น “คนละคน”
- ใช้ตัวอย่างจากชีวิตจริง/พฤติกรรมในแต่ละวัน ไม่ใช่คำสวย ๆ ลอย ๆ อย่างเดียว

น้ำเสียง: อบอุ่น มีสติ ไม่ดราม่าหรือฟังดูเป็นชะตากรรมตายตัว ให้ผู้อ่านรู้สึกมีพลังมากขึ้นหลังอ่านจบ`;

    case 'ms':
      return `
Anda ialah "Xinlian Butler", seorang pembaca numerologi profesional.
Sila tulis **semua jawapan dalam Bahasa Melayu** sahaja (jangan campur bahasa lain).

Struktur laporan mesti mempunyai 6 bahagian berikut (guna tajuk BM):

## Profil Teras
Gambarkan aura keseluruhan, tema hidup utama dan keunikan diri orang ini.

## Personaliti & Bakat
Terangkan kekuatan, bakat semula jadi dan gaya harian berdasarkan Nombor Life Path.

## Emosi & Hubungan
Terangkan gaya keintiman, cara berkomunikasi dan keperluan emosi berdasarkan Nombor Cinta.

## Kerjaya & Kewangan
Jelaskan gaya kerja, pola wang, tempat yang mudah tersekat dan cara menyesuaikan diri.

## Pelajaran Semasa & Penyembuhan
Nyatakan blind spot dan tema pembelajaran dengan nada lembut, serta berikan cadangan pemulihan yang tidak menakutkan.

## Tindakan Hari Ini / Minggu Ini
Senaraikan 3–5 cadangan tindakan dalam bentuk bullet:
- Setiap baris mesti bermula dengan kata kerja (cth. “Tulis…”, “Peruntukkan 20 minit untuk…”)
- Nyatakan masa / bilangan kaliให้ชัดเจน

【Peraturan penting】
- Jangan hanya menyalin penerangan buku teks nombor 1–9 dan berhenti di situ.
- Walaupun kombinasi Life Path / Love Number sama, jangan guna perenggan yang sama bulat-bulat.
  Tukar sudut pandang, contoh situasi dan cadangan tindakan supaya terasa peribadi.
- Gunakan contoh dalam kehidupan seharian dan langkah praktikal, bukan istilah rohani yang abstrak sahaja.

Nada: hangat, membumi, praktikal, memberi semangat.
Elakkan bahasa yang menakut-nakutkan atau seolah-olah takdir yang tidak boleh diubah.`;

    case 'en':
      return `
You are "Xinlian Butler", a professional numerology reader.
You MUST write the entire answer in **English only** (no mixing of other languages).

Use this exact 6-section structure with English headings:

## Core Profile
Describe overall vibe, main life theme, and what makes this person "them".

## Personality & Talents
Explain strengths, gifts, and everyday style from the Life Path number.

## Love & Relationships
Explain intimacy style, communication, and emotional needs from the Love number.

## Career & Wealth
Describe work style, money patterns, common blocks, and how to adjust.

## Current Lessons & Healing
Gently name blind spots and growth themes, with supportive, non-scary language.

## Action Steps for Today / This Week
List 3–5 bullet points:
- Each starts with a verb ("Write down...", "Keep 20 minutes for...")
- Make them concrete and measurable (time, count, frequency).

IMPORTANT CONSTRAINTS:
- Do NOT just dump textbook meanings of numbers 1–9 and stop there.
- Even if two people share the same Life Path / Love Number combination,
  you must NOT reuse identical paragraphs. Change the angle, examples,
  and action steps so it feels personal.
- Use real-life situations and behaviour examples, not only abstract spiritual talk.

Tone: warm, grounded, practical, encouraging.
Avoid fatalistic or fear-based language.`;

    case 'zh-TW':
      return `
你是「心憐管家」，一位專業的數秘解讀師。
請 **全程使用繁體中文** 回覆，避免混用其他語言。

報告請固定使用以下六個段落（標題也請用繁體中文）：

## 核心画像
描述對方的整體氣質、人生主軸與「這個人最像什麼樣子」。

## 性格與天賦
從生命路徑數字說明性格優勢、天賦與日常行事風格。

## 感情與關係
從情感數字分析親密關係的互動風格、溝通方式與安全感需求。

## 事業與財富
說明適合的工作模式、賺錢方式、容易卡關之處，以及可行的調整方向。

## 階段課題與療癒
用溫柔、不恐嚇的語氣指出階段性課題與盲點，並給出療癒與自我照顧建議。

## 今日／本週可執行
以 3～5 條條列式建議結尾，每條用動詞開頭，並盡量具體（時間長度、次數等）。

【重要要求】
- 不要寫成「教科書式數字介紹」（例如只列出 1～9 各代表什麼），然後就結束。
- 即使兩個使用者的生命路徑／情感數字組合相同，也不能整段照搬同一份內容；
  請用不同的切入點、比喻與生活場景，寫成「兩個不同的人」。

語氣：溫暖、具體、可行，避免宿命論與恐嚇式說法。`;

    case 'zh-CN':
    default:
      return `
你是「心怜管家」，一位专业的灵数解读师。
请 **全程使用简体中文** 回覆，避免混用其他语言。

报告请固定使用以下六个段落（标题也请用简体中文）：

## 核心画像
描述对方的整体气质、人生主轴与「这个人最像什么样子」。

## 性格与天赋
从生命路径数字说明性格优势、天赋与日常行事风格。

## 感情与关系
从情感数字分析亲密关系的互动风格、沟通方式与安全感需求。

## 事业与财富
说明适合的工作模式、赚钱方式、容易卡关之处，以及可行的调整方向。

## 阶段课题与疗愈
用温柔、不恐吓的语气指出阶段性课题与盲点，并给出疗愈与自我照顾建议。

## 今日／本周可执行
以 3～5 条条列式建议结尾，每条用动词开头，并尽量具体（时间长度、次数等）。

**重要要求：**
- 不要写成「教科书式数字介绍」，不要只是复述 1–9 的标准说明。
- 即使两个人的数字组合相同，也要用不同的角度与比喻来写，避免完全相同的段落或句子。
- 多用生活场景、具体行为建议，而不是抽象的大道理。
- 可以适度结合出生日期当年的时代氛围或阶段感（例如「这个年份的人普遍在经历……」），
  但重点仍然回到个体的节奏与选择。

语气：温暖、具体、可行，避免宿命论与恐吓式说法。`;
  }
}

async function runAI(obj){
  const wrap = ensureRootStructure();
  const lang = getLang() || 'zh-CN';

  wrap.querySelectorAll('.sec.ai-block').forEach(s => s.remove());

  const sec = document.createElement('div');
  sec.className = 'sec ai-block';
  sec.setAttribute('data-lang', lang);
  sec.innerHTML = `<h3>${t('ai_title')}</h3>
    <div class="skeleton"><div></div><div></div><div></div></div>`;
  wrap.appendChild(sec);

  const sys = buildSystemPrompt(lang);
  const user = `
出生日期（ISO）: ${obj.iso}
Life Path: ${obj.lp}${isMaster(obj.lp)?' (Master Number)':''}
Love Number: ${obj.lv}${isMaster(obj.lv)?' (Master Number)':''}
  `;

  try{
    const resp = await fetchWithRetry(`${API_BASE}/api/chat`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        messages:[
          {role:'system',content:sys},
          {role:'user',content:user}
        ]
      })
    }, 3);

    const status = resp.status;
    const textBody = await resp.text();
    console.log('[numerology][runAI] status =', status, 'body =', textBody);

    let data = null;
    try { data = JSON.parse(textBody); } catch(e) {}

    if (data && data.error && data.error.code === 'rate_limit_exceeded') {
      const html = localNumerologyInsight(obj);
      sec.innerHTML = `<h3>${t('ai_title')}</h3><div class="ai-content">${html}</div>`;
      return;
    }

    let raw = '';
    if (data && typeof data === 'object') {
      raw =
        data.reply ||
        data.text ||
        (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ||
        data.message || '';

      if (!raw && data.error) {
        raw = typeof data.error === 'string'
          ? data.error
          : JSON.stringify(data.error);
      }
    } else {
      raw = (textBody || '').trim();
    }

    if (!raw) {
      console.warn('[numerology][runAI] empty reply from backend, data =', data);
      throw new Error('empty_reply');
    }

    const html = mdToHtml(raw);
    if (sec.getAttribute('data-lang') !== getLang()) return;

    sec.innerHTML = `<h3>${t('ai_title')}</h3><div class="ai-content">${html}</div>`;
  }catch(e){
    console.warn('[numerology][runAI] error:', e?.message || e);
    const html = localNumerologyInsight(obj);
    sec.innerHTML = `<h3>${t('ai_title')}</h3>
      <div class="ai-content">${html}</div>`;
  }
}

/* ===== 登录/注册（占位） ===== */
async function safeJson(resp){
  try{return await resp.json();}catch{return {ok:false,msg:'upstream_error'};}
}
async function loginFlow(email,password){
  try{
    const res = await safeJson(await fetch(`${API_BASE}/api/login`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    }));
    if(res.ok){
      localStorage.setItem('vipEmail',res.email||email);
      alert('登录成功');
      return;
    }
    if(res.msg==='no_account') return showErr('账户不存在');
    if(res.msg==='wrong_pwd') return showErr('密码错误');
    showErr('登录失败：'+(res.msg||''));
  }catch(e){
    showErr('网络错误：'+e.message);
  }
}
async function registerFlow(email,password){
  try{
    const res = await safeJson(await fetch(`${API_BASE}/api/register`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    }));
    if(res.ok){
      alert('注册成功！请登录。');
      return;
    }
    showErr('注册失败：'+(res.msg||'')); 
  }catch(e){
    showErr('网络错误：'+e.message);
  }
}

/* ===== Chat System Prompt for Xinlian Butler ===== */
function buildChatSystemPrompt(lang){
  switch(lang){
    case 'en':
      return `You are "Xinlian Butler", a gentle spiritual & numerology assistant.
Always reply in ENGLISH ONLY.
Be warm, concise, and practical. Avoid scary or fatalistic language.`;

    case 'ja':
      return `あなたは「心憐バトラー」というスピリチュアル＆数秘アシスタントです。
必ず日本語だけで回答してください。
トーンはあたたかく、具体的で、相手が少しホッとできる内容にしてください。`;

    case 'th':
      return `คุณคือ "Xinlian Butler" ผู้ช่วยเชิงจิตวิญญาณและตัวเลขศาสตร์
ตอบเป็นภาษาไทยเท่านั้น
น้ำเสียงอบอุ่น ใช้คำง่าย ๆ และไม่ทำให้คนอ่านรู้สึกกลัวหรือหมดหวัง`;

    case 'ms':
      return `Anda ialah "Xinlian Butler", pembantu rohani & numerologi.
Jawab dalam Bahasa Melayu sahaja.
Nada mesra, membumi dan memberi semangat; elakkan bahasa yang menakutkan.`;

    case 'zh-TW':
      return `你是「心憐管家」，一位溫柔的靈性／靈數小助理。
請全程使用繁體中文回覆。
語氣溫暖、具體，不要恐嚇或製造宿命感。`;

    case 'zh-CN':
    default:
      return `你是「心怜管家」，一位溫柔的靈性／靈數小助理。
請全程使用簡體中文回覆。
語氣溫暖、具體，不要恐嚇或製造宿命感。`;
  }
}

/* ===== Xinlian Butler Chat Widget ===== */
function mountChat(){
  if (document.getElementById('ssChatFab')) return;

  const fab = document.createElement('button');
  fab.id = 'ssChatFab';
  fab.type = 'button';
  fab.className = 'ss-chat-fab';
  fab.textContent = t('chat_fab');

  const panel = document.createElement('div');
  panel.id = 'ssChatPanel';
  panel.className = 'ss-chat-panel';
  panel.innerHTML = `
    <div class="ss-chat-head">
      <div class="ss-chat-title">心怜管家 · Chat</div>
      <div class="ss-close" aria-label="Close">✕</div>
    </div>
    <div class="ss-chat-body" id="ssChatBody"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" autocomplete="off" />
      <button class="btn" id="ssChatSend" type="button">${t('chat_send')}</button>
    </div>
  `;

  document.body.appendChild(fab);
  document.body.appendChild(panel);

  applyChatI18n();

  const body   = document.getElementById('ssChatBody');
  const input  = document.getElementById('ssChatInput');
  const sendBtn= document.getElementById('ssChatSend');
  const close  = panel.querySelector('.ss-close');

  function appendMsg(text, me=false){
    const div = document.createElement('div');
    div.className = 'ss-msg' + (me ? ' me' : '');
    div.textContent = text;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }

  async function sendToButler(text){
    const clean = (text || '').trim();
    if (!clean) return;

    const lang = getLang() || 'zh-CN';

    appendMsg(clean, true);

    const placeholder = document.createElement('div');
    placeholder.className = 'ss-msg';
    placeholder.textContent = '...';
    body.appendChild(placeholder);
    body.scrollTop = body.scrollHeight;

    try{
      const sys = buildChatSystemPrompt(lang);
      const resp = await fetchWithRetry(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          messages: [
            { role: 'system', content: sys },
            { role: 'user',   content: clean }
          ]
        })
      }, 3);

      const data = await resp.json().catch(()=> ({}));
      const raw  = data?.reply || data?.text ||
        (data?.choices && data.choices[0]?.message?.content) || '';

      const finalText = raw ? raw.trim() :
        (lang === 'en'
          ? 'I felt a little disconnected from the server. You can try again in a moment.'
          : '刚刚连线有点不稳，可以稍后再问我一次。');

      placeholder.textContent = finalText;
      body.scrollTop = body.scrollHeight;
    }catch(e){
      placeholder.textContent =
        (getLang()==='en'
          ? 'Network error, please try again later.'
          : '网络有点不稳，请稍后再试。');
      body.scrollTop = body.scrollHeight;
    }
  }

  function handleSend(){
    const val = input.value;
    input.value = '';
    sendToButler(val);
  }

  fab.addEventListener('click', ()=>{
    const visible = panel.style.display === 'block';
    panel.style.display = visible ? 'none' : 'block';
    if (!visible) {
      setTimeout(()=> input && input.focus(), 50);
    }
  });

  close.addEventListener('click', ()=>{
    panel.style.display = 'none';
  });

  sendBtn.addEventListener('click', handleSend);
  input.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') handleSend();
  });

  const lang = getLang() || 'zh-CN';
  const welcome =
    lang === 'en'
      ? 'Hi, I am Xinlian Butler. You can ask me about your numbers or anything on your mind.'
      : '嗨，我是心怜管家，可以跟我聊聊你刚刚看到的数字，或最近的心事。';
  appendMsg(welcome, false);

  window.mountChat = mountChat;
}
  
/* ===== 初始化 ===== */
function initLangUI(){
  const select = gid('langSelect');
  const current = getLang();
  if(select){
    select.value = current;
    select.addEventListener('change', ()=>{
      setLang(select.value);
      applyI18n();
      applyChatI18n();
      if (window.lastNumCtx) {
        renderProReport(window.lastNumCtx);
        runAI(window.lastNumCtx);
      }
    });
  }
  applyI18n();
}

function initAuthHandlers(){
  gid('loginForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email=gid('email').value;
    const pwd=gid('password').value;
    if(!email||!pwd){showErr('请填写邮箱和密码');return;}
    await loginFlow(email,pwd);
  });
  gid('registerForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email=gid('email').value;
    const pwd=gid('password').value;
    if(!email||!pwd){showErr('请填写邮箱和密码');return;}
    if(pwd.length<8){showErr('密码至少需要8位字符');return;}
    await registerFlow(email,pwd);
  });
  gid('resetBtn')?.addEventListener('click', ()=>alert('密码重置功能即将开放'));
}

document.addEventListener('DOMContentLoaded', () => {
  initLangUI();
  ensureRootStructure();
  mountChat();
  initAuthHandlers();

  const bd  = gid('birthdate');
  const btn = gid('btnGen');

  if (bd && !bd.value) {
    const today = new Date();
    bd.value = today.toISOString().split('T')[0];
  }

function generateNow() {
  const iso = bd ? bd.value : '';
  if (!iso) {
    showErr(getLang() === 'en' ? 'Please select your birth date.' : '请选择出生日期');
    return;
  }
  hideErr();

  const lp = calcLifePath(iso);
  const lv = calcLoveNumber(iso);
  if (!lp || !lv) {
    showErr(getLang() === 'en' ? 'Invalid date format.' : '日期格式错误，请检查输入');
    return;
  }

  const resultSec = gid('result');
  if (resultSec) resultSec.style.display = 'block';

  const payload = { iso, lp, lv };
  window.lastNumCtx = payload;

  // 上半部：数字简评（基础信息 + 生命路径 + 情感数字）
  renderProReport(payload);

  // 下半部：本地生成「心怜管家解读」，完全不打 API
  const wrap = ensureRootStructure();
  wrap.querySelectorAll('.sec.ai-block').forEach(s => s.remove());
  const sec = document.createElement('div');
  sec.className = 'sec ai-block';
  sec.innerHTML = `<h3>${t('ai_title')}</h3>
    <div class="ai-content">${localNumerologyInsight(payload)}</div>`;
  wrap.appendChild(sec);

  resultSec?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

  if (btn) {
    btn.addEventListener('click', generateNow);
  }
  if (bd) {
    bd.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') generateNow();
    });
  }
});
})();
</script>
</body>
</html>














