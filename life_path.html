<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">çµæ•°ç®€è¯„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !é‡è¦;white-space:nowrap;padding:10px 14px}

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving Â· <span data-i18n="site_title">çµæ•°ç®€è¯„</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">çµæ•°ç®€è¯„</h1>
    <p class="sub" data-i18n="site_subtitle">å…è´¹ç‰ˆ Â· ä¸é¦–é¡µç»Ÿä¸€é£æ ¼ | VIP å¯è§£é”å®Œæ•´çµæ•°åœ°å›¾</p>

    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">å‡ºç”Ÿæ—¥æœŸ</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">è§„åˆ™</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">æ¯•è¾¾å“¥æ‹‰æ–¯ / Pythagorean</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">ç”Ÿæˆåˆ†æ</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
        è¯´æ˜ï¼šç”Ÿå‘½è·¯å¾„ = ç”Ÿæ—¥æ‰€æœ‰æ•°å­—ç›¸åŠ å¹¶é™è‡³ 1â€“9ï¼ˆä¿ç•™ 11/22/33ï¼‰ï¼›æƒ…æ„Ÿæ•°å­— = å‡ºç”Ÿæ—¥ï¼ˆDDï¼‰åŒæ ·è§„åˆ™ã€‚
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®</h2>
      <div id="numReport" class="report"></div>
    </section>

    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
                <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

<script>
(function(){
'use strict';

/* ================= åŸºç¡€å‚æ•° ================= */
const OFFLINE_MODE = false; // éœ€è¦å¼ºåˆ¶ç¦»çº¿æ¼”ç¤ºæ—¶è®¾ä¸º true
const API_ENDPOINTS = [
  'https://throbbing-lab-1440.hello5xliving.workers.dev',
  // å¯ä»¥åœ¨ä¸‹é¢ç»§ç»­è¿½åŠ å¤‡ç”¨ç«¯ç‚¹
];
const API_CHAT_PATH = '/api/chat';
const API_LOGIN_PATH = '/api/login';
const API_REGISTER_PATH = '/api/register';

const LANG_KEY = 'site_lang';
const gid = id => document.getElementById(id);

/* ---------- Polyfills ---------- */
if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector;}
if(!Element.prototype.closest){Element.prototype.closest=function(s){let el=this;while(el&&el.nodeType===1){if(el.matches(s))return el;el=el.parentElement||el.parentNode;}return null;}}

/* ================= i18nï¼ˆä¿ç•™ä½ çš„ keyï¼Œè¡¥é½å¿…è¦é¡¹ï¼‰ ================= */
const translations = {
  "zh-CN": {
    "page_title": "çµæ•°ç®€è¯„",
    "site_title": "çµæ•°ç®€è¯„",
    "site_subtitle": "å…è´¹ç‰ˆ Â· ä¸é¦–é¡µç»Ÿä¸€é£æ ¼ | VIP å¯è§£é”å®Œæ•´çµæ•°åœ°å›¾",
    "lang_label": "è¯­è¨€",
    "ph_birthdate": "å‡ºç”Ÿæ—¥æœŸ",
    "rule_pyth": "è§„åˆ™",
    "btn_gen": "ç”Ÿæˆåˆ†æ",
    "hint_text":"è¯´æ˜ï¼šç”Ÿå‘½è·¯å¾„ = ç”Ÿæ—¥æ‰€æœ‰æ•°å­—ç›¸åŠ å¹¶é™è‡³ 1â€“9ï¼ˆä¿ç•™ 11/22/33ï¼‰ï¼›æƒ…æ„Ÿæ•°å­— = å‡ºç”Ÿæ—¥ï¼ˆDDï¼‰åŒæ ·è§„åˆ™ã€‚",
    "res_title":"å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®",
    "vip_title":"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
    "vip_mingli":"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
    "vip_love":"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
    "vip_career":"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
    "vip_wealth":"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
    "vip_pet":"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
    "vip_hepan":"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    "vip_name":"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
    "vip_fengshui":"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
    "vip_xinlian":"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
    "vip_record":"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    "vip_course":"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
    "vip_memorial":"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
    "vip_tasks":"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
    "vip_shop":"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    "login_title":"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
    "panel_login_head":"è´¦æˆ·ç™»å½• / æ³¨å†Œ",
    "ph_email":"é‚®ç®± Email",
    "ph_label_password":"å¯†ç  Password",
    "ph_password":"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    "btn_login":"ç™»å…¥è´¦æˆ·",
    "btn_reset":"ğŸ”‘ é‡è®¾å¯†ç ",
    "btn_register":"æ³¨å†Œè´¦æˆ·",
    "note_price":"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
    "panel_member_head":"ä¼šå‘˜æœåŠ¡",
    "btn_upgrade":"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
    "btn_backshop":"â† è¿”å›å‘½ç†å•†åŸ",
    "note_price1":"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
    "chat_fab":"é—®",
    "chat_placeholder":"è¾“å…¥æ‚¨çš„é—®é¢˜...",
    "chat_send":"å‘é€"
  },
  "en": {
    "page_title":"Numerology Report",
    "site_title":"Numerology Report",
    "site_subtitle":"Free version Â· VIP unlocks the full numerology map",
    "lang_label":"Language",
    "ph_birthdate":"Birth date",
    "rule_pyth":"Rule",
    "btn_gen":"Generate",
    "hint_text":"Life Path = sum of all digits of birth date, reduce to 1â€“9 (keep 11/22/33); Love Number = day (DD), same rule.",
    "res_title":"Xinlian Butler Â· Reading & Advice",
    "chat_fab":"Chat",
    "chat_placeholder":"Ask me anything...",
    "chat_send":"Send"
  }
};
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){
  const lang = getLang();
  const pack = translations[lang] || translations["zh-CN"];
  return pack[key] ?? translations["zh-CN"][key] ?? key;
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(key) el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    if(key) el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}
function applyChatI18n(){
  const fab = gid('ssChatFab'); 
  const inp = gid('ssChatInput'); 
  const btn = gid('ssChatSend');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
}

/* ================= UI/é”™è¯¯æç¤º ================= */
function showErr(msg){ const e=gid('error'); if(!e) return; e.textContent=msg; e.style.display='block'; setTimeout(()=>{e.style.display='none';}, 5000); }
function hideErr(){ const e=gid('error'); if(!e) return; e.style.display='none'; e.textContent=''; }

/* ================= ä¿è¯ç»“æœåŒºå­˜åœ¨ ================= */
function ensureRootStructure(){
  let result=gid('result');
  if(!result){
    result=document.createElement('section');
    result.id='result';
    result.className='card';
    result.style.display='none';
    const cards=document.querySelectorAll('.card');
    if(cards.length) cards[cards.length-1].after(result); else document.querySelector('main').appendChild(result);
  }
  if(!result.querySelector('h2')){
    const h2=document.createElement('h2');
    h2.style.cssText='margin:0 0 10px;color:var(--gold)';
    h2.setAttribute('data-i18n','res_title');
    h2.textContent=t('res_title');
    result.appendChild(h2);
  }
  let numReport=gid('numReport');
  if(!numReport){
    numReport=document.createElement('div');
    numReport.id='numReport';
    numReport.className='report';
    result.appendChild(numReport);
  }
  return numReport;
}

/* ================= æ•°å­—æ ¸å¿ƒ ================= */
const masters={11:1,22:1,33:1};
const isMaster=n=>!!masters[n];
function reduceNum(n){while(n>9&&!isMaster(n)){n=String(n).split('').reduce((a,b)=>a+Number(b),0);}return n;}
function parseDateDigits(iso){if(!iso)return null;const d=iso.replace(/[^0-9]/g,'');if(d.length<8)return null;return d.split('').map(Number);}
function calcLifePath(iso){const d=parseDateDigits(iso);if(!d)return null;return reduceNum(d.reduce((a,b)=>a+b,0));}
function calcLoveNumber(iso){if(!iso)return null;const p=iso.split('-');const dd=Number(p[2]||'0');if(!dd)return null;return reduceNum(dd);}
function calcPersonalYear(iso,year){if(!iso)return null;const p=iso.split('-');const m=Number(p[1]||'0'),d=Number(p[2]||'0');if(!m||!d)return null;let total=0;(`${m}${d}${year}`).replace(/./g,ch=>total+=Number(ch));return reduceNum(total);}

/* ================= æ¸²æŸ“æŠ¥å‘Šï¼ˆä¿ç•™ä½ çš„åˆ†å—ï¼‰ ================= */
function renderProReport(obj){
  const wrap=ensureRootStructure();
  const {iso,lp,lv}=obj;
  const tag = n=> isMaster(n)?`${n}ï¼ˆå¤§å¸ˆæ•°å­—ï¼‰`:n;
  wrap.innerHTML = `
    <div class="sec">
      <h3>åŸºç¡€ä¿¡æ¯</h3>
      <p>å‡ºç”Ÿæ—¥æœŸï¼š${iso}</p>
    </div>
    <div class="sec">
      <h3>ç”Ÿå‘½è·¯å¾„æ•°å­—</h3>
      <p>${tag(lp)}</p>
    </div>
    <div class="sec">
      <h3>æƒ…æ„Ÿæ•°å­—</h3>
      <p>${tag(lv)}</p>
    </div>
  `;
}

/* ================= ç¨³å¥ç½‘ç»œè¯·æ±‚ï¼ˆé‡è¯•/è¶…æ—¶/å¤šç«¯ç‚¹ï¼‰ ================= */
async function fetchJSONWithTimeout(url, options={}, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const ctrl = new AbortController();
    const t = setTimeout(()=>{ctrl.abort(); reject(new Error('timeout'));}, timeoutMs);
    fetch(url, {...options, signal: ctrl.signal})
      .then(async r=>{
        clearTimeout(t);
        let data=null; try{ data = await r.json(); }catch{ data = {}; }
        if(!r.ok) { const err = new Error(`HTTP ${r.status}`); err.status=r.status; err.data=data; throw err; }
        resolve(data);
      })
      .catch(e=>{ clearTimeout(t); reject(e); });
  });
}

async function apiCall(path, payload, {retries=2, timeout=15000}={}){
  if(OFFLINE_MODE) throw new Error('offline');
  let lastErr = null;
  for(let round=0; round<=retries; round++){
    const base = API_ENDPOINTS[round % API_ENDPOINTS.length];
    try{
      return await fetchJSONWithTimeout(base+path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload||{})
      }, timeout);
    }catch(e){
      lastErr = e;
      // å¯¹ 429/502/503/504 æˆ–ç½‘ç»œé”™è¯¯åšæŒ‡æ•°é€€é¿
      const status = e.status || 0;
      if(round < retries && (status===429 || status===502 || status===503 || status===504 || e.name==='AbortError' || e.message==='Failed to fetch' || e.message==='timeout')){
        await new Promise(r=>setTimeout(r, 600 * Math.pow(2, round)));
        continue;
      }
      break;
    }
  }
  throw lastErr || new Error('unknown');
}

/* ================= AI è§£è¯»ï¼ˆå¤±è´¥â†’æœ¬åœ°å…œåº•ï¼‰ ================= */
function localNumerologyAdvice({iso, lp, lv}){
  const briefly = n=>{
    const map = {
      1:'é¢†å¯¼ä¸å¼€åˆ›ï¼›è¡ŒåŠ¨å…ˆäºçŠ¹è±«ï¼Œç»ƒä¹ â€œè¯·æ±‚å¸®åŠ©â€ã€‚',
      2:'å…±æ„Ÿä¸åˆä½œï¼›é¿å…è¿‡åº¦åœ¨æ„è¯„ä»·ï¼Œå®šç•Œæ›´ç¨³ã€‚',
      3:'è¡¨è¾¾ä¸çµæ„Ÿï¼›æŠŠç‚¹å­è½åœ°æˆæœ€å°è¡ŒåŠ¨ã€‚',
      4:'ç»“æ„ä¸ç¨³å¥ï¼›åˆ«è¢«å®Œç¾ä¸»ä¹‰å¡ä½ï¼Œå…ˆå‡ºæ ·ã€‚',
      5:'å˜åŒ–ä¸è‡ªç”±ï¼›å»ºç«‹â€œå›ºå®šèŠ‚å¥â€æ¥ç§¯ç´¯åŠ¿èƒ½ã€‚',
      6:'è´£ä»»ä¸å…³æ€€ï¼›ä¸å¿…å¯¹æ‰€æœ‰äººè´Ÿè´£ï¼Œä¼˜å…ˆè‡ªæˆ‘ç…§é¡¾ã€‚',
      7:'æ´å¯Ÿä¸æ·±æ½œï¼›æŠŠç ”ç©¶æˆæœåˆ†äº«ç»™ä¸€ä¸ªå°åœˆå­ã€‚',
      8:'æˆå°±ä¸èµ„æºï¼›æŠŠç›®æ ‡æ‹†æˆç°é‡‘æµä¸æ æ†ä¸¤ä¸ªæ¸…å•ã€‚',
      9:'ç–—æ„ˆä¸å®Œæˆï¼›å­¦ä¼šâ€œæ”¾ä¸‹â€ï¼Œä¸ºæ–°å‘¨æœŸç•™ç™½ã€‚',
      11:'ç›´è§‰ä¸çµæ„Ÿæ”¾å¤§ï¼ˆå¤§å¸ˆæ•°ï¼‰ï¼›ç”¨å†¥æƒ³ç¨³ä½é€šé“ã€‚',
      22:'å®è§‚è½åœ°ï¼ˆå¤§å¸ˆæ•°ï¼‰ï¼›ä»ä¸€ç±³è§æ–¹çš„å°é¡¹ç›®å¼€å§‹ã€‚',
      33:'æ— æ¡ä»¶çš„çˆ±ï¼ˆå¤§å¸ˆæ•°ï¼‰ï¼›å…ˆç…§é¡¾å¥½è‡ªå·±çš„èƒ½é‡ã€‚'
    };
    return map[n] || '';
  };
  return `
<h3>æ ¸å¿ƒç”»åƒ</h3>
<p>ç”Ÿå‘½è·¯å¾„ ${lp} ä¸æƒ…æ„Ÿæ•°å­— ${lv} çš„ç»„åˆï¼Œæ˜¾ç¤ºä½ çš„é•¿æœŸè·¯çº¿ä¸äº²å¯†/æƒ…ç»ªè¡¨è¾¾æ–¹å¼å¦‚ä½•äº’åŠ¨ã€‚</p>

<h3>ä¼˜åŠ¿ä¸ç›²ç‚¹</h3>
<p>â€¢ ç”Ÿå‘½è·¯å¾„ï¼š${briefly(lp)}<br>
â€¢ æƒ…æ„Ÿæ•°å­—ï¼š${briefly(lv)}</p>

<h3>ä»Šæ—¥/æœ¬å‘¨å¯æ‰§è¡Œ</h3>
<p>â€¢ è®¾ä¸€ä¸ª 25 åˆ†é’Ÿçš„â€œæœ€å°è¡ŒåŠ¨â€ä¸å¤ç›˜ã€‚<br>
â€¢ æŠŠä¸€ä¸ªç›®æ ‡å†™å‡ºâ€œå®Œæˆå®šä¹‰â€ã€‚<br>
â€¢ ç”¨æ‰‹æœºæé†’è®¾ç½®ä¸€ä¸ªå›ºå®šèŠ‚å¥ï¼ˆæ¯æ—¥/æ¯å‘¨ï¼‰ã€‚</p>
  `.trim();
}

async function runAI(obj){
  const elC = ensureRootStructure();
  const sec = document.createElement('div');
  sec.className = 'sec';
  sec.innerHTML = `<h3>å¿ƒæ€œç®¡å®¶è§£è¯»</h3>
  <div class="skeleton"><div></div><div></div><div></div></div>`;
  elC.appendChild(sec);

  try{
    const data = await apiCall(API_CHAT_PATH, {
      messages: [
        { role:'system', content:'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„çµæ•°è§£è¯»å¸ˆï¼Œè¯·ç»™å‡ºæ¸©æš–ã€æ¸…æ™°ã€å¯æ‰§è¡Œçš„å»ºè®®ï¼›ç”¨ä¸­æ–‡ä½œç­”ã€‚' },
        { role:'user', content: `å‡ºç”Ÿæ—¥æœŸï¼š${obj.iso}\nç”Ÿå‘½è·¯å¾„ï¼š${obj.lp}${isMaster(obj.lp)?'(å¤§å¸ˆæ•°å­—)':''}\næƒ…æ„Ÿæ•°å­—ï¼š${obj.lv}${isMaster(obj.lv)?'(å¤§å¸ˆæ•°å­—)':''}\nè¯·è¾“å‡º 3 æ®µï¼šæ ¸å¿ƒç”»åƒ / ä¼˜åŠ¿ä¸ç›²ç‚¹ / ä»Šæ—¥æˆ–æœ¬å‘¨å¯æ‰§è¡Œå»ºè®®ã€‚` }
      ]
    }, {retries:2, timeout:15000});

    const raw = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
    sec.innerHTML = `<h3>å¿ƒæ€œç®¡å®¶è§£è¯»</h3><div class="ai-content">${raw || localNumerologyAdvice(obj)}</div>`;
  }catch(e){
    // å…œåº•ï¼šæœ¬åœ°ç¦»çº¿è§£è¯»
    sec.innerHTML = `<h3>å¿ƒæ€œç®¡å®¶è§£è¯»</h3>
      <div class="ai-content">${localNumerologyAdvice(obj)}
      <div class="muted" style="margin-top:8px;color:#98a7b7">ï¼ˆå·²ä½¿ç”¨æœ¬åœ°ç¦»çº¿è§£è¯»ï¼›åŸå› ï¼š${e.message || 'ç½‘ç»œä¸å¯ç”¨'}ï¼‰</div>
      </div>`;
    console.warn('[AI Fallback]', e);
  }
}

/* ================= ç™»å½•/æ³¨å†Œï¼ˆä¿æŒä½ çš„æŒ‰é’®ä¸å­—æ®µï¼‰ ================= */
async function loginFlow(email, password){
  try{
    const data = await apiCall(API_LOGIN_PATH, {email, password}, {retries:1, timeout:12000});
    if(data?.ok){ localStorage.setItem('vipEmail', data.email || email); alert('ç™»å½•æˆåŠŸï¼'); return; }
    if(data?.msg==='no_account'){ showErr('è´¦æˆ·ä¸å­˜åœ¨'); return; }
    if(data?.msg==='wrong_pwd'){ showErr('å¯†ç é”™è¯¯'); return; }
    showErr('ç™»å½•å¤±è´¥ï¼š'+(data?.msg||'æœªçŸ¥é”™è¯¯'));
  }catch(e){
    showErr('ç½‘ç»œé”™è¯¯ï¼š'+e.message);
  }
}
async function registerFlow(email, password){
  try{
    const data = await apiCall(API_REGISTER_PATH, {email, password}, {retries:1, timeout:12000});
    if(data?.ok){ alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚'); return; }
    showErr('æ³¨å†Œå¤±è´¥ï¼š'+(data?.msg||'æœªçŸ¥é”™è¯¯'));
  }catch(e){
    showErr('ç½‘ç»œé”™è¯¯ï¼š'+e.message);
  }
}

/* ================= å³ä¸‹è§’èŠå¤©ï¼ˆé‡è¯• & å…œåº•ï¼‰ ================= */
function mountChat(){
  if(gid('ssChatFab')) return;

  const fab=document.createElement('div');
  fab.id='ssChatFab';
  fab.className='ss-chat-fab';
  fab.textContent=t('chat_fab');
  fab.title='å¿ƒæ€œç®¡å®¶';

  const panel=document.createElement('div');
  panel.id='ssChatPanel';
  panel.className='ss-chat-panel';
  panel.innerHTML = `
    <div class="ss-chat-head">
      <div class="ss-chat-title">å¿ƒæ€œç®¡å®¶ Â· Chat</div>
      <div class="ss-close" id="ssChatClose">âœ•</div>
    </div>
    <div class="ss-chat-body" id="ssChatBody"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" placeholder="${t('chat_placeholder')}"/>
      <button id="ssChatSend" class="btn">${t('chat_send')}</button>
    </div>`;

  document.body.appendChild(fab);
  document.body.appendChild(panel);

  applyChatI18n();

  const $body=gid('ssChatBody'), $input=gid('ssChatInput');
  fab.onclick = ()=> panel.style.display='block';
  gid('ssChatClose').onclick = ()=> panel.style.display='none';

  function addMsg(text, me=false){
    const div=document.createElement('div');
    div.className='ss-msg'+(me?' me':'');
    div.textContent=text;
    $body.appendChild(div);
    $body.scrollTop=$body.scrollHeight;
  }

  async function askChat(prompt){
    addMsg(prompt,true);
    if($input){ $input.value=''; $input.focus(); }
    try{
      const data = await apiCall(API_CHAT_PATH,{
        messages:[
          {role:'system', content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå›ç­”è¦æ¸©æš–ã€ç®€æ´ã€å‡†ç¡®ã€‚'},
          {role:'user', content: prompt}
        ]
      }, {retries:2, timeout:12000});
      const reply = data?.reply || data?.text || data?.choices?.[0]?.message?.content || '';
      addMsg(reply || 'ï¼ˆæš‚æ— å›å¤ï¼‰');
    }catch(e){
      addMsg('ï¼ˆå·²ç¦»çº¿ï¼‰ç®€å•å»ºè®®ï¼šæŠŠé—®é¢˜æ‹†æˆ 1 ä¸ªæœ€å°è¡ŒåŠ¨ï¼Œ25 åˆ†é’Ÿå†…å®Œæˆï¼Œç„¶åå¤ç›˜ 3 å¥ã€‚');
    }
  }

  gid('ssChatSend').onclick = ()=>{ const v=$input?.value.trim(); if(v) askChat(v); };
  $input?.addEventListener('keydown',e=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); } });
}

/* ================= è¯­è¨€é€‰æ‹© ================= */
function initLangUI(){
  const select = gid('langSelect');
  const current = getLang();
  if(select){
    select.value = current;
    select.addEventListener('change', ()=>{
      setLang(select.value);
      applyI18n();
      applyChatI18n();
    });
  }
  applyI18n();
}

/* ================= Auth äº‹ä»¶ç»‘å®šï¼ˆä¿ç•™ä½ çš„æŒ‰é’®ï¼‰ ================= */
function initAuthHandlers(){
  gid('loginBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = gid('email')?.value?.trim();
    const password = gid('password')?.value || '';
    if(!email || !password){ showErr('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç '); return; }
    if(password.length<8){ showErr('å¯†ç è‡³å°‘ 8 ä½'); return; }
    await loginFlow(email, password);
  });
  gid('registerBtn')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const email = gid('email')?.value?.trim();
    const password = gid('password')?.value || '';
    if(!email || !password){ showErr('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç '); return; }
    if(password.length<8){ showErr('å¯†ç è‡³å°‘ 8 ä½'); return; }
    await registerFlow(email, password);
  });
  gid('resetBtn')?.addEventListener('click', ()=>{
    alert('å¯†ç é‡ç½®åŠŸèƒ½å³å°†å¼€æ”¾');
  });
}

/* ================= ä¸»åˆå§‹åŒ– ================= */
document.addEventListener('DOMContentLoaded', () => {
  initLangUI();
  ensureRootStructure();
  mountChat();
  initAuthHandlers();

  const bd = gid('birthdate');
  const btn = gid('btnGen');

  function generateNow(){
    const iso = bd ? bd.value : '';
    if(!iso){ showErr('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ'); return; }
    hideErr();
    const lp = calcLifePath(iso);
    const lv = calcLoveNumber(iso);
    if(!lp || !lv){ showErr('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥'); return; }
    gid('result').style.display = 'block';
    renderProReport({iso, lp, lv});
    runAI({iso, lp, lv});
    gid('result').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  btn?.addEventListener('click', generateNow);
  bd?.addEventListener('keydown', e=>{ if(e.key==='Enter') generateNow(); });
});
})();
</script>
</body>
</html>
