<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">灵数简评</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
      --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    html{font-size:16px}
    @media (min-width:768px){ html{font-size:17px} }
    @media (min-width:1200px){ html{font-size:18px} }

    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                  linear-gradient(180deg,#0b0f14,#0b0f14);
      font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body::before{content:""; position:fixed; inset:0; z-index:-2; background:#090d13 url('') center/cover no-repeat; filter:brightness(.45) saturate(.9) blur(2px)}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

    .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand-badge{display:inline-grid; place-items:center; width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018); border:1px solid #2a3546; box-shadow:0 4px 14px rgba(0,0,0,.35); font-weight:800; color:#ffe084}
    .title{font-family:"Noto Serif SC","Noto Serif",serif !important; font-weight:600 !important; letter-spacing:.02em; font-size:1.1rem !important; line-height:1.25}
    .title a{ color: inherit; text-decoration: none; }
    .title a:hover{ text-decoration: underline; text-underline-offset: 3px; }
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{white-space:nowrap; color:var(--muted)}
    .lang select{
      appearance:none; min-width:170px; border-radius:10px; border:1px solid #243244;
      background:#0e1520; color:#e8edf3; padding:10px 34px 10px 12px; font-size:.95rem;
      background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:calc(100% - 12px) 50%;
    }
    @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

    .h1{margin:12px 0 6px; color:#ffe084; font-weight:800; font-size:1.8rem}
    .sub{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }
    label.muted{display:block;margin-bottom:4px}
    input,select,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none}
    input::placeholder{color:#6f8092}
    .btn{display:inline-grid;place-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;font-weight:800;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--gold2);border:1px solid rgba(212,175,55,.45);box-shadow:none}

    .report{margin-top:12px;display:grid;gap:10px}
    .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
    .report .sec h3{margin:0 0 6px;color:#f2d27a;font-size:1.05rem}
    .report p,.report li{line-height:1.7}

    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){ .columns{grid-template-columns:1fr 1fr} }
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .astro-auth{max-width:980px;margin:28px auto;padding:20px 18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .auth-grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){ .auth-grid{grid-template-columns:1fr} }
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(212,175,55,.22);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .head{padding:16px 18px;border-bottom:1px solid rgba(212,175,55,.22);color:var(--gold);font-weight:700;letter-spacing:.3px}
    .panel .body{padding:18px}
    .spacer{height:12px}
    .auth-grid > * { min-width: 0; }
    .panel .body .row.one > * { min-width: 0; }

    .ss-chat-fab{
      position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
      box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
    }
    .ss-chat-panel{
      position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;
      background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
    }
    .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
    .ss-chat-title{font-weight:700}
    .ss-close{cursor:pointer;opacity:.8}
    .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
    .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
    .ss-msg.me{margin-left:auto;background:#132033}
    .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
    .ss-chat-input input{flex:1 1 auto;min-width:0}
    .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto !important;white-space:nowrap;padding:10px 14px}

    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

    .ai-content{white-space:pre-wrap;line-height:1.7}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:#e8edf3;cursor:pointer}
    .skeleton{display:grid;gap:8px}
    .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
    @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
    .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
    .ai-lock-overlay .sub{color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">5xLiving · <span data-i18n="site_title">灵数简评</span></span>
      </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="h1" data-i18n="page_title">灵数简评</h1>
    <p class="sub" data-i18n="site_subtitle">免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图</p>

    <section class="card">
      <div class="row cols-3">
        <div>
          <label class="muted" for="birthdate" data-i18n="ph_birthdate">出生日期</label>
          <input type="date" id="birthdate" data-i18n-ph="ph_birthdate">
        </div>
        <div>
          <label class="muted" for="calcRule" data-i18n="rule_pyth">规则</label>
          <select id="calcRule">
            <option value="p" data-i18n="rule_pyth">毕达哥拉斯 / Pythagorean</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="btnGen" data-i18n="btn_gen">生成分析</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" data-i18n="hint_text">
        说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。
      </div>
      <div class="error" id="error" style="display:none"></div>
    </section>

    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">心怜管家解读与建议</h2>
      <div id="numReport" class="report"></div>
    </section>

    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">🌙 会员区域 VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">🗝 命理空间专属内容</div>
          <ul>
            <li data-i18n="vip_love">姻缘方向：恋爱缘分、婚姻走势</li>
            <li data-i18n="vip_career">事业方向：职场发展、创业潜力</li>
            <li data-i18n="vip_wealth">财运方向：财位分析、理财时机</li>
            <li data-i18n="vip_pet">宠物命理：伴侣动物的性格与缘分</li>
            <li data-i18n="vip_hepan">合盘分析：婚期择日、新生择时</li>
            <li data-i18n="vip_name">测名分析：公司名、宝宝名、命名改运</li>
            <li data-i18n="vip_fengshui">财位合盘：住家 / 办公室动线配合</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">🌙 心怜空间专属内容</div>
          <ul>
            <li data-i18n="vip_record">灵性记录：照片、梦境、声音、愿望祈祷</li>
            <li data-i18n="vip_course">命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图</li>
            <li data-i18n="vip_memorial">家族纪念系统：亲人灵性纪念 & 延续</li>
            <li data-i18n="vip_tasks">每周能量练习 / 神明仪式任务</li>
            <li data-i18n="vip_shop">能量商城专属折扣 & 御守订制</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">💎 登入 VIP 功能</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">账户登录 / 注册</div>
            <div class="body">
              <div class="row" id="authFields">
                <label for="email" class="sr-only" data-i18n="ph_email">邮箱 Email</label>
                <input id="email" name="email" type="email" inputmode="email" autocomplete="username">
                <label for="password" class="sr-only" data-i18n="ph_label_password">密码 Password</label>
                <input id="password" type="password" autocomplete="new-password" placeholder="密码 Password（至少8位，含大小写数字符号）" data-i18n-ph="ph_password" required/>
              </div>
              <div class="spacer"></div>
              <form id="loginForm" class="row one">
                <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">登入账户</button>
              </form>
              <div class="spacer"></div>
              <div class="row one">
                <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">🔑 重设密码</button>
              </div>
              <div class="spacer"></div>
              <form class="row one" id="registerForm">
                <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">注册账户</button>
                <div class="muted" data-i18n="note_price">注册账号赠送一次免费体验</div>
                <div class="spacer"></div>
                <div class="error-message" id="authError" style="display:none"></div>
              </form>
            </div>
          </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">会员服务</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">💎 升级为 VIP（月费）</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">← 返回命理商城</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

<script>
(function(){
  'use strict';

  /* =========================
     Config & Utilities
  ========================= */
  var API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
  var LANG_KEY = 'site_lang';
  var gid = function(id){ return document.getElementById(id); };

  // Polyfills
  if (!Element.prototype.matches) {
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  if (!Element.prototype.closest) {
    Element.prototype.closest = function (s) {
      var el = this;
      while (el && el.nodeType === 1) { if (el.matches(s)) return el; el = el.parentElement || el.parentNode; }
      return null;
    };
  }

  // Ensure result scaffolding exists so Butler can render
  function ensureRootStructure(){
    var result = gid('result');
    if (!result){
      result = document.createElement('section');
      result.id = 'result';
      result.style.display = 'none';
      document.body.appendChild(result);
    }
    var numReport = gid('numReport');
    if (!numReport){
      numReport = document.createElement('div');
      numReport.id = 'numReport';
      result.appendChild(numReport);
    }
    return numReport;
  }

  /* =========================
     i18n
  ========================= */
  const i18n = {
    "zh-CN": {
      page_title:"灵数简评", site_title:"灵数简评",
      site_subtitle:"免费版 · 与首页统一风格 | VIP 可解锁完整灵数地图",
      lang_label:"语言",
      ph_birthdate:"出生日期", rule_pyth:"规则（毕达哥拉斯）", btn_gen:"生成分析",
      hint_text:"说明：生命路径 = 生日所有数字相加并降至 1–9（保留 11/22/33）；情感数字 = 出生日（DD）同样规则。",
      res_title:"心怜管家解读与建议",
      sec_overview:"基础信息",
      sec_life:"生命路径",
      sec_love:"情感数字",
      sec_career:"事业与工作风格",
      sec_money:"金钱与资源模式",
      sec_rel:"关系与边界",
      sec_year:"本年能量（个人年数）",
      sec_plan30:"30天可执行计划",
      sec_gentle:"温柔提醒",
      err_need_birthdate:"请先选择出生日期",
      butler_title:"心怜管家 · 智能解读", butler_chat_title:"心怜管家 · Chat",
      chat_fab:"问", chat_placeholder:"想了解什么？（如：功能、会员说明）", chat_send:"发送",
      chip_career:"事业解读", chip_love:"感情关系", chip_money:"财务建议", chip_list:"本周执行清单", chip_30d:"30天计划",
      q_career:"结合我的灵数，继续解读事业与团队协作",
      q_love:"结合我的灵数，说说感情与长期关系",
      q_money:"给我与灵数相关的金钱习惯、盲区与改善建议",
      q_list:"给我一份本周可执行清单（结合灵数）",
      q_30d:"基于灵数，为我定一个30天成长计划",
      vip_tip:"🔒 VIP 解锁后可查看完整解读",
      vip_sub:"包含「事业/财富/执行清单/温柔提醒」全部章节与持续追问",
      btn_unlock:"立即解锁",
      err_network:"网络异常", err_busy:"服务暂时繁忙，请稍后重试。",
      vip_title:"🌙 会员区域 VIP Segment", vip_mingli:"🗝 命理空间专属内容",
      vip_love:"姻缘方向：恋爱缘分、婚姻走势", vip_career:"事业方向：职场发展、创业潜力",
      vip_wealth:"财运方向：财位分析、理财时机", vip_pet:"宠物命理：伴侣动物的性格与缘分",
      vip_hepan:"合盘分析：婚期择日、新生择时", vip_name:"测名分析：公司名、宝宝名、命名改运",
      vip_fengshui:"财位合盘：住家 / 办公室动线配合",
      vip_xinlian:"🌙 心怜空间专属内容", vip_record:"灵性记录：照片、梦境、声音、愿望祈祷",
      vip_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
      vip_memorial:"家族纪念系统：亲人灵性纪念 & 延续", vip_tasks:"每周能量练习 / 神明仪式任务",
      vip_shop:"能量商城专属折扣 & 御守订制", login_title:"💎 登入 VIP 功能",
      panel_login_head:"账户登录 / 注册",
      ph_email:"邮箱 Email", ph_password:"密码 Password（至少 8 位，需包含大小写字母、数字与符号）", ph_label_password:"密码 Password",
      btn_login:"登录账户", btn_register:"注册账户", btn_reset:"🔑 重设密码",
      panel_member_head:"会员服务", btn_upgrade:"💎 升级为 VIP（月费）", btn_backshop:"← 返回命理商城",
      note_price:"注册账号赠送一次免费体验", note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）"
    },
    "zh-TW": { /* …(原内容保留)… */ },
    "en": { /* …(原内容保留)… */ },
    "ja": { /* …(原内容保留)… */ },
    "th": { /* …(原内容保留)… */ },
    "ms": { /* …(原内容保留)… */ }
  };

  var BUTLER_LANG_NAME = {
    'zh-CN':'Simplified Chinese','zh-TW':'Traditional Chinese','en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  function getLang(){
    var saved = localStorage.getItem(LANG_KEY);
    if (saved && i18n[saved]) return saved;
    var raw = (navigator.language || 'zh-CN').replace('_','-');
    var map = {'zh':'zh-CN','zh-CN':'zh-CN','zh-SG':'zh-CN','zh-TW':'zh-TW','zh-HK':'zh-TW','en':'en','en-US':'en','en-GB':'en','ja':'ja','ja-JP':'ja','th':'th','ms':'ms'};
    return map[raw] || 'zh-CN';
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
  function t(key){
    var L = i18n[getLang()] || i18n['zh-CN'];
    return L[key] || (i18n['zh-CN'][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(function(el){
      var k = el.getAttribute('data-i18n'); var v = t(k);
      if (v!=null) el.textContent = v;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(function(el){
      var k = el.getAttribute('data-i18n-ph'); var v = t(k);
      if (v!=null) el.setAttribute('placeholder', v);
    });
    var titleEl = document.querySelector('title[data-i18n], title[data-i18n="page_title"]');
    if (titleEl) titleEl.textContent = t('page_title');
  }

  /* =========================
     Numerology Core
  ========================= */
  var masters = {11:true,22:true,33:true};
  function isMaster(n){ return !!masters[n]; }
  function reduceNum(n){
    while(n>9 && !isMaster(n)){
      var s = String(n).split(""), acc=0;
      for (var i=0;i<s.length;i++) acc += Number(s[i]);
      n = acc;
    }
    return n;
  }
  function parseDateDigits(iso){
    if(!iso) return null;
    var d = iso.replace(/[^0-9]/g,"");
    if(d.length<8) return null;
    var arr=[]; for (var i=0;i<d.length;i++) arr.push(Number(d[i]));
    return arr;
  }
  function calcLifePath(iso){
    var digits = parseDateDigits(iso);
    if(!digits) return null;
    var sum=0; for (var i=0;i<digits.length;i++) sum+=digits[i];
    return reduceNum(sum);
  }
  function calcLoveNumber(iso){
    if(!iso) return null;
    var p = iso.split("-");
    var dd = Number(p[2]||"0"); if(!dd) return null;
    return reduceNum(dd);
  }
  function calcPersonalYear(iso, year){
    // Personal Year = reduce( (month + day + currentYear) digits ), keep 11/22
    if(!iso) return null;
    var p = iso.split("-");
    var m = Number(p[1]||"0"), d = Number(p[2]||"0");
    if(!m || !d) return null;
    var total = 0;
    (String(m)+String(d)+String(year)).replace(/./g, function(ch){ total += Number(ch); });
    return reduceNum(total);
  }

  /* =========================
     Professional Dictionaries
  ========================= */
  // Compact but richer text blocks; localized for zh-CN and en (fallback)
  var PRO = {
    "en": {
      life: {
        1:"Archetype: Pioneer. Core lesson: self-definition without domination. Strengths: initiative, originality, decisiveness. Triggers: resistance to control, impatience. Growth: lead by invitation, not imposition.",
        2:"Archetype: Diplomat. Core lesson: boundaries with empathy. Strengths: listening, harmony-building. Triggers: conflict avoidance. Growth: speak needs plainly; collaboration with standards.",
        3:"Archetype: Creator. Core lesson: consistency behind expression. Strengths: storytelling, aesthetics, morale. Triggers: criticism, boredom. Growth: ship on a cadence; edit rigorously.",
        4:"Archetype: Builder. Core lesson: structure without rigidity. Strengths: systems, discipline, reliability. Triggers: chaos, broken promises. Growth: iterate, don’t ossify.",
        5:"Archetype: Explorer. Core lesson: freedom with responsibility. Strengths: adaptability, sales, learning. Triggers: confinement. Growth: commit via sprints; measure risk.",
        6:"Archetype: Steward. Core lesson: care without over-control. Strengths: service, guardianship, taste. Triggers: mess, unfairness. Growth: delegate; “good enough” thresholds.",
        7:"Archetype: Sage. Core lesson: share findings. Strengths: analysis, depth, pattern-sense. Triggers: superficiality. Growth: translate wisdom into practice.",
        8:"Archetype: Executive. Core lesson: power with benevolence. Strengths: integration, resource command. Triggers: power struggles. Growth: governance, transparency, double-win deals.",
        9:"Archetype: Healer. Core lesson: give with boundaries. Strengths: compassion, completion, art. Triggers: injustice. Growth: receive support, not just give.",
        11:"Archetype: Visionary. Core lesson: ground intuition. Strengths: inspiration, sensing zeitgeist. Growth: routines, body care, practical pilots.",
        22:"Archetype: Architect. Core lesson: steward scale. Strengths: vision→infrastructure. Growth: teams, charters, compounding systems.",
        33:"Archetype: Altruist. Core lesson: self-love precedes service. Strengths: heart-led healing. Growth: sustainable giving, boundaries."
      },
      love: {
        1:"Leads with initiative; practice tenderness and shared decisions.",
        2:"Seeks safety and closeness; name needs directly.",
        3:"Playful, words of affirmation; keep promises.",
        4:"Steady rituals and reliability; romance via constancy.",
        5:"Needs novelty and space; commit in chapters.",
        6:"Devoted and protective; avoid perfectionism.",
        7:"Quiet depth; respect solitude; cherish meaning.",
        8:"Goal-aligned partnership; negotiate power fairly.",
        9:"Big-hearted; don’t rescue at your expense.",
        11:"Highly sensitive; handle with grace and slowness.",
        22:"Long-horizon builder; practical affection.",
        33:"Healing through love; recharge before you give."
      },
      careerTips: {
        1:["Own a problem end-to-end each quarter.","Practice consensus: two options + ask for input.","Delegate earlier than feels comfy."],
        2:["Facilitate hard conversations with agendas.","Track favors/asks in a simple log.","Say no with alternatives."],
        3:["Commit to a weekly ship cadence.","Batch ideation vs. editing sessions.","Create a portfolio of proofs."],
        4:["Design once, scale many: SOPs & checklists.","Automate boring steps first.","Retrospect monthly: kill brittle rules."],
        5:["Sprint 2–4 weeks per theme.","Quantify risk ceilings before exploring.","Sell via demos, not decks."],
        6:["Define “done” to avoid overgiving.","Guard maker time; schedule care blocks.","Coach, don’t fix."],
        7:["Publish summaries, not just research.","Pair with an operator for go-live.","Turn insights into 30-day pilots."],
        8:["Write operating principles and stick to them.","Separate power and affection cleanly.","Structure win-win incentives."],
        9:["Scope your causes; one at a time.","Measure impact, not martyrdom.","Keep a “receive” list: help you accept."],
        11:["Translate visions into 7-day experiments.","Sleep, hydration, nature as non-negotiables.","Protect quiet creation windows."],
        22:["Roadmap: V1→V2→V3 maturity.","Hire for systems, not heroes.","Institutionalize lessons learned."],
        33:["Define limits of service explicitly.","Create caregiver backup plans.","Teach the method; don’t carry alone."]
      },
      moneyTips: {
        1:["Invest in tools that multiply time.","Avoid impulse “control” buys; choose leverage."],
        2:["Budget for generosity but cap it.","Price your coordination work."],
        3:["Separate creative R&D vs. revenue projects.","Automate savings on pay-in days."],
        4:["Use envelopes/“buckets” for stability.","Index-fund default; review quarterly."],
        5:["Build a freedom fund (6–12m).","Have “fun allocation” with a hard stop."],
        6:["Insure properly; no overcoverage.","Charge fairly for care/service"],
        7:["Pay for mentors/tools that compress learning.","Don’t over-optimize tiny fees."],
        8:["Track ROI by initiative.","Avoid power signaling purchases."],
        9:["Give within limits; receipt your giving.","Retirement contributions first."],
        11:["Finance routines: sleep, therapy, craft.","Beware magical spending."],
        22:["Capex with depreciation schedules.","Fund maintainers, not just launches."],
        33:["Budget recovery time as “cost”.","Gift from surplus, not depletion."]
      },
      planSeeds:{
        generic:["Clarify one 30-day focus theme.","Define success metrics and anti-goals.","Block two weekly deep-work slots.","One money habit to install.","One relationship boundary to practice."]
      }
    },
    "zh-CN": {
      life:{
        1:"原型：开拓者。课题：自我定义而不压制他人。优势：主动性、原创、决断。触发点：被控制、拖延。成长：以“邀请式领导”代替“命令式”。",
        2:"原型：协调者。课题：同理与边界并存。优势：倾听、润滑关系。触发点：冲突回避。成长：清晰表达需求，带标准地合作。",
        3:"原型：创造者。课题：表达之后要有“交付”。优势：叙事、审美、带动气氛。触发点：被批评、无聊。成长：固定节奏出品，严谨复盘。",
        4:"原型：建造者。课题：结构≠僵化。优势：系统、纪律、可靠。触发点：混乱、失约。成长：小步迭代，避免一刀切规则。",
        5:"原型：探索者。课题：自由与责任同在。优势：适应、销售、学习。触发点：被束缚。成长：以冲刺承诺，量化风险。",
        6:"原型：守护者。课题：关怀不等于控制。优势：服务、审美、照料。触发点：凌乱、不公。成长：划定“够好”阈值，学会授权。",
        7:"原型：智者。课题：把发现说出来。优势：分析、洞见、模式识别。触发点：表面化。成长：把结论转译为实践动作。",
        8:"原型：执行官。课题：权力与仁慈平衡。优势：整合、资源调度。触发点：权力博弈。成长：治理、透明、双赢合约。",
        9:"原型：疗愈者。课题：有边界的给予。优势：同理、完成度、艺术性。触发点：不公。成长：允许被支持，而非只付出。",
        11:"原型：愿景者。课题：直觉需落地。优势：启发、捕捉风向。成长：规律作息、身体照护、小范围试点。",
        22:"原型：架构师。课题：把规模管好。优势：愿景→基础设施。成长：团队、章程、可复利系统。",
        33:"原型：大爱者。课题：先自爱，再服务。优势：以爱疗愈。成长：可持续给予，先补能量。"
      },
      love:{
        1:"主动而果断；练习柔软与共识决策。",2:"重视安全亲密；直接表达需求。",3:"爱表达与仪式感；说到做到。",
        4:"稳定与可靠；以恒常制造浪漫。",5:"需要新鲜与空间；分阶段承诺。",6:"忠诚与保护；避免完美主义。",
        7:"安静而深刻；尊重独处，珍惜意义。",8:"目标同频；公平协商权责。",9:"心大易拯救；别以自我牺牲换爱。",
        11:"高度敏感；用优雅与慢节奏相处。",22:"长线建构型；务实表达关心。",33:"以爱疗愈；先充电再给予。"
      },
      careerTips:{ /* 与英文结构一致，保留关键点的中文表达 */ },
      moneyTips:{ /* 与英文结构一致，保留关键点的中文表达 */ },
      planSeeds:{ generic:["明确一个30天主题。","写清成功指标与反目标。","每周预留两段深度工作。","安装一个金钱习惯。","练习一条关系边界。"] }
    }
  };

  function txt(lang, path, key){
    var L = PRO[lang] || PRO['en'];
    var bucket = L[path] || {};
    return bucket[key] || (PRO['en'][path] ? (PRO['en'][path][key] || '') : '');
  }

  /* =========================
     AI Butler helpers
  ========================= */
  function mdToHtml(md){
    return (md||'')
      .replace(/^###?\s+(.*)$/gm,'<h3 style="margin:12px 0 6px;color:#f2d27a">$1</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'• $1')
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  function isVIP(){
    return localStorage.getItem('vipStatus')==='active' || !!localStorage.getItem('vipEmail');
  }
  function ensureAiCard(){
    ensureRootStructure();
    if (gid('aiCard')) return;
    var wrap = gid('numReport'); if(!wrap) return;
    var sec = document.createElement('div');
    sec.className = 'sec';
    sec.id = 'aiCard';
    sec.innerHTML =
      '<h3 id="butlerTitle" data-i18n="butler_title">' + t('butler_title') + '</h3>' +
      '<div id="aiContent" class="ai-content">' +
      '  <div class="skeleton">' +
      '    <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>' +
      '    <div style="width:70%"></div><div style="width:50%"></div>' +
      '  </div>' +
      '</div>' +
      '<div class="chips" id="aiChips"></div>';
    wrap.appendChild(sec);
    renderChips();
  }
  function renderChips(){
    var wrap = gid('aiChips'); if(!wrap) return;
    wrap.innerHTML = '';
    [{k:'chip_career', q:'q_career'},
     {k:'chip_love',   q:'q_love'},
     {k:'chip_money',  q:'q_money'},
     {k:'chip_list',   q:'q_list'},
     {k:'chip_30d',    q:'q_30d'}].forEach(function(it){
       var b = document.createElement('button');
       b.className='chip';
       b.textContent = t(it.k);
       b.setAttribute('data-q', t(it.q));
       b.dataset.topicKey = it.q;
       wrap.appendChild(b);
     });
  }

  function buildButlerSystemPrompt(lang, topic){
    if (!topic) topic = '';
    var ln = BUTLER_LANG_NAME[lang] || BUTLER_LANG_NAME['zh-CN'];
    var HEADER_MAP = {
      'zh-CN':['人物画像','关系与沟通','事业与自我实现','金钱与物质','今日/本周可执行清单','温柔提醒'],
      'zh-TW':['人物画像','關係與溝通','事業與自我實現','金錢與物質','今日/本週可執行清單','溫柔提醒'],
      'en'   :['Persona','Relationships & Communication','Career & Self-Actualization','Money & Material','Actionable To-Dos (Today/This Week)','Gentle Reminder'],
      'ja'   :['人物像','関係とコミュニケーション','キャリアと自己実現','お金と物質','今日/今週の実行リスト','やさしいリマインド'],
      'th'   :['ภาพบุคคล','ความสัมพันธ์ & การสื่อสาร','การงาน & การเติมเต็มตนเอง','การเงิน & วัตถุ','รายการปฏิบัติ (วันนี้/สัปดาห์นี้)','คำเตือนอ่อนโยน'],
      'ms'   :['Persona','Hubungan & Komunikasi','Kerjaya & Aktualisasi Diri','Wang & Material','Senarai Tindakan (Hari/Minggu Ini)','Peringatan Lembut']
    };
    var h = HEADER_MAP[lang] || HEADER_MAP['zh-CN'];
    var lines = [
      'You are "Xinlian Butler". OUTPUT LANGUAGE: ' + ln + '. Reply strictly in ' + ln + ' only.',
      'Warm, practical, actionable. No medical/legal conclusions.',
      'Markdown structure:',
      '## ' + h[0],
      '## ' + h[1] + ' (2–4 bullets)',
      '## ' + h[2] + ' (2–4 bullets)',
      '## ' + h[3] + ' (2–3 bullets)',
      '## ' + h[4] + ' (3–5 bullets; start with verbs; quantify if possible)',
      '## ' + h[5]
    ];
    if (topic) lines.push('Primary focus topic: ' + topic);
    return lines.join('\n');
  }

  async function runAI(obj, topic){
    if (!topic) topic = '';
    ensureAiCard();

    var lang = getLang();
    var title = gid('butlerTitle'); if (title) title.textContent = t('butler_title');

    var sys = buildButlerSystemPrompt(lang, topic);
    var lp = obj.lp, lv = obj.lv, iso = obj.iso;
    var L = getLang();
    var lineLP = 'Life Path: ' + (lp!=null?lp:'-') + ' — ' + (txt(L,'life', lp) || '');
    var lineLV = 'Love Number: ' + (lv!=null?lv:'-') + ' — ' + (txt(L,'love', lv) || '');
    var usr = [
      'Birth date: ' + iso,
      lineLP,
      lineLV,
      (topic ? ('Task/Focus: ' + topic) : ('Task/Focus: ' + t('chip_career'))),
      'Expectation: human, concrete and immediately actionable advice.'
    ].join('\n');

    var elC = gid('aiContent');
    if (elC){
      elC.innerHTML =
        '<div class="skeleton">' +
        '  <div style="width:60%"></div><div style="width:80%"></div><div style="width:90%"></div>' +
        '  <div style="width:70%"></div><div style="width:50%"></div>' +
        '</div>';
    }

    try{
      var r = await fetch(API_BASE + '/api/chat',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({messages:[
          {role:'system',content:sys},
          {role:'user',content:usr}
        ]})
      });
      var data = await r.json().catch(function(){ return {}; });
      var raw  = (data && (data.reply || data.text || (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content))) || '';
      var html = mdToHtml(raw);

      if(!isVIP()){
        var parts = (raw||'').split(/\n##\s+/);
        var header = parts.shift() || '';
        var kept = [header];
        for (var i=0;i<Math.min(2, parts.length); i++){ kept.push('## ' + parts[i]); }
        html = mdToHtml(kept.join('\n\n')) +
          '<div class="ai-lock-overlay">' +
          '  <div class="tip">' + t('vip_tip') + '</div>' +
          '  <div class="sub" style="margin-top:4px">' + t('vip_sub') + '</div>' +
          '  <a class="btn" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener" style="margin-top:10px">' + t('btn_unlock') + '</a>' +
          '</div>';
      }

      if(elC) elC.innerHTML = html;
      renderChips();
    }catch(e){
      if(elC) elC.innerHTML = '<div style="color:#98a7b7">' + t('err_network') + ': ' + e.message + '</div>';
    }
  }

  /* =========================
     PRO Report Renderer
  ========================= */
  function bulletList(arr){
    if (!arr || !arr.length) return '';
    return '<ul>' + arr.map(function(s){ return '<li>' + s + '</li>'; }).join('') + '</ul>';
  }

  function renderProReport(obj){
    ensureRootStructure();
    var iso = obj.iso, lp = obj.lp, lv = obj.lv;
    var wrap = gid('numReport');
    var L = getLang();
    var lpTxt = txt(L,'life', lp) || '';
    var lvTxt = txt(L,'love', lv) || '';

    // Career & Money tips sourced from dictionaries
    var career = (PRO[L] && PRO[L].careerTips && PRO[L].careerTips[lp]) ? PRO[L].careerTips[lp] :
                 (PRO['en'].careerTips[lp] || []);
    var money  = (PRO[L] && PRO[L].moneyTips && PRO[L].moneyTips[lp]) ? PRO[L].moneyTips[lp] :
                 (PRO['en'].moneyTips[lp] || []);

    // Relationship guidance mixes Love Number + Life Path nuance
    var relPoints = [];
    if (lvTxt) relPoints.push(lvTxt);
    if (lp===2 || lp===6 || lp===9) relPoints.push(L==='zh-CN' ? "练习“有边界的温柔”，把自己的需求说清楚。" : "Practice ‘bounded kindness’: state your needs clearly.");
    if (lp===1 || lp===8) relPoints.push(L==='zh-CN' ? "用“共同决策”代替“单向决策”，增强亲密的安全感。" : "Use shared decisions to increase safety and closeness.");
    if (lp===5 || lp===7) relPoints.push(L==='zh-CN' ? "约定“空间与联结”的节奏：给自由也给联系。" : "Create a rhythm of space and connection.");
    if (lp===11 || lp===22 || lp===33) relPoints.push(L==='zh-CN' ? "能量敏感时减速：少争辩，多复盘与共识。" : "When energy is sensitive, slow down: less debate, more reflection and consensus.");

    // Personal Year (use visitor local year)
    var now = new Date();
    var py = calcPersonalYear(iso, now.getFullYear());
    var pyLine = '';
    if (py!=null){
      var map = {
        1: L==='zh-CN' ? "开启之年：立新主题，轻装上路，播种而不求全。" : "Year 1: Beginnings — define themes, travel light, plant seeds.",
        2: L==='zh-CN' ? "协作之年：慢就是快，巩固人脉与情感支持。" : "Year 2: Cooperation — slow is smooth; build alliances.",
        3: L==='zh-CN' ? "表达之年：内容/社交曝光，保持稳定产出。" : "Year 3: Expression — create and publish steadily.",
        4: L==='zh-CN' ? "打底之年：搭结构、补短板、练基本功。" : "Year 4: Foundations — build structure and fundamentals.",
        5: L==='zh-CN' ? "变动之年：探索与转场，控制风险窗口。" : "Year 5: Change — explore shifts with risk windows.",
        6: L==='zh-CN' ? "承诺之年：家庭/团队责任与品质升级。" : "Year 6: Commitments — upgrade quality, care.",
        7: L==='zh-CN' ? "内省之年：研究、疗愈、回到本心。" : "Year 7: Inner work — study, healing, essence.",
        8: L==='zh-CN' ? "实现之年：资源整合、结果导向、治理升级。" : "Year 8: Realization — integrate resources, govern.",
        9: L==='zh-CN' ? "收束之年：清理旧章节，为新周期腾挪空间。" : "Year 9: Completion — clear chapters for the next cycle.",
        11: L==='zh-CN' ? "灵感之年：愿景落地，保持身心节律。" : "Year 11: Inspiration — land visions with routines.",
        22: L==='zh-CN' ? "架构之年：把“规模化”写进流程与制度。" : "Year 22: Architecture — scale into processes.",
        33: L==='zh-CN' ? "大爱之年：以自我照料换取可持续服务。" : "Year 33: Compassion — self-care to sustain service."
      };
      pyLine = (map[py] || '');
    }

    // Actionable 30-day plan seeds
    var seeds = (PRO[L] && PRO[L].planSeeds && PRO[L].planSeeds.generic) ? PRO[L].planSeeds.generic : PRO['en'].planSeeds.generic;

    // Keep Butler focus state
    var oldAi = gid('aiCard');
    var savedKey = (oldAi && oldAi.dataset) ? (oldAi.dataset.topicKey || '') : '';
    var savedTopic = (oldAi && oldAi.dataset) ? (oldAi.dataset.topic || '') : '';

    wrap.innerHTML =
      '<div class="sec">' +
      '  <h3>' + t('sec_overview') + '</h3>' +
      '  <p>' + iso + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_life') + '</h3>' +
      '  <p><b>' + t('sec_life') + '</b>：<span id="lifePath">' + (lp!=null?lp:'—') + '</span></p>' +
      '  <p class="muted" id="lifePathDesc">' + lpTxt + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_love') + '</h3>' +
      '  <p><b>' + t('sec_love') + '</b>：<span id="loveNumber">' + (lv!=null?lv:'—') + '</span></p>' +
      '  <p class="muted" id="loveDesc">' + (txt(L,'love', lv) || '') + '</p>' +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_career') + '</h3>' +
      '  ' + bulletList(career) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_money') + '</h3>' +
      '  ' + bulletList(money) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_rel') + '</h3>' +
      '  ' + bulletList(relPoints) +
      '</div>' +

      (py!=null ? ('<div class="sec"><h3>' + t('sec_year') + '</h3><p><b>PY</b>：' + py + '</p><p class="muted">' + pyLine + '</p></div>') : '') +

      '<div class="sec">' +
      '  <h3>' + t('sec_plan30') + '</h3>' +
      '  ' + bulletList(seeds) +
      '</div>' +

      '<div class="sec">' +
      '  <h3>' + t('sec_gentle') + '</h3>' +
      '  <p class="muted">' + ( (L==='zh-CN') ?
            '把“节奏感”当成本月主题：稳定产出、小步快跑、及时复盘。' :
            'Make “rhythm” your theme: steady output, short sprints, timely retros.' ) + '</p>' +
      '</div>';

    ensureAiCard();
    renderChips();

    var newAi = gid('aiCard');
    if (newAi && savedKey) {
      newAi.dataset.topicKey = savedKey;
      newAi.dataset.topic    = savedTopic || t(savedKey);
    }
  }

  /* =========================
     Chat Widget (unchanged)
  ========================= */
  function applyChatI18n(){
    var fab = gid('ssChatFab'),
        inp = gid('ssChatInput'),
        btn = gid('ssChatSend'),
        title = document.querySelector('.ss-chat-title');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
    if (title) title.textContent = t('butler_chat_title');
  }
  function mountChat(){
    if (gid('ssChatFab')) return;
    var fab = document.createElement('div');
    fab.className = 'ss-chat-fab';
    fab.id = 'ssChatFab';
    fab.title = t('butler_chat_title');

    var panel = document.createElement('div');
    panel.className = 'ss-chat-panel';
    panel.id = 'ssChatPanel';
    panel.setAttribute('role','dialog');
    panel.setAttribute('aria-label', t('butler_chat_title'));
    panel.innerHTML =
      '<div class="ss-chat-head"><div class="ss-chat-title">' + t('butler_chat_title') + '</div><div class="ss-close" id="ssChatClose">✕</div></div>' +
      '<div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>' +
      '<div class="ss-chat-input">' +
      '  <input id="ssChatInput" type="text" placeholder="' + t('chat_placeholder') + '"/>' +
      '  <button id="ssChatSend" class="btn">' + t('chat_send') + '</button>' +
      '</div>';
    document.body.appendChild(fab);
    document.body.appendChild(panel);
    applyChatI18n();

    var $body  = gid('ssChatBody'),
        $input = gid('ssChatInput'),
        $send  = gid('ssChatSend'),
        $close = gid('ssChatClose');

    var open = function(){ panel.style.display='block'; if ($input) $input.focus(); };
    var close = function(){ panel.style.display='none'; };
    fab.addEventListener('click', open);
    if ($close) $close.addEventListener('click', close);

    function addMsg(text, me){
      var div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      if ($input){ $input.value=''; $input.focus(); }
      var sys = [
        'You are "Xinlian Butler". OUTPUT LANGUAGE: ' + (BUTLER_LANG_NAME[getLang()] || 'Simplified Chinese') + '.',
        'Help visitors understand features, navigation and VIP. Tone: warm, concise, professional.'
      ].join('\n');
      try{
        var r = await fetch(API_BASE + '/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({messages:[{role:'system',content:sys},{role:'user',content:prompt}]})
        });
        var data = await r.json().catch(function(){ return {}; });
        var reply = (data && (data.reply || data.text || (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content))) || '';
        addMsg(reply || t('err_busy'));
      }catch(e){
        addMsg(t('err_network') + '，' + t('err_busy'));
      }
    }

    if ($send) $send.addEventListener('click', function(){
      var v = $input ? ($input.value ? $input.value.trim() : '') : '';
      if (v) askChat(v);
    });
    if ($input) $input.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        var v = $input.value ? $input.value.trim() : '';
        if (v) askChat(v);
      }
    });
  }

  /* =========================
     Init & Events
  ========================= */
  document.addEventListener('DOMContentLoaded', function(){
    ensureRootStructure();

    // prefill birthdate to today
    var bd = gid('birthdate');
    if (bd && !bd.value) {
      var now = new Date();
      var y = now.getFullYear();
      var m = String(now.getMonth() + 1).padStart(2, '0');
      var d = String(now.getDate()).padStart(2, '0');
      bd.value = y + '-' + m + '-' + d;
    }

    var sel = gid('langSelect');
    var current = getLang();
    if (sel) sel.value = current;
    document.documentElement.lang = current;

    applyI18n();
    mountChat();
    applyChatI18n();

    // Generate button
    var _btnGen = gid('btnGen');
    if (_btnGen) _btnGen.addEventListener('click', function(){
      var iso = bd ? bd.value : '';
      if(!iso){ var e = t('err_need_birthdate'); var el=gid('error'); if(el){ el.textContent=e; el.style.display='block'; setTimeout(function(){el.style.display='none';},4000); } return; }
      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);
      gid('result').style.display = 'block';
      renderProReport({ iso: iso, lp: lp, lv: lv });
      runAI({ iso: iso, lp: lp, lv: lv });
      window.scrollTo({ top: gid('result').offsetTop - 10, behavior: 'smooth' });
    });

    // Language switch (keep last Butler topic if any)
    if (sel) sel.addEventListener('change', function(){
      setLang(sel.value);
      applyI18n();
      applyChatI18n();
      if (gid('aiChips')) renderChips();

      var iso = bd ? bd.value : '';
      if (!iso) return;

      var oldAi = gid('aiCard');
      var oldKey = (oldAi && oldAi.dataset && oldAi.dataset.topicKey) ? oldAi.dataset.topicKey : '';

      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);

      var res = gid('result');
      if (res && res.style.display !== 'none') {
        renderProReport({ iso: iso, lp: lp, lv: lv });
      }

      var topic = oldKey ? t(oldKey) : '';
      var newAi = gid('aiCard');
      if (newAi && oldKey) {
        newAi.dataset.topicKey = oldKey;
        newAi.dataset.topic = topic;
      }

      if (topic) {
        runAI({ iso: iso, lp: lp, lv: lv }, topic);
      } else if (newAi) {
        runAI({ iso: iso, lp: lp, lv: lv });
      }
    });

    // Chip click => AI
    document.addEventListener('click', function(e){
      var target = e.target || e.srcElement;
      var btn = target && target.closest ? target.closest('.chip') : null;
      if (!btn) return;

      var key   = (btn.dataset && btn.dataset.topicKey) ? btn.dataset.topicKey : '';
      var topic = key ? t(key) : (btn.getAttribute('data-q') || btn.textContent || '');

      var aiCard = gid('aiCard');
      if (aiCard && aiCard.dataset) {
        aiCard.dataset.topic    = topic;
        aiCard.dataset.topicKey = key;
        aiCard.dataset.lang     = getLang();
      }

      var bd = gid('birthdate');
      var iso = bd ? bd.value : '';
      if (!iso) return;

      var lp = calcLifePath(iso);
      var lv = calcLoveNumber(iso);

      runAI({ iso: iso, lp: lp, lv: lv }, topic);
    });
  });
})();
</script>
</body>
</html>


