<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  /* â€”â€” å¤´éƒ¨ï¼ˆTarot åŒæ¬¾ï¼‰ â€”â€” */
  .site-header{
    position:sticky;
    top:0;
    z-index:10;
    background:#0b0f14cc;
    border-bottom:1px solid #0f1622;
    backdrop-filter:saturate(140%) blur(12px);
    transition: all 0.3s ease;
  }
  .site-header.scrolled {
    background: rgba(11, 15, 20, 0.95);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  .head-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    padding:14px 16px;
  }
  
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; 
  place-items:center; 
  width:34px; 
  height:34px; 
  border-radius:8px; 
  background:linear-gradient(180deg,#0e1520,#0b1018); 
  border:1px solid #2a3546; 
  box-shadow:0 4px 14px rgba(0,0,0,.35); 
  font-weight:800; 
  color:#ffe084;
  transition: all 0.3s ease;
}
.brand:hover .brand-badge {
  transform: rotate(15deg);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}
.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

/* æ–°å¢ï¼šé¼ æ ‡åœ¨æ•´æ¡ brand ä¸Šæ—¶ï¼Œé«˜äº®æ ‡é¢˜ */
.brand:hover .title {
  color: var(--gold);
}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== Buttons ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== å…«å­—ä¸“ç”¨æ ·å¼ ===== */
  .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
  .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
  .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
  .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
  
  .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
  .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
  .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
  
  .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
  .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
  .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
  .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
  
  /* æ—¶é—´è¾“å…¥è¡Œ */
  .time-row{display:flex;align-items:center;gap:10px}
  .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
  .btn-mini{padding:8px 10px;border-radius:10px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:pre-wrap;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold)}

  /* ===== List blocks ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Misc ===== */
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
  
  .error{color:#ff6b6b;margin-top:8px;display:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  .block{width:100%}

  /* ===== VIP åŒºåŸŸï¼ˆç»Ÿä¸€æ ·å¼ Â· ä¸ energy.html ä¸€è‡´ï¼‰ ===== */
.card.section{
  max-width:1100px;
  margin:32px auto 40px;
  padding:18px 18px 22px;
  border-radius:var(--radius);
  border:1px solid #1f2a36;
  background:#11161dcc;
  box-shadow:var(--shadow);
  box-sizing:border-box;
}

.group-title{
  font-weight:800;
  color:#ffe084;
  font-size:1rem;
  margin:0 0 10px;
}

/* ä¸ŠåŠéƒ¨ï¼šå·¦å³ä¸¤å— VIP åˆ—è¡¨ */
.card.section .columns{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:16px;
  margin-top:10px;
}
.card.section .list-block{
  border-radius:12px;
  border:1px solid #1f2a36;
  background:#0f141d;
  padding:14px 16px;
}
.card.section .list-block ul{
  list-style:none;
  margin:6px 0 0;
  padding:0;
}
.card.section .list-block li{
  margin:.25rem 0;
  font-size:.95rem;
  color:var(--muted);
  line-height:1.6;
}

/* ä¸‹åŠéƒ¨ï¼šç™»å½•åŒºåŸŸ */
.astro-auth{
  margin-top:16px;
}
.astro-auth .auth-grid{
  display:grid;
  grid-template-columns:1.1fr 0.9fr;
  gap:16px;
}
.astro-auth .panel{
  background:#11161dcc;
  border-radius:14px;
  border:1px solid #1f2a36;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  padding:16px 18px 18px;
  box-sizing:border-box;
}
.astro-auth .panel .head{
  font-size:.95rem;
  font-weight:800;
  color:#ffe084;
  padding-bottom:8px;
  margin-bottom:10px;
  border-bottom:1px solid #1f2a36;
}
.astro-auth .panel .body{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .row{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .spacer{
  height:4px;
}

/* è¾“å…¥æ¡† = è·Ÿ energy.html ä¸€æ ·å®½åº¦ */
.astro-auth input[type="email"],
.astro-auth input[type="password"]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #243244;
  background:#0e1520;
  color:#e8edf3;
  font-size:15px;
  box-sizing:border-box;
}
.astro-auth input[type="email"]::placeholder,
.astro-auth input[type="password"]::placeholder{
  color:#6f8092;
}
.astro-auth input[type="email"]:focus,
.astro-auth input[type="password"]:focus{
  outline:none;
  border-color:#d4af37;
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}

/* ç™»å½• / é‡è®¾ / æ³¨å†ŒæŒ‰é’® = å’Œè¾“å…¥æ¡†åŒå®½ï¼Œpill å½¢çŠ¶ */
.astro-auth .btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  max-width:100%;
  padding:11px 18px;
  border-radius:999px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  font-weight:800;
  text-align:center;
  box-shadow:0 6px 20px rgba(230,199,110,.35);
  white-space:nowrap;
  box-sizing:border-box;
  transition:.12s ease;
}
.astro-auth .btn.block{
  width:100%;
}

/* æ·±è‰²çš„ reset æŒ‰é’®æ ·å¼ */
.astro-auth .btn.ghost.block{
  background:#101826;
  border-color:#273245;
  color:#e8edf3;
  box-shadow:none;
}
.astro-auth .btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(230,199,110,.45);
}
.astro-auth .btn.ghost.block:hover{
  border-color:#d4af37;
  background:rgba(212,175,55,.08);
}

.error-message{
  color:#ff7b7b;
  font-size:.85rem;
}

/* å°å±ï¼šVIP åŒºã€ç™»å½•åŒºéƒ½ä¸€åˆ—æ’å¸ƒ */
@media (max-width:768px){
  .card.section .columns{
    grid-template-columns:1fr;
  }
  .astro-auth .auth-grid{
    grid-template-columns:1fr;
  }
}

  /* AI box (ç®¡å®¶æç¤ºå—) */
  .ai-box{
    background:#0b111a;
    border:1px solid #1f2a36;
    border-radius:12px;
    padding:14px 16px;
    margin:14px 0;
  }
  .ai-box-h{
    color:#ffd88a;
    font-weight:700;
    margin-bottom:8px;
  }
  .ai-box-c{
    color:#e8edf3;
    line-height:1.7;
  }

  /* Prompt chips */
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:12px;
  }
  .chip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #2a3546;
    background:#0e1520;
    color:#e8edf3;
    cursor:pointer;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  .chip:hover{
    border-color:#f2d27a;
    box-shadow:0 0 0 2px rgba(242,210,122,.15) inset;
  }
  .chip:disabled{
    opacity:.6;
    cursor:not-allowed;
  }
  .skeleton{
    display:grid;
    gap:8px;
  }
  .skeleton div{
    height:12px;
    border-radius:6px;
    background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);
    animation:sh 1.2s infinite;
  }
  @keyframes sh{
    0%{opacity:.5}
    50%{opacity:1}
    100%{opacity:.5}
  }
  .ai-lock-overlay{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #1f2a36;
    text-align:center;
  }
  .ai-lock-overlay .tip{
    color:#ffd88a;
    font-weight:700;
    margin-bottom:4px;
  }
  .ai-lock-overlay .sub{
    color:var(--muted);
  }

  /* è¯¦æƒ…é¡µï¼ˆå¦‚æœä½ çš„ VIP æŠŠæŠ¥å‘Šå±•å¼€ç”¨è¿™ä¸ªï¼‰ */
  .detail-view{display:none}
  .detail-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:20px;
  }
  .back-btn{
    background:rgba(212,175,55,.1);
    border:1px solid rgba(212,175,55,.3);
    color:var(--gold2);
    padding:8px 16px;
    border-radius:8px;
    cursor:pointer;
  }
  .detail-content{line-height:1.8}
  .detail-section{margin-bottom:24px}
  .detail-section h4{
    color:var(--gold2);
    margin-bottom:12px;
    font-size:1.1rem;
  }
  .action-list{
    list-style:none;
    padding:0;
    margin:0;
  }
  .action-list li{
    margin-bottom:8px;
    padding-left:20px;
    position:relative;
  }
  .action-list li::before{
    content:"â€¢";
    color:var(--gold2);
    position:absolute;
    left:0;
    top:0;
  }

  /* é€šç”¨å°å·¥å…· */
  .sr-only{
    position:absolute !important;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  .chips-container{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:20px 0;
    justify-content:center;
  }

  /* ===== Xinlian Butler Floating Chat (é—®) ===== */

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}

  /* ä¸“ä¸šç‰ˆç®¡å®¶å— */
  .butler-professional{
    display:none;
    margin-top:20px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:20px;
  }
  .butler-header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:20px;
    color:var(--gold2);
    font-size:1.2rem;
    font-weight:700;
  }
  .butler-content{
    line-height:1.8;
    padding:15px;
    background:var(--surface);
    border-radius:10px;
    border:1px solid #253245;
  }
  .butler-section{
    margin-bottom:25px;
    padding-bottom:15px;
    border-bottom:1px solid #253245;
  }
  .butler-section h4{
    color:var(--gold2);
    margin-bottom:10px;
    font-size:1.1rem;
  }
  .butler-chat{
    margin-top:20px;
    border-top:1px solid var(--line);
    padding-top:15px;
  }
  .chat-messages{
    height:200px;
    overflow-y:auto;
    margin-bottom:15px;
    padding:10px;
    background:var(--surface);
    border-radius:8px;
    border:1px solid #253245;
  }
  .chat-input-area{
    display:flex;
    gap:10px;
  }
  .chat-input-area input{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #253245;
    background:#0e1520;
    color:#e8edf3;
  }
  .chat-send-btn{
    padding:10px 20px;
    background:var(--gold);
    color:#191919;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
  }
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</option>
          <option value="compatibility" data-i18n="type_compat">åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <div class="time-row">
          <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
          <div class="time-unknown">
            <input type="checkbox" id="timeUnknown">
            <label for="timeUnknown">ä¸è¯¦</label>
          </div>
        </div>
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ -->
      <form id="reportForm" action="report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <div class="time-row">
            <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
            <div class="time-unknown">
              <input type="checkbox" id="timeUnknown2">
              <label for="timeUnknown2">ä¸è¯¦</label>
            </div>
          </div>
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="å‘½åæ”¹è¿" data-i18n="opt_rename">å‘½åæ”¹è¿</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
        </select>
      </div>
      <button class="btn" id="btnNext" type="button" data-i18n="btn_next">ç”Ÿæˆåˆ†æ</button>
    </section>

    <!-- å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®® - æ”¾åœ¨å‰é¢ -->
    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®</h2>
      <div id="butler-host"></div>
      <div id="rich-report"></div>
      <div id="xl-free-report"></div>
    </section>

    <!-- å¿ƒæ€œç©ºé—´åŠŸèƒ½å…¥å£ - æ”¾åœ¨å°¾ç«¯ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>

    <!-- ä¼šå‘˜åŒºåŸŸ -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
      <div class="body">
        <!-- NEW: reveal button -->
        <div class="row one">
      </div>

        <div class="spacer"></div>

        <div class="row" id="authFields">
          <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username"
                 placeholder="é‚®ç®± Email" data-i18n-ph="ph_email"/>
      
          <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
          <input id="password" type="password" autocomplete="current-password"
                 placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required/>
        </div>

        <div class="spacer"></div>

        <form id="loginForm" class="row one">
          <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
        </form>

        <div class="spacer"></div>

        <div class="row one">
          <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
        </div>

        <div class="spacer"></div>

        <form class="row one" id="registerForm">
          <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
          <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
          <div class="spacer"></div>
          <div class="error-message" id="authError" style="display:none"></div>
        </form>
      </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
</body>
          
<!-- GPT / å¿ƒæ€œç®¡å®¶ï¼ˆç»Ÿä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat_fab">é—®</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ€œç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å†…å®¹åŒºï¼šä¿æŒä¸ºç©ºï¼Œæ¶ˆæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¾“å…¥é—®é¢˜â€¦"
      data-i18n-ph="chat_input_ph"
    />
    <button class="btn" id="chatSend" data-i18n="chat_send">å‘é€</button>
  </div>
</div>
<script>
'use strict';

/* ==============================
   CONFIG
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const CHAT_ENDPOINT = "/api/chat";
const DEFAULT_LANG = "zh-CN";
const LANG_KEY = "5x_lang";
const $ = (id) => document.getElementById(id);  

/* ==============================
   i18n (use your existing translations object)
   Keep your translations object as-is.
============================== */
const translations = window.translations || {
  "zh-CN": {
    page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    lang_label:"è¯­è¨€",
    form_title:"å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š",
    choose_type:"é€‰æ‹©å‘½ç›˜ç±»å‹",
    type_personal:"ä¸ªäººå‘½ç›˜",
    type_compat:"åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰",
    culture_auto:"è‡ªåŠ¨è¯†åˆ« Auto Detect",
    culture_cn:"ä¸œæ–¹ Chinese / Bazi",
    culture_west:"è¥¿æ–¹ Astrology / Tarot",
    culture_jp:"æ—¥å¼ä¹æ˜Ÿ Japanese",
    culture_vedic:"å°åº¦å é™€ Vedic",
    self_info:"æœ¬äººèµ„æ–™",
    ph_name1:"å§“åï¼ˆæœ¬äººï¼‰",
    ph_time1:"å‡ºç”Ÿæ—¶é—´",
    cal_g:"é˜³å† (Gregorian)",
    cal_l:"å†œå† (Lunar)",
    ph_country1:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    btn_next:"ç”Ÿæˆåˆ†æ",
    partner_info:"ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰",
    ph_name2:"å§“åï¼ˆç¬¬äºŒäººï¼‰",
    ph_time2:"å‡ºç”Ÿæ—¶é—´",
    ph_country2:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    focus_title:"å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰",
    portal_title:"å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£",
    vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
    login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
    panel_login_head:"è´¦æˆ·ç™»å½• / æ³¨å†Œ",
    ph_email:"é‚®ç®± Email",
    ph_label_password:"å¯†ç  Password",
    ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    btn_login:"ç™»å…¥è´¦æˆ·",
    btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
    btn_register:"æ³¨å†Œè´¦æˆ·",
    note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
    panel_member_head:"ä¼šå‘˜æœåŠ¡",
    btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
    btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
    note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
    res_title:"å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®",
    chat_fab:"ğŸ’¬",
    chat_title:"å¿ƒæ€œç®¡å®¶ Â· GPT",
    chat_input_ph:"è¾“å…¥é—®é¢˜â€¦",
    chat_send:"å‘é€",
    btn_show_login_fields:"æ˜¾ç¤ºç™»å½•æ ",
    btn_hide_login_fields:"éšè—ç™»å½•æ ",
    time_unknown:"ä¸è¯¦"
  },"zh-TW": {
  page_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· VIP Soul Sanctuary",
  site_title:"å‘½ç†å¿ƒæ†ç©ºé–“ Â· VIP Soul Sanctuary",
  lang_label:"èªè¨€",
  form_title:"å‘½ç†åˆ†æ Â· ç”Ÿæˆå ±å‘Š",
  choose_type:"é¸æ“‡å‘½ç›¤é¡å‹",
  type_personal:"å€‹äººå‘½ç›¤",
  type_compat:"åˆç›¤ï¼ˆå…©äººè³‡æ–™ï¼‰",
  culture_auto:"è‡ªå‹•è¾¨è­˜ Auto Detect",
  culture_cn:"æ±æ–¹ Chinese / Bazi",
  culture_west:"è¥¿æ–¹ Astrology / Tarot",
  culture_jp:"æ—¥å¼ä¹æ˜Ÿ Japanese",
  culture_vedic:"å°åº¦å é™€ Vedic",
  self_info:"æœ¬äººè³‡æ–™",
  ph_name1:"å§“åï¼ˆæœ¬äººï¼‰",
  ph_time1:"å‡ºç”Ÿæ™‚é–“",
  cal_g:"é™½æ›† (Gregorian)",
  cal_l:"è¾²æ›† (Lunar)",
  ph_country1:"å‡ºç”Ÿåœ‹å®¶ / åœ°å€",
  btn_next:"ç”Ÿæˆåˆ†æ",
  partner_info:"ç¬¬äºŒäººè³‡æ–™ï¼ˆåˆç›¤ï¼‰",
  ph_name2:"å§“åï¼ˆç¬¬äºŒäººï¼‰",
  ph_time2:"å‡ºç”Ÿæ™‚é–“",
  ph_country2:"å‡ºç”Ÿåœ‹å®¶ / åœ°å€",
  focus_title:"å‘½ç†é¸é¡Œï¼ˆå ±å‘Šèšç„¦ï¼‰",
  portal_title:"å¿ƒæ†ç©ºé–“ Â· åŠŸèƒ½å…¥å£",
  vip_title:"ğŸŒ™ æœƒå“¡å€åŸŸ VIP Segment",
  login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
  panel_login_head:"å¸³æˆ¶ç™»å…¥ / è¨»å†Š",
  ph_email:"ä¿¡ç®± Email",
  ph_label_password:"å¯†ç¢¼ Password",
  ph_password:"å¯†ç¢¼ Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å¯«æ•¸å­—ç¬¦è™Ÿï¼‰",
  btn_login:"ç™»å…¥å¸³æˆ¶",
  btn_reset:"ğŸ”‘ é‡è¨­å¯†ç¢¼",
  btn_register:"è¨»å†Šå¸³æˆ¶",
  note_price:"è¨»å†Šå¸³è™Ÿè´ˆé€ä¸€æ¬¡å…è²»é«”é©—",
  panel_member_head:"æœƒå“¡æœå‹™",
  btn_upgrade:"ğŸ’ å‡ç´šç‚º VIPï¼ˆæœˆè²»ï¼‰",
  btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
  note_price1:"$9.9 / æœˆè²» VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ†ç©ºé–“ + éˆæ€§èª²ç¨‹ï¼‰",
  res_title:"å¿ƒæ†ç®¡å®¶è§£è®€èˆ‡å»ºè­°",
  chat_fab:"ğŸ’¬",
  chat_title:"å¿ƒæ†ç®¡å®¶ Â· GPT",
  chat_input_ph:"è¼¸å…¥å•é¡Œâ€¦",
  chat_send:"é€å‡º",
  btn_show_login_fields:"é¡¯ç¤ºç™»å…¥æ¬„",
  btn_hide_login_fields:"éš±è—ç™»å…¥æ¬„",
  time_unknown:"ä¸è©³"
},

"en-US": {
  page_title:"Soul Sanctuary Â· VIP",
  site_title:"Soul Sanctuary Â· VIP",
  lang_label:"Language",
  form_title:"Metaphysics Report Â· Generate",
  choose_type:"Choose Chart Type",
  type_personal:"Personal Chart",
  type_compat:"Compatibility (Two Profiles)",
  culture_auto:"Auto Detect",
  culture_cn:"Chinese / Bazi",
  culture_west:"Western Astrology / Tarot",
  culture_jp:"Japanese Nine Star Ki",
  culture_vedic:"Vedic Astrology",
  self_info:"Your Details",
  ph_name1:"Name (You)",
  ph_time1:"Birth Time",
  cal_g:"Gregorian",
  cal_l:"Lunar",
  ph_country1:"Birth Country / Region",
  btn_next:"Generate Analysis",
  partner_info:"Second Person (Compatibility)",
  ph_name2:"Name (Second Person)",
  ph_time2:"Birth Time",
  ph_country2:"Birth Country / Region",
  focus_title:"Focus Topic (Report)",
  portal_title:"Soul Sanctuary Â· Portal",
  vip_title:"ğŸŒ™ VIP Segment",
  login_title:"ğŸ’ VIP Login",
  panel_login_head:"Login / Sign Up",
  ph_email:"Email",
  ph_label_password:"Password",
  ph_password:"Password (min 8 chars, with upper/lowercase, numbers & symbols)",
  btn_login:"Log in",
  btn_reset:"ğŸ”‘ Reset Password",
  btn_register:"Sign up",
  note_price:"Sign up to get one free trial",
  panel_member_head:"Member Services",
  btn_upgrade:"ğŸ’ Upgrade to VIP (Monthly)",
  btn_backshop:"â† Back to Metaphysics Store",
  note_price1:"$9.9 / month VIP (Metaphysics + Soul Sanctuary + Spiritual Courses)",
  res_title:"Butler Insights & Suggestions",
  chat_fab:"ğŸ’¬",
  chat_title:"Xinlian Butler Â· GPT",
  chat_input_ph:"Type your questionâ€¦",
  chat_send:"Send",
  btn_show_login_fields:"Show login fields",
  btn_hide_login_fields:"Hide login fields",
  time_unknown:"Unknown"
},

"ja-JP": {
  page_title:"å¿ƒæ€œç©ºé–“ Â· VIP Soul Sanctuary",
  site_title:"å¿ƒæ€œç©ºé–“ Â· VIP Soul Sanctuary",
  lang_label:"è¨€èª",
  form_title:"å‘½ç†åˆ†æ Â· ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ",
  choose_type:"ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ",
  type_personal:"å€‹äººãƒãƒ£ãƒ¼ãƒˆ",
  type_compat:"ç›¸æ€§ï¼ˆ2äººã®æƒ…å ±ï¼‰",
  culture_auto:"è‡ªå‹•åˆ¤å®š Auto Detect",
  culture_cn:"æ±æ´‹ Chinese / Bazi",
  culture_west:"è¥¿æ´‹ Astrology / Tarot",
  culture_jp:"ä¹æ˜Ÿæ°—å­¦ Japanese",
  culture_vedic:"ã‚¤ãƒ³ãƒ‰å æ˜Ÿè¡“ Vedic",
  self_info:"æœ¬äººæƒ…å ±",
  ph_name1:"åå‰ï¼ˆæœ¬äººï¼‰",
  ph_time1:"å‡ºç”Ÿæ™‚åˆ»",
  cal_g:"è¥¿æš¦ (Gregorian)",
  cal_l:"æ—§æš¦ (Lunar)",
  ph_country1:"å‡ºç”Ÿå›½ / åœ°åŸŸ",
  btn_next:"åˆ†æã‚’ç”Ÿæˆ",
  partner_info:"ãŠç›¸æ‰‹æƒ…å ±ï¼ˆç›¸æ€§ï¼‰",
  ph_name2:"åå‰ï¼ˆ2äººç›®ï¼‰",
  ph_time2:"å‡ºç”Ÿæ™‚åˆ»",
  ph_country2:"å‡ºç”Ÿå›½ / åœ°åŸŸ",
  focus_title:"ãƒ†ãƒ¼ãƒï¼ˆãƒ¬ãƒãƒ¼ãƒˆã®ç„¦ç‚¹ï¼‰",
  portal_title:"å¿ƒæ€œç©ºé–“ Â· æ©Ÿèƒ½ãƒãƒ¼ã‚¿ãƒ«",
  vip_title:"ğŸŒ™ VIPã‚¨ãƒªã‚¢",
  login_title:"ğŸ’ VIPã«ãƒ­ã‚°ã‚¤ãƒ³",
  panel_login_head:"ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²",
  ph_email:"ãƒ¡ãƒ¼ãƒ« Email",
  ph_label_password:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ Password",
  ph_password:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ Passwordï¼ˆ8æ–‡å­—ä»¥ä¸Šã€å¤§/å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ï¼‰",
  btn_login:"ãƒ­ã‚°ã‚¤ãƒ³",
  btn_reset:"ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š",
  btn_register:"æ–°è¦ç™»éŒ²",
  note_price:"ç™»éŒ²ã§ç„¡æ–™ä½“é¨“1å›",
  panel_member_head:"ä¼šå“¡ã‚µãƒ¼ãƒ“ã‚¹",
  btn_upgrade:"ğŸ’ VIPã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆæœˆé¡ï¼‰",
  btn_backshop:"â† å‘½ç†ã‚·ãƒ§ãƒƒãƒ—ã«æˆ»ã‚‹",
  note_price1:"$9.9 / æœˆ VIPï¼ˆå‘½ç†ç©ºé–“ + å¿ƒæ€œç©ºé–“ + ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«è¬›åº§ï¼‰",
  res_title:"å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ã®è§£é‡ˆã¨ææ¡ˆ",
  chat_fab:"ğŸ’¬",
  chat_title:"å¿ƒæ€œãƒãƒˆãƒ©ãƒ¼ Â· GPT",
  chat_input_ph:"è³ªå•ã‚’å…¥åŠ›â€¦",
  chat_send:"é€ä¿¡",
  btn_show_login_fields:"ãƒ­ã‚°ã‚¤ãƒ³æ¬„ã‚’è¡¨ç¤º",
  btn_hide_login_fields:"ãƒ­ã‚°ã‚¤ãƒ³æ¬„ã‚’éè¡¨ç¤º",
  time_unknown:"ä¸æ˜"
},

"th-TH": {
  page_title:"Soul Sanctuary Â· VIP",
  site_title:"Soul Sanctuary Â· VIP",
  lang_label:"à¸ à¸²à¸©à¸²",
  form_title:"à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸”à¸§à¸‡ Â· à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™",
  choose_type:"à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—à¸”à¸§à¸‡",
  type_personal:"à¸”à¸§à¸‡à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§",
  type_compat:"à¸”à¸§à¸‡à¸„à¸¹à¹ˆ (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ 2 à¸„à¸™)",
  culture_auto:"à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ Auto Detect",
  culture_cn:"à¸ˆà¸µà¸™ Chinese / Bazi",
  culture_west:"à¸•à¸°à¸§à¸±à¸™à¸•à¸ Astrology / Tarot",
  culture_jp:"à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™ Japanese",
  culture_vedic:"à¹€à¸§à¸—/à¹‚à¸«à¸£à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸­à¸´à¸™à¹€à¸”à¸µà¸¢ Vedic",
  self_info:"à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“",
  ph_name1:"à¸Šà¸·à¹ˆà¸­ (à¸„à¸¸à¸“)",
  ph_time1:"à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”",
  cal_g:"à¸›à¸à¸´à¸—à¸´à¸™à¸ªà¸²à¸à¸¥ (Gregorian)",
  cal_l:"à¸›à¸à¸´à¸—à¸´à¸™à¸ˆà¸±à¸™à¸—à¸£à¸„à¸•à¸´ (Lunar)",
  ph_country1:"à¸›à¸£à¸°à¹€à¸—à¸¨ / à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¹€à¸à¸´à¸”",
  btn_next:"à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ",
  partner_info:"à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸µà¸à¸„à¸™ (à¸”à¸§à¸‡à¸„à¸¹à¹ˆ)",
  ph_name2:"à¸Šà¸·à¹ˆà¸­ (à¸­à¸µà¸à¸„à¸™)",
  ph_time2:"à¹€à¸§à¸¥à¸²à¹€à¸à¸´à¸”",
  ph_country2:"à¸›à¸£à¸°à¹€à¸—à¸¨ / à¸ à¸¹à¸¡à¸´à¸ à¸²à¸„à¹€à¸à¸´à¸”",
  focus_title:"à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (à¹‚à¸Ÿà¸à¸±à¸ªà¸£à¸²à¸¢à¸‡à¸²à¸™)",
  portal_title:"Soul Sanctuary Â· à¸—à¸²à¸‡à¹€à¸‚à¹‰à¸²à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™",
  vip_title:"ğŸŒ™ à¹‚à¸‹à¸™à¸ªà¸¡à¸²à¸Šà¸´à¸ VIP",
  login_title:"ğŸ’ à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š VIP",
  panel_login_head:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š / à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸",
  ph_email:"à¸­à¸µà¹€à¸¡à¸¥ Email",
  ph_label_password:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ Password",
  ph_password:"à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ Password (à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 8 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ à¸¡à¸µà¸•à¸±à¸§à¸à¸´à¸¡à¸à¹Œà¹ƒà¸«à¸à¹ˆ/à¹€à¸¥à¹‡à¸ à¸•à¸±à¸§à¹€à¸¥à¸‚ à¹à¸¥à¸°à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œ)",
  btn_login:"à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
  btn_reset:"ğŸ”‘ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™",
  btn_register:"à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸",
  note_price:"à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¸£à¸±à¸šà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸—à¸”à¸¥à¸­à¸‡à¸Ÿà¸£à¸µ 1 à¸„à¸£à¸±à¹‰à¸‡",
  panel_member_head:"à¸šà¸£à¸´à¸à¸²à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸",
  btn_upgrade:"ğŸ’ à¸­à¸±à¸›à¹€à¸à¸£à¸”à¹€à¸›à¹‡à¸™ VIP (à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™)",
  btn_backshop:"â† à¸à¸¥à¸±à¸šà¹„à¸›à¸—à¸µà¹ˆà¸£à¹‰à¸²à¸™à¸„à¹‰à¸²",
  note_price1:"$9.9 / à¹€à¸”à¸·à¸­à¸™ VIP (Metaphysics + Soul Sanctuary + à¸„à¸­à¸£à¹Œà¸ªà¸ˆà¸´à¸•à¸§à¸´à¸à¸à¸²à¸“)",
  res_title:"à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸ˆà¸²à¸à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢",
  chat_fab:"ğŸ’¬",
  chat_title:"Xinlian Butler Â· GPT",
  chat_input_ph:"à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸–à¸²à¸¡â€¦",
  chat_send:"à¸ªà¹ˆà¸‡",
  btn_show_login_fields:"à¹à¸ªà¸”à¸‡à¸Šà¹ˆà¸­à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
  btn_hide_login_fields:"à¸‹à¹ˆà¸­à¸™à¸Šà¹ˆà¸­à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š",
  time_unknown:"à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸š"
},

"ms-MY": {
  page_title:"Soul Sanctuary Â· VIP",
  site_title:"Soul Sanctuary Â· VIP",
  lang_label:"Bahasa",
  form_title:"Analisis Metafizik Â· Jana Laporan",
  choose_type:"Pilih Jenis Carta",
  type_personal:"Carta Peribadi",
  type_compat:"Padanan (2 orang)",
  culture_auto:"Kesan Automatik Auto Detect",
  culture_cn:"Cina Chinese / Bazi",
  culture_west:"Barat Astrology / Tarot",
  culture_jp:"Jepun Nine Star Ki",
  culture_vedic:"Vedic Astrology",
  self_info:"Maklumat Anda",
  ph_name1:"Nama (Anda)",
  ph_time1:"Masa Lahir",
  cal_g:"Gregorian",
  cal_l:"Lunar",
  ph_country1:"Negara / Wilayah Lahir",
  btn_next:"Jana Analisis",
  partner_info:"Maklumat Orang Kedua (Padanan)",
  ph_name2:"Nama (Orang Kedua)",
  ph_time2:"Masa Lahir",
  ph_country2:"Negara / Wilayah Lahir",
  focus_title:"Topik Fokus (Laporan)",
  portal_title:"Soul Sanctuary Â· Portal",
  vip_title:"ğŸŒ™ Segmen VIP",
  login_title:"ğŸ’ Log Masuk VIP",
  panel_login_head:"Log Masuk / Daftar",
  ph_email:"E-mel Email",
  ph_label_password:"Kata Laluan Password",
  ph_password:"Kata Laluan Password (min 8 aksara, huruf besar/kecil, nombor & simbol)",
  btn_login:"Log Masuk",
  btn_reset:"ğŸ”‘ Tetapkan Semula Kata Laluan",
  btn_register:"Daftar Akaun",
  note_price:"Daftar akaun dapat 1 percubaan percuma",
  panel_member_head:"Perkhidmatan Ahli",
  btn_upgrade:"ğŸ’ Naik taraf ke VIP (Bulanan)",
  btn_backshop:"â† Kembali ke Kedai Metafizik",
  note_price1:"$9.9 / bulan VIP (Metaphysics + Soul Sanctuary + Kursus Spiritual)",
  res_title:"Tafsiran & Cadangan Butler",
  chat_fab:"ğŸ’¬",
  chat_title:"Xinlian Butler Â· GPT",
  chat_input_ph:"Taip soalanâ€¦",
  chat_send:"Hantar",
  btn_show_login_fields:"Tunjukkan ruangan log masuk",
  btn_hide_login_fields:"Sembunyikan ruangan log masuk",
  time_unknown:"Tidak diketahui"
},

function $(id){ return document.getElementById(id); }

function getLang(){
  return localStorage.getItem(LANG_KEY) || document.documentElement.lang || DEFAULT_LANG;
}
function setLang(code){
  localStorage.setItem(LANG_KEY, code);
  document.documentElement.lang = code;
}
function t(key){
  const lang = getLang();
  return (translations[lang] && translations[lang][key])
      || (translations["zh-CN"] && translations["zh-CN"][key])
      || key;
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

/* ==============================
   Error helper
============================== */
function ensureErrorBox(){
  let box = $('error');
  if (!box){
    box = document.createElement('div');
    box.id = 'error';
    box.className = 'error';
    box.style.cssText = 'margin-top:10px;color:#ff8b8b';
    (document.querySelector('.card.section') || document.body).appendChild(box);
  }
  return box;
}
function showErr(msg){
  const e = ensureErrorBox();
  e.textContent = msg;
  e.style.display = 'block';
  setTimeout(()=>{ e.style.display='none'; }, 5000);
}

/* ==============================
   UI helpers (bars)
============================== */
function setText(id, txt){
  const el = $(id);
  if (el) el.textContent = (txt ?? '');
}
function setBar(el, pct){
  if(!el) return;
  const v = Math.max(0, Math.min(100, Number(pct)||0));
  el.style.width = v + '%';
  el.setAttribute('aria-valuenow', String(Math.round(v)));
}

/* ==============================
   Culture -> focus options map
============================== */
const culturePurposeMap = {
  'ä¸œæ–¹': {
    personal: ['æ‹çˆ±ç¼˜åˆ†','å©šå§»èµ°åŠ¿','èŒåœºå‘å±•','åˆ›ä¸šæ½œåŠ›','è´¢ä½åˆ†æ','ç†è´¢æ—¶æœº','å©šæœŸæ‹©æ—¥','æ–°ç”Ÿå®å®æ‹©æ—¥','æ–°å®¶å…¥ä½æ‹©æ—¥','æ–°å…¬å¸å…¥ä½æ‹©æ—¥','å®å®å','å® ç‰©å','å…¬å¸å','å‘½åæ”¹è¿','ä½å®¶','åŠå…¬å®¤'],
    compatibility: ['æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰','å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰','åˆç›˜åˆ†æ','äº‹ä¸šå…±äº‹','æ–­è”ä¿®å¤','å® ç‰©ç¼˜åˆ†']
  },
  'è¥¿æ–¹': {
    personal: ['çˆ±æƒ…è¿åŠ¿','èŒä¸šå‘å±•','è´¢å¯Œå¢é•¿','å¿ƒçµæˆé•¿','å¡”ç½—å åœ','æ˜Ÿç›˜è§£è¯»','äººé™…å…³ç³»','å¥åº·è¿åŠ¿'],
    compatibility: ['å…³ç³»åˆç›˜','çµé­‚ä¼´ä¾£','åˆä½œè¿åŠ¿','å®¶åº­å…³ç³»','å‹è°Šåˆ†æ']
  },
  'æ—¥å¼': {
    personal: ['ä¹æ˜Ÿè¿åŠ¿','æ–¹ä½å‰å‡¶','å§“åé‰´å®š','æ‹çˆ±å åœ','èŒä¸šæŒ‡å—','å¥åº·å»ºè®®','å®¶ç›¸è¯Šæ–­'],
    compatibility: ['ç¼˜åˆ†åŒ¹é…','ç›¸æ€§è¯Šæ–­','åˆä½œç¼˜åˆ†','å®¶åº­å’Œè°']
  },
  'å é™€': {
    personal: ['æœ¬å‘½ç›˜','äº‹ä¸šæ–¹å‘','å©šå§»è¿åŠ¿','å¥åº·å»ºè®®','æ‹©å‰æ—¥','å®çŸ³æ¨è','ä»ªå¼å»ºè®®'],
    compatibility: ['å¤«å¦»åˆç›˜','åˆä½œåŒ¹é…','å®¶åº­åˆç›˜','å•†ä¸šä¼™ä¼´']
  }
};

function normalizeCulture(v){
  if (!v || v === 'auto') return 'ä¸œæ–¹';
  return v;
}

/* ==============================
   Toggle partner + focus selector
============================== */
function togglePartner(value){
  const section = $('partner-section');
  const personal = $('purpose_personal');
  const compat = $('purpose_compatibility');
  const show = (value === "compatibility");

  if (section) section.style.display = show ? "block" : "none";
  if (personal){
    personal.style.display = show ? "none" : "block";
    personal.disabled = show;
  }
  if (compat){
    compat.style.display = show ? "block" : "none";
    compat.disabled = !show;
  }
  updatePurposeOptions($('culture')?.value || 'auto');
}

function updatePurposeOptions(cultureRaw){
  const culture = normalizeCulture(cultureRaw);
  const typeSel = $('type')?.value || 'personal';
  const config = culturePurposeMap[culture] || culturePurposeMap['ä¸œæ–¹'];
  const options = (typeSel === 'compatibility') ? config.compatibility : config.personal;

  if (typeSel === 'compatibility'){
    updateCompatibilityPurposeOptions(options);
  }else{
    updatePersonalPurposeOptions(options);
  }
}

function updatePersonalPurposeOptions(options){
  const select = $('purpose_personal');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '';

  // If the selected culture is not ä¸œæ–¹, just dump as plain options (simpler + no missing i18n)
  const culture = normalizeCulture($('culture')?.value || 'auto');
  if (culture !== 'ä¸œæ–¹'){
    options.forEach(item=>{
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      select.appendChild(opt);
    });
    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) select.value = currentValue;
    return;
  }

  // ä¸œæ–¹: keep your grouped experience
  const groups = {
    'å§»ç¼˜ Love': ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿'],
    'äº‹ä¸š Career': ['èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›'],
    'è´¢è¿ Wealth': ['è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº'],
    'æ‹©æ—¥ Auspicious Date': ['å©šæœŸæ‹©æ—¥', 'æ–°ç”Ÿå®å®æ‹©æ—¥', 'æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥'],
    'æµ‹å Name Analysis': ['å®å®å', 'å® ç‰©å', 'å…¬å¸å', 'å‘½åæ”¹è¿'],
    'é£æ°´ Feng Shui': ['ä½å®¶', 'åŠå…¬å®¤']
  };

  Object.entries(groups).forEach(([label, items])=>{
    const availableItems = items.filter(item => options.includes(item));
    if (!availableItems.length) return;
    const og = document.createElement('optgroup');
    og.label = label;
    availableItems.forEach(item=>{
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      og.appendChild(opt);
    });
    select.appendChild(og);
  });

  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) select.value = currentValue;
}

function updateCompatibilityPurposeOptions(options){
  const select = $('purpose_compatibility');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '';

  const og = document.createElement('optgroup');
  og.label = 'åˆç›˜åˆ†æ Compatibility';
  options.forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    og.appendChild(opt);
  });
  select.appendChild(og);

  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) select.value = currentValue;
}

/* ==============================
   Bazi calculator (your simplified version)
============================== */
const baziCalculator = {
  heavenlyStems: ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'],
  earthlyBranches: ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'],

  getStemElement(stem){
    const map={'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'};
    return map[stem] || 'æœ¨';
  },
  getBranchElement(branch){
    const map={'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´'};
    return map[branch] || 'æœ¨';
  },

  calculateYearPillar(year){
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    const stem = this.heavenlyStems[(stemIndex+10)%10];
    const branch = this.earthlyBranches[(branchIndex+12)%12];
    return { stem, branch, element:this.getStemElement(stem) };
  },

  calculateMonthPillar(year, month){
    // simplified mapping (same as your version)
    const monthMap = {
      1:{stem:'ä¸™',branch:'å¯…'},2:{stem:'ä¸',branch:'å¯'},3:{stem:'æˆŠ',branch:'è¾°'},4:{stem:'å·±',branch:'å·³'},
      5:{stem:'åºš',branch:'åˆ'},6:{stem:'è¾›',branch:'æœª'},7:{stem:'å£¬',branch:'ç”³'},8:{stem:'ç™¸',branch:'é…‰'},
      9:{stem:'ç”²',branch:'æˆŒ'},10:{stem:'ä¹™',branch:'äº¥'},11:{stem:'ä¸™',branch:'å­'},12:{stem:'ä¸',branch:'ä¸‘'}
    };
    const p = monthMap[month] || monthMap[1];
    return { stem:p.stem, branch:p.branch, element:this.getStemElement(p.stem) };
  },

  calculateDayPillar(year, month, day){
    const date = new Date(year, month-1, day);
    const startDate = new Date(1900,0,1);
    const dayNum = Math.floor((date - startDate) / 86400000);
    const stem = this.heavenlyStems[(dayNum%10+10)%10];
    const branch = this.earthlyBranches[(dayNum%12+12)%12];
    return { stem, branch, element:this.getStemElement(stem) };
  },

  calculateHourPillar(dayStem, hour){
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const startStems = {'ç”²':'ç”²','ä¹™':'ä¸™','ä¸™':'æˆŠ','ä¸':'åºš','æˆŠ':'å£¬','å·±':'ç”²','åºš':'ä¸™','è¾›':'æˆŠ','å£¬':'åºš','ç™¸':'å£¬'};
    const stem = startStems[dayStem] || 'ç”²';
    return { stem, branch:this.earthlyBranches[hourIndex], element:this.getStemElement(stem) };
  },

  calculateBazi(year, month, day, hour, timeUnknown){
    const dayP = this.calculateDayPillar(year, month, day);
    const pillars = {
      year: this.calculateYearPillar(year),
      month: this.calculateMonthPillar(year, month),
      day: dayP,
      hour: timeUnknown ? { stem:'?', branch:'?', element:'æœªçŸ¥' } : this.calculateHourPillar(dayP.stem, hour)
    };

    const elements = { 'æœ¨':0,'ç«':0,'åœŸ':0,'é‡‘':0,'æ°´':0 };
    Object.values(pillars).forEach(p=>{
      if (p.element && p.element !== 'æœªçŸ¥') elements[p.element]+=3;
      if (p.branch && p.branch !== '?'){
        elements[this.getBranchElement(p.branch)] += 2;
      }
    });
    const total = Object.values(elements).reduce((a,b)=>a+b,0) || 1;
    const percents = {
      wood: Math.round(elements['æœ¨']/total*100),
      fire: Math.round(elements['ç«']/total*100),
      earth: Math.round(elements['åœŸ']/total*100),
      metal: Math.round(elements['é‡‘']/total*100),
      water: Math.round(elements['æ°´']/total*100),
    };
    return { pillars, percents, timeUnknown };
  }
};

/* ==============================
   Other calculators (your simplified versions)
============================== */
const calculators = {
  'ä¸œæ–¹': {
    name:'å…«å­—å‘½ç†',
    calculate:(y,m,d,h,tu)=>baziCalculator.calculateBazi(y,m,d,h,tu),
    render: renderBaziReport,
    analysis: generateBaziReport
  },
  'è¥¿æ–¹': {
    name:'è¥¿æ´‹å æ˜Ÿ',
    calculate:(y,m,d,h,tu)=>{
      const zodiacSigns=['æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§','ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§','å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§'];
      const signIndex = (m-1)%12;
      return {
        zodiac:zodiacSigns[signIndex],
        rising: tu ? 'æœªçŸ¥' : ['ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§','å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§'][h%12],
        moon: ['å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§','ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§'][d%12],
        elements:{fire:30,earth:25,air:25,water:20}
      };
    },
    render: renderWesternReport,
    analysis: generateWesternReport
  },
  'æ—¥å¼': {
    name:'ä¹æ˜Ÿæ°—å­¦',
    calculate:(y,m,d)=>{
      const numbers=['ä¸€ç™½æ°´æ˜Ÿ','äºŒé»’åœŸæ˜Ÿ','ä¸‰ç¢§æœ¨æ˜Ÿ','å››ç·‘æœ¨æ˜Ÿ','äº”é»„åœŸæ˜Ÿ','å…­ç™½é‡‘æ˜Ÿ','ä¸ƒèµ¤é‡‘æ˜Ÿ','å…«ç™½åœŸæ˜Ÿ','ä¹ç´«ç«æ˜Ÿ'];
      const idx=(y+m+d)%9;
      return {
        number:numbers[idx],
        element:['æ°´','åœŸ','æœ¨','æœ¨','åœŸ','é‡‘','é‡‘','åœŸ','ç«'][idx],
        direction:['åŒ—','è¥¿å—','æ±','æ±å—','ä¸­å¤®','è¥¿åŒ—','è¥¿','æ±åŒ—','å—'][idx],
        luck:['å‰','å‡¶','å‰','å‰','å‡¶','å‰','å‰','å‰','å‰'][idx]
      };
    },
    render: renderJapaneseReport,
    analysis: generateJapaneseReport
  },
  'å é™€': {
    name:'å°åº¦å é™€',
    calculate:(y,m,d)=>{
      const rashis=['Mesha','Vrishabha','Mithuna','Karka','Simha','Kanya','Tula','Vrishchika','Dhanu','Makara','Kumbha','Meena'];
      const idx=(m-1)%12;
      return {
        rashi:rashis[idx],
        nakshatra:['Ashwini','Bharani','Krittika','Rohini','Mrigashira','Ardra','Punarvasu','Pushya','Ashlesha','Magha','Purva Phalguni','Uttara Phalguni'][d%12],
        element:['ç«','åœŸ','é¢¨','æ°´','ç«','åœŸ','é¢¨','æ°´','ç«','åœŸ','é¢¨','æ°´'][idx]
      };
    },
    render: renderVedicReport,
    analysis: generateVedicReport
  }
};

/* ==============================
   Result host builder (for ä¸œæ–¹)
============================== */
function ensureResultHost(){
  const result = $('result');
  if (!result) return null;
  // Ensure these placeholders exist
  if (!$('butler-host')){
    const bh = document.createElement('div');
    bh.id = 'butler-host';
    result.appendChild(bh);
  }
  if (!$('rich-report')){
    const rr = document.createElement('div');
    rr.id = 'rich-report';
    result.appendChild(rr);
  }
  if (!$('xl-free-report')){
    const free = document.createElement('div');
    free.id = 'xl-free-report';
    free.innerHTML = `
      <div class="card" style="margin-top:8px">
        <div class="group-title">å‘½ç†ç®€æŠ¥</div>
        <div id="bazi-date" class="sub" style="margin-bottom:8px"></div>
        <div id="bazi-pillars" class="pillars"></div>
        <div class="row" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;align-items:center;margin-top:10px">
          <div><div>æœ¨</div><div class="bar"><i id="bar-æœ¨"></i></div><div id="pct-æœ¨" class="muted" style="margin-top:4px"></div></div>
          <div><div>ç«</div><div class="bar"><i id="bar-ç«"></i></div><div id="pct-ç«" class="muted" style="margin-top:4px"></div></div>
          <div><div>åœŸ</div><div class="bar"><i id="bar-åœŸ"></i></div><div id="pct-åœŸ" class="muted" style="margin-top:4px"></div></div>
          <div><div>é‡‘</div><div class="bar"><i id="bar-é‡‘"></i></div><div id="pct-é‡‘" class="muted" style="margin-top:4px"></div></div>
          <div><div>æ°´</div><div class="bar"><i id="bar-æ°´"></i></div><div id="pct-æ°´" class="muted" style="margin-top:4px"></div></div>
        </div>
        <div id="bazi-elements-balance" class="sub" style="margin-top:8px"></div>
      </div>
    `;
    result.appendChild(free);
  }
  return result;
}

function renderPillars(root, p, timeUnknown=false){
  if(!root) return;
  root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const isUnknown = (tit==='æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;
    const div = document.createElement('div');
    div.className='pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
      ${v.element && v.element!=='æœªçŸ¥' ? `<div style="color:#98a7b7;font-size:.75rem;margin-top:4px">${v.element}</div>` : ''}
    `;
    root.appendChild(div);
  });
}

/* ==============================
   Renderers
============================== */
function renderBaziReport(result, info){
  $('result').style.display='block';
  ensureResultHost();

  const { pillars, percents, timeUnknown } = result;
  const timeText = timeUnknown ? t('time_unknown') : `${info.hour}æ—¶`;
  setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${info.year}å¹´${info.month}æœˆ${info.day}æ—¥ ${timeText}`);
  renderPillars($('bazi-pillars'), pillars, timeUnknown);

  setBar($('bar-æœ¨'), percents.wood); setText('pct-æœ¨', percents.wood + '%');
  setBar($('bar-ç«'), percents.fire); setText('pct-ç«', percents.fire + '%');
  setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ', percents.earth + '%');
  setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘', percents.metal + '%');
  setBar($('bar-æ°´'), percents.water); setText('pct-æ°´', percents.water + '%');

  const elements = [
    {name:'æœ¨',value:percents.wood},{name:'ç«',value:percents.fire},{name:'åœŸ',value:percents.earth},{name:'é‡‘',value:percents.metal},{name:'æ°´',value:percents.water}
  ].sort((a,b)=>b.value-a.value);
  setText('bazi-elements-balance', `å…ƒç´ å¹³è¡¡ï¼š${elements[0].name}åå¼º (${elements[0].value}%) Â· ${elements[4].name}åå¼± (${elements[4].value}%)`);
}

function renderWesternReport(result){
  $('result').style.display='block';
  ensureResultHost();
  const host = $('butler-host');

  host.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">è¥¿æ´‹å æ˜ŸæŠ¥å‘Š</h3>
      <p><strong>å¤ªé˜³æ˜Ÿåº§ï¼š</strong>${result.zodiac}</p>
      <p><strong>ä¸Šå‡æ˜Ÿåº§ï¼š</strong>${result.rising}</p>
      <p><strong>æœˆäº®æ˜Ÿåº§ï¼š</strong>${result.moon}</p>
      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div><div>ç«</div><div class="bar"><i style="width:${result.elements.fire}%"></i></div><div class="muted">${result.elements.fire}%</div></div>
        <div><div>åœŸ</div><div class="bar"><i style="width:${result.elements.earth}%"></i></div><div class="muted">${result.elements.earth}%</div></div>
        <div><div>é£</div><div class="bar"><i style="width:${result.elements.air}%"></i></div><div class="muted">${result.elements.air}%</div></div>
        <div><div>æ°´</div><div class="bar"><i style="width:${result.elements.water}%"></i></div><div class="muted">${result.elements.water}%</div></div>
      </div>
    </div>
  `;
}

function renderJapaneseReport(result){
  $('result').style.display='block';
  ensureResultHost();
  const host = $('butler-host');

  host.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">æ—¥å¼ä¹æ˜ŸæŠ¥å‘Š</h3>
      <div style="text-align:center;padding:14px 10px">
        <div style="font-size:2.2rem;color:var(--gold2);font-weight:800">${result.number}</div>
        <div class="chips" style="justify-content:center">
          <span class="chip">${result.element}å…ƒç´ </span>
          <span class="chip">${result.direction}æ–¹ä½</span>
          <span class="chip">${result.luck}é‹</span>
        </div>
        <div class="sub" style="margin-top:10px">æœ¬å‘½æ˜Ÿå½±å“æ‚¨çš„æ€§æ ¼ç‰¹è´¨å’Œè¿åŠ¿èµ°å‘</div>
      </div>
    </div>
  `;
}

function renderVedicReport(result){
  $('result').style.display='block';
  ensureResultHost();
  const host = $('butler-host');

  host.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">å°åº¦å é™€æŠ¥å‘Š</h3>
      <p><strong>æœ¬å‘½æ˜Ÿåº§ (Rashi)ï¼š</strong>${result.rashi}</p>
      <p><strong>æœˆå®¿ (Nakshatra)ï¼š</strong>${result.nakshatra}</p>
      <p><strong>ä¸»å¯¼å…ƒç´ ï¼š</strong>${result.element}</p>
      <div style="margin-top:12px;padding:12px;background:rgba(212,175,55,.08);border-radius:10px;border:1px solid var(--line)">
        <div class="muted">æ ¹æ®å é™€å æ˜Ÿå­¦ï¼Œæ‚¨çš„å‘½ç›˜æ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„èƒ½é‡ç‰¹è´¨ã€‚</div>
      </div>
    </div>
  `;
}

/* ==============================
   Analysis generators (keep yours; here minimal safe wrappers)
   (Uses your existing generateBaziReport() etc. If you already defined them below, keep them.)
============================== */
function generateBaziReport({ pillars, percents, focus = "" } = {}){
  // If you already have your long version, you can paste it here instead.
  const dayStem = pillars?.day?.stem || "ç”²";
  const dayBranch = pillars?.day?.branch || "å­";
  return `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">å¿ƒæ€œç®¡å®¶ Â· å…«å­—å»ºè®®</h3>
      <p><strong>æ—¥ä¸»ï¼š</strong>${dayStem}${dayBranch}</p>
      <p class="muted">ï¼ˆæ­¤å¤„ä¸ºç¤ºä¾‹è¾“å‡ºã€‚ä½ å¯ä»¥ç»§ç»­ç”¨ä½ åŸæœ¬é‚£å¥—é•¿æ–‡ generateBaziReportã€‚ï¼‰</p>
      <p><strong>èšç„¦ä¸»é¢˜ï¼š</strong>${focus || 'ç»¼åˆ'}</p>
    </div>
  `;
}
function generateWesternReport(result, focus){
  return `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">å¿ƒæ€œç®¡å®¶ Â· å æ˜Ÿå»ºè®®</h3>
      <p><strong>å¤ªé˜³ï¼š</strong>${result.zodiac} ï½œ <strong>æœˆäº®ï¼š</strong>${result.moon}</p>
      <p><strong>èšç„¦ä¸»é¢˜ï¼š</strong>${focus || 'ç»¼åˆ'}</p>
    </div>
  `;
}
function generateJapaneseReport(result, focus){
  return `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">å¿ƒæ€œç®¡å®¶ Â· ä¹æ˜Ÿå»ºè®®</h3>
      <p><strong>æœ¬å‘½æ˜Ÿï¼š</strong>${result.number}ï¼ˆ${result.element}ï¼‰</p>
      <p><strong>èšç„¦ä¸»é¢˜ï¼š</strong>${focus || 'ç»¼åˆ'}</p>
    </div>
  `;
}
function generateVedicReport(result, focus){
  return `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">å¿ƒæ€œç®¡å®¶ Â· å é™€å»ºè®®</h3>
      <p><strong>Rashiï¼š</strong>${result.rashi} ï½œ <strong>Nakshatraï¼š</strong>${result.nakshatra}</p>
      <p><strong>èšç„¦ä¸»é¢˜ï¼š</strong>${focus || 'ç»¼åˆ'}</p>
    </div>
  `;
}

function generateCompatibilityReport(culture, focus){
  return `
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--gold)">åˆç›˜åˆ†æï¼ˆ${culture}ï¼‰</h3>
      <p class="muted">ä½ ç°åœ¨çš„åˆç›˜é€»è¾‘è¿˜æ²¡æ¥åç«¯ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆç»™ä¸€ä¸ªå ä½è¾“å‡ºã€‚åç»­ä½ æŠŠåˆç›˜ API æ¥ä¸Šï¼Œæˆ‘å¸®ä½ æŠŠè¿™é‡Œæ”¹æˆçœŸå®æŠ¥å‘Šã€‚</p>
      <p><strong>èšç„¦ä¸»é¢˜ï¼š</strong>${focus || 'ç»¼åˆ'}</p>
    </div>
  `;
}

/* ==============================
   Generate report (button)
============================== */
function parseDateInput(v){
  if(!v) return null;
  const [yy,mm,dd] = v.split('-').map(n=>parseInt(n,10));
  if(!yy||!mm||!dd) return null;
  return {yy,mm,dd};
}
function parseTimeHour(v){
  if(!v) return null;
  const [hh] = v.split(':').map(n=>parseInt(n,10));
  return Number.isFinite(hh) ? hh : null;
}

function getFocus(){
  const isCompat = ($('type')?.value === 'compatibility');
  const sel = isCompat ? $('purpose_compatibility') : $('purpose_personal');
  return sel?.value || '';
}

function clearResultArea(){
  const result = $('result');
  if (!result) return;
  const bh = $('butler-host'); if (bh) bh.innerHTML = '';
  const rr = $('rich-report'); if (rr) rr.innerHTML = '';
  // Keep ä¸œæ–¹çš„ç®€æŠ¥ block (xl-free-report) because we update it
}

function generateReport(){
  const type = $('type')?.value || 'personal';
  const cultureRaw = $('culture')?.value || 'auto';
  const culture = normalizeCulture(cultureRaw);

  const d1 = parseDateInput($('birthdate1')?.value);
  if(!d1) return showErr('è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸï¼ˆæœ¬äººï¼‰');
  const name1 = ($('name1')?.value || '').trim();
  const country1 = ($('country1')?.value || '').trim();
  if(!name1) return showErr('è¯·å¡«å†™å§“åï¼ˆæœ¬äººï¼‰');
  if(!country1) return showErr('è¯·å¡«å†™å‡ºç”Ÿå›½å®¶/åœ°åŒºï¼ˆæœ¬äººï¼‰');

  const timeUnknown1 = !!$('timeUnknown')?.checked;
  const hour1 = timeUnknown1 ? 12 : (parseTimeHour($('birthtime1')?.value) ?? 12);

  // If compatibility: validate second person (basic)
  if (type === 'compatibility'){
    const name2 = ($('name2')?.value || '').trim();
    const country2 = ($('country2')?.value || '').trim();
    const d2 = parseDateInput($('birthdate2')?.value);

    if(!name2) return showErr('è¯·å¡«å†™ç¬¬äºŒäººå§“åï¼ˆåˆç›˜ï¼‰');
    if(!d2) return showErr('è¯·å¡«å†™ç¬¬äºŒäººå‡ºç”Ÿæ—¥æœŸï¼ˆåˆç›˜ï¼‰');
    if(!country2) return showErr('è¯·å¡«å†™ç¬¬äºŒäººå‡ºç”Ÿå›½å®¶/åœ°åŒºï¼ˆåˆç›˜ï¼‰');
  }

  const calc = calculators[culture] || calculators['ä¸œæ–¹'];
  const focus = getFocus();

  clearResultArea();
  $('result').style.display = 'block';
  ensureResultHost();

  // Personal calculation
  const info = { year:d1.yy, month:d1.mm, day:d1.dd, hour:hour1, timeUnknown:timeUnknown1 };

  if (type === 'personal'){
    const data = calc.calculate(info.year, info.month, info.day, info.hour, info.timeUnknown);
    // render + analysis
    calc.render(data, info);
    const analysisHTML = (culture === 'ä¸œæ–¹')
      ? calc.analysis({ pillars:data.pillars, percents:data.percents, focus })
      : calc.analysis(data, focus);

    $('rich-report').innerHTML = analysisHTML;
  } else {
    // For now: placeholder compatibility output (until you wire API)
    // Still show a small â€œheaderâ€ render from calc if you want; but we keep it clean.
    $('butler-host').innerHTML = generateCompatibilityReport(culture, focus);
  }

  // scroll into view
  $('result').scrollIntoView({ behavior:'smooth', block:'start' });
}

/* ==============================
   Time unknown checkbox UX
============================== */
function wireTimeUnknown(timeId, chkId){
  const t = $(timeId);
  const c = $(chkId);
  if(!t || !c) return;
  function sync(){
    if (c.checked){
      t.value = '';
      t.setAttribute('disabled','disabled');
      t.style.opacity = '0.6';
    }else{
      t.removeAttribute('disabled');
      t.style.opacity = '1';
    }
  }
  c.addEventListener('change', sync);
  sync();
}

/* ==============================
   VIP auth fields: hidden by default + toggle
============================== */
function setupAuthReveal(){
  const authFields = $('authFields');
  if (!authFields) return;

  // Hide by default (your preference)
  authFields.style.display = 'none';

  // Inject toggle button into the empty row
  const hostRow = document.querySelector('.astro-auth .panel .body .row.one');
  if (hostRow){
    hostRow.innerHTML = `
      <button class="btn ghost block" id="toggleAuthFields" type="button">
        ${t('btn_show_login_fields')}
      </button>
      <div class="muted" style="margin-top:6px">ï¼ˆç™»å½•æ é»˜è®¤éšè—ï¼Œç‚¹å‡»åæ‰æ˜¾ç¤ºï¼‰</div>
    `;
  }

  function updateBtn(){
    const btn = $('toggleAuthFields');
    if (!btn) return;
    const shown = authFields.style.display !== 'none';
    btn.textContent = shown ? t('btn_hide_login_fields') : t('btn_show_login_fields');
  }

  document.addEventListener('click', (e)=>{
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;
    if (target.id === 'toggleAuthFields'){
      const shown = authFields.style.display !== 'none';
      authFields.style.display = shown ? 'none' : 'flex';
      authFields.style.flexDirection = 'column';
      authFields.style.gap = '10px';
      updateBtn();
    }
  });

  updateBtn();

  // Prevent default submits (until your real API wiring is in place)
  const loginForm = $('loginForm');
  const registerForm = $('registerForm');
  const resetBtn = $('resetBtn');
  const errBox = $('authError');

  function setAuthError(msg){
    if (!errBox) return;
    errBox.style.display = msg ? 'block' : 'none';
    errBox.textContent = msg || '';
  }

  if (loginForm){
    loginForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      setAuthError('ç™»å½•åŠŸèƒ½å°šæœªè¿æ¥åç«¯ï¼ˆä½ æ¥ä¸Š Airtable/Worker API åï¼Œæˆ‘å¸®ä½ è¡¥å…¨ï¼‰ã€‚');
    });
  }
  if (registerForm){
    registerForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      setAuthError('æ³¨å†ŒåŠŸèƒ½å°šæœªè¿æ¥åç«¯ï¼ˆä½ æ¥ä¸Š Airtable/Worker API åï¼Œæˆ‘å¸®ä½ è¡¥å…¨ï¼‰ã€‚');
    });
  }
  if (resetBtn){
    resetBtn.addEventListener('click', ()=>{
      setAuthError('é‡è®¾å¯†ç åŠŸèƒ½å°šæœªè¿æ¥åç«¯ï¼ˆä½ æ¥ä¸Š Airtable/Worker API åï¼Œæˆ‘å¸®ä½ è¡¥å…¨ï¼‰ã€‚');
    });
  }
}

/* ==============================
   Floating chat
============================== */
let chatHistory = [];

function appendChat(role, text){
  const body = $("chatBody");
  if (!body) return;
  const msg = document.createElement("div");
  msg.className = "ss-msg" + (role === "user" ? " me" : "");
  msg.textContent = text;
  body.appendChild(msg);
  body.scrollTop = body.scrollHeight;
}

function toggleChat(open){
  const panel = $("chatPanel");
  if (!panel) return;
  panel.setAttribute("aria-hidden", open ? "false" : "true");
}

async function sendChat(){
  const input = $("chatInput");
  const text = (input?.value || "").trim();
  if (!text) return;

  appendChat("user", text);
  input.value = "";

  chatHistory.push({ role:"user", content:text });
  chatHistory = chatHistory.slice(-12);

  try{
    const res = await fetch(API_BASE + CHAT_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ lang: getLang(), messages: chatHistory })
    });
    if (!res.ok) throw new Error("chat api error");
    const data = await res.json();
    const reply = data?.reply || data?.text || data?.message || "ï¼ˆç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•ï¼‰";
    chatHistory.push({ role:"assistant", content: reply });
    appendChat("assistant", reply);
  }catch(err){
    appendChat("assistant", "ï¼ˆç½‘ç»œæˆ–ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ï¼‰");
  }
}

/* ==============================
   Header scroll effect
============================== */
function setupHeaderScroll(){
  const header = document.querySelector('.site-header');
  if(!header) return;
  const onScroll = ()=>{
    if (window.scrollY > 10) header.classList.add('scrolled');
    else header.classList.remove('scrolled');
  };
  window.addEventListener('scroll', onScroll, { passive:true });
  onScroll();
}

/* ==============================
   Boot
============================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // lang
  const langSelect = $('langSelect');
  const lang = getLang();
  if (langSelect){
    langSelect.value = langSelect.querySelector(`option[value="${lang}"]`) ? lang : DEFAULT_LANG;
    setLang(langSelect.value);
    langSelect.addEventListener('change', ()=>{
      setLang(langSelect.value);
      applyI18n();
      // update dynamic button text for auth reveal
      const btn = $('toggleAuthFields');
      if (btn) btn.textContent = ( ($('authFields')?.style.display !== 'none') ? t('btn_hide_login_fields') : t('btn_show_login_fields') );
    });
  }
  applyI18n();

  // type/culture changes
  $('type')?.addEventListener('change', (e)=>togglePartner(e.target.value));
  $('culture')?.addEventListener('change', (e)=>updatePurposeOptions(e.target.value));

  // initial
  togglePartner($('type')?.value || 'personal');
  updatePurposeOptions($('culture')?.value || 'auto');

  // generate
  $('btnNext')?.addEventListener('click', generateReport);

  // time unknown wiring
  wireTimeUnknown('birthtime1','timeUnknown');
  wireTimeUnknown('birthtime2','timeUnknown2');

  // auth hide/reveal
  setupAuthReveal();

  // chat
  $('ssChatFab')?.addEventListener('click', ()=>toggleChat(true));
  $('chatClose')?.addEventListener('click', ()=>toggleChat(false));
  $('chatSend')?.addEventListener('click', sendChat);
  $('chatInput')?.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') sendChat();
  });

  // header scroll
  setupHeaderScroll();
});
</script>
</body>
</html>
