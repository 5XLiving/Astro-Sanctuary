<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">命理心怜空间 · VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13 url('') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand-badge{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#0e1520,#0b1018);border:1px solid #2a3546;box-shadow:0 4px 14px rgba(0,0,0,.35);font-weight:800;color:var(--gold)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif!important;font-weight:600!important;letter-spacing:.02em;font-size:1.1rem!important;line-height:1.25}
  .title a{color:inherit;text-decoration:none}
  .title a:hover{text-decoration:underline;text-underline-offset:3px}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid (fix row-2/row-3 & cols-2/cols-3) ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  /* nicer selects with arrow */
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== List blocks (portal) ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Buttons (unified) ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:normal;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold);margin:12px 0 6px;font-size:1.05rem;font-weight:800}

  /* ===== Chat widget ===== */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-close{cursor:pointer;opacity:.8}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}
  .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto!important;white-space:nowrap;padding:10px 14px}

  /* skeleton */
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}

  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}

  /* 锁提示（保留外观） */
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">命理心怜空间 · VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- 顶部：命理分析表单 -->
    <section class="card section">
      <h2 data-i18n="form_title">命理分析 · 生成报告</h2>

      <div class="group-title" data-i18n="choose_type">选择命盘类型</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">个人命盘</option>
          <option value="compatibility" data-i18n="type_compat">合盘（两人资料）</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">自动识别 Auto Detect</option>
          <option value="东方" data-i18n="culture_cn">东方 Chinese / Bazi</option>
          <option value="西方" data-i18n="culture_west">西方 Astrology / Tarot</option>
          <option value="日式" data-i18n="culture_jp">日式九星 Japanese</option>
          <option value="吠陀" data-i18n="culture_vedic">印度吠陀 Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">本人资料</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="姓名（本人）" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="出生时间" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
          <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="出生国家 / 地区" required data-i18n-ph="ph_country1">
        <!-- 给按钮一个 id，便于绑定 -->
        <button id="btnNext" class="btn" data-i18n="btn_next">下一步</button>
      </div>

      <!-- 隐形表单用于提交（保留，不用） -->
      <form id="reportForm" action="/secure/report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">第二人资料（合盘）</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="姓名（第二人）" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="出生时间" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
            <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="出生国家 / 地区" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">命理选题（报告聚焦）</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="姻缘 Love" data-i18n="opt_love"></optgroup>
          <option value="恋爱缘分" data-i18n="opt_dating">恋爱缘分</option>
          <option value="婚姻走势" data-i18n="opt_marriage">婚姻走势</option>

          <optgroup label="事业 Career" data-i18n="opt_career"></optgroup>
          <option value="职场发展" data-i18n="opt_work">职场发展</option>
          <option value="创业潜力" data-i18n="opt_startup">创业潜力</option>

          <optgroup label="财运 Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="财位分析" data-i18n="opt_wealthpos">财位分析</option>
          <option value="理财时机" data-i18n="opt_timing">理财时机</option>

          <optgroup label="择日 Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="婚期择日" data-i18n="opt_wedding">婚期择日</option>
          <option value="新生宝宝择日" data-i18n="opt_babydate">新生宝宝择日</option>
          <option value="新家入住择日" data-i18n="opt_house">新家入住择日</option>
          <option value="新公司入住择日" data-i18n="opt_office">新公司入住择日</option>

          <optgroup label="测名 Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="宝宝名" data-i18n="opt_babyname">宝宝名</option>
          <option value="宠物名" data-i18n="opt_petname">宠物名</option>
          <option value="公司名" data-i18n="opt_companyname">公司名</option>
          <option value="命名改运" data-i18n="opt_rename">命名改运</option>

          <optgroup label="风水 Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="住家" data-i18n="opt_home">住家</option>
          <option value="办公室" data-i18n="opt_officefs">办公室</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="合盘分析 Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="缘分起落" data-i18n="opt_couple">情侣合盘（缘分起落 / 暧昧进展）</option>
          <option value="夫妻流年" data-i18n="opt_spouse">夫妻流年（婚姻发展）</option>
          <option value="合盘分析" data-i18n="opt_personality">个性合盘（冲突 / 互补）</option>
          <option value="事业共事" data-i18n="opt_partner">事业合盘（合伙人 / 员工）</option>
          <option value="断联修复" data-i18n="opt_reconnect">断联修复（朋友 / 情人 / 家人）</option>
          <option value="宠物缘分" data-i18n="opt_petbond">宠物合盘（主人与宠物）</option>
        </select>
      </div>
    </section>

    <!-- ===== 新增：报告预览卡片（渲染结果放这里） ===== -->
    <section id="reportCard" class="card section" style="display:none">
      <h2 data-i18n="report_title">报告预览</h2>
      <div class="report">
        <div class="sec">
          <h3 data-i18n="sec_scholar">系统分析报告（专业版）</h3>
          <div id="sysBox" class="ai-content"></div>
          <div class="btns" style="margin-top:6px">
            <button id="btnRegenScholar" class="btn ghost sm">↻ 重生成</button>
            <button id="btnCopyScholar" class="btn ghost sm">复制</button>
          </div>
        </div>
        <div class="sec">
          <h3 data-i18n="sec_butler">心怜管家建议</h3>
          <div id="butlerBox" class="ai-content"></div>
          <div class="btns" style="margin-top:6px">
            <button id="btnRegenButler" class="btn ghost sm">↻ 重生成</button>
            <button id="btnCopyButler" class="btn ghost sm">复制</button>
            <button id="btnDownloadMd2" class="btn ghost sm">下载 Markdown</button>
            <button id="btnPrint2" class="btn ghost sm">打印/存 PDF</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 下段：各功能入口 -->
    <section class="card section">
      <h2 data-i18n="portal_title">心怜空间 · 功能入口</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">🧘‍♀️ 灵性日记</div>
        <ul><li data-i18n="diary_desc">照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">个人隐藏记录</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">家庭共享记录</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">上传记录</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">📘 命理课程专区</div>
        <ul>
          <li data-i18n="course_bazi">八字命理：十神 / 流年 / 用神分析</li>
          <li data-i18n="course_tarot">塔罗牌：牌阵解读 / 情境实战</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">进入课程</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">🛍️ 能量商城 · VIP折扣 & 御守订制</div>
        <ul><li data-i18n="shop_desc">专属祈愿包分类：</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="阴债和解包.html">阴债和解包</a>
          <a class="btn link-btn" href="财库包.html">财库包</a>
          <a class="btn link-btn" href="灵魂开悟的指引包.html">心灵包</a>
          <a class="btn link-btn" href="财运包.html">财运包</a>
          <a class="btn link-btn" href="姻缘包.html">姻缘包</a>
          <a class="btn link-btn" href="学业包.html">学业包</a>
          <a class="btn link-btn" href="事业包.html">事业包</a>
          <a class="btn link-btn" href="御守包.html">御守包</a>
          <a class="btn link-btn" href="太岁包.html">太岁包</a>
          <a class="btn link-btn" href="七月包.html">七月包</a>
          <a class="btn link-btn" href="家族福报包.html">家族福报包</a>
          <a class="btn link-btn" href="情伤疗愈包.html">情伤疗愈包</a>
          <a class="btn link-btn" href="劫难包.html">劫难包</a>
          <a class="btn link-btn" href="新宅办公室包.html">新宅 / 办公室包</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">🔮 梦想提交 Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">梦想规划 / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">📖 灵性空间 ~ 往生记怜录</div>
        <ul><li data-i18n="memorial_desc">灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">登入灵性空间</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">上传往生录</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">注册灵性空间</a>
        </div>
      </div>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <script>
    // 切换个人/合盘显示
    function togglePartner(value){
      const section = document.getElementById("partner-section");
      const personal = document.getElementById('purpose_personal');
      const compat = document.getElementById('purpose_compatibility');
      const show = (value === "compatibility");
      section.style.display = show ? "block" : "none";
      personal.style.display = show ? "none" : "block";
      compat.style.display = show ? "block" : "none";
    }

    // 隐形表单同步（保留）
    const reportForm = document.getElementById('reportForm');
    function syncToHiddenForm(){
      const ids = ["type","culture","name1","birthdate1","birthtime1","calendar1","country1","name2","birthdate2","birthtime2","calendar2","country2"];
      ids.forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        let h = reportForm.querySelector(`[name="${id}"]`);
        if(!h){ h = document.createElement('input'); h.type='hidden'; h.name=id; reportForm.appendChild(h); }
        h.value = el.value || '';
      });
      const purpose = (document.getElementById('type').value === 'compatibility')
        ? document.getElementById('purpose_compatibility').value
        : document.getElementById('purpose_personal').value;
      let p = reportForm.querySelector('[name="purpose"]');
      if(!p){ p = document.createElement('input'); p.type='hidden'; p.name='purpose'; reportForm.appendChild(p); }
      p.value = purpose;
    }

  // ============== 统一配置（你的 Worker 域名） ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers.dev

  // 工具函数
  const $ = id => document.getElementById(id);
  function showErr(msg){ let e=$("error"); if(!e){ e=document.createElement('div'); e.id='error'; e.style.color='#ff8b8b'; e.style.marginTop='6px'; const sec=document.querySelector('.section'); sec && sec.appendChild(e);} e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); if(e){ e.style.display="none"; e.textContent=""; } }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }
  function mdToHtml(md){
    if(!md) return '';
    return md
      .replace(/(^|\n)[#＃]{1,3}\s+(.+?)\s*(?=\n|$)/g, '$1<h3>$2</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'<li>$1</li>')
      .replace(/(?:^|\n)(<li>[\s\S]+?<\/li>)+/g, m => `<ul>${m}</ul>`)
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  const LANG_NAME = {
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese',
    'en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  // （保留你原来的翻译表）
const translations = {
  "zh-CN": {
    page_title:"命理心怜空间 · VIP Soul Sanctuary",
    site_title:"命理心怜空间 · VIP Soul Sanctuary",
    site_subtitle:"与「八字简评」同款风格 · 手机&电脑一致体验",
    lang_label:"语言",
    form_title:"命理分析 · 生成报告",
    choose_type:"选择命盘类型",
    type_personal:"个人命盘", type_compat:"合盘（两人资料）",
    culture_auto:"自动识别 Auto Detect", culture_cn:"东方 Chinese / Bazi",
    culture_west:"西方 Astrology / Tarot", culture_jp:"日式九星 Japanese", culture_vedic:"印度吠陀 Vedic",
    self_info:"本人资料", ph_name1:"姓名（本人）", ph_time1:"出生时间", ph_country1:"出生国家 / 地区",
    cal_g:"阳历 (Gregorian)", cal_l:"农历 (Lunar)",
    btn_next:"下一步",
    partner_info:"第二人资料（合盘）", ph_name2:"姓名（第二人）", ph_time2:"出生时间", ph_country2:"出生国家 / 地区",
    focus_title:"命理选题（报告聚焦）",
    opt_love:"姻缘 Love", opt_dating:"恋爱缘分", opt_marriage:"婚姻走势",
    opt_career:"事业 Career", opt_work:"职场发展", opt_startup:"创业潜力",
    opt_wealth:"财运 Wealth", opt_wealthpos:"财位分析", opt_timing:"理财时机",
    opt_dates:"择日 Auspicious Date", opt_wedding:"婚期择日", opt_babydate:"新生宝宝择日", opt_house:"新家入住择日", opt_office:"新公司入住择日",
    opt_name:"测名 Name Analysis", opt_babyname:"宝宝名", opt_petname:"宠物名", opt_companyname:"公司名", opt_rename:"命名改运",
    opt_fs:"风水 Feng Shui", opt_home:"住家", opt_officefs:"办公室",
    opt_comp:"合盘分析 Compatibility", opt_couple:"情侣合盘（缘分起落 / 暧昧进展）",
    opt_spouse:"夫妻流年（婚姻发展）", opt_personality:"个性合盘（冲突 / 互补）",
    opt_partner:"事业合盘（合伙人 / 员工）", opt_reconnect:"断联修复（朋友 / 情人 / 家人）", opt_petbond:"宠物合盘（主人与宠物）",

    vip_overview:"VIP 内容总览",
    vip_mingli:"🗝 命理空间专属内容",
    list_love:"姻缘方向：恋爱缘分、婚姻走势",
    list_career:"事业方向：职场发展、创业潜力",
    list_wealth:"财运方向：财位分析、理财时机",
    list_pet:"宠物命理：伴侣动物的性格与缘分",
    list_hepan:"合盘分析：婚期择日、新生择时",
    list_name:"测名分析：公司名、宝宝名、命名改运",
    list_fs:"财位合盘：住家 / 办公室动线配合",
    vip_xinlian:"🌙 心怜空间专属内容",
    list_record:"灵性记录：照片、梦境、声音、愿望祈祷",
    list_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    list_memorial:"家族纪念系统：亲人灵性纪念 & 延续",
    list_tasks:"每周能量练习 / 神明仪式任务",
    list_shop:"能量商城专属折扣 & 御守订制",
    btn_upgrade:"💎 升级为 VIP（月费）",
    btn_back:"← 返回命理商城",
    vip_note:"$9.9 / 月费（命理空间 + 心怜空间 + 灵性课程）· 注册账号赠送一次免费体验",

    portal_title:"心怜空间 · 功能入口",
    diary_title:"🧘‍♀️ 灵性日记", diary_desc:"照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）",
    btn_personal:"个人隐藏记录", btn_family:"家庭共享记录", btn_upload:"上传记录",
    course_title:"📘 命理课程专区", course_bazi:"八字命理：十神 / 流年 / 用神分析", course_tarot:"塔罗牌：牌阵解读 / 情境实战",
    course_coming:"🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……",
    btn_enter_course:"进入课程",
    shop_title:"🛍️ 能量商城 · VIP折扣 & 御守订制", shop_desc:"专属祈愿包分类：",
    wish_title:"🔮 梦想提交 Dream Submission", btn_manifest:"梦想规划 / Manifestation",
    memorial_title:"📖 灵性空间 ~ 往生记怜录", memorial_desc:"灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）",
    btn_login_memorial:"登入灵性空间", btn_upload_memorial:"上传往生录", btn_register_memorial:"注册灵性空间",

    login_title:"💎 登入 VIP 功能",
    ph_email:"邮箱 Email",
    ph_password:"密码 Password（至少8位，含大小写数字符号）",
    btn_login:"登入账户",
    btn_register:"注册账户",
    btn_reset:"🔑 重设密码",
    btn_backshop:"← 返回命理商城",
    note_price:"注册账号赠送一次免费体验",
    note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",

    err_expired:"会员已过期",
    err_no_account:"没有这个账号，请先注册",
    err_wrong_pwd:"密码不正确",
    err_login_fail:"登录失败，请稍后再试。",
    err_register_fail:"注册失败，请稍后再试。",
    err_need_ep:"请填写邮箱和密码",
    err_pwd_rule:"密码至少 8 位，需包含大小写字母、数字和符号",
    prompt_email:"请输入注册邮箱",
    prompt_newpwd:"请输入新密码（至少8位，含大小写数字符号）",
    err_email_empty:"邮箱不能为空",
    err_pwd_empty:"密码不能为空",
    err_reset_fail:"重设失败，请稍后再试。",
    msg_reset_ok:"已重设成功，请用新密码登录",

    chat_fab:"Chat",
    chat_placeholder:"有什么想咨询的？",
    chat_send:"发送",

    /* 新增：报告区 UI */
    report_title:"报告预览",
    sec_scholar:"系统分析报告（专业版）",
    sec_butler:"心怜管家建议",
    copied_ok:"已复制到剪贴板"
  },

  "zh-TW": {
    /* …（原内容保持）… */
  },

  "en": {
    /* …（原内容保持）… */
    report_title:"Report Preview",
    sec_scholar:"System Analysis (Scholarly)",
    sec_butler:"Xinlian Butler Advice",
    copied_ok:"Copied to clipboard"
  },

  "ja": { /* …原文… */ },
  "th": { /* …原文… */ },
  "ms": { /* …原文… */ }
};

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }

  // ============== Chat 浮窗（走 /api/chat） ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

  // ======== 构建报告提示词（学术→管家） ========
  function buildScholarPrompt(params){
    const {langName,type,culture,purpose,name1,birthdate1,birthtime1,calendar1,country1,
           name2,birthdate2,birthtime2,calendar2,country2} = params;

    const whoA = `A：${name1||'（未填）'}；生日：${birthdate1||'未知'}；时刻：${birthtime1||'未知'}；历法：${calendar1||'阳历'}；地点：${country1||'未知'}`;
    const whoB = (type==='compatibility')
      ? `\nB：${name2||'（未填）'}；生日：${birthdate2||'未知'}；时刻：${birthtime2||'未知'}；历法：${calendar2||'阳历'}；地点：${country2||'未知'}`
      : '';

    return `You are "Astro Scholar" at 5XLiving. OUTPUT LANGUAGE: ${langName}.
Tone: rigorous, structured, practical. Avoid medical/legal claims. If data is missing, state assumptions and limitations.

[Chart Type] ${type==='compatibility'?'Synastry (Two persons)':'Personal'}
[Culture Preference] ${culture} (if "Auto", pick the most fitting framework and say why)
[Focus Purpose] ${purpose||'通用'}

[Given Data]
${whoA}${whoB}

Write a MARKDOWN report with this structure (keep titles):
# 摘要（3–5句，给出结论+判据）
# 盘面要点（列4–6条，指明指标与含义）
# 时机节律（未来30/90天：窗口/易耗期，用周次或日期范围表达）
# 风险与注意（3–5条，避免误用）
# 方法与局限（数据缺口/假设/模型边界）
仅写分析，不要写个性化行动建议。`;
  }

  function buildButlerPrompt(langName, scholarMD){
    return `You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Tone: warm, grounded, actionable.
Based on the following "Scholarly Report", produce practical advice without repeating theory.

=== Scholarly Report ===
${scholarMD}
=== END ===

Return Markdown in this structure:
# 核心判断（2–4句，引用报告证据）
# 现在要做的事（3条，动词开头，含频次/时长/阈值）
# 避坑提醒（2–3条，具体到行为）
# 能量练习（2–3条：冥想/呼吸/书写/仪式/节律；写操作要点与频次）
# AI 推举内容（3–5条：如预约 1v1 / 加入 VIP / 课程练习包 / 御守与许愿 / 存入心怜笔记等，写成建议句式）`;
  }

  async function callAI(messages){
    const r = await fetch(`${API_BASE}/api/chat`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages})
    });
    let data={}; try{ data = await r.json(); }catch{}
    return data.reply || data.text || data?.choices?.[0]?.message?.content || '';
  }

  // ======== 渲染报告主流程 ========
  async function generateReport(){
    hideErr();
    const langCode = getLang();
    const langName = LANG_NAME[langCode] || 'Simplified Chinese';

    const type = $('type').value;
    const culture = $('culture').value;
    const name1 = $('name1').value.trim();
    const birthdate1 = $('birthdate1').value;
    const birthtime1 = $('birthtime1').value;
    const calendar1 = $('calendar1').value;
    const country1 = $('country1').value.trim();

    if(!birthdate1){ showErr('请先填写：出生日期'); return; }
    if(type==='compatibility' && !$('birthdate2').value){ showErr('合盘需填写第二人的出生日期'); return; }

    const name2 = $('name2')?.value.trim()||'';
    const birthdate2 = $('birthdate2')?.value||'';
    const birthtime2 = $('birthtime2')?.value||'';
    const calendar2 = $('calendar2')?.value||'阳历';
    const country2 = $('country2')?.value.trim()||'';
    const purpose = (type==='compatibility') ? $('purpose_compatibility').value : $('purpose_personal').value;

    // 同步隐藏表单（保留原逻辑）
    syncToHiddenForm();

    // 显示报告容器 & 骨架
    const card = $('reportCard'); card.style.display='block';
    const sysBox = $('sysBox'); const butlerBox = $('butlerBox');
    sysBox.innerHTML = `<div class="skeleton">
      <div style="width:78%"></div><div style="width:92%"></div><div style="width:86%"></div>
      <div style="width:70%"></div><div style="width:55%"></div>
    </div>`;
    butlerBox.innerHTML = `<div class="skeleton">
      <div style="width:65%"></div><div style="width:82%"></div><div style="width:90%"></div>
      <div style="width:72%"></div><div style="width:48%"></div>
    </div>`;

    // 1) 学术报告
    const scholarPrompt = buildScholarPrompt({langName,type,culture,purpose,name1,birthdate1,birthtime1,calendar1,country1,name2,birthdate2,birthtime2,calendar2,country2});
    const scholarMD = await callAI([
      {role:'system',content:`You are "Astro Scholar" for 5XLiving. OUTPUT LANGUAGE: ${langName}. Be rigorous and clear.`},
      {role:'user',content: scholarPrompt}
    ]);
    $('sysBox').innerHTML = mdToHtml(scholarMD || '（暂时无法生成）');

    // 2) 管家建议
    const butlerMD = await callAI([
      {role:'system',content:`You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Warm, practical, actionable.`},
      {role:'user',content: buildButlerPrompt(langName, scholarMD)}
    ]);
    $('butlerBox').innerHTML = mdToHtml(butlerMD || '（暂时无法生成）');

    // 暴露到全局，便于复制/导出
    window.__scholarMD = scholarMD;
    window.__butlerMD  = butlerMD;

    window.scrollTo({top: card.offsetTop - 10, behavior:'smooth'});
  }

  // ============== Chat 浮窗挂载 ==============
  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">心怜管家 · Chat</div>
        <div class="ss-close" id="ssChatClose">✕</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。');
        addMsg(reply);
      }catch(e){
        addMsg('网络异常，请稍后再试。');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // 语言切换
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }

    // ====== 关键修正：让“下一步”渲染报告 ======
    const nextBtn = $('btnNext');
    if(nextBtn){
      nextBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        generateReport();
      });
    }

    // 如果你之前用“判断按钮文案”的方式，这里覆盖为渲染，不再提交
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button');
      const labelEl = document.querySelector('[data-i18n="btn_next"]');
      if(!b || !labelEl) return;
      if (b.textContent.trim() === labelEl.textContent.trim() && b.id !== 'btnNext'){
        e.preventDefault();
        generateReport();
      }
    });

    // 工具栏事件
    const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(txt); alert(t('copied_ok')); }catch{} };
    $('btnRegenScholar')?.addEventListener('click', generateReport);
    $('btnRegenButler')?.addEventListener('click', async ()=>{
      if(!window.__scholarMD) return generateReport();
      const langName = LANG_NAME[getLang()] || 'Simplified Chinese';
      const md = await callAI([
        {role:'system',content:`You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Warm, practical, actionable.`},
        {role:'user',content: buildButlerPrompt(langName, window.__scholarMD)}
      ]);
      $('butlerBox').innerHTML = mdToHtml(md||''); window.__butlerMD = md;
    });
    $('btnCopyScholar')?.addEventListener('click', ()=> copy(window.__scholarMD||''));
    $('btnCopyButler')?.addEventListener('click', ()=> copy(window.__butlerMD||''));
    $('btnDownloadMd2')?.addEventListener('click', ()=>{
      const blob = new Blob([`# ${t('sec_scholar')}\n\n${window.__scholarMD||''}\n\n---\n\n# ${t('sec_butler')}\n\n${window.__butlerMD||''}\n`], {type:'text/markdown;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Astro_Report_5XLiving.md'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0);
    });
    $('btnPrint2')?.addEventListener('click', ()=> window.print());
  });

  // ============== 登录流程（保留原逻辑，若页面无对应表单则不执行） ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }
  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      const go = confirm(t('err_expired') + "。是否前往续费？");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== 表单事件（加安全存在判断） ========
  const regFormEl = document.getElementById("registerForm");
  if (regFormEl) regFormEl.addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

    lock($("registerBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      }));

      if (res.ok === true){
        localStorage.setItem("vipEmail", email);
        location.href = "vip_trial.html";
        return;
      }

      if ((res.msg||"").toString() === 'exists'){
        await loginFlow(email, password);
        return;
      }

      return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
    } catch(err){
      showErr(t('err_register_fail') + (err?.message || ''));
    } finally{
      lock($("registerBtn"), false);
    }
  });

  const loginFormEl = document.getElementById("loginForm");
  if (loginFormEl) loginFormEl.addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    lock($("loginBtn"), true);
    try{
      await loginFlow(email, password);
    } catch(err){
      showErr(t('err_login_fail') + (err?.message || ''));
    } finally{
      lock($("loginBtn"), false);
    }
  });

  const resetBtnEl = document.getElementById("resetBtn");
  if (resetBtnEl) resetBtnEl.addEventListener("click", async ()=>{
    hideErr();
    let email = prompt(t('prompt_email'));
    if (email === null) return; email = email.trim();
    if (!email) return showErr(t('err_email_empty'));

    let newPassword = prompt(t('prompt_newpwd'));
    if (newPassword === null) return; newPassword = newPassword.trim();
    if (!newPassword) return showErr(t('err_pwd_empty'));
    if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

    lock($("resetBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword })
      }));
      if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
      alert(t('msg_reset_ok'));
    } catch(err){
      showErr(t('err_reset_fail') + (err?.message || ''));
    } finally{
      lock($("resetBtn"), false);
    }
  });
</script>
</body>
</html>
