<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13 url('') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand-badge{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#0e1520,#0b1018);border:1px solid #2a3546;box-shadow:0 4px 14px rgba(0,0,0,.35);font-weight:800;color:var(--gold)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif!important;font-weight:600!important;letter-spacing:.02em;font-size:1.1rem!important;line-height:1.25}
  .title a{color:inherit;text-decoration:none}
  .title a:hover{text-decoration:underline;text-underline-offset:3px}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid (fix row-2/row-3 & cols-2/cols-3) ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  /* nicer selects with arrow */
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== List blocks (portal) ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Buttons (unified) ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:normal;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold);margin:12px 0 6px;font-size:1.05rem;font-weight:800}

  /* ===== Chat widget ===== */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-close{cursor:pointer;opacity:.8}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}
  .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto!important;white-space:nowrap;padding:10px 14px}

  /* skeleton */
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}

  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}

  /* é”æç¤ºï¼ˆä¿ç•™å¤–è§‚ï¼‰ */
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</option>
          <option value="compatibility" data-i18n="type_compat">åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
        <!-- ç»™æŒ‰é’®ä¸€ä¸ª idï¼Œä¾¿äºç»‘å®š -->
        <button id="btnNext" class="btn" data-i18n="btn_next">ä¸‹ä¸€æ­¥</button>
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ï¼ˆä¿ç•™ï¼Œä¸ç”¨ï¼‰ -->
      <form id="reportForm" action="/secure/report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="å‘½åæ”¹è¿" data-i18n="opt_rename">å‘½åæ”¹è¿</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
        </select>
      </div>
    </section>

    <!-- ===== æ–°å¢ï¼šæŠ¥å‘Šé¢„è§ˆå¡ç‰‡ï¼ˆæ¸²æŸ“ç»“æœæ”¾è¿™é‡Œï¼‰ ===== -->
    <section id="reportCard" class="card section" style="display:none">
      <h2 data-i18n="report_title">æŠ¥å‘Šé¢„è§ˆ</h2>
      <div class="report">
        <div class="sec">
          <h3 data-i18n="sec_scholar">ç³»ç»Ÿåˆ†ææŠ¥å‘Šï¼ˆä¸“ä¸šç‰ˆï¼‰</h3>
          <div id="sysBox" class="ai-content"></div>
          <div class="btns" style="margin-top:6px">
            <button id="btnRegenScholar" class="btn ghost sm">â†» é‡ç”Ÿæˆ</button>
            <button id="btnCopyScholar" class="btn ghost sm">å¤åˆ¶</button>
          </div>
        </div>
        <div class="sec">
          <h3 data-i18n="sec_butler">å¿ƒæ€œç®¡å®¶å»ºè®®</h3>
          <div id="butlerBox" class="ai-content"></div>
          <div class="btns" style="margin-top:6px">
            <button id="btnRegenButler" class="btn ghost sm">â†» é‡ç”Ÿæˆ</button>
            <button id="btnCopyButler" class="btn ghost sm">å¤åˆ¶</button>
            <button id="btnDownloadMd2" class="btn ghost sm">ä¸‹è½½ Markdown</button>
            <button id="btnPrint2" class="btn ghost sm">æ‰“å°/å­˜ PDF</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ä¸‹æ®µï¼šå„åŠŸèƒ½å…¥å£ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>
  </main>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
  </main>

  <script>
    // åˆ‡æ¢ä¸ªäºº/åˆç›˜æ˜¾ç¤º
    function togglePartner(value){
      const section = document.getElementById("partner-section");
      const personal = document.getElementById('purpose_personal');
      const compat = document.getElementById('purpose_compatibility');
      const show = (value === "compatibility");
      section.style.display = show ? "block" : "none";
      personal.style.display = show ? "none" : "block";
      compat.style.display = show ? "block" : "none";
    }

    // éšå½¢è¡¨å•åŒæ­¥ï¼ˆä¿ç•™ï¼‰
    const reportForm = document.getElementById('reportForm');
    function syncToHiddenForm(){
      const ids = ["type","culture","name1","birthdate1","birthtime1","calendar1","country1","name2","birthdate2","birthtime2","calendar2","country2"];
      ids.forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        let h = reportForm.querySelector(`[name="${id}"]`);
        if(!h){ h = document.createElement('input'); h.type='hidden'; h.name=id; reportForm.appendChild(h); }
        h.value = el.value || '';
      });
      const purpose = (document.getElementById('type').value === 'compatibility')
        ? document.getElementById('purpose_compatibility').value
        : document.getElementById('purpose_personal').value;
      let p = reportForm.querySelector('[name="purpose"]');
      if(!p){ p = document.createElement('input'); p.type='hidden'; p.name='purpose'; reportForm.appendChild(p); }
      p.value = purpose;
    }

  // ============== ç»Ÿä¸€é…ç½®ï¼ˆä½ çš„ Worker åŸŸåï¼‰ ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // â† æ”¹æˆä½ çš„ Workers.dev

  // å·¥å…·å‡½æ•°
  const $ = id => document.getElementById(id);
  function showErr(msg){ let e=$("error"); if(!e){ e=document.createElement('div'); e.id='error'; e.style.color='#ff8b8b'; e.style.marginTop='6px'; const sec=document.querySelector('.section'); sec && sec.appendChild(e);} e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); if(e){ e.style.display="none"; e.textContent=""; } }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }
  function mdToHtml(md){
    if(!md) return '';
    return md
      .replace(/(^|\n)[#ï¼ƒ]{1,3}\s+(.+?)\s*(?=\n|$)/g, '$1<h3>$2</h3>')
      .replace(/^\s*[-*]\s+(.*)$/gm,'<li>$1</li>')
      .replace(/(?:^|\n)(<li>[\s\S]+?<\/li>)+/g, m => `<ul>${m}</ul>`)
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\n{2,}/g,'\n\n')
      .replace(/\n/g,'<br/>');
  }
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  const LANG_NAME = {
    'zh-CN':'Simplified Chinese',
    'zh-TW':'Traditional Chinese',
    'en':'English','ja':'Japanese','th':'Thai','ms':'Malay'
  };

  // ï¼ˆä¿ç•™ä½ åŸæ¥çš„ç¿»è¯‘è¡¨ï¼‰
const translations = {
  "zh-CN": {
    page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    site_subtitle:"ä¸ã€Œå…«å­—ç®€è¯„ã€åŒæ¬¾é£æ ¼ Â· æ‰‹æœº&ç”µè„‘ä¸€è‡´ä½“éªŒ",
    lang_label:"è¯­è¨€",
    form_title:"å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š",
    choose_type:"é€‰æ‹©å‘½ç›˜ç±»å‹",
    type_personal:"ä¸ªäººå‘½ç›˜", type_compat:"åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰",
    culture_auto:"è‡ªåŠ¨è¯†åˆ« Auto Detect", culture_cn:"ä¸œæ–¹ Chinese / Bazi",
    culture_west:"è¥¿æ–¹ Astrology / Tarot", culture_jp:"æ—¥å¼ä¹æ˜Ÿ Japanese", culture_vedic:"å°åº¦å é™€ Vedic",
    self_info:"æœ¬äººèµ„æ–™", ph_name1:"å§“åï¼ˆæœ¬äººï¼‰", ph_time1:"å‡ºç”Ÿæ—¶é—´", ph_country1:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    cal_g:"é˜³å† (Gregorian)", cal_l:"å†œå† (Lunar)",
    btn_next:"ä¸‹ä¸€æ­¥",
    partner_info:"ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰", ph_name2:"å§“åï¼ˆç¬¬äºŒäººï¼‰", ph_time2:"å‡ºç”Ÿæ—¶é—´", ph_country2:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    focus_title:"å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰",
    opt_love:"å§»ç¼˜ Love", opt_dating:"æ‹çˆ±ç¼˜åˆ†", opt_marriage:"å©šå§»èµ°åŠ¿",
    opt_career:"äº‹ä¸š Career", opt_work:"èŒåœºå‘å±•", opt_startup:"åˆ›ä¸šæ½œåŠ›",
    opt_wealth:"è´¢è¿ Wealth", opt_wealthpos:"è´¢ä½åˆ†æ", opt_timing:"ç†è´¢æ—¶æœº",
    opt_dates:"æ‹©æ—¥ Auspicious Date", opt_wedding:"å©šæœŸæ‹©æ—¥", opt_babydate:"æ–°ç”Ÿå®å®æ‹©æ—¥", opt_house:"æ–°å®¶å…¥ä½æ‹©æ—¥", opt_office:"æ–°å…¬å¸å…¥ä½æ‹©æ—¥",
    opt_name:"æµ‹å Name Analysis", opt_babyname:"å®å®å", opt_petname:"å® ç‰©å", opt_companyname:"å…¬å¸å", opt_rename:"å‘½åæ”¹è¿",
    opt_fs:"é£æ°´ Feng Shui", opt_home:"ä½å®¶", opt_officefs:"åŠå…¬å®¤",
    opt_comp:"åˆç›˜åˆ†æ Compatibility", opt_couple:"æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰",
    opt_spouse:"å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰", opt_personality:"ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰",
    opt_partner:"äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰", opt_reconnect:"æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰", opt_petbond:"å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰",

    vip_overview:"VIP å†…å®¹æ€»è§ˆ",
    vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
    list_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
    list_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
    list_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
    list_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
    list_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    list_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
    list_fs:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
    vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
    list_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    list_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
    list_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
    list_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
    list_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
    btn_back:"â† è¿”å›å‘½ç†å•†åŸ",
    vip_note:"$9.9 / æœˆè´¹ï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰Â· æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",

    portal_title:"å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£",
    diary_title:"ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°", diary_desc:"ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰",
    btn_personal:"ä¸ªäººéšè—è®°å½•", btn_family:"å®¶åº­å…±äº«è®°å½•", btn_upload:"ä¸Šä¼ è®°å½•",
    course_title:"ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº", course_bazi:"å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ", course_tarot:"å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜",
    course_coming:"ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦",
    btn_enter_course:"è¿›å…¥è¯¾ç¨‹",
    shop_title:"ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶", shop_desc:"ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š",
    wish_title:"ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission", btn_manifest:"æ¢¦æƒ³è§„åˆ’ / Manifestation",
    memorial_title:"ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•", memorial_desc:"çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰",
    btn_login_memorial:"ç™»å…¥çµæ€§ç©ºé—´", btn_upload_memorial:"ä¸Šä¼ å¾€ç”Ÿå½•", btn_register_memorial:"æ³¨å†Œçµæ€§ç©ºé—´",

    login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
    ph_email:"é‚®ç®± Email",
    ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    btn_login:"ç™»å…¥è´¦æˆ·",
    btn_register:"æ³¨å†Œè´¦æˆ·",
    btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
    btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
    note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
    note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",

    err_expired:"ä¼šå‘˜å·²è¿‡æœŸ",
    err_no_account:"æ²¡æœ‰è¿™ä¸ªè´¦å·ï¼Œè¯·å…ˆæ³¨å†Œ",
    err_wrong_pwd:"å¯†ç ä¸æ­£ç¡®",
    err_login_fail:"ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚",
    err_register_fail:"æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚",
    err_need_ep:"è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ",
    err_pwd_rule:"å¯†ç è‡³å°‘ 8 ä½ï¼Œéœ€åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç¬¦å·",
    prompt_email:"è¯·è¾“å…¥æ³¨å†Œé‚®ç®±",
    prompt_newpwd:"è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    err_email_empty:"é‚®ç®±ä¸èƒ½ä¸ºç©º",
    err_pwd_empty:"å¯†ç ä¸èƒ½ä¸ºç©º",
    err_reset_fail:"é‡è®¾å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚",
    msg_reset_ok:"å·²é‡è®¾æˆåŠŸï¼Œè¯·ç”¨æ–°å¯†ç ç™»å½•",

    chat_fab:"Chat",
    chat_placeholder:"æœ‰ä»€ä¹ˆæƒ³å’¨è¯¢çš„ï¼Ÿ",
    chat_send:"å‘é€",

    /* æ–°å¢ï¼šæŠ¥å‘ŠåŒº UI */
    report_title:"æŠ¥å‘Šé¢„è§ˆ",
    sec_scholar:"ç³»ç»Ÿåˆ†ææŠ¥å‘Šï¼ˆä¸“ä¸šç‰ˆï¼‰",
    sec_butler:"å¿ƒæ€œç®¡å®¶å»ºè®®",
    copied_ok:"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
  },

  "zh-TW": {
    /* â€¦ï¼ˆåŸå†…å®¹ä¿æŒï¼‰â€¦ */
  },

  "en": {
    /* â€¦ï¼ˆåŸå†…å®¹ä¿æŒï¼‰â€¦ */
    report_title:"Report Preview",
    sec_scholar:"System Analysis (Scholarly)",
    sec_butler:"Xinlian Butler Advice",
    copied_ok:"Copied to clipboard"
  },

  "ja": { /* â€¦åŸæ–‡â€¦ */ },
  "th": { /* â€¦åŸæ–‡â€¦ */ },
  "ms": { /* â€¦åŸæ–‡â€¦ */ }
};

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }

  // ============== Chat æµ®çª—ï¼ˆèµ° /api/chatï¼‰ ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

  // ======== æ„å»ºæŠ¥å‘Šæç¤ºè¯ï¼ˆå­¦æœ¯â†’ç®¡å®¶ï¼‰ ========
  function buildScholarPrompt(params){
    const {langName,type,culture,purpose,name1,birthdate1,birthtime1,calendar1,country1,
           name2,birthdate2,birthtime2,calendar2,country2} = params;

    const whoA = `Aï¼š${name1||'ï¼ˆæœªå¡«ï¼‰'}ï¼›ç”Ÿæ—¥ï¼š${birthdate1||'æœªçŸ¥'}ï¼›æ—¶åˆ»ï¼š${birthtime1||'æœªçŸ¥'}ï¼›å†æ³•ï¼š${calendar1||'é˜³å†'}ï¼›åœ°ç‚¹ï¼š${country1||'æœªçŸ¥'}`;
    const whoB = (type==='compatibility')
      ? `\nBï¼š${name2||'ï¼ˆæœªå¡«ï¼‰'}ï¼›ç”Ÿæ—¥ï¼š${birthdate2||'æœªçŸ¥'}ï¼›æ—¶åˆ»ï¼š${birthtime2||'æœªçŸ¥'}ï¼›å†æ³•ï¼š${calendar2||'é˜³å†'}ï¼›åœ°ç‚¹ï¼š${country2||'æœªçŸ¥'}`
      : '';

    return `You are "Astro Scholar" at 5XLiving. OUTPUT LANGUAGE: ${langName}.
Tone: rigorous, structured, practical. Avoid medical/legal claims. If data is missing, state assumptions and limitations.

[Chart Type] ${type==='compatibility'?'Synastry (Two persons)':'Personal'}
[Culture Preference] ${culture} (if "Auto", pick the most fitting framework and say why)
[Focus Purpose] ${purpose||'é€šç”¨'}

[Given Data]
${whoA}${whoB}

Write a MARKDOWN report with this structure (keep titles):
# æ‘˜è¦ï¼ˆ3â€“5å¥ï¼Œç»™å‡ºç»“è®º+åˆ¤æ®ï¼‰
# ç›˜é¢è¦ç‚¹ï¼ˆåˆ—4â€“6æ¡ï¼ŒæŒ‡æ˜æŒ‡æ ‡ä¸å«ä¹‰ï¼‰
# æ—¶æœºèŠ‚å¾‹ï¼ˆæœªæ¥30/90å¤©ï¼šçª—å£/æ˜“è€—æœŸï¼Œç”¨å‘¨æ¬¡æˆ–æ—¥æœŸèŒƒå›´è¡¨è¾¾ï¼‰
# é£é™©ä¸æ³¨æ„ï¼ˆ3â€“5æ¡ï¼Œé¿å…è¯¯ç”¨ï¼‰
# æ–¹æ³•ä¸å±€é™ï¼ˆæ•°æ®ç¼ºå£/å‡è®¾/æ¨¡å‹è¾¹ç•Œï¼‰
ä»…å†™åˆ†æï¼Œä¸è¦å†™ä¸ªæ€§åŒ–è¡ŒåŠ¨å»ºè®®ã€‚`;
  }

  function buildButlerPrompt(langName, scholarMD){
    return `You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Tone: warm, grounded, actionable.
Based on the following "Scholarly Report", produce practical advice without repeating theory.

=== Scholarly Report ===
${scholarMD}
=== END ===

Return Markdown in this structure:
# æ ¸å¿ƒåˆ¤æ–­ï¼ˆ2â€“4å¥ï¼Œå¼•ç”¨æŠ¥å‘Šè¯æ®ï¼‰
# ç°åœ¨è¦åšçš„äº‹ï¼ˆ3æ¡ï¼ŒåŠ¨è¯å¼€å¤´ï¼Œå«é¢‘æ¬¡/æ—¶é•¿/é˜ˆå€¼ï¼‰
# é¿å‘æé†’ï¼ˆ2â€“3æ¡ï¼Œå…·ä½“åˆ°è¡Œä¸ºï¼‰
# èƒ½é‡ç»ƒä¹ ï¼ˆ2â€“3æ¡ï¼šå†¥æƒ³/å‘¼å¸/ä¹¦å†™/ä»ªå¼/èŠ‚å¾‹ï¼›å†™æ“ä½œè¦ç‚¹ä¸é¢‘æ¬¡ï¼‰
# AI æ¨ä¸¾å†…å®¹ï¼ˆ3â€“5æ¡ï¼šå¦‚é¢„çº¦ 1v1 / åŠ å…¥ VIP / è¯¾ç¨‹ç»ƒä¹ åŒ… / å¾¡å®ˆä¸è®¸æ„¿ / å­˜å…¥å¿ƒæ€œç¬”è®°ç­‰ï¼Œå†™æˆå»ºè®®å¥å¼ï¼‰`;
  }

  async function callAI(messages){
    const r = await fetch(`${API_BASE}/api/chat`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages})
    });
    let data={}; try{ data = await r.json(); }catch{}
    return data.reply || data.text || data?.choices?.[0]?.message?.content || '';
  }

  // ======== æ¸²æŸ“æŠ¥å‘Šä¸»æµç¨‹ ========
  async function generateReport(){
    hideErr();
    const langCode = getLang();
    const langName = LANG_NAME[langCode] || 'Simplified Chinese';

    const type = $('type').value;
    const culture = $('culture').value;
    const name1 = $('name1').value.trim();
    const birthdate1 = $('birthdate1').value;
    const birthtime1 = $('birthtime1').value;
    const calendar1 = $('calendar1').value;
    const country1 = $('country1').value.trim();

    if(!birthdate1){ showErr('è¯·å…ˆå¡«å†™ï¼šå‡ºç”Ÿæ—¥æœŸ'); return; }
    if(type==='compatibility' && !$('birthdate2').value){ showErr('åˆç›˜éœ€å¡«å†™ç¬¬äºŒäººçš„å‡ºç”Ÿæ—¥æœŸ'); return; }

    const name2 = $('name2')?.value.trim()||'';
    const birthdate2 = $('birthdate2')?.value||'';
    const birthtime2 = $('birthtime2')?.value||'';
    const calendar2 = $('calendar2')?.value||'é˜³å†';
    const country2 = $('country2')?.value.trim()||'';
    const purpose = (type==='compatibility') ? $('purpose_compatibility').value : $('purpose_personal').value;

    // åŒæ­¥éšè—è¡¨å•ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
    syncToHiddenForm();

    // æ˜¾ç¤ºæŠ¥å‘Šå®¹å™¨ & éª¨æ¶
    const card = $('reportCard'); card.style.display='block';
    const sysBox = $('sysBox'); const butlerBox = $('butlerBox');
    sysBox.innerHTML = `<div class="skeleton">
      <div style="width:78%"></div><div style="width:92%"></div><div style="width:86%"></div>
      <div style="width:70%"></div><div style="width:55%"></div>
    </div>`;
    butlerBox.innerHTML = `<div class="skeleton">
      <div style="width:65%"></div><div style="width:82%"></div><div style="width:90%"></div>
      <div style="width:72%"></div><div style="width:48%"></div>
    </div>`;

    // 1) å­¦æœ¯æŠ¥å‘Š
    const scholarPrompt = buildScholarPrompt({langName,type,culture,purpose,name1,birthdate1,birthtime1,calendar1,country1,name2,birthdate2,birthtime2,calendar2,country2});
    const scholarMD = await callAI([
      {role:'system',content:`You are "Astro Scholar" for 5XLiving. OUTPUT LANGUAGE: ${langName}. Be rigorous and clear.`},
      {role:'user',content: scholarPrompt}
    ]);
    $('sysBox').innerHTML = mdToHtml(scholarMD || 'ï¼ˆæš‚æ—¶æ— æ³•ç”Ÿæˆï¼‰');

    // 2) ç®¡å®¶å»ºè®®
    const butlerMD = await callAI([
      {role:'system',content:`You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Warm, practical, actionable.`},
      {role:'user',content: buildButlerPrompt(langName, scholarMD)}
    ]);
    $('butlerBox').innerHTML = mdToHtml(butlerMD || 'ï¼ˆæš‚æ—¶æ— æ³•ç”Ÿæˆï¼‰');

    // æš´éœ²åˆ°å…¨å±€ï¼Œä¾¿äºå¤åˆ¶/å¯¼å‡º
    window.__scholarMD = scholarMD;
    window.__butlerMD  = butlerMD;

    window.scrollTo({top: card.offsetTop - 10, behavior:'smooth'});
  }

  // ============== Chat æµ®çª—æŒ‚è½½ ==============
  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = 'å¿ƒæ€œç®¡å®¶';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">å¿ƒæ€œç®¡å®¶ Â· Chat</div>
        <div class="ss-close" id="ssChatClose">âœ•</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ï¼Œè¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        addMsg(reply);
      }catch(e){
        addMsg('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // è¯­è¨€åˆ‡æ¢
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }

    // ====== å…³é”®ä¿®æ­£ï¼šè®©â€œä¸‹ä¸€æ­¥â€æ¸²æŸ“æŠ¥å‘Š ======
    const nextBtn = $('btnNext');
    if(nextBtn){
      nextBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        generateReport();
      });
    }

    // å¦‚æœä½ ä¹‹å‰ç”¨â€œåˆ¤æ–­æŒ‰é’®æ–‡æ¡ˆâ€çš„æ–¹å¼ï¼Œè¿™é‡Œè¦†ç›–ä¸ºæ¸²æŸ“ï¼Œä¸å†æäº¤
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button');
      const labelEl = document.querySelector('[data-i18n="btn_next"]');
      if(!b || !labelEl) return;
      if (b.textContent.trim() === labelEl.textContent.trim() && b.id !== 'btnNext'){
        e.preventDefault();
        generateReport();
      }
    });

    // å·¥å…·æ äº‹ä»¶
    const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(txt); alert(t('copied_ok')); }catch{} };
    $('btnRegenScholar')?.addEventListener('click', generateReport);
    $('btnRegenButler')?.addEventListener('click', async ()=>{
      if(!window.__scholarMD) return generateReport();
      const langName = LANG_NAME[getLang()] || 'Simplified Chinese';
      const md = await callAI([
        {role:'system',content:`You are "Xinlian Butler". OUTPUT LANGUAGE: ${langName}. Warm, practical, actionable.`},
        {role:'user',content: buildButlerPrompt(langName, window.__scholarMD)}
      ]);
      $('butlerBox').innerHTML = mdToHtml(md||''); window.__butlerMD = md;
    });
    $('btnCopyScholar')?.addEventListener('click', ()=> copy(window.__scholarMD||''));
    $('btnCopyButler')?.addEventListener('click', ()=> copy(window.__butlerMD||''));
    $('btnDownloadMd2')?.addEventListener('click', ()=>{
      const blob = new Blob([`# ${t('sec_scholar')}\n\n${window.__scholarMD||''}\n\n---\n\n# ${t('sec_butler')}\n\n${window.__butlerMD||''}\n`], {type:'text/markdown;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Astro_Report_5XLiving.md'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0);
    });
    $('btnPrint2')?.addEventListener('click', ()=> window.print());
  });

  // ============== ç™»å½•æµç¨‹ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œè‹¥é¡µé¢æ— å¯¹åº”è¡¨å•åˆ™ä¸æ‰§è¡Œï¼‰ ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }
  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      const go = confirm(t('err_expired') + "ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== è¡¨å•äº‹ä»¶ï¼ˆåŠ å®‰å…¨å­˜åœ¨åˆ¤æ–­ï¼‰ ========
  const regFormEl = document.getElementById("registerForm");
  if (regFormEl) regFormEl.addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

    lock($("registerBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      }));

      if (res.ok === true){
        localStorage.setItem("vipEmail", email);
        location.href = "vip_trial.html";
        return;
      }

      if ((res.msg||"").toString() === 'exists'){
        await loginFlow(email, password);
        return;
      }

      return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
    } catch(err){
      showErr(t('err_register_fail') + (err?.message || ''));
    } finally{
      lock($("registerBtn"), false);
    }
  });

  const loginFormEl = document.getElementById("loginForm");
  if (loginFormEl) loginFormEl.addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    lock($("loginBtn"), true);
    try{
      await loginFlow(email, password);
    } catch(err){
      showErr(t('err_login_fail') + (err?.message || ''));
    } finally{
      lock($("loginBtn"), false);
    }
  });

  const resetBtnEl = document.getElementById("resetBtn");
  if (resetBtnEl) resetBtnEl.addEventListener("click", async ()=>{
    hideErr();
    let email = prompt(t('prompt_email'));
    if (email === null) return; email = email.trim();
    if (!email) return showErr(t('err_email_empty'));

    let newPassword = prompt(t('prompt_newpwd'));
    if (newPassword === null) return; newPassword = newPassword.trim();
    if (!newPassword) return showErr(t('err_pwd_empty'));
    if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

    lock($("resetBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword })
      }));
      if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
      alert(t('msg_reset_ok'));
    } catch(err){
      showErr(t('err_reset_fail') + (err?.message || ''));
    } finally{
      lock($("resetBtn"), false);
    }
  });
</script>
</body>
</html>
