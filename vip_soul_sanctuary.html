

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13 url('') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand-badge{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#0e1520,#0b1018);border:1px solid #2a3546;box-shadow:0 4px 14px rgba(0,0,0,.35);font-weight:800;color:var(--gold)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif!important;font-weight:600!important;letter-spacing:.02em;font-size:1.1rem!important;line-height:1.25}
  .title a{color:inherit;text-decoration:none}
  .title a:hover{text-decoration:underline;text-underline-offset:3px}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid (fix row-2/row-3 & cols-2/cols-3) ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  /* nicer selects with arrow */
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== List blocks (portal) ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Buttons (unified) ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:pre-wrap;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold)}

  /* ===== Chat widget ===== */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-close{cursor:pointer;opacity:.8}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}
  .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto!important;white-space:nowrap;padding:10px 14px}

  /* ===== Misc ===== */
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</option>
          <option value="compatibility" data-i18n="type_compat">åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
        <button class="btn" id="btnNext" type="button" data-i18n="btn_next">ç”Ÿæˆåˆ†æ</button>
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ -->
      <form id="reportForm" action="report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="å‘½åæ”¹è¿" data-i18n="opt_rename">å‘½åæ”¹è¿</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
        </select>
      </div>
    </section>

    <!-- ä¸‹æ®µï¼šå„åŠŸèƒ½å…¥å£ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>
  </main>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>

<script>
'use strict';

/* ==============================
   CONFIG
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // keep ONE definition only

/* ==============================
   UTILITIES
============================== */
const $ = id => document.getElementById(id);

function ensureErrorBox(){
  let box = $('error');
  if (!box){
    box = document.createElement('div');
    box.id = 'error';
    box.className = 'error';
    box.style.cssText = 'margin-top:10px;color:#ff8b8b';
    (document.querySelector('.section') || document.body).appendChild(box);
  }
  return box;
}
function showErr(msg){ const e = ensureErrorBox(); e.textContent = msg; e.style.display = 'block'; setTimeout(()=>{ e.style.display='none'; }, 5000); }
function hideErr(){ const e = $('error'); if (e){ e.style.display='none'; e.textContent=''; } }
function lock(el, v){ if (el) el.disabled = !!v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, txt){ const el=$(id); if(el) el.textContent = (txt ?? ''); }
function setBar(el, pct){ if(!el) return; const v=Math.max(0,Math.min(100,Number(pct)||0)); el.style.width = v+'%'; el.setAttribute('aria-valuenow', String(Math.round(v))); }
function ELABEL(){
  const L = getLang();
  const map = {
    "zh-CN": { wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´' },
    "zh-TW": { wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´' },
    "ja":    { wood:'æœ¨', fire:'ç«', earth:'åœŸ', metal:'é‡‘', water:'æ°´' },
    "th":    { wood:'à¹„à¸¡à¹‰', fire:'à¹„à¸Ÿ', earth:'à¸”à¸´à¸™', metal:'à¹‚à¸¥à¸«à¸°', water:'à¸™à¹‰à¸³' },
    "ms":    { wood:'Kayu', fire:'Api', earth:'Tanah', metal:'Logam', water:'Air' },
    "en":    { wood:'Wood', fire:'Fire', earth:'Earth', metal:'Metal', water:'Water' }
  };
  return map[L] || map['en'];
}

/* ==============================
   I18N
============================== */
const LANG_KEY = "site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

const translations = { /* â€”â€”â€” your big translations object unchanged â€”â€”â€” */ 
  /* (KEEP EXACTLY WHAT YOU PASTED â€” omitted here for brevity in this snippet) */
};

function t(key){
  const L = translations[getLang()] || translations["zh-CN"];
  return L[key] || translations["zh-CN"][key] || key;
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

/* ==============================
   CHAT WIDGET (optional, safe defaults)
============================== */
function applyChatI18n(){
  const fab = $('ssChatFab'); const inp = $('ssChatInput'); const btn = $('ssChatSend');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
}

/* ==============================
   AUTH HELPERS
============================== */
async function safeJson(resp){ try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; } }

async function loginFlow(email, password){
  const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password })
  }));
  const msg = (res.msg || "").toString().toLowerCase();

  // expired?
  let expired = false;
  if (res.expired === true) expired = true;
  else if (msg === 'expired') expired = true;
  else if (res.expiresAt) {
    const ts = Date.parse(res.expiresAt);
    if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
  }
  if (expired){
    const go = confirm(t('err_expired') + "ã€‚æ˜¯å¦å‰å¾€ç»­è´¹ï¼Ÿ");
    if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
    return;
  }

  if (res.ok === true){
    localStorage.setItem("vipEmail", res.email || email);
    location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
    return;
  }

  if (msg === 'no_account') return showErr(t('err_no_account'));
  if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
  showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
}

/* ==============================
   FORM & TOGGLE
============================== */
function togglePartner(value){
  const section  = $('partner-section');
  const personal = $('purpose_personal');
  const compat   = $('purpose_compatibility');
  const show = (value === "compatibility");

  if (section) section.style.display = show ? "block" : "none";
  if (personal){ personal.style.display = show ? "none" : "block"; personal.disabled = show; }
  if (compat){   compat.style.display   = show ? "block": "none";  compat.disabled   = !show; }
}

/* =========================================
   RESULT HOST (inline render target)
========================================= */
function ensureResultHost(){
  let result = document.getElementById('result');
  if (!result){
    result = document.createElement('section');
    result.id = 'result';
    result.className = 'card section';
    const main = document.querySelector('main') || document.body;
    main.appendChild(result);
  }
  if (!document.getElementById('xl-free-report')){
    const free = document.createElement('div');
    free.id = 'xl-free-report';
    free.innerHTML = `
      <div class="card" style="margin-top:8px">
        <div class="h2">å‘½ç†ç®€æŠ¥</div>
        <div id="bazi-date" class="sub" style="margin-bottom:8px"></div>
        <div id="bazi-pillars" class="row cols-4" style="gap:10px"></div>
        <div class="row cols-5" style="align-items:center;margin-top:10px">
          <div><div>æœ¨</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-æœ¨" style="height:8px;width:0%"></div></div><div id="pct-æœ¨" class="muted" style="margin-top:4px"></div></div>
          <div><div>ç«</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-ç«" style="height:8px;width:0%"></div></div><div id="pct-ç«" class="muted" style="margin-top:4px"></div></div>
          <div><div>åœŸ</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-åœŸ" style="height:8px;width:0%"></div></div><div id="pct-åœŸ" class="muted" style="margin-top:4px"></div></div>
          <div><div>é‡‘</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-é‡‘" style="height:8px;width:0%"></div></div><div id="pct-é‡‘" class="muted" style="margin-top:4px"></div></div>
          <div><div>æ°´</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-æ°´" style="height:8px;width:0%"></div></div><div id="pct-æ°´" class="muted" style="margin-top:4px"></div></div>
        </div>
        <div id="bazi-elements-balance" class="sub" style="margin-top:8px"></div>
      </div>
    `;
    result.appendChild(free);
  }
  if (!document.getElementById('rich-report')){
    const rich = document.createElement('div');
    rich.id = 'rich-report';
    result.appendChild(rich);
  }
  if (!document.getElementById('butler-host')){
    const b = document.createElement('div');
    b.id = 'butler-host';
    result.appendChild(b);
  }
  return result;
}

/* ================== è§„åˆ™/æ¸²æŸ“ ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['å¹´æŸ±',p.year],['æœˆæŸ±',p.month],['æ—¥æŸ±',p.day],['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='æ—¶æŸ±'&&timeUnknown); const stem=u?'ï¼Ÿ':v.stem,branch=u?'ï¼Ÿ':v.branch;
    const div=document.createElement('div'); 
    div.className='pillar'; 
    div.style.cssText='border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;background:#0e1520';
    div.innerHTML=`<div class="tit" style="color:var(--gold);font-weight:700;margin-bottom:4px">${tit}</div><div class="gz" style="font-size:1.25rem">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}
function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  setText('year-stem',p.year.stem); setText('year-branch',p.year.branch);
  setText('month-stem',p.month.stem); setText('month-branch',p.month.branch);
  setText('day-stem',p.day.stem); setText('day-branch',p.day.branch);
  setText('hour-stem',timeUnknown?'ï¼Ÿ':p.hour.stem); setText('hour-branch',timeUnknown?'ï¼Ÿ':p.hour.branch);
  const setIf=(id,val)=>{const el=$(id); if(el) el.textContent=val; };
  setIf('year-element',ge(p.year.stem,p.year.branch)); setIf('month-element',ge(p.month.stem,p.month.branch));
  setIf('day-element',ge(p.day.stem,p.day.branch)); setIf('hour-element',timeUnknown?'æœªçŸ¥':ge(p.hour.stem,p.hour.branch));
  setIf('year-nayin',ny(p.year.stem,p.year.branch)); setIf('month-nayin',ny(p.month.stem,p.month.branch));
  setIf('day-nayin',ny(p.day.stem,p.day.branch)); setIf('hour-nayin',timeUnknown?'æœªçŸ¥':ny(p.hour.stem,p.hour.branch));
}
function judgeStrength(dayGan,monthZhi,cnt){
  const STEM_ELEM={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
  const SEASON_BY_MONTH_BRANCH={å¯…:'æ˜¥',å¯:'æ˜¥',è¾°:'æ˜¥',å·³:'å¤',åˆ:'å¤',æœª:'å¤',ç”³:'ç§‹',é…‰:'ç§‹',æˆŒ:'ç§‹',äº¥:'å†¬',å­:'å†¬',ä¸‘:'å†¬'};
  const dmEl=STEM_ELEM[dayGan], season=SEASON_BY_MONTH_BRANCH[monthZhi]||'-';
  let score=0;
  if((season==='æ˜¥'&&'æœ¨ç«'.includes(dmEl))||(season==='å¤'&&'ç«åœŸ'.includes(dmEl))||(season==='ç§‹'&&dmEl==='é‡‘')||(season==='å†¬'&&dmEl==='æ°´')) score+=2;
  score+=(cnt[dmEl]||0)*1.2;
  const mark=score>=3?'åå¼º':(score<=1?'åå¼±':'å¹³è¡¡');
  const focus=mark==='åå¼º'?'æ³„ç§€/åˆ¶åŒ–':(mark==='åå¼±'?'è¡¥åŠ©/é¡ºåŠ¿':'å®ˆä¸­/è°ƒå’Œ'); return{season,mark,focus};
}
function chooseUseful(strength,dmElem){
  if(strength==='åå¼º') return {strategy:'æ³„ç§€/åˆ¶åŒ–', useful:({æœ¨:['ç«','åœŸ','é‡‘'],ç«:['åœŸ','é‡‘','æ°´'],åœŸ:['é‡‘','æ°´','æœ¨'],é‡‘:['æ°´','æœ¨','ç«'],æ°´:['æœ¨','ç«','åœŸ']})[dmElem], avoid:[dmElem]};
  if(strength==='åå¼±') return {strategy:'ç”Ÿæ‰¶/è¡¥åŠ©', useful:({æœ¨:['æœ¨','æ°´'],ç«:['ç«','æœ¨'],åœŸ:['åœŸ','ç«'],é‡‘:['é‡‘','åœŸ'],æ°´:['æ°´','é‡‘']})[dmElem], avoid:[]};
  return {strategy:'è°ƒå’Œ', useful:['æœ¨','ç«','åœŸ','é‡‘','æ°´'], avoid:[]};
}

/* â€”â€”ï¼ˆå¯é€‰ï¼‰æ—§ç®¡å®¶é¢æ¿å®šä½ï¼šè‹¥æ—  #assistant-panel åˆ™ä¸åŠ¨ä½œ â€”â€” */
function relocateButlerPanel(){
  const panel  = document.getElementById('assistant-panel');
  const anchor = document.getElementById('butler-anchor');
  if (panel && anchor && anchor.parentNode){
    anchor.parentNode.insertBefore(panel, anchor.nextSibling);
  }
}

/* ================== ç”Ÿæˆå‘½ç›˜ï¼ˆINLINEï¼‰ ================== */
async function genChart(){
  const get = id => $(id)?.value?.trim() || '';
  const type = get('type');
  const bd1  = get('birthdate1');
  const bt1  = get('birthtime1');
  if (!bd1){ showErr('è¯·å¡«å†™æœ¬äººå‡ºç”Ÿæ—¥æœŸ'); return; }

  // hour default = 12
  const [Y,M,D] = bd1.split('-').map(Number);
  const hour = bt1 ? parseInt(bt1.split(':')[0],10) : 12;

  const nextBtn = $('btnNext');
  if (nextBtn){ nextBtn.disabled = true; nextBtn.textContent = 'ç”Ÿæˆä¸­...'; }

  try{
    if (typeof baziCalculator === 'undefined') throw new Error('baziCalculator æœªåŠ è½½');

    const { pillars, counts, percents, timeUnknown: tu=false } =
      baziCalculator.calculateBazi(Y, M, D, hour, false);

    ensureResultHost();

    const timeText = tu ? 'æ—¶é—´ä¸è¯¦' : (hour + 'æ—¶');
    setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${Y}å¹´${M}æœˆ${D}æ—¥ ${timeText}`);
    if (tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span class="badge-warn">æœªçº³å…¥æ—¶æŸ±</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);
    displayClassicArea(pillars, tu);

    setBar($('bar-æœ¨'), percents.wood);  setText('pct-æœ¨',  Math.round(percents.wood)  + '%');
    setBar($('bar-ç«'), percents.fire);  setText('pct-ç«',  Math.round(percents.fire)  + '%');
    setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ',  Math.round(percents.earth) + '%');
    setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘',  Math.round(percents.metal) + '%');
    setBar($('bar-æ°´'), percents.water); setText('pct-æ°´',  Math.round(percents.water) + '%');

    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);

    // æœ€å¼º/æœ€å¼±ï¼ˆç”¨æœ¬åœ°åŒ–æ ‡ç­¾ï¼‰
    {
      const keys = Object.keys(counts);
      const maxK = keys.reduce((a,b)=> counts[a] > counts[b] ? a : b);
      const minK = keys.reduce((a,b)=> counts[a] < counts[b] ? a : b);
      const E = ELABEL();
      const char2Locale = { æœ¨: E.wood, ç«: E.fire, åœŸ: E.earth, é‡‘: E.metal, æ°´: E.water };
      setText(
        'bazi-elements-balance',
        (t('elements_balance_tpl') || 'å…ƒç´ å¹³è¡¡ï¼šåå¼º {max} Â· åå¼± {min}')
          .replace('{max}', char2Locale[maxK])
          .replace('{min}', char2Locale[minK])
      );
    }

    // å­˜å…¥ä¸Šä¸‹æ–‡
    window.__last_report__ = { pillars, percents, st, adv, timeUnknown: tu };

    // é¡ºåºï¼šæ‰©å±• â†’ å¯ŒæŠ¥å‘Š â†’ ç®¡å®¶
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });
    mountRichReport({ pillars, percents, st, adv, timeUnknown: tu });
    mountButlerCard();

    console.log(
      'å®é™… â†’',
      pillars.year.stem+pillars.year.branch,
      pillars.month.stem+pillars.month.branch,
      pillars.day.stem+pillars.day.branch,
      tu ? 'ï¼Ÿ' : (pillars.hour.stem+pillars.hour.branch)
    );
  } catch (err){
    console.error(err);
    showErr('è®¡ç®—å…«å­—æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    if (nextBtn){ nextBtn.disabled = false; nextBtn.textContent = t('btn_next') || 'ç”Ÿæˆåˆ†æ'; }
    // æ»šåŠ¨åˆ°ç»“æœ
    $('result')?.scrollIntoView({ behavior:'smooth', block:'start' });
  }
}

/* =============== æ‰©å±•æŒ‚è½½ï¼ˆFREEï¼‰ =============== */
function mountExtensionsIntoResult(ctx){
  const host = ensureResultHost();
  // è¿™é‡Œå¯æ’å…¥ä½ çš„ã€Œå…è´¹ç®€æŠ¥ã€æˆ–æ›´å¤šæ‰©å±•æ®µè½
  // ä¿ç•™å ä½ï¼ˆé¿å…åˆ é™¤ä½ çš„ç°æœ‰å®ç°ï¼‰
  if (!document.getElementById('free-extra')){
    const sec = document.createElement('div');
    sec.id = 'free-extra';
    sec.className = 'sec';
    sec.innerHTML = `
      <h3 class="h2">åŸºç¡€åˆ†æ</h3>
      <div class="sub">ï¼ˆç¤ºä¾‹æ®µè½ï¼Œå¯æ›¿æ¢ä¸ºä½ çš„å…è´¹åˆ†ææ–‡æœ¬å—æˆ–å¡ç‰‡ç»„ä»¶ã€‚ï¼‰</div>
    `;
    host.appendChild(sec);
  }
}

/* =============== å¯ŒæŠ¥å‘ŠæŒ‚è½½ï¼ˆVIP/ä¸°å¯Œæ®µï¼‰ =============== */
function buildRichReportHTML({ pillars, percents, st, adv, timeUnknown }){
  // è¿™é‡Œè¾“å‡ºä½ å¯ŒæŠ¥å‘Šçš„ HTMLï¼ˆä¿ç•™ç‚¹ä½ï¼‰
  const E = ELABEL();
  const pct = (k)=> Math.round((percents?.[k]||0));
  return `
    <div class="sec" id="rich-sec-overview">
      <h3>èƒ½é‡æ¦‚è§ˆ</h3>
      <ul>
        <li>${E.wood}: ${pct('wood')}%</li>
        <li>${E.fire}: ${pct('fire')}%</li>
        <li>${E.earth}: ${pct('earth')}%</li>
        <li>${E.metal}: ${pct('metal')}%</li>
        <li>${E.water}: ${pct('water')}%</li>
      </ul>
    </div>
    <div class="sec" id="rich-sec-adv">
      <h3>ç”¨ç¥æ–¹å‘</h3>
      <p>æ—¥ä¸»å¼ºå¼±ï¼š<b>${st.mark}</b> Â· å»ºè®®ç­–ç•¥ï¼š<b>${adv.strategy}</b></p>
      <p>æœ‰åˆ©äº”è¡Œï¼š${(adv.useful||[]).join('ã€') || 'â€”'}ï¼›é¿å…ï¼š${(adv.avoid||[]).join('ã€') || 'â€”'}</p>
    </div>
  `;
}
function mountRichReport({ pillars, percents, st, adv, timeUnknown }) {
  let host = document.getElementById('rich-report');
  if (!host) host = ensureResultHost().querySelector('#rich-report');
  host.innerHTML = buildRichReportHTML({ pillars, percents, st, adv, timeUnknown });

  // ğŸ‘‰ ç¡®ä¿â€œç®¡å®¶â€å®¹å™¨åœ¨æŠ¥å‘Šä¹‹å
  let bhost = document.getElementById('butler-host');
  if (!bhost && host.parentNode) {
    bhost = document.createElement('div');
    bhost.id = 'butler-host';
    host.parentNode.insertBefore(bhost, host.nextSibling);
  }

  if (typeof relocateButlerPanel === 'function') relocateButlerPanel();
}

/* =============== ç®¡å®¶å¡ç‰‡ï¼ˆå ä½æ¢å¤ï¼‰ =============== */
function mountButlerCard(){
  const host = document.getElementById('butler-host') || ensureResultHost();
  if (!host.querySelector('#aiCard')){
    const card = document.createElement('div');
    card.id = 'aiCard';
    card.className = 'sec';
    card.innerHTML = `
      <h3 id="butlerTitle">${t('butler_title') || 'å¿ƒæ€œç®¡å®¶ Â· å»ºè®®'}</h3>
      <div class="chips" id="butlerChips"></div>
      <div class="ai-lock-overlay">
        <div class="tip">VIP è§£é”æ›´å¤šä¸ªæ€§åŒ–å»ºè®®</div>
        <div class="sub">ç™»å½•åå¯ç”Ÿæˆå®Œæ•´æ·±åº¦æŠ¥å‘Šä¸æ—¥å¸¸ç»ƒä¹ å¡ã€‚</div>
      </div>
    `;
    host.appendChild(card);
  }
  renderChips();
}
function renderChips(){
  const el = document.getElementById('butlerChips'); if (!el) return;
  el.innerHTML='';
  const chips = [
    t('opt_dating')||'æ‹çˆ±ç¼˜åˆ†', t('opt_marriage')||'å©šå§»èµ°åŠ¿', t('opt_work')||'èŒåœºå‘å±•',
    t('opt_startup')||'åˆ›ä¸šæ½œåŠ›', t('opt_wealthpos')||'è´¢ä½åˆ†æ', t('opt_timing')||'ç†è´¢æ—¶æœº'
  ];
  chips.forEach(txt=>{
    const c=document.createElement('div'); c.className='chip'; c.textContent=txt; el.appendChild(c);
  });
}

/* =============== è¯­è¨€åˆ‡æ¢åé‡æ¸²æŸ“ =============== */
function initLangUI(){
  const sel = document.getElementById('langSelect');
  if(!sel) return;
  const current = getLang();
  sel.value = current;
  document.documentElement.lang = current;
  applyI18n();
  applyChatI18n();

  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n();
    applyChatI18n();
    rerenderReportsIfAny();
  });
}
function rerenderReportsIfAny(){
  const ctx = window.__last_report__;
  if (!ctx) return;

  const { pillars, percents, st, adv, timeUnknown } = ctx;

  // 1) é‡æ–°æ¸²æŸ“æŠ¥å‘Šï¼ˆå…è´¹+å¯ŒæŠ¥å‘Šï¼‰
  mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown });
  mountRichReport({ pillars, percents, st, adv, timeUnknown });
  if (typeof relocateButlerPanel === 'function') relocateButlerPanel();

  // 2) åˆ‡è¯­è¨€ååŒæ­¥åˆ·æ–°â€œæœ€å¼º/æœ€å¼±â€æç¤º
  const E = ELABEL();
  const key2Locale = { wood: E.wood, fire: E.fire, earth: E.earth, metal: E.metal, water: E.water };
  const entries = Object.entries(percents || {});
  const strongestK = entries.reduce((a,b)=> a[1] > b[1] ? a : b, ['wood',0])[0];
  const weakestK   = entries.reduce((a,b)=> a[1] < b[1] ? a : b, ['wood',0])[0];
  setText(
    'bazi-elements-balance',
    (t('elements_balance_tpl') || 'å…ƒç´ å¹³è¡¡ï¼šåå¼º {max} Â· åå¼± {min}')
      .replace('{max}', key2Locale[strongestK])
      .replace('{min}', key2Locale[weakestK])
  );

  // 3) åˆ·æ–° AI å¡ç‰‡æ ‡é¢˜ä¸èŠ¯ç‰‡æ–‡æ¡ˆ
  const titleEl = document.getElementById('butlerTitle');
  if (titleEl) titleEl.textContent = t('butler_title') || 'å¿ƒæ€œç®¡å®¶ Â· å»ºè®®';
  renderChips();
}

/* ================== ä¼°æ—¶é—´å‘å¯¼ï¼ˆå¯é€‰ï¼‰ ================== */
(function initBirthtimeWizard(){
  // å¦‚æœä½ çš„é¡µé¢æ²¡æœ‰è¿™äº›å…ƒç´ ï¼Œè‡ªåŠ¨è·³è¿‡
  const tChk=$('timeUnknown'), tInput=$('birthtime'), btn=$('guessTimeBtn');
  const twMask=$('twMask'), twGrid=$('twGrid'), twApply=$('twApply'), twCancel=$('twCancel');
  if(!tInput||!tChk||!twMask||!twGrid||!twApply||!twCancel) return;

  const DZ=[
    ['å­','23:00â€“01:00','00:00'],['ä¸‘','01:00â€“03:00','02:00'],['å¯…','03:00â€“05:00','04:00'],['å¯','05:00â€“07:00','06:00'],
    ['è¾°','07:00â€“09:00','08:00'],['å·³','09:00â€“11:00','10:00'],['åˆ','11:00â€“13:00','12:00'],['æœª','13:00â€“15:00','14:00'],
    ['ç”³','15:00â€“17:00','16:00'],['é…‰','17:00â€“19:00','18:00'],['æˆŒ','19:00â€“21:00','20:00'],['äº¥','21:00â€“23:00','22:00']
  ];
  let selected=null;

  function openWizard(){
    twMask.style.display='flex'; selected=null; twApply.disabled=true;
    if(!twGrid.dataset.built){
      DZ.forEach(([z,range])=>{
        const b=document.createElement('button'); b.type='button'; b.className='tw-btn'; b.textContent=`${z}ï¼ˆ${range}ï¼‰`;
        b.addEventListener('click',()=>{ [...twGrid.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); selected=z; twApply.disabled=false;});
        twGrid.appendChild(b);
      }); twGrid.dataset.built='1';
    }else{ [...twGrid.children].forEach(x=>x.classList.remove('active')); }
  }
  function closeWizard(){ twMask.style.display='none'; }

  tChk.addEventListener('change', ()=>{ tInput.disabled=tChk.checked; if(tChk.checked) openWizard(); else closeWizard(); });
  btn && btn.addEventListener('click', openWizard);
  twCancel.addEventListener('click', closeWizard);
  twApply.addEventListener('click', ()=>{
    if(!selected) return;
    const mid=Object.fromEntries(DZ.map(([z,_,m])=>[z,m]))[selected];
    tInput.value=mid; tInput.disabled=false; tChk.checked=false; closeWizard();
  });
  tInput.disabled=tChk.checked;
})();

/* ==============================
   DOM READY (wire events)
============================== */
document.addEventListener('DOMContentLoaded', () => {
  // Language selector init
  const select = $('langSelect');
  const current = getLang();
  if (select) { select.value = current; select.addEventListener('change', ()=>{ setLang(select.value); applyI18n(); applyChatI18n(); }); }
  applyI18n();

  // Chat attach (non-intrusive)
  const chatFab = document.createElement('div');
  chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = 'å¿ƒæ€œç®¡å®¶';
  const chatPanel = document.createElement('div');
  chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','å¿ƒæ€œç®¡å®¶');
  chatPanel.style.display = 'none';
  chatPanel.innerHTML = `
    <div class="ss-chat-head">
      <div class="ss-chat-title">å¿ƒæ€œç®¡å®¶ Â· Chat</div>
      <div class="ss-close" id="ssChatClose">âœ•</div>
    </div>
    <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" />
      <button id="ssChatSend"></button>
    </div>`;
  document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
  applyChatI18n();

  const $body = $('ssChatBody'); const $input = $('ssChatInput'); const $send = $('ssChatSend'); const $close = $('ssChatClose');
  function addMsg(text, me=false){
    const div = document.createElement('div');
    div.className = 'ss-msg' + (me ? ' me' : '');
    div.textContent = text;
    $body.appendChild(div);
    $body.scrollTop = $body.scrollHeight;
  }
  async function askChat(prompt){
    addMsg(prompt, true); $input.value=''; $input.focus();
    try{
      const r = await fetch(`${API_BASE}/api/chat`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          messages: [
            { role:'system', content:'ä½ æ˜¯â€œå¿ƒæ€œç®¡å®¶â€ï¼Œå¸®åŠ©è®¿å®¢äº†è§£å‘½ç†å¿ƒæ€œç©ºé—´çš„åŠŸèƒ½ã€å¯¼èˆªä¸ä¼šå‘˜è¯´æ˜ï¼Œè¯­æ°”æ¸©æš–ä¸“ä¸šã€ç®€æ´æœ‰æ¡ç†ã€‚' },
            { role:'user', content: prompt }
          ]
        })
      });
      let data, reply=''; try { data = await r.json(); } catch { data = {}; }
      reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
      if (!reply) return addMsg('æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚');
      addMsg(reply);
    }catch{ addMsg('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚'); }
  }
  chatFab.addEventListener('click', ()=>{ chatPanel.style.display='flex'; $input && $input.focus(); });
  $close.addEventListener('click', ()=>{ chatPanel.style.display='none'; });
  if ($send) $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
  if ($input) $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

  // Type toggle
  const typeSel = $('type');
  if (typeSel){
    togglePartner(typeSel.value);
    typeSel.addEventListener('change', e => togglePartner(e.target.value));
  }

  // Submit â†’ INLINE RENDER (NO REDIRECT)
  const nextBtn = $('btnNext');
  if (nextBtn){
    nextBtn.addEventListener('click', (e)=>{
      e.preventDefault(); hideErr(); genChart();
    });
  }

  // å›è½¦æäº¤
  ['birthdate1','birthtime1'].forEach(id=>{
    const el=$(id);
    if(el) el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); genChart(); }});
  });

  // â€”â€” æœ€å°é˜²è‡ªåŠ¨å¡«å……ï¼ˆä¸é¢„è®¾é‚®ç®±/å¯†ç ï¼‰â€”â€”
  (() => {
    const form = document.getElementById('loginForm');
    if (form) form.setAttribute('autocomplete','off');
    const email = document.getElementById('email');
    const pwd   = document.getElementById('password');
    if (email) email.setAttribute('autocomplete','off');
    if (pwd)   pwd.setAttribute('autocomplete','new-password');
  })();

  initLangUI();
});

/* ==============================
   INLINE REPORT (optional API demo)
============================== */
async function generateReport(data) {
  const nextBtn = $('btnNext');
  try {
    if (nextBtn){ nextBtn.disabled = true; nextBtn.textContent = 'ç”Ÿæˆä¸­...'; }
    const resp = await fetch(`${API_BASE}/api/generate-report`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
    });
    const result = await resp.json();
    if (result?.success) displayReport(result.report);
    else alert('æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'));
  } catch (err) {
    alert('ç½‘ç»œé”™è¯¯: ' + err.message);
  } finally {
    if (nextBtn){ nextBtn.disabled = false; nextBtn.textContent = t('btn_next') || 'ç”Ÿæˆåˆ†æ'; }
  }
}
function displayReport(reportHtml) {
  let reportSection = $('reportSection');
  if (!reportSection){
    reportSection = document.createElement('div');
    reportSection.id = 'reportSection';
    reportSection.className = 'card';
    (document.querySelector('main') || document.body).appendChild(reportSection);
  }
  reportSection.innerHTML = `<h2>å‘½ç†åˆ†ææŠ¥å‘Š</h2><div class="report">${reportHtml}</div>`;
  reportSection.scrollIntoView({ behavior:'smooth' });
}

/* ==============================
   BAZI SELF-TEST (safe if present)
============================== */
(function(){
  const $now = $('nowTime');
  if ($now){
    function tick(){ $now.textContent = new Date().toLocaleString(); }
    tick(); setInterval(tick, 1000);
  }
})();

if (typeof BaziCalculator === 'function') {
  // now pillars
  (function(){
    const c = new BaziCalculator();
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate(), h = now.getHours();
    const Y = c.calculateYearPillar(y);
    const M = c.calculateMonthPillar(y, m, d);
    const D = c.calculateDayPillar(y, m, d);
    const H = c.calculateHourPillar(D.stem, h);
    console.log(
      `ç°åœ¨ ${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} ${String(h).padStart(2,'0')}:00 â†’`,
      `å¹´${Y.stem}${Y.branch} æœˆ${M.stem}${M.branch} æ—¥${D.stem}${D.branch} æ—¶${H.stem}${H.branch}`
    );
  })();

  // test: 1978-02-21 12:00 â†’ æˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ
  (function(){
    const c=new BaziCalculator();
    const Y=c.calculateYearPillar(1978);
    const M=c.calculateMonthPillar(1978,2,21);
    const D=c.calculateDayPillar(1978,2,21);
    const H=c.calculateHourPillar(D.stem,12);
    console.log('åº”ä¸º â†’ å¹´ æˆŠåˆï½œæœˆ ç”²å¯…ï½œæ—¥ ç”²å¯…ï½œæ—¶ åºšåˆ');
    console.log('å®é™… â†’', Y.stem+Y.branch, M.stem+M.branch, D.stem+D.branch, H.stem+H.branch);
  })();
}
</script>
</body>
</html>
