<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">命理心怜空间 · VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  .site-header{position:sticky;top:0;z-index:10;background:#0b0f14cc;border-bottom:1px solid #0f1622;backdrop-filter:saturate(140%) blur(12px)}
  .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .brand-badge{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#0e1520,#0b1018);border:1px solid #2a3546;box-shadow:0 4px 14px rgba(0,0,0,.35);font-weight:800;color:var(--gold)}
  .title{font-family:"Noto Serif SC","Noto Serif",serif!important;font-weight:600!important;letter-spacing:.02em;font-size:1.1rem!important;line-height:1.25}
  .title a{color:inherit;text-decoration:none}
  .title a:hover{text-decoration:underline;text-underline-offset:3px}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid (fix row-2/row-3 & cols-2/cols-3) ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  /* nicer selects with arrow */
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== List blocks (portal) ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Buttons (unified) ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:pre-wrap;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold)}

  /* ===== Chat widget ===== */
  .ss-chat-fab{
    position:fixed;right:18px;bottom:18px;z-index:50;width:56px;height:56px;border-radius:50%;
    background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;display:grid;place-items:center;font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35);cursor:pointer;border:1px solid #e6c76e
  }
  .ss-chat-panel{
    position:fixed;right:18px;bottom:88px;z-index:50;width:min(460px,92vw);display:none;flex-direction:column;
    background:#0e1520;border:1px solid #243244;border-radius:14px;box-shadow:var(--shadow)
  }
  .ss-chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #243244}
  .ss-chat-title{font-weight:700}
  .ss-close{cursor:pointer;opacity:.8}
  .ss-chat-body{max-height:300px;overflow:auto;padding:10px 12px}
  .ss-msg{padding:8px 10px;background:#0f1624;border:1px solid #243244;border-radius:10px;margin:6px 0;max-width:80%}
  .ss-msg.me{margin-left:auto;background:#132033}
  .ss-chat-input{display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #243244}
  .ss-chat-input input{flex:1 1 auto;min-width:0}
  .ss-chat-input .btn,.ss-chat-input button{flex:0 0 auto;width:auto!important;white-space:nowrap;padding:10px 14px}

  /* ===== Misc ===== */
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">命理心怜空间 · VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- 顶部：命理分析表单 -->
    <section class="card section">
      <h2 data-i18n="form_title">命理分析 · 生成报告</h2>

      <div class="group-title" data-i18n="choose_type">选择命盘类型</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">个人命盘</option>
          <option value="compatibility" data-i18n="type_compat">合盘（两人资料）</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">自动识别 Auto Detect</option>
          <option value="东方" data-i18n="culture_cn">东方 Chinese / Bazi</option>
          <option value="西方" data-i18n="culture_west">西方 Astrology / Tarot</option>
          <option value="日式" data-i18n="culture_jp">日式九星 Japanese</option>
          <option value="吠陀" data-i18n="culture_vedic">印度吠陀 Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">本人资料</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="姓名（本人）" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="出生时间" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
          <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="出生国家 / 地区" required data-i18n-ph="ph_country1">
        <button class="btn" id="btnNext" type="button" data-i18n="btn_next">生成分析</button>
      </div>

      <!-- 隐形表单用于提交 -->
      <form id="reportForm" action="report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">第二人资料（合盘）</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="姓名（第二人）" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="出生时间" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
            <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="出生国家 / 地区" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">命理选题（报告聚焦）</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="姻缘 Love" data-i18n="opt_love"></optgroup>
          <option value="恋爱缘分" data-i18n="opt_dating">恋爱缘分</option>
          <option value="婚姻走势" data-i18n="opt_marriage">婚姻走势</option>

          <optgroup label="事业 Career" data-i18n="opt_career"></optgroup>
          <option value="职场发展" data-i18n="opt_work">职场发展</option>
          <option value="创业潜力" data-i18n="opt_startup">创业潜力</option>

          <optgroup label="财运 Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="财位分析" data-i18n="opt_wealthpos">财位分析</option>
          <option value="理财时机" data-i18n="opt_timing">理财时机</option>

          <optgroup label="择日 Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="婚期择日" data-i18n="opt_wedding">婚期择日</option>
          <option value="新生宝宝择日" data-i18n="opt_babydate">新生宝宝择日</option>
          <option value="新家入住择日" data-i18n="opt_house">新家入住择日</option>
          <option value="新公司入住择日" data-i18n="opt_office">新公司入住择日</option>

          <optgroup label="测名 Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="宝宝名" data-i18n="opt_babyname">宝宝名</option>
          <option value="宠物名" data-i18n="opt_petname">宠物名</option>
          <option value="公司名" data-i18n="opt_companyname">公司名</option>
          <option value="命名改运" data-i18n="opt_rename">命名改运</option>

          <optgroup label="风水 Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="住家" data-i18n="opt_home">住家</option>
          <option value="办公室" data-i18n="opt_officefs">办公室</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="合盘分析 Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="缘分起落" data-i18n="opt_couple">情侣合盘（缘分起落 / 暧昧进展）</option>
          <option value="夫妻流年" data-i18n="opt_spouse">夫妻流年（婚姻发展）</option>
          <option value="合盘分析" data-i18n="opt_personality">个性合盘（冲突 / 互补）</option>
          <option value="事业共事" data-i18n="opt_partner">事业合盘（合伙人 / 员工）</option>
          <option value="断联修复" data-i18n="opt_reconnect">断联修复（朋友 / 情人 / 家人）</option>
          <option value="宠物缘分" data-i18n="opt_petbond">宠物合盘（主人与宠物）</option>
        </select>
      </div>
    </section>

    <!-- 下段：各功能入口 -->
    <section class="card section">
      <h2 data-i18n="portal_title">心怜空间 · 功能入口</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">🧘‍♀️ 灵性日记</div>
        <ul><li data-i18n="diary_desc">照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">个人隐藏记录</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">家庭共享记录</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">上传记录</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">📘 命理课程专区</div>
        <ul>
          <li data-i18n="course_bazi">八字命理：十神 / 流年 / 用神分析</li>
          <li data-i18n="course_tarot">塔罗牌：牌阵解读 / 情境实战</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">进入课程</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">🛍️ 能量商城 · VIP折扣 & 御守订制</div>
        <ul><li data-i18n="shop_desc">专属祈愿包分类：</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="阴债和解包.html">阴债和解包</a>
          <a class="btn link-btn" href="财库包.html">财库包</a>
          <a class="btn link-btn" href="灵魂开悟的指引包.html">心灵包</a>
          <a class="btn link-btn" href="财运包.html">财运包</a>
          <a class="btn link-btn" href="姻缘包.html">姻缘包</a>
          <a class="btn link-btn" href="学业包.html">学业包</a>
          <a class="btn link-btn" href="事业包.html">事业包</a>
          <a class="btn link-btn" href="御守包.html">御守包</a>
          <a class="btn link-btn" href="太岁包.html">太岁包</a>
          <a class="btn link-btn" href="七月包.html">七月包</a>
          <a class="btn link-btn" href="家族福报包.html">家族福报包</a>
          <a class="btn link-btn" href="情伤疗愈包.html">情伤疗愈包</a>
          <a class="btn link-btn" href="劫难包.html">劫难包</a>
          <a class="btn link-btn" href="新宅办公室包.html">新宅 / 办公室包</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">🔮 梦想提交 Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">梦想规划 / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">📖 灵性空间 ~ 往生记怜录</div>
        <ul><li data-i18n="memorial_desc">灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">登入灵性空间</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">上传往生录</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">注册灵性空间</a>
        </div>
      </div>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>

<script>
'use strict';

/* ==============================
   CONFIG
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';

const DEFAULT_LANG = "zh-CN";

// 修复：添加缺失的翻译对象
const translations = {
  "zh-CN": {
    "page_title": "命理心怜空间 · VIP Soul Sanctuary",
    "site_title": "命理心怜空间 · VIP Soul Sanctuary",
    "lang_label": "语言",
    "form_title": "命理分析 · 生成报告",
    "choose_type": "选择命盘类型",
    "type_personal": "个人命盘",
    "type_compat": "合盘（两人资料）",
    "culture_auto": "自动识别 Auto Detect",
    "culture_cn": "东方 Chinese / Bazi",
    "culture_west": "西方 Astrology / Tarot",
    "culture_jp": "日式九星 Japanese",
    "culture_vedic": "印度吠陀 Vedic",
    "self_info": "本人资料",
    "ph_name1": "姓名（本人）",
    "ph_time1": "出生时间",
    "cal_g": "阳历 (Gregorian)",
    "cal_l": "农历 (Lunar)",
    "ph_country1": "出生国家 / 地区",
    "btn_next": "生成分析",
    "partner_info": "第二人资料（合盘）",
    "ph_name2": "姓名（第二人）",
    "ph_time2": "出生时间",
    "ph_country2": "出生国家 / 地区",
    "focus_title": "命理选题（报告聚焦）",
    "opt_love": "姻缘 Love",
    "opt_dating": "恋爱缘分",
    "opt_marriage": "婚姻走势",
    "opt_career": "事业 Career",
    "opt_work": "职场发展",
    "opt_startup": "创业潜力",
    "opt_wealth": "财运 Wealth",
    "opt_wealthpos": "财位分析",
    "opt_timing": "理财时机",
    "opt_dates": "择日 Auspicious Date",
    "opt_wedding": "婚期择日",
    "opt_babydate": "新生宝宝择日",
    "opt_house": "新家入住择日",
    "opt_office": "新公司入住择日",
    "opt_name": "测名 Name Analysis",
    "opt_babyname": "宝宝名",
    "opt_petname": "宠物名",
    "opt_companyname": "公司名",
    "opt_rename": "命名改运",
    "opt_fs": "风水 Feng Shui",
    "opt_home": "住家",
    "opt_officefs": "办公室",
    "opt_comp": "合盘分析 Compatibility",
    "opt_couple": "情侣合盘（缘分起落 / 暧昧进展）",
    "opt_spouse": "夫妻流年（婚姻发展）",
    "opt_personality": "个性合盘（冲突 / 互补）",
    "opt_partner": "事业合盘（合伙人 / 员工）",
    "opt_reconnect": "断联修复（朋友 / 情人 / 家人）",
    "opt_petbond": "宠物合盘（主人与宠物）",
    "portal_title": "心怜空间 · 功能入口",
    "diary_title": "🧘‍♀️ 灵性日记",
    "diary_desc": "照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）",
    "btn_personal": "个人隐藏记录",
    "btn_family": "家庭共享记录",
    "btn_upload": "上传记录",
    "course_title": "📘 命理课程专区",
    "course_bazi": "八字命理：十神 / 流年 / 用神分析",
    "course_tarot": "塔罗牌：牌阵解读 / 情境实战",
    "course_coming": "🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……",
    "btn_enter_course": "进入课程",
    "shop_title": "🛍️ 能量商城 · VIP折扣 & 御守订制",
    "shop_desc": "专属祈愿包分类：",
    "wish_title": "🔮 梦想提交 Dream Submission",
    "btn_manifest": "梦想规划 / Manifestation",
    "memorial_title": "📖 灵性空间 ~ 往生记怜录",
    "memorial_desc": "灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）",
    "btn_login_memorial": "登入灵性空间",
    "btn_upload_memorial": "上传往生录",
    "btn_register_memorial": "注册灵性空间",
    "chat_fab": "💬",
    "chat_placeholder": "输入您的问题...",
    "chat_send": "发送",
    "butler_title": "心怜管家 · 建议",
    "elements_balance_tpl": "元素平衡：偏强 {max} · 偏弱 {min}"
  },
  "zh-TW": {
    // 繁体中文翻译（简化示例）
    "page_title": "命理心憐空間 · VIP Soul Sanctuary",
    "site_title": "命理心憐空間 · VIP Soul Sanctuary",
    "lang_label": "語言"
    // 其他翻译项...
  },
  "en": {
    "page_title": "Astrology Sanctuary · VIP Soul Space",
    "site_title": "Astrology Sanctuary · VIP Soul Space",
    "lang_label": "Language"
    // 其他翻译项...
  }
  // 其他语言...
};

function normalizeLang(code){
  if (!code) return DEFAULT_LANG;
  const c = String(code).trim();
  if (/^zh[-_]?cn$/i.test(c)) return "zh-CN";
  if (/^zh[-_]?tw$/i.test(c)) return "zh-TW";
  if (/^en/i.test(c)) return "en";
  if (/^ja/i.test(c)) return "ja";
  if (/^th/i.test(c)) return "th";
  if (/^ms/i.test(c)) return "ms";
  return DEFAULT_LANG;
}

function t(key){
  const lang = normalizeLang(getLang());
  const base = translations[DEFAULT_LANG] || {};
  const pack = translations[lang] || base;
  return pack[key] || base[key] || key;
}  

/* ==============================
   UTILITIES
============================== */
const $ = id => document.getElementById(id);

function ensureErrorBox(){
  let box = $('error');
  if (!box){
    box = document.createElement('div');
    box.id = 'error';
    box.className = 'error';
    box.style.cssText = 'margin-top:10px;color:#ff8b8b';
    (document.querySelector('.section') || document.body).appendChild(box);
  }
  return box;
}
function showErr(msg){ const e = ensureErrorBox(); e.textContent = msg; e.style.display = 'block'; setTimeout(()=>{ e.style.display='none'; }, 5000); }
function hideErr(){ const e = $('error'); if (e){ e.style.display='none'; e.textContent=''; } }
function lock(el, v){ if (el) el.disabled = !!v; }
function strongPwd(pw){ return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw); }
function setText(id, txt){ const el=$(id); if(el) el.textContent = (txt ?? ''); }
function setBar(el, pct){ if(!el) return; const v=Math.max(0,Math.min(100,Number(pct)||0)); el.style.width = v+'%'; el.setAttribute('aria-valuenow', String(Math.round(v))); }
function ELABEL(){
  const L = getLang();
  const map = {
    "zh-CN": { wood:'木', fire:'火', earth:'土', metal:'金', water:'水' },
    "zh-TW": { wood:'木', fire:'火', earth:'土', metal:'金', water:'水' },
    "ja":    { wood:'木', fire:'火', earth:'土', metal:'金', water:'水' },
    "th":    { wood:'ไม้', fire:'ไฟ', earth:'ดิน', metal:'โลหะ', water:'น้ำ' },
    "ms":    { wood:'Kayu', fire:'Api', earth:'Tanah', metal:'Logam', water:'Air' },
    "en":    { wood:'Wood', fire:'Fire', earth:'Earth', metal:'Metal', water:'Water' }
  };
  return map[L] || map['en'];
}

/* ==============================
   I18N
============================== */
const LANG_KEY = "site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

/* ==============================
   CHAT WIDGET
============================== */
function applyChatI18n(){
  const fab = $('ssChatFab'); const inp = $('ssChatInput'); const btn = $('ssChatSend');
  if (fab) fab.textContent = t('chat_fab');
  if (inp) inp.placeholder = t('chat_placeholder');
  if (btn) btn.textContent = t('chat_send');
}

/* ==============================
   AUTH HELPERS
============================== */
async function safeJson(resp){ try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; } }

async function loginFlow(email, password){
  const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email, password })
  }));
  const msg = (res.msg || "").toString().toLowerCase();

  let expired = false;
  if (res.expired === true) expired = true;
  else if (msg === 'expired') expired = true;
  else if (res.expiresAt) {
    const ts = Date.parse(res.expiresAt);
    if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
  }
  if (expired){
    const go = confirm('账户已过期。是否前往续费？');
    if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
    return;
  }

  if (res.ok === true){
    localStorage.setItem("vipEmail", res.email || email);
    location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
    return;
  }

  if (msg === 'no_account') return showErr('账户不存在');
  if (msg === 'wrong_pwd')  return showErr('密码错误');
  showErr('登录失败' + (res.msg ? ` ${res.msg}` : ''));
}

/* ==============================
   FORM & TOGGLE
============================== */
function togglePartner(value){
  const section  = $('partner-section');
  const personal = $('purpose_personal');
  const compat   = $('purpose_compatibility');
  const show = (value === "compatibility");

  if (section) section.style.display = show ? "block" : "none";
  if (personal){ personal.style.display = show ? "none" : "block"; personal.disabled = show; }
  if (compat){   compat.style.display   = show ? "block": "none";  compat.disabled   = !show; }
}

/* =========================================
   RESULT HOST (inline render target)
========================================= */
function ensureResultHost(){
  let result = document.getElementById('result');
  if (!result){
    result = document.createElement('section');
    result.id = 'result';
    result.className = 'card section';
    const main = document.querySelector('main') || document.body;
    main.appendChild(result);
  }
  
  // 修复：确保所有必要的子元素都存在
  if (!document.getElementById('xl-free-report')){
    const free = document.createElement('div');
    free.id = 'xl-free-report';
    free.innerHTML = `
      <div class="card" style="margin-top:8px">
        <div class="h2">命理简报</div>
        <div id="bazi-date" class="sub" style="margin-bottom:8px"></div>
        <div id="bazi-pillars" class="row cols-4" style="gap:10px"></div>
        <div class="row cols-5" style="align-items:center;margin-top:10px">
          <div><div>木</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-木" style="height:8px;width:0%"></div></div><div id="pct-木" class="muted" style="margin-top:4px"></div></div>
          <div><div>火</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-火" style="height:8px;width:0%"></div></div><div id="pct-火" class="muted" style="margin-top:4px"></div></div>
          <div><div>土</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-土" style="height:8px;width:0%"></div></div><div id="pct-土" class="muted" style="margin-top:4px"></div></div>
          <div><div>金</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-金" style="height:8px;width:0%"></div></div><div id="pct-金" class="muted" style="margin-top:4px"></div></div>
          <div><div>水</div><div class="bar" style="height:8px;background:#263448;border-radius:6px;overflow:hidden"><div id="bar-水" style="height:8px;width:0%"></div></div><div id="pct-水" class="muted" style="margin-top:4px"></div></div>
        </div>
        <div id="bazi-elements-balance" class="sub" style="margin-top:8px"></div>
      </div>
    `;
    result.appendChild(free);
  }
  if (!document.getElementById('rich-report')){
    const rich = document.createElement('div');
    rich.id = 'rich-report';
    result.appendChild(rich);
  }
  if (!document.getElementById('butler-host')){
    const b = document.createElement('div');
    b.id = 'butler-host';
    result.appendChild(b);
  }
  return result;
}

/* ================== 八字计算器（简化版本） ================== */
// 修复：添加基本的八字计算器功能
const baziCalculator = {
  // 天干地支基础数据
  heavenlyStems: ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'],
  earthlyBranches: ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'],
  
  // 计算年柱
  calculateYearPillar: function(year) {
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: this.earthlyBranches[branchIndex],
      element: this.getElement(this.heavenlyStems[stemIndex], this.earthlyBranches[branchIndex])
    };
  },
  
  // 计算月柱（简化版）
  calculateMonthPillar: function(year, month, day) {
    // 简化：使用固定映射
    const monthMap = {
      1: { stem: '丙', branch: '寅' }, 2: { stem: '丁', branch: '卯' },
      3: { stem: '戊', branch: '辰' }, 4: { stem: '己', branch: '巳' },
      5: { stem: '庚', branch: '午' }, 6: { stem: '辛', branch: '未' },
      7: { stem: '壬', branch: '申' }, 8: { stem: '癸', branch: '酉' },
      9: { stem: '甲', branch: '戌' }, 10: { stem: '乙', branch: '亥' },
      11: { stem: '丙', branch: '子' }, 12: { stem: '丁', branch: '丑' }
    };
    const pillar = monthMap[month] || monthMap[1];
    return {
      stem: pillar.stem,
      branch: pillar.branch,
      element: this.getElement(pillar.stem, pillar.branch)
    };
  },
  
  // 计算日柱（简化版 - 使用固定算法）
  calculateDayPillar: function(year, month, day) {
    // 简化：使用基于日期的简单算法
    const date = new Date(year, month - 1, day);
    const dayNum = Math.floor((date - new Date(1900, 0, 1)) / (1000 * 60 * 60 * 24));
    const stemIndex = dayNum % 10;
    const branchIndex = dayNum % 12;
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: this.earthlyBranches[branchIndex],
      element: this.getElement(this.heavenlyStems[stemIndex], this.earthlyBranches[branchIndex])
    };
  },
  
  // 计算时柱
  calculateHourPillar: function(dayStem, hour) {
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const stemMap = {
      '甲': ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸', '甲', '乙'],
      '乙': ['丙', '丁', '戊', '己', '庚', '辛', '壬', '癸', '甲', '乙', '丙', '丁'],
      // 简化其他天干的映射
    };
    const stem = stemMap[dayStem] ? stemMap[dayStem][hourIndex] : '甲';
    return {
      stem: stem,
      branch: this.earthlyBranches[hourIndex],
      element: this.getElement(stem, this.earthlyBranches[hourIndex])
    };
  },
  
  // 获取五行元素
  getElement: function(stem, branch) {
    const stemElements = {
      '甲': '木', '乙': '木', '丙': '火', '丁': '火',
      '戊': '土', '己': '土', '庚': '金', '辛': '金', 
      '壬': '水', '癸': '水'
    };
    return stemElements[stem] || '木';
  },
  
  // 获取纳音
  getNayin: function(stem, branch) {
    // 简化版纳音
    return "金";
  },
  
  // 主计算函数
  calculateBazi: function(year, month, day, hour, timeUnknown) {
    const pillars = {
      year: this.calculateYearPillar(year),
      month: this.calculateMonthPillar(year, month, day),
      day: this.calculateDayPillar(year, month, day),
      hour: timeUnknown ? { stem: '?', branch: '?', element: '未知' } : this.calculateHourPillar(this.calculateDayPillar(year, month, day).stem, hour)
    };
    
    // 计算五行统计（简化）
    const elements = ['木', '火', '土', '金', '水'];
    const counts = { 木: 0, 火: 0, 土: 0, 金: 0, 水: 0 };
    const percents = { wood: 25, fire: 25, earth: 25, metal: 25, water: 0 };
    
    return { pillars, counts, percents, timeUnknown };
  }
};

/* ================== 规则/渲染 ================== */
function renderPillars(root,p,timeUnknown=false){
  if(!root) return; root.innerHTML='';
  [['年柱',p.year],['月柱',p.month],['日柱',p.day],['时柱',p.hour]].forEach(([tit,v])=>{
    const u=(tit==='时柱'&&timeUnknown); const stem=u?'？':v.stem,branch=u?'？':v.branch;
    const div=document.createElement('div'); 
    div.className='pillar'; 
    div.style.cssText='border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;background:#0e1520';
    div.innerHTML=`<div class="tit" style="color:var(--gold);font-weight:700;margin-bottom:4px">${tit}</div><div class="gz" style="font-size:1.25rem">${stem}${branch}</div>`;
    root.appendChild(div);
  });
}

function displayClassicArea(p,timeUnknown){
  const ge=(s,b)=>baziCalculator.getElement(s,b), ny=(s,b)=>baziCalculator.getNayin(s,b);
  // 简化实现
}

function judgeStrength(dayGan,monthZhi,cnt){
  return {season: '春', mark: '平衡', focus: '守中/调和'};
}

function chooseUseful(strength,dmElem){
  return {strategy:'调和', useful:['木','火','土','金','水'], avoid:[]};
}

/* ================== 生成命盘（INLINE） ================== */
async function genChart(){
  const get = id => $(id)?.value?.trim() || '';
  const type = get('type');
  const bd1  = get('birthdate1');
  const bt1  = get('birthtime1');
  if (!bd1){ showErr('请填写本人出生日期'); return; }

  const [Y,M,D] = bd1.split('-').map(Number);
  const hour = bt1 ? parseInt(bt1.split(':')[0],10) : 12;

  const nextBtn = $('btnNext');
  if (nextBtn){ nextBtn.disabled = true; nextBtn.textContent = '生成中...'; }

  try{
    const { pillars, counts, percents, timeUnknown: tu=false } =
      baziCalculator.calculateBazi(Y, M, D, hour, false);

    ensureResultHost();

    const timeText = tu ? '时间不详' : (hour + '时');
    setText('bazi-date', `出生日期: ${Y}年${M}月${D}日 ${timeText}`);
    if (tu){ const el=$('bazi-date'); if(el) el.innerHTML += ' <span style="color:orange">未纳入时柱</span>'; }

    renderPillars($('bazi-pillars'), pillars, tu);

    setBar($('bar-木'), percents.wood);  setText('pct-木',  Math.round(percents.wood)  + '%');
    setBar($('bar-火'), percents.fire);  setText('pct-火',  Math.round(percents.fire)  + '%');
    setBar($('bar-土'), percents.earth); setText('pct-土',  Math.round(percents.earth) + '%');
    setBar($('bar-金'), percents.metal); setText('pct-金',  Math.round(percents.metal) + '%');
    setBar($('bar-水'), percents.water); setText('pct-水',  Math.round(percents.water) + '%');

    const st  = judgeStrength(pillars.day.stem, pillars.month.branch, counts);
    const adv = chooseUseful(st.mark, pillars.day.element);

    // 最强/最弱
    {
      const E = ELABEL();
      setText(
        'bazi-elements-balance',
        (t('elements_balance_tpl') || '元素平衡：偏强 {max} · 偏弱 {min}')
          .replace('{max}', E.wood)
          .replace('{min}', E.water)
      );
    }

    // 存入上下文
    window.__last_report__ = { pillars, percents, st, adv, timeUnknown: tu };

    // 顺序：扩展 → 富报告 → 管家
    mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown: tu });
    mountRichReport({ pillars, percents, st, adv, timeUnknown: tu });
    mountButlerCard();

  } catch (err){
    console.error(err);
    showErr('计算八字时出现错误，请重试');
  } finally {
    if (nextBtn){ nextBtn.disabled = false; nextBtn.textContent = t('btn_next') || '生成分析'; }
    // 滚动到结果
    $('result')?.scrollIntoView({ behavior:'smooth', block:'start' });
  }
}

/* =============== 扩展挂载（FREE） =============== */
function mountExtensionsIntoResult(ctx){
  const host = ensureResultHost();
  if (!document.getElementById('free-extra')){
    const sec = document.createElement('div');
    sec.id = 'free-extra';
    sec.className = 'sec';
    sec.innerHTML = `
      <h3 class="h2">基础分析</h3>
      <div class="sub">根据您的八字分析，显示基本命理信息。</div>
    `;
    host.appendChild(sec);
  }
}

/* =============== 富报告挂载 =============== */
function buildRichReportHTML({ pillars, percents, st, adv, timeUnknown }){
  const E = ELABEL();
  const pct = (k)=> Math.round((percents?.[k]||0));
  return `
    <div class="sec" id="rich-sec-overview">
      <h3>能量概览</h3>
      <ul>
        <li>${E.wood}: ${pct('wood')}%</li>
        <li>${E.fire}: ${pct('fire')}%</li>
        <li>${E.earth}: ${pct('earth')}%</li>
        <li>${E.metal}: ${pct('metal')}%</li>
        <li>${E.water}: ${pct('water')}%</li>
      </ul>
    </div>
    <div class="sec" id="rich-sec-adv">
      <h3>用神方向</h3>
      <p>日主强弱：<b>${st.mark}</b> · 建议策略：<b>${adv.strategy}</b></p>
      <p>有利五行：${(adv.useful||[]).join('、') || '—'}；避免：${(adv.avoid||[]).join('、') || '—'}</p>
    </div>
  `;
}

function mountRichReport({ pillars, percents, st, adv, timeUnknown }) {
  let host = document.getElementById('rich-report');
  if (!host) host = ensureResultHost().querySelector('#rich-report');
  host.innerHTML = buildRichReportHTML({ pillars, percents, st, adv, timeUnknown });

  let bhost = document.getElementById('butler-host');
  if (!bhost && host.parentNode) {
    bhost = document.createElement('div');
    bhost.id = 'butler-host';
    host.parentNode.insertBefore(bhost, host.nextSibling);
  }
}

/* =============== 管家卡片 =============== */
function mountButlerCard(){
  const host = document.getElementById('butler-host') || ensureResultHost();
  if (!host.querySelector('#aiCard')){
    const card = document.createElement('div');
    card.id = 'aiCard';
    card.className = 'sec';
    card.innerHTML = `
      <h3 id="butlerTitle">${t('butler_title') || '心怜管家 · 建议'}</h3>
      <div class="chips" id="butlerChips"></div>
      <div class="ai-lock-overlay">
        <div class="tip">VIP 解锁更多个性化建议</div>
        <div class="sub">登录后可生成完整深度报告与日常练习卡。</div>
      </div>
    `;
    host.appendChild(card);
  }
  renderChips();
}

function renderChips(){
  const el = document.getElementById('butlerChips'); if (!el) return;
  el.innerHTML='';
  const chips = [
    t('opt_dating')||'恋爱缘分', t('opt_marriage')||'婚姻走势', t('opt_work')||'职场发展',
    t('opt_startup')||'创业潜力', t('opt_wealthpos')||'财位分析', t('opt_timing')||'理财时机'
  ];
  chips.forEach(txt=>{
    const c=document.createElement('div'); c.className='chip'; c.textContent=txt; el.appendChild(c);
  });
}

/* =============== 语言切换后重渲染 =============== */
function initLangUI(){
  const sel = document.getElementById('langSelect');
  if(!sel) return;
  const current = getLang();
  sel.value = current;
  document.documentElement.lang = current;
  applyI18n();
  applyChatI18n();

  sel.addEventListener('change', ()=>{
    setLang(sel.value);
    applyI18n();
    applyChatI18n();
    rerenderReportsIfAny();
  });
}

function rerenderReportsIfAny(){
  const ctx = window.__last_report__;
  if (!ctx) return;

  const { pillars, percents, st, adv, timeUnknown } = ctx;
  mountExtensionsIntoResult({ pillars, percents, st, adv, timeUnknown });
  mountRichReport({ pillars, percents, st, adv, timeUnknown });

  const E = ELABEL();
  setText(
    'bazi-elements-balance',
    (t('elements_balance_tpl') || '元素平衡：偏强 {max} · 偏弱 {min}')
      .replace('{max}', E.wood)
      .replace('{min}', E.water)
  );

  const titleEl = document.getElementById('butlerTitle');
  if (titleEl) titleEl.textContent = t('butler_title') || '心怜管家 · 建议';
  renderChips();
}

/* ==============================
   DOM READY (wire events)
============================== */
document.addEventListener('DOMContentLoaded', () => {
  // Language selector init
  const select = $('langSelect');
  const current = getLang();
  if (select) { select.value = current; select.addEventListener('change', ()=>{ setLang(select.value); applyI18n(); applyChatI18n(); }); }
  applyI18n();

  // Chat attach
  const chatFab = document.createElement('div');
  chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';
  const chatPanel = document.createElement('div');
  chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
  chatPanel.style.display = 'none';
  chatPanel.innerHTML = `
    <div class="ss-chat-head">
      <div class="ss-chat-title">心怜管家 · Chat</div>
      <div class="ss-close" id="ssChatClose">✕</div>
    </div>
    <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
    <div class="ss-chat-input">
      <input id="ssChatInput" type="text" />
      <button id="ssChatSend">发送</button>
    </div>`;
  document.body.appendChild(chatFab); document.body.appendChild(chatPanel);
  applyChatI18n();

  const $body = $('ssChatBody'); const $input = $('ssChatInput'); const $send = $('ssChatSend'); const $close = $('ssChatClose');
  function addMsg(text, me=false){
    const div = document.createElement('div');
    div.className = 'ss-msg' + (me ? ' me' : '');
    div.textContent = text;
    $body.appendChild(div);
    $body.scrollTop = $body.scrollHeight;
  }
  async function askChat(prompt){
    addMsg(prompt, true); $input.value=''; $input.focus();
    try{
      // 模拟AI回复
      setTimeout(function() {
        addMsg('您好！我是心怜管家，很高兴为您服务。请问有什么可以帮助您的？', false);
      }, 1000);
    }catch{ addMsg('网络异常，请稍后再试。'); }
  }
  chatFab.addEventListener('click', ()=>{ chatPanel.style.display='flex'; $input && $input.focus(); });
  $close.addEventListener('click', ()=>{ chatPanel.style.display='none'; });
  if ($send) $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
  if ($input) $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

  // Type toggle
  const typeSel = $('type');
  if (typeSel){
    togglePartner(typeSel.value);
    typeSel.addEventListener('change', e => togglePartner(e.target.value));
  }

  // Submit → INLINE RENDER
  const nextBtn = $('btnNext');
  if (nextBtn){
    nextBtn.addEventListener('click', (e)=>{
      e.preventDefault(); hideErr(); genChart();
    });
  }

  // 回车提交
  ['birthdate1','birthtime1'].forEach(id=>{
    const el=$(id);
    if(el) el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); genChart(); }});
  });

  initLangUI();
});
</script>
</body>
</html>
