<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --gold:#ffe084; --gold2:#f2d27a; --accent:#58b9ff;
    --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  /* ===== Base ===== */
  html,body{height:100%}
  html{font-size:16px}
  @media (min-width:768px){ html{font-size:17px} }
  @media (min-width:1200px){ html{font-size:18px} }
  body{
    margin:0; color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
                linear-gradient(180deg,#0b0f14,#0b0f14);
    font-family:Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:#090d13;filter:brightness(.45) saturate(.9) blur(2px)}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px 80px}

  /* ===== Header ===== */
  /* â€”â€” å¤´éƒ¨ï¼ˆTarot åŒæ¬¾ï¼‰ â€”â€” */
  .site-header{
    position:sticky;
    top:0;
    z-index:10;
    background:#0b0f14cc;
    border-bottom:1px solid #0f1622;
    backdrop-filter:saturate(140%) blur(12px);
    transition: all 0.3s ease;
  }
  .site-header.scrolled {
    background: rgba(11, 15, 20, 0.95);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  .head-inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    padding:14px 16px;
  }
  
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
.brand-badge{
  display:inline-grid; 
  place-items:center; 
  width:34px; 
  height:34px; 
  border-radius:8px; 
  background:linear-gradient(180deg,#0e1520,#0b1018); 
  border:1px solid #2a3546; 
  box-shadow:0 4px 14px rgba(0,0,0,.35); 
  font-weight:800; 
  color:#ffe084;
  transition: all 0.3s ease;
}
.brand:hover .brand-badge {
  transform: rotate(15deg);
  box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
}
.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

.title{
  font-family:"Noto Serif SC","Noto Serif",serif !important;
  font-weight:600 !important;
  letter-spacing:.02em;
  font-size:1.1rem !important;
  line-height:1.25;
}

/* æ–°å¢ï¼šé¼ æ ‡åœ¨æ•´æ¡ brand ä¸Šæ—¶ï¼Œé«˜äº®æ ‡é¢˜ */
.brand:hover .title {
  color: var(--gold);
}

  .lang{display:flex;align-items:center;gap:8px}
  .lang label{white-space:nowrap;color:var(--muted)}
  .lang select{min-width:170px}
  @media (max-width:520px){ .title{font-size:1rem} .lang select{min-width:140px} }

  /* ===== Headings / Cards ===== */
  .h1{margin:12px 0 6px;color:var(--gold);font-weight:800;font-size:1.8rem}
  .section>h2{margin:0 0 10px;color:var(--gold);font-weight:800;font-size:1.25rem}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:18px;margin:16px 0}
  .group-title{font-size:1.05rem;color:var(--gold);margin:10px 0 8px}

  /* ===== Form Grid ===== */
  .row{display:grid;gap:12px}
  .row.row-2,.row.cols-2{grid-template-columns:1fr}
  .row.row-3,.row.cols-3{grid-template-columns:1fr}
  @media(min-width:760px){
    .row.row-2,.row.cols-2{grid-template-columns:1fr 1fr}
    .row.row-3,.row.cols-3{grid-template-columns:1fr 1fr 1fr}
  }
  label.muted{display:block;margin-bottom:4px;color:var(--muted)}

  input,select,textarea{
    width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;
    background:#0e1520;color:var(--text);padding:12px;font-size:15px;outline:none
  }
  select{
    appearance:none;
    padding-right:34px;
    background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:calc(100% - 12px) 50%;
  }
  input::placeholder,textarea::placeholder{color:#6f8092}
  input:focus,select:focus,textarea:focus{border-color:#3a4a60;box-shadow:0 0 0 3px rgba(212,175,55,.18)}

  /* ===== Buttons ===== */
  .btn, a.btn{
    display:inline-grid;place-items:center;gap:6px;padding:12px 16px;border-radius:12px;
    border:1px solid #e6c76e;background:linear-gradient(180deg,#fff9e6,#e6c76e);color:#191919;
    font-weight:800;cursor:pointer;text-decoration:none;user-select:none;
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{filter:saturate(105%) brightness(1.02)}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:#101826;color:var(--gold);border-color:#3a3f47}
  .btn.secondary:hover{background:#121b2b;border-color:#4a5565}
  .btn.ghost{background:transparent;color:var(--gold);border:1px solid rgba(212,175,55,.45);box-shadow:none}
  .btn.ghost:hover{background:rgba(255,232,149,.06)}
  .btn.sm{padding:9px 12px;border-radius:10px;font-weight:700}
  .btn.lg{padding:14px 18px;border-radius:14px}
  .btns .btn{min-width:110px}

  /* ===== å…«å­—ä¸“ç”¨æ ·å¼ ===== */
  .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
  .pillar{background:#0f1624;border:1px solid #253245;border-radius:12px;padding:14px 10px;text-align:center}
  .pillar .tit{color:#9aa3b2;font-size:.85rem;margin-bottom:6px}
  .pillar .gz{font-size:1.5rem;font-weight:800;color:var(--gold2)}
  
  .bazi-table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1624;border-radius:8px;overflow:hidden}
  .bazi-table th,.bazi-table td{padding:10px 12px;border:1px solid #253245;text-align:center}
  .bazi-table th{background:rgba(212,175,55,.1);color:var(--gold2)}
  
  .bar{height:10px;background:#0d1420;border:1px solid #233146;border-radius:999px;overflow:hidden;margin:6px 0}
  .bar i{display:block;height:100%;background:linear-gradient(90deg,#ffe084,#f2d27a);width:0}
  .bar-row{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
  .badge-warn{display:inline-block;padding:2px 8px;margin-left:6px;border:1px solid #ffb84d;border-radius:999px;color:#ffb84d;font-size:.82rem}
  
  /* æ—¶é—´è¾“å…¥è¡Œ */
  .time-row{display:flex;align-items:center;gap:10px}
  .time-row .time-unknown{display:flex;align-items:center;gap:6px;white-space:nowrap}
  .btn-mini{padding:8px 10px;border-radius:10px}

  /* ===== Report / Rich text ===== */
  .report{margin-top:12px;display:grid;gap:10px}
  .report .sec{padding:12px;border:1px solid var(--line);background:#0e1520;border-radius:12px}
  .report .sec h3{margin:0 0 6px;color:var(--gold);font-size:1.05rem}
  .report p,.report li{line-height:1.7}
  .ai-content{white-space:pre-wrap;line-height:1.7}
  .ai-content h2,.ai-content h3{color:var(--gold)}

  /* ===== List blocks ===== */
  .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
  .list-block ul{margin:.2rem 0 0;padding-left:1.1rem;color:var(--muted)}
  .list-block .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* ===== Misc ===== */
  footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #2a3546;background:#0e1520;color:var(--text);cursor:pointer}
  .skeleton{display:grid;gap:8px}
  .skeleton div{height:12px;border-radius:6px;background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);animation:sh 1.2s infinite}
  @keyframes sh{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .ai-lock-overlay{position:static;inset:auto;background:none;backdrop-filter:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--line);text-align:center}
  .ai-lock-overlay .tip{color:#ffd88a;font-weight:700;margin-bottom:4px}
  .ai-lock-overlay .sub{color:var(--muted)}
  
  .error{color:#ff6b6b;margin-top:8px;display:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  .block{width:100%}

  /* ===== VIP åŒºåŸŸï¼ˆç»Ÿä¸€æ ·å¼ Â· ä¸ energy.html ä¸€è‡´ï¼‰ ===== */
.card.section{
  max-width:1100px;
  margin:32px auto 40px;
  padding:18px 18px 22px;
  border-radius:var(--radius);
  border:1px solid #1f2a36;
  background:#11161dcc;
  box-shadow:var(--shadow);
  box-sizing:border-box;
}

.group-title{
  font-weight:800;
  color:#ffe084;
  font-size:1rem;
  margin:0 0 10px;
}

/* ä¸ŠåŠéƒ¨ï¼šå·¦å³ä¸¤å— VIP åˆ—è¡¨ */
.card.section .columns{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:16px;
  margin-top:10px;
}
.card.section .list-block{
  border-radius:12px;
  border:1px solid #1f2a36;
  background:#0f141d;
  padding:14px 16px;
}
.card.section .list-block ul{
  list-style:none;
  margin:6px 0 0;
  padding:0;
}
.card.section .list-block li{
  margin:.25rem 0;
  font-size:.95rem;
  color:var(--muted);
  line-height:1.6;
}

/* ä¸‹åŠéƒ¨ï¼šç™»å½•åŒºåŸŸ */
.astro-auth{
  margin-top:16px;
}
.astro-auth .auth-grid{
  display:grid;
  grid-template-columns:1.1fr 0.9fr;
  gap:16px;
}
.astro-auth .panel{
  background:#11161dcc;
  border-radius:14px;
  border:1px solid #1f2a36;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  padding:16px 18px 18px;
  box-sizing:border-box;
}
.astro-auth .panel .head{
  font-size:.95rem;
  font-weight:800;
  color:#ffe084;
  padding-bottom:8px;
  margin-bottom:10px;
  border-bottom:1px solid #1f2a36;
}
.astro-auth .panel .body{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .row{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .spacer{
  height:4px;
}

/* è¾“å…¥æ¡† = è·Ÿ energy.html ä¸€æ ·å®½åº¦ */
.astro-auth input[type="email"],
.astro-auth input[type="password"]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #243244;
  background:#0e1520;
  color:#e8edf3;
  font-size:15px;
  box-sizing:border-box;
}
.astro-auth input[type="email"]::placeholder,
.astro-auth input[type="password"]::placeholder{
  color:#6f8092;
}
.astro-auth input[type="email"]:focus,
.astro-auth input[type="password"]:focus{
  outline:none;
  border-color:#d4af37;
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}

/* ç™»å½• / é‡è®¾ / æ³¨å†ŒæŒ‰é’® = å’Œè¾“å…¥æ¡†åŒå®½ï¼Œpill å½¢çŠ¶ */
.astro-auth .btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  max-width:100%;
  padding:11px 18px;
  border-radius:999px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  font-weight:800;
  text-align:center;
  box-shadow:0 6px 20px rgba(230,199,110,.35);
  white-space:nowrap;
  box-sizing:border-box;
  transition:.12s ease;
}
.astro-auth .btn.block{
  width:100%;
}

/* æ·±è‰²çš„ reset æŒ‰é’®æ ·å¼ */
.astro-auth .btn.ghost.block{
  background:#101826;
  border-color:#273245;
  color:#e8edf3;
  box-shadow:none;
}
.astro-auth .btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(230,199,110,.45);
}
.astro-auth .btn.ghost.block:hover{
  border-color:#d4af37;
  background:rgba(212,175,55,.08);
}

.error-message{
  color:#ff7b7b;
  font-size:.85rem;
}

/* å°å±ï¼šVIP åŒºã€ç™»å½•åŒºéƒ½ä¸€åˆ—æ’å¸ƒ */
@media (max-width:768px){
  .card.section .columns{
    grid-template-columns:1fr;
  }
  .astro-auth .auth-grid{
    grid-template-columns:1fr;
  }
}

  /* AI box (ç®¡å®¶æç¤ºå—) */
  .ai-box{
    background:#0b111a;
    border:1px solid #1f2a36;
    border-radius:12px;
    padding:14px 16px;
    margin:14px 0;
  }
  .ai-box-h{
    color:#ffd88a;
    font-weight:700;
    margin-bottom:8px;
  }
  .ai-box-c{
    color:#e8edf3;
    line-height:1.7;
  }

  /* Prompt chips */
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:12px;
  }
  .chip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #2a3546;
    background:#0e1520;
    color:#e8edf3;
    cursor:pointer;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  .chip:hover{
    border-color:#f2d27a;
    box-shadow:0 0 0 2px rgba(242,210,122,.15) inset;
  }
  .chip:disabled{
    opacity:.6;
    cursor:not-allowed;
  }
  .skeleton{
    display:grid;
    gap:8px;
  }
  .skeleton div{
    height:12px;
    border-radius:6px;
    background:linear-gradient(90deg,#1a2431,#1f2b3b,#1a2431);
    animation:sh 1.2s infinite;
  }
  @keyframes sh{
    0%{opacity:.5}
    50%{opacity:1}
    100%{opacity:.5}
  }
  .ai-lock-overlay{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid #1f2a36;
    text-align:center;
  }
  .ai-lock-overlay .tip{
    color:#ffd88a;
    font-weight:700;
    margin-bottom:4px;
  }
  .ai-lock-overlay .sub{
    color:var(--muted);
  }

  /* è¯¦æƒ…é¡µï¼ˆå¦‚æœä½ çš„ VIP æŠŠæŠ¥å‘Šå±•å¼€ç”¨è¿™ä¸ªï¼‰ */
  .detail-view{display:none}
  .detail-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:20px;
  }
  .back-btn{
    background:rgba(212,175,55,.1);
    border:1px solid rgba(212,175,55,.3);
    color:var(--gold2);
    padding:8px 16px;
    border-radius:8px;
    cursor:pointer;
  }
  .detail-content{line-height:1.8}
  .detail-section{margin-bottom:24px}
  .detail-section h4{
    color:var(--gold2);
    margin-bottom:12px;
    font-size:1.1rem;
  }
  .action-list{
    list-style:none;
    padding:0;
    margin:0;
  }
  .action-list li{
    margin-bottom:8px;
    padding-left:20px;
    position:relative;
  }
  .action-list li::before{
    content:"â€¢";
    color:var(--gold2);
    position:absolute;
    left:0;
    top:0;
  }

  /* é€šç”¨å°å·¥å…· */
  .sr-only{
    position:absolute !important;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  .chips-container{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:20px 0;
    justify-content:center;
  }

  /* ===== Xinlian Butler Floating Chat (é—®) ===== */

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}

  /* ä¸“ä¸šç‰ˆç®¡å®¶å— */
  .butler-professional{
    display:none;
    margin-top:20px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:20px;
  }
  .butler-header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:20px;
    color:var(--gold2);
    font-size:1.2rem;
    font-weight:700;
  }
  .butler-content{
    line-height:1.8;
    padding:15px;
    background:var(--surface);
    border-radius:10px;
    border:1px solid #253245;
  }
  .butler-section{
    margin-bottom:25px;
    padding-bottom:15px;
    border-bottom:1px solid #253245;
  }
  .butler-section h4{
    color:var(--gold2);
    margin-bottom:10px;
    font-size:1.1rem;
  }
  .butler-chat{
    margin-top:20px;
    border-top:1px solid var(--line);
    padding-top:15px;
  }
  .chat-messages{
    height:200px;
    overflow-y:auto;
    margin-bottom:15px;
    padding:10px;
    background:var(--surface);
    border-radius:8px;
    border:1px solid #253245;
  }
  .chat-input-area{
    display:flex;
    gap:10px;
  }
  .chat-input-area input{
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #253245;
    background:#0e1520;
    color:#e8edf3;
  }
  .chat-send-btn{
    padding:10px 20px;
    background:var(--gold);
    color:#191919;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
  }
</style>

</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>    
          <div class="title" data-i18n="site_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary</div>
    </a>
      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="th">à¹„à¸—à¸¢</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>
  
  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</option>
          <option value="compatibility" data-i18n="type_compat">åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <div class="time-row">
          <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
          <div class="time-unknown">
            <input type="checkbox" id="timeUnknown">
            <label for="timeUnknown">ä¸è¯¦</label>
          </div>
        </div>
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ -->
      <form id="reportForm" action="report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <div class="time-row">
            <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
            <div class="time-unknown">
              <input type="checkbox" id="timeUnknown2">
              <label for="timeUnknown2">ä¸è¯¦</label>
            </div>
          </div>
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="å‘½åæ”¹è¿" data-i18n="opt_rename">å‘½åæ”¹è¿</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
        </select>
      </div>
      <button class="btn" id="btnNext" type="button" data-i18n="btn_next">ç”Ÿæˆåˆ†æ</button>
    </section>

    <!-- å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®® - æ”¾åœ¨å‰é¢ -->
    <section class="card" id="result" style="display:none">
      <h2 style="margin:0 0 10px;color:var(--gold)" data-i18n="res_title">å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®</h2>
      <div id="butler-host"></div>
      <div id="rich-report"></div>
      <div id="xl-free-report"></div>
    </section>

    <!-- å¿ƒæ€œç©ºé—´åŠŸèƒ½å…¥å£ - æ”¾åœ¨å°¾ç«¯ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>

    <!-- ä¼šå‘˜åŒºåŸŸ -->
    <section class="card section">
      <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
      <div class="columns">
        <div class="list-block">
          <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
            <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
            <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
            <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
            <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
            <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
            <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
          </ul>
        </div>
        <div class="list-block">
          <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
          <ul>
            <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
            <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
            <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
            <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
            <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
          </ul>
        </div>
      </div>

      <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>
      <section class="astro-auth">
        <div class="auth-grid">
          <div class="panel">
            <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
      <div class="body">
        <!-- NEW: reveal button -->
        <div class="row one">
      </div>

        <div class="spacer"></div>

        <div class="row" id="authFields">
          <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username"
                 placeholder="é‚®ç®± Email" data-i18n-ph="ph_email"/>
      
          <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
          <input id="password" type="password" autocomplete="current-password"
                 placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰" data-i18n-ph="ph_password" required/>
        </div>

        <div class="spacer"></div>

        <form id="loginForm" class="row one">
          <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
        </form>

        <div class="spacer"></div>

        <div class="row one">
          <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
        </div>

        <div class="spacer"></div>

        <form class="row one" id="registerForm">
          <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
          <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
          <div class="spacer"></div>
          <div class="error-message" id="authError" style="display:none"></div>
        </form>
      </div>

          <div class="panel">
            <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
            <div class="body">
              <div class="row one">
                <a class="btn block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
              </div>
              <div class="spacer"></div>
              <div class="row one">
                <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
              </div>
              <div class="spacer"></div>
              <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
</body>
          
<!-- GPT / å¿ƒæ€œç®¡å®¶ï¼ˆç»Ÿä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat_fab">é—®</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ€œç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å†…å®¹åŒºï¼šä¿æŒä¸ºç©ºï¼Œæ¶ˆæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¾“å…¥é—®é¢˜â€¦"
      data-i18n-ph="chat_input_ph"
    />
    <button class="btn" id="chatSend" data-i18n="chat_send">å‘é€</button>
  </div>
</div>
<script>
'use strict';

/* ==============================
   CONFIG
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const DEFAULT_LANG = "zh-CN";

// ç¿»è¯‘å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼‰
const translations = {
  "zh-CN": {
    "page_title": "å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    "site_title": "å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    "lang_label": "è¯­è¨€",
    "form_title": "å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š",
    "choose_type": "é€‰æ‹©å‘½ç›˜ç±»å‹",
    "type_personal": "ä¸ªäººå‘½ç›˜",
    "type_compat": "åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰",
    "culture_auto": "è‡ªåŠ¨è¯†åˆ« Auto Detect",
    "culture_cn": "ä¸œæ–¹ Chinese / Bazi",
    "culture_west": "è¥¿æ–¹ Astrology / Tarot",
    "culture_jp": "æ—¥å¼ä¹æ˜Ÿ Japanese",
    "culture_vedic": "å°åº¦å é™€ Vedic",
    "self_info": "æœ¬äººèµ„æ–™",
    "ph_name1": "å§“åï¼ˆæœ¬äººï¼‰",
    "ph_time1": "å‡ºç”Ÿæ—¶é—´",
    "cal_g": "é˜³å† (Gregorian)",
    "cal_l": "å†œå† (Lunar)",
    "ph_country1": "å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    "btn_next": "ç”Ÿæˆåˆ†æ",
    "partner_info": "ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰",
    "ph_name2": "å§“åï¼ˆç¬¬äºŒäººï¼‰",
    "ph_time2": "å‡ºç”Ÿæ—¶é—´",
    "ph_country2": "å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    "focus_title": "å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰",
    "opt_love": "å§»ç¼˜ Love",
    "opt_dating": "æ‹çˆ±ç¼˜åˆ†",
    "opt_marriage": "å©šå§»èµ°åŠ¿",
    "opt_career": "äº‹ä¸š Career",
    "opt_work": "èŒåœºå‘å±•",
    "opt_startup": "åˆ›ä¸šæ½œåŠ›",
    "opt_wealth": "è´¢è¿ Wealth",
    "opt_wealthpos": "è´¢ä½åˆ†æ",
    "opt_timing": "ç†è´¢æ—¶æœº",
    "opt_dates": "æ‹©æ—¥ Auspicious Date",
    "opt_wedding": "å©šæœŸæ‹©æ—¥",
    "opt_babydate": "æ–°ç”Ÿå®å®æ‹©æ—¥",
    "opt_house": "æ–°å®¶å…¥ä½æ‹©æ—¥",
    "opt_office": "æ–°å…¬å¸å…¥ä½æ‹©æ—¥",
    "opt_name": "æµ‹å Name Analysis",
    "opt_babyname": "å®å®å",
    "opt_petname": "å® ç‰©å",
    "opt_companyname": "å…¬å¸å",
    "opt_rename": "å‘½åæ”¹è¿",
    "opt_fs": "é£æ°´ Feng Shui",
    "opt_home": "ä½å®¶",
    "opt_officefs": "åŠå…¬å®¤",
    "opt_comp": "åˆç›˜åˆ†æ Compatibility",
    "opt_couple": "æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰",
    "opt_spouse": "å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰",
    "opt_personality": "ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰",
    "opt_partner": "äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰",
    "opt_reconnect": "æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰",
    "opt_petbond": "å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰",
    "portal_title": "å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£",
    "diary_title": "ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°",
    "diary_desc": "ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰",
    "btn_personal": "ä¸ªäººéšè—è®°å½•",
    "btn_family": "å®¶åº­å…±äº«è®°å½•",
    "btn_upload": "ä¸Šä¼ è®°å½•",
    "course_title": "ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº",
    "course_bazi": "å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ",
    "course_tarot": "å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜",
    "course_coming": "ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦",
    "btn_enter_course": "è¿›å…¥è¯¾ç¨‹",
    "shop_title": "ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    "shop_desc": "ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š",
    "wish_title": "ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission",
    "btn_manifest": "æ¢¦æƒ³è§„åˆ’ / Manifestation",
    "memorial_title": "ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•",
    "memorial_desc": "çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰",
    "btn_login_memorial": "ç™»å…¥çµæ€§ç©ºé—´",
    "btn_upload_memorial": "ä¸Šä¼ å¾€ç”Ÿå½•",
    "btn_register_memorial": "æ³¨å†Œçµæ€§ç©ºé—´",
    "vip_title": "ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
    "vip_mingli": "ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
    "vip_love": "å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
    "vip_career": "äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
    "vip_wealth": "è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
    "vip_pet": "å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
    "vip_hepan": "åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    "vip_name": "æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
    "vip_fengshui": "è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
    "vip_xinlian": "ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
    "vip_record": "çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    "vip_course": "å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
    "vip_memorial": "å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
    "vip_tasks": "æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
    "vip_shop": "èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    "login_title": "ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
    "panel_login_head": "è´¦æˆ·ç™»å½• / æ³¨å†Œ",
    "ph_email": "é‚®ç®± Email",
    "ph_label_password": "å¯†ç  Password",
    "ph_password": "å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    "btn_login": "ç™»å…¥è´¦æˆ·",
    "btn_reset": "ğŸ”‘ é‡è®¾å¯†ç ",
    "btn_register": "æ³¨å†Œè´¦æˆ·",
    "note_price": "æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",
    "panel_member_head": "ä¼šå‘˜æœåŠ¡",
    "btn_upgrade": "ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
    "btn_backshop": "â† è¿”å›å‘½ç†å•†åŸ",
    "note_price1": "$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",
    "res_title": "å¿ƒæ€œç®¡å®¶è§£è¯»ä¸å»ºè®®",
    "chat_fab": "ğŸ’¬",
    "chat_placeholder": "è¾“å…¥æ‚¨çš„é—®é¢˜...",
    "chat_send": "å‘é€",
    "butler_title": "å¿ƒæ€œç®¡å®¶ Â· å»ºè®®",
    "elements_balance_tpl": "å…ƒç´ å¹³è¡¡ï¼šåå¼º {max} Â· åå¼± {min}",
    "btn_logout": "ç™»å‡º",
    "btn_upgrade_now": "ç«‹å³å‡çº§",
    "chat_title": "å¿ƒæ€œç®¡å®¶ Â· GPT",
    "chat_input_ph": "è¾“å…¥é—®é¢˜â€¦",
    "btn_show_login_fields": "æ˜¾ç¤ºç™»å½•æ ",
    "btn_hide_login_fields": "éšè—ç™»å½•æ ",
    "time_unknown": "ä¸è¯¦"
   },
      // å…¶ä»–è¯­è¨€å¯ä»¥åç»­æ·»åŠ 
      "en": {},
      "zh-TW": {},
      "ja": {},
      "th": {},
      "ms": {}
    };

// ============================================
// å·¥å…·å‡½æ•°
// ============================================
const $ = id => document.getElementById(id);
function ensureErrorBox(){
  let box = $('error');
  if (!box){
    box = document.createElement('div');
    box.id = 'error';
    box.className = 'error';
    box.style.cssText = 'margin-top:10px;color:#ff8b8b';
    (document.querySelector('.section') || document.body).appendChild(box);
  }
  return box;
}
function showErr(msg){ const e = ensureErrorBox(); e.textContent = msg; e.style.display = 'block'; setTimeout(()=>{ e.style.display='none'; }, 5000); }
function hideErr(){ const e = $('error'); if (e){ e.style.display='none'; e.textContent=''; } }
function setText(id, txt){ const el=$(id); if(el) el.textContent = (txt ?? ''); }
function setBar(el, pct){ if(!el) return; const v=Math.max(0,Math.min(100,Number(pct)||0)); el.style.width = v+'%'; el.setAttribute('aria-valuenow', String(Math.round(v))); }

// è¯­è¨€ç®¡ç†
const LANG_KEY = "5x_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){
  const lang = getLang();
  return (translations[lang] && translations[lang][key])
      || (translations["zh-CN"] && translations["zh-CN"][key])
      || key;
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{ const key = el.getAttribute("data-i18n"); el.textContent = t(key); });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{ const key = el.getAttribute("data-i18n-ph"); el.setAttribute("placeholder", t(key)); });
  const titleEl = document.querySelector("title[data-i18n]"); if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

// ============================================
// æ–‡åŒ–ç±»å‹åˆ°é€‰é¢˜æ˜ å°„
// ============================================
const culturePurposeMap = {
  'ä¸œæ–¹': { // Chinese Bazi
    personal: ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿', 'èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›', 'è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº', 'å©šæœŸæ‹©æ—¥', 'æ–°ç”Ÿå®å®æ‹©æ—¥', 'æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥', 'å®å®å', 'å® ç‰©å', 'å…¬å¸å', 'å‘½åæ”¹è¿', 'ä½å®¶', 'åŠå…¬å®¤'],
    compatibility: ['æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰', 'å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰', 'ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰', 'äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰', 'æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰', 'å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰']
  },
  'è¥¿æ–¹': { // Astrology/Tarot
    personal: ['çˆ±æƒ…è¿åŠ¿', 'èŒä¸šå‘å±•', 'è´¢å¯Œå¢é•¿', 'å¿ƒçµæˆé•¿', 'å¡”ç½—å åœ', 'æ˜Ÿç›˜è§£è¯»', 'äººé™…å…³ç³»', 'å¥åº·è¿åŠ¿'],
    compatibility: ['å…³ç³»åˆç›˜', 'çµé­‚ä¼´ä¾£', 'åˆä½œè¿åŠ¿', 'å®¶åº­å…³ç³»', 'å‹è°Šåˆ†æ']
  },
  'æ—¥å¼': { // Japanese
    personal: ['ä¹æ˜Ÿè¿åŠ¿', 'æ–¹ä½å‰å‡¶', 'å§“åé‰´å®š', 'æ‹çˆ±å åœ', 'èŒä¸šæŒ‡å—', 'å¥åº·å»ºè®®', 'å®¶ç›¸è¯Šæ–­'],
    compatibility: ['ç¼˜åˆ†åŒ¹é…', 'ç›¸æ€§è¯Šæ–­', 'åˆä½œç¼˜åˆ†', 'å®¶åº­å’Œè°']
  },
  'å é™€': { // Vedic
    personal: ['æœ¬å‘½ç›˜', 'äº‹ä¸šæ–¹å‘', 'å©šå§»è¿åŠ¿', 'å¥åº·å»ºè®®', 'æ‹©å‰æ—¥', 'å®çŸ³æ¨è', 'ä»ªå¼å»ºè®®'],
    compatibility: ['å¤«å¦»åˆç›˜', 'åˆä½œåŒ¹é…', 'å®¶åº­åˆç›˜', 'å•†ä¸šä¼™ä¼´']
  }
};

// ============================================
// è¡¨å•åˆ‡æ¢åŠŸèƒ½
// ============================================
function togglePartner(value){
  const section = $('partner-section');
  const personal = $('purpose_personal');
  const compat = $('purpose_compatibility');
  const show = (value === "compatibility");
  
  if (section) section.style.display = show ? "block" : "none";
  if (personal){ 
    personal.style.display = show ? "none" : "block"; 
    personal.disabled = show; 
  }
  if (compat){ 
    compat.style.display = show ? "block": "none"; 
    compat.disabled = !show; 
  }
  
  // æ›´æ–°é€‰é¢˜
  updatePurposeOptions($('culture').value);
}

// æ›´æ–°é€‰é¢˜é€‰é¡¹
function updatePurposeOptions(culture) {
  const cultureType = culture === 'auto' ? 'ä¸œæ–¹' : culture;
  const type = $('type').value; // 'personal' or 'compatibility'
  const config = culturePurposeMap[cultureType] || culturePurposeMap['ä¸œæ–¹'];
  
if (type === 'personal') {
  if (calculator.analysis){
    // IMPORTANT: generateBaziReport expects {pillars, percents, focus}
    if (culture === "ä¸œæ–¹") {
      reportContent = calculator.analysis({
        pillars: data?.pillars,
        percents: data?.percents,
        focus: focusArea || ""
      });
    } else {
      // for other systems you may keep their generator style
      reportContent = calculator.analysis(data, focusArea);
    }
  } else {
    reportContent = `<p>${culture}å‘½ç†åˆ†ææ­£åœ¨ç”Ÿæˆä¸­...</p>`;
  }
} else {
  reportContent = generateCompatibilityReport(data, culture, focusArea);
}

// æ›´æ–°ä¸ªäººå‘½ç›˜é€‰é¢˜
function updatePersonalPurposeOptions(options) {
  const select = $('purpose_personal');
  if (!select) return;
  
  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
  const currentValue = select.value;
  
  // æ¸…ç©ºé€‰é¡¹
  select.innerHTML = '';
  
  // åˆ†ç»„å®šä¹‰
  const groups = {
    'å§»ç¼˜ Love': ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿'],
    'äº‹ä¸š Career': ['èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›'],
    'è´¢è¿ Wealth': ['è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº'],
    'æ‹©æ—¥ Auspicious Date': ['å©šæœŸæ‹©æ—¥', 'æ–°ç”Ÿå®å®æ‹©æ—¥', 'æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥'],
    'æµ‹å Name Analysis': ['å®å®å', 'å® ç‰©å', 'å…¬å¸å', 'å‘½åæ”¹è¿'],
    'é£æ°´ Feng Shui': ['ä½å®¶', 'åŠå…¬å®¤']
  };
  
  // æŒ‰æ–‡åŒ–è¿‡æ»¤å¹¶æ·»åŠ é€‰é¡¹
  Object.entries(groups).forEach(([label, items]) => {
    const availableItems = items.filter(item => options.includes(item));
    if (availableItems.length > 0) {
      const optgroup = document.createElement('optgroup');
      optgroup.label = label;
      availableItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        optgroup.appendChild(option);
      });
      select.appendChild(optgroup);
    }
  });
  
  // æ¢å¤é€‰ä¸­çŠ¶æ€
  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  }
}

// æ›´æ–°åˆç›˜é€‰é¢˜
function updateCompatibilityPurposeOptions(options) {
  const select = $('purpose_compatibility');
  if (!select) return;
  
  // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
  const currentValue = select.value;
  
  // æ¸…ç©ºé€‰é¡¹
  select.innerHTML = '';
  
  const optgroup = document.createElement('optgroup');
  optgroup.label = 'åˆç›˜åˆ†æ Compatibility';
  
  options.forEach(item => {
    const option = document.createElement('option');
    option.value = item;
    option.textContent = item;
    optgroup.appendChild(option);
  });
  
  select.appendChild(optgroup);
  
  // æ¢å¤é€‰ä¸­çŠ¶æ€
  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  }
}

// ============================================
// å…«å­—è®¡ç®—å™¨
// ============================================
const baziCalculator = {
  heavenlyStems: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
  earthlyBranches: ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'],
  
  calculateYearPillar: function(year) {
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    return { 
      stem: this.heavenlyStems[stemIndex], 
      branch: this.earthlyBranches[branchIndex], 
      element: this.getStemElement(this.heavenlyStems[stemIndex])
    };
  },
  
  calculateMonthPillar: function(year, month, day) {
    // ç®€åŒ–ç‰ˆï¼šæ ¹æ®æœˆä»½è¿”å›å›ºå®šæœˆæŸ±
    const monthMap = { 
      1: { stem: 'ä¸™', branch: 'å¯…' }, 2: { stem: 'ä¸', branch: 'å¯' }, 
      3: { stem: 'æˆŠ', branch: 'è¾°' }, 4: { stem: 'å·±', branch: 'å·³' }, 
      5: { stem: 'åºš', branch: 'åˆ' }, 6: { stem: 'è¾›', branch: 'æœª' }, 
      7: { stem: 'å£¬', branch: 'ç”³' }, 8: { stem: 'ç™¸', branch: 'é…‰' }, 
      9: { stem: 'ç”²', branch: 'æˆŒ' }, 10: { stem: 'ä¹™', branch: 'äº¥' }, 
      11: { stem: 'ä¸™', branch: 'å­' }, 12: { stem: 'ä¸', branch: 'ä¸‘' } 
    };
    const pillar = monthMap[month] || monthMap[1];
    return { 
      stem: pillar.stem, 
      branch: pillar.branch, 
      element: this.getStemElement(pillar.stem)
    };
  },
  
  calculateDayPillar: function(year, month, day) {
    // ç®€åŒ–è®¡ç®—ï¼šåŸºäº1900å¹´1æœˆ1æ—¥ä¸ºç”²å­æ—¥
    const date = new Date(year, month - 1, day);
    const startDate = new Date(1900, 0, 1);
    const dayNum = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
    const stemIndex = dayNum % 10;
    const branchIndex = dayNum % 12;
    return { 
      stem: this.heavenlyStems[stemIndex], 
      branch: this.earthlyBranches[branchIndex],
      element: this.getStemElement(this.heavenlyStems[stemIndex])
    };
  },
  
  calculateHourPillar: function(dayStem, hour) {
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    // ç®€åŒ–çš„æ—¶æŸ±è®¡ç®—
    const startStems = { 'ç”²': 'ç”²', 'ä¹™': 'ä¸™', 'ä¸™': 'æˆŠ', 'ä¸': 'åºš', 'æˆŠ': 'å£¬', 
                       'å·±': 'ç”²', 'åºš': 'ä¸™', 'è¾›': 'æˆŠ', 'å£¬': 'åºš', 'ç™¸': 'å£¬' };
    const stem = startStems[dayStem] || 'ç”²';
    return { 
      stem: stem, 
      branch: this.earthlyBranches[hourIndex],
      element: this.getStemElement(stem)
    };
  },
  
  getStemElement: function(stem) {
    const elementMap = {
      'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«',
      'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘',
      'å£¬': 'æ°´', 'ç™¸': 'æ°´'
    };
    return elementMap[stem] || 'æœ¨';
  },
  
  getBranchElement: function(branch) {
    const elementMap = {
      'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨',
      'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ',
      'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
    };
    return elementMap[branch] || 'æœ¨';
  },
  
  calculateBazi: function(year, month, day, hour, timeUnknown) {
    const pillars = {
      year: this.calculateYearPillar(year),
      month: this.calculateMonthPillar(year, month, day),
      day: this.calculateDayPillar(year, month, day),
      hour: timeUnknown ? { stem: '?', branch: '?', element: 'æœªçŸ¥' } : this.calculateHourPillar(this.calculateDayPillar(year, month, day).stem, hour)
    };
    
    // è®¡ç®—äº”è¡Œç™¾åˆ†æ¯”
    const elements = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
    
    // ç»Ÿè®¡å¤©å¹²åœ°æ”¯äº”è¡Œ
    Object.values(pillars).forEach(pillar => {
      if (pillar.element && pillar.element !== 'æœªçŸ¥') {
        elements[pillar.element] += 3;
      }
      if (pillar.branch && pillar.branch !== '?') {
        const branchElement = this.getBranchElement(pillar.branch);
        elements[branchElement] += 2;
      }
    });
    
    // è½¬æ¢ä¸ºç™¾åˆ†æ¯”
    const total = Object.values(elements).reduce((a, b) => a + b, 0);
    const percents = {
      wood: Math.round((elements['æœ¨'] / total) * 100),
      fire: Math.round((elements['ç«'] / total) * 100),
      earth: Math.round((elements['åœŸ'] / total) * 100),
      metal: Math.round((elements['é‡‘'] / total) * 100),
      water: Math.round((elements['æ°´'] / total) * 100)
    };
    
    return { pillars, percents, timeUnknown };
  }
};

// ============================================
// å…¶ä»–æ–‡åŒ–è®¡ç®—å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ============================================
const calculators = {
  'ä¸œæ–¹': {
    name: 'å…«å­—å‘½ç†',
    calculate: (year, month, day, hour, timeUnknown) => {
      return baziCalculator.calculateBazi(year, month, day, hour, timeUnknown);
    },
    render: renderBaziReport,
    analysis: generateBaziReport
  },
  'è¥¿æ–¹': {
    name: 'è¥¿æ´‹å æ˜Ÿ',
    calculate: (year, month, day, hour, timeUnknown) => {
      // ç®€åŒ–å æ˜Ÿè®¡ç®—
      const zodiacSigns = [
        'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§', 'ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§',
        'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§', 'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§'
      ];
      const signIndex = (month - 1) % 12;
      
      return {
        zodiac: zodiacSigns[signIndex],
        rising: timeUnknown ? 'æœªçŸ¥' : ['ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§', 'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§', 
                                       'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§'][hour % 12],
        moon: ['å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§', 'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§',
               'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§', 'ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§'][day % 12],
        elements: { fire: 30, earth: 25, air: 25, water: 20 }
      };
    },
    render: renderWesternReport,
    analysis: generateWesternReport
  },
  'æ—¥å¼': {
    name: 'ä¹æ˜Ÿæ°—å­¦',
    calculate: (year, month, day, hour, timeUnknown) => {
      // ç®€åŒ–ä¹æ˜Ÿè®¡ç®—
      const numbers = ['ä¸€ç™½æ°´æ˜Ÿ', 'äºŒé»’åœŸæ˜Ÿ', 'ä¸‰ç¢§æœ¨æ˜Ÿ', 'å››ç·‘æœ¨æ˜Ÿ', 
                       'äº”é»„åœŸæ˜Ÿ', 'å…­ç™½é‡‘æ˜Ÿ', 'ä¸ƒèµ¤é‡‘æ˜Ÿ', 'å…«ç™½åœŸæ˜Ÿ', 'ä¹ç´«ç«æ˜Ÿ'];
      const starIndex = (year + month + day) % 9;
      
      return {
        number: numbers[starIndex],
        element: ['æ°´', 'åœŸ', 'æœ¨', 'æœ¨', 'åœŸ', 'é‡‘', 'é‡‘', 'åœŸ', 'ç«'][starIndex],
        direction: ['åŒ—', 'è¥¿å—', 'æ±', 'æ±å—', 'ä¸­å¤®', 'è¥¿åŒ—', 'è¥¿', 'æ±åŒ—', 'å—'][starIndex],
        luck: ['å‰', 'å‡¶', 'å‰', 'å‰', 'å‡¶', 'å‰', 'å‰', 'å‰', 'å‰'][starIndex]
      };
    },
    render: renderJapaneseReport,
    analysis: generateJapaneseReport
  },
  'å é™€': {
    name: 'å°åº¦å é™€',
    calculate: (year, month, day, hour, timeUnknown) => {
      // ç®€åŒ–å é™€è®¡ç®—
      const rashis = ['Mesha', 'Vrishabha', 'Mithuna', 'Karka', 'Simha', 'Kanya',
                      'Tula', 'Vrishchika', 'Dhanu', 'Makara', 'Kumbha', 'Meena'];
      const rashiIndex = (month - 1) % 12;
      
      return {
        rashi: rashis[rashiIndex],
        nakshatra: ['Ashwini', 'Bharani', 'Krittika', 'Rohini', 'Mrigashira', 'Ardra',
                    'Punarvasu', 'Pushya', 'Ashlesha', 'Magha', 'Purva Phalguni', 'Uttara Phalguni'][day % 12],
        element: ['ç«', 'åœŸ', 'é¢¨', 'æ°´', 'ç«', 'åœŸ', 'é¢¨', 'æ°´', 'ç«', 'åœŸ', 'é¢¨', 'æ°´'][rashiIndex]
      };
    },
    render: renderVedicReport,
    analysis: generateVedicReport
  }
};

// ============================================
// æŠ¥å‘Šæ¸²æŸ“å‡½æ•°
// ============================================
// å…«å­—æŠ¥å‘Šæ¸²æŸ“
function renderBaziReport(result, info) {
  const { pillars, percents, timeUnknown } = result;
  const { year, month, day, hour } = info;
  
  // ç¡®ä¿ç»“æœåŒºåŸŸå­˜åœ¨
  $('result').style.display = 'block';
  ensureResultHost();
  
  // æ¸²æŸ“å…«å­—ä¿¡æ¯
  const timeText = timeUnknown ? 'æ—¶é—´ä¸è¯¦' : `${hour}æ—¶`;
  setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
  renderPillars($('bazi-pillars'), pillars, timeUnknown);
  
  // æ¸²æŸ“äº”è¡Œç™¾åˆ†æ¯”
  setBar($('bar-æœ¨'), percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
  setBar($('bar-ç«'), percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
  setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
  setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
  setBar($('bar-æ°´'), percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');
  
  // åˆ†æäº”è¡Œå¹³è¡¡
  const elements = [
    { name: 'æœ¨', value: percents.wood },
    { name: 'ç«', value: percents.fire },
    { name: 'åœŸ', value: percents.earth },
    { name: 'é‡‘', value: percents.metal },
    { name: 'æ°´', value: percents.water }
  ];
  elements.sort((a, b) => b.value - a.value);
  setText('bazi-elements-balance', `å…ƒç´ å¹³è¡¡ï¼š${elements[0].name}åå¼º (${elements[0].value}%) Â· ${elements[4].name}åå¼± (${elements[4].value}%)`);
}

// æ¸²æŸ“å…«å­—æŸ±
function renderPillars(root, p, timeUnknown=false){
  if(!root) return; 
  root.innerHTML='';
  
  [['å¹´æŸ±',p.year], ['æœˆæŸ±',p.month], ['æ—¥æŸ±',p.day], ['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const isUnknown = (tit==='æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;
    
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
      ${v.element && v.element !== 'æœªçŸ¥' ? `<div style="color:#98a7b7;font-size:.75rem;margin-top:4px">${v.element}</div>` : ''}
    `;
    root.appendChild(div);
  });
}

// ç¡®ä¿ç»“æœåŒºåŸŸç»“æ„
function ensureResultHost(){
  let result = $('result');
  if (!result) return null;
  
  // ç¡®ä¿å…«å­—æŠ¥å‘Šç»“æ„å­˜åœ¨
  if (!document.getElementById('xl-free-report')){
    const free = document.createElement('div');
    free.id = 'xl-free-report';
    free.innerHTML = `
      <div class="card" style="margin-top:8px">
        <div class="h2">å‘½ç†ç®€æŠ¥</div>
        <div id="bazi-date" class="sub" style="margin-bottom:8px"></div>
        <div id="bazi-pillars" class="pillars"></div>
        <div class="row cols-5" style="align-items:center;margin-top:10px">
          <div><div>æœ¨</div><div class="bar"><i id="bar-æœ¨"></i></div><div id="pct-æœ¨" class="muted" style="margin-top:4px"></div></div>
          <div><div>ç«</div><div class="bar"><i id="bar-ç«"></i></div><div id="pct-ç«" class="muted" style="margin-top:4px"></div></div>
          <div><div>åœŸ</div><div class="bar"><i id="bar-åœŸ"></i></div><div id="pct-åœŸ" class="muted" style="margin-top:4px"></div></div>
          <div><div>é‡‘</div><div class="bar"><i id="bar-é‡‘"></i></div><div id="pct-é‡‘" class="muted" style="margin-top:4px"></div></div>
          <div><div>æ°´</div><div class="bar"><i id="bar-æ°´"></i></div><div id="pct-æ°´" class="muted" style="margin-top:4px"></div></div>
        </div>
        <div id="bazi-elements-balance" class="sub" style="margin-top:8px"></div>
      </div>
    `;
    result.appendChild(free);
  }
  
  return result;
}

// è¥¿æ–¹å æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderWesternReport(result, info) {
  $('result').style.display = 'block';
  const host = $('butler-host') || $('result');
  
  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>è¥¿æ´‹å æ˜ŸæŠ¥å‘Š</h3>
    <p><strong>å¤ªé˜³æ˜Ÿåº§ï¼š</strong>${result.zodiac}</p>
    <p><strong>ä¸Šå‡æ˜Ÿåº§ï¼š</strong>${result.rising}</p>
    <p><strong>æœˆäº®æ˜Ÿåº§ï¼š</strong>${result.moon}</p>
    <div class="row cols-4" style="margin-top:15px">
      <div><div>ç«å…ƒç´ </div><div class="bar"><i style="width:${result.elements.fire}%"></i></div><div class="muted">${result.elements.fire}%</div></div>
      <div><div>åœŸå…ƒç´ </div><div class="bar"><i style="width:${result.elements.earth}%"></i></div><div class="muted">${result.elements.earth}%</div></div>
      <div><div>é£å…ƒç´ </div><div class="bar"><i style="width:${result.elements.air}%"></i></div><div class="muted">${result.elements.air}%</div></div>
      <div><div>æ°´å…ƒç´ </div><div class="bar"><i style="width:${result.elements.water}%"></i></div><div class="muted">${result.elements.water}%</div></div>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// æ—¥å¼ä¹æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderJapaneseReport(result, info) {
  $('result').style.display = 'block';
  const host = $('butler-host') || $('result');
  
  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>æ—¥å¼ä¹æ˜ŸæŠ¥å‘Š</h3>
    <div style="text-align:center;padding:20px">
      <div style="font-size:2.5rem;color:var(--gold2);font-weight:800">${result.number}</div>
      <div style="margin-top:10px">
        <span class="chip">${result.element}å…ƒç´ </span>
        <span class="chip">${result.direction}æ–¹ä½</span>
        <span class="chip">${result.luck}é‹</span>
      </div>
      <p style="margin-top:15px">æœ¬å‘½æ˜Ÿå½±å“æ‚¨çš„æ€§æ ¼ç‰¹è´¨å’Œè¿åŠ¿èµ°å‘</p>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// å é™€å æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderVedicReport(result, info) {
  $('result').style.display = 'block';
  const host = $('butler-host') || $('result');
  
  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>å°åº¦å é™€æŠ¥å‘Š</h3>
    <p><strong>æœ¬å‘½æ˜Ÿåº§ (Rashi)ï¼š</strong>${result.rashi}</p>
    <p><strong>æœˆå®¿ (Nakshatra)ï¼š</strong>${result.nakshatra}</p>
    <p><strong>ä¸»å¯¼å…ƒç´ ï¼š</strong>${result.element}</p>
    <div style="margin-top:15px;padding:15px;background:rgba(212,175,55,0.1);border-radius:10px">
      <p><small>æ ¹æ®å é™€å æ˜Ÿå­¦ï¼Œæ‚¨çš„å‘½ç›˜æ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„èƒ½é‡ç‰¹è´¨ã€‚</small></p>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// ============================================
// æŠ¥å‘Šç”Ÿæˆå‡½æ•°
// ============================================
// å…«å­—æŠ¥å‘Šç”Ÿæˆ
function generateBaziReport({ pillars, percents, focus = "" } = {}) {
  pillars = pillars || {};
  percents = percents || { wood:0, fire:0, earth:0, metal:0, water:0 };

  const dayStem = pillars?.day?.stem || "ç”²";
  const dayBranch = pillars?.day?.branch || "å­";
  
  // äº”è¡Œåˆ†æ
  const elements = [
    { name: 'æœ¨', value: percents.wood },
    { name: 'ç«', value: percents.fire },
    { name: 'åœŸ', value: percents.earth },
    { name: 'é‡‘', value: percents.metal },
    { name: 'æ°´', value: percents.water }
  ];
  elements.sort((a, b) => b.value - a.value);
  const strongest = elements[0];
  const weakest = elements[elements.length - 1];
  
  // æ—¥ä¸»åˆ†æ
  const dayMasterAnalysis = {
    'ç”²': 'å¦‚å‚å¤©å¤§æ ‘ï¼Œæ­£ç›´ä»å¾·ï¼Œé¢†å¯¼åŠ›å¼ºï¼Œåœ¨å›¢é˜Ÿä¸­å¸¸æ‰®æ¼”æ”¯æŸ±è§’è‰²ã€‚',
    'ä¹™': 'å¦‚è—¤è”“èŠ±è‰ï¼ŒæŸ”éŸ§é€‚åº”ï¼Œå–„äºåˆä½œï¼Œäººé™…å…³ç³»å’Œè°é¡ºç•…ã€‚',
    'ä¸™': 'å¦‚å¤ªé˜³ä¹‹ç«ï¼Œçƒ­æƒ…å¼€æœ—ï¼Œæ„ŸæŸ“åŠ›å¼ºï¼Œå¤©ç”Ÿå…·æœ‰å¸å¼•åŠ›ã€‚',
    'ä¸': 'å¦‚ç¯çƒ›ä¹‹ç«ï¼Œç»†è…»èªæ…§ï¼Œè§‚å¯Ÿå…¥å¾®ï¼Œå¿ƒæ€ç¼œå¯†æœ‰è°‹ç•¥ã€‚',
    'æˆŠ': 'å¦‚åŸå¢™ä¹‹åœŸï¼Œç¨³é‡è¯šä¿¡ï¼Œè´£ä»»å¿ƒå¼ºï¼Œå€¼å¾—ä¿¡èµ–çš„ä¼™ä¼´ã€‚',
    'å·±': 'å¦‚ç”°å›­ä¹‹åœŸï¼ŒåŒ…å®¹æ»‹å…»ï¼Œå–„äºåè°ƒï¼Œå…·æœ‰è°ƒè§£æ‰èƒ½ã€‚',
    'åºš': 'å¦‚åˆ€å‰‘ä¹‹é‡‘ï¼Œåˆšæ¯…æœæ–­ï¼ŒåŸåˆ™æ€§å¼ºï¼Œæ‰§è¡ŒåŠ›å“è¶Šã€‚',
    'è¾›': 'å¦‚ç å®ä¹‹é‡‘ï¼Œç²¾è‡´æ•é”ï¼Œè¿½æ±‚å®Œç¾ï¼Œæ³¨é‡ç»†èŠ‚å“è´¨ã€‚',
    'å£¬': 'å¦‚æ±Ÿæ²³ä¹‹æ°´ï¼Œæ™ºæ…§æµåŠ¨ï¼Œé€‚åº”åŠ›å¼ºï¼Œæ€ç»´çµæ´»å¤šå˜ã€‚',
    'ç™¸': 'å¦‚é›¨éœ²ä¹‹æ°´ï¼Œç»†è…»æ•æ„Ÿï¼Œç›´è§‰åŠ›å¼ºï¼Œæƒ…æ„Ÿä¸°å¯Œæ·±åˆ»ã€‚'
  };
  
  const dayMasterDesc = dayMasterAnalysis[dayStem] || 'å…·æœ‰ç‹¬ç‰¹çš„å‘½ç†ç‰¹è´¨å’Œæ½œèƒ½ã€‚';
  
  let focusAnalysis = '';
  
  // æ ¹æ®ä¸åŒé€‰é¢˜ç”Ÿæˆå…·ä½“åˆ†æ
  if (focus.includes('æ‹çˆ±') || focus.includes('å§»ç¼˜') || focus.includes('çˆ±æƒ…')) {
    focusAnalysis = generateLoveAnalysis(dayStem, strongest, dayBranch);
  } else if (focus.includes('äº‹ä¸š') || focus.includes('èŒåœº') || focus.includes('åˆ›ä¸š') || focus.includes('èŒä¸š')) {
    focusAnalysis = generateCareerAnalysis(dayStem, strongest, pillars.month.branch);
  } else if (focus.includes('è´¢è¿') || focus.includes('è´¢å¯Œ') || focus.includes('ç†è´¢')) {
    focusAnalysis = generateWealthAnalysis(dayStem, strongest, pillars.year.stem);
  } else if (focus.includes('é£æ°´') || focus.includes('ä½å®¶') || focus.includes('åŠå…¬å®¤')) {
    focusAnalysis = generateFengShuiAnalysis(dayStem, pillars);
  } else {
    focusAnalysis = generateGeneralAnalysis(dayStem, strongest, weakest);
  }
  
  return `
    <h4>ğŸ“Š å‘½ç†æ ¸å¿ƒåˆ†æ</h4>
    <p><strong>æ—¥ä¸»ç‰¹è´¨ï¼š</strong>æ‚¨çš„æ—¥æŸ±ä¸º <span style="color: var(--gold2); font-weight: 600">${dayStem}${dayBranch}</span>ï¼Œä»£è¡¨æ‚¨è‡ªèº«çš„æ ¸å¿ƒèƒ½é‡ã€‚${dayMasterDesc}</p>
    
    <p><strong>äº”è¡Œå¹³è¡¡ï¼š</strong>å‘½ç›˜ä¸­ï¼Œ<span style="color: #7bc47f">${strongest.name}å…ƒç´ ï¼ˆ${strongest.value}%ï¼‰</span>æœ€ä¸ºæ—ºç››ï¼Œ
    <span style="color: #ff8b8b">${weakest.name}å…ƒç´ ï¼ˆ${weakest.value}%ï¼‰</span>ç›¸å¯¹è¾ƒå¼±ã€‚${getElementBalanceAdvice(strongest.name, weakest.name)}</p>
    
    ${focusAnalysis}
    
    <h4>ğŸ¯ è¿‘æœŸè¿åŠ¿æé†’</h4>
    <p>${getRecentFortune(dayStem, pillars.month.branch)}</p>
    
    <div style="margin-top: 20px; padding: 15px; background: rgba(212, 175, 55, 0.08); border-radius: 10px; border-left: 3px solid var(--gold);">
      <strong style="color: var(--gold2);">âœ¨ å¿ƒçµå¯„è¯­ï¼š</strong>
      <p style="margin-top: 5px; font-style: italic;">"${getInspirationalQuote(dayStem)}"</p>
    </div>
  `;
}

// ============================================
// è¾…åŠ©å‡½æ•°
// ============================================
function getElementBalanceAdvice(strongest, weakest) {
  const adviceMap = {
    'æœ¨': {
      'ç«': 'æœ¨ç”Ÿç«ï¼Œç²¾åŠ›æ—ºç››åˆ›é€ åŠ›å¼ºï¼Œä½†éœ€æ³¨æ„ä¼‘æ¯é¿å…è€—æŸã€‚',
      'åœŸ': 'æœ¨å…‹åœŸï¼Œè¡ŒåŠ¨åŠ›å¼ºç›®æ ‡æ˜ç¡®ï¼Œä½†éœ€è€å¿ƒæ·±è€•ç»†ä½œã€‚',
      'é‡‘': 'é‡‘å…‹æœ¨ï¼Œå‹åŠ›æŒ‘æˆ˜è¾ƒå¤šï¼Œéœ€è°ƒèŠ‚æƒ…ç»ªä¿æŒéŸ§æ€§ã€‚',
      'æ°´': 'æ°´ç”Ÿæœ¨ï¼Œæˆé•¿é¡ºåˆ©èµ„æºå……è¶³ï¼Œä½†éœ€æ˜ç¡®æ–¹å‘ä¸“æ³¨ç›®æ ‡ã€‚'
    },
    'ç«': {
      'åœŸ': 'ç«ç”ŸåœŸï¼Œçƒ­æƒ…ç¨³å®šæ„ŸæŸ“åŠ›å¼ºï¼Œä½†éœ€æŒä¹…åšæŒé¿å…ä¸‰åˆ†é’Ÿçƒ­åº¦ã€‚',
      'é‡‘': 'ç«å…‹é‡‘ï¼Œæœæ–­å†³ç»æ‰§è¡ŒåŠ›å¼ºï¼Œä½†éœ€è°¨æ…å†³ç­–é¿å…å†²åŠ¨ã€‚',
      'æ°´': 'æ°´å…‹ç«ï¼Œæ¿€æƒ…æ˜“å—å¤–ç•Œå½±å“ï¼Œéœ€ä¿æŒå†…åœ¨åŠ¨åŠ›åšå®šä¿¡å¿µã€‚',
      'æœ¨': 'æœ¨ç”Ÿç«ï¼Œèµ„æºæ”¯æŒå……è¶³ï¼Œéœ€å–„ç”¨æœºä¼šå‘æŒ¥æ½œèƒ½ã€‚'
    },
    'åœŸ': {
      'é‡‘': 'åœŸç”Ÿé‡‘ï¼ŒåŸºç¡€æ‰å®å–„äºç§¯ç´¯ï¼Œç¨³æ‰ç¨³æ‰“ç»ˆæœ‰æ”¶è·ã€‚',
      'æ°´': 'åœŸå…‹æ°´ï¼Œç¨³é‡åŠ¡å®è®¡åˆ’æ€§å¼ºï¼Œä½†éœ€çµæ´»å˜é€šé€‚åº”å˜åŒ–ã€‚',
      'æœ¨': 'æœ¨å…‹åœŸï¼Œå‹åŠ›è´£ä»»è¾ƒé‡ï¼Œéœ€å¢å¼ºæŠ—å‹èƒ½åŠ›ä¿æŒå¹³è¡¡ã€‚',
      'ç«': 'ç«ç”ŸåœŸï¼Œå¤–éƒ¨æ”¯æŒå……è¶³ï¼Œéœ€ä¸»åŠ¨äº‰å–æŠŠæ¡æœºé‡ã€‚'
    },
    'é‡‘': {
      'æ°´': 'é‡‘ç”Ÿæ°´ï¼Œæ™ºæ…§æµåŠ¨å–„äºæ²Ÿé€šï¼Œç†æ€§åˆ†æç»“åˆç›´è§‰åˆ¤æ–­ã€‚',
      'æœ¨': 'é‡‘å…‹æœ¨ï¼Œæ‰§è¡ŒåŠ›å¼ºæ•ˆç‡é«˜ï¼Œä½†éœ€æ¸©å’Œæ²Ÿé€šé¿å…å†²çªã€‚',
      'ç«': 'ç«å…‹é‡‘ï¼Œæ˜“å—æŒ‘æˆ˜è€ƒéªŒï¼Œéœ€ä¿æŒåšéŸ§å±•ç°çœŸé‡‘æœ¬è‰²ã€‚',
      'åœŸ': 'åœŸç”Ÿé‡‘ï¼ŒåŸºç¡€è‰¯å¥½èµ„æºä¸°å¯Œï¼Œéœ€ç§¯æå‘æŒ¥å–„ç”¨ä¼˜åŠ¿ã€‚'
    },
    'æ°´': {
      'æœ¨': 'æ°´ç”Ÿæœ¨ï¼Œå–„äºæ»‹å…»æ”¯æŒä»–äººï¼Œä½†éœ€æ˜ç¡®è‡ªèº«æ–¹å‘ç›®æ ‡ã€‚',
      'ç«': 'æ°´å…‹ç«ï¼Œå†·é™ç†æ€§æ€ç»´æ¸…æ™°ï¼Œä½†éœ€é€‚æ—¶å±•ç°çƒ­æƒ…æ´»åŠ›ã€‚',
      'åœŸ': 'åœŸå…‹æ°´ï¼Œæ˜“é‡é˜»ç¢é™åˆ¶ï¼Œéœ€åšæŒä¿¡å¿µçµæ´»åº”å¯¹ã€‚',
      'é‡‘': 'é‡‘ç”Ÿæ°´ï¼Œèµ„æºæ™ºæ…§ä¸°å¯Œï¼Œéœ€å–„ç”¨å¤©èµ‹åˆ›é€ ä»·å€¼ã€‚'
    }
  };
  
  return adviceMap[strongest]?.[weakest] || 'äº”è¡Œéœ€è¦å¹³è¡¡è°ƒå’Œï¼Œæ‰¬é•¿é¿çŸ­å‘æŒ¥ä¼˜åŠ¿ã€‚';
}

function getRecentFortune(dayStem, monthBranch) {
  const fortunes = {
    'ç”²': 'è¿‘æœŸæœ‰æ–°çš„å¼€å§‹æœºä¼šï¼Œé€‚åˆè§„åˆ’é•¿æœŸç›®æ ‡ï¼Œæ³¨æ„äººé™…å…³ç³»ç»´æŠ¤ã€‚',
    'ä¹™': 'åˆä½œæœºä¼šå¢å¤šï¼Œé€‚åˆå»ºç«‹äººè„‰ç½‘ç»œï¼Œæ³¨æ„ç»†èŠ‚å¤„ç†ã€‚',
    'ä¸™': 'èƒ½é‡å……æ²›æ´»åŠ›å¼ºï¼Œé€‚åˆä¸»åŠ¨å‡ºå‡»ï¼Œæ³¨æ„æƒ…ç»ªç®¡ç†ã€‚',
    'ä¸': 'æ€ç»´æ•æ·çµæ„Ÿå¤šï¼Œé€‚åˆå­¦ä¹ ç ”ç©¶ï¼Œæ³¨æ„å®è·µè½å®ã€‚',
    'æˆŠ': 'ç¨³å®šå‘å±•æ—¶æœºï¼Œé€‚åˆå·©å›ºåŸºç¡€ï¼Œæ³¨æ„æœºä¼šæŠŠæ¡ã€‚',
    'å·±': 'è°ƒå’Œå…³ç³»çš„å¥½æ—¶æœºï¼Œé€‚åˆæ²Ÿé€šåè°ƒï¼Œæ³¨æ„ç«‹åœºåšå®šã€‚',
    'åºš': 'é¢ä¸´é€‰æ‹©å†³ç­–ï¼Œéœ€ç†æ€§åˆ†æï¼Œæ³¨æ„å¹³è¡¡å„æ–¹åˆ©ç›Šã€‚',
    'è¾›': 'è¿½æ±‚å®Œç¾ç»†èŠ‚ï¼Œé€‚åˆç²¾è¿›æŠ€èƒ½ï¼Œæ³¨æ„å¤§å±€è§‚å¿µã€‚',
    'å£¬': 'å˜åŒ–æµåŠ¨æ—¶æœŸï¼Œéœ€çµæ´»é€‚åº”ï¼Œæ³¨æ„ä¿æŒæ ¸å¿ƒç¨³å®šã€‚',
    'ç™¸': 'æ„Ÿæ€§ç›´è§‰å¢å¼ºï¼Œé€‚åˆè‰ºæœ¯åˆ›ä½œï¼Œæ³¨æ„ç†æ€§åˆ¤æ–­ã€‚'
  };
  return fortunes[dayStem] || 'è¿‘æœŸè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆè§„åˆ’æœªæ¥å‘å±•æ–¹å‘ã€‚';
}

function getInspirationalQuote(dayStem) {
  const quotes = {
    'ç”²': 'å‚å¤©å¤§æ ‘å§‹äºå¹¼è‹—ï¼Œä¼Ÿå¤§æˆå°±æºäºåšæŒã€‚',
    'ä¹™': 'æŸ”èƒ½å…‹åˆšï¼ŒåšéŸ§èƒœè¿‡å¼ºç¡¬ã€‚',
    'ä¸™': 'å¿ƒä¸­æœ‰å…‰ï¼Œè„šä¸‹æœ‰è·¯ï¼Œçƒ­æƒ…ç…§äº®å‰ç¨‹ã€‚',
    'ä¸': 'ç»†èŠ‚å†³å®šæˆè´¥ï¼Œä¸“æ³¨é“¸å°±å“è¶Šã€‚',
    'æˆŠ': 'åšå¾·è½½ç‰©ï¼Œè¯šä¿¡ç«‹èº«ï¼Œç¨³é‡è‡´è¿œã€‚',
    'å·±': 'åŒ…å®¹å¦‚åœŸï¼Œæ»‹å…»ä¸‡ç‰©ï¼Œå’Œè°å…±ç”Ÿã€‚',
    'åºš': 'çœŸé‡‘ä¸æ€•ç«ç‚¼ï¼ŒåšéŸ§æ–¹æ˜¾æœ¬è‰²ã€‚',
    'è¾›': 'ç²¾é›•ç»†ç¢ï¼Œæ–¹æˆç²¾å“ï¼›ä¸“æ³¨ç”¨å¿ƒï¼Œç»ˆå¾—å®Œç¾ã€‚',
    'å£¬': 'æµæ°´ä¸äº‰å…ˆï¼Œäº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€‚',
    'ç™¸': 'æ¶¦ç‰©ç»†æ— å£°ï¼Œå¾®å°å¤„è§çœŸæƒ…ã€‚'
  };
  return quotes[dayStem] || 'å‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œæ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚';
}

function generateLoveAnalysis(dayStem, strongest, dayBranch) {
  const peachBlossom = getPeachBlossomTime(dayBranch);
  const loveTraits = getLoveTraits(dayStem, strongest.name);
  const advice = getLoveAdvice(dayStem);
  
  return `
    <h4>ğŸ’– å§»ç¼˜çˆ±æƒ…æ·±åº¦åˆ†æ</h4>
    <p><strong>æ‚¨çš„çˆ±æƒ…ç‰¹è´¨ï¼š</strong>${loveTraits}</p>
    <p><strong>æ¡ƒèŠ±è¿åŠ¿ï¼š</strong>${peachBlossom}</p>
    <p><strong>æ„Ÿæƒ…å»ºè®®ï¼š</strong>${advice}</p>
    <p><strong>é€‚å®œå¯¹è±¡ï¼š</strong>${getCompatibleTypes(dayStem)}</p>
  `;
}

function getLoveTraits(dayStem, strongElement) {
  const traits = {
    'ç”²': 'åœ¨æ„Ÿæƒ…ä¸­çœŸè¯šç›´æ¥ï¼Œå–œæ¬¢æ˜ç¡®çš„å…³ç³»ï¼Œé‡è§†æ‰¿è¯ºå’Œè´£ä»»ã€‚',
    'ä¹™': 'æ„Ÿæƒ…ç»†è…»æ¸©æŸ”ï¼Œæ³¨é‡ç²¾ç¥äº¤æµï¼Œå–„äºç†è§£å¯¹æ–¹éœ€æ±‚ã€‚',
    'ä¸™': 'çƒ­æƒ…ä¸»åŠ¨è¿½æ±‚çˆ±æƒ…ï¼Œæµªæ¼«æœ‰æƒ…è°ƒï¼Œå–œæ¬¢æƒŠå–œå’Œæ–°é²œæ„Ÿã€‚',
    'ä¸': 'è§‚å¯Ÿç»†è‡´ä½“è´´å…¥å¾®ï¼Œæ„Ÿæƒ…æŒä¹…ç¨³å®šï¼Œé‡è§†å¿ƒçµå¥‘åˆã€‚',
    'æˆŠ': 'ç¨³é‡å¯é æœ‰æ‹…å½“ï¼Œæ„Ÿæƒ…åŠ¡å®é•¿ä¹…ï¼Œé‡è§†å®¶åº­ç¨³å®šã€‚',
    'å·±': 'åŒ…å®¹ä½“è´´å–„è§£äººæ„ï¼Œæ„Ÿæƒ…ç»†è…»æŒä¹…ï¼Œé‡è§†å’Œè°å…³ç³»ã€‚',
    'åºš': 'ç†æ€§åŠ¡å®æ„Ÿæƒ…è§‚ï¼Œé‡è§†å¹³ç­‰å°Šé‡ï¼Œè¡ŒåŠ¨å¤šäºè¨€è¯­ã€‚',
    'è¾›': 'è¿½æ±‚å®Œç¾ç²¾è‡´æ„Ÿæƒ…ï¼Œæ³¨é‡ç»†èŠ‚å“è´¨ï¼Œæ„Ÿæƒ…ä¸“ä¸€æ·±åˆ»ã€‚',
    'å£¬': 'æ„Ÿæƒ…è‡ªç”±éšç¼˜ï¼Œé‡è§†å¿ƒçµäº¤æµï¼Œé€‚åº”æ€§å¼ºã€‚',
    'ç™¸': 'æ„Ÿæƒ…ç»†è…»æ•æ„Ÿï¼Œç›´è§‰åŠ›å¼ºï¼Œé‡è§†æƒ…æ„Ÿæ·±åº¦å’Œå®‰å…¨æ„Ÿã€‚'
  };
  return traits[dayStem] || 'æ„Ÿæƒ…çœŸè¯šï¼Œç”¨å¿ƒç»è¥æ¯æ®µå…³ç³»ã€‚';
}

function getLoveAdvice(dayStem) {
  const advice = {
    'ç”²': 'ä¸»åŠ¨è¡¨è¾¾ä½†é¿å…å¼ºåŠ¿ï¼Œç»™äºˆå¯¹æ–¹ç©ºé—´ï¼Œå­¦ä¹ å€¾å¬ã€‚',
    'ä¹™': 'å¢å¼ºè‡ªä¿¡å‹‡æ•¢è¡¨è¾¾ï¼Œé¿å…è¿‡åº¦è¿å°±ï¼Œä¿æŒè‡ªæˆ‘ã€‚',
    'ä¸™': 'ä¿æŒçƒ­æƒ…ä½†éœ€æŒä¹…ï¼Œå­¦ä¹ ç¨³é‡ï¼Œé¿å…æƒ…ç»ªæ³¢åŠ¨ã€‚',
    'ä¸': 'ç»†è…»ä½“è´´ä½†éœ€ç›´æ¥ï¼Œé¿å…çŒœç–‘ï¼Œå¢å¼ºä¿¡ä»»æ²Ÿé€šã€‚',
    'æˆŠ': 'ç¨³é‡å¯é ä½†éœ€æµªæ¼«ï¼Œå­¦ä¹ è¡¨è¾¾æƒ…æ„Ÿï¼Œå¢åŠ æƒ…è¶£ã€‚',
    'å·±': 'åŒ…å®¹ç†è§£ä½†éœ€åŸåˆ™ï¼Œé¿å…è¿‡åº¦ç‰ºç‰²ï¼Œä¿æŒè¾¹ç•Œã€‚',
    'åºš': 'ç†æ€§åŠ¡å®ä½†éœ€æ¸©æƒ…ï¼Œå­¦ä¹ æ„Ÿæ€§è¡¨è¾¾ï¼Œå¢åŠ æŸ”è½¯ã€‚',
    'è¾›': 'è¿½æ±‚å®Œç¾ä½†éœ€åŒ…å®¹ï¼Œé¿å…è‹›æ±‚ï¼Œæ¬£èµä¸å®Œç¾ä¹‹ç¾ã€‚',
    'å£¬': 'è‡ªç”±éšç¼˜ä½†éœ€ä¸“æ³¨ï¼Œé¿å…é£˜å¿½ï¼Œå»ºç«‹ç¨³å®šå…³ç³»ã€‚',
    'ç™¸': 'ç»†è…»æ•æ„Ÿä½†éœ€ç†æ€§ï¼Œé¿å…å¤šç–‘ï¼Œå¢å¼ºå®‰å…¨æ„Ÿã€‚'
  };
  return advice[dayStem] || 'çœŸè¯šç›¸å¾…ï¼Œäº’ç›¸ç†è§£å°Šé‡æ˜¯æ„Ÿæƒ…é•¿ä¹…çš„åŸºç¡€ã€‚';
}

function getCompatibleTypes(dayStem) {
  const compatible = {
    'ç”²': 'åºšé‡‘ã€æˆŠåœŸç±»å‹ï¼Œèƒ½å¤Ÿäº’è¡¥å½¢æˆç¨³å®šå…³ç³»ã€‚',
    'ä¹™': 'è¾›é‡‘ã€å·±åœŸç±»å‹ï¼Œç»†è…»ä¸ç²¾è‡´çš„å®Œç¾ç»“åˆã€‚',
    'ä¸™': 'å£¬æ°´ã€ç”²æœ¨ç±»å‹ï¼Œçƒ­æƒ…ä¸æ™ºæ…§çš„ç›¸äº’æ»‹å…»ã€‚',
    'ä¸': 'ç™¸æ°´ã€ä¹™æœ¨ç±»å‹ï¼Œç»†è…»ä¸æŸ”å’Œçš„å’Œè°å…±ç”Ÿã€‚',
    'æˆŠ': 'ç”²æœ¨ã€ä¸™ç«ç±»å‹ï¼Œç¨³é‡ä¸æ´»åŠ›çš„å¹³è¡¡æ­é…ã€‚',
    'å·±': 'ä¹™æœ¨ã€ä¸ç«ç±»å‹ï¼ŒåŒ…å®¹ä¸æ¸©æš–çš„ç¾æ»¡ç»„åˆã€‚',
    'åºš': 'ä¸™ç«ã€æˆŠåœŸç±»å‹ï¼Œåˆšæ¯…ä¸çƒ­æƒ…çš„ç›¸äº’æˆå°±ã€‚',
    'è¾›': 'ä¸ç«ã€å·±åœŸç±»å‹ï¼Œç²¾è‡´ä¸ç»†è…»çš„å®Œç¾å¥‘åˆã€‚',
    'å£¬': 'æˆŠåœŸã€åºšé‡‘ç±»å‹ï¼ŒæµåŠ¨ä¸ç¨³å®šçš„å’Œè°ç»Ÿä¸€ã€‚',
    'ç™¸': 'å·±åœŸã€è¾›é‡‘ç±»å‹ï¼ŒæŸ”ç¾ä¸ç²¾è‡´çš„ç›¸å¾—ç›Šå½°ã€‚'
  };
  return compatible[dayStem] || 'å¯»æ‰¾èƒ½å¤Ÿäº’ç›¸ç†è§£ã€æ”¯æŒæˆé•¿çš„ä¼´ä¾£ã€‚';
}

function getPeachBlossomTime(branch) {
  const map = {
    'å­': 'é¼ å¹´ã€é¾™å¹´ã€çŒ´å¹´æ¡ƒèŠ±è¿åŠ¿æœ€æ—ºï¼Œå†¬å­£æ„Ÿæƒ…æœºä¼šå¢å¤šã€‚',
    'ä¸‘': 'ç‰›å¹´ã€è›‡å¹´ã€é¸¡å¹´ç¼˜åˆ†æ·±åšï¼Œå¹´åˆå¹´æœ«æ˜“é‡è‰¯ç¼˜ã€‚',
    'å¯…': 'è™å¹´ã€é©¬å¹´ã€ç‹—å¹´æ„Ÿæƒ…è¿›å±•é¡ºåˆ©ï¼Œæ˜¥å­£æ¡ƒèŠ±è¿ä½³ã€‚',
    'å¯': 'å…”å¹´ã€ç¾Šå¹´ã€çŒªå¹´è‰¯ç¼˜å‡ºç°ï¼Œå†œå†äºŒæœˆå…«æœˆæœºä¼šå¤šã€‚',
    'è¾°': 'é¾™å¹´ã€çŒ´å¹´ã€é¼ å¹´æœºé‡å¢å¤šï¼Œå­£èŠ‚äº¤æ›¿æ—¶ç¼˜åˆ†è‡³ã€‚',
    'å·³': 'è›‡å¹´ã€é¸¡å¹´ã€ç‰›å¹´å…³ç³»ç¨³å®šå‘å±•ï¼Œå¤å­£æ„Ÿæƒ…å‡æ¸©ã€‚',
    'åˆ': 'é©¬å¹´ã€ç‹—å¹´ã€è™å¹´çƒ­æƒ…é«˜æ¶¨ï¼Œåˆæ—¶å‡ºç”Ÿè€…æ¡ƒèŠ±æ—ºã€‚',
    'æœª': 'ç¾Šå¹´ã€çŒªå¹´ã€å…”å¹´æ¸©æƒ…è„‰è„‰ï¼Œç§‹å­£æ„Ÿæƒ…ç»†è…»å‘å±•ã€‚',
    'ç”³': 'çŒ´å¹´ã€é¼ å¹´ã€é¾™å¹´ç†æ€§é€‰æ‹©ï¼Œå¤´è„‘æ¸…æ™°æ—¶é‡æ­£ç¼˜ã€‚',
    'é…‰': 'é¸¡å¹´ã€ç‰›å¹´ã€è›‡å¹´åŠ¡å®è€ƒé‡ï¼Œé‡‘ç§‹æ—¶èŠ‚ç¼˜åˆ†æˆç†Ÿã€‚',
    'æˆŒ': 'ç‹—å¹´ã€è™å¹´ã€é©¬å¹´çœŸè¯šç›¸å¾…ï¼ŒçœŸè¯šä»˜å‡ºæ—¶é‡çœŸå¿ƒã€‚',
    'äº¥': 'çŒªå¹´ã€å…”å¹´ã€ç¾Šå¹´æ„Ÿæ€§è¿æ¥ï¼Œç›´è§‰æŒ‡å¼•é‡è§ç¼˜åˆ†ã€‚'
  };
  return map[branch] || 'æ¯å¹´æ˜¥å­£æ¡ƒèŠ±è¿åŠ¿è¾ƒä½³ï¼Œä¿æŒå¼€æ”¾å¿ƒæ€è¿æ¥ç¼˜åˆ†ã€‚';
}

// å…¶ä»–åˆ†æå‡½æ•°ç±»ä¼¼ï¼Œé™äºç¯‡å¹…ä¸å®Œæ•´åˆ—å‡º...
function generateCareerAnalysis(dayStem, strongest, monthBranch) {
  return `<h4>ğŸ’¼ äº‹ä¸šæ–¹å‘å»ºè®®</h4><p>æ ¹æ®æ‚¨çš„å‘½ç†ç‰¹è´¨ï¼Œé€‚åˆåœ¨${getCareerDirection(dayStem)}ç­‰é¢†åŸŸå‘å±•ã€‚</p>`;
}

function generateWealthAnalysis(dayStem, strongest, yearStem) {
  return `<h4>ğŸ’° è´¢å¯Œæ ¼å±€åˆ†æ</h4><p>è´¢è¿ä»¥${getWealthElement(dayStem)}ä¸ºä¸»ï¼Œå»ºè®®${getWealthDirection(yearStem)}ã€‚</p>`;
}

function generateFengShuiAnalysis(dayStem, pillars) {
  return `<h4>ğŸ¡ é£æ°´å¸ƒå±€å»ºè®®</h4><p>æ ¹æ®æ‚¨çš„å…«å­—ï¼Œ${getFengShuiAdvice(dayStem, pillars)}ã€‚</p>`;
}

function generateGeneralAnalysis(dayStem, strongest, weakest) {
  return `<h4>ğŸŒŸ ç»¼åˆå‘å±•å»ºè®®</h4><p>å‘æŒ¥${strongest.name}å…ƒç´ ä¼˜åŠ¿ï¼Œè¡¥å¼º${weakest.name}å…ƒç´ ä¸è¶³ï¼Œå®ç°å¹³è¡¡å‘å±•ã€‚</p>`;
}

// è¥¿æ–¹æŠ¥å‘Šç”Ÿæˆ
function generateWesternReport(result, focus) {
  return `
    <h4>â­ å æ˜Ÿç‰¹è´¨åˆ†æ</h4>
    <p><strong>å¤ªé˜³æ˜Ÿåº§ ${result.zodiac}ï¼š</strong>ä»£è¡¨æ‚¨çš„æ ¸å¿ƒè‡ªæˆ‘å’Œäººç”Ÿç›®æ ‡ã€‚</p>
    <p><strong>ä¸Šå‡æ˜Ÿåº§ ${result.rising}ï¼š</strong>å½±å“æ‚¨çš„å¤–åœ¨è¡¨ç°å’Œç¬¬ä¸€å°è±¡ã€‚</p>
    <p><strong>æœˆäº®æ˜Ÿåº§ ${result.moon}ï¼š</strong>åæ˜ æ‚¨çš„æƒ…ç»ªéœ€æ±‚å’Œå†…å¿ƒä¸–ç•Œã€‚</p>
    <p>æ ¹æ®å…ƒç´ åˆ†æï¼Œæ‚¨çš„å‘½ç›˜ä»¥${getDominantElement(result.elements)}ä¸ºä¸»ï¼Œ${getElementPersonality(getDominantElement(result.elements))}ã€‚</p>
  `;
}

function getDominantElement(elements) {
  const max = Math.max(elements.fire, elements.earth, elements.air, elements.water);
  if (max === elements.fire) return 'ç«å…ƒç´ ';
  if (max === elements.earth) return 'åœŸå…ƒç´ ';
  if (max === elements.air) return 'é£å…ƒç´ ';
  return 'æ°´å…ƒç´ ';
}

function getElementPersonality(element) {
  const map = {
    'ç«å…ƒç´ ': 'çƒ­æƒ…ä¸»åŠ¨ï¼Œå……æ»¡æ´»åŠ›ï¼Œå…·æœ‰é¢†å¯¼åŠ›å’Œå¼€åˆ›ç²¾ç¥ã€‚',
    'åœŸå…ƒç´ ': 'åŠ¡å®ç¨³é‡ï¼Œæ³¨é‡å®é™…ï¼Œå…·æœ‰è€å¿ƒå’ŒæŒä¹…åŠ›ã€‚',
    'é£å…ƒç´ ': 'ç†æ€§æ€ç»´ï¼Œå–„äºæ²Ÿé€šï¼Œå…·æœ‰å­¦ä¹ èƒ½åŠ›å’Œé€‚åº”æ€§ã€‚',
    'æ°´å…ƒç´ ': 'æ„Ÿæ€§ç›´è§‰ï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œå…·æœ‰åŒç†å¿ƒå’Œåˆ›é€ åŠ›ã€‚'
  };
  return map[element] || 'å…·æœ‰ç‹¬ç‰¹çš„ä¸ªæ€§ç‰¹è´¨ã€‚';
}

// æ—¥å¼æŠ¥å‘Šç”Ÿæˆ
function generateJapaneseReport(result, focus) {
  return `
    <h4>ğŸ ä¹æ˜Ÿå‘½ç†åˆ†æ</h4>
    <p><strong>æœ¬å‘½æ˜Ÿ ${result.number}ï¼š</strong>å½±å“æ‚¨çš„æ€§æ ¼ç‰¹è´¨å’Œè¿åŠ¿èµ°å‘ã€‚</p>
    <p><strong>ä¸»å¯¼å…ƒç´  ${result.element}ï¼š</strong>${getJapaneseElementDesc(result.element)}</p>
    <p><strong>å‰æ–¹ä½ ${result.direction}ï¼š</strong>åœ¨æ­¤æ–¹å‘æ´»åŠ¨ã€å·¥ä½œã€ä¼‘æ¯å¯å¢å¼ºè¿åŠ¿ã€‚</p>
    <p><strong>è¿åŠ¿è¯„çº§ï¼š</strong>${result.luck === 'å‰' ? 'æ•´ä½“è¿åŠ¿è‰¯å¥½ï¼ŒæŠŠæ¡æœºä¼šç§¯æè¡ŒåŠ¨ã€‚' : 'éœ€è°¨æ…è¡Œäº‹ï¼Œæ³¨æ„è§„é¿é£é™©ã€‚'}</p>
  `;
}

function getJapaneseElementDesc(element) {
  const map = {
    'æ°´': 'æ™ºæ…§æµåŠ¨ï¼Œé€‚åº”åŠ›å¼ºï¼Œå–„äºæ€è€ƒå’Œæ²Ÿé€šã€‚',
    'æœ¨': 'æˆé•¿å‘å±•ï¼Œå……æ»¡æ´»åŠ›ï¼Œå…·æœ‰åˆ›é€ åŠ›å’Œè¡ŒåŠ¨åŠ›ã€‚',
    'ç«': 'çƒ­æƒ…æ´»åŠ›ï¼Œç§¯æè¿›å–ï¼Œå…·æœ‰é¢†å¯¼åŠ›å’Œæ„ŸæŸ“åŠ›ã€‚',
    'åœŸ': 'ç¨³é‡åŠ¡å®ï¼Œè„šè¸å®åœ°ï¼Œå…·æœ‰è´£ä»»æ„Ÿå’Œè€å¿ƒã€‚',
    'é‡‘': 'ç²¾è‡´å®Œç¾ï¼ŒåšæŒåŸåˆ™ï¼Œå…·æœ‰åˆ†æåŠ›å’Œæ‰§è¡ŒåŠ›ã€‚'
  };
  return map[element] || 'å…·æœ‰è¯¥å…ƒç´ çš„å…¸å‹ç‰¹è´¨ã€‚';
}

// å é™€æŠ¥å‘Šç”Ÿæˆ
function generateVedicReport(result, focus) {
  return `
    <h4>ğŸ•‰ï¸ å é™€å‘½ç†åˆ†æ</h4>
    <p><strong>æœ¬å‘½æ˜Ÿåº§ ${result.rashi}ï¼š</strong>ä»£è¡¨æ‚¨çš„åŸºæœ¬æ€§æ ¼å’Œç”Ÿå‘½è½¨è¿¹ã€‚</p>
    <p><strong>æœˆå®¿ ${result.nakshatra}ï¼š</strong>å½±å“æ‚¨çš„æ€ç»´æ¨¡å¼å’Œæƒ…æ„Ÿè¡¨è¾¾ã€‚</p>
    <p><strong>ä¸»å¯¼å…ƒç´  ${result.element}ï¼š</strong>${getVedicElementDesc(result.element)}</p>
    <p>æ ¹æ®å é™€å æ˜Ÿï¼Œæ‚¨çš„å‘½ç›˜æ˜¾ç¤ºå‡º${getVedicFortune(result.rashi)}çš„è¿åŠ¿ç‰¹ç‚¹ã€‚</p>
  `;
}

function getVedicElementDesc(element) {
  const map = {
    'ç«': 'è¡ŒåŠ¨åŠ›å¼ºï¼Œå……æ»¡èƒ½é‡ï¼Œå…·æœ‰é¢†å¯¼æ‰èƒ½ã€‚',
    'åœŸ': 'åŠ¡å®ç¨³å®šï¼Œæ³¨é‡å®‰å…¨ï¼Œå…·æœ‰æŒä¹…è€åŠ›ã€‚',
    'é£': 'æ€ç»´æ´»è·ƒï¼Œå–„äºæ²Ÿé€šï¼Œå­¦ä¹ å¸æ”¶å¿«ã€‚',
    'æ°´': 'æƒ…æ„Ÿä¸°å¯Œï¼Œç›´è§‰æ•é”ï¼Œæ„Ÿå—åŠ›å¼ºã€‚'
  };
  return map[element] || 'å…·æœ‰ç‹¬ç‰¹çš„èƒ½é‡ç‰¹è´¨ã€‚';
}

function getVedicFortune(rashi){
  const map = {
    'Mesha': 'å¼€åˆ›åŠ›å¼ºï¼Œé€‚åˆä¸»åŠ¨å¼€å¯æ–°è®¡åˆ’ã€‚',
    'Vrishabha': 'ç¨³æ‰ç¨³æ‰“ï¼Œé€‚åˆç§¯ç´¯ä¸é•¿æœŸæŠ•èµ„ã€‚',
    'Mithuna': 'æ²Ÿé€šä¸å­¦ä¹ æ—ºï¼Œé€‚åˆæ‹“å±•äººè„‰ä¸æŠ€èƒ½ã€‚',
    'Karka': 'å®¶åº­ä¸æƒ…æ„Ÿè®®é¢˜çªå‡ºï¼Œé€‚åˆä¿®å¤å…³ç³»ä¸ç–—æ„ˆã€‚',
    'Simha': 'è‡ªä¿¡è¡¨ç°åŠ›å¼ºï¼Œé€‚åˆé¢†å¯¼ä¸å…¬å¼€è¡¨è¾¾ã€‚',
    'Kanya': 'ç»†èŠ‚ä¸ç³»ç»Ÿèƒ½åŠ›å¼ºï¼Œé€‚åˆä¼˜åŒ–ä¸ä¸“ä¸šæ·±è€•ã€‚',
    'Tula': 'åˆä½œä¸å¹³è¡¡ä¸»é¢˜å¼ºï¼Œé€‚åˆè°ˆåˆ¤ä¸ä¼™ä¼´å…³ç³»ã€‚',
    'Vrishchika': 'æ´å¯Ÿä¸è½¬åŒ–åŠ›å¼ºï¼Œé€‚åˆæ–­èˆç¦»ä¸é‡å¡‘ã€‚',
    'Dhanu': 'è¿œæ™¯ä¸æ‰©å¼ åŠ›å¼ºï¼Œé€‚åˆå­¦ä¹ æ—…è¡Œä¸è·¨ç•Œã€‚',
    'Makara': 'ç›®æ ‡æ„Ÿä¸è´£ä»»å¼ºï¼Œé€‚åˆå»ºç«‹äº‹ä¸šç»“æ„ã€‚',
    'Kumbha': 'åˆ›æ–°ä¸ç¤¾ç¾¤èƒ½é‡å¼ºï¼Œé€‚åˆæ–°æ¨¡å¼ä¸æ–°ç§‘æŠ€ã€‚',
    'Meena': 'çµæ€§ä¸æƒ³è±¡åŠ›å¼ºï¼Œé€‚åˆåˆ›ä½œä¸å†…åœ¨æˆé•¿ã€‚'
  };
  return map[rashi] || 'æ•´ä½“èƒ½é‡ç¨³å®šï¼Œé€‚åˆç¨³æ­¥æ¨è¿›ã€‚';
}

function getCareerDirection(dayStem){
  const map = {
    'ç”²':'ç®¡ç†ã€æ•™è‚²ã€é¡¹ç›®æ¨è¿›ã€å“ç‰Œé¢†å¯¼',
    'ä¹™':'é¡¾é—®ã€è®¾è®¡ã€å…³ç³»ç»è¥ã€æœåŠ¡è¡Œä¸š',
    'ä¸™':'é”€å”®ã€å¸‚åœºã€å†…å®¹ä¼ æ’­ã€å…¬ä¼—è¡¨è¾¾',
    'ä¸':'ç ”ç©¶ã€ç­–åˆ’ã€å¿ƒç†/ç–—æ„ˆã€ç²¾ç»†åŒ–è¿è¥',
    'æˆŠ':'åœ°äº§ã€ä¾›åº”é“¾ã€ç®¡ç†ã€è´¢åŠ¡ç»“æ„',
    'å·±':'äººäº‹ã€åè°ƒã€å®¢æˆ·æˆåŠŸã€ç¤¾åŒºè¿è¥',
    'åºš':'æŠ€æœ¯ã€å·¥ç¨‹ã€æ³•åŠ¡ã€æ‰§è¡Œä¸æ”¹é©',
    'è¾›':'å®¡ç¾ã€ç å®/ç²¾å“ã€å“æ§ã€ç­–ç•¥åˆ†æ',
    'å£¬':'åª’ä½“ã€è´¸æ˜“ã€è·¨å¢ƒã€æµåŠ¨å‹è¡Œä¸š',
    'ç™¸':'è‰ºæœ¯ã€ç–—æ„ˆã€å’¨è¯¢ã€éšæ€§ä»·å€¼æŒ–æ˜'
  };
  return map[dayStem] || 'é€‚åˆå‘æŒ¥ä¸ªäººä¼˜åŠ¿çš„é¢†åŸŸ';
}

function getWealthElement(dayStem){
  const map = {'ç”²':'åœŸ','ä¹™':'åœŸ','ä¸™':'é‡‘','ä¸':'é‡‘','æˆŠ':'æ°´','å·±':'æ°´','åºš':'æœ¨','è¾›':'æœ¨','å£¬':'ç«','ç™¸':'ç«'};
  return map[dayStem] || 'åœŸ';
}

function getWealthDirection(yearStem){
  const map = {
    'ç”²':'ä»¥é•¿æœŸé¡¹ç›®ä¸å¤åˆ©ä¸ºä¸»ï¼Œé¿å…çŸ­ç‚’ã€‚',
    'ä¹™':'ä»¥åˆä½œä¸æ¸ é“ä¸ºä¸»ï¼Œé‡è§†å£ç¢‘ã€‚',
    'ä¸™':'ä»¥æ›å…‰ä¸æˆäº¤ä¸ºä¸»ï¼Œç°é‡‘æµä¼˜å…ˆã€‚',
    'ä¸':'ä»¥ä¸“ä¸šå£å’ä¸ºä¸»ï¼Œåšé«˜è´¨é‡é«˜æº¢ä»·ã€‚',
    'æˆŠ':'ä»¥èµ„äº§é…ç½®ä¸ºä¸»ï¼Œç¨³å¥æ‰©å¼ ã€‚',
    'å·±':'ä»¥å®¢æˆ·å…³ç³»ä¸ºä¸»ï¼Œç´¯ç§¯ä¼šå‘˜ä¸å¤è´­ã€‚',
    'åºš':'ä»¥æ•ˆç‡ä¸æ‰§è¡Œä¸ºä¸»ï¼Œæ•¢ç æ‰ä½æ•ˆã€‚',
    'è¾›':'ä»¥ç²¾å“è·¯çº¿ä¸ºä¸»ï¼Œå°‘è€Œç²¾æ›´èµšé’±ã€‚',
    'å£¬':'ä»¥æµé‡ä¸è·¨ç•Œä¸ºä¸»ï¼Œå¤šæ¸ é“åˆ†æ•£ã€‚',
    'ç™¸':'ä»¥å†…å®¹ä¸ä¿¡ä»»ä¸ºä¸»ï¼Œæ…¢å°±æ˜¯å¿«ã€‚'
  };
  return map[yearStem] || 'ç¨³å¥è§„åˆ’ã€æ§åˆ¶é£é™©ã€‚';
}

function getFengShuiAdvice(dayStem, pillars){
  // ç®€åŒ–ï¼šç»™ä¸€å¥—â€œå¯æ‰§è¡Œâ€çš„å»ºè®®
  return 'å»ºè®®ä¿æŒç„å…³/å…¥å£æ˜äº®æ•´æ´ï¼ŒåºŠå¤´ä¸åŠå…¬ä½èƒŒåæœ‰é ï¼ˆå¢™/æŸœï¼‰ï¼Œé¿å…èƒŒé—¨ï¼›è‹¥äº”è¡Œåå¼±å¯ç”¨å¯¹åº”è‰²ç³»ä¸æè´¨åšè½¯è£…è¡¥æ°”ã€‚';
}

/* ====== Chat (floating) ====== */
const CHAT_ENDPOINT = "/api/chat";
let chatHistory = [];

function appendChat(role, text){
  const body = $("chatBody");
  if (!body) return;
  const msg = document.createElement("div");
  msg.className = "ss-msg" + (role === "user" ? " me" : "");
  msg.textContent = text;
  body.appendChild(msg);
  body.scrollTop = body.scrollHeight;
}

function toggleChat(open){
  const panel = $("chatPanel");
  if (!panel) return;
  panel.setAttribute("aria-hidden", open ? "false" : "true");
}

async function sendChat(){
  const input = $("chatInput");
  const text = (input?.value || "").trim();
  if (!text) return;

  appendChat("user", text);
  input.value = "";

  // Keep short history
  chatHistory.push({ role: "user", content: text });
  chatHistory = chatHistory.slice(-12);

  try{
    const res = await fetch(API_BASE + CHAT_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        lang: getLang(),
        messages: chatHistory
      })
    });
    if (!res.ok) throw new Error("chat api error");
    const data = await res.json();
    const reply = data?.reply || data?.text || data?.message || "ï¼ˆç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•ï¼‰";
    chatHistory.push({ role:"assistant", content: reply });
    appendChat("assistant", reply);
  }catch(e){
    appendChat("assistant", "ï¼ˆç½‘ç»œé”™è¯¯ / API æš‚æ—¶ä¸å¯ç”¨ï¼‰");
  }
}

/* ====== Main report generation ====== */
function clearResultArea(){
  const host = $("butler-host");
  const rich = $("rich-report");
  if (host) host.innerHTML = "";
  if (rich) rich.innerHTML = "";
  const free = $("xl-free-report");
  if (free) free.innerHTML = ""; // will be rebuilt by ensureResultHost()
}

function getCultureSelected(){
  const c = $("culture")?.value || "auto";
  return c === "auto" ? "ä¸œæ–¹" : c;
}

function readPerson(prefix){
  const name = ($(prefix === 1 ? "name1" : "name2")?.value || "").trim();
  const birth = $(prefix === 1 ? "birthdate1" : "birthdate2")?.value || "";
  const timeEl = $(prefix === 1 ? "birthtime1" : "birthtime2");
  const unknown = !!$(prefix === 1 ? "timeUnknown" : "timeUnknown2")?.checked;
  const time = unknown ? "" : (timeEl?.value || "");
  const country = ($(prefix === 1 ? "country1" : "country2")?.value || "").trim();

  if (!name || !birth || !country) return null;

  const [y,m,d] = birth.split("-").map(n=>parseInt(n,10));
  let hour = 0;
  if (!unknown && time){
    hour = parseInt(time.split(":")[0] || "0", 10);
  }
  return { name, y, m, d, hour, timeUnknown: unknown, country };
}

function getFocus(){
  const type = $("type")?.value || "personal";
  const sel = type === "compatibility" ? $("purpose_compatibility") : $("purpose_personal");
  return sel?.value || "";
}

function runSingleReport(){
  const p1 = readPerson(1);
  if (!p1){
    showErr("è¯·å¡«å†™ï¼šå§“å / å‡ºç”Ÿæ—¥æœŸ / å‡ºç”Ÿå›½å®¶åœ°åŒºï¼ˆå‡ºç”Ÿæ—¶é—´å¯é€‰ï¼‰");
    return;
  }

  const culture = getCultureSelected();
  const calc = calculators[culture] || calculators["ä¸œæ–¹"];

  const result = calc.calculate(p1.y, p1.m, p1.d, p1.hour, p1.timeUnknown);

  $("result").style.display = "block";
  clearResultArea();
  ensureResultHost();

  // Render + analysis
  calc.render(result, { year:p1.y, month:p1.m, day:p1.d, hour:p1.hour, timeUnknown:p1.timeUnknown });

  const rich = $("rich-report");
  if (rich){
    const focus = getFocus();
    if (culture === "ä¸œæ–¹"){
      rich.innerHTML = `<div class="report"><div class="sec"><h3>${t("res_title")}</h3><div class="ai-content">${
        calc.analysis({ pillars: result.pillars, percents: result.percents, focus })
      }</div></div></div>`;
    }else{
      rich.innerHTML = `<div class="report"><div class="sec"><h3>${t("res_title")}</h3><div class="ai-content">${
        (culture === "è¥¿æ–¹") ? generateWesternReport(result, focus)
        : (culture === "æ—¥å¼") ? generateJapaneseReport(result, focus)
        : generateVedicReport(result, focus)
      }</div></div></div>`;
    }
  }
}

function initAuthReveal(){
  const btn = $("revealAuthBtn");
  const fields = $("authFields");
  if (!btn || !fields) return;

  // hidden by default (your standard)
  fields.style.display = "none";

  btn.addEventListener("click", ()=>{
    const isHidden = fields.style.display === "none";
    fields.style.display = isHidden ? "block" : "none";
    btn.textContent = isHidden ? t("btn_hide_login_fields") : t("btn_show_login_fields");
  });
}

function initHeaderScroll(){
  const header = document.querySelector(".site-header");
  if (!header) return;
  window.addEventListener("scroll", ()=>{
    if (window.scrollY > 8) header.classList.add("scrolled");
    else header.classList.remove("scrolled");
  }, { passive:true });
}

function initTimeUnknown(){
  const cb1 = $("timeUnknown"), t1 = $("birthtime1");
  if (cb1 && t1){
    cb1.addEventListener("change", ()=>{
      t1.disabled = cb1.checked;
      if (cb1.checked) t1.value = "";
    });
  }
  const cb2 = $("timeUnknown2"), t2 = $("birthtime2");
  if (cb2 && t2){
    cb2.addEventListener("change", ()=>{
      t2.disabled = cb2.checked;
      if (cb2.checked) t2.value = "";
    });
  }
}

function initPurposeOptions(){
  const typeSel = $("type");
  const cultureSel = $("culture");
  if (typeSel) typeSel.addEventListener("change", ()=>togglePartner(typeSel.value));
  if (cultureSel) cultureSel.addEventListener("change", ()=>updatePurposeOptions(cultureSel.value));

  // initial
  togglePartner(typeSel?.value || "personal");
  updatePurposeOptions(cultureSel?.value || "auto");
}

function initLang(){
  const sel = $("langSelect");
  if (!sel) return;
  sel.value = getLang();
  sel.addEventListener("change", ()=>{
    setLang(sel.value);
    applyI18n();
    // update reveal button text if currently visible
    const fields = $("authFields");
    const btn = $("revealAuthBtn");
    if (btn && fields){
      const isHidden = fields.style.display === "none";
      btn.textContent = isHidden ? t("btn_show_login_fields") : t("btn_hide_login_fields");
    }
  });
}

function initChatUI(){
  const fab = $("ssChatFab");
  const close = $("chatClose");
  const send = $("chatSend");
  const input = $("chatInput");

  if (fab) fab.addEventListener("click", ()=>toggleChat(true));
  if (close) close.addEventListener("click", ()=>toggleChat(false));
  if (send) send.addEventListener("click", sendChat);
  if (input) input.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") sendChat();
  });
}

function initMain(){
  applyI18n();
  initLang();
  initHeaderScroll();
  initTimeUnknown();
  initPurposeOptions();
  initAuthReveal();
  initChatUI();

  const btnNext = $("btnNext");
  if (btnNext) btnNext.addEventListener("click", ()=>{
    hideErr();
    runSingleReport(); // (å…ˆåšå•äººç‰ˆï¼›ä½ è¦åˆç›˜æˆ‘ä¹Ÿèƒ½ç»§ç»­è¡¥å®Œæ•´é€»è¾‘)
  });

  // Fix chat placeholder key if you keep old HTML attribute
  const chatInput = $("chatInput");
  if (chatInput){
    chatInput.setAttribute("placeholder", t("chat_input_ph"));
  }
}

document.addEventListener("DOMContentLoaded", initMain);
  
// ============================================
// å¿ƒæ€œç®¡å®¶å¡ç‰‡
// ============================================
function mountButlerCard({ data, culture, focusArea, type = 'personal' }) {
  const host = $('butler-host') || $('result');
  
  // æ¸…é™¤ç°æœ‰å†…å®¹
  const existingCard = host.querySelector('#aiCard');
  if (existingCard) existingCard.remove();
  
  // è·å–åˆ†æå†…å®¹
  let reportContent = '';
  const calculator = calculators[culture] || calculators['ä¸œæ–¹'];
  
  if (type === 'personal') {
    reportContent = calculator.analysis ? calculator.analysis(data, focusArea) : 
      `<p>${culture}å‘½ç†åˆ†ææ­£åœ¨ç”Ÿæˆä¸­...</p>`;
  } else {
    reportContent = generateCompatibilityReport(data, culture, focusArea);
  }
  
  const card = document.createElement('div');
  card.id = 'aiCard';
  card.className = 'sec';
  
  card.innerHTML = `
    <h3 id="butlerTitle">${t('butler_title') || 'å¿ƒæ€œç®¡å®¶ Â· ä¸“å±æŠ¥å‘Š'}</h3>
    <div class="focus-badge" style="display: inline-block; padding: 6px 12px; background: rgba(212, 175, 55, 0.15); border: 1px solid var(--gold); border-radius: 20px; color: var(--gold2); font-size: 0.9rem; margin-bottom: 15px;">
      åˆ†æé‡ç‚¹ï¼š${focusArea} Â· ${calculator.name}
    </div>
    <div class="chips" id="butlerChips"></div>
    <div class="ai-content">
      ${reportContent}
    </div>
    <div class="ai-lock-overlay">
      <div class="tip">ğŸ’ VIP è§£é”å®Œæ•´æ·±åº¦åˆ†æ</div>
      <div class="sub">ç™»å½•åå¯è·å–è¯¦ç»†æµå¹´è¿åŠ¿ã€å…·ä½“å»ºè®®å’Œæ¯æ—¥ç»ƒä¹ å¡ã€‚</div>
      <button class="btn ghost sm" style="margin-top: 10px;" onclick="showLogin()" data-i18n="btn_upgrade_now">ç«‹å³å‡çº§</button>
    </div>
  `;
  host.insertBefore(card, host.firstChild);
  
  // æ¸²æŸ“ç›¸å…³ä¸»é¢˜æ ‡ç­¾
  renderChips(focusArea, culture, type);
}

function renderChips(focus, culture = 'ä¸œæ–¹', type = 'personal') {
  const el = $('butlerChips'); 
  if (!el) return;
  
  el.innerHTML = '';
  
  let chips = [];
  
  if (type === 'personal') {
    if (focus.includes('æ‹çˆ±') || focus.includes('å§»ç¼˜') || focus.includes('çˆ±æƒ…')) {
      chips = ['æ­£ç¼˜ç‰¹å¾', 'æ¡ƒèŠ±æ—¶æœº', 'ç›¸å¤„å»ºè®®', 'é¿å‘æŒ‡å—', 'å¢è¿›æ„Ÿæƒ…'];
    } else if (focus.includes('äº‹ä¸š') || focus.includes('èŒåœº') || focus.includes('åˆ›ä¸š') || focus.includes('èŒä¸š')) {
      chips = ['èŒä¸šæ–¹å‘', 'å‘å±•æ—¶æœº', 'åˆä½œè´µäºº', 'èƒ½åŠ›æå‡', 'é£é™©è§„é¿'];
    } else if (focus.includes('è´¢è¿') || focus.includes('è´¢å¯Œ') || focus.includes('ç†è´¢')) {
      chips = ['è´¢ä½æ–¹å‘', 'æŠ•èµ„æ—¶æœº', 'ç†è´¢ç­–ç•¥', 'å¼€æºæ–¹æ³•', 'èŠ‚æµå»ºè®®'];
    } else if (focus.includes('é£æ°´') || focus.includes('ä½å®¶') || focus.includes('åŠå…¬å®¤')) {
      chips = ['å¸ƒå±€å»ºè®®', 'æ–¹ä½é€‰æ‹©', 'é¢œè‰²æ­é…', 'ç‰©å“æ‘†æ”¾', 'èƒ½é‡æå‡'];
    } else if (culture === 'è¥¿æ–¹') {
      chips = ['æ˜Ÿåº§ç‰¹è´¨', 'è¡Œæ˜Ÿç›¸ä½', 'è¿åŠ¿å‘¨æœŸ', 'ä¸ªäººæˆé•¿', 'å…³ç³»å»ºè®®'];
    } else if (culture === 'æ—¥å¼') {
      chips = ['æœ¬å‘½æ˜Ÿ', 'æ–¹ä½å‰å‡¶', 'é¢œè‰²å¹¸è¿', 'æ•°å­—èƒ½é‡', 'å­£èŠ‚è¿åŠ¿'];
    } else if (culture === 'å é™€') {
      chips = ['æœ¬å‘½ç›˜', 'è¡Œæ˜Ÿå½±å“', 'å®çŸ³å»ºè®®', 'ä»ªå¼æŒ‡å—', 'ä¿®è¡Œæ–¹å‘'];
    } else {
      chips = ['è¿åŠ¿æ€»è§ˆ', 'æ€§æ ¼åˆ†æ', 'äººé™…å…³ç³»', 'å¥åº·æé†’', 'å‘å±•å»ºè®®'];
    }
  } else {
    chips = ['ç¼˜åˆ†æŒ‡æ•°', 'ç›¸å¤„æ¨¡å¼', 'äº’è¡¥é¢†åŸŸ', 'æ½œåœ¨æŒ‘æˆ˜', 'å¢è¿›æ–¹æ³•'];
  }
  
  chips.forEach(txt => {
    const c = document.createElement('div');
    c.className = 'chip';
    c.textContent = txt;
    el.appendChild(c);
  });
}

function generateCompatibilityReport(data, culture, focus) {
  const { person1, person2, compatibility } = data;
  
  return `
    <h4>ğŸ¤ ${culture}åˆç›˜åˆ†æ</h4>
    <p><strong>ç¼˜åˆ†æŒ‡æ•°ï¼š</strong>${compatibility?.score || '85'} / 100</p>
    <p><strong>ç›¸å¤„æ¨¡å¼ï¼š</strong>${getCompatibilityPattern(culture)}</p>
    <p><strong>äº’è¡¥é¢†åŸŸï¼š</strong>${getComplementaryAreas(person1, person2, culture)}</p>
    <p><strong>æ½œåœ¨æŒ‘æˆ˜ï¼š</strong>${getPotentialChallenges(person1, person2, culture)}</p>
    <p><strong>å¢è¿›å»ºè®®ï¼š</strong>${getCompatibilityAdvice(culture, focus)}</p>
  `;
}

function getCompatibilityPattern(culture) {
  const patterns = {
    'ä¸œæ–¹': 'ç›¸äº’æ»‹å…»ï¼Œå…±åŒæˆé•¿ï¼Œèƒ½å¤Ÿå½¢æˆè‰¯å¥½çš„æ”¯æŒå…³ç³»ã€‚',
    'è¥¿æ–¹': 'æ˜Ÿåº§äº’åŠ¨è‰¯å¥½ï¼Œèƒ½é‡äº’è¡¥ï¼Œå…³ç³»å‘å±•æ½œåŠ›å¤§ã€‚',
    'æ—¥å¼': 'ä¹æ˜Ÿç›¸é…ï¼Œæ–¹ä½å’Œè°ï¼Œç¼˜åˆ†æ·±åšã€‚',
    'å é™€': 'å‘½ç›˜å‘¼åº”ï¼Œè¡Œæ˜Ÿç›¸ä½æœ‰åˆ©ï¼Œç¼˜åˆ†å¤©å®šã€‚'
  };
  return patterns[culture] || 'ç›¸äº’ç†è§£ï¼Œå…±åŒæˆé•¿çš„å…³ç³»æ¨¡å¼ã€‚';
}

function getComplementaryAreas(p1, p2, culture) {
  if (culture === 'ä¸œæ–¹') {
    return 'æ€§æ ¼äº’è¡¥ï¼Œä¼˜åŠ¿äº’è¡¥ï¼Œèƒ½å¤Ÿç›¸äº’æ”¯æŒå…±åŒæˆé•¿ã€‚';
  }
  return 'åœ¨ä¸åŒé¢†åŸŸå„æœ‰æ‰€é•¿ï¼Œèƒ½å¤Ÿç›¸äº’è¡¥å……å®Œå–„ã€‚';
}

function getPotentialChallenges(p1, p2, culture) {
  if (culture === 'ä¸œæ–¹') {
    return 'å¶å°”ä¼šæœ‰è§‚å¿µå·®å¼‚ï¼Œéœ€è¦åŠ å¼ºæ²Ÿé€šå’Œç†è§£ã€‚';
  }
  return 'éœ€è¦äº’ç›¸é€‚åº”ï¼Œå­¦ä¼šæ¥çº³å½¼æ­¤çš„ä¸åŒã€‚';
}

function getCompatibilityAdvice(culture, focus) {
  if (focus.includes('æƒ…ä¾£') || focus.includes('å¤«å¦»')) {
    return 'åŠ å¼ºæƒ…æ„Ÿäº¤æµï¼Œå»ºç«‹å…±åŒç›®æ ‡ï¼ŒåŸ¹å…»å…±åŒå…´è¶£ã€‚';
  } else if (focus.includes('äº‹ä¸š') || focus.includes('åˆä½œ')) {
    return 'æ˜ç¡®åˆ†å·¥ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œå»ºç«‹äº’ä¿¡æœºåˆ¶ã€‚';
  }
  return 'ä¿æŒå¼€æ”¾æ²Ÿé€šï¼Œäº’ç›¸å°Šé‡ç†è§£ï¼Œå…±åŒæˆé•¿è¿›æ­¥ã€‚';
}

// ============================================
// ç”Ÿæˆå‘½ç›˜ä¸»å‡½æ•°
// ============================================
async function genChart(){
  const get = id => $(id)?.value?.trim() || '';
  const bd1 = get('birthdate1'), bt1 = get('birthtime1');
  if (!bd1){ showErr('è¯·å¡«å†™æœ¬äººå‡ºç”Ÿæ—¥æœŸ'); return; }

  const [Y,M,D] = bd1.split('-').map(Number);
  const hour = bt1 ? parseInt(bt1.split(':')[0],10) : 12;
  const timeUnknown = $('#timeUnknown')?.checked || false;
  
  // è·å–æ–‡åŒ–ç±»å‹å’Œå‘½ç›˜ç±»å‹
  const culture = $('culture').value === 'auto' ? 'ä¸œæ–¹' : $('culture').value;
  const type = $('type').value; // personal or compatibility
  
  const nextBtn = $('btnNext');
  if (nextBtn){ nextBtn.disabled = true; nextBtn.textContent = 'ç”Ÿæˆä¸­...'; }

  try{
    // æ ¹æ®æ–‡åŒ–ç±»å‹é€‰æ‹©è®¡ç®—å™¨
    const calculator = calculators[culture] || calculators['ä¸œæ–¹'];
    
    if (type === 'personal') {
      // å•äººåˆ†æ
      const result = await calculator.calculate(Y, M, D, hour, timeUnknown);
      
      // è·å–é€‰é¢˜
      const purposeSelect = $('purpose_personal');
      const focusText = purposeSelect?.options[purposeSelect.selectedIndex]?.text || 'ç»¼åˆå‘½ç†åˆ†æ';
      
      // æ¸²æŸ“ç›¸åº”æ–‡åŒ–ç±»å‹çš„æŠ¥å‘Š
      calculator.render(result, { year: Y, month: M, day: D, hour, timeUnknown });
      
      // ç”Ÿæˆç®¡å®¶æŠ¥å‘Š
      mountButlerCard({ 
        data: result, 
        culture, 
        focusArea: focusText,
        type: 'personal'
      });
      
    } else if (type === 'compatibility') {
      // åˆç›˜åˆ†æ - éœ€è¦ä¸¤äººæ•°æ®
      const bd2 = get('birthdate2');
      if (!bd2) { showErr('è¯·å¡«å†™ç¬¬äºŒäººå‡ºç”Ÿæ—¥æœŸ'); return; }
      
      const [Y2, M2, D2] = bd2.split('-').map(Number);
      const hour2 = get('birthtime2') ? parseInt(get('birthtime2').split(':')[0],10) : 12;
      const timeUnknown2 = $('#timeUnknown2')?.checked || false;
      
      // è®¡ç®—ä¸¤äººå‘½ç›˜
      const result1 = await calculator.calculate(Y, M, D, hour, timeUnknown);
      const result2 = await calculator.calculate(Y2, M2, D2, hour2, timeUnknown2);
      
      // ç®€åŒ–åˆç›˜åˆ†æ
      const compatibility = {
        score: calculateCompatibilityScore(result1, result2, culture),
        summary: getCompatibilitySummary(result1, result2, culture)
      };
      
      // æ˜¾ç¤ºç»“æœ
      $('result').style.display = 'block';
      renderCompatibilityReport(result1, result2, compatibility, culture);
      
      // è·å–åˆç›˜é€‰é¢˜
      const purposeSelect = $('purpose_compatibility');
      const focusText = purposeSelect?.options[purposeSelect.selectedIndex]?.text || 'åˆç›˜åˆ†æ';
      
      mountButlerCard({ 
        data: { person1: result1, person2: result2, compatibility },
        culture,
        focusArea: focusText,
        type: 'compatibility'
      });
    }

  } catch (err){
    console.error(err);
    showErr('è®¡ç®—å‘½ç›˜æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    if (nextBtn){ nextBtn.disabled = false; nextBtn.textContent = t('btn_next') || 'ç”Ÿæˆåˆ†æ'; }
    $('result')?.scrollIntoView({ behavior:'smooth', block:'start' });
  }
}

function calculateCompatibilityScore(result1, result2, culture) {
  // ç®€åŒ–è¯„åˆ†
  let score = 70;
  if (culture === 'ä¸œæ–¹') {
    // å…«å­—åˆç›˜ç®€å•è¯„åˆ†
    if (result1.pillars && result2.pillars) {
      const day1 = result1.pillars.day.stem;
      const day2 = result2.pillars.day.stem;
      // ç®€å•çš„ç›¸ç”Ÿç›¸å…‹åˆ¤æ–­
      const compatiblePairs = [
        ['ç”²', 'åºš'], ['ä¹™', 'è¾›'], ['ä¸™', 'å£¬'], ['ä¸', 'ç™¸'],
        ['æˆŠ', 'ç”²'], ['å·±', 'ä¹™'], ['åºš', 'ä¸™'], ['è¾›', 'ä¸'],
        ['å£¬', 'æˆŠ'], ['ç™¸', 'å·±']
      ];
      if (compatiblePairs.some(pair => 
        (pair[0] === day1 && pair[1] === day2) || 
        (pair[0] === day2 && pair[1] === day1)
      )) {
        score += 20;
      }
    }
  }
  return Math.min(score, 95);
}

function getCompatibilitySummary(result1, result2, culture) {
  const summaries = {
    'ä¸œæ–¹': 'å…«å­—äº’è¡¥ï¼Œç¼˜åˆ†æ·±åšï¼Œå…·æœ‰é•¿æœŸå‘å±•æ½œåŠ›ã€‚',
    'è¥¿æ–¹': 'æ˜Ÿåº§äº’åŠ¨è‰¯å¥½ï¼Œèƒ½é‡å’Œè°ï¼Œå…³ç³»å‘å±•é¡ºåˆ©ã€‚',
    'æ—¥å¼': 'ä¹æ˜Ÿç›¸é…ï¼Œæ–¹ä½å’Œè°ï¼Œç¼˜åˆ†å¤©å®šã€‚',
    'å é™€': 'å‘½ç›˜å‘¼åº”ï¼Œç¼˜åˆ†æ·±åšï¼Œç›¸äº’æ”¯æŒæˆé•¿ã€‚'
  };
  return summaries[culture] || 'ç›¸äº’ç†è§£ï¼Œå…±åŒæˆé•¿çš„è‰¯å¥½å…³ç³»ã€‚';
}

function renderCompatibilityReport(result1, result2, compatibility, culture) {
  $('result').style.display = 'block';
  const host = $('butler-host') || $('result');
  
  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>${culture}åˆç›˜æŠ¥å‘Š</h3>
    <div style="text-align:center;padding:20px">
      <div style="font-size:3rem;color:var(--gold2);font-weight:800">${compatibility.score}</div>
      <div style="font-size:0.9rem;color:var(--muted);margin-top:5px">ç¼˜åˆ†æŒ‡æ•° / 100</div>
      <div style="margin-top:15px">
        <div class="chip">${getCompatibilityLevel(compatibility.score)}</div>
        <div class="chip">${culture}åˆ†æ</div>
      </div>
      <p style="margin-top:15px">${compatibility.summary}</p>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

function getCompatibilityLevel(score) {
  if (score >= 90) return 'å¤©ä½œä¹‹åˆ';
  if (score >= 80) return 'è‰¯ç¼˜ä½³å¶';
  if (score >= 70) return 'ç›¸å¤„èæ´½';
  if (score >= 60) return 'æœ‰å¾…ç£¨åˆ';
  return 'éœ€è¦åŠªåŠ›';
}

// ============================================
// ä¼šå‘˜çŠ¶æ€ç®¡ç†
// ============================================
let memberStatus = {
  isLoggedIn: false,
  name: '',
  expiry: null,
  daysLeft: 0
};

function checkLoginStatus() {
  const stored = localStorage.getItem('member_data');
  if (stored) {
    try {
      const data = JSON.parse(stored);
      memberStatus = { ...memberStatus, ...data, isLoggedIn: true };
      showMemberStatus();
    } catch (e) {
      console.error('è§£æä¼šå‘˜æ•°æ®å¤±è´¥:', e);
    }
  }
}

function showMemberStatus() {
  const statusEl = $('memberStatus');
  const welcomeEl = $('memberWelcome');
  const expiryEl = $('memberExpiry');
  
  if (memberStatus.isLoggedIn && statusEl && welcomeEl && expiryEl) {
    statusEl.style.display = 'block';
    welcomeEl.textContent = `æ¬¢è¿å›æ¥ï¼Œ${memberStatus.name || 'å°Šè´µä¼šå‘˜'}ï¼`;
    expiryEl.textContent = memberStatus.daysLeft > 0 
      ? `VIP æœ‰æ•ˆæœŸï¼šè¿˜æœ‰ ${memberStatus.daysLeft} å¤©` 
      : 'VIP ä¼šå‘˜èº«ä»½æœ‰æ•ˆ';
    
    // éšè—ç™»å½•è¡¨å•
    const authGrid = document.querySelector('.auth-grid');
    if (authGrid) authGrid.style.display = 'none';
  }
}

function showLogin() {
  // æ»šåŠ¨åˆ°ç™»å½•åŒºåŸŸ
  document.querySelector('.astro-auth')?.scrollIntoView({ behavior: 'smooth' });
  
  // æ˜¾ç¤ºç™»å½•è¡¨å•
  const authGrid = document.querySelector('.auth-grid');
  if (authGrid) {
    authGrid.style.display = 'grid';
    $('memberStatus').style.display = 'none';
  }
}

function setupLogout() {
  const logoutBtn = $('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
      localStorage.removeItem('member_data');
      memberStatus = { isLoggedIn: false, name: '', expiry: null, daysLeft: 0 };
      $('memberStatus').style.display = 'none';
      document.querySelector('.auth-grid').style.display = 'grid';
      alert('å·²æˆåŠŸç™»å‡º');
    });
  }
}

// ============================================
// å¯ŒæŠ¥å‘Šå‡½æ•°ï¼ˆåŸmountRichReportï¼‰
// ============================================
function mountRichReport({ pillars, percents }) {
  let host = $('rich-report');
  if (!host) {
    host = document.createElement('div');
    host.id = 'rich-report';
    $('result').appendChild(host);
  }
  
  host.innerHTML = `
    <div class="sec">
      <h3>å…«å­—è¯¦ç»†åˆ†æ</h3>
      <p>æ‚¨çš„å…«å­—ç»„åˆæ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„å‘½ç†ç‰¹å¾ï¼š</p>
      <ul>
        <li>å¹´æŸ± ${pillars.year.stem}${pillars.year.branch} - ä»£è¡¨ç¥–ä¸Šæ ¹åŸºå’Œæ—©å¹´è¿åŠ¿</li>
        <li>æœˆæŸ± ${pillars.month.stem}${pillars.month.branch} - ä»£è¡¨çˆ¶æ¯å®«å’Œé’å¹´è¿åŠ¿</li>
        <li>æ—¥æŸ± ${pillars.day.stem}${pillars.day.branch} - ä»£è¡¨è‡ªèº«å’Œé…å¶</li>
        <li>æ—¶æŸ± ${pillars.hour.stem}${pillars.hour.branch} - ä»£è¡¨å­å¥³å’Œæ™šå¹´è¿åŠ¿</li>
      </ul>
    </div>
  `;
}

// ============================================
// åˆå§‹åŒ–
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  // è¯­è¨€åˆå§‹åŒ–
  const select = $('langSelect');
  const current = getLang();
  if (select) { 
    select.value = current; 
    select.addEventListener('change', () => { 
      setLang(select.value); 
      applyI18n(); 
    }); 
  }
  applyI18n();

  // ç±»å‹åˆ‡æ¢
  const typeSel = $('type');
  if (typeSel){
    togglePartner(typeSel.value);
    typeSel.addEventListener('change', e => togglePartner(e.target.value));
  }

  // æ–‡åŒ–ç±»å‹æ”¹å˜æ—¶æ›´æ–°é€‰é¢˜
  const cultureSelect = $('culture');
  if (cultureSelect) {
    cultureSelect.addEventListener('change', function() {
      const culture = this.value === 'auto' ? 'ä¸œæ–¹' : this.value;
      updatePurposeOptions(culture);
    });
  }

  // ç”Ÿæˆåˆ†ææŒ‰é’®
  const nextBtn = $('btnNext');
  if (nextBtn){
    nextBtn.addEventListener('click', (e) => {
      e.preventDefault(); 
      hideErr(); 
      genChart();
    });
  }

  // æ—¶é—´ä¸è¯¦å¤„ç†
  const timeUnknown = $('#timeUnknown');
  const birthtime1 = $('#birthtime1');
  if (timeUnknown && birthtime1) {
    timeUnknown.addEventListener('change', function() {
      birthtime1.disabled = this.checked;
      if (this.checked) birthtime1.value = '';
    });
  }

  const timeUnknown2 = $('#timeUnknown2');
  const birthtime2 = $('#birthtime2');
  if (timeUnknown2 && birthtime2) {
    timeUnknown2.addEventListener('change', function() {
      birthtime2.disabled = this.checked;
      if (this.checked) birthtime2.value = '';
    });
  }

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLoginStatus();
  setupLogout();
  
  // æ¨¡æ‹Ÿç™»å½•æˆåŠŸ
  $('#loginBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    const email = $('email').value;
    const password = $('password').value;
    
    if (!email || !password) {
      showErr('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
      return;
    }
    
    // æ¨¡æ‹Ÿç™»å½•æˆåŠŸ
    const memberData = {
      isLoggedIn: true,
      name: email.split('@')[0] || 'VIPä¼šå‘˜',
      daysLeft: 30,
      email: email
    };
    localStorage.setItem('member_data', JSON.stringify(memberData));
    checkLoginStatus();
    alert('ç™»å½•æˆåŠŸï¼');
  });

  // æ³¨å†ŒæŒ‰é’®
  $('#registerBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    const email = $('email').value;
    const password = $('password').value;
    
    if (!email || !password) {
      showErr('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
      return;
    }
    
    if (password.length < 8) {
      showErr('å¯†ç è‡³å°‘éœ€è¦8ä½');
      return;
    }
    
    // æ¨¡æ‹Ÿæ³¨å†ŒæˆåŠŸ
    const memberData = {
      isLoggedIn: true,
      name: email.split('@')[0] || 'æ–°ä¼šå‘˜',
      daysLeft: 7, // èµ é€7å¤©ä½“éªŒ
      email: email,
      isNew: true
    };
    localStorage.setItem('member_data', JSON.stringify(memberData));
    checkLoginStatus();
    alert('æ³¨å†ŒæˆåŠŸï¼èµ é€7å¤©VIPä½“éªŒã€‚');
  });

  // é‡è®¾å¯†ç 
  $('#resetBtn')?.addEventListener('click', function() {
    const email = $('email').value;
    if (!email) {
      showErr('è¯·è¾“å…¥é‚®ç®±åœ°å€');
      return;
    }
    alert(`å¯†ç é‡è®¾é“¾æ¥å·²å‘é€åˆ° ${email}ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ã€‚`);
  });

  // åˆå§‹åŒ–é€‰é¢˜
  updatePurposeOptions('ä¸œæ–¹');
  
  // å¤´éƒ¨æ»šåŠ¨æ•ˆæœ
  function initHeaderScroll() {
    const header = document.querySelector(".site-header");
    if (!header) return;
    const onScroll = () => {
      if (window.scrollY > 4) header.classList.add("scrolled");
      else header.classList.remove("scrolled");
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll();
  }
  initHeaderScroll();

  // èŠå¤©åŠŸèƒ½åˆå§‹åŒ–
  function initChat() {
    const fab = $("ssChatFab");
    const panel = $("chatPanel");
    const closeBtn = $("chatClose");
    const body = $("chatBody");
    const input = $("chatInput");
    const sendBtn = $("chatSend");
    if (!fab || !panel || !closeBtn || !body || !input || !sendBtn) return;

    function toggle() {
      const hidden = panel.getAttribute("aria-hidden") === "true";
      panel.setAttribute("aria-hidden", hidden ? "false" : "true");
      if (!hidden) return;
      // ensure welcome only once
      if (!body.dataset.welcomed) {
        body.dataset.welcomed = "1";
        appendMsg("æ‚¨å¥½ï¼æˆ‘æ˜¯å¿ƒæ€œç®¡å®¶ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ", false);
      }
}

    function appendMsg(text, me) {
      const div = document.createElement("div");
      div.className = "ss-msg" + (me ? " me" : "");
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
      return div;
    }

    async function handleSend() {
      const msg = input.value.trim();
      if (!msg) return;

      appendMsg(msg, true);
      input.value = "";

      const pending = appendMsg("æ­£åœ¨æ€è€ƒ...", false);

      // æ¨¡æ‹ŸAIå›å¤
      setTimeout(() => {
        const replies = [
          "æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œæˆ‘å»ºè®®æ‚¨å¤šå…³æ³¨äººé™…å…³ç³»çš„å‘å±•ã€‚",
          "åœ¨è´¢è¿æ–¹é¢ï¼Œè¿‘æœŸæœ‰ä¸é”™çš„æŠ•èµ„æœºä¼šï¼Œä½†éœ€è°¨æ…è¯„ä¼°é£é™©ã€‚",
          "æ„Ÿæƒ…è¿åŠ¿æ–¹é¢ï¼Œéœ€è¦æ›´å¤šçš„æ²Ÿé€šå’Œç†è§£æ¥å¢è¿›å…³ç³»ã€‚",
          "äº‹ä¸šä¸Šï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„é¢†å¯¼æ½œåŠ›ï¼Œå¯ä»¥é€‚å½“å±•ç°è‡ªå·±çš„èƒ½åŠ›ã€‚",
          "å¥åº·æ–¹é¢ï¼Œå»ºè®®æ‚¨æ³¨æ„ä¼‘æ¯ï¼Œä¿æŒè‰¯å¥½çš„ä½œæ¯ä¹ æƒ¯ã€‚"
        ];
        const randomReply = replies[Math.floor(Math.random() * replies.length)];
        pending.textContent = randomReply;
      }, 1000);
    }

    fab.addEventListener("click", toggle);
    closeBtn.addEventListener("click", toggle);
    sendBtn.addEventListener("click", handleSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleSend();
      }
    });
  }
  initChat();
});
</script>
<script>
/* ==============================
   Default: show current date/time in birth inputs
============================== */
function pad2(n){ return String(n).padStart(2,'0'); }

function fillNowFor(prefix){ // prefix: "1" or "2"
  const dEl = document.getElementById(`birthdate${prefix}`);
  const tEl = document.getElementById(`birthtime${prefix}`);
  const unk = document.getElementById(prefix === "1" ? "timeUnknown" : "timeUnknown2");

  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = pad2(now.getMonth() + 1);
  const dd = pad2(now.getDate());
  const HH = pad2(now.getHours());
  const MIN = pad2(now.getMinutes());

  // Only set if empty (do not override)
  if (dEl && !dEl.value) dEl.value = `${yyyy}-${mm}-${dd}`;
  if (tEl && !tEl.value && !(unk && unk.checked)) tEl.value = `${HH}:${MIN}`;

  // If "time unknown" checked, clear time
  if (unk && tEl){
    unk.addEventListener("change", () => {
      if (unk.checked) tEl.value = "";
    });
  }
}

document.addEventListener("DOMContentLoaded", () => {
  fillNowFor("1");      // main person
  fillNowFor("2");      // partner (won't do anything unless those inputs exist)

  // Optional: if partner section appears later, ensure defaults when toggled open
  const typeSel = document.getElementById("type");
  if (typeSel){
    typeSel.addEventListener("change", () => {
      if (typeSel.value === "compatibility") fillNowFor("2");
    });
  }
});  
</script>  
</body>
</html>
