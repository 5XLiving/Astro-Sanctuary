<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Segment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
              linear-gradient(180deg,#0b0f14,#0b0f14);
  font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.site-header{
  position:sticky; top:0; z-index:10; background:#0b0f14cc;
  border-bottom:1px solid #0f1622; backdrop-filter:saturate(140%) blur(12px);
}
.container{max-width:1100px; margin:0 auto; padding:24px 16px 80px;}
.head-inner{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:14px 16px;}
.brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text);}
.brand-badge{
  width:34px; height:34px; border-radius:8px; background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546; display:grid; place-items:center; font-weight:800; color:#ffe084;
}
.title{font-family:"Noto Serif SC","Noto Serif",serif!important; font-weight:600!important; font-size:1.1rem!important;}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; margin:32px auto 40px;}
.section{margin-top:18px}
.section h2{font-family:"Noto Serif SC","Noto Serif",serif; font-weight:600; font-size:1.2rem; margin:0 0 12px; display:flex; align-items:center; gap:10px}
.group-title{font-size:1.05rem; color:#ffe084; margin:6px 0 14px; font-weight:800}
.row{display:grid; gap:12px}
@media(min-width:640px){.row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr}}
input,select,button{width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #243244; background:#0e1520; color:var(--text); padding:14px 13px; font-size:1rem; outline:none}
.btn{background:linear-gradient(180deg,#1d2a3a,#101723); border:1px solid #28364a; font-weight:600; cursor:pointer; transition:.2s}
.btn:hover{box-shadow:0 6px 18px rgba(88,185,255,.15)}
.btn-gold{background:linear-gradient(180deg,#f7e7a8,#d4af37); color:#191919; border:1px solid #d4af37}
.type-selector{display:flex; gap:10px; margin-bottom:20px; border:1px solid #243244; border-radius:12px; padding:4px; background:#0e1520}
.type-btn{flex:1; padding:12px 16px; border:none; border-radius:10px; background:transparent; color:#98a7b7; font-weight:600; cursor:pointer}
.type-btn.active{background:linear-gradient(135deg,#1d2a3a,#101723); color:#e8edf3; border:1px solid #58b9ff}
.error{color:#ff8f8f; margin-top:8px; display:none}
.loading{text-align:center; padding:40px 20px; color:#98a7b7}
.loading-spinner{width:40px; height:40px; border:4px solid rgba(88,185,255,.2); border-top:4px solid #58b9ff; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* å…«å­—ç»“æœæ˜¾ç¤ºæ ·å¼ */
.bazi-result{background:rgba(14,21,32,0.6); padding:20px; border-radius:12px; margin:20px 0; border:1px solid #58b9ff}
.bazi-pillars{display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom:20px}
.pillar-box{text-align:center; padding:15px; background:rgba(11,15,20,0.5); border-radius:10px}
.pillar-title{color:#98a7b7; font-size:0.9rem; margin-bottom:5px}
.pillar-text{font-size:1.4rem; font-weight:700; color:#ffe084; margin:5px 0}
.pillar-info{color:#58b9ff; font-size:0.9rem}
.element-grid{display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:15px 0}
.element-bar{height:10px; background:#243244; border-radius:5px; overflow:hidden}
.analysis-box{background:rgba(11,15,20,0.5); padding:15px; border-radius:8px; border-left:4px solid #d4af37}
.insight-box{background:rgba(212,175,55,0.1); padding:15px; border-radius:8px; border:1px solid rgba(212,175,55,0.3)}
.name-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; margin:20px 0}
.name-card{background:rgba(14,21,32,0.6); border:1px solid #243244; border-radius:10px; padding:16px}
.name-header{display:flex; align-items:center; gap:12px; margin-bottom:12px}
.name-badge{width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#d4af37,#f2d27a); display:flex; align-items:center; justify-content:center; font-weight:800; color:#191919}
.name-text{font-size:1.3rem; font-weight:700; color:#e8edf3; font-family:"Noto Serif SC",serif}
.element-badge{width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.7rem; font-weight:600}
.element-wood{background:#2d5c2a; color:#a8e6a8}
.element-fire{background:#5c2a2a; color:#ff8f8f}
.element-earth{background:#5c542a; color:#ffe084}
.element-metal{background:#2a3a5c; color:#8fb4ff}
.element-water{background:#2a5c5c; color:#84f2f2}
</style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="#">
        <span class="brand-badge">5X</span>
        <span class="title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Segment</span>
      </a>
    </div>
  </header>

  <main class="container">
    <!-- å‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2>å…«å­—å‘½ç†åˆ†æ</h2>
      
      <div class="type-selector">
        <button class="type-btn active" data-type="personal">ä¸ªäººå‘½ç›˜</button>
        <button class="type-btn" data-type="compatibility">åˆç›˜åˆ†æ</button>
      </div>
      
      <div class="group-title">å‡ºç”Ÿä¿¡æ¯</div>
      <div class="row row-3">
        <input type="text" id="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰">
        <input type="date" id="birthdate1" value="1978-02-21">
        <input type="time" id="birthtime1" value="12:55">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1">
          <option value="é˜³å†">é˜³å† (Gregorian)</option>
          <option value="å†œå†">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" placeholder="å‡ºç”Ÿåœ°åŒº" value="ä¸­å›½">
        <select id="gender1">
          <option value="">æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</option>
          <option value="ç”·">ç”·</option>
          <option value="å¥³">å¥³</option>
        </select>
      </div>
      
      <div class="group-title" style="margin-top:12px">åˆ†æä¸»é¢˜</div>
      <select id="purpose">
        <option value="ç»¼åˆ">ç»¼åˆå‘½ç†åˆ†æ</option>
        <option value="äº‹ä¸š">äº‹ä¸šè´¢è¿</option>
        <option value="å§»ç¼˜">å©šå§»æ„Ÿæƒ…</option>
        <option value="å¥åº·">å¥åº·è¿åŠ¿</option>
        <option value="æ”¹å">æ”¹åå»ºè®®</option>
      </select>
      
      <button class="btn btn-gold" id="btnNext" style="margin-top:20px">
        âœ¨ ç”Ÿæˆä¸“ä¸šå…«å­—åˆ†ææŠ¥å‘Š
      </button>
      <div id="error" class="error"></div>
    </section>

    <!-- ç»“æœåŒºåŸŸ -->
    <section id="result" class="card section" style="display:none">
      <h2>å…«å­—å‘½ç†æ·±åº¦åˆ†ææŠ¥å‘Š</h2>
      <div id="result-content"></div>
    </section>
  </main>

<script>
/* =============================================
   ä¸“ä¸šå…«å­—è®¡ç®—å™¨ v2.0
   æ”¯æŒ1900-2099å¹´ï¼ŒåŒ…å«èŠ‚æ°”è®¡ç®—
============================================= */
const professionalBaziCalculator = {
  // å¤©å¹²åœ°æ”¯
  heavenlyStems: ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'],
  earthlyBranches: ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'],
  
  // èŠ‚æ°”è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
  solarTerms: [
    {month:1, day:6, term:'å°å¯’'},   {month:1, day:20, term:'å¤§å¯’'},
    {month:2, day:4, term:'ç«‹æ˜¥'},   {month:2, day:19, term:'é›¨æ°´'},
    {month:3, day:6, term:'æƒŠè›°'},   {month:3, day:21, term:'æ˜¥åˆ†'},
    {month:4, day:5, term:'æ¸…æ˜'},   {month:4, day:20, term:'è°·é›¨'},
    {month:5, day:6, term:'ç«‹å¤'},   {month:5, day:21, term:'å°æ»¡'},
    {month:6, day:6, term:'èŠ’ç§'},   {month:6, day:21, term:'å¤è‡³'},
    {month:7, day:7, term:'å°æš‘'},   {month:7, day:23, term:'å¤§æš‘'},
    {month:8, day:8, term:'ç«‹ç§‹'},   {month:8, day:23, term:'å¤„æš‘'},
    {month:9, day:8, term:'ç™½éœ²'},   {month:9, day:23, term:'ç§‹åˆ†'},
    {month:10, day:8, term:'å¯’éœ²'},  {month:10, day:23, term:'éœœé™'},
    {month:11, day:7, term:'ç«‹å†¬'},  {month:11, day:22, term:'å°é›ª'},
    {month:12, day:7, term:'å¤§é›ª'},  {month:12, day:22, term:'å†¬è‡³'}
  ],
  
  // äº”è¡Œå±æ€§
  getElement(stemOrBranch) {
    const stemElements = {
      'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ',
      'å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´'
    };
    const branchElements = {
      'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ',
      'å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘',
      'æˆŒ':'åœŸ','äº¥':'æ°´'
    };
    return stemElements[stemOrBranch] || branchElements[stemOrBranch] || 'æœªçŸ¥';
  },
  
  // åˆ¤æ–­é—°å¹´
  isLeapYear(year) {
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
  },
  
  // è®¡ç®—å¹´æŸ±
  calculateYearPillar(year, month, day) {
    // åˆ¤æ–­æ˜¯å¦åœ¨ç«‹æ˜¥ä¹‹å‰
    let isBeforeSpring = false;
    if (month < 2) {
      isBeforeSpring = true;
    } else if (month === 2) {
      isBeforeSpring = day < 4;
    }
    
    const lunarYear = isBeforeSpring ? year - 1 : year;
    const stemIndex = (lunarYear - 4) % 10;
    const branchIndex = (lunarYear - 4) % 12;
    
    return {
      stem: this.heavenlyStems[(stemIndex + 10) % 10],
      branch: this.earthlyBranches[(branchIndex + 12) % 12],
      stemIndex: (stemIndex + 10) % 10,
      branchIndex: (branchIndex + 12) % 12,
      lunarYear: lunarYear
    };
  },
  
  // è®¡ç®—èŠ‚æ°”æœˆä»½
  getSolarTermMonth(year, month, day) {
    const dateKey = month * 100 + day;
    
    for (let i = this.solarTerms.length - 1; i >= 0; i--) {
      const term = this.solarTerms[i];
      const termKey = term.month * 100 + term.day;
      if (dateKey >= termKey) {
        return term.month - 1; // è¿”å›æœˆä»½ç´¢å¼•ï¼ˆ0-11ï¼‰
      }
    }
    return 11; // é»˜è®¤12æœˆ
  },
  
  // è®¡ç®—æœˆæŸ±
  calculateMonthPillar(year, month, day, yearStem) {
    const solarMonth = this.getSolarTermMonth(year, month, day);
    const monthBranches = ['å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥','å­','ä¸‘'];
    const monthBranch = monthBranches[solarMonth];
    const branchIndex = this.earthlyBranches.indexOf(monthBranch);
    
    // æœˆå¹²å£è¯€
    const monthStemRules = {
      'ç”²':'ä¸™','ä¹™':'æˆŠ','ä¸™':'åºš','ä¸':'å£¬','æˆŠ':'ç”²',
      'å·±':'ä¸™','åºš':'æˆŠ','è¾›':'åºš','å£¬':'å£¬','ç™¸':'ç”²'
    };
    
    let baseStem = monthStemRules[yearStem];
    let stemIndex = this.heavenlyStems.indexOf(baseStem);
    stemIndex = (stemIndex + solarMonth) % 10;
    
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: monthBranch,
      stemIndex: stemIndex,
      branchIndex: branchIndex,
      solarMonth: solarMonth + 1
    };
  },
  
  // è®¡ç®—æ—¥æŸ±ï¼ˆ1900-2099ï¼‰
  calculateDayPillar(year, month, day) {
    // è®¡ç®—åŸºå‡†æ—¥ï¼ˆ1900å¹´1æœˆ1æ—¥ä¸ºç”²å­æ—¥ï¼‰
    const baseDate = new Date(1900, 0, 1);
    const targetDate = new Date(year, month - 1, day);
    
    // è®¡ç®—å¤©æ•°å·®
    const timeDiff = targetDate.getTime() - baseDate.getTime();
    const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    
    // 60ç”²å­å¾ªç¯
    const dayIndex = ((dayDiff % 60) + 60) % 60;
    const stemIndex = dayIndex % 10;
    const branchIndex = dayIndex % 12;
    
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: this.earthlyBranches[branchIndex],
      stemIndex: stemIndex,
      branchIndex: branchIndex,
      dayIndex: dayIndex
    };
  },
  
  // è®¡ç®—æ—¶æŸ±
  calculateHourPillar(hour, minute, dayStem) {
    // ç¡®å®šæ—¶è¾°
    const hour24 = hour + minute / 60;
    let hourBranchIndex;
    
    if (hour24 >= 23 || hour24 < 1) hourBranchIndex = 0;      // å­æ—¶
    else if (hour24 < 3) hourBranchIndex = 1;                 // ä¸‘æ—¶
    else if (hour24 < 5) hourBranchIndex = 2;                 // å¯…æ—¶
    else if (hour24 < 7) hourBranchIndex = 3;                 // å¯æ—¶
    else if (hour24 < 9) hourBranchIndex = 4;                 // è¾°æ—¶
    else if (hour24 < 11) hourBranchIndex = 5;                // å·³æ—¶
    else if (hour24 < 13) hourBranchIndex = 6;                // åˆæ—¶
    else if (hour24 < 15) hourBranchIndex = 7;                // æœªæ—¶
    else if (hour24 < 17) hourBranchIndex = 8;                // ç”³æ—¶
    else if (hour24 < 19) hourBranchIndex = 9;                // é…‰æ—¶
    else if (hour24 < 21) hourBranchIndex = 10;               // æˆŒæ—¶
    else hourBranchIndex = 11;                                // äº¥æ—¶
    
    const hourBranch = this.earthlyBranches[hourBranchIndex];
    
    // æ—¶å¹²å£è¯€
    const hourStemRules = {
      'ç”²':'ç”²','ä¹™':'ä¸™','ä¸™':'æˆŠ','ä¸':'åºš','æˆŠ':'å£¬',
      'å·±':'ç”²','åºš':'ä¸™','è¾›':'æˆŠ','å£¬':'åºš','ç™¸':'å£¬'
    };
    
    let baseStem = hourStemRules[dayStem];
    let stemIndex = this.heavenlyStems.indexOf(baseStem);
    stemIndex = (stemIndex + hourBranchIndex) % 10;
    
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: hourBranch,
      stemIndex: stemIndex,
      branchIndex: hourBranchIndex
    };
  },
  
  // è—å¹²
  getHiddenStems(branch) {
    const hiddenStems = {
      'å­':['ç™¸'], 'ä¸‘':['å·±','ç™¸','è¾›'], 'å¯…':['ç”²','ä¸™','æˆŠ'],
      'å¯':['ä¹™'], 'è¾°':['æˆŠ','ä¹™','ç™¸'], 'å·³':['ä¸™','åºš','æˆŠ'],
      'åˆ':['ä¸','å·±'], 'æœª':['å·±','ä¸','ä¹™'], 'ç”³':['åºš','å£¬','æˆŠ'],
      'é…‰':['è¾›'], 'æˆŒ':['æˆŠ','è¾›','ä¸'], 'äº¥':['å£¬','ç”²']
    };
    return hiddenStems[branch] || [];
  },
  
  // åç¥
  getTenGods(dayStem, targetStem) {
    const relations = {
      'æ¯”è‚©': [0,10,20,30,40,50], 'åŠ«è´¢': [1,11,21,31,41,51],
      'é£Ÿç¥': [2,12,22,32,42,52], 'ä¼¤å®˜': [3,13,23,33,43,53],
      'åè´¢': [4,14,24,34,44,54], 'æ­£è´¢': [5,15,25,35,45,55],
      'ä¸ƒæ€': [6,16,26,36,46,56], 'æ­£å®˜': [7,17,27,37,47,57],
      'åå°': [8,18,28,38,48,58], 'æ­£å°': [9,19,29,39,49,59]
    };
    
    const dayIndex = this.heavenlyStems.indexOf(dayStem);
    const targetIndex = this.heavenlyStems.indexOf(targetStem);
    const diff = ((targetIndex - dayIndex) * 2 + 20) % 10;
    
    for (const [tenGod, values] of Object.entries(relations)) {
      if (values.includes(diff)) return tenGod;
    }
    return 'æœªçŸ¥';
  },
  
  // ä¸»è¦è®¡ç®—å‡½æ•°
  calculateBazi(year, month, day, hour, minute, timeUnknown = false) {
    try {
      // è®¡ç®—å››æŸ±
      const yearPillar = this.calculateYearPillar(year, month, day);
      const monthPillar = this.calculateMonthPillar(year, month, day, yearPillar.stem);
      const dayPillar = this.calculateDayPillar(year, month, day);
      const hourPillar = timeUnknown ? 
        { stem: '?', branch: '?', stemIndex: -1, branchIndex: -1 } : 
        this.calculateHourPillar(hour, minute, dayPillar.stem);
      
      // ç»„ç»‡ç»“æœ
      const pillars = {
        year: {
          stem: yearPillar.stem,
          branch: yearPillar.branch,
          element: this.getElement(yearPillar.stem),
          hiddenStems: this.getHiddenStems(yearPillar.branch),
          tenGods: this.getTenGods(dayPillar.stem, yearPillar.stem)
        },
        month: {
          stem: monthPillar.stem,
          branch: monthPillar.branch,
          element: this.getElement(monthPillar.stem),
          hiddenStems: this.getHiddenStems(monthPillar.branch),
          tenGods: this.getTenGods(dayPillar.stem, monthPillar.stem),
          lunarMonth: monthPillar.solarMonth
        },
        day: {
          stem: dayPillar.stem,
          branch: dayPillar.branch,
          element: this.getElement(dayPillar.stem),
          hiddenStems: this.getHiddenStems(dayPillar.branch),
          tenGods: 'æ—¥ä¸»',
          dayMaster: true
        },
        hour: {
          stem: hourPillar.stem,
          branch: hourPillar.branch,
          element: timeUnknown ? 'æœªçŸ¥' : this.getElement(hourPillar.stem),
          hiddenStems: timeUnknown ? [] : this.getHiddenStems(hourPillar.branch),
          tenGods: timeUnknown ? 'æœªçŸ¥' : this.getTenGods(dayPillar.stem, hourPillar.stem)
        }
      };
      
      // è®¡ç®—äº”è¡ŒåŠ›é‡
      const elements = { 'æœ¨':0, 'ç«':0, 'åœŸ':0, 'é‡‘':0, 'æ°´':0 };
      
      // ç»Ÿè®¡å¤©å¹²äº”è¡Œ
      Object.values(pillars).forEach(pillar => {
        if (pillar.element && pillar.element !== 'æœªçŸ¥') {
          elements[pillar.element] += 3;
        }
      });
      
      // ç»Ÿè®¡åœ°æ”¯äº”è¡Œ
      Object.values(pillars).forEach(pillar => {
        if (pillar.branch && pillar.branch !== '?') {
          const branchElement = this.getElement(pillar.branch);
          elements[branchElement] += 2;
        }
      });
      
      // ç»Ÿè®¡è—å¹²äº”è¡Œ
      Object.values(pillars).forEach(pillar => {
        pillar.hiddenStems.forEach(stem => {
          const element = this.getElement(stem);
          elements[element] += 1;
        });
      });
      
      const total = Object.values(elements).reduce((a, b) => a + b, 0);
      
      const percents = {
        wood: total > 0 ? Math.round((elements['æœ¨'] / total) * 100) : 0,
        fire: total > 0 ? Math.round((elements['ç«'] / total) * 100) : 0,
        earth: total > 0 ? Math.round((elements['åœŸ'] / total) * 100) : 0,
        metal: total > 0 ? Math.round((elements['é‡‘'] / total) * 100) : 0,
        water: total > 0 ? Math.round((elements['æ°´'] / total) * 100) : 0
      };
      
      // ç”Ÿæˆåˆ†æ
      const analysis = this.generateAnalysis(pillars, elements, percents);
      
      return {
        success: true,
        pillars: pillars,
        elements: elements,
        percents: percents,
        analysis: analysis,
        baziString: `${pillars.year.stem}${pillars.year.branch} ${pillars.month.stem}${pillars.month.branch} ${pillars.day.stem}${pillars.day.branch} ${pillars.hour.stem}${pillars.hour.branch}`,
        timeUnknown: timeUnknown
      };
      
    } catch (error) {
      console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
      return {
        success: false,
        error: 'å…«å­—è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®'
      };
    }
  },
  
  // ç”Ÿæˆåˆ†ææŠ¥å‘Š
  generateAnalysis(pillars, elements, percents) {
    const analysis = [];
    const dayMaster = pillars.day;
    
    // æ—¥ä¸»åˆ†æ
    const dayMasterStrength = elements[dayMaster.element];
    const totalStrength = Object.values(elements).reduce((a, b) => a + b, 0);
    const dayMasterPercent = totalStrength > 0 ? (dayMasterStrength / totalStrength) * 100 : 0;
    
    if (dayMasterPercent > 45) {
      analysis.push(`æ—¥ä¸»${dayMaster.element}å¼ºæ—ºï¼Œæ€§æ ¼ç‹¬ç«‹è‡ªä¸»ï¼Œæœ‰é¢†å¯¼æ‰èƒ½`);
    } else if (dayMasterPercent > 25) {
      analysis.push(`æ—¥ä¸»${dayMaster.element}ä¸­å’Œï¼Œæ€§æ ¼å¹³è¡¡ç¨³å®šï¼Œé€‚åº”èƒ½åŠ›å¼º`);
    } else {
      analysis.push(`æ—¥ä¸»${dayMaster.element}åå¼±ï¼Œæ€§æ ¼æ¸©å’Œï¼Œéœ€å¤–åŠ›æ‰¶æŒ`);
    }
    
    // äº”è¡Œåˆ†æ
    const sortedElements = Object.entries(elements).sort((a, b) => b[1] - a[1]);
    const strongest = sortedElements[0];
    const weakest = sortedElements[sortedElements.length - 1];
    
    analysis.push(`äº”è¡Œä¸­${strongest[0]}æœ€å¼ºï¼ˆå æ¯”${Math.round(strongest[1]/totalStrength*100)}%ï¼‰ï¼Œ${weakest[0]}æœ€å¼±ï¼ˆå æ¯”${Math.round(weakest[1]/totalStrength*100)}%ï¼‰`);
    
    // æ ¼å±€åˆ†æ
    if (dayMaster.element === 'æœ¨' && elements['ç«'] > elements['æ°´']) {
      analysis.push('æœ¨ç«é€šæ˜ï¼Œèªæ˜å¥½å­¦ï¼Œæœ‰æ–‡é‡‡');
    } else if (dayMaster.element === 'é‡‘' && elements['æ°´'] > elements['ç«']) {
      analysis.push('é‡‘ç™½æ°´æ¸…ï¼Œæ€ç»´æ¸…æ™°ï¼Œæœ‰å†³æ–­åŠ›');
    } else if (dayMaster.element === 'æ°´' && elements['æœ¨'] > elements['åœŸ']) {
      analysis.push('æ°´æœ¨æ¸…åï¼Œæœ‰è‰ºæœ¯å¤©èµ‹ï¼Œæƒ…æ„Ÿä¸°å¯Œ');
    }
    
    // åç¥åˆ†æ
    const tenGodsCount = {};
    Object.values(pillars).forEach(pillar => {
      if (pillar.tenGods && pillar.tenGods !== 'æ—¥ä¸»' && pillar.tenGods !== 'æœªçŸ¥') {
        tenGodsCount[pillar.tenGods] = (tenGodsCount[pillar.tenGods] || 0) + 1;
      }
    });
    
    const dominantTenGods = Object.entries(tenGodsCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 2);
    
    if (dominantTenGods.length > 0) {
      analysis.push(`å‘½å±€ä¸­${dominantTenGods.map(([name]) => name).join('ã€')}æ˜æ˜¾ï¼Œå½±å“æ˜¾è‘—`);
    }
    
    return analysis;
  }
};

/* =============================================
   é¡µé¢åŠŸèƒ½å®ç°
============================================= */
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–ç±»å‹é€‰æ‹©å™¨
  const typeBtns = document.querySelectorAll('.type-btn');
  typeBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      typeBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const type = this.dataset.type;
      const partnerSection = document.getElementById('partner-section');
      if (partnerSection) {
        partnerSection.style.display = type === 'compatibility' ? 'block' : 'none';
      }
    });
  });
  
  // ç”ŸæˆæŠ¥å‘ŠæŒ‰é’®
  const generateBtn = document.getElementById('btnNext');
  const errorEl = document.getElementById('error');
  const resultSection = document.getElementById('result');
  const resultContent = document.getElementById('result-content');
  
  if (generateBtn) {
    generateBtn.addEventListener('click', function() {
      // éšè—é”™è¯¯ä¿¡æ¯
      if (errorEl) errorEl.style.display = 'none';
      
      // è·å–è¾“å…¥æ•°æ®
      const birthdate = document.getElementById('birthdate1').value;
      const birthtime = document.getElementById('birthtime1').value;
      const purpose = document.getElementById('purpose').value;
      const gender = document.getElementById('gender1').value;
      
      // éªŒè¯è¾“å…¥
      if (!birthdate) {
        showError('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ');
        return;
      }
      
      // è§£ææ—¥æœŸæ—¶é—´
      const [year, month, day] = birthdate.split('-').map(Number);
      let hour = 0, minute = 0;
      let timeUnknown = false;
      
      if (birthtime) {
        [hour, minute] = birthtime.split(':').map(Number);
      } else {
        timeUnknown = true;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      resultContent.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>æ­£åœ¨è®¡ç®—å…«å­—å‘½ç†...</p>
          <p style="font-size:0.85rem; color:#98a7b7">è¯·ç¨å€™ï¼Œæ­£åœ¨ä¸ºæ‚¨è¿›è¡Œä¸“ä¸šåˆ†æ</p>
        </div>
      `;
      resultSection.style.display = 'block';
      
      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      // è®¡ç®—å…«å­—
      setTimeout(() => {
        try {
          const baziResult = professionalBaziCalculator.calculateBazi(
            year, month, day, hour, minute, timeUnknown
          );
          
          if (baziResult.success) {
            displayBaziResult(baziResult, purpose, gender);
          } else {
            showError(baziResult.error || 'å…«å­—è®¡ç®—å¤±è´¥');
          }
        } catch (error) {
          console.error('åˆ†æé”™è¯¯:', error);
          showError('åˆ†æè¿‡ç¨‹å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
        }
      }, 800);
    });
  }
  
  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  function showError(message) {
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
  
  // æ˜¾ç¤ºå…«å­—ç»“æœ
  function displayBaziResult(result, purpose, gender) {
    const { pillars, baziString, analysis, percents } = result;
    
    // äº”è¡Œé¢œè‰²æ˜ å°„
    const elementColors = {
      'æœ¨': '#2d5c2a', 'ç«': '#5c2a2a', 'åœŸ': '#5c542a',
      'é‡‘': '#2a3a5c', 'æ°´': '#2a5c5c'
    };
    
    // å…ƒç´ åç§°æ˜ å°„
    const elementNames = {
      wood: 'æœ¨', fire: 'ç«', earth: 'åœŸ', metal: 'é‡‘', water: 'æ°´'
    };
    
    let html = `
      <div class="bazi-result">
        <div style="text-align:center; margin-bottom:20px;">
          <div style="font-size:1.8rem; font-weight:700; color:#f2d27a; font-family:'Noto Serif SC',serif;">
            ${baziString}
          </div>
          <div style="color:#98a7b7; margin-top:8px;">å¹´æŸ± Â· æœˆæŸ± Â· æ—¥æŸ± Â· æ—¶æŸ±</div>
        </div>
        
        <div class="bazi-pillars">
    `;
    
    // æ˜¾ç¤ºå››æŸ±
    ['year', 'month', 'day', 'hour'].forEach(key => {
      const pillar = pillars[key];
      html += `
        <div class="pillar-box">
          <div class="pillar-title">${key === 'year' ? 'å¹´æŸ±' : key === 'month' ? 'æœˆæŸ±' : key === 'day' ? 'æ—¥æŸ±' : 'æ—¶æŸ±'}</div>
          <div class="pillar-text">${pillar.stem}${pillar.branch}</div>
          <div class="pillar-info">${pillar.element} Â· ${pillar.tenGods}</div>
          ${pillar.hiddenStems.length > 0 ? `
            <div style="color:#98a7b7; font-size:0.8rem; margin-top:5px;">
              è—å¹²: ${pillar.hiddenStems.join('ã€')}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    html += `
        </div>
        
        <div style="margin:20px 0;">
          <h3 style="color:#f2d27a; border-bottom:1px solid #243244; padding-bottom:8px;">äº”è¡ŒåŠ›é‡åˆ†æ</h3>
          <div class="element-grid">
    `;
    
    // æ˜¾ç¤ºäº”è¡Œæ¡
    Object.entries(percents).forEach(([key, value]) => {
      const elementName = elementNames[key];
      const color = elementColors[elementName];
      html += `
        <div style="text-align:center;">
          <div style="color:#e8edf3; margin-bottom:5px;">${elementName}</div>
          <div class="element-bar">
            <div style="height:100%; width:${value}%; background:${color};"></div>
          </div>
          <div style="color:#58b9ff; margin-top:5px; font-size:0.9rem;">${value}%</div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <div style="margin:20px 0;">
          <h3 style="color:#f2d27a; border-bottom:1px solid #243244; padding-bottom:8px;">å‘½ç†åˆ†æ</h3>
          <div class="analysis-box">
            <ul style="margin:0; padding-left:20px; color:#e8edf3;">
              ${analysis.map(item => `<li style="margin-bottom:8px;">${item}</li>`).join('')}
            </ul>
          </div>
        </div>
    `;
    
    // æ ¹æ®ç›®çš„æ·»åŠ ä¸“é¡¹åˆ†æ
    html += getSpecialAnalysis(purpose, pillars, gender);
    
    // æ¸©é¦¨æç¤º
    html += `
        <div class="insight-box">
          <h4 style="color:#f2d27a; margin-top:0;">ğŸ“ å‘½ç†æç¤º</h4>
          <p style="color:#e8edf3; margin:0; line-height:1.6;">
            å…«å­—å‘½ç†ä»…ä¾›å‚è€ƒï¼ŒçœŸæ­£çš„å¥½è¿æ¥è‡ªäºç§¯æçš„å¿ƒæ€å’ŒæŒç»­çš„åŠªåŠ›ã€‚
            å»ºè®®ç»“åˆè‡ªèº«å®é™…æƒ…å†µï¼Œåˆç†è§„åˆ’äººç”Ÿæ–¹å‘ã€‚
          </p>
        </div>
      </div>
    `;
    
    resultContent.innerHTML = html;
  }
  
  // è·å–ä¸“é¡¹åˆ†æ
  function getSpecialAnalysis(purpose, pillars, gender) {
    let html = '';
    
    switch(purpose) {
      case 'äº‹ä¸š':
        html = `
          <div style="margin:20px 0;">
            <h3 style="color:#f2d27a; border-bottom:1px solid #243244; padding-bottom:8px;">äº‹ä¸šè´¢è¿åˆ†æ</h3>
            <div style="background:rgba(88,185,255,0.1); padding:15px; border-radius:8px;">
              <p style="color:#e8edf3; margin:0 0 10px 0;">åŸºäºæ‚¨çš„å…«å­—å‘½å±€ï¼š</p>
              <ul style="margin:0; padding-left:20px; color:#e8edf3;">
                <li>æ—¥ä¸»${pillars.day.element}ï¼Œé€‚åˆ${getSuitableCareers(pillars.day.element)}ç­‰è¡Œä¸š</li>
                <li>è´¢è¿æ–¹é¢ï¼š${getWealthAnalysis(pillars)}</li>
                <li>å‘å±•æ–¹ä½ï¼š${getFavorableDirections(pillars.year.branch)}</li>
                <li>å…³é”®å¹´ä»½ï¼šæœªæ¥3å¹´æ˜¯äº‹ä¸šå‘å±•çš„é‡è¦æ—¶æœŸ</li>
              </ul>
            </div>
          </div>
        `;
        break;
        
      case 'å§»ç¼˜':
        html = `
          <div style="margin:20px 0;">
            <h3 style="color:#f2d27a; border-bottom:1px solid #243244; padding-bottom:8px;">å©šå§»æ„Ÿæƒ…åˆ†æ</h3>
            <div style="background:rgba(255,105,180,0.1); padding:15px; border-radius:8px;">
              <p style="color:#e8edf3; margin:0 0 10px 0;">æ„Ÿæƒ…è¿åŠ¿åˆ†æï¼š</p>
              <ul style="margin:0; padding-left:20px; color:#e8edf3;">
                <li>${getMarriageAnalysis(pillars, gender)}</li>
                <li>ç†æƒ³ä¼´ä¾£ï¼š${getIdealPartner(pillars.day.element)}</li>
                <li>å©šæ‹æ—¶æœºï¼š${getMarriageTiming(pillars)}</li>
                <li>ç›¸å¤„å»ºè®®ï¼šç›¸äº’ç†è§£ï¼Œå…±åŒæˆé•¿</li>
              </ul>
            </div>
          </div>
        `;
        break;
        
      case 'æ”¹å':
        html = `
          <div style="margin:20px 0;">
            <h3 style="color:#f2d27a; border-bottom:1px solid #243244; padding-bottom:8px;">æ”¹åå»ºè®®</h3>
            <div style="background:rgba(212,175,55,0.1); padding:15px; border-radius:8px;">
              <p style="color:#e8edf3; margin:0 0 10px 0;">å‘½ååŸåˆ™ï¼šè¡¥ç›Šäº”è¡Œï¼ŒéŸ³ä¹‰ä¿±ä½³</p>
              
              <div class="name-grid">
                ${generateNameSuggestions(pillars, gender).map((name, index) => `
                  <div class="name-card">
                    <div class="name-header">
                      <div class="name-badge">${index + 1}</div>
                      <div>
                        <div class="name-text">${name.fullName}</div>
                        <div style="color:#98a7b7; font-size:0.85rem;">${name.pinyin}</div>
                      </div>
                    </div>
                    <div style="color:#e8edf3; font-size:0.9rem; line-height:1.6; margin:12px 0;">
                      ${name.meaning}
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:12px; padding-top:12px; border-top:1px solid #243244;">
                      <span style="background:rgba(88,185,255,0.1); color:#58b9ff; padding:2px 8px; border-radius:12px; font-size:0.8rem;">
                        ${name.gender === 'ç”·' ? 'ç”·å­©å' : name.gender === 'å¥³' ? 'å¥³å­©å' : 'ä¸­æ€§å'}
                      </span>
                      <div style="display:flex; gap:6px;">
                        ${name.elements.map(el => `
                          <div class="element-badge element-${el}" title="${el}è¡Œ">${el}</div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div style="margin-top:15px; padding:10px; background:rgba(11,15,20,0.5); border-radius:6px;">
                <p style="color:#98a7b7; font-size:0.85rem; margin:0;">
                  ğŸ’¡ é€‰æ‹©å»ºè®®ï¼šå»ºè®®é€‰æ‹©ä¸ä¸ªäººæ„Ÿè§‰æœ€å¥‘åˆçš„åå­—ï¼Œå¯é‚€è¯·å®¶äººæœ‹å‹ä¸€èµ·è®¨è®º
                </p>
              </div>
            </div>
          </div>
        `;
        break;
    }
    
    return html;
  }
  
  // è¾…åŠ©å‡½æ•°
  function getSuitableCareers(element) {
    const careers = {
      'æœ¨': 'æ–‡åŒ–æ•™è‚²ã€åŒ»ç–—å¥åº·ã€è®¾è®¡åˆ›ä½œ',
      'ç«': 'ä¼ åª’å¨±ä¹ã€é¤é¥®æœåŠ¡ã€èƒ½æºç”µåŠ›',
      'åœŸ': 'æˆ¿åœ°äº§ã€å»ºç­‘ã€é‡‘èæŠ•èµ„',
      'é‡‘': 'æœºæ¢°åˆ¶é€ ã€æ³•å¾‹ã€é‡‘èç®¡ç†',
      'æ°´': 'è´¸æ˜“ç‰©æµã€æ—…æ¸¸ã€å’¨è¯¢æœåŠ¡'
    };
    return careers[element] || 'å¤šç§è¡Œä¸š';
  }
  
  function getWealthAnalysis(pillars) {
    const wealthGods = ['æ­£è´¢', 'åè´¢'];
    const hasWealth = Object.values(pillars).some(p => wealthGods.includes(p.tenGods));
    
    if (hasWealth) {
      return 'å‘½ä¸­æœ‰è´¢æ˜Ÿï¼Œæ­£è´¢åè´¢çš†æœ‰ï¼Œç†è´¢èƒ½åŠ›è¾ƒå¼º';
    } else {
      return 'éœ€é€šè¿‡ä¸“ä¸šèƒ½åŠ›å’Œå‹¤å¥‹å·¥ä½œç§¯ç´¯è´¢å¯Œ';
    }
  }
  
  function getFavorableDirections(branch) {
    const directions = {
      'å­': 'åŒ—æ–¹', 'ä¸‘': 'ä¸œåŒ—', 'å¯…': 'ä¸œåŒ—', 'å¯': 'ä¸œæ–¹',
      'è¾°': 'ä¸œå—', 'å·³': 'ä¸œå—', 'åˆ': 'å—æ–¹', 'æœª': 'è¥¿å—',
      'ç”³': 'è¥¿å—', 'é…‰': 'è¥¿æ–¹', 'æˆŒ': 'è¥¿åŒ—', 'äº¥': 'è¥¿åŒ—'
    };
    return `å®œå¾€${directions[branch] || 'å¤šä¸ª'}æ–¹å‘å‘å±•`;
  }
  
  function getMarriageAnalysis(pillars, gender) {
    const spouseStar = gender === 'ç”·' ? 'æ­£è´¢' : 'æ­£å®˜';
    const hasSpouse = Object.values(pillars).some(p => p.tenGods === spouseStar);
    
    if (hasSpouse) {
      return 'å‘½ä¸­æœ‰æ­£ç¼˜ï¼Œå©šå§»è¿åŠ¿è¾ƒå¥½ï¼Œå®œæ™šå©šæ›´å‰';
    } else {
      return 'éœ€ä¸»åŠ¨æŠŠæ¡æœºä¼šï¼Œé€šè¿‡ç¤¾äº¤æ‰©å¤§äº¤å‹åœˆ';
    }
  }
  
  function getIdealPartner(dayElement) {
    const partners = {
      'æœ¨': 'é‡‘æˆ–åœŸå±æ€§ï¼Œæ€§æ ¼ç¨³é‡',
      'ç«': 'æ°´æˆ–é‡‘å±æ€§ï¼Œæ€§æ ¼æ¸©å’Œ',
      'åœŸ': 'æœ¨æˆ–ç«å±æ€§ï¼Œæ€§æ ¼ç§¯æ',
      'é‡‘': 'ç«æˆ–æœ¨å±æ€§ï¼Œæ€§æ ¼çƒ­æƒ…',
      'æ°´': 'åœŸæˆ–é‡‘å±æ€§ï¼Œæ€§æ ¼è¸å®'
    };
    return partners[dayElement] || 'äº”è¡Œäº’è¡¥ï¼Œæ€§æ ¼ç›¸åˆ';
  }
  
  function getMarriageTiming(pillars) {
    const currentYear = new Date().getFullYear();
    const favorableYears = [currentYear + 1, currentYear + 3, currentYear + 6];
    return `å»ºè®®åœ¨${favorableYears.join('ã€')}å¹´æŠŠæ¡å©šæ‹æœºä¼š`;
  }
  
  // ç”Ÿæˆåå­—å»ºè®®
  function generateNameSuggestions(pillars, gender) {
    const surnames = ['ç‹','æ','å¼ ','åˆ˜','é™ˆ','æ¨','èµµ','é»„','å‘¨','å´'];
    const maleNames = [
      {char:'ç¿', pinyin:'ruÃ¬', meaning:'èªæ˜ç¿æ™º', elements:['é‡‘']},
      {char:'å®‡', pinyin:'yÇ”', meaning:'æ°”å®‡è½©æ˜‚', elements:['åœŸ']},
      {char:'æµ©', pinyin:'hÃ o', meaning:'æµ©ç„¶æ­£æ°”', elements:['æ°´']},
      {char:'è½©', pinyin:'xuÄn', meaning:'å™¨å®‡ä¸å‡¡', elements:['åœŸ']},
      {char:'åš', pinyin:'bÃ³', meaning:'åšå­¦å¤šæ‰', elements:['æ°´']}
    ];
    const femaleNames = [
      {char:'æ¬£', pinyin:'xÄ«n', meaning:'æ¬£æ¬£å‘è£', elements:['æœ¨']},
      {char:'æ€¡', pinyin:'yÃ­', meaning:'å¿ƒæ—·ç¥æ€¡', elements:['åœŸ']},
      {char:'é›…', pinyin:'yÇ', meaning:'æ¸©æ–‡å°”é›…', elements:['æœ¨']},
      {char:'å©·', pinyin:'tÃ­ng', meaning:'å©·å©·ç‰ç«‹', elements:['ç«']},
      {char:'æ…§', pinyin:'huÃ¬', meaning:'èªæ…§ä¼¶ä¿', elements:['æ°´']}
    ];
    
    const selectedNames = gender === 'ç”·' ? maleNames : 
                         gender === 'å¥³' ? femaleNames : 
                         [...maleNames, ...femaleNames];
    
    const suggestions = [];
    const surname = surnames[Math.floor(Math.random() * surnames.length)];
    
    for (let i = 0; i < 3; i++) {
      const name1 = selectedNames[Math.floor(Math.random() * selectedNames.length)];
      const name2 = selectedNames[Math.floor(Math.random() * selectedNames.length)];
      
      const fullName = surname + name1.char + name2.char;
      const pinyin = surname + ' ' + name1.pinyin + ' ' + name2.pinyin;
      const meaning = `${name1.meaning}ï¼Œ${name2.meaning}ï¼Œå¯“æ„ç¾å¥½å‰ç¥¥`;
      
      suggestions.push({
        fullName: fullName,
        pinyin: pinyin,
        meaning: meaning,
        elements: [...new Set([...name1.elements, ...name2.elements])],
        gender: gender || (i % 2 === 0 ? 'ç”·' : 'å¥³')
      });
    }
    
    return suggestions;
  }
  
  // æµ‹è¯•1978å¹´2æœˆ21æ—¥12:55pm
  function testExample() {
    const testResult = professionalBaziCalculator.calculateBazi(1978, 2, 21, 12, 55);
    console.log('1978å¹´2æœˆ21æ—¥12:55pmå…«å­—ç»“æœ:', testResult);
    
    if (testResult.success) {
      const resultDiv = document.createElement('div');
      resultDiv.style.cssText = 'background:#0e1520; padding:20px; border-radius:12px; margin:20px 0; border:1px solid #58b9ff';
      resultDiv.innerHTML = `
        <h3 style="color:#58b9ff">æµ‹è¯•ç»“æœï¼š1978å¹´2æœˆ21æ—¥12:55pm</h3>
        <div style="font-size:1.2rem; color:#f2d27a; margin:10px 0">${testResult.baziString}</div>
        <div style="color:#98a7b7">æ­£ç¡®å…«å­—åº”ä¸ºï¼šæˆŠåˆ ç”²å¯… ç”²å¯… åºšåˆ</div>
      `;
      document.querySelector('.container').prepend(resultDiv);
    }
  }
  
  // è¿è¡Œæµ‹è¯•
  setTimeout(testExample, 1000);
});
</script>
</body>
</html>
