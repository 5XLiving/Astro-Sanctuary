
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Segment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  --card-w:128px; --card-h:212px; --gap:14px;
}
@media (max-width:640px){
  :root{ --card-w:100px; --card-h:168px; --gap:10px; }
}

html,body{height:100%}
body{
  margin:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
              linear-gradient(180deg,#0b0f14,#0b0f14);
  font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-2;
  background: linear-gradient(rgba(11, 15, 20, 0.85), rgba(11, 15, 20, 0.9)), 
              radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
              radial-gradient(circle at 80% 20%, rgba(88, 185, 255, 0.05) 0%, transparent 50%);
}

/* å…¨å±€å®¹å™¨ */
.container{
  max-width:1100px;
  margin:0 auto;
  padding:24px 16px 80px;
}

/* â€”â€” å¤´éƒ¨ â€”â€” */
.site-header{
  position:sticky;
  top:0;
  z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
  transition:.3s;
}
.site-header.scrolled{
  background:rgba(11,15,20,.95);
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.head-inner{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:14px 16px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  text-decoration:none; color:var(--text);
}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546;
  box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
  transition:.3s;
}
.brand:hover .brand-badge{
  transform:rotate(15deg);
  box-shadow:0 6px 20px rgba(212,175,55,.3);
}
.title{
  font-family:"Noto Serif SC","Noto Serif",serif!important;
  font-weight:600!important;
  letter-spacing:.02em;
  font-size:1.1rem!important;
  line-height:1.25;
}
.brand:hover .title{color:var(--gold);}
.lang{
  display:flex; align-items:center; gap:8px;
}
.lang label{
  white-space:nowrap; color:var(--muted); margin-right:4px;
}
.lang select{
  appearance:none;
  min-width:170px;
  border-radius:10px;
  border:1px solid #243244;
  background:#0e1520;
  color:var(--text);
  padding:10px 34px 10px 12px;
  font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:calc(100% - 12px) 50%;
  transition:.3s;
}
.lang select:focus{
  outline:none;
  border-color:var(--gold);
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}
@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}

    .lang{display:flex;align-items:center;gap:8px}
    .lang label{color:var(--muted);font-size:.9rem}
    .lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px;font-size:.95rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));padding:18px}
    .section{margin-top:18px}
    .section h2{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;font-size:1.2rem;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    .section h2::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px #58b9ff22}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .muted{color:var(--muted)} .error{color:#ff8f8f;margin-top:8px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
    input,select,button{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:14px 13px;font-size:1rem;outline:none}
    input::placeholder{color:#6f8092}
    select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .btn{background:linear-gradient(180deg,#1d2a3a,#101723);border:1px solid #28364a;font-weight:600;letter-spacing:.02em;cursor:pointer;transition:transform .05s ease,box-shadow .2s ease,border .2s ease}
    .btn:hover{box-shadow:0 6px 18px rgba(88,185,255,.15),inset 0 1px 0 #2e3c50}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-gold{background:linear-gradient(180deg,#f7e7a8,#d4af37);color:#191919;border:1px solid #d4af37}
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.columns{grid-template-columns:1fr 1fr}}
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .list-block li{line-height:1.9}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .link-btn{display:grid;place-items:center;text-decoration:none}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

  /* ===== VIP åŒºåŸŸï¼ˆç»Ÿä¸€æ ·å¼ Â· ä¸ energy.html ä¸€è‡´ï¼‰ ===== */
.card.section{
  max-width:1100px;
  margin:32px auto 40px;
  padding:18px 18px 22px;
  border-radius:var(--radius);
  border:1px solid #1f2a36;
  background:#11161dcc;
  box-shadow:var(--shadow);
  box-sizing:border-box;
}

.group-title{
  font-weight:800;
  color:#ffe084;
  font-size:1rem;
  margin:0 0 10px;
}

/* ä¸ŠåŠéƒ¨ï¼šå·¦å³ä¸¤å— VIP åˆ—è¡¨ */
.card.section .columns{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:16px;
  margin-top:10px;
}
.card.section .list-block{
  border-radius:12px;
  border:1px solid #1f2a36;
  background:#0f141d;
  padding:14px 16px;
}
.card.section .list-block ul{
  list-style:none;
  margin:6px 0 0;
  padding:0;
}
.card.section .list-block li{
  margin:.25rem 0;
  font-size:.95rem;
  color:var(--muted);
  line-height:1.6;
}

/* ä¸‹åŠéƒ¨ï¼šç™»å½•åŒºåŸŸ */
.astro-auth{
  margin-top:16px;
}
.astro-auth .auth-grid{
  display:grid;
  grid-template-columns:1.2fr 0.8fr;
  gap:16px;
}
.astro-auth .panel{
  background:#11161dcc;
  border-radius:14px;
  border:1px solid #1f2a36;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  padding:16px 18px 18px;
  box-sizing:border-box;
}
.astro-auth .panel .head{
  font-size:.95rem;
  font-weight:800;
  color:#ffe084;
  padding-bottom:8px;
  margin-bottom:10px;
  border-bottom:1px solid #1f2a36;
}
.astro-auth .panel .body{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .row{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .spacer{
  height:4px;
}

/* è¾“å…¥æ¡† = è·Ÿ energy.html ä¸€æ ·å®½åº¦ */
.astro-auth input[type="email"],
.astro-auth input[type="password"]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #243244;
  background:#0e1520;
  color:#e8edf3;
  font-size:15px;
  box-sizing:border-box;
}
.astro-auth input[type="email"]::placeholder,
.astro-auth input[type="password"]::placeholder{
  color:#6f8092;
}
.astro-auth input[type="email"]:focus,
.astro-auth input[type="password"]:focus{
  outline:none;
  border-color:#d4af37;
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}

/* ç™»å½• / é‡è®¾ / æ³¨å†ŒæŒ‰é’® = å’Œè¾“å…¥æ¡†åŒå®½ï¼Œpill å½¢çŠ¶ */
.astro-auth .btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  max-width:100%;
  padding:11px 18px;
  border-radius:999px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  font-weight:800;
  text-align:center;
  box-shadow:0 6px 20px rgba(230,199,110,.35);
  white-space:nowrap;
  box-sizing:border-box;
  transition:.12s ease;
}
.astro-auth .btn.block{
  width:100%;
}

/* æ·±è‰²çš„ reset æŒ‰é’®æ ·å¼ */
.astro-auth .btn.ghost.block{
  background:#101826;
  border-color:#273245;
  color:#e8edf3;
  box-shadow:none;
}
.astro-auth .btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(230,199,110,.45);
}
.astro-auth .btn.ghost.block:hover{
  border-color:#d4af37;
  background:rgba(212,175,55,.08);
}

.error-message{
  color:#ff7b7b;
  font-size:.85rem;
}

/* å°å±ï¼šVIP åŒºã€ç™»å½•åŒºéƒ½ä¸€åˆ—æ’å¸ƒ */
@media (max-width:768px){
  .card.section .columns{
    grid-template-columns:1fr;
  }
  .astro-auth .auth-grid{
    grid-template-columns:1fr;
  }
}

/* ===== æ”¹è¿›æ ·å¼ï¼šå‘½ç›˜ç±»å‹é€‰æ‹© ===== */
.type-selector {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border: 1px solid #243244;
  border-radius: 12px;
  padding: 4px;
  background: #0e1520;
}

.type-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 10px;
  background: transparent;
  color: #98a7b7;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.type-btn.active {
  background: linear-gradient(135deg, #1d2a3a, #101723);
  color: #e8edf3;
  box-shadow: 0 4px 12px rgba(88, 185, 255, 0.15);
  border: 1px solid #58b9ff;
}

.type-btn:hover:not(.active) {
  background: rgba(88, 185, 255, 0.1);
  color: #e8edf3;
}

/* ===== æ”¹è¿›æ ·å¼ï¼šæŠ¥å‘ŠåŒº ===== */
.ai-report {
  background: rgba(15, 22, 45, 0.5);
  border: 1px solid #243244;
  border-radius: 12px;
  padding: 20px;
  margin-top: 16px;
}

.ai-report h4 {
  color: #ffe084;
  margin-top: 0;
  border-bottom: 1px solid #243244;
  padding-bottom: 10px;
  font-family: "Noto Serif SC", serif;
  font-weight: 700;
  font-size: 1.2rem;
}

.ai-section {
  margin: 16px 0;
  padding: 12px;
  background: rgba(11, 15, 20, 0.3);
  border-radius: 8px;
  border-left: 4px solid #58b9ff;
}

.ai-section h5 {
  color: #f2d27a;
  margin-top: 0;
  font-family: "Noto Serif SC", serif;
  font-weight: 600;
}

.ai-note {
  margin-top: 20px;
  padding: 10px;
  background: rgba(212, 175, 55, 0.1);
  border-radius: 6px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  color: #98a7b7;
  font-size: 0.85rem;
}

/* ===== æµ‹åæ¨èæ ·å¼ ===== */
.naming-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
  margin: 20px 0;
}

.name-card {
  background: rgba(14, 21, 32, 0.6);
  border: 1px solid #243244;
  border-radius: 10px;
  padding: 16px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.name-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(88, 185, 255, 0.2);
}

.name-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.name-badge {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #d4af37, #f2d27a);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  color: #191919;
  font-size: 0.9rem;
}

.name-text {
  font-size: 1.3rem;
  font-weight: 700;
  color: #e8edf3;
  font-family: "Noto Serif SC", serif;
}

.name-pinyin {
  color: #98a7b7;
  font-size: 0.85rem;
}

.name-explanation {
  margin-top: 12px;
  color: #e8edf3;
  font-size: 0.9rem;
  line-height: 1.6;
}

.name-rating {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  font-size: 0.85rem;
}

.rating-stars {
  color: #f2d27a;
  font-weight: 800;
}

.rating-score {
  color: #58b9ff;
  font-weight: 600;
}

.name-meta {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #243244;
  font-size: 0.8rem;
  color: #98a7b7;
}

.gender-tag {
  background: rgba(88, 185, 255, 0.1);
  color: #58b9ff;
  padding: 2px 8px;
  border-radius: 12px;
}

.five-elements {
  display: flex;
  gap: 6px;
}

.element-badge {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 600;
}

.element-wood { background: #2d5c2a; color: #a8e6a8; }
.element-fire { background: #5c2a2a; color: #ff8f8f; }
.element-earth { background: #5c542a; color: #ffe084; }
.element-metal { background: #2a3a5c; color: #8fb4ff; }
.element-water { background: #2a5c5c; color: #84f2f2; }

/* ===== åˆç›˜åˆ†ææ ·å¼ ===== */
.compatibility-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.person-card {
  background: rgba(14, 21, 32, 0.6);
  border: 1px solid #243244;
  border-radius: 10px;
  padding: 16px;
}

.person-name {
  font-size: 1.1rem;
  font-weight: 700;
  color: #ffe084;
  margin-bottom: 8px;
}

.compatibility-score {
  text-align: center;
  background: linear-gradient(135deg, #1d2a3a, #101723);
  border-radius: 10px;
  padding: 20px;
  border: 1px solid #58b9ff;
}

.score-circle {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: conic-gradient(#58b9ff 0% 75%, #243244 75% 100%);
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.score-circle::before {
  content: '';
  position: absolute;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #0e1520;
}

.score-value {
  position: relative;
  z-index: 1;
  font-size: 2rem;
  font-weight: 800;
  color: #58b9ff;
}

.score-label {
  color: #e8edf3;
  font-size: 1rem;
  margin-top: 8px;
}

/* ===== æ— éšœç¢ & å·¥å…· ===== */
.sr-only{
  position:absolute!important;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
.btn-row{
  display:flex;
  align-items:stretch;
  gap:10px;
  width:100%;
  box-sizing:border-box;
}
.btn-row .btn{
  flex:1 1 0;
  width:auto!important;
  max-width:100%;
  box-sizing:border-box;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.btn-row .btn-block{
  display:flex;
  width:auto!important;
}

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}

/* AI æ–‡æœ¬åŒºåŸŸï¼ˆé¢„ç•™ï¼‰ */
#aiText,#energyText{
  white-space:normal;
  line-height:1.7;
}
#aiText h3.ai-head,#energyText h3.ai-head{
  color:#ffe084;
  font-weight:800;
  font-size:1.05rem;
  margin:14px 0 8px;
}
#aiText ul,#aiText ol,#energyText ul,#energyText ol{
  margin:.2rem 0 .6rem 1.2rem;
  padding-left:1.1rem;
}
#aiText li,#energyText li{margin:.25rem 0;}
#aiText ol li::marker{font-weight:700;}

/* å°å±å¸ƒå±€è°ƒæ•´ */
@media (max-width:768px){
  .compatibility-grid {
    grid-template-columns: 1fr;
  }
  
  .naming-grid {
    grid-template-columns: 1fr;
  }
  
  .board.spread-5{
    grid-template-columns:1fr;
    grid-template-rows:auto;
    grid-template-areas:
      "top"
      "left"
      "center"
      "right"
      "bottom";
    gap:10px;
  }
  .controls{
    flex-direction:column;
  }
  .controls input,
  .controls select,
  .controls button{
    min-width:100%;
  }
}

/* é¡µè„š */
footer{
  color:#6c7b8c;
  font-size:.85rem;
  text-align:center;
  padding:30px 0;
}

/* ===== åŠ è½½åŠ¨ç”» ===== */
.loading {
  text-align: center;
  padding: 40px 20px;
  color: #98a7b7;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(88, 185, 255, 0.2);
  border-top: 4px solid #58b9ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== æ”¹è¿›çš„é€‰æ‹©æ¡†æ ·å¼ ===== */
.select-group {
  position: relative;
}

.select-icon {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: #98a7b7;
  pointer-events: none;
}

select:focus + .select-icon {
  color: #d4af37;
}

/* ===== æ”¹è¿›çš„æŠ¥å‘Šæ ·å¼ ===== */
.deep-analysis {
  background: linear-gradient(135deg, rgba(11, 15, 20, 0.8), rgba(30, 40, 60, 0.8));
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  border: 1px solid #58b9ff;
}

.deep-analysis-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.deep-analysis-icon {
  font-size: 1.5rem;
}

.analysis-point {
  margin: 16px 0;
  padding-left: 20px;
  border-left: 3px solid #d4af37;
}

.analysis-point h6 {
  color: #f2d27a;
  margin: 0 0 8px 0;
  font-size: 1rem;
}

.analysis-detail {
  color: #e8edf3;
  line-height: 1.6;
}

/* ===== æ—¶é—´è½´æ ·å¼ ===== */
.timeline {
  position: relative;
  margin: 20px 0;
  padding-left: 24px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 7px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, #58b9ff, #d4af37);
}

.timeline-item {
  position: relative;
  margin-bottom: 24px;
}

.timeline-dot {
  position: absolute;
  left: -24px;
  top: 0;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #d4af37;
  border: 2px solid #0e1520;
}

.timeline-content {
  background: rgba(14, 21, 32, 0.6);
  border-radius: 8px;
  padding: 12px 16px;
  border: 1px solid #243244;
}

.timeline-date {
  color: #58b9ff;
  font-weight: 600;
  margin-bottom: 4px;
}

.timeline-desc {
  color: #e8edf3;
}
</style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">
          <span data-i18n="brand">5xLiving Â· Soul Sanctuary</span>
        </span>
      </a>

      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en-US">English</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
          <option value="th-TH">à¹„à¸—à¸¢</option>
          <option value="ms-MY">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <!-- æ”¹è¿›ï¼šå‘½ç›˜ç±»å‹é€‰æ‹© -->
      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="type-selector">
        <button class="type-btn active" data-type="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</button>
        <button class="type-btn" data-type="compatibility" data-i18n="type_compat">åˆç›˜åˆ†æ</button>
      </div>
      
      <div class="row row-2">
        <select id="culture" name="culture" style="grid-column: span 2;">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼ä¹æ˜Ÿ" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å°åº¦å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
        <select id="gender1" name="gender1">
          <option value="">æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</option>
          <option value="ç”·">ç”·</option>
          <option value="å¥³">å¥³</option>
        </select>
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ -->
      <form id="reportForm" action="/secure/report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-3" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
          <select id="gender2" name="gender2">
            <option value="">æ€§åˆ«ï¼ˆå¯é€‰ï¼‰</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
          </select>
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>

          <optgroup label="æµ‹åå‘½å" data-i18n="opt_name"></optgroup>
          <option value="ä¸ªäººæ”¹å" data-i18n="opt_rename">ä¸ªäººæ”¹å</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
          
          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="æƒ…ä¾£åˆå" data-i18n="opt_couple_name">æƒ…ä¾£åˆå</option>         
        </select>
        
        <button class="btn btn-gold" id="btnNext" type="button" data-i18n="btn_next">
          <span>âœ¨ ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š</span>
        </button>
      </div>
      
      <div id="error" class="error" style="display:none"></div>
    </section>

    <!-- ç»“æœåŒºåŸŸï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
    <section id="result" class="card section" style="display:none">
      <h2 data-i18n="res_title">å¿ƒæ€œç®¡å®¶æ·±åº¦è§£è¯»</h2>
      <div id="result-content">
        <!-- æŠ¥å‘Šå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </section>

    <!-- ä¸‹æ®µï¼šå„åŠŸèƒ½å…¥å£ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>

  <!-- ä¼šå‘˜ä¸“åŒºï¼ˆåŸæ ·ä¿ç•™ï¼‰ -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

   <section class="astro-auth">
    <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
              <input
                id="email"
                name="email"
                type="email"
                inputmode="email"
                autocomplete="username"
                placeholder=""
                data-i18n-ph="ph_email"
                required
              />
              <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
              <input
                id="password"
                name="password"
                type="password"
                autocomplete="current-password"
                placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
                data-i18n-ph="ph_password"
                required
              />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>
            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
</body>
          
<!-- GPT / å¿ƒæ€œç®¡å®¶ï¼ˆç»Ÿä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat_fab">ğŸ’¬</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ€œç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å†…å®¹åŒºï¼šä¿æŒä¸ºç©ºï¼Œæ¶ˆæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¾“å…¥é—®é¢˜â€¦"
      data-i18n-ph="chat_input_ph"
    />
    <button class="btn" id="chatSend" data-i18n="chat_send">å‘é€</button>
  </div>
</div>

<script>
/* ==============================
   CONFIG (GLOBAL)
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const CHAT_ENDPOINT = '/api/chat';
const DEFAULT_LANG = 'zh-CN';
const LANG_KEY = '5x_lang';

/* ==============================
   LANGUAGE CORE (REQUIRED)
============================== */
function getLang(){
  return (
    localStorage.getItem(LANG_KEY) ||
    document.documentElement.lang ||
    DEFAULT_LANG
  );
}
function setLang(lang){
  localStorage.setItem(LANG_KEY, lang);
  document.documentElement.lang = lang;
}

/* ==============================
   TRANSLATOR (GLOBAL SAFE)
============================== */
window.t = window.t || function(key){
  const lang = getLang();
  return (
    window.i18n?.[lang]?.[key] ??
    window.i18n?.['zh-CN']?.[key] ??
    key
  );
};

(() => {
'use strict';

/* ==============================
   CONFIG (GLOBAL)
============================== */
const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev';
const CHAT_ENDPOINT = '/api/chat';
const DEFAULT_LANG = 'zh-CN';
const LANG_KEY = '5x_lang';

/* ==============================
   LANGUAGE CORE (REQUIRED)
============================== */
function getLang(){
  return (
    localStorage.getItem(LANG_KEY) ||
    document.documentElement.lang ||
    DEFAULT_LANG
  );
}
function setLang(lang){
  localStorage.setItem(LANG_KEY, lang);
  document.documentElement.lang = lang;
}

/* ==============================
   TRANSLATOR (GLOBAL SAFE)
============================== */
window.t = window.t || function(key){
  const lang = getLang();
  return (
    window.i18n?.[lang]?.[key] ??
    window.i18n?.['zh-CN']?.[key] ??
    key
  );
};

(() => {
'use strict';

/* ==============================
   HELPERS
============================== */
const $ = (id)=>document.getElementById(id);
const $$ = (selector)=>document.querySelectorAll(selector);
const pad2 = (n)=>String(n??'').padStart(2,'0');
const safe = (s)=>String(s??'');
const escapeHTML = (s)=>String(s??'')
  .replaceAll('&','&amp;')
  .replaceAll('<','&lt;')
  .replaceAll('>','&gt;')
  .replaceAll('"','&quot;')
  .replaceAll("'","&#39;");

/* ==============================
   i18n DICTIONARY
============================== */
const i18n = {
  "zh-CN": {
    brand:"5xLiving Â· Soul Sanctuary",
    page_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    site_title:"å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Soul Sanctuary",
    lang_label:"è¯­è¨€",
    form_title:"å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š",
    choose_type:"é€‰æ‹©å‘½ç›˜ç±»å‹",
    type_personal:"ä¸ªäººå‘½ç›˜",
    type_compat:"åˆç›˜åˆ†æ",
    culture_auto:"è‡ªåŠ¨è¯†åˆ« Auto Detect",
    culture_cn:"ä¸œæ–¹ Chinese / Bazi",
    culture_west:"è¥¿æ–¹ Astrology / Tarot",
    culture_jp:"æ—¥å¼ä¹æ˜Ÿ Japanese",
    culture_vedic:"å°åº¦å é™€ Vedic",

    self_info:"æœ¬äººèµ„æ–™",
    ph_name1:"å§“åï¼ˆæœ¬äººï¼‰",
    ph_time1:"å‡ºç”Ÿæ—¶é—´",
    cal_g:"é˜³å† (Gregorian)",
    cal_l:"å†œå† (Lunar)",
    ph_country1:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",
    btn_next:"âœ¨ ç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š",

    partner_info:"ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰",
    ph_name2:"å§“åï¼ˆç¬¬äºŒäººï¼‰",
    ph_time2:"å‡ºç”Ÿæ—¶é—´",
    ph_country2:"å‡ºç”Ÿå›½å®¶ / åœ°åŒº",

    focus_title:"å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰",
    opt_love:"å§»ç¼˜ Love",
    opt_career:"äº‹ä¸š Career",
    opt_wealth:"è´¢è¿ Wealth",
    opt_dates:"æ‹©æ—¥ Auspicious Date",
    opt_name:"æµ‹åå‘½å",
    opt_fs:"é£æ°´ Feng Shui",
    opt_comp:"åˆç›˜åˆ†æ Compatibility",
    opt_dating:"æ‹çˆ±ç¼˜åˆ†",
    opt_marriage:"å©šå§»èµ°åŠ¿",
    opt_work:"èŒåœºå‘å±•",
    opt_startup:"åˆ›ä¸šæ½œåŠ›",
    opt_wealthpos:"è´¢ä½åˆ†æ",
    opt_timing:"ç†è´¢æ—¶æœº",
    opt_wedding:"å©šæœŸæ‹©æ—¥",
    opt_babydate:"æ–°ç”Ÿå®å®æ‹©æ—¥",
    opt_house:"æ–°å®¶å…¥ä½æ‹©æ—¥",
    opt_office:"æ–°å…¬å¸å…¥ä½æ‹©æ—¥",
    opt_babyname:"å®å®å",
    opt_petname:"å® ç‰©å",
    opt_companyname:"å…¬å¸å",
    opt_rename:"ä¸ªäººæ”¹å",
    opt_couple_name:"æƒ…ä¾£åˆå",
    opt_home:"ä½å®¶",
    opt_officefs:"åŠå…¬å®¤",
    opt_couple:"æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰",
    opt_spouse:"å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰",
    opt_personality:"ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰",
    opt_partner:"äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰",
    opt_reconnect:"æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰",
    opt_petbond:"å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰",

    portal_title:"å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£",
    diary_title:"ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°",
    diary_desc:"ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰",
    btn_personal:"ä¸ªäººéšè—è®°å½•",
    btn_family:"å®¶åº­å…±äº«è®°å½•",
    btn_upload:"ä¸Šä¼ è®°å½•",

    course_title:"ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº",
    course_bazi:"å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ",
    course_tarot:"å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜",
    course_coming:"ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦",
    btn_enter_course:"è¿›å…¥è¯¾ç¨‹",

    shop_title:"ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",
    shop_desc:"ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š",

    wish_title:"ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission",
    btn_manifest:"æ¢¦æƒ³è§„åˆ’ / Manifestation",

    memorial_title:"ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•",
    memorial_desc:"çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰",
    btn_login_memorial:"ç™»å…¥çµæ€§ç©ºé—´",
    btn_upload_memorial:"ä¸Šä¼ å¾€ç”Ÿå½•",
    btn_register_memorial:"æ³¨å†Œçµæ€§ç©ºé—´",

    vip_title:"ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment",
    vip_mingli:"ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹",
    vip_xinlian:"ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹",
    vip_love:"å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿",
    vip_career:"äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›",
    vip_wealth:"è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº",
    vip_pet:"å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†",
    vip_hepan:"åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶",
    vip_name:"æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿",
    vip_fengshui:"è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ",
    vip_record:"çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·",
    vip_course:"å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾",
    vip_memorial:"å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­",
    vip_tasks:"æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡",
    vip_shop:"èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶",

    login_title:"ğŸ’ ç™»å…¥ VIP åŠŸèƒ½",
    panel_login_head:"è´¦æˆ·ç™»å½• / æ³¨å†Œ",
    ph_email:"é‚®ç®± Email",
    ph_label_password:"å¯†ç  Password",
    ph_password:"å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰",
    btn_login:"ç™»å…¥è´¦æˆ·",
    btn_reset:"ğŸ”‘ é‡è®¾å¯†ç ",
    btn_register:"æ³¨å†Œè´¦æˆ·",
    note_price:"æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ",

    panel_member_head:"ä¼šå‘˜æœåŠ¡",
    btn_upgrade:"ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰",
    btn_backshop:"â† è¿”å›å‘½ç†å•†åŸ",
    note_price1:"$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰",

    res_title:"å¿ƒæ€œç®¡å®¶æ·±åº¦è§£è¯»",

    chat_fab:"ğŸ’¬",
    chat_title:"å¿ƒæ€œç®¡å®¶ Â· GPT",
    chat_input_ph:"è¾“å…¥é—®é¢˜â€¦",
    chat_send:"å‘é€",

    time_unknown:"ä¸è¯¦",
    err_fill_name1:"è¯·å¡«å†™å§“åï¼ˆæœ¬äººï¼‰",
    err_fill_date1:"è¯·å¡«å†™å‡ºç”Ÿæ—¥æœŸï¼ˆæœ¬äººï¼‰",
    err_fill_country1:"è¯·å¡«å†™å‡ºç”Ÿå›½å®¶/åœ°åŒºï¼ˆæœ¬äººï¼‰",
    err_fill_name2:"è¯·å¡«å†™ç¬¬äºŒäººå§“åï¼ˆåˆç›˜ï¼‰",
    err_fill_date2:"è¯·å¡«å†™ç¬¬äºŒäººå‡ºç”Ÿæ—¥æœŸï¼ˆåˆç›˜ï¼‰",
    err_fill_country2:"è¯·å¡«å†™å‡ºç”Ÿå›½å®¶/åœ°åŒºï¼ˆåˆç›˜ï¼‰",
    
    // æ–°å¢ç¿»è¯‘
    naming_recommendations:"âœ¨ å‘½åæ¨è",
    compatibility_score:"åˆç›˜è¯„åˆ†",
    deep_analysis:"æ·±åº¦åˆ†æ",
    key_insights:"æ ¸å¿ƒæ´å¯Ÿ",
    action_plan:"è¡ŒåŠ¨è®¡åˆ’",
    auspicious_dates:"å‰æ—¥å»ºè®®",
    element_balance:"äº”è¡Œå¹³è¡¡",
    destiny_trend:"è¿åŠ¿è¶‹åŠ¿",
    gender_boy:"ç”·å­©å",
    gender_girl:"å¥³å­©å",
    unisex_name:"ä¸­æ€§å",
    naming_principles:"å‘½ååŸåˆ™",
    element_strengthen:"éœ€å¼ºåŒ–çš„äº”è¡Œ",
    element_weaken:"éœ€å¹³è¡¡çš„äº”è¡Œ",
    stroke_count:"ç¬”ç”»æ•°ç†",
    pronunciation:"éŸ³éŸµ",
    meaning:"å¯“æ„",
    cultural_significance:"æ–‡åŒ–æ„ä¹‰"
  }
};
window.i18n = i18n;

/* ==============================
   APPLY i18n
============================== */
function applyI18n(){
  const lang = getLang();
  document.documentElement.lang = lang;

  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.dataset.i18n;
    const val = t(key);
    if(val!=null) el.textContent = val;
  });

  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.dataset.i18nPh;
    const val = t(key);
    if(val!=null) el.placeholder = val;
  });

  const titleEl = document.querySelector('title[data-i18n]');
  if(titleEl) document.title = t(titleEl.dataset.i18n);
}
  
/* ==============================
   REQUIRED: auto-fill current date & time
============================== */
function setDefaultBirthDateTimeNow(){
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm   = pad2(now.getMonth()+1);
  const dd   = pad2(now.getDate());
  const hh   = pad2(now.getHours());
  const mi   = pad2(now.getMinutes());

  const d1 = $('birthdate1');
  const t1 = $('birthtime1');

  if (d1 && !String(d1.value || '').trim()) d1.value = `${yyyy}-${mm}-${dd}`;
  if (t1 && !String(t1.value || '').trim()) t1.value = `${hh}:${mi}`;
}

/* ==============================
   æ”¹è¿›çš„å‘½ç›˜ç±»å‹é€‰æ‹©
============================== */
function setupTypeSelector() {
  const typeBtns = $$('.type-btn');
  const typeSelect = $('type');
  
  if (!typeSelect) {
    // å¦‚æœä¸å­˜åœ¨selectï¼Œåˆ›å»ºä¸€ä¸ªéšè—çš„
    const hiddenSelect = document.createElement('select');
    hiddenSelect.id = 'type';
    hiddenSelect.style.display = 'none';
    hiddenSelect.innerHTML = `
      <option value="personal">ä¸ªäººå‘½ç›˜</option>
      <option value="compatibility">åˆç›˜åˆ†æ</option>
    `;
    document.querySelector('.type-selector').parentNode.insertBefore(hiddenSelect, document.querySelector('.type-selector'));
  }
  
  typeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      typeBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // æ›´æ–°éšè—çš„selectå€¼
      const typeValue = btn.dataset.type;
      if ($('type')) $('type').value = typeValue;
      
      // è§¦å‘toggle
      togglePartner(typeValue);
      updatePurposeOptionsBasedOnCulture(getCultureResolved());
    });
  });
}

/* ===========================================
   æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨ï¼ˆæ›¿æ¢åŸæœ‰é”™è¯¯ç‰ˆæœ¬ï¼‰
=========================================== */
class BaziCalculator {
  constructor(){
    this.HEAVENLY_STEMS=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    this.EARTHLY_BRANCHES=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    this.NAYIN=['æµ·ä¸­é‡‘','ç‚‰ä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','å‰‘é”‹é‡‘','å±±å¤´ç«','æ¶§ä¸‹æ°´','åŸå¤´åœŸ','ç™½èœ¡é‡‘','æ¨æŸ³æœ¨','æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é›³ç«','æ¾æŸæœ¨','é•¿æµæ°´','ç ‚çŸ³é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘','ä½›ç¯ç«','å¤©æ²³æ°´','å¤§é©¿åœŸ','é’—é’é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','æ²™ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  }
  
  // å¹´æŸ±è®¡ç®—
  yearPillar(year){
    const s=(year-4)%10, b=(year-4)%12;
    return {
      stem: this.HEAVENLY_STEMS[(s+10)%10], 
      branch: this.EARTHLY_BRANCHES[(b+12)%12]
    };
  }
  
  // è·å–èŠ‚æ°”æœˆæ”¯ç´¢å¼•
  solarMonthIndex(y,m,d){
    const mmdd=m*100+d;
    const gates=[[106,12],[204,1],[306,2],[405,3],[506,4],[606,5],[707,6],[808,7],[908,8],[1008,9],[1107,10],[1207,11]];
    let idx=11;
    for(const [thr,val] of gates){ 
      if(mmdd>=thr) idx=val; 
    }
    const branchBy={
      1:'å¯…',2:'å¯',3:'è¾°',4:'å·³',5:'åˆ',
      6:'æœª',7:'ç”³',8:'é…‰',9:'æˆŒ',10:'äº¥',
      11:'å­',12:'ä¸‘'
    };
    return {index:idx, branch:branchBy[idx]};
  }
  
  // æœˆæŸ±è®¡ç®—
  monthPillar(year,month,day){
    const {index,branch}=this.solarMonthIndex(year,month,day);
    const yStemIdx=this.HEAVENLY_STEMS.indexOf(this.yearPillar(year).stem);
    const startMap={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0};
    const stemIdx=(startMap[yStemIdx]+(index-1))%10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx], 
      branch
    };
  }
  
  // æ—¥æŸ±è®¡ç®—
  dayPillar(year,month,day){
    const baseUTC=Date.UTC(1900,0,31);
    const targetUTC=Date.UTC(year,month-1,day);
    const dayDiff=Math.floor((targetUTC-baseUTC)/86400000);
    const stemIdx=(0+dayDiff)%10, branchIdx=(4+dayDiff)%12;
    return {
      stem: this.HEAVENLY_STEMS[(stemIdx+10)%10], 
      branch: this.EARTHLY_BRANCHES[(branchIdx+12)%12]
    };
  }
  
  // æ—¶æŸ±è®¡ç®—
  hourPillar(dayStem,hour){
    const branchMap={
      23:'å­',0:'å­',1:'ä¸‘',2:'ä¸‘',3:'å¯…',4:'å¯…',5:'å¯',6:'å¯',
      7:'è¾°',8:'è¾°',9:'å·³',10:'å·³',11:'åˆ',12:'åˆ',13:'æœª',14:'æœª',
      15:'ç”³',16:'ç”³',17:'é…‰',18:'é…‰',19:'æˆŒ',20:'æˆŒ',21:'äº¥',22:'äº¥'
    };
    const startMap={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8};
    const dayIdx=this.HEAVENLY_STEMS.indexOf(dayStem);
    const hourIndex=Math.floor((hour+1)/2)%12;
    const stemIdx=(startMap[dayIdx]+hourIndex)%10;
    return {
      stem: this.HEAVENLY_STEMS[stemIdx], 
      branch: branchMap[hour]
    };
  }
  
  // å¤©å¹²äº”è¡Œ
  stemElem(s){ 
    return ({ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'})[s]||'-'; 
  }
  
  // åœ°æ”¯äº”è¡Œ
  branchElem(b){ 
    return ({å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'})[b]||'-'; 
  }
  
  // çº³éŸ³äº”è¡Œ
  nayin(s,b){
    const si=this.HEAVENLY_STEMS.indexOf(s);
    const bi=this.EARTHLY_BRANCHES.indexOf(b);
    return this.NAYIN[(si*2+bi)%this.NAYIN.length];
  }
  
  // åç¥è®¡ç®—
  tenGods(dayStem, stems){
    const map={
      'ç”²':{'ç”²':'æ¯”è‚©','ä¹™':'åŠ«è´¢','ä¸™':'é£Ÿç¥','ä¸':'ä¼¤å®˜','æˆŠ':'åè´¢','å·±':'æ­£è´¢','åºš':'ä¸ƒæ€','è¾›':'æ­£å®˜','å£¬':'åå°','ç™¸':'æ­£å°'},
      'ä¹™':{'ç”²':'åŠ«è´¢','ä¹™':'æ¯”è‚©','ä¸™':'ä¼¤å®˜','ä¸':'é£Ÿç¥','æˆŠ':'æ­£è´¢','å·±':'åè´¢','åºš':'æ­£å®˜','è¾›':'ä¸ƒæ€','å£¬':'æ­£å°','ç™¸':'åå°'},
      'ä¸™':{'ç”²':'åå°','ä¹™':'æ­£å°','ä¸™':'æ¯”è‚©','ä¸':'åŠ«è´¢','æˆŠ':'é£Ÿç¥','å·±':'ä¼¤å®˜','åºš':'åè´¢','è¾›':'æ­£è´¢','å£¬':'ä¸ƒæ€','ç™¸':'æ­£å®˜'},
      'ä¸':{'ç”²':'æ­£å°','ä¹™':'åå°','ä¸™':'åŠ«è´¢','ä¸':'æ¯”è‚©','æˆŠ':'ä¼¤å®˜','å·±':'é£Ÿç¥','åºš':'æ­£è´¢','è¾›':'åè´¢','å£¬':'æ­£å®˜','ç™¸':'ä¸ƒæ€'},
      'æˆŠ':{'ç”²':'ä¸ƒæ€','ä¹™':'æ­£å®˜','ä¸™':'åå°','ä¸':'æ­£å°','æˆŠ':'æ¯”è‚©','å·±':'åŠ«è´¢','åºš':'é£Ÿç¥','è¾›':'ä¼¤å®˜','å£¬':'åè´¢','ç™¸':'æ­£è´¢'},
      'å·±':{'ç”²':'æ­£å®˜','ä¹™':'ä¸ƒæ€','ä¸™':'æ­£å°','ä¸':'åå°','æˆŠ':'åŠ«è´¢','å·±':'æ¯”è‚©','åºš':'ä¼¤å®˜','è¾›':'é£Ÿç¥','å£¬':'æ­£è´¢','ç™¸':'åè´¢'},
      'åºš':{'ç”²':'åè´¢','ä¹™':'æ­£è´¢','ä¸™':'ä¸ƒæ€','ä¸':'æ­£å®˜','æˆŠ':'åå°','å·±':'æ­£å°','åºš':'æ¯”è‚©','è¾›':'åŠ«è´¢','å£¬':'é£Ÿç¥','ç™¸':'ä¼¤å®˜'},
      'è¾›':{'ç”²':'æ­£è´¢','ä¹™':'åè´¢','ä¸™':'æ­£å®˜','ä¸':'ä¸ƒæ€','æˆŠ':'æ­£å°','å·±':'åå°','åºš':'åŠ«è´¢','è¾›':'æ¯”è‚©','å£¬':'ä¼¤å®˜','ç™¸':'é£Ÿç¥'},
      'å£¬':{'ç”²':'é£Ÿç¥','ä¹™':'ä¼¤å®˜','ä¸™':'åè´¢','ä¸':'æ­£è´¢','æˆŠ':'ä¸ƒæ€','å·±':'æ­£å®˜','åºš':'åå°','è¾›':'æ­£å°','å£¬':'æ¯”è‚©','ç™¸':'åŠ«è´¢'},
      'ç™¸':{'ç”²':'ä¼¤å®˜','ä¹™':'é£Ÿç¥','ä¸™':'æ­£è´¢','ä¸':'åè´¢','æˆŠ':'æ­£å®˜','å·±':'ä¸ƒæ€','åºš':'æ­£å°','è¾›':'åå°','å£¬':'åŠ«è´¢','ç™¸':'æ¯”è‚©'}
    };
    const m=map[dayStem]||{};
    return stems.map(s=>m[s]||'-');
  }
  
  // è®¡ç®—å…«å­—å‘½ç›˜ï¼ˆä¸»å‡½æ•°ï¼‰
  calculateBazi(year, month, day, hour, minute, timeUnknown = false) {
    try {
      const y = this.yearPillar(year);
      const m = this.monthPillar(year, month, day);
      const d = this.dayPillar(year, month, day);
      const h = timeUnknown ? 
        { stem: '?', branch: '?', element: 'æœªçŸ¥' } : 
        this.hourPillar(d.stem, hour);
      
      const pillars = {
        year: {
          stem: y.stem,
          branch: y.branch,
          element: this.stemElem(y.stem),
          nayin: this.nayin(y.stem, y.branch)
        },
        month: {
          stem: m.stem,
          branch: m.branch,
          element: this.stemElem(m.stem),
          nayin: this.nayin(m.stem, m.branch)
        },
        day: {
          stem: d.stem,
          branch: d.branch,
          element: this.stemElem(d.stem),
          nayin: this.nayin(d.stem, d.branch)
        },
        hour: {
          stem: h.stem,
          branch: h.branch,
          element: timeUnknown ? 'æœªçŸ¥' : this.stemElem(h.stem),
          nayin: timeUnknown ? 'æœªçŸ¥' : this.nayin(h.stem, h.branch)
        }
      };
      
      // è®¡ç®—äº”è¡Œå¼ºåº¦
      const elements = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
      
      // å¤©å¹²äº”è¡Œï¼ˆæƒé‡ï¼š3ï¼‰
      [y.stem, m.stem, d.stem].forEach(stem => {
        const elem = this.stemElem(stem);
        if (elem !== '-') elements[elem] += 3;
      });
      
      if (!timeUnknown && h.stem !== '?') {
        const hElem = this.stemElem(h.stem);
        if (hElem !== '-') elements[hElem] += 3;
      }
      
      // åœ°æ”¯äº”è¡Œï¼ˆæƒé‡ï¼š2ï¼‰
      [y.branch, m.branch, d.branch].forEach(branch => {
        const elem = this.branchElem(branch);
        if (elem !== '-') elements[elem] += 2;
      });
      
      if (!timeUnknown && h.branch !== '?') {
        const hBranchElem = this.branchElem(h.branch);
        if (hBranchElem !== '-') elements[hBranchElem] += 2;
      }
      
      // åœ°æ”¯è—å¹²ï¼ˆæƒé‡ï¼š1ï¼‰ç®€åŒ–çš„è—å¹²ç³»ç»Ÿ
      const branchHiddenStems = {
        'å­': ['ç™¸'], 'ä¸‘': ['å·±','ç™¸','è¾›'], 'å¯…': ['ç”²','ä¸™','æˆŠ'],
        'å¯': ['ä¹™'], 'è¾°': ['æˆŠ','ä¹™','ç™¸'], 'å·³': ['ä¸™','æˆŠ','åºš'],
        'åˆ': ['ä¸','å·±'], 'æœª': ['å·±','ä¸','ä¹™'], 'ç”³': ['åºš','å£¬','æˆŠ'],
        'é…‰': ['è¾›'], 'æˆŒ': ['æˆŠ','è¾›','ä¸'], 'äº¥': ['å£¬','ç”²']
      };
      
      [y.branch, m.branch, d.branch, h.branch].forEach(branch => {
        if (branch && branch !== '?' && branchHiddenStems[branch]) {
          branchHiddenStems[branch].forEach(stem => {
            const elem = this.stemElem(stem);
            if (elem !== '-') elements[elem] += 1;
          });
        }
      });
      
      // è®¡ç®—ç™¾åˆ†æ¯”
      const total = Object.values(elements).reduce((a, b) => a + b, 0) || 1;
      const percents = {
        wood: Math.round((elements['æœ¨'] / total) * 100),
        fire: Math.round((elements['ç«'] / total) * 100),
        earth: Math.round((elements['åœŸ'] / total) * 100),
        metal: Math.round((elements['é‡‘'] / total) * 100),
        water: Math.round((elements['æ°´'] / total) * 100)
      };
      
      // åç¥å…³ç³»
      const stems = [y.stem, m.stem, d.stem, timeUnknown ? '-' : h.stem];
      const tenGods = this.tenGods(d.stem, stems);
      
      return {
        pillars,
        percents,
        elements,
        tenGods,
        timeUnknown,
        dayStem: d.stem,
        fullString: `${y.stem}${y.branch} ${m.stem}${m.branch} ${d.stem}${d.branch} ${timeUnknown ? '??' : h.stem + h.branch}`
      };
      
    } catch (error) {
      console.error('å…«å­—è®¡ç®—é”™è¯¯:', error);
      return null;
    }
  }
}

/* ==============================
   æ–‡åŒ–ç³»ç»Ÿé…ç½®ï¼ˆå¢å¼ºç‰ˆï¼‰
============================== */
const culturePurposeMap = {
  'ä¸œæ–¹': {
    personal: [
      'æ‹çˆ±ç¼˜åˆ†',
      'å©šå§»èµ°åŠ¿',
      'èŒåœºå‘å±•',
      'åˆ›ä¸šæ½œåŠ›',
      'è´¢ä½åˆ†æ',
      'ç†è´¢æ—¶æœº',
      'æ–°å®¶å…¥ä½æ‹©æ—¥',
      'æ–°å…¬å¸å…¥ä½æ‹©æ—¥',
      'ä½å®¶',
      'åŠå…¬å®¤',
      'ä¸ªäººæ”¹å'
    ],
    compatibility: [
      'å©šæœŸæ‹©æ—¥',
      'æ–°ç”Ÿå®å®æ‹©æ—¥',
      'æ–°å®¶å…¥ä½æ‹©æ—¥',
      'ç¼˜åˆ†èµ·è½',
      'å¤«å¦»æµå¹´',
      'åˆç›˜åˆ†æ',
      'æ–°å…¬å¸å…¥ä½æ‹©æ—¥',
      'äº‹ä¸šå…±äº‹',
      'æ–­è”ä¿®å¤',
      'å® ç‰©ç¼˜åˆ†',
      'å®å®å',
      'å® ç‰©å',
      'å…¬å¸å',
      'æƒ…ä¾£åˆå'
    ],
    analysisType: 'å…«å­—å‘½ç†',
    icon: 'ğŸŒ³',
    description: 'åŸºäºä¸­å›½ä¼ ç»Ÿå…«å­—å‘½ç†å­¦ï¼Œç»“åˆäº”è¡Œã€å¹²æ”¯ã€åç¥è¿›è¡Œæ·±åº¦åˆ†æ'
  },
  'è¥¿æ–¹': {
    personal: [
      'æ‹çˆ±ç¼˜åˆ†',
      'å©šå§»èµ°åŠ¿',
      'èŒåœºå‘å±•',
      'åˆ›ä¸šæ½œåŠ›',
      'è´¢ä½åˆ†æ',
      'ç†è´¢æ—¶æœº'
    ],
    compatibility: [
      'å©šæœŸæ‹©æ—¥',
      'ç¼˜åˆ†èµ·è½',
      'å¤«å¦»æµå¹´',
      'åˆç›˜åˆ†æ',
      'äº‹ä¸šå…±äº‹',
      'æ–­è”ä¿®å¤'
    ],
    analysisType: 'å æ˜Ÿå¡”ç½—',
    icon: 'â­',
    description: 'åŸºäºè¥¿æ–¹å æ˜Ÿå­¦å’Œå¡”ç½—ç‰Œï¼Œç»“åˆæ˜Ÿåº§ã€è¡Œæ˜Ÿä½ç½®è¿›è¡Œè¿åŠ¿åˆ†æ'
  },
  'æ—¥å¼': {
    personal: [
      'æ‹çˆ±ç¼˜åˆ†',
      'å©šå§»èµ°åŠ¿',
      'èŒåœºå‘å±•',
      'åˆ›ä¸šæ½œåŠ›',
      'ä¸ªäººæ”¹å'
    ],
    compatibility: [
      'å©šæœŸæ‹©æ—¥',
      'ç¼˜åˆ†èµ·è½',
      'å¤«å¦»æµå¹´',
      'åˆç›˜åˆ†æ',
      'äº‹ä¸šå…±äº‹'
    ],
    analysisType: 'ä¹æ˜Ÿæ°”å­¦',
    icon: 'ğŸŒ¸',
    description: 'åŸºäºæ—¥æœ¬ä¹æ˜Ÿæ°”å­¦ï¼Œç»“åˆä¹æ˜Ÿã€æ–¹ä½ã€æ°”è¿è¿›è¡Œè¿åŠ¿åˆ†æ'
  },
  'å é™€': {
    personal: [
      'æ‹çˆ±ç¼˜åˆ†',
      'å©šå§»èµ°åŠ¿',
      'èŒåœºå‘å±•',
      'åˆ›ä¸šæ½œåŠ›',
      'è´¢ä½åˆ†æ'
    ],
    compatibility: [
      'å©šæœŸæ‹©æ—¥',
      'ç¼˜åˆ†èµ·è½',
      'å¤«å¦»æµå¹´',
      'åˆç›˜åˆ†æ'
    ],
    analysisType: 'å°åº¦å æ˜Ÿ',
    icon: 'ğŸ•‰ï¸',
    description: 'åŸºäºå°åº¦å é™€å æ˜Ÿå­¦ï¼Œç»“åˆçº³å…‹æ²™ç‰¹æ‹‰ã€è¾¾æ²™è¿›è¡Œè¿åŠ¿åˆ†æ'
  }
};

/* ==============================
   è‡ªåŠ¨æ–‡åŒ–è¯†åˆ«
============================== */
function autoDetectCulture(country, birthTime, name) {
  // æ ¹æ®å›½å®¶/åœ°åŒºã€å‡ºç”Ÿæ—¶é—´å’Œå§“åè‡ªåŠ¨è¯†åˆ«æ–‡åŒ–èƒŒæ™¯
  const countryLower = (country || '').toLowerCase();
  const nameStr = (name || '').toLowerCase();
  
  // ä¸­å›½åœ°åŒºè¯†åˆ«
  if (countryLower.includes('ä¸­å›½') || 
      countryLower.includes('china') ||
      countryLower.includes('taiwan') ||
      countryLower.includes('hong kong') ||
      countryLower.includes('macau')) {
    return 'ä¸œæ–¹';
  }
  
  // æ—¥æœ¬åœ°åŒºè¯†åˆ«
  if (countryLower.includes('æ—¥æœ¬') || 
      countryLower.includes('japan') ||
      nameStr.includes('ä½è—¤') || nameStr.includes('éˆ´æœ¨') ||
      nameStr.includes('é«˜æ©‹')) {
    return 'æ—¥å¼';
  }
  
  // å°åº¦åœ°åŒºè¯†åˆ«
  if (countryLower.includes('å°åº¦') || 
      countryLower.includes('india') ||
      nameStr.includes('singh') || nameStr.includes('kumar') ||
      nameStr.includes('patel')) {
    return 'å é™€';
  }
  
  // å…¶ä»–æƒ…å†µé»˜è®¤ä¸ºè¥¿æ–¹
  return 'è¥¿æ–¹';
}

/* ==============================
   è·å–è§£æåçš„æ–‡åŒ–ï¼ˆå¢å¼ºç‰ˆï¼‰
============================== */
function getCultureResolved() {
  const cultureSelect = $('culture');
  const selectedValue = cultureSelect?.value || 'auto';
  
  if (selectedValue === 'auto') {
    // è‡ªåŠ¨è¯†åˆ«
    const country = $('country1')?.value || '';
    const name = $('name1')?.value || '';
    return autoDetectCulture(country, '', name);
  }
  
  // æ˜ å°„æ–‡åŒ–åç§°åˆ°å†…éƒ¨æ ‡è¯†
  const cultureMap = {
    'ä¸œæ–¹': 'ä¸œæ–¹',
    'è¥¿æ–¹': 'è¥¿æ–¹',
    'æ—¥å¼': 'æ—¥å¼',
    'æ—¥å¼ä¹æ˜Ÿ': 'æ—¥å¼',
    'å é™€': 'å é™€',
    'å°åº¦å é™€': 'å é™€'
  };
  
  return cultureMap[selectedValue] || 'ä¸œæ–¹';
}

/* ==============================
   æ–‡åŒ–åˆ‡æ¢æ—¶æ›´æ–°ç•Œé¢
============================== */
function updateUIForCulture(culture) {
  const config = culturePurposeMap[culture] || culturePurposeMap['ä¸œæ–¹'];
  const type = getCurrentType();
  
  // æ›´æ–°åˆ†æç±»å‹æ˜¾ç¤º
  const analysisTypeElement = document.getElementById('analysisTypeDisplay');
  if (!analysisTypeElement) {
    // åˆ›å»ºæ˜¾ç¤ºå…ƒç´ 
    const titleElement = document.querySelector('.section h2');
    if (titleElement) {
      const analysisSpan = document.createElement('span');
      analysisSpan.id = 'analysisTypeDisplay';
      analysisSpan.style.cssText = 'font-size: 0.9rem; color: var(--gold); margin-left: 10px;';
      analysisSpan.textContent = ` Â· ${config.analysisType}`;
      titleElement.appendChild(analysisSpan);
    }
  } else {
    analysisTypeElement.textContent = ` Â· ${config.analysisType}`;
  }
  
  // æ›´æ–°æ–‡åŒ–å›¾æ ‡
  const cultureIconElement = document.getElementById('cultureIcon');
  if (!cultureIconElement) {
    const titleElement = document.querySelector('.section h2');
    if (titleElement) {
      const iconSpan = document.createElement('span');
      iconSpan.id = 'cultureIcon';
      iconSpan.style.cssText = 'margin-right: 8px;';
      iconSpan.textContent = config.icon;
      titleElement.insertBefore(iconSpan, titleElement.firstChild);
    }
  } else {
    cultureIconElement.textContent = config.icon;
  }
  
  // æ›´æ–°ç›®çš„é€‰é¡¹
  updatePurposeOptionsBasedOnCulture(culture);
}

/* ==============================
   æ”¹è¿›çš„ç›®çš„é€‰é¡¹æ›´æ–°
============================== */
function updatePurposeOptionsBasedOnCulture(cultureResolved) {
  const type = getCurrentType();
  const config = culturePurposeMap[cultureResolved] || culturePurposeMap['ä¸œæ–¹'];
  
  if (type === 'personal') {
    updatePersonalPurposeOptions(config.personal);
  } else {
    updateCompatibilityPurposeOptions(config.compatibility);
  }
}

function getCurrentType() {
  const typeSelect = $('type');
  return (typeSelect?.value || 'personal') === 'compatibility' ? 'compatibility' : 'personal';
}

function updatePersonalPurposeOptions(options) {
  if (!Array.isArray(options)) return;
  const select = $('purpose_personal');
  if (!select) return;
  const currentValue = select.value;

  select.innerHTML = '';
  
  // æŒ‰ç±»åˆ«åˆ†ç»„
  const groups = {
    'å§»ç¼˜ Love': ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿'],
    'äº‹ä¸š Career': ['èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›'],
    'è´¢è¿ Wealth': ['è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº'],
    'æ‹©æ—¥ Auspicious Date': ['æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥'],
    'é£æ°´ Feng Shui': ['ä½å®¶', 'åŠå…¬å®¤'],
    'æµ‹åå‘½å': ['ä¸ªäººæ”¹å']
  };

  Object.entries(groups).forEach(([label, items]) => {
    const available = items.filter(x => options.includes(x));
    if (!available.length) return;

    const og = document.createElement('optgroup');
    og.label = label;
    available.forEach(item => {
      const op = document.createElement('option');
      op.value = item;
      op.textContent = item;
      og.appendChild(op);
    });
    select.appendChild(og);
  });

  if (currentValue && select.querySelector(`option[value="${CSS.escape(currentValue)}"]`)) {
    select.value = currentValue;
  }
}

function updateCompatibilityPurposeOptions(options) {
  if (!Array.isArray(options)) return;
  const select = $('purpose_compatibility');
  if (!select) return;
  const currentValue = select.value;

  select.innerHTML = '';
  
  // åˆç›˜åˆ†ç»„
  const groups = {
    'åˆç›˜åˆ†æ Compatibility': [
      'å©šæœŸæ‹©æ—¥',
      'æ–°ç”Ÿå®å®æ‹©æ—¥',
      'æ–°å®¶å…¥ä½æ‹©æ—¥',
      'ç¼˜åˆ†èµ·è½',
      'å¤«å¦»æµå¹´',
      'åˆç›˜åˆ†æ',
      'æ–°å…¬å¸å…¥ä½æ‹©æ—¥',
      'äº‹ä¸šå…±äº‹',
      'æ–­è”ä¿®å¤',
      'å® ç‰©ç¼˜åˆ†'
    ],
    'æµ‹å Name Analysis': [
      'å®å®å',
      'å® ç‰©å',
      'å…¬å¸å',
      'æƒ…ä¾£åˆå'
    ]
  };

  Object.entries(groups).forEach(([label, items]) => {
    const available = items.filter(x => options.includes(x));
    if (!available.length) return;

    const og = document.createElement('optgroup');
    og.label = label;
    available.forEach(item => {
      const op = document.createElement('option');
      op.value = item;
      op.textContent = item;
      og.appendChild(op);
    });
    select.appendChild(og);
  });

  if (currentValue && select.querySelector(`option[value="${CSS.escape(currentValue)}"]`)) {
    select.value = currentValue;
  }
}

/* ==============================
   æ”¹è¿›çš„å‘½åç³»ç»Ÿ
============================== */
const namingSystem = {
  // å¸¸ç”¨å‰ç¥¥å­—åº“
  auspiciousCharacters: {
    male: [
      { char: 'ç¿', pinyin: 'ruÃ¬', meaning: 'èªæ˜ç¿æ™º', elements: ['é‡‘'], strokes: 14 },
      { char: 'å®‡', pinyin: 'yÇ”', meaning: 'æ°”å®‡è½©æ˜‚', elements: ['åœŸ'], strokes: 6 },
      { char: 'æ³½', pinyin: 'zÃ©', meaning: 'æ©æ³½æ·±åš', elements: ['æ°´'], strokes: 8 },
      { char: 'æµ©', pinyin: 'hÃ o', meaning: 'æµ©ç„¶æ­£æ°”', elements: ['æ°´'], strokes: 10 },
      { char: 'è½©', pinyin: 'xuÄn', meaning: 'å™¨å®‡è½©æ˜‚', elements: ['åœŸ'], strokes: 7 },
      { char: 'åš', pinyin: 'bÃ³', meaning: 'åšå­¦å¤šæ‰', elements: ['æ°´'], strokes: 12 },
      { char: 'æ–‡', pinyin: 'wÃ©n', meaning: 'æ–‡è´¨å½¬å½¬', elements: ['æ°´'], strokes: 4 },
      { char: 'æ˜', pinyin: 'mÃ­ng', meaning: 'å…‰æ˜ç£Šè½', elements: ['ç«'], strokes: 8 },
      { char: 'å¿—', pinyin: 'zhÃ¬', meaning: 'å¿—å‘è¿œå¤§', elements: ['ç«'], strokes: 7 },
      { char: 'ä¿Š', pinyin: 'jÃ¹n', meaning: 'è‹±ä¿Šæ½‡æ´’', elements: ['ç«'], strokes: 9 }
    ],
    female: [
      { char: 'æ¬£', pinyin: 'xÄ«n', meaning: 'æ¬£æ¬£å‘è£', elements: ['æœ¨'], strokes: 8 },
      { char: 'æ€¡', pinyin: 'yÃ­', meaning: 'å¿ƒæ—·ç¥æ€¡', elements: ['åœŸ'], strokes: 8 },
      { char: 'é›¨', pinyin: 'yÇ”', meaning: 'é›¨éœ²æ©æ³½', elements: ['æ°´'], strokes: 8 },
      { char: 'é™', pinyin: 'jÃ¬ng', meaning: 'å¨´é™ä¼˜é›…', elements: ['é‡‘'], strokes: 14 },
      { char: 'é›…', pinyin: 'yÇ', meaning: 'æ¸©æ–‡å°”é›…', elements: ['æœ¨'], strokes: 12 },
      { char: 'å©·', pinyin: 'tÃ­ng', meaning: 'å©·å©·ç‰ç«‹', elements: ['ç«'], strokes: 12 },
      { char: 'æ…§', pinyin: 'huÃ¬', meaning: 'èªæ…§ä¼¶ä¿', elements: ['æ°´'], strokes: 15 },
      { char: 'å©‰', pinyin: 'wÇn', meaning: 'æ¸©å©‰å¯äºº', elements: ['åœŸ'], strokes: 11 },
      { char: 'ç³', pinyin: 'lÃ­n', meaning: 'ç³ç…æ»¡ç›®', elements: ['æœ¨'], strokes: 12 },
      { char: 'è¯—', pinyin: 'shÄ«', meaning: 'è¯—æƒ…ç”»æ„', elements: ['é‡‘'], strokes: 13 }
    ],
    unisex: [
      { char: 'å®‰', pinyin: 'Än', meaning: 'å¹³å®‰å‰ç¥¥', elements: ['åœŸ'], strokes: 6 },
      { char: 'ä¹', pinyin: 'lÃ¨', meaning: 'å¿«ä¹å¹¸ç¦', elements: ['ç«'], strokes: 15 },
      { char: 'å®', pinyin: 'nÃ­ng', meaning: 'å®‰å®å¹³é™', elements: ['ç«'], strokes: 5 },
      { char: 'å’Œ', pinyin: 'hÃ©', meaning: 'å’Œè°ç¾æ»¡', elements: ['æ°´'], strokes: 8 },
      { char: 'å˜‰', pinyin: 'jiÄ', meaning: 'ç¾å¥½å‰ç¥¥', elements: ['æœ¨'], strokes: 14 }
    ]
  },

  // å§“æ°åº“
  commonSurnames: ['ç‹','æ','å¼ ','åˆ˜','é™ˆ','æ¨','é»„','èµµ','å‘¨','å´','å¾','å­™','æœ±','é©¬','èƒ¡','éƒ­','æ—','ä½•','é«˜','æ¢'],
  
  // ç”Ÿæˆåå­—æ¨è
  generateNameSuggestions(baziData, purpose, gender = '') {
    const suggestions = [];
    const { elements } = baziData;
    
    // ç¡®å®šéœ€è¦è¡¥å……çš„äº”è¡Œ
    const elementScores = [
      { element: 'æœ¨', score: elements['æœ¨'] || 0 },
      { element: 'ç«', score: elements['ç«'] || 0 },
      { element: 'åœŸ', score: elements['åœŸ'] || 0 },
      { element: 'é‡‘', score: elements['é‡‘'] || 0 },
      { element: 'æ°´', score: elements['æ°´'] || 0 }
    ].sort((a, b) => a.score - b.score);
    
    const weakElements = elementScores.slice(0, 2).map(e => e.element);
    const strongElements = elementScores.slice(-2).map(e => e.element);
    
    // æ ¹æ®ç›®çš„é€‰æ‹©åå­—ç±»å‹
    let namePool = [];
    if (gender === 'ç”·') {
      namePool = [...this.auspiciousCharacters.male, ...this.auspiciousCharacters.unisex];
    } else if (gender === 'å¥³') {
      namePool = [...this.auspiciousCharacters.female, ...this.auspiciousCharacters.unisex];
    } else {
      namePool = [...this.auspiciousCharacters.male, ...this.auspiciousCharacters.female, ...this.auspiciousCharacters.unisex];
    }
    
    // é€‰æ‹©è¡¥å……å¼±äº”è¡Œçš„å­—
    const recommendedChars = namePool.filter(char => 
      char.elements.some(el => weakElements.includes(el))
    );
    
    // å¦‚æœæ²¡æœ‰åˆé€‚çš„ï¼Œé€‰æ‹©ä¸­æ€§äº”è¡Œçš„å­—
    const backupChars = namePool.filter(char => 
      !char.elements.some(el => strongElements.includes(el))
    );
    
    const finalChars = recommendedChars.length > 0 ? recommendedChars : backupChars;
    
    // éšæœºé€‰æ‹©å§“æ°
    const randomSurname = this.commonSurnames[Math.floor(Math.random() * this.commonSurnames.length)];
    
    // ç”Ÿæˆ6ä¸ªåå­—å»ºè®®
    for (let i = 0; i < 6 && i < finalChars.length; i++) {
      const char1 = finalChars[i];
      const char2 = finalChars[(i + 3) % finalChars.length];
      
      const fullName = randomSurname + char1.char + (Math.random() > 0.3 ? char2.char : '');
      const pinyin = randomSurname + ' ' + char1.pinyin + (char2 ? ' ' + char2.pinyin : '');
      const meaning = `${char1.meaning}${char2 ? `ã€${char2.meaning}` : ''}`;
      
      // è®¡ç®—æ€»ç¬”ç”»æ•°
      const surnameStrokes = this.getStrokeCount(randomSurname);
      const totalStrokes = surnameStrokes + char1.strokes + (char2 ? char2.strokes : 0);
      
      // è¯„åˆ†é€»è¾‘
      let rating = 85 + Math.floor(Math.random() * 15); // 85-99åˆ†
      if (char1.elements.some(el => weakElements.includes(el))) rating += 5;
      if (totalStrokes % 2 === 0) rating += 3; // å¶æ•°ç¬”ç”»åŠ åˆ†
      
      suggestions.push({
        name: fullName,
        pinyin: pinyin,
        meaning: meaning,
        elements: [...new Set([...char1.elements, ...(char2 ? char2.elements : [])])],
        strokes: totalStrokes,
        rating: Math.min(99, rating),
        explanation: this.generateExplanation(fullName, char1, char2, weakElements, purpose)
      });
    }
    
    return suggestions;
  },
  
  // ç”Ÿæˆåå­—è§£é‡Š
  generateExplanation(name, char1, char2, weakElements, purpose) {
    const explanations = [];
    
    // äº”è¡Œè§£é‡Š
    const elementNames = {
      'æœ¨': 'æœ¨è¡Œï¼ˆç”Ÿæœºã€æˆé•¿ï¼‰',
      'ç«': 'ç«è¡Œï¼ˆçƒ­æƒ…ã€æ´»åŠ›ï¼‰',
      'åœŸ': 'åœŸè¡Œï¼ˆç¨³å®šã€åŒ…å®¹ï¼‰',
      'é‡‘': 'é‡‘è¡Œï¼ˆæœæ–­ã€åšéŸ§ï¼‰',
      'æ°´': 'æ°´è¡Œï¼ˆæ™ºæ…§ã€æµåŠ¨ï¼‰'
    };
    
    const nameElements = [...char1.elements, ...(char2 ? char2.elements : [])];
    const elementStr = nameElements.map(el => elementNames[el]).join('ã€');
    
    explanations.push(`æ­¤åè•´å«${elementStr}ï¼Œèƒ½æœ‰æ•ˆè¡¥å……å‘½ç†ä¸­è¾ƒå¼±çš„äº”è¡Œã€‚`);
    
    // æ ¹æ®ç›®çš„æ·»åŠ è§£é‡Š
    if (purpose === 'å®å®å') {
      explanations.push(`å¯“æ„ç¾å¥½ï¼Œé€‚åˆæ–°ç”Ÿå„¿ä½¿ç”¨ï¼Œæœ‰åŠ©äºå­©å­å¥åº·æˆé•¿ã€èªæ˜ä¼¶ä¿ã€‚`);
    } else if (purpose === 'ä¸ªäººæ”¹å') {
      explanations.push(`æ­¤åæœ‰åŠ©äºæ”¹å–„è¿åŠ¿ï¼Œå¢å¼ºä¸ªäººæ°”åœºï¼Œé€‚åˆå¸Œæœ›æ”¹å˜ç°çŠ¶çš„äººå£«ã€‚`);
    } else if (purpose === 'æƒ…ä¾£åˆå') {
      explanations.push(`åå­—å’Œè°ç¾å¥½ï¼Œè±¡å¾ä¸¤äººå…³ç³»å’Œç¦ï¼Œå…±åŒæˆé•¿ã€‚`);
    }
    
    // ç¬”ç”»è§£é‡Š
    const strokes = char1.strokes + (char2 ? char2.strokes : 0);
    if (strokes % 2 === 0) {
      explanations.push(`ç¬”ç”»æ•°ä¸º${strokes}ï¼Œå±äºå‰æ•°ï¼Œè±¡å¾å¹³è¡¡ä¸å’Œè°ã€‚`);
    }
    
    return explanations.join(' ');
  },
  
  // ç®€å•çš„ç¬”ç”»æ•°æŸ¥è¯¢ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦å®Œæ•´æ•°æ®åº“ï¼‰
  getStrokeCount(char) {
    const strokeMap = {
      'ç‹': 4, 'æ': 7, 'å¼ ': 7, 'åˆ˜': 15, 'é™ˆ': 7, 'æ¨': 13, 'é»„': 12, 'èµµ': 14,
      'å‘¨': 8, 'å´': 7, 'å¾': 10, 'å­™': 10, 'æœ±': 6, 'é©¬': 3, 'èƒ¡': 9, 'éƒ­': 15,
      'æ—': 8, 'ä½•': 7, 'é«˜': 10, 'æ¢': 11
    };
    return strokeMap[char] || 8;
  }
};

/* ==============================
   å…«å­—åˆ†æéƒ¨åˆ†ï¼ˆä½¿ç”¨æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨ï¼‰
============================== */
function generateBaziAnalysis(baziResult) {
  if (!baziResult) return '';
  
  const { pillars, percents, tenGods, dayStem } = baziResult;
  
  return `
    <div class="ai-section">
      <h5>ğŸ— å…«å­—å‘½ç›˜</h5>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 12px 0;">
        <div style="text-align: center; padding: 12px; background: rgba(14, 21, 32, 0.6); border-radius: 8px;">
          <div style="color: #98a7b7; font-size: 0.85rem;">å¹´æŸ±</div>
          <div style="font-size: 1.2rem; font-weight: 700; color: #f2d27a; margin: 4px 0;">${pillars.year.stem}${pillars.year.branch}</div>
          <div style="color: #58b9ff; font-size: 0.8rem;">${pillars.year.element}Â·${pillars.year.nayin}</div>
          <div style="color: #98a7b7; font-size: 0.75rem; margin-top: 4px;">${tenGods[0]}</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(14, 21, 32, 0.6); border-radius: 8px;">
          <div style="color: #98a7b7; font-size: 0.85rem;">æœˆæŸ±</div>
          <div style="font-size: 1.2rem; font-weight: 700; color: #f2d27a; margin: 4px 0;">${pillars.month.stem}${pillars.month.branch}</div>
          <div style="color: #58b9ff; font-size: 0.8rem;">${pillars.month.element}Â·${pillars.month.nayin}</div>
          <div style="color: #98a7b7; font-size: 0.75rem; margin-top: 4px;">${tenGods[1]}</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(14, 21, 32, 0.6); border-radius: 8px;">
          <div style="color: #98a7b7; font-size: 0.85rem;">æ—¥æŸ±ï¼ˆæ—¥ä¸»ï¼‰</div>
          <div style="font-size: 1.2rem; font-weight: 700; color: #f2d27a; margin: 4px 0;">${pillars.day.stem}${pillars.day.branch}</div>
          <div style="color: #58b9ff; font-size: 0.8rem;">${pillars.day.element}Â·${pillars.day.nayin}</div>
          <div style="color: #98a7b7; font-size: 0.75rem; margin-top: 4px;">æ—¥ä¸»</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(14, 21, 32, 0.6); border-radius: 8px;">
          <div style="color: #98a7b7; font-size: 0.85rem;">æ—¶æŸ±</div>
          <div style="font-size: 1.2rem; font-weight: 700; color: #f2d27a; margin: 4px 0;">${pillars.hour.stem}${pillars.hour.branch}</div>
          <div style="color: #58b9ff; font-size: 0.8rem;">${pillars.hour.element}Â·${pillars.hour.nayin}</div>
          <div style="color: #98a7b7; font-size: 0.75rem; margin-top: 4px;">${tenGods[3]}</div>
        </div>
      </div>
      
      <div style="margin-top: 16px;">
        <h6 style="color: #f2d27a; margin-bottom: 8px;">äº”è¡Œå¹³è¡¡åˆ†æ</h6>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
          ${['æœ¨','ç«','åœŸ','é‡‘','æ°´'].map(el => {
            const percentKey = {
              'æœ¨': 'wood', 'ç«': 'fire', 'åœŸ': 'earth',
              'é‡‘': 'metal', 'æ°´': 'water'
            }[el];
            const percent = percents[percentKey] || 0;
            const color = getElementColor(el);
            
            let description = 'é€‚ä¸­';
            if (percent >= 30) description = 'å¼ºæ—º';
            else if (percent >= 20) description = 'é€‚ä¸­';
            else if (percent >= 10) description = 'åå¼±';
            else description = 'è¿‡å¼±';
            
            return `
              <div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-weight: 600; color: ${color}">${el}è¡Œ</span>
                  <span style="color: #58b9ff; font-weight: 600;">${percent}%</span>
                </div>
                <div style="height: 8px; background: #243244; border-radius: 4px; overflow: hidden;">
                  <div style="height: 100%; width: ${percent}%; background: ${color}; border-radius: 4px;"></div>
                </div>
                <div style="font-size: 0.75rem; color: #98a7b7; margin-top: 2px;">
                  ${description}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

/* ==============================
   è¥¿æ–¹å æ˜Ÿåˆ†æ
============================== */
function generateWesternAstrologyAnalysis(data) {
  // ç®€åŒ–ç‰ˆå æ˜Ÿåˆ†æ
  const zodiacSigns = [
    'ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§', 'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§',
    'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§'
  ];
  
  // æ ¹æ®æœˆä»½ç²—ç•¥è®¡ç®—æ˜Ÿåº§
  const month = data.month;
  let sign = '';
  if (month >= 3 && month <= 4) sign = zodiacSigns[0]; // ç™½ç¾Š
  else if (month >= 4 && month <= 5) sign = zodiacSigns[1]; // é‡‘ç‰›
  else if (month >= 5 && month <= 6) sign = zodiacSigns[2]; // åŒå­
  else if (month >= 6 && month <= 7) sign = zodiacSigns[3]; // å·¨èŸ¹
  else if (month >= 7 && month <= 8) sign = zodiacSigns[4]; // ç‹®å­
  else if (month >= 8 && month <= 9) sign = zodiacSigns[5]; // å¤„å¥³
  else if (month >= 9 && month <= 10) sign = zodiacSigns[6]; // å¤©ç§¤
  else if (month >= 10 && month <= 11) sign = zodiacSigns[7]; // å¤©è
  else if (month >= 11 && month <= 12) sign = zodiacSigns[8]; // å°„æ‰‹
  else if (month === 12 || month <= 1) sign = zodiacSigns[9]; // æ‘©ç¾¯
  else if (month >= 1 && month <= 2) sign = zodiacSigns[10]; // æ°´ç“¶
  else if (month >= 2 && month <= 3) sign = zodiacSigns[11]; // åŒé±¼
  
  return `
    <div class="ai-section">
      <h5>â­ å æ˜Ÿåˆ†æ</h5>
      <div style="display: flex; align-items: center; gap: 20px; margin: 12px 0;">
        <div style="text-align: center;">
          <div style="font-size: 2rem; color: #f2d27a;">${getZodiacEmoji(sign)}</div>
          <div style="color: #58b9ff; font-weight: 600; margin-top: 4px;">${sign}</div>
        </div>
        <div>
          <p>å¤ªé˜³æ˜Ÿåº§ï¼š<strong>${sign}</strong></p>
          <p style="color: var(--muted); font-size: 0.9rem;">
            åŸºäºè¥¿æ–¹å æ˜Ÿå­¦ï¼Œå¤ªé˜³æ˜Ÿåº§ä»£è¡¨æ‚¨çš„æ ¸å¿ƒäººæ ¼å’Œè‡ªæˆ‘è¡¨è¾¾æ–¹å¼ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

/* ==============================
   æ”¹è¿›çš„æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿï¼ˆæ–‡åŒ–é€‚é…ç‰ˆï¼‰
============================== */
async function generateDeepReport(data, focus, type, culture, baziResult = null, namingSuggestions = null) {
  const now = new Date();
  const currentYear = now.getFullYear();
  const config = culturePurposeMap[culture] || culturePurposeMap['ä¸œæ–¹'];
  
  let reportHTML = '';
  
  // 1. æŠ¥å‘Šæ ‡é¢˜å’Œæ¦‚è¦
  reportHTML += `
    <div class="ai-report">
      <h4>${config.icon} ${config.analysisType} Â· ${focus}æ·±åº¦åˆ†ææŠ¥å‘Š</h4>
      
      <div class="ai-section">
        <h5>ğŸ“‹ æŠ¥å‘Šæ¦‚è¦</h5>
        <p>æœ¬æŠ¥å‘ŠåŸºäº${config.description}ï¼Œç»“åˆæ‚¨çš„å‡ºç”Ÿä¿¡æ¯è¿›è¡Œæ·±åº¦åˆ†æã€‚</p>
        <p style="color: var(--muted); font-size: 0.9rem; margin-top: 8px;">
          <strong>åˆ†æä½“ç³»ï¼š</strong>${config.analysisType}<br>
          <strong>æŠ¥å‘Šç„¦ç‚¹ï¼š</strong>${focus}<br>
          <strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${now.toLocaleString('zh-CN')}
        </p>
      </div>
  `;
  
  // 2. æ ¹æ®ä¸åŒæ–‡åŒ–æ˜¾ç¤ºä¸åŒåˆ†æå†…å®¹
  if (culture === 'ä¸œæ–¹' && baziResult) {
    // å…«å­—åˆ†æï¼ˆä½¿ç”¨æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨ï¼‰
    reportHTML += generateBaziAnalysis(baziResult);
  } else if (culture === 'è¥¿æ–¹') {
    // å æ˜Ÿåˆ†æ
    reportHTML += generateWesternAstrologyAnalysis(data);
  } else if (culture === 'æ—¥å¼') {
    // ä¹æ˜Ÿåˆ†æ
    reportHTML += `
      <div class="ai-section">
        <h5>ğŸŒ¸ ä¹æ˜Ÿæ°”å­¦</h5>
        <p>åŸºäºæ—¥æœ¬ä¹æ˜Ÿæ°”å­¦åˆ†æï¼Œæ‚¨çš„å‘½ç†æ˜¾ç¤º...</p>
      </div>
    `;
  } else if (culture === 'å é™€') {
    // å°åº¦å æ˜Ÿåˆ†æ
    reportHTML += `
      <div class="ai-section">
        <h5>ğŸ•‰ï¸ å é™€å æ˜Ÿ</h5>
        <p>åŸºäºå°åº¦å é™€å æ˜Ÿå­¦åˆ†æï¼Œæ‚¨çš„å‘½ç†æ˜¾ç¤º...</p>
      </div>
    `;
  }
  
  // 3. æ·±åº¦åˆ†æå†…å®¹
  reportHTML += await generateDeepAnalysisContent(focus, type, culture, currentYear, data);
  
  // 4. å‘½åæ¨èï¼ˆå¦‚æœæ˜¯æµ‹åç›¸å…³ä¸”æ–‡åŒ–æ”¯æŒï¼‰
  if (namingSuggestions && namingSuggestions.length > 0 && 
      (culture === 'ä¸œæ–¹' || culture === 'æ—¥å¼')) {
    reportHTML += generateNamingSection(focus, namingSuggestions, culture);
  }
  
  // 5. è¡ŒåŠ¨è®¡åˆ’
  reportHTML += generateActionPlan(focus, type, culture);
  
  // 6. æ³¨æ„äº‹é¡¹
  reportHTML += generateCulturalNotes(culture);
  
  reportHTML += `</div>`;
  
  return reportHTML;
}

/* ==============================
   åˆç›˜åˆ†æç”Ÿæˆï¼ˆä½¿ç”¨æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨ï¼‰
============================== */
async function generateCompatibilityReport(person1, person2, focus, culture) {
  // è®¡ç®—ä¸¤äººå…«å­—ï¼ˆå¦‚æœæ˜¯ä¸œæ–¹æ–‡åŒ–ï¼‰
  let bazi1 = null, bazi2 = null;
  
  if (culture === 'ä¸œæ–¹') {
    const calculator = new BaziCalculator();
    bazi1 = calculator.calculateBazi(
      person1.year, person1.month, person1.day, person1.hour, person1.minute, person1.timeUnknown
    );
    bazi2 = calculator.calculateBazi(
      person2.year, person2.month, person2.day, person2.hour, person2.minute, person2.timeUnknown
    );
  }
  
  // è®¡ç®—åˆç›˜è¯„åˆ†
  const score = calculateCompatibilityScore(bazi1, bazi2, culture);
  
  const config = culturePurposeMap[culture] || culturePurposeMap['ä¸œæ–¹'];
  
  let reportHTML = `
    <div class="ai-report">
      <h4>${config.icon} ${config.analysisType} Â· ${focus}åˆç›˜åˆ†ææŠ¥å‘Š</h4>
      
      <div class="compatibility-grid">
        <div class="person-card">
          <div class="person-name">${person1.name || 'æœ¬äºº'}</div>
          <div style="margin-top: 8px;">
            ${culture === 'ä¸œæ–¹' && bazi1 ? `
              <div style="color: #98a7b7; font-size: 0.9rem;">
                å…«å­—ï¼š${bazi1.pillars.year.stem}${bazi1.pillars.year.branch} 
                ${bazi1.pillars.month.stem}${bazi1.pillars.month.branch} 
                ${bazi1.pillars.day.stem}${bazi1.pillars.day.branch} 
                ${bazi1.pillars.hour.stem}${bazi1.pillars.hour.branch}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="compatibility-score">
          <div class="score-circle">
            <div class="score-value">${score.total}</div>
          </div>
          <div class="score-label">${t('compatibility_score')}</div>
          <div style="margin-top: 12px; font-size: 0.9rem; color: #98a7b7;">
            ${getCompatibilityLevel(score.total)}
          </div>
        </div>
        
        <div class="person-card">
          <div class="person-name">${person2.name || 'ç¬¬äºŒäºº'}</div>
          <div style="margin-top: 8px;">
            ${culture === 'ä¸œæ–¹' && bazi2 ? `
              <div style="color: #98a7b7; font-size: 0.9rem;">
                å…«å­—ï¼š${bazi2.pillars.year.stem}${bazi2.pillars.year.branch} 
                ${bazi2.pillars.month.stem}${bazi2.pillars.month.branch} 
                ${bazi2.pillars.day.stem}${bazi2.pillars.day.branch} 
                ${bazi2.pillars.hour.stem}${bazi2.pillars.hour.branch}
              </div>
            ` : ''}
          </div>
        </div>
      </div>
  `;
  
  // æ·»åŠ åˆç›˜åˆ†æè¯¦æƒ…
  reportHTML += await generateCompatibilityDetails(bazi1, bazi2, focus, score, culture);
  
  reportHTML += generateCulturalNotes(culture);
  
  reportHTML += `
    </div>
  `;
  
  return reportHTML;
}

/* ==============================
   ä¸»ç”Ÿæˆå‡½æ•°ï¼ˆä½¿ç”¨æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨ï¼‰
============================== */
async function onGenerate() {
  const errorEl = $('error');
  if (errorEl) errorEl.style.display = 'none';
  
  const type = getCurrentType();
  const err = validate(type);
  if (err) {
    showError(err);
    return;
  }
  
  const me = readBirthInputs('1');
  const focus = getFocus();
  const culture = getCultureResolved();
  const gender = $('gender1')?.value || '';
  
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const resultSection = $('result');
    const resultContent = $('result-content');
    
    resultContent.innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š...</p>
        <p style="font-size: 0.85rem; color: #98a7b7;">è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨è¿›è¡Œä¸“ä¸šåˆ†æ</p>
      </div>
    `;
    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    let reportHTML = '';
    let baziResult = null;
    let namingSuggestions = null;
    
    // å¦‚æœæ˜¯ä¸œæ–¹æ–‡åŒ–ï¼Œä½¿ç”¨æ­£ç¡®çš„å…«å­—è®¡ç®—å™¨
    if (culture === 'ä¸œæ–¹') {
      const calculator = new BaziCalculator();
      baziResult = calculator.calculateBazi(
        me.year, me.month, me.day, me.hour, me.minute, me.timeUnknown
      );
      
      if (!baziResult) {
        throw new Error('å…«å­—è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡ºç”Ÿä¿¡æ¯');
      }
    }
    
    // å¦‚æœæ˜¯æµ‹åç›¸å…³ï¼Œç”Ÿæˆåå­—æ¨è
    if (['å®å®å', 'ä¸ªäººæ”¹å', 'æƒ…ä¾£åˆå'].includes(focus) && culture === 'ä¸œæ–¹') {
      namingSuggestions = namingSystem.generateNameSuggestions(
        baziResult || { elements: {} },
        focus,
        gender
      );
    }
    
    // æ ¹æ®ç±»å‹ç”ŸæˆæŠ¥å‘Š
    if (type === 'compatibility') {
      const person2 = readBirthInputs('2');
      reportHTML = await generateCompatibilityReport(me, person2, focus, culture);
    } else {
      reportHTML = await generateDeepReport(me, focus, type, culture, baziResult, namingSuggestions);
    }
    
    // æ›´æ–°ç»“æœåŒºåŸŸ
    resultContent.innerHTML = reportHTML;
    
  } catch (error) {
    console.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š', error);
    showError('åˆ†æç”Ÿæˆå¤±è´¥ï¼š' + error.message);
  }
}

/* ==============================
   è¡¨å•å¤„ç†å‡½æ•°
============================== */
function togglePartner(typeValue) {
  const section = $('partner-section');
  const personal = $('purpose_personal');
  const compat = $('purpose_compatibility');
  const show = (typeValue === 'compatibility');

  if (section) section.style.display = show ? 'block' : 'none';
  if (personal) {
    personal.style.display = show ? 'none' : 'block';
    personal.disabled = show;
  }
  if (compat) {
    compat.style.display = show ? 'block' : 'none';
    compat.disabled = !show;
  }
}

function readBirthInputs(prefix='1') {
  const name = ($(`name${prefix}`)?.value || '').trim();
  const birthdate = ($(`birthdate${prefix}`)?.value || '').trim();
  const birthtime = ($(`birthtime${prefix}`)?.value || '').trim();
  const country = ($(`country${prefix}`)?.value || '').trim();
  const timeUnknown = !birthtime;

  let year=0, month=0, day=0, hour=0, minute=0;
  if (birthdate) {
    const parts = birthdate.split('-').map(Number);
    year = parts[0] || 0;
    month = parts[1] || 0;
    day = parts[2] || 0;
  }
  if (birthtime) {
    const tp = birthtime.split(':').map(Number);
    hour = tp[0] || 0;
    minute = tp[1] || 0;
  }
  return { name, birthdate, birthtime, country, timeUnknown, year, month, day, hour, minute };
}

function getFocus() {
  const type = getCurrentType();
  if (type === 'compatibility') return $('purpose_compatibility')?.value || '';
  return $('purpose_personal')?.value || '';
}

function validate(type) {
  const me = readBirthInputs('1');
  if (!me.name) return t('err_fill_name1');
  if (!me.birthdate) return t('err_fill_date1');
  if (!me.country) return t('err_fill_country1');
  
  // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
  if (me.year < 1900 || me.year > new Date().getFullYear()) {
    return 'è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºç”Ÿå¹´ä»½ï¼ˆ1900-ç°åœ¨ï¼‰';
  }
  
  // æ£€æŸ¥æ—¶é—´æ ¼å¼
  if (me.birthtime && !validateBirthTime(me.birthtime)) {
    return 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´æ ¼å¼ï¼ˆHH:MMï¼‰';
  }

  if (type === 'compatibility') {
    const p = readBirthInputs('2');
    if (!p.name) return t('err_fill_name2');
    if (!p.birthdate) return t('err_fill_date2');
    if (!p.country) return t('err_fill_country2');
    
    if (p.year < 1900 || p.year > new Date().getFullYear()) {
      return 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç¬¬äºŒäººå‡ºç”Ÿå¹´ä»½ï¼ˆ1900-ç°åœ¨ï¼‰';
    }
    
    if (p.birthtime && !validateBirthTime(p.birthtime)) {
      return 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç¬¬äºŒäººæ—¶é—´æ ¼å¼ï¼ˆHH:MMï¼‰';
    }
  }
  return '';
}

function validateBirthTime(timeStr) {
  if (!timeStr) return true;
  const regex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
  return regex.test(timeStr);
}

function showError(message) {
  const errorEl = $('error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

/* ==============================
   è¾…åŠ©å‡½æ•°
============================== */
function getZodiacEmoji(sign) {
  const emojiMap = {
    'ç™½ç¾Šåº§': 'â™ˆ', 'é‡‘ç‰›åº§': 'â™‰', 'åŒå­åº§': 'â™Š', 'å·¨èŸ¹åº§': 'â™‹',
    'ç‹®å­åº§': 'â™Œ', 'å¤„å¥³åº§': 'â™', 'å¤©ç§¤åº§': 'â™', 'å¤©èåº§': 'â™',
    'å°„æ‰‹åº§': 'â™', 'æ‘©ç¾¯åº§': 'â™‘', 'æ°´ç“¶åº§': 'â™’', 'åŒé±¼åº§': 'â™“'
  };
  return emojiMap[sign] || 'â­';
}

function getElementKey(element) {
  const map = { 'æœ¨': 'wood', 'ç«': 'fire', 'åœŸ': 'earth', 'é‡‘': 'metal', 'æ°´': 'water' };
  return map[element] || 'wood';
}

function getElementColor(el) {
  const map = {
    'æœ¨': '#2d5c2a',
    'ç«': '#5c2a2a',
    'åœŸ': '#5c542a',
    'é‡‘': '#2a3a5c',
    'æ°´': '#2a5c5c'
  };
  return map[el] || '#58b9ff';
}

function getElementDescription(element, percent) {
  if (percent >= 30) return 'å¼ºæ—º';
  if (percent >= 20) return 'é€‚ä¸­';
  if (percent >= 10) return 'åå¼±';
  return 'è¿‡å¼±';
}

function calculateCompatibilityScore(bazi1, bazi2, culture) {
  if (culture !== 'ä¸œæ–¹' || !bazi1 || !bazi2) {
    return {
      total: 75 + Math.floor(Math.random() * 20),
      elements: 0,
      pillars: 0,
      overall: 0
    };
  }
  
  // ç®€åŒ–ç‰ˆçš„åˆç›˜è¯„åˆ†ç®—æ³•
  let totalScore = 70;
  
  // äº”è¡Œç›¸ç”Ÿç›¸å…‹è¯„åˆ†
  const elementRelations = {
    'æœ¨': { 'æœ¨': 0, 'ç«': 10, 'åœŸ': -5, 'é‡‘': -10, 'æ°´': 10 },
    'ç«': { 'æœ¨': 10, 'ç«': 0, 'åœŸ': 10, 'é‡‘': -5, 'æ°´': -10 },
    'åœŸ': { 'æœ¨': -5, 'ç«': 10, 'åœŸ': 0, 'é‡‘': 10, 'æ°´': -5 },
    'é‡‘': { 'æœ¨': -10, 'ç«': -5, 'åœŸ': 10, 'é‡‘': 0, 'æ°´': 10 },
    'æ°´': { 'æœ¨': 10, 'ç«': -10, 'åœŸ': -5, 'é‡‘': 10, 'æ°´': 0 }
  };
  
  const elem1 = bazi1.pillars.day.element;
  const elem2 = bazi2.pillars.day.element;
  const elemScore = elementRelations[elem1]?.[elem2] || 0;
  totalScore += elemScore;
  
  totalScore = Math.max(40, Math.min(99, totalScore));
  
  return {
    total: totalScore,
    elements: elemScore,
    pillars: 0,
    overall: 0
  };
}

function getCompatibilityLevel(score) {
  if (score >= 90) return 'å¤©ä½œä¹‹åˆ â˜…â˜…â˜…â˜…â˜…';
  if (score >= 80) return 'éå¸¸ç›¸é… â˜…â˜…â˜…â˜…â˜†';
  if (score >= 70) return 'æ¯”è¾ƒåˆé€‚ â˜…â˜…â˜…â˜†â˜†';
  if (score >= 60) return 'éœ€è¦ç£¨åˆ â˜…â˜…â˜†â˜†â˜†';
  return 'æŒ‘æˆ˜è¾ƒå¤š â˜…â˜†â˜†â˜†â˜†';
}

async function generateCompatibilityDetails(bazi1, bazi2, focus, score, culture) {
  let detailsHTML = '';
  
  detailsHTML += `
    <div class="deep-analysis" style="margin-top: 20px;">
      <div class="deep-analysis-title">
        <span class="deep-analysis-icon">ğŸ“Š</span>
        <h5>åˆç›˜æ·±åº¦åˆ†æ</h5>
      </div>
  `;
  
  // æ ¹æ®ä¸åŒçš„focusç”Ÿæˆå…·ä½“å†…å®¹
  switch(focus) {
    case 'ç¼˜åˆ†èµ·è½':
      detailsHTML += `
        <div class="analysis-point">
          <h6>ç¼˜åˆ†æ·±æµ…åˆ†æ</h6>
          <div class="analysis-detail">
            <p>ä¸¤äººçš„ç¼˜åˆ†åˆ†æç»“æœæ˜¾ç¤ºï¼š</p>
            <ul>
              <li><strong>ç¼˜åˆ†æŒ‡æ•°ï¼š</strong>${score.total}åˆ†ï¼ˆ${getCompatibilityLevel(score.total)}ï¼‰</li>
              <li><strong>å…³ç³»ç‰¹ç‚¹ï¼š</strong>ç›¸äº’å¸å¼•ï¼Œä½†éœ€è¦æ—¶é—´ç£¨åˆ</li>
              <li><strong>ç”œèœœæœŸï¼š</strong>æœªæ¥3-6ä¸ªæœˆæ˜¯å…³ç³»å‡æ¸©çš„å…³é”®æœŸ</li>
              <li><strong>æŒ‘æˆ˜æœŸï¼š</strong>éœ€æ³¨æ„æ˜å¹´æ˜¥å­£å¯èƒ½å‡ºç°çš„æ²Ÿé€šé—®é¢˜</li>
            </ul>
          </div>
        </div>
      `;
      break;
      
    case 'å¤«å¦»æµå¹´':
      detailsHTML += `
        <div class="analysis-point">
          <h6>å©šå§»è¿åŠ¿åˆ†æ</h6>
          <div class="analysis-detail">
            <p>å¤«å¦»${new Date().getFullYear()}å¹´æµå¹´åˆ†æï¼š</p>
            <ul>
              <li><strong>å’Œè°æŒ‡æ•°ï¼š</strong>${score.total}åˆ†</li>
              <li><strong>è´¢è¿æ–¹é¢ï¼š</strong>åˆä½œæŠ•èµ„æœ‰åˆ©ï¼Œéœ€æ³¨æ„é£é™©æ§åˆ¶</li>
              <li><strong>å¥åº·æ–¹é¢ï¼š</strong>ç›¸äº’ç…§é¡¾ï¼Œå…³æ³¨å½¼æ­¤å¥åº·</li>
              <li><strong>å­å¥³ç¼˜ï¼š</strong>ä»Šå¹´æœ‰è¾ƒå¥½çš„å­å¥³ç¼˜åˆ†</li>
            </ul>
          </div>
        </div>
      `;
      break;
      
    default:
      detailsHTML += `
        <div class="analysis-point">
          <h6>åˆç›˜æ¦‚å†µ</h6>
          <div class="analysis-detail">
            <p>åŒæ–¹å‘½ç†åˆç›˜æ˜¾ç¤ºï¼š</p>
            <ul>
              <li><strong>æ•´ä½“è¯„åˆ†ï¼š</strong>${score.total}åˆ†</li>
              <li><strong>ä¼˜åŠ¿äº’è¡¥ï¼š</strong>æ€§æ ¼å’Œèƒ½åŠ›ä¸Šæœ‰è¾ƒå¥½çš„äº’è¡¥æ€§</li>
              <li><strong>éœ€è¦æ³¨æ„ï¼š</strong>åœ¨æŸäº›ä»·å€¼è§‚ä¸Šå¯èƒ½å­˜åœ¨å·®å¼‚</li>
              <li><strong>å‘å±•å»ºè®®ï¼š</strong>åŠ å¼ºæ²Ÿé€šï¼Œäº’ç›¸ç†è§£åŒ…å®¹</li>
            </ul>
          </div>
        </div>
      `;
  }
  
  detailsHTML += `
    </div>
  `;
  
  return detailsHTML;
}

async function generateDeepAnalysisContent(focus, type, culture, currentYear, data) {
  let contentHTML = '';
  
  // æ ¹æ®ç„¦ç‚¹ç”Ÿæˆä¸åŒçš„åˆ†æå†…å®¹
  switch(focus) {
    case 'æ‹çˆ±ç¼˜åˆ†':
      contentHTML = `
        <div class="deep-analysis">
          <div class="deep-analysis-title">
            <span class="deep-analysis-icon">ğŸ’–</span>
            <h5>æ·±åº¦æƒ…æ„Ÿåˆ†æ</h5>
          </div>
          
          <div class="analysis-point">
            <h6>å‘½ç†ç‰¹ç‚¹</h6>
            <div class="analysis-detail">
              <p>æ‚¨çš„å‘½ç†æ˜¾ç¤ºåœ¨æ„Ÿæƒ…æ–¹é¢å…·æœ‰ä»¥ä¸‹ç‰¹è´¨ï¼š</p>
              <ul>
                <li><strong>æƒ…æ„Ÿæ¨¡å¼ï¼š</strong>å€¾å‘äºç¨³å®šé•¿æœŸçš„å…³ç³»ï¼Œä¸å–œé¢‘ç¹å˜åŠ¨</li>
                <li><strong>æœ€ä½³ç›¸é‡æ—¶æ®µï¼š</strong>${currentYear}å¹´ç§‹å­£è‡³${currentYear+1}å¹´æ˜¥å­£</li>
                <li><strong>è´µäººæ–¹ä½ï¼š</strong>ä¸œæ–¹å’Œä¸œå—æ–¹å‘çš„äººå£«å¯èƒ½æˆä¸ºè‰¯ç¼˜</li>
                <li><strong>æ€§æ ¼é€‚é…ï¼š</strong>ä¸æ€§æ ¼æ¸©å’Œã€æœ‰è´£ä»»å¿ƒçš„äººå£«ç¼˜åˆ†è¾ƒæ·±</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      break;
      
    case 'èŒåœºå‘å±•':
      contentHTML = `
        <div class="deep-analysis">
          <div class="deep-analysis-title">
            <span class="deep-analysis-icon">ğŸ’¼</span>
            <h5>èŒä¸šå‘å±•æ·±åº¦åˆ†æ</h5>
          </div>
          
          <div class="analysis-point">
            <h6>èŒä¸šä¼˜åŠ¿åˆ†æ</h6>
            <div class="analysis-detail">
              <p>åŸºäºæ‚¨çš„å‘½ç†ç‰¹ç‚¹ï¼Œæ‚¨åœ¨èŒåœºä¸­å…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
              <ul>
                <li><strong>æ ¸å¿ƒèƒ½åŠ›ï¼š</strong>é€»è¾‘æ€ç»´èƒ½åŠ›å¼ºï¼Œæ“…é•¿åˆ†æå’Œè§„åˆ’</li>
                <li><strong>é€‚åˆé¢†åŸŸï¼š</strong>ç®¡ç†ã€ç­–åˆ’ã€æ•™è‚²ã€å’¨è¯¢è¡Œä¸š</li>
                <li><strong>æ™‹å‡æ½œåŠ›ï¼š</strong>${currentYear}å¹´åº•æœ‰é‡è¦æ™‹å‡æœºä¼š</li>
                <li><strong>è´µäººåŠ©åŠ›ï¼š</strong>ä¸Šçº§æˆ–èµ„æ·±åŒäº‹çš„æ”¯æŒæ˜¯å…³é”®</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      break;
      
    default:
      contentHTML = `
        <div class="ai-section">
          <h5>ğŸ¯ æ ¸å¿ƒåˆ†æ</h5>
          <p>åŸºäºæ‚¨çš„å‘½ç†ç‰¹ç‚¹ï¼Œå…³äº"${focus}"çš„åˆ†æå¦‚ä¸‹ï¼š</p>
          <ul>
            <li><strong>å½“å‰è¿åŠ¿ï¼š</strong>å¤„äºå¹³ç¨³ä¸Šå‡æœŸï¼Œæœºé‡é€æ¸å¢å¤š</li>
            <li><strong>å…³é”®æ—¶æœºï¼š</strong>${currentYear}å¹´ç¬¬å››å­£åº¦æ˜¯é‡è¦èŠ‚ç‚¹</li>
            <li><strong>å‘å±•æ–¹å‘ï¼š</strong>å‘æŒ¥è‡ªèº«ä¼˜åŠ¿ï¼Œç¨³æ­¥æ¨è¿›è®¡åˆ’</li>
            <li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong>é¿å…å†²åŠ¨å†³ç­–ï¼Œåšå¥½å……åˆ†å‡†å¤‡</li>
          </ul>
        </div>
      `;
  }
  
  return contentHTML;
}

function generateNamingSection(focus, namingSuggestions, culture) {
  let sectionHTML = '';
  
  // ç¡®å®šæ€§åˆ«æ ‡ç­¾
  const genderLabels = {
    'å®å®å': ['ç”·å­©å', 'å¥³å­©å', 'ä¸­æ€§å'],
    'ä¸ªäººæ”¹å': ['ç”·æ€§æ”¹å', 'å¥³æ€§æ”¹å', 'ä¸­æ€§æ”¹å'],
    'æƒ…ä¾£åˆå': ['æƒ…ä¾£ç»„åˆå']
  };
  
  const labels = genderLabels[focus] || ['æ¨èå'];
  
  sectionHTML += `
    <div class="ai-section">
      <h5>${t('naming_recommendations')}</h5>
      <p>åŸºäºæ‚¨çš„å‘½ç†äº”è¡Œåˆ†æï¼Œæˆ‘ä»¬ä¸ºæ‚¨æ¨èä»¥ä¸‹${labels.join('/')}ï¼š</p>
      
      <div class="naming-grid">
  `;
  
  namingSuggestions.forEach((name, index) => {
    let genderTag = labels[0];
    if (labels.length > 1) {
      genderTag = index % 3 === 0 ? labels[0] : 
                  index % 3 === 1 ? labels[1] : labels[2];
    }
    
    sectionHTML += `
      <div class="name-card">
        <div class="name-header">
          <div class="name-badge">${index + 1}</div>
          <div>
            <div class="name-text">${name.name}</div>
            <div class="name-pinyin">${name.pinyin}</div>
          </div>
        </div>
        
        <div class="name-explanation">${name.explanation}</div>
        
        <div class="name-rating">
          <div class="rating-stars">${'â˜…'.repeat(Math.floor(name.rating / 20))}${'â˜†'.repeat(5 - Math.floor(name.rating / 20))}</div>
          <div class="rating-score">è¯„åˆ†ï¼š${name.rating}/100</div>
        </div>
        
        <div class="name-meta">
          <span class="gender-tag">${genderTag}</span>
          <div class="five-elements">
            ${name.elements.map(el => `
              <div class="element-badge ${`element-${el}`}" title="${el}è¡Œ">${el}</div>
            `).join('')}
          </div>
          <span style="color: #98a7b7;">${name.strokes}ç”»</span>
        </div>
      </div>
    `;
  });
  
  sectionHTML += `
      </div>
    </div>
  `;
  
  return sectionHTML;
}

function generateActionPlan(focus, type, culture) {
  let planHTML = `
    <div class="ai-section">
      <h5>ğŸ“… è¡ŒåŠ¨è®¡åˆ’</h5>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 12px;">
  `;
  
  const plans = {
    'æ‹çˆ±ç¼˜åˆ†': [
      { time: 'ç«‹å³è¡ŒåŠ¨', action: 'æ¸…ç†æ¡ƒèŠ±ä½ï¼ˆä¸œå—æ–¹ï¼‰ï¼Œæ”¾ç½®ç²‰æ°´æ™¶æˆ–é²œèŠ±' },
      { time: 'æœ¬å‘¨å†…', action: 'å‚åŠ è‡³å°‘ä¸€æ¬¡ç¤¾äº¤æ´»åŠ¨ï¼Œæ‰©å±•äº¤å‹åœˆ' },
      { time: 'æœ¬æœˆå†…', action: 'æ”¹å–„è‡ªèº«å½¢è±¡ï¼Œæå‡ä¸ªäººé­…åŠ›' }
    ],
    'èŒåœºå‘å±•': [
      { time: 'ç«‹å³è¡ŒåŠ¨', action: 'æ›´æ–°ç®€å†ï¼Œæ˜ç¡®èŒä¸šç›®æ ‡' },
      { time: 'æœ¬å‘¨å†…', action: 'ä¸ä¸Šçº§æ²Ÿé€šèŒä¸šå‘å±•è®¡åˆ’' },
      { time: 'æœ¬æœˆå†…', action: 'å®Œæˆä¸€é¡¹èƒ½å±•ç°èƒ½åŠ›çš„é¡¹ç›®' }
    ]
  };
  
  const defaultPlan = [
    { time: 'ç«‹å³è¡ŒåŠ¨', action: 'åˆ¶å®šå…·ä½“å®æ–½è®¡åˆ’' },
    { time: 'æœ¬å‘¨å†…', action: 'å¼€å§‹æ‰§è¡Œç¬¬ä¸€æ­¥è®¡åˆ’' },
    { time: 'æœ¬æœˆå†…', action: 'å®Œæˆé˜¶æ®µæ€§ç›®æ ‡' }
  ];
  
  const selectedPlan = plans[focus] || defaultPlan;
  
  selectedPlan.forEach((item, index) => {
    planHTML += `
      <div style="background: rgba(14, 21, 32, 0.6); padding: 12px; border-radius: 8px; border-left: 4px solid #58b9ff;">
        <div style="color: #58b9ff; font-weight: 600; margin-bottom: 4px;">${item.time}</div>
        <div style="color: #e8edf3; font-size: 0.9rem;">${item.action}</div>
      </div>
    `;
  });
  
  planHTML += `
      </div>
    </div>
  `;
  
  return planHTML;
}

function generateCulturalNotes(culture) {
  const notes = {
    'ä¸œæ–¹': `
      <div class="ai-note">
        <strong>ğŸ’¡ å…«å­—å‘½ç†æ¸©é¦¨æç¤ºï¼š</strong><br>
        1. å…«å­—åˆ†æåŸºäºä¼ ç»Ÿå‘½ç†å­¦åŸç†ï¼Œéœ€ç»“åˆå®é™…æƒ…å†µè§£è¯»<br>
        2. äº”è¡Œå¹³è¡¡å¯é€‚å½“é€šè¿‡é¢œè‰²ã€æ–¹ä½ã€èŒä¸šç­‰è¿›è¡Œè°ƒæ•´<br>
        3. å‘½ç†åˆ†ææ—¨åœ¨æä¾›å‚è€ƒï¼ŒçœŸæ­£çš„æ”¹å˜åœ¨äºè‡ªèº«åŠªåŠ›<br>
        4. å»ºè®®ä¿æŒè‰¯å¥½å¿ƒæ€ï¼Œç§¯æé¢å¯¹ç”Ÿæ´»æŒ‘æˆ˜
      </div>
    `,
    'è¥¿æ–¹': `
      <div class="ai-note">
        <strong>ğŸ’¡ å æ˜Ÿå¡”ç½—æ¸©é¦¨æç¤ºï¼š</strong><br>
        1. å æ˜Ÿå­¦æ˜¯æ¢ç´¢è‡ªæˆ‘å’Œæ½œèƒ½çš„å·¥å…·ï¼Œéç»å¯¹é¢„è¨€<br>
        2. æ˜Ÿåº§ç‰¹è´¨æä¾›å‚è€ƒï¼Œæ¯ä¸ªäººéƒ½æ˜¯ç‹¬ç‰¹çš„ä¸ªä½“<br>
        3. å¡”ç½—ç‰Œåæ˜ å½“ä¸‹èƒ½é‡ï¼Œæœªæ¥ç”±é€‰æ‹©åˆ›é€ <br>
        4. ä¿æŒå¼€æ”¾å¿ƒæ€ï¼Œç»“åˆç†æ€§æ€è€ƒåšå‡ºå†³ç­–
      </div>
    `
  };
  
  return notes[culture] || notes['ä¸œæ–¹'];
}

/* ==============================
   Chat åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰
============================== */
function setupChatUI() {
  const fab = $('ssChatFab');
  const close = $('chatClose');
  const send = $('chatSend');
  const input = $('chatInput');

  if (fab) fab.addEventListener('click', () => {
    const panel = $('chatPanel');
    panel.setAttribute('aria-hidden', 'false');
  });
  
  if (close) close.addEventListener('click', () => {
    const panel = $('chatPanel');
    panel.setAttribute('aria-hidden', 'true');
  });
  
  if (send) send.addEventListener('click', () => {
    const input = $('chatInput');
    if (input.value.trim()) {
      appendChat('user', input.value);
      input.value = '';
      setTimeout(() => {
        appendChat('assistant', 'æ„Ÿè°¢æ‚¨çš„æé—®ï¼å¦‚éœ€è¯¦ç»†çš„å‘½ç†åˆ†æï¼Œè¯·ä½¿ç”¨ä¸Šæ–¹çš„æŠ¥å‘Šç”ŸæˆåŠŸèƒ½ã€‚');
      }, 500);
    }
  });
  
  if (input) input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send.click();
    }
  });
}

function appendChat(role, text) {
  const body = $('chatBody');
  if (!body) return;
  const msg = document.createElement('div');
  msg.className = 'ss-msg' + (role === 'user' ? ' me' : '');
  msg.textContent = text;
  body.appendChild(msg);
  body.scrollTop = body.scrollHeight;
}

/* ==============================
   åˆå§‹åŒ–
============================== */
function init(){
  // åº”ç”¨ç¿»è¯‘
  applyI18n();
  
  // è®¾ç½®é»˜è®¤æ—¶é—´
  setDefaultBirthDateTimeNow();
  
  // è®¾ç½®ç±»å‹é€‰æ‹©å™¨
  setupTypeSelector();
  
  // åˆå§‹çŠ¶æ€
  const initialCulture = getCultureResolved();
  togglePartner('personal');
  updateUIForCulture(initialCulture);
  
  // äº‹ä»¶ç›‘å¬
  $('btnNext')?.addEventListener('click', onGenerate);
  
  // æ–‡åŒ–é€‰æ‹©å˜åŒ–
  $('culture')?.addEventListener('change', () => {
    const newCulture = getCultureResolved();
    updateUIForCulture(newCulture);
  });
  
  // å½“å›½å®¶/åœ°åŒºè¾“å…¥å˜åŒ–æ—¶ï¼Œå¦‚æœæ–‡åŒ–é€‰æ‹©æ˜¯autoï¼Œæ›´æ–°æ–‡åŒ–
  $('country1')?.addEventListener('change', () => {
    if ($('culture')?.value === 'auto') {
      const newCulture = getCultureResolved();
      updateUIForCulture(newCulture);
    }
  });
  
  // è¯­è¨€é€‰æ‹©
  const langSelect = $('langSelect');
  if (langSelect) {
    langSelect.value = getLang();
    langSelect.addEventListener('change', (e) => {
      setLang(e.target.value);
      applyI18n();
      const currentCulture = getCultureResolved();
      updateUIForCulture(currentCulture);
    });
  }
  
  // Chat
  setupChatUI();
}

// DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// ä¿®å¤ï¼šç¡®ä¿ç«‹å³æ‰§è¡Œå‡½æ•°æ­£ç¡®é—­åˆ
})(); // è¿™è¡Œå¿…é¡»åœ¨æœ€åï¼Œç¡®ä¿æ‰€æœ‰æ‹¬å·éƒ½é—­åˆ
</script>
</body>  
</html>
