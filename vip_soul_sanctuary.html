<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">命理心怜空间 · VIP Soul Sanctuary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f14;--card:#11161dCC;--line:#1f2a36;--text:#e8edf3;--muted:#98a7b7;--brand:#d4af37;--accent:#58b9ff;--radius:14px;--shadow:0 8px 30px rgba(0,0,0,.35);--blur:10px}
    html,body{height:100%} html{font-size:16px}
    @media(min-width:768px){html{font-size:17px}} @media(min-width:1200px){html{font-size:18px}}
    body{margin:0;color:var(--text);background:radial-gradient(1200px 600px at 70% -10%,#16202b 10%,transparent 60%) no-repeat linear-gradient(180deg,#0b0f14,#0b0f14);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC",Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body::before{content:"";position:fixed;inset:0;z-index:-2;background:url('assets/images/gate.jpg') center/cover no-repeat;filter:brightness(.45) saturate(.9) blur(2px)}
    .glow{position:fixed;inset:auto auto 10% -10%;width:45vw;height:45vw;max-width:700px;max-height:700px;background:radial-gradient(closest-side,#2a98ff33,transparent 70%);filter:blur(30px);z-index:-1;pointer-events:none}
    .container{width:100%;max-width:1100px;padding:24px 16px 80px;margin:0 auto}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(12px);background:#0b0f14cc;border-bottom:1px solid #0f1622}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,#273243,#0e141c);display:grid;place-items:center;color:var(--brand);font-weight:700;box-shadow:var(--shadow)}
    .title{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;letter-spacing:.02em;font-size:1.1rem}
    .subtitle{color:var(--muted);font-size:.9rem}
    /* 语言选择器 */
    .lang{display:flex;align-items:center;gap:8px}
    .lang label{color:var(--muted);font-size:.9rem}
    .lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px;font-size:.95rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));padding:18px}
    .section{margin-top:18px}
    .section h2{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;font-size:1.2rem;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    .section h2::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px #58b9ff22}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .muted{color:var(--muted)} .error{color:#ff8f8f;margin-top:8px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
    input,select,button{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:14px 13px;font-size:1rem;outline:none}
    input::placeholder{color:#6f8092}
    select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .btn{background:linear-gradient(180deg,#1d2a3a,#101723);border:1px solid #28364a;font-weight:600;letter-spacing:.02em;cursor:pointer;transition:transform .05s ease,box-shadow .2s ease,border .2s ease}
    .btn:hover{box-shadow:0 6px 18px rgba(88,185,255,.15),inset 0 1px 0 #2e3c50}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-gold{background:linear-gradient(180deg,#f7e7a8,#d4af37);color:#191919;border:1px solid #d4af37}
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.columns{grid-template-columns:1fr 1fr}}
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .list-block li{line-height:1.9}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .link-btn{display:grid;place-items:center;text-decoration:none}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}
        /* Chat 浮窗 */
    .ss-chat-fab{
      position: fixed; right: 18px; bottom: 18px; z-index: 50;
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(180deg,#f7e7a8,#d4af37); color:#191919;
      display:grid; place-items:center; font-weight:800; box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
      border:1px solid #d4af37;
    }
    .ss-chat-panel{
      position: fixed; right: 18px; bottom: 90px; z-index: 50;
      width: min(380px, 92vw); max-height: 70vh; display:none; flex-direction: column;
      background: #0e1520f2; backdrop-filter: blur(12px);
      border:1px solid #263448; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .ss-chat-head{
      padding: 12px 14px; border-bottom:1px solid #1f2a36; display:flex; align-items:center; justify-content:space-between;
    }
    .ss-chat-title{ color:#ffe084; font-weight:700 }
    .ss-chat-body{ padding: 12px; overflow:auto; display:flex; flex-direction:column; gap:10px }
    .ss-msg{ padding:10px 12px; border:1px solid #243244; border-radius: 12px; background:#0b1018; color:#e8edf3; max-width: 85% }
    .ss-msg.me{ margin-left:auto; background:#111a2a; border-color:#2f3e53 }
    .ss-chat-input{ display:flex; gap:8px; padding:12px; border-top:1px solid #1f2a36 }
    /* Fix: override global widths for chat controls */
    .ss-chat-input input, .ss-chat-input button { width:auto; }
    .ss-chat-input input{
      flex:1; min-height:48px; font-size:1rem; color:#e8edf3; caret-color:#e8edf3;
      border-radius:12px; border:1px solid #243244; background:#0e1520; padding:12px;
    }
    .ss-chat-input input::placeholder{ color:#8ea0b5 }
    .ss-chat-input button{
      min-height:48px; border-radius:12px; padding:0 16px;
      background:linear-gradient(180deg,#1d2a3a,#101723); color:#e8edf3; border:1px solid #28364a; cursor:pointer;
      white-space:nowrap;
    }
    .ss-close{ color:#98a7b7; cursor:pointer }
    /* ===== 基础色系 ===== */
  :root{
    --gold:#d4af37; --gold2:#f2d27a; --txt:#e8ecf4; --muted:#9aa3b2;
    --panel:rgba(255,255,255,.02); --border:rgba(212,175,55,.22); --radius:14px;
  }
  body{
    background: radial-gradient(1200px 800px at 50% 0%, #111a2b 0%, #0b0f17 38%, #070a11 100%) fixed;
    color:#e6e9ef;
  }
  /* ===== 无障碍隐藏文字 ===== */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}

  /* ===== 外层卡片 ===== */
  .astro-auth{
    max-width: 980px; margin: 28px auto; padding: 20px 18px;
    background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.01));
    border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }

  /* ===== 栅格：桌面双栏 / 手机单栏 ===== */
  .auth-grid{
    display:grid; gap:18px;
    grid-template-columns: 1.2fr .8fr; /* 左宽右窄 */
  }
  @media (max-width: 860px){
    .auth-grid{ grid-template-columns: 1fr; }
  }

  /* ===== 面板 ===== */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .panel .head{
    padding:16px 18px; border-bottom:1px solid var(--border);
    color:var(--gold); font-weight:700; letter-spacing:.3px;
  }
  .panel .body{ padding:18px; }

  /* ===== 行布局 ===== */
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row.one{ grid-template-columns: 1fr; }
  .row.center{ align-items:center; }
  @media (max-width:640px){ .row{ grid-template-columns: 1fr; } }

  /* ===== 输入框 ===== */
  .astro-auth input[type="email"],
  .astro-auth input[type="password"]{
    width:100%; background:#0f1522; color:#eaf0ff;
    border:1px solid rgba(212,175,55,.28); border-radius:10px;
    padding:13px 12px; outline:none; transition:.18s;
  }
  .astro-auth input:focus{
    border-color:var(--gold2); box-shadow:0 0 0 3px rgba(212,175,55,.2);
  }

  /* ===== 按钮 ===== */
  .btn{
    display:inline-grid; place-items:center; text-decoration:none;
    padding:13px 16px; border-radius:12px; border:0; cursor:pointer;
    font-weight:600; letter-spacing:.3px;
    background:linear-gradient(180deg, var(--gold2), var(--gold)); color:#231a04;
    box-shadow:0 6px 18px rgba(212,175,55,.3); transition:.15s;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(212,175,55,.35); }
  .btn.btn-gold{ background:linear-gradient(180deg, var(--gold2), var(--gold)); color:#231a04; }
  .btn.ghost{
    background:transparent; color:var(--gold2);
    border:1px solid rgba(212,175,55,.45); box-shadow:none;
  }
/* block 按钮基准 */
.btn.block {
  display: block;        /* 普通块级即可 */
  width: 100%;           /* 占满父容器 */
  max-width: 100%;       /* 不允许超出 */
  box-sizing: border-box;/* 计算边框内收 */
}

/* 如果要在 .row.one 里强制覆盖 inline-grid */
.row.one .btn.block {
  display: block !important; /* 强制覆盖，避免 inline-grid 样式残留 */
}

/* 保证按钮在 panel 内居中 */
.panel .body .btn.block {
  margin-left: auto;
  margin-right: auto;
}

  /* ===== 说明与错误 ===== */
  .muted{ color:var(--muted); font-size:13px; line-height:1.6; }
  .error{ color:#ffb4b4; background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25);
          padding:10px 12px; border-radius:10px; }
  .spacer{ height:12px; }
</style>
</head>
  <body>
  <div class="glow"></div>
  <header>
    <div class="head-inner container">
      <div class="brand">
        <div class="brand-badge">5X</div>
        <div>
          <div class="title" data-i18n="site_title">命理心怜空间 · VIP Soul Sanctuary</div>
        </div>
      </div>
      <div class="lang">
        <label for="langSelect" data-i18n="lang_label">语言</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">简体中文</option>
          <option value="zh-TW">繁體中文</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
          <option value="th">ไทย</option>
          <option value="ms">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 顶部：命理分析表单 -->
    <section class="card section">
      <h2 data-i18n="form_title">命理分析 · 生成报告</h2>

      <div class="group-title" data-i18n="choose_type">选择命盘类型</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">个人命盘</option>
          <option value="compatibility" data-i18n="type_compat">合盘（两人资料）</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">自动识别 Auto Detect</option>
          <option value="东方" data-i18n="culture_cn">东方 Chinese / Bazi</option>
          <option value="西方" data-i18n="culture_west">西方 Astrology / Tarot</option>
          <option value="日式" data-i18n="culture_jp">日式九星 Japanese</option>
          <option value="吠陀" data-i18n="culture_vedic">印度吠陀 Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">本人资料</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="姓名（本人）" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="出生时间" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
          <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="出生国家 / 地区" required data-i18n-ph="ph_country1">
        <button class="btn" onclick="document.getElementById('reportForm').requestSubmit()" data-i18n="btn_next">下一步</button>
      </div>

      <!-- 隐形表单用于提交 -->
      <form id="reportForm" action="/secure/report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">第二人资料（合盘）</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="姓名（第二人）" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="出生时间" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="阳历" data-i18n="cal_g">阳历 (Gregorian)</option>
            <option value="农历" data-i18n="cal_l">农历 (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="出生国家 / 地区" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">命理选题（报告聚焦）</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="姻缘 Love" data-i18n="opt_love"></optgroup>
          <option value="恋爱缘分" data-i18n="opt_dating">恋爱缘分</option>
          <option value="婚姻走势" data-i18n="opt_marriage">婚姻走势</option>

          <optgroup label="事业 Career" data-i18n="opt_career"></optgroup>
          <option value="职场发展" data-i18n="opt_work">职场发展</option>
          <option value="创业潜力" data-i18n="opt_startup">创业潜力</option>

          <optgroup label="财运 Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="财位分析" data-i18n="opt_wealthpos">财位分析</option>
          <option value="理财时机" data-i18n="opt_timing">理财时机</option>

          <optgroup label="择日 Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="婚期择日" data-i18n="opt_wedding">婚期择日</option>
          <option value="新生宝宝择日" data-i18n="opt_babydate">新生宝宝择日</option>
          <option value="新家入住择日" data-i18n="opt_house">新家入住择日</option>
          <option value="新公司入住择日" data-i18n="opt_office">新公司入住择日</option>

          <optgroup label="测名 Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="宝宝名" data-i18n="opt_babyname">宝宝名</option>
          <option value="宠物名" data-i18n="opt_petname">宠物名</option>
          <option value="公司名" data-i18n="opt_companyname">公司名</option>
          <option value="命名改运" data-i18n="opt_rename">命名改运</option>

          <optgroup label="风水 Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="住家" data-i18n="opt_home">住家</option>
          <option value="办公室" data-i18n="opt_officefs">办公室</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="合盘分析 Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="缘分起落" data-i18n="opt_couple">情侣合盘（缘分起落 / 暧昧进展）</option>
          <option value="夫妻流年" data-i18n="opt_spouse">夫妻流年（婚姻发展）</option>
          <option value="合盘分析" data-i18n="opt_personality">个性合盘（冲突 / 互补）</option>
          <option value="事业共事" data-i18n="opt_partner">事业合盘（合伙人 / 员工）</option>
          <option value="断联修复" data-i18n="opt_reconnect">断联修复（朋友 / 情人 / 家人）</option>
          <option value="宠物缘分" data-i18n="opt_petbond">宠物合盘（主人与宠物）</option>
        </select>
      </div>
    </section>

    <!-- 下段：各功能入口 -->
    <section class="card section">
      <h2 data-i18n="portal_title">心怜空间 · 功能入口</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">🧘‍♀️ 灵性日记</div>
        <ul><li data-i18n="diary_desc">照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">个人隐藏记录</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">家庭共享记录</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">上传记录</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">📘 命理课程专区</div>
        <ul>
          <li data-i18n="course_bazi">八字命理：十神 / 流年 / 用神分析</li>
          <li data-i18n="course_tarot">塔罗牌：牌阵解读 / 情境实战</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">进入课程</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">🛍️ 能量商城 · VIP折扣 & 御守订制</div>
        <ul><li data-i18n="shop_desc">专属祈愿包分类：</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="阴债和解包.html">阴债和解包</a>
          <a class="btn link-btn" href="财库包.html">财库包</a>
          <a class="btn link-btn" href="灵魂开悟的指引包.html">心灵包</a>
          <a class="btn link-btn" href="财运包.html">财运包</a>
          <a class="btn link-btn" href="姻缘包.html">姻缘包</a>
          <a class="btn link-btn" href="学业包.html">学业包</a>
          <a class="btn link-btn" href="事业包.html">事业包</a>
          <a class="btn link-btn" href="御守包.html">御守包</a>
          <a class="btn link-btn" href="太岁包.html">太岁包</a>
          <a class="btn link-btn" href="七月包.html">七月包</a>
          <a class="btn link-btn" href="家族福报包.html">家族福报包</a>
          <a class="btn link-btn" href="情伤疗愈包.html">情伤疗愈包</a>
          <a class="btn link-btn" href="劫难包.html">劫难包</a>
          <a class="btn link-btn" href="新宅办公室包.html">新宅 / 办公室包</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">🔮 梦想提交 Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">梦想规划 / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">📖 灵性空间 ~ 往生记怜录</div>
        <ul><li data-i18n="memorial_desc">灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">登入灵性空间</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">上传往生录</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">注册灵性空间</a>
        </div>
      </div>
    </section>
  </main>

  <footer>© 5XLiving • Astro Sanctuary</footer>
  </main>

  <script>
    // 切换个人/合盘显示
    function togglePartner(value){
      const section = document.getElementById("partner-section");
      const personal = document.getElementById('purpose_personal');
      const compat = document.getElementById('purpose_compatibility');
      const show = (value === "compatibility");
      section.style.display = show ? "block" : "none";
      personal.style.display = show ? "none" : "block";
      compat.style.display = show ? "block" : "none";
    }

    // 隐形表单同步并提交
    const reportForm = document.getElementById('reportForm');
    function syncToHiddenForm(){
      const ids = ["type","culture","name1","birthdate1","birthtime1","calendar1","country1","name2","birthdate2","birthtime2","calendar2","country2"];
      ids.forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        let h = reportForm.querySelector(`[name="${id}"]`);
        if(!h){ h = document.createElement('input'); h.type='hidden'; h.name=id; reportForm.appendChild(h); }
        h.value = el.value || '';
      });
      const purpose = (document.getElementById('type').value === 'compatibility')
        ? document.getElementById('purpose_compatibility').value
        : document.getElementById('purpose_personal').value;
      let p = reportForm.querySelector('[name="purpose"]');
      if(!p){ p = document.createElement('input'); p.type='hidden'; p.name='purpose'; reportForm.appendChild(p); }
      p.value = purpose;
    }
    // 拦截“下一步”按钮
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button');
      if (b && b.textContent.trim() === document.querySelector('[data-i18n="btn_next"]').textContent.trim()){
        e.preventDefault(); syncToHiddenForm(); reportForm.submit();
      }
    });

  // ============== 统一配置（你的 Worker 域名） ==============
  const API_BASE = 'https://throbbing-lab-1440.hello5xliving.workers.dev'; // ← 改成你的 Workers.dev

  // 工具函数
  const $ = id => document.getElementById(id);
  function showErr(msg){ const e=$("error"); e.textContent=msg; e.style.display="block"; setTimeout(()=>{e.style.display='none'},5000); }
  function hideErr(){ const e=$("error"); e.style.display="none"; e.textContent=""; }
  function lock(el, v){ if(el) el.disabled = v; }
  function strongPwd(pw){
    return pw.length>=8 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  }

  // ============== 多语言 ==============
  const LANG_KEY = "site_lang";
  function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }

  // （保留你原来的翻译表，我这里是完整一份，包含 chat_fab/chat_placeholder/chat_send）
const translations = {
  "zh-CN": {
    // —— 站点 & 表单（上半部分） ——
    page_title:"命理心怜空间 · VIP Trial",
    site_title:"命理心怜空间 · VIP Trial",
    site_subtitle:"与「八字简评」同款风格 · 手机&电脑一致体验",
    lang_label:"语言",
    form_title:"命理分析 · 生成报告",
    choose_type:"选择命盘类型",
    type_personal:"个人命盘", type_compat:"合盘（两人资料）",
    culture_auto:"自动识别 Auto Detect", culture_cn:"东方 Chinese / Bazi",
    culture_west:"西方 Astrology / Tarot", culture_jp:"日式九星 Japanese", culture_vedic:"印度吠陀 Vedic",
    self_info:"本人资料", ph_name1:"姓名（本人）", ph_time1:"出生时间", ph_country1:"出生国家 / 地区",
    cal_g:"阳历 (Gregorian)", cal_l:"农历 (Lunar)",
    btn_next:"下一步",
    partner_info:"第二人资料（合盘）", ph_name2:"姓名（第二人）", ph_time2:"出生时间", ph_country2:"出生国家 / 地区",
    focus_title:"命理选题（报告聚焦）",
    opt_love:"姻缘 Love", opt_dating:"恋爱缘分", opt_marriage:"婚姻走势",
    opt_career:"事业 Career", opt_work:"职场发展", opt_startup:"创业潜力",
    opt_wealth:"财运 Wealth", opt_wealthpos:"财位分析", opt_timing:"理财时机",
    opt_dates:"择日 Auspicious Date", opt_wedding:"婚期择日", opt_babydate:"新生宝宝择日", opt_house:"新家入住择日", opt_office:"新公司入住择日",
    opt_name:"测名 Name Analysis", opt_babyname:"宝宝名", opt_petname:"宠物名", opt_companyname:"公司名", opt_rename:"命名改运",
    opt_fs:"风水 Feng Shui", opt_home:"住家", opt_officefs:"办公室",
    opt_comp:"合盘分析 Compatibility", opt_couple:"情侣合盘（缘分起落 / 暧昧进展）",
    opt_spouse:"夫妻流年（婚姻发展）", opt_personality:"个性合盘（冲突 / 互补）",
    opt_partner:"事业合盘（合伙人 / 员工）", opt_reconnect:"断联修复（朋友 / 情人 / 家人）", opt_petbond:"宠物合盘（主人与宠物）",

    // —— VIP 列表（中段） ——
    vip_overview:"VIP 内容总览",
    vip_mingli:"🗝 命理空间专属内容",
    list_love:"姻缘方向：恋爱缘分、婚姻走势",
    list_career:"事业方向：职场发展、创业潜力",
    list_wealth:"财运方向：财位分析、理财时机",
    list_pet:"宠物命理：伴侣动物的性格与缘分",
    list_hepan:"合盘分析：婚期择日、新生择时",
    list_name:"测名分析：公司名、宝宝名、命名改运",
    list_fs:"财位合盘：住家 / 办公室动线配合",
    vip_xinlian:"🌙 心怜空间专属内容",
    list_record:"灵性记录：照片、梦境、声音、愿望祈祷",
    list_course:"命理课程：八字 / 塔罗 / 占星 / 灵数 / 人类图",
    list_memorial:"家族纪念系统：亲人灵性纪念 & 延续",
    list_tasks:"每周能量练习 / 神明仪式任务",
    list_shop:"能量商城专属折扣 & 御守订制",
    btn_upgrade:"💎 升级为 VIP（月费）",
    btn_back:"← 返回命理商城",
    vip_note:"$9.9 / 月费（命理空间 + 心怜空间 + 灵性课程）· 注册账号赠送一次免费体验",

    // —— 入口（下段） ——
    portal_title:"心怜空间 · 功能入口",
    diary_title:"🧘‍♀️ 灵性日记", diary_desc:"照片上传 / 语音记录 / 灵性笔记 / 家庭日志 / 愿望祈祷（每日加持）",
    btn_personal:"个人隐藏记录", btn_family:"家庭共享记录", btn_upload:"上传记录",
    course_title:"📘 命理课程专区", course_bazi:"八字命理：十神 / 流年 / 用神分析", course_tarot:"塔罗牌：牌阵解读 / 情境实战",
    course_coming:"🌙 以下课程酝酿中：占星 / 灵数 / 人类图 / 六爻 / 冥想引导 / 奇门 / 日式神明 / 紫微 / 能量学 / 西洋占星 / 心灵课程……",
    btn_enter_course:"进入课程",
    shop_title:"🛍️ 能量商城 · VIP折扣 & 御守订制", shop_desc:"专属祈愿包分类：",
    wish_title:"🔮 梦想提交 Dream Submission", btn_manifest:"梦想规划 / Manifestation",
    memorial_title:"📖 灵性空间 ~ 往生记怜录", memorial_desc:"灵魂档案 / 纪念回忆（图文音） / 灵性延续（功德传承）",
    btn_login_memorial:"登入灵性空间", btn_upload_memorial:"上传往生录", btn_register_memorial:"注册灵性空间",

    // —— 登录区（你缺的键都在这里） ——
    login_title:"💎 登入 VIP 功能",
    ph_email:"邮箱 Email",
    ph_password:"密码 Password（至少8位，含大小写数字符号）",
    btn_login:"登入账户",
    btn_register:"注册账户",
    btn_reset:"🔑 重设密码",
    btn_backshop:"← 返回命理商城",
    note_price:"注册账号赠送一次免费体验",
    note_price1:"$9.9 / 月费 VIP（命理空间 + 心怜空间 + 灵性课程）",

    // —— 错误/提示消息（JS 会用到） ——
    err_expired:"会员已过期",
    err_no_account:"没有这个账号，请先注册",
    err_wrong_pwd:"密码不正确",
    err_login_fail:"登录失败，请稍后再试。",
    err_register_fail:"注册失败，请稍后再试。",
    err_need_ep:"请填写邮箱和密码",
    err_pwd_rule:"密码至少 8 位，需包含大小写字母、数字和符号",
    prompt_email:"请输入注册邮箱",
    prompt_newpwd:"请输入新密码（至少8位，含大小写数字符号）",
    err_email_empty:"邮箱不能为空",
    err_pwd_empty:"密码不能为空",
    err_reset_fail:"重设失败，请稍后再试。",
    msg_reset_ok:"已重设成功，请用新密码登录",

    // —— Chat 浮窗文案 ——
    chat_fab:"Chat",
    chat_placeholder:"有什么想咨询的？",
    chat_send:"发送"
  },

  "zh-TW": {
    page_title:"命理心憐空間 · VIP Trial",
    site_title:"命理心憐空間 · VIP Trial",
    site_subtitle:"與「八字簡評」同款風格 · 手機&電腦一致體驗",
    lang_label:"語言",
    form_title:"命理分析 · 生成報告",
    choose_type:"選擇命盤類型",
    type_personal:"個人命盤", type_compat:"合盤（兩人資料）",
    culture_auto:"自動識別 Auto Detect", culture_cn:"東方 Chinese / Bazi",
    culture_west:"西方 Astrology / Tarot", culture_jp:"日式九星 Japanese", culture_vedic:"印度吠陀 Vedic",
    self_info:"本人資料", ph_name1:"姓名（本人）", ph_time1:"出生時間", ph_country1:"出生國家 / 地區",
    cal_g:"陽曆 (Gregorian)", cal_l:"農曆 (Lunar)",
    btn_next:"下一步",
    partner_info:"第二人資料（合盤）", ph_name2:"姓名（第二人）", ph_time2:"出生時間", ph_country2:"出生國家 / 地區",
    focus_title:"命理選題（報告聚焦）",
    opt_love:"姻緣 Love", opt_dating:"戀愛緣分", opt_marriage:"婚姻走勢",
    opt_career:"事業 Career", opt_work:"職場發展", opt_startup:"創業潛力",
    opt_wealth:"財運 Wealth", opt_wealthpos:"財位分析", opt_timing:"理財時機",
    opt_dates:"擇日 Auspicious Date", opt_wedding:"婚期擇日", opt_babydate:"新生寶寶擇日", opt_house:"新家入住擇日", opt_office:"新公司入住擇日",
    opt_name:"測名 Name Analysis", opt_babyname:"寶寶名", opt_petname:"寵物名", opt_companyname:"公司名", opt_rename:"命名改運",
    opt_fs:"風水 Feng Shui", opt_home:"住家", opt_officefs:"辦公室",
    opt_comp:"合盤分析 Compatibility", opt_couple:"情侶合盤（緣分起落 / 曖昧進展）",
    opt_spouse:"夫妻流年（婚姻發展）", opt_personality:"個性合盤（衝突 / 互補）",
    opt_partner:"事業合盤（合夥人 / 員工）", opt_reconnect:"斷聯修復（朋友 / 情人 / 家人）", opt_petbond:"寵物合盤（主人與寵物）",

    vip_overview:"VIP 內容總覽",
    vip_mingli:"🗝 命理空間專屬內容",
    list_love:"姻緣方向：戀愛緣分、婚姻走勢",
    list_career:"事業方向：職場發展、創業潛力",
    list_wealth:"財運方向：財位分析、理財時機",
    list_pet:"寵物命理：伴侶動物的性格與緣分",
    list_hepan:"合盤分析：婚期擇日、新生擇時",
    list_name:"測名分析：公司名、寶寶名、命名改運",
    list_fs:"財位合盤：住家 / 辦公室動線配合",
    vip_xinlian:"🌙 心憐空間專屬內容",
    list_record:"靈性記錄：照片、夢境、聲音、願望祈禱",
    list_course:"命理課程：八字 / 塔羅 / 占星 / 靈數 / 人類圖",
    list_memorial:"家族紀念系統：親人靈性紀念 & 延續",
    list_tasks:"每週能量練習 / 神明儀式任務",
    list_shop:"能量商城專屬折扣 & 御守訂製",
    btn_upgrade:"💎 升級為 VIP（月費）",
    btn_back:"← 返回命理商城",
    vip_note:"$9.9 / 月費（命理空間 + 心憐空間 + 靈性課程）· 註冊贈送一次免費體驗",

    portal_title:"心憐空間 · 功能入口",
    diary_title:"🧘‍♀️ 靈性日記", diary_desc:"照片上傳 / 語音記錄 / 靈性筆記 / 家庭日誌 / 願望祈禱（每日加持）",
    btn_personal:"個人隱藏記錄", btn_family:"家庭共享記錄", btn_upload:"上傳記錄",
    course_title:"📘 命理課程專區", course_bazi:"八字命理：十神 / 流年 / 用神分析", course_tarot:"塔羅牌：牌陣解讀 / 情境實戰",
    course_coming:"🌙 以下課程醞釀中：占星 / 靈數 / 人類圖 / 六爻 / 冥想引導 / 奇門 / 日式神明 / 紫微 / 能量學 / 西洋占星 / 心靈課程……",
    btn_enter_course:"進入課程",
    shop_title:"🛍️ 能量商城 · VIP折扣 & 御守訂製", shop_desc:"專屬祈願包分類：",
    wish_title:"🔮 夢想提交 Dream Submission", btn_manifest:"夢想規劃 / Manifestation",
    memorial_title:"📖 靈性空間 ~ 往生記憶錄", memorial_desc:"靈魂檔案 / 紀念回憶（圖文音） / 靈性延續（功德傳承）",
    btn_login_memorial:"登入靈性空間", btn_upload_memorial:"上傳往生錄", btn_register_memorial:"註冊靈性空間",

    login_title:"💎 登入 VIP 功能",
    ph_email:"信箱 Email",
    ph_password:"密碼 Password（至少8位，含大小寫數字符號）",
    btn_login:"登入帳戶",
    btn_register:"註冊帳戶",
    btn_reset:"🔑 重設密碼",
    btn_backshop:"← 返回命理商城",
    note_price:"註冊贈送一次免費體驗",
    note_price1:"$9.9 / 月費 VIP（命理空間 + 心憐空間 + 靈性課程）",

    err_expired:"會員已過期",
    err_no_account:"沒有此帳號，請先註冊",
    err_wrong_pwd:"密碼不正確",
    err_login_fail:"登入失敗，請稍後再試。",
    err_register_fail:"註冊失敗，請稍後再試。",
    err_need_ep:"請填寫信箱與密碼",
    err_pwd_rule:"密碼至少 8 位，需含大小寫、數字與符號",
    prompt_email:"請輸入註冊信箱",
    prompt_newpwd:"請輸入新密碼（至少8位，含大小寫數字符號）",
    err_email_empty:"信箱不可為空",
    err_pwd_empty:"密碼不可為空",
    err_reset_fail:"重設失敗，請稍後再試。",
    msg_reset_ok:"已重設成功，請用新密碼登入",

    chat_fab:"聊天",
    chat_placeholder:"想了解什麼呢？",
    chat_send:"送出"
  },

  "en": {
    page_title:"Soul Sanctuary · VIP Trial",
    site_title:"Soul Sanctuary · VIP Trial",
    lang_label:"Language",
    form_title:"Astro Analysis · Generate Report",
    choose_type:"Chart Type",
    type_personal:"Personal Chart", type_compat:"Synastry (Two Persons)",
    culture_auto:"Auto Detect", culture_cn:"Chinese / Bazi",
    culture_west:"Western Astrology / Tarot", culture_jp:"Japanese Nine Star Ki", culture_vedic:"Vedic Astrology",
    self_info:"Your Info", ph_name1:"Your Name", ph_time1:"Birth Time", ph_country1:"Birth Country / Region",
    cal_g:"Gregorian", cal_l:"Lunar",
    btn_next:"Next",
    partner_info:"Partner Info (Synastry)", ph_name2:"Partner Name", ph_time2:"Birth Time", ph_country2:"Birth Country / Region",
    focus_title:"Report Focus",
    opt_love:"Love", opt_dating:"Dating Fate", opt_marriage:"Marriage Trend",
    opt_career:"Career", opt_work:"Workplace", opt_startup:"Entrepreneurship",
    opt_wealth:"Wealth", opt_wealthpos:"Wealth Position", opt_timing:"Timing",
    opt_dates:"Auspicious Dates", opt_wedding:"Wedding Date", opt_babydate:"Baby Birth Date", opt_house:"House Move-in", opt_office:"Company Move-in",
    opt_name:"Name Analysis", opt_babyname:"Baby Name", opt_petname:"Pet Name", opt_companyname:"Company Name", opt_rename:"Renaming",
    opt_fs:"Feng Shui", opt_home:"Home", opt_officefs:"Office",
    opt_comp:"Compatibility", opt_couple:"Couple Synastry (Ups & Downs)", opt_spouse:"Spouse Transit (Marriage)", opt_personality:"Personality Fit (Conflict/Complement)",
    opt_partner:"Business Partner / Team", opt_reconnect:"Reconnect (Friends/Family/Lovers)", opt_petbond:"Owner–Pet Bond",

    vip_overview:"VIP Overview",
    vip_mingli:"🗝 Astro Sanctuary · Exclusive",
    list_love:"Love: Dating & Marriage",
    list_career:"Career: Workplace & Startup",
    list_wealth:"Wealth: Position & Timing",
    list_pet:"Pet Destiny: Temperament & Bond",
    list_hepan:"Synastry: Wedding Date / Birth Time",
    list_name:"Name Reading: Company/Baby/Renaming",
    list_fs:"Wealth × Layout: Home / Office",
    vip_xinlian:"🌙 Soul Sanctuary · Exclusive",
    list_record:"Spiritual Logs: Photos/Dreams/Voice/Prayers",
    list_course:"Courses: Bazi / Tarot / Astrology / Numerology / HD",
    list_memorial:"Family Memorial: Archive & Legacy",
    list_tasks:"Weekly Energy / Ritual Tasks",
    list_shop:"Store Discounts & Omamori",
    btn_upgrade:"💎 Upgrade to VIP (Monthly)",
    btn_back:"← Back to Store",
    vip_note:"$9.9 / month (Astro + Soul + Courses). New account gets one free trial.",

    portal_title:"Soul Sanctuary · Portals",
    diary_title:"🧘‍♀️ Spiritual Diary", diary_desc:"Photos / Voice / Notes / Family Log / Prayer (Daily Blessing)",
    btn_personal:"Personal (Private)", btn_family:"Family (Shared)", btn_upload:"Upload Entry",
    course_title:"📘 Courses", course_bazi:"Bazi: Ten Gods / Annual Luck / Useful God", course_tarot:"Tarot: Spreads & Practice",
    course_coming:"🌙 Coming soon: Astrology / Numerology / Human Design / I Ching / Meditation / Qimen / Shinto / Zi Wei / Energy / Western Astro / Spiritual courses…",
    btn_enter_course:"Enter Courses",
    shop_title:"🛍️ Energy Store · VIP Discount & Omamori", shop_desc:"Exclusive Blessing Packs:",
    wish_title:"🔮 Dream Submission", btn_manifest:"Manifestation Planner",
    memorial_title:"📖 Memorial Space", memorial_desc:"Soul Archive / Media Memories / Spiritual Continuance",
    btn_login_memorial:"Log in", btn_upload_memorial:"Upload Record", btn_register_memorial:"Register",

    login_title:"💎 Log in to VIP",
    ph_email:"Email",
    ph_password:"Password (≥8 chars with upper/lowercase, number & symbol)",
    btn_login:"Log In",
    btn_register:"Register",
    btn_reset:"🔑 Reset Password",
    btn_backshop:"← Back to Store",
    note_price:"One free trial for new accounts.",
    note_price1:"$9.9 / month VIP (Astro + Soul + Courses).",

    err_expired:"Membership expired",
    err_no_account:"Account not found. Please register first.",
    err_wrong_pwd:"Incorrect password",
    err_login_fail:"Login failed. Please try again later.",
    err_register_fail:"Registration failed. Please try again later.",
    err_need_ep:"Please enter email and password",
    err_pwd_rule:"Password must be ≥8 chars and include upper/lowercase, number, and symbol",
    prompt_email:"Enter your email",
    prompt_newpwd:"Enter a new password (≥8 chars with upper/lowercase, number & symbol)",
    err_email_empty:"Email cannot be empty",
    err_pwd_empty:"Password cannot be empty",
    err_reset_fail:"Reset failed. Please try again later.",
    msg_reset_ok:"Password reset succeeded. Please log in with the new password.",

    chat_fab:"Chat",
    chat_placeholder:"Ask me anything…",
    chat_send:"Send"
  },

  "ja": {
    page_title:"ソウル・サンクチュアリ · VIPセグメント",
    site_title:"ソウル・サンクチュアリ · VIPセグメント",
    site_subtitle:"四柱簡評と同デザイン · モバイル/PC一貫体験",
    lang_label:"言語",
    form_title:"命理分析 · レポート作成",
    choose_type:"命盤タイプ",
    type_personal:"個人命盤", type_compat:"相性（2人）",
    culture_auto:"自動検出", culture_cn:"中国四柱推命",
    culture_west:"西洋占星 / タロット", culture_jp:"九星気学", culture_vedic:"ヴェーディック占星",
    self_info:"本人情報", ph_name1:"氏名（本人）", ph_time1:"出生時刻", ph_country1:"出生国 / 地域",
    cal_g:"西暦", cal_l:"旧暦",
    btn_next:"次へ",
    partner_info:"相手情報（相性）", ph_name2:"氏名（相手）", ph_time2:"出生時刻", ph_country2:"出生国 / 地域",
    focus_title:"レポート重点",
    opt_love:"恋愛", opt_dating:"恋愛縁", opt_marriage:"結婚運",
    opt_career:"仕事", opt_work:"職場発展", opt_startup:"起業潜在",
    opt_wealth:"金運", opt_wealthpos:"財位分析", opt_timing:"タイミング",
    opt_dates:"良日選び", opt_wedding:"結婚日", opt_babydate:"出産日", opt_house:"新居入居", opt_office:"会社入居",
    opt_name:"命名", opt_babyname:"赤ちゃん名", opt_petname:"ペット名", opt_companyname:"会社名", opt_rename:"改名",
    opt_fs:"風水", opt_home:"住居", opt_officefs:"オフィス",
    opt_comp:"相性分析", opt_couple:"カップル相性（浮き沈み）",
    opt_spouse:"夫婦運（結婚発展）", opt_personality:"性格相性（衝突/補完）",
    opt_partner:"ビジネス相性（共同/従業員）", opt_reconnect:"関係修復（友/家族/恋人）", opt_petbond:"ペット相性（飼い主とペット）",

    vip_overview:"VIP コンテンツ概要",
    vip_mingli:"🗝 命理エリア · 限定",
    list_love:"恋愛：縁・結婚の流れ",
    list_career:"仕事：職場・起業",
    list_wealth:"金運：財位・タイミング",
    list_pet:"ペット：性格とご縁",
    list_hepan:"相性：結婚日 / 出産時刻",
    list_name:"命名：会社/赤ちゃん/改名",
    list_fs:"財位×レイアウト：住居 / オフィス",
    vip_xinlian:"🌙 心怜エリア · 限定",
    list_record:"スピリチュアル記録：写真/夢/音声/祈り",
    list_course:"講座：四柱 / タロット / 占星 / 数秘 / HD",
    list_memorial:"家族メモリアル：記録と継承",
    list_tasks:"毎週エナジー / 儀式タスク",
    list_shop:"ストア割引 & お守り",
    btn_upgrade:"💎 VIPへアップグレード（月額）",
    btn_back:"← ストアへ戻る",
    vip_note:"$9.9/月（命理 + 心怜 + 講座）。新規登録は1回無料体験。",

    portal_title:"心怜スペース · 入り口",
    diary_title:"🧘‍♀️ スピ日記", diary_desc:"写真 / 音声 / ノート / 家族ログ / 祈り（毎日加持）",
    btn_personal:"個人（非公開）", btn_family:"家族（共有）", btn_upload:"投稿する",
    course_title:"📘 講座", course_bazi:"四柱：十神 / 年運 / 用神", course_tarot:"タロット：スプレッド/実戦",
    course_coming:"🌙 まもなく：占星 / 数秘 / HD / 易 / 瞑想 / 気門 / 神道 / 紫微 / エナジー / 西洋占星 / スピ講座…",
    btn_enter_course:"講座に入る",
    shop_title:"🛍️ エナジーストア · VIP割引 & 御守り", shop_desc:"祈願パック：",
    wish_title:"🔮 夢の実現", btn_manifest:"マニフェステーション",
    memorial_title:"📖 メモリアル", memorial_desc:"魂の記録 / 想い出 / 霊性継承",
    btn_login_memorial:"ログイン", btn_upload_memorial:"記録を投稿", btn_register_memorial:"登録する",

    login_title:"💎 VIP にログイン",
    ph_email:"メールアドレス",
    ph_password:"パスワード（8文字以上・大小英数・記号必須）",
    btn_login:"ログイン",
    btn_register:"登録する",
    btn_reset:"🔑 パスワードを再設定",
    btn_backshop:"← ストアへ戻る",
    note_price:"新規は1回無料体験",
    note_price1:"$9.9 / 月（命理 + 心怜 + 講座）",    

    err_expired:"会員期限が切れています",
    err_no_account:"アカウントが見つかりません。先に登録してください。",
    err_wrong_pwd:"パスワードが正しくありません",
    err_login_fail:"ログインに失敗しました。しばらくしてからお試しください。",
    err_register_fail:"登録に失敗しました。しばらくしてからお試しください。",
    err_need_ep:"メールとパスワードを入力してください",
    err_pwd_rule:"パスワードは8文字以上で、大小英字・数字・記号を含めてください",
    prompt_email:"登録メールを入力してください",
    prompt_newpwd:"新しいパスワードを入力してください（8文字以上・複合）",
    err_email_empty:"メールは必須です",
    err_pwd_empty:"パスワードは必須です",
    err_reset_fail:"再設定に失敗しました。後でもう一度。",
    msg_reset_ok:"再設定が完了しました。新しいパスワードでログインしてください。",

    chat_fab:"チャット",
    chat_placeholder:"ご質問はありますか？",
    chat_send:"送信"
  },

  "th": {
    page_title:"Soul Sanctuary · VIP",
    site_title:"Soul Sanctuary · VIP",
    site_subtitle:"สไตล์เดียวกับ Bazi Free · มือถือ/พีซีเหมือนกัน",
    lang_label:"ภาษา",
    form_title:"วิเคราะห์ดวง · สร้างรายงาน",
    choose_type:"เลือกประเภทดวง",
    type_personal:"ดวงส่วนตัว", type_compat:"ดวงคู่ (2 คน)",
    culture_auto:"ตรวจอัตโนมัติ", culture_cn:"จีน / Bazi",
    culture_west:"ตะวันตก / Tarot", culture_jp:"เก้าดาวญี่ปุ่น", culture_vedic:"เวทโหราศาสตร์",
    self_info:"ข้อมูลของคุณ", ph_name1:"ชื่อ", ph_time1:"เวลาเกิด", ph_country1:"ประเทศ/ภูมิภาคเกิด",
    cal_g:"สากล", cal_l:"จันทรคติ",
    btn_next:"ถัดไป",
    partner_info:"ข้อมูลคู่ (Synastry)", ph_name2:"ชื่อคู่", ph_time2:"เวลาเกิด", ph_country2:"ประเทศ/ภูมิภาคเกิด",
    focus_title:"หัวข้อรายงาน",
    opt_love:"ความรัก", opt_dating:"ชะตาความรัก", opt_marriage:"แนวโน้มแต่งงาน",
    opt_career:"การงาน", opt_work:"พัฒนางาน", opt_startup:"ศักยภาพธุรกิจ",
    opt_wealth:"การเงิน", opt_wealthpos:"ตำแหน่งโชคลาภ", opt_timing:"จังหวะลงทุน",
    opt_dates:"ฤกษ์งามยามดี", opt_wedding:"วันแต่งงาน", opt_babydate:"ฤกษ์คลอด", opt_house:"ย้ายบ้าน", opt_office:"ย้ายสำนักงาน",
    opt_name:"ตั้งชื่อ", opt_babyname:"ชื่อลูก", opt_petname:"ชื่อสัตว์เลี้ยง", opt_companyname:"ชื่อบริษัท", opt_rename:"เปลี่ยนชื่อ",
    opt_fs:"ฮวงจุ้ย", opt_home:"บ้าน", opt_officefs:"ออฟฟิศ",
    opt_comp:"ความเข้ากันได้", opt_couple:"คู่รัก (ขึ้นลง/สถานะคุย)",
    opt_spouse:"คู่สมรส (พัฒนาการ)", opt_personality:"บุคลิก (ขัดแย้ง/เสริมกัน)",
    opt_partner:"หุ้นส่วนธุรกิจ/ทีม", opt_reconnect:"เชื่อมสัมพันธ์ใหม่", opt_petbond:"เจ้าของ–สัตว์เลี้ยง",

    vip_overview:"สรุป VIP",
    vip_mingli:"🗝 โซน Astro · พิเศษ",
    list_love:"ความรัก: คู่แท้/แต่งงาน",
    list_career:"การงาน: ที่ทำงาน/ทำธุรกิจ",
    list_wealth:"การเงิน: ตำแหน่ง/จังหวะ",
    list_pet:"สัตว์เลี้ยง: นิสัยและสายใย",
    list_hepan:"Synastry: วันแต่ง/เวลาคลอด",
    list_name:"ชื่อ: บริษัท/ลูก/เปลี่ยนชื่อ",
    list_fs:"โชคลาภ × ผังบ้าน/ออฟฟิศ",
    vip_xinlian:"🌙 โซน Soul · พิเศษ",
    list_record:"บันทึกจิตวิญญาณ: รูป/ฝัน/เสียง/คำอธิษฐาน",
    list_course:"คอร์ส: Bazi / Tarot / Astrology / Numerology / HD",
    list_memorial:"อนุสรณ์ครอบครัว: บันทึกและมรดกจิตวิญญาณ",
    list_tasks:"ฝึกพลังงานรายสัปดาห์ / พิธีกรรม",
    list_shop:"ส่วนลดร้าน & Omamori",
    btn_upgrade:"💎 อัปเกรด VIP (รายเดือน)",
    btn_back:"← กลับร้าน",
    vip_note:"$9.9 / เดือน (Astro + Soul + คอร์ส) สมัครใหม่ใช้ฟรี 1 ครั้ง",

    portal_title:"พอร์ทัล Soul Sanctuary",
    diary_title:"🧘‍♀️ ไดอารี่วิญญาณ", diary_desc:"รูป / เสียง / บันทึก / ครอบครัว / คำอธิษฐาน (เสริมพลังรายวัน)",
    btn_personal:"ส่วนตัว", btn_family:"ครอบครัว", btn_upload:"อัปโหลด",
    course_title:"📘 คอร์ส", course_bazi:"Bazi: Ten Gods / Annual / Useful God", course_tarot:"Tarot: Spreads & Practice",
    course_coming:"🌙 เร็ว ๆ นี้: โหราศาสตร์ / ตัวเลขชีวิต / HD / อี้จิง / ทำสมาธิ / Qimen / Shinto / Zi Wei / พลังงาน / ตะวันตก / จิตวิญญาณ…",
    btn_enter_course:"เข้าสู่คอร์ส",
    shop_title:"🛍️ Energy Store · ส่วนลด VIP & Omamori", shop_desc:"ชุดพรเฉพาะ:",
    wish_title:"🔮 ส่งคำปรารถนา", btn_manifest:"วางแผน Manifest",
    memorial_title:"📖 พื้นที่อนุสรณ์", memorial_desc:"แฟ้มวิญญาณ / ความทรงจำ / สืบทอดจิตวิญญาณ",
    btn_login_memorial:"เข้าสู่ระบบ", btn_upload_memorial:"อัปโหลด", btn_register_memorial:"สมัคร",

    login_title:"💎 เข้าสู่ระบบ VIP",
    ph_email:"อีเมล",
    ph_password:"รหัสผ่าน (อย่างน้อย 8 ตัว รวมตัวพิมพ์ใหญ่-เล็ก ตัวเลข และสัญลักษณ์)",
    btn_login:"เข้าสู่ระบบ",
    btn_register:"สมัครสมาชิก",
    btn_reset:"🔑 รีเซ็ตรหัสผ่าน",
    btn_backshop:"← กลับร้าน",
    note_price:"สมัครใหม่ใช้ฟรี 1 ครั้ง",
    note_price:"$9.9 / เดือน VIP (Astro + Soul + คอร์ส)",

    err_expired:"สมาชิกหมดอายุ",
    err_no_account:"ไม่พบบัญชี กรุณาสมัครก่อน",
    err_wrong_pwd:"รหัสผ่านไม่ถูกต้อง",
    err_login_fail:"เข้าสู่ระบบไม่สำเร็จ โปรดลองใหม่ภายหลัง",
    err_register_fail:"สมัครไม่สำเร็จ โปรดลองใหม่ภายหลัง",
    err_need_ep:"กรอกอีเมลและรหัสผ่านก่อน",
    err_pwd_rule:"รหัสผ่านต้อง ≥8 ตัว และมีตัวพิมพ์ใหญ่-เล็ก ตัวเลข และสัญลักษณ์",
    prompt_email:"กรอกอีเมลของคุณ",
    prompt_newpwd:"กรอกรหัสผ่านใหม่ (≥8 ตัว และแบบผสม)",
    err_email_empty:"อีเมลห้ามว่าง",
    err_pwd_empty:"รหัสผ่านห้ามว่าง",
    err_reset_fail:"รีเซ็ตไม่สำเร็จ โปรดลองใหม่",
    msg_reset_ok:"รีเซ็ตสำเร็จ กรุณาเข้าสู่ระบบด้วยรหัสใหม่",

    chat_fab:"แชต",
    chat_placeholder:"อยากถามอะไร…",
    chat_send:"ส่ง"
  },

  "ms": {
    page_title:"Soul Sanctuary · VIP",
    site_title:"Soul Sanctuary · VIP",
    site_subtitle:"Gaya sama dengan Bazi Free · Seragam Mudah Alih & Desktop",
    lang_label:"Bahasa",
    form_title:"Analisis · Jana Laporan",
    choose_type:"Jenis Carta",
    type_personal:"Peribadi", type_compat:"Keserasian (2 Orang)",
    culture_auto:"Auto Detect", culture_cn:"Cina / Bazi",
    culture_west:"Barat / Tarot", culture_jp:"Sembilan Bintang Jepun", culture_vedic:"Astrologi Veda",
    self_info:"Maklumat Anda", ph_name1:"Nama", ph_time1:"Masa Lahir", ph_country1:"Negara/Kawasan",
    cal_g:"Gregorian", cal_l:"Lunar",
    btn_next:"Seterusnya",
    partner_info:"Maklumat Pasangan (Synastry)", ph_name2:"Nama Pasangan", ph_time2:"Masa Lahir", ph_country2:"Negara/Kawasan",
    focus_title:"Fokus Laporan",
    opt_love:"Cinta", opt_dating:"Jodoh", opt_marriage:"Trend Perkahwinan",
    opt_career:"Kerjaya", opt_work:"Tempat Kerja", opt_startup:"Potensi Usahawan",
    opt_wealth:"Kewangan", opt_wealthpos:"Posisi Kekayaan", opt_timing:"Masa",
    opt_dates:"Tarikh Bertuah", opt_wedding:"Tarikh Kahwin", opt_babydate:"Tarikh Kelahiran Bayi", opt_house:"Pindah Rumah", opt_office:"Pindah Syarikat",
    opt_name:"Analisis Nama", opt_babyname:"Nama Bayi", opt_petname:"Nama Haiwan", opt_companyname:"Nama Syarikat", opt_rename:"Tukar Nama",
    opt_fs:"Feng Shui", opt_home:"Rumah", opt_officefs:"Pejabat",
    opt_comp:"Keserasian", opt_couple:"Pasangan (Naik/Turun)",
    opt_spouse:"Suami Isteri (Perkembangan)", opt_personality:"Personaliti (Konflik/Tampung)",
    opt_partner:"Rakan Niaga / Kakitangan", opt_reconnect:"Sambung Semula", opt_petbond:"Pemilik–Haiwan",

    vip_overview:"Gambaran VIP",
    vip_mingli:"🗝 Kandungan Eksklusif · Astro",
    list_love:"Cinta: Jodoh & Perkahwinan",
    list_career:"Kerjaya: Tempat Kerja & Usahawan",
    list_wealth:"Kewangan: Posisi & Masa",
    list_pet:"Haiwan Peliharaan: Perangai & Ikatan",
    list_hepan:"Synastry: Tarikh Kahwin / Masa Lahir",
    list_name:"Nama: Syarikat/Bayi/Tukar Nama",
    list_fs:"Kekayaan × Susun Atur: Rumah / Pejabat",
    vip_xinlian:"🌙 Kandungan Eksklusif · Soul",
    list_record:"Log Rohani: Foto/Mimpi/Suara/Doa",
    list_course:"Kursus: Bazi / Tarot / Astrologi / Numerologi / HD",
    list_memorial:"Memorial Keluarga: Arkib & Legasi",
    list_tasks:"Latihan Tenaga Mingguan / Ritual",
    list_shop:"Diskaun Kedai & Omamori",
    btn_upgrade:"💎 Naik Taraf VIP (Bulanan)",
    btn_back:"← Kembali ke Kedai",
    vip_note:"$9.9 / bulan (Astro + Soul + Kursus). Akaun baharu dapat percubaan percuma.",

    portal_title:"Portal Soul Sanctuary",
    diary_title:"🧘‍♀️ Diari Rohani", diary_desc:"Foto / Suara / Nota / Log Keluarga / Doa (Berkat Harian)",
    btn_personal:"Peribadi", btn_family:"Keluarga", btn_upload:"Muat Naik",
    course_title:"📘 Kursus", course_bazi:"Bazi: Ten Gods / Tahunan / Useful God", course_tarot:"Tarot: Bentangan & Amali",
    course_coming:"🌙 Akan Datang: Astrologi / Numerologi / HD / I Ching / Meditasi / Qimen / Shinto / Zi Wei / Tenaga / Barat / Kerohanian…",
    btn_enter_course:"Masuk Kursus",
    shop_title:"🛍️ Kedai Tenaga · Diskaun VIP & Omamori", shop_desc:"Pek Berkat Eksklusif:",
    wish_title:"🔮 Hantar Impian", btn_manifest:"Perancang Manifestasi",
    memorial_title:"📖 Ruang Memorial", memorial_desc:"Arkib Jiwa / Kenangan / Kelangsungan Rohani",
    btn_login_memorial:"Log Masuk", btn_upload_memorial:"Muat Naik", btn_register_memorial:"Daftar",

    login_title:"💎 Log Masuk VIP",
    ph_email:"E-mel",
    ph_password:"Kata laluan (≥8 aksara dengan huruf besar/kecil, nombor & simbol)",
    btn_login:"Log Masuk",
    btn_register:"Daftar",
    btn_reset:"🔑 Tetapkan Semula Kata Laluan",
    btn_backshop:"← Kembali ke Kedai",
    note_price:"Akaun baharu percubaan percuma sekali.",
    note_price:"$9.9 / bulan VIP (Astro + Soul + Kursus).",

    err_expired:"Keahlian tamat tempoh",
    err_no_account:"Akaun tidak dijumpai. Sila daftar dahulu.",
    err_wrong_pwd:"Kata laluan tidak betul",
    err_login_fail:"Gagal log masuk. Cuba lagi nanti.",
    err_register_fail:"Gagal mendaftar. Cuba lagi nanti.",
    err_need_ep:"Sila masukkan e-mel dan kata laluan",
    err_pwd_rule:"Kata laluan mesti ≥8 aksara dan mengandungi huruf besar/kecil, nombor dan simbol",
    prompt_email:"Masukkan e-mel anda",
    prompt_newpwd:"Masukkan kata laluan baharu (≥8 aksara, campuran)",
    err_email_empty:"E-mel tidak boleh kosong",
    err_pwd_empty:"Kata laluan tidak boleh kosong",
    err_reset_fail:"Gagal menetapkan semula. Cuba lagi nanti.",
    msg_reset_ok:"Berjaya ditetapkan semula. Sila log masuk dengan kata laluan baharu.",

    chat_fab:"Sembang",
    chat_placeholder:"Ada apa nak tanya?",
    chat_send:"Hantar"
  }
};

  function t(key){
    const L = translations[getLang()] || translations["zh-CN"];
    return L[key] || (translations["zh-CN"][key] || key);
  }
  function applyI18n(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
      const key = el.getAttribute("data-i18n-ph");
      el.setAttribute("placeholder", t(key));
    });
    const titleEl = document.querySelector("title[data-i18n]");
    if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
  }
  function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }

  // ============== Chat 浮窗（走 /api/chat） ==============
  function applyChatI18n(){
    const fab = document.getElementById('ssChatFab');
    const inp = document.getElementById('ssChatInput');
    const btn = document.getElementById('ssChatSend');
    if (fab) fab.textContent = t('chat_fab');
    if (inp) inp.placeholder = t('chat_placeholder');
    if (btn) btn.textContent = t('chat_send');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Chat 按钮与面板
    const chatFab = document.createElement('div');
    chatFab.className = 'ss-chat-fab'; chatFab.id = 'ssChatFab'; chatFab.title = '心怜管家';

    const chatPanel = document.createElement('div');
    chatPanel.className = 'ss-chat-panel'; chatPanel.id = 'ssChatPanel'; chatPanel.setAttribute('role','dialog'); chatPanel.setAttribute('aria-label','心怜管家');
    chatPanel.innerHTML = `
      <div class="ss-chat-head">
        <div class="ss-chat-title">心怜管家 · Chat</div>
        <div class="ss-close" id="ssChatClose">✕</div>
      </div>
      <div class="ss-chat-body" id="ssChatBody" aria-live="polite"></div>
      <div class="ss-chat-input">
        <input id="ssChatInput" type="text" />
        <button id="ssChatSend"></button>
      </div>`;

    document.body.appendChild(chatFab);
    document.body.appendChild(chatPanel);

    // 初始语言（页面 + chat）
    const select = document.getElementById("langSelect");
    const current = getLang();
    if (select) select.value = current;
    applyI18n();
    applyChatI18n();

    const $body  = document.getElementById('ssChatBody');
    const $input = document.getElementById('ssChatInput');
    const $send  = document.getElementById('ssChatSend');
    const $close = document.getElementById('ssChatClose');

    const openPanel  = () => { chatPanel.style.display = 'flex'; $input.focus(); };
    const closePanel = () => { chatPanel.style.display = 'none'; };
    chatFab.addEventListener('click', openPanel);
    $close.addEventListener('click', closePanel);

    function addMsg(text, me=false){
      const div = document.createElement('div');
      div.className = 'ss-msg' + (me ? ' me' : '');
      div.textContent = text;
      $body.appendChild(div);
      $body.scrollTop = $body.scrollHeight;
    }

    async function askChat(prompt){
      addMsg(prompt, true);
      $input.value = '';
      $input.focus();
      try{
        const r = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [
              { role:'system', content:'你是“心怜管家”，帮助访客了解命理心怜空间的功能、导航与会员说明，语气温暖专业、简洁有条理。' },
              { role:'user', content: prompt }
            ]
          })
        });
        let data, reply = '';
        try { data = await r.json(); } catch { data = {}; }
        reply = data.reply ?? data.text ?? data?.choices?.[0]?.message?.content ?? "";
        if (!reply) return addMsg('抱歉，服务暂时繁忙，请稍后重试。');
        addMsg(reply);
      }catch(e){
        addMsg('网络异常，请稍后再试。');
      }
    }
    $send.addEventListener('click', ()=>{ const v=$input.value.trim(); if(v) askChat(v); });
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=$input.value.trim(); if(v) askChat(v); }});

    // 语言切换时，同步更新
    if (select) {
      select.addEventListener("change", ()=>{
        setLang(select.value);
        applyI18n();
        applyChatI18n();
      });
    }
  });

  // ============== 登录流程（集中处理 exists / expired / expiresAt） ==============
  async function safeJson(resp){
    try { return await resp.json(); } catch { return { ok:false, msg:'upstream_error' }; }
  }

  async function loginFlow(email, password){
    const res = await safeJson(await fetch(`${API_BASE}/api/login`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }));

    const msg = (res.msg || "").toString().toLowerCase();

    // ✅ 统一判断是否过期（兼容 msg/flag/时间戳）
    let expired = false;
    if (res.expired === true) expired = true;
    else if (msg === 'expired') expired = true;
    else if (res.expiresAt) {
      const ts = Date.parse(res.expiresAt);
      if (!Number.isNaN(ts) && ts < Date.now()) expired = true;
    }

    if (expired) {
      // 只提示，不跳转；可一键引导续费
      const go = confirm(t('err_expired') + "。是否前往续费？");
      if (go) window.open("https://yourshopifyshop.com/products/monthly-vip", "_blank");
      return;
    }

    // ✅ 正常通过才跳 VIP
    if (res.ok === true) {
      localStorage.setItem("vipEmail", res.email || email);
      location.href = "https://astro.5xliving.com/vip_soul_sanctuary.html";
      return;
    }

    // 常见错误
    if (msg === 'no_account') return showErr(t('err_no_account'));
    if (msg === 'wrong_pwd')  return showErr(t('err_wrong_pwd'));
    return showErr(t('err_login_fail') + (res.msg ? ` ${res.msg}` : ''));
  }

  // ======== 表单事件（注册 / 登录 / 重设） ========
  document.getElementById("registerForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    if (!strongPwd(password)) return showErr(t('err_pwd_rule'));

    lock($("registerBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/register`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      }));

      if (res.ok === true){
        localStorage.setItem("vipEmail", email);
        location.href = "vip_trial.html";
        return;
      }

      // 已存在：自动尝试登录（用刚输入的密码）
      if ((res.msg||"").toString() === 'exists'){
        await loginFlow(email, password);
        return;
      }

      return showErr((res.msg && (res.msg+'')) || t('err_register_fail'));
    } catch(err){
      showErr(t('err_register_fail') + (err?.message || ''));
    } finally{
      lock($("registerBtn"), false);
    }
  });

  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideErr();
    const email = $("email").value.trim();
    const password = $("password").value.trim();
    if (!email || !password) return showErr(t('err_need_ep'));
    lock($("loginBtn"), true);
    try{
      await loginFlow(email, password);
    } catch(err){
      showErr(t('err_login_fail') + (err?.message || ''));
    } finally{
      lock($("loginBtn"), false);
    }
  });

  document.getElementById("resetBtn").addEventListener("click", async ()=>{
    hideErr();
    let email = prompt(t('prompt_email'));
    if (email === null) return; email = email.trim();
    if (!email) return showErr(t('err_email_empty'));

    let newPassword = prompt(t('prompt_newpwd'));
    if (newPassword === null) return; newPassword = newPassword.trim();
    if (!newPassword) return showErr(t('err_pwd_empty'));
    if (!strongPwd(newPassword)) return showErr(t('err_pwd_rule'));

    lock($("resetBtn"), true);
    try{
      const res = await safeJson(await fetch(`${API_BASE}/api/reset`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword })
      }));
      if (!res.ok) return showErr((res.msg && (res.msg+'')) || t('err_reset_fail'));
      alert(t('msg_reset_ok'));
    } catch(err){
      showErr(t('err_reset_fail') + (err?.message || ''));
    } finally{
      lock($("resetBtn"), false);
    }
  });
</script>
</body>
</html>
