
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="page_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· VIP Segment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
    :root{
  --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
  --brand:#d4af37; --gold:#d4af37; --gold2:#f2d27a; --accent:#58b9ff;
  --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
  --card-w:128px; --card-h:212px; --gap:14px;
}
@media (max-width:640px){
  :root{ --card-w:100px; --card-h:168px; --gap:10px; }
}

html,body{height:100%}
body{
  margin:0; color:var(--text);
  background: radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
              linear-gradient(180deg,#0b0f14,#0b0f14);
  font-family: Inter,system-ui,-apple-system,"Noto Sans SC","Segoe UI",Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-2;
  background: linear-gradient(rgba(11, 15, 20, 0.85), rgba(11, 15, 20, 0.9)), 
              radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
              radial-gradient(circle at 80% 20%, rgba(88, 185, 255, 0.05) 0%, transparent 50%);
}

/* å…¨å±€å®¹å™¨ */
.container{
  max-width:1100px;
  margin:0 auto;
  padding:24px 16px 80px;
}

/* â€”â€” å¤´éƒ¨ â€”â€” */
.site-header{
  position:sticky;
  top:0;
  z-index:10;
  background:#0b0f14cc;
  border-bottom:1px solid #0f1622;
  backdrop-filter:saturate(140%) blur(12px);
  transition:.3s;
}
.site-header.scrolled{
  background:rgba(11,15,20,.95);
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.head-inner{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:14px 16px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  text-decoration:none; color:var(--text);
}
.brand-badge{
  display:inline-grid; place-items:center;
  width:34px; height:34px; border-radius:8px;
  background:linear-gradient(180deg,#0e1520,#0b1018);
  border:1px solid #2a3546;
  box-shadow:0 4px 14px rgba(0,0,0,.35);
  font-weight:800; color:#ffe084;
  transition:.3s;
}
.brand:hover .brand-badge{
  transform:rotate(15deg);
  box-shadow:0 6px 20px rgba(212,175,55,.3);
}
.title{
  font-family:"Noto Serif SC","Noto Serif",serif!important;
  font-weight:600!important;
  letter-spacing:.02em;
  font-size:1.1rem!important;
  line-height:1.25;
}
.brand:hover .title{color:var(--gold);}
.lang{
  display:flex; align-items:center; gap:8px;
}
.lang label{
  white-space:nowrap; color:var(--muted); margin-right:4px;
}
.lang select{
  appearance:none;
  min-width:170px;
  border-radius:10px;
  border:1px solid #243244;
  background:#0e1520;
  color:var(--text);
  padding:10px 34px 10px 12px;
  font-size:.95rem;
  background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:calc(100% - 12px) 50%;
  transition:.3s;
}
.lang select:focus{
  outline:none;
  border-color:var(--gold);
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}
@media (max-width:520px){
  .title{font-size:1rem}
  .lang select{min-width:140px}
}

    .lang{display:flex;align-items:center;gap:8px}
    .lang label{color:var(--muted);font-size:.9rem}
    .lang select{appearance:none;border-radius:10px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:10px 34px 10px 12px;font-size:.95rem;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));padding:18px}
    .section{margin-top:18px}
    .section h2{font-family:"Noto Serif SC","Noto Serif",serif;font-weight:600;font-size:1.2rem;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    .section h2::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px #58b9ff22}
    .group-title{font-size:1.05rem;color:#ffe084;margin:6px 0 14px}
    .muted{color:var(--muted)} .error{color:#ff8f8f;margin-top:8px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
    input,select,button{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #243244;background:#0e1520;color:var(--text);padding:14px 13px;font-size:1rem;outline:none}
    input::placeholder{color:#6f8092}
    select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2398a7b7' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:calc(100% - 12px) 50%}
    .btn{background:linear-gradient(180deg,#1d2a3a,#101723);border:1px solid #28364a;font-weight:600;letter-spacing:.02em;cursor:pointer;transition:transform .05s ease,box-shadow .2s ease,border .2s ease}
    .btn:hover{box-shadow:0 6px 18px rgba(88,185,255,.15),inset 0 1px 0 #2e3c50}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-gold{background:linear-gradient(180deg,#f7e7a8,#d4af37);color:#191919;border:1px solid #d4af37}
    .columns{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.columns{grid-template-columns:1fr 1fr}}
    .list-block{border:1px solid #263448;background:#0e1520;border-radius:12px;padding:16px}
    .list-block ul{margin:.2rem 0 0;padding-left:1.1rem}
    .list-block li{line-height:1.9}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .link-btn{display:grid;place-items:center;text-decoration:none}
    footer{color:#6c7b8c;font-size:.85rem;text-align:center;padding:30px 0}

  /* ===== VIP åŒºåŸŸï¼ˆç»Ÿä¸€æ ·å¼ Â· ä¸ energy.html ä¸€è‡´ï¼‰ ===== */
.card.section{
  max-width:1100px;
  margin:32px auto 40px;
  padding:18px 18px 22px;
  border-radius:var(--radius);
  border:1px solid #1f2a36;
  background:#11161dcc;
  box-shadow:var(--shadow);
  box-sizing:border-box;
}

.group-title{
  font-weight:800;
  color:#ffe084;
  font-size:1rem;
  margin:0 0 10px;
}

/* ä¸ŠåŠéƒ¨ï¼šå·¦å³ä¸¤å— VIP åˆ—è¡¨ */
.card.section .columns{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:16px;
  margin-top:10px;
}
.card.section .list-block{
  border-radius:12px;
  border:1px solid #1f2a36;
  background:#0f141d;
  padding:14px 16px;
}
.card.section .list-block ul{
  list-style:none;
  margin:6px 0 0;
  padding:0;
}
.card.section .list-block li{
  margin:.25rem 0;
  font-size:.95rem;
  color:var(--muted);
  line-height:1.6;
}

/* ä¸‹åŠéƒ¨ï¼šç™»å½•åŒºåŸŸ */
.astro-auth{
  margin-top:16px;
}
.astro-auth .auth-grid{
  display:grid;
  grid-template-columns:1.2fr 0.8fr;
  gap:16px;
}
.astro-auth .panel{
  background:#11161dcc;
  border-radius:14px;
  border:1px solid #1f2a36;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  padding:16px 18px 18px;
  box-sizing:border-box;
}
.astro-auth .panel .head{
  font-size:.95rem;
  font-weight:800;
  color:#ffe084;
  padding-bottom:8px;
  margin-bottom:10px;
  border-bottom:1px solid #1f2a36;
}
.astro-auth .panel .body{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .row{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.astro-auth .body .spacer{
  height:4px;
}

/* è¾“å…¥æ¡† = è·Ÿ energy.html ä¸€æ ·å®½åº¦ */
.astro-auth input[type="email"],
.astro-auth input[type="password"]{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #243244;
  background:#0e1520;
  color:#e8edf3;
  font-size:15px;
  box-sizing:border-box;
}
.astro-auth input[type="email"]::placeholder,
.astro-auth input[type="password"]::placeholder{
  color:#6f8092;
}
.astro-auth input[type="email"]:focus,
.astro-auth input[type="password"]:focus{
  outline:none;
  border-color:#d4af37;
  box-shadow:0 0 0 2px rgba(212,175,55,.2);
}

/* ç™»å½• / é‡è®¾ / æ³¨å†ŒæŒ‰é’® = å’Œè¾“å…¥æ¡†åŒå®½ï¼Œpill å½¢çŠ¶ */
.astro-auth .btn{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  max-width:100%;
  padding:11px 18px;
  border-radius:999px;
  border:1px solid #e6c76e;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  font-weight:800;
  text-align:center;
  box-shadow:0 6px 20px rgba(230,199,110,.35);
  white-space:nowrap;
  box-sizing:border-box;
  transition:.12s ease;
}
.astro-auth .btn.block{
  width:100%;
}

/* æ·±è‰²çš„ reset æŒ‰é’®æ ·å¼ */
.astro-auth .btn.ghost.block{
  background:#101826;
  border-color:#273245;
  color:#e8edf3;
  box-shadow:none;
}
.astro-auth .btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(230,199,110,.45);
}
.astro-auth .btn.ghost.block:hover{
  border-color:#d4af37;
  background:rgba(212,175,55,.08);
}

.error-message{
  color:#ff7b7b;
  font-size:.85rem;
}

/* å°å±ï¼šVIP åŒºã€ç™»å½•åŒºéƒ½ä¸€åˆ—æ’å¸ƒ */
@media (max-width:768px){
  .card.section .columns{
    grid-template-columns:1fr;
  }
  .astro-auth .auth-grid{
    grid-template-columns:1fr;
  }
}

/* ===== æ— éšœç¢ & å·¥å…· ===== */
.sr-only{
  position:absolute!important;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
.btn-row{
  display:flex;
  align-items:stretch;
  gap:10px;
  width:100%;
  box-sizing:border-box;
}
.btn-row .btn{
  flex:1 1 0;
  width:auto!important;
  max-width:100%;
  box-sizing:border-box;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.btn-row .btn-block{
  display:flex;
  width:auto!important;
}

/* ===== Chat ===== */
.ss-chat-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:50;
  width:56px;
  height:56px;
  border-radius:50%;
  background:linear-gradient(180deg,#fff9e6,#e6c76e);
  color:#191919;
  display:grid;
  place-items:center;
  font-size: 22px;
  font-weight:800;
  box-shadow:0 8px 30px rgba(0,0,0,.35);
  cursor:pointer;
  border:1px solid #e6c76e;
}
.ss-chat-panel{
  position:fixed;
  right:18px;
  bottom:88px;
  z-index:50;
  width:min(460px,92vw);
  display:none;
  flex-direction:column;
  background:#0e1520;
  border:1px solid #243244;
  border-radius:14px;
  box-shadow:var(--shadow);
}
.ss-chat-panel[aria-hidden="false"]{display:flex;}
.ss-chat-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid #243244;
}
.ss-chat-title{font-weight:700}
.ss-chat-body{
  max-height:300px;
  overflow:auto;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.ss-msg{
  padding:8px 10px;
  background:#0f1624;
  border:1px solid #243244;
  border-radius:10px;
  margin:6px 0;
  max-width:80%;
  font-size:.9rem;
  line-height:1.6;
}
.ss-msg.me{
  margin-left:auto;
  background:#132033;
}
.ss-chat-input{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-top:1px solid #243244;
}
.ss-chat-input input{
  flex:1 1 auto;
  min-width:0;
}

/* AI æ–‡æœ¬åŒºåŸŸï¼ˆé¢„ç•™ï¼‰ */
#aiText,#energyText{
  white-space:normal;
  line-height:1.7;
}
#aiText h3.ai-head,#energyText h3.ai-head{
  color:#ffe084;
  font-weight:800;
  font-size:1.05rem;
  margin:14px 0 8px;
}
#aiText ul,#aiText ol,#energyText ul,#energyText ol{
  margin:.2rem 0 .6rem 1.2rem;
  padding-left:1.1rem;
}
#aiText li,#energyText li{margin:.25rem 0;}
#aiText ol li::marker{font-weight:700;}

/* å°å±å¸ƒå±€è°ƒæ•´ */
@media (max-width:768px){
  .board.spread-5{
    grid-template-columns:1fr;
    grid-template-rows:auto;
    grid-template-areas:
      "top"
      "left"
      "center"
      "right"
      "bottom";
    gap:10px;
  }
  .controls{
    flex-direction:column;
  }
  .controls input,
  .controls select,
  .controls button{
    min-width:100%;
  }
}

/* é¡µè„š */
footer{
  color:#6c7b8c;
  font-size:.85rem;
  text-align:center;
  padding:30px 0;
}
</style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner container">
      <a class="brand" href="https://astro.5xliving.com" target="_self" rel="nofollow">
        <span class="brand-badge">5X</span>
        <span class="title">
          <span data-i18n="brand">5xLiving Â· Soul Sanctuary</span>
        </span>
      </a>

      <div class="lang">
        <label for="langSelect" class="muted" data-i18n="lang_label">è¯­è¨€</label>
        <select id="langSelect" aria-label="Language">
          <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
          <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
          <option value="en-US">English</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
          <option value="th-TH">à¹„à¸—à¸¢</option>
          <option value="ms-MY">Bahasa Melayu</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- é¡¶éƒ¨ï¼šå‘½ç†åˆ†æè¡¨å• -->
    <section class="card section">
      <h2 data-i18n="form_title">å‘½ç†åˆ†æ Â· ç”ŸæˆæŠ¥å‘Š</h2>

      <div class="group-title" data-i18n="choose_type">é€‰æ‹©å‘½ç›˜ç±»å‹</div>
      <div class="row row-2">
        <select id="type" name="type" onchange="togglePartner(this.value)">
          <option value="personal" data-i18n="type_personal">ä¸ªäººå‘½ç›˜</option>
          <option value="compatibility" data-i18n="type_compat">åˆç›˜ï¼ˆä¸¤äººèµ„æ–™ï¼‰</option>
        </select>
        <select id="culture" name="culture">
          <option value="auto" data-i18n="culture_auto">è‡ªåŠ¨è¯†åˆ« Auto Detect</option>
          <option value="ä¸œæ–¹" data-i18n="culture_cn">ä¸œæ–¹ Chinese / Bazi</option>
          <option value="è¥¿æ–¹" data-i18n="culture_west">è¥¿æ–¹ Astrology / Tarot</option>
          <option value="æ—¥å¼" data-i18n="culture_jp">æ—¥å¼ä¹æ˜Ÿ Japanese</option>
          <option value="å é™€" data-i18n="culture_vedic">å°åº¦å é™€ Vedic</option>
        </select>
      </div>

      <div class="group-title" data-i18n="self_info">æœ¬äººèµ„æ–™</div>
      <div class="row row-3">
        <input type="text" id="name1" name="name1" placeholder="å§“åï¼ˆæœ¬äººï¼‰" required data-i18n-ph="ph_name1">
        <input type="date" id="birthdate1" name="birthdate1" required>
        <input type="time" id="birthtime1" name="birthtime1" placeholder="å‡ºç”Ÿæ—¶é—´" data-i18n-ph="ph_time1">
      </div>
      <div class="row row-3" style="margin-top:6px">
        <select id="calendar1" name="calendar1">
          <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
          <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
        </select>
        <input type="text" id="country1" name="country1" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" required data-i18n-ph="ph_country1">
      </div>

      <!-- éšå½¢è¡¨å•ç”¨äºæäº¤ -->
      <form id="reportForm" action="/secure/report.html" method="GET" style="display:none"></form>

      <div id="partner-section" style="display:none; margin-top:16px">
        <div class="group-title" data-i18n="partner_info">ç¬¬äºŒäººèµ„æ–™ï¼ˆåˆç›˜ï¼‰</div>
        <div class="row row-3">
          <input type="text" id="name2" name="name2" placeholder="å§“åï¼ˆç¬¬äºŒäººï¼‰" form="reportForm" data-i18n-ph="ph_name2">
          <input type="date" id="birthdate2" name="birthdate2" form="reportForm">
          <input type="time" id="birthtime2" name="birthtime2" placeholder="å‡ºç”Ÿæ—¶é—´" form="reportForm" data-i18n-ph="ph_time2">
        </div>
        <div class="row row-2" style="margin-top:6px">
          <select id="calendar2" name="calendar2" form="reportForm">
            <option value="é˜³å†" data-i18n="cal_g">é˜³å† (Gregorian)</option>
            <option value="å†œå†" data-i18n="cal_l">å†œå† (Lunar)</option>
          </select>
          <input type="text" id="country2" name="country2" placeholder="å‡ºç”Ÿå›½å®¶ / åœ°åŒº" form="reportForm" data-i18n-ph="ph_country2">
        </div>
      </div>

      <div class="group-title" style="margin-top:12px" data-i18n="focus_title">å‘½ç†é€‰é¢˜ï¼ˆæŠ¥å‘Šèšç„¦ï¼‰</div>
      <div class="row">
        <select id="purpose_personal" name="purpose" form="reportForm">
          <optgroup label="å§»ç¼˜ Love" data-i18n="opt_love"></optgroup>
          <option value="æ‹çˆ±ç¼˜åˆ†" data-i18n="opt_dating">æ‹çˆ±ç¼˜åˆ†</option>
          <option value="å©šå§»èµ°åŠ¿" data-i18n="opt_marriage">å©šå§»èµ°åŠ¿</option>

          <optgroup label="äº‹ä¸š Career" data-i18n="opt_career"></optgroup>
          <option value="èŒåœºå‘å±•" data-i18n="opt_work">èŒåœºå‘å±•</option>
          <option value="åˆ›ä¸šæ½œåŠ›" data-i18n="opt_startup">åˆ›ä¸šæ½œåŠ›</option>

          <optgroup label="è´¢è¿ Wealth" data-i18n="opt_wealth"></optgroup>
          <option value="è´¢ä½åˆ†æ" data-i18n="opt_wealthpos">è´¢ä½åˆ†æ</option>
          <option value="ç†è´¢æ—¶æœº" data-i18n="opt_timing">ç†è´¢æ—¶æœº</option>

          <optgroup label="æ‹©æ—¥ Auspicious Date" data-i18n="opt_dates"></optgroup>
          <option value="å©šæœŸæ‹©æ—¥" data-i18n="opt_wedding">å©šæœŸæ‹©æ—¥</option>
          <option value="æ–°ç”Ÿå®å®æ‹©æ—¥" data-i18n="opt_babydate">æ–°ç”Ÿå®å®æ‹©æ—¥</option>
          <option value="æ–°å®¶å…¥ä½æ‹©æ—¥" data-i18n="opt_house">æ–°å®¶å…¥ä½æ‹©æ—¥</option>
          <option value="æ–°å…¬å¸å…¥ä½æ‹©æ—¥" data-i18n="opt_office">æ–°å…¬å¸å…¥ä½æ‹©æ—¥</option>

          <optgroup label="æµ‹å Name Analysis" data-i18n="opt_name"></optgroup>
          <option value="å®å®å" data-i18n="opt_babyname">å®å®å</option>
          <option value="å® ç‰©å" data-i18n="opt_petname">å® ç‰©å</option>
          <option value="å…¬å¸å" data-i18n="opt_companyname">å…¬å¸å</option>
          <option value="å‘½åæ”¹è¿" data-i18n="opt_rename">å‘½åæ”¹è¿</option>

          <optgroup label="é£æ°´ Feng Shui" data-i18n="opt_fs"></optgroup>
          <option value="ä½å®¶" data-i18n="opt_home">ä½å®¶</option>
          <option value="åŠå…¬å®¤" data-i18n="opt_officefs">åŠå…¬å®¤</option>
        </select>

        <select id="purpose_compatibility" name="purpose" style="display:none" form="reportForm">
          <optgroup label="åˆç›˜åˆ†æ Compatibility" data-i18n="opt_comp"></optgroup>
          <option value="ç¼˜åˆ†èµ·è½" data-i18n="opt_couple">æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰</option>
          <option value="å¤«å¦»æµå¹´" data-i18n="opt_spouse">å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰</option>
          <option value="åˆç›˜åˆ†æ" data-i18n="opt_personality">ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰</option>
          <option value="äº‹ä¸šå…±äº‹" data-i18n="opt_partner">äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰</option>
          <option value="æ–­è”ä¿®å¤" data-i18n="opt_reconnect">æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰</option>
          <option value="å® ç‰©ç¼˜åˆ†" data-i18n="opt_petbond">å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰</option>
        </select>
       <button class="btn" id="btnNext" type="button" data-i18n="btn_next">ç”Ÿæˆåˆ†æ</button>
      </div>
    </section>

    <!-- ä¸‹æ®µï¼šå„åŠŸèƒ½å…¥å£ -->
    <section class="card section">
      <h2 data-i18n="portal_title">å¿ƒæ€œç©ºé—´ Â· åŠŸèƒ½å…¥å£</h2>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="diary_title">ğŸ§˜â€â™€ï¸ çµæ€§æ—¥è®°</div>
        <ul><li data-i18n="diary_desc">ç…§ç‰‡ä¸Šä¼  / è¯­éŸ³è®°å½• / çµæ€§ç¬”è®° / å®¶åº­æ—¥å¿— / æ„¿æœ›ç¥ˆç¥·ï¼ˆæ¯æ—¥åŠ æŒï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="personal_memory.html" data-i18n="btn_personal">ä¸ªäººéšè—è®°å½•</a>
          <a class="btn link-btn" href="family_memory.html" data-i18n="btn_family">å®¶åº­å…±äº«è®°å½•</a>
          <a class="btn link-btn" href="memory_upload.html" data-i18n="btn_upload">ä¸Šä¼ è®°å½•</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="course_title">ğŸ“˜ å‘½ç†è¯¾ç¨‹ä¸“åŒº</div>
        <ul>
          <li data-i18n="course_bazi">å…«å­—å‘½ç†ï¼šåç¥ / æµå¹´ / ç”¨ç¥åˆ†æ</li>
          <li data-i18n="course_tarot">å¡”ç½—ç‰Œï¼šç‰Œé˜µè§£è¯» / æƒ…å¢ƒå®æˆ˜</li>
        </ul>
        <div class="muted" style="margin-top:6px" data-i18n="course_coming">
          ğŸŒ™ ä»¥ä¸‹è¯¾ç¨‹é…é…¿ä¸­ï¼šå æ˜Ÿ / çµæ•° / äººç±»å›¾ / å…­çˆ» / å†¥æƒ³å¼•å¯¼ / å¥‡é—¨ / æ—¥å¼ç¥æ˜ / ç´«å¾® / èƒ½é‡å­¦ / è¥¿æ´‹å æ˜Ÿ / å¿ƒçµè¯¾ç¨‹â€¦â€¦
        </div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="soul_integration_course.html" data-i18n="btn_enter_course">è¿›å…¥è¯¾ç¨‹</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="shop_title">ğŸ›ï¸ èƒ½é‡å•†åŸ Â· VIPæŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</div>
        <ul><li data-i18n="shop_desc">ä¸“å±ç¥ˆæ„¿åŒ…åˆ†ç±»ï¼š</li></ul>
        <div class="btns" style="flex-wrap:wrap">
          <a class="btn link-btn" href="é˜´å€ºå’Œè§£åŒ….html">é˜´å€ºå’Œè§£åŒ…</a>
          <a class="btn link-btn" href="è´¢åº“åŒ….html">è´¢åº“åŒ…</a>
          <a class="btn link-btn" href="çµé­‚å¼€æ‚Ÿçš„æŒ‡å¼•åŒ….html">å¿ƒçµåŒ…</a>
          <a class="btn link-btn" href="è´¢è¿åŒ….html">è´¢è¿åŒ…</a>
          <a class="btn link-btn" href="å§»ç¼˜åŒ….html">å§»ç¼˜åŒ…</a>
          <a class="btn link-btn" href="å­¦ä¸šåŒ….html">å­¦ä¸šåŒ…</a>
          <a class="btn link-btn" href="äº‹ä¸šåŒ….html">äº‹ä¸šåŒ…</a>
          <a class="btn link-btn" href="å¾¡å®ˆåŒ….html">å¾¡å®ˆåŒ…</a>
          <a class="btn link-btn" href="å¤ªå²åŒ….html">å¤ªå²åŒ…</a>
          <a class="btn link-btn" href="ä¸ƒæœˆåŒ….html">ä¸ƒæœˆåŒ…</a>
          <a class="btn link-btn" href="å®¶æ—ç¦æŠ¥åŒ….html">å®¶æ—ç¦æŠ¥åŒ…</a>
          <a class="btn link-btn" href="æƒ…ä¼¤ç–—æ„ˆåŒ….html">æƒ…ä¼¤ç–—æ„ˆåŒ…</a>
          <a class="btn link-btn" href="åŠ«éš¾åŒ….html">åŠ«éš¾åŒ…</a>
          <a class="btn link-btn" href="æ–°å®…åŠå…¬å®¤åŒ….html">æ–°å®… / åŠå…¬å®¤åŒ…</a>
        </div>
      </div>

      <div class="list-block" style="margin-bottom:12px">
        <div class="group-title" data-i18n="wish_title">ğŸ”® æ¢¦æƒ³æäº¤ Dream Submission</div>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="wish_submission.html" data-i18n="btn_manifest">æ¢¦æƒ³è§„åˆ’ / Manifestation</a>
        </div>
      </div>

      <div class="list-block">
        <div class="group-title" data-i18n="memorial_title">ğŸ“– çµæ€§ç©ºé—´ ~ å¾€ç”Ÿè®°æ€œå½•</div>
        <ul><li data-i18n="memorial_desc">çµé­‚æ¡£æ¡ˆ / çºªå¿µå›å¿†ï¼ˆå›¾æ–‡éŸ³ï¼‰ / çµæ€§å»¶ç»­ï¼ˆåŠŸå¾·ä¼ æ‰¿ï¼‰</li></ul>
        <div class="btns" style="margin-top:8px">
          <a class="btn link-btn" href="login_memorial.html" data-i18n="btn_login_memorial">ç™»å…¥çµæ€§ç©ºé—´</a>
          <a class="btn link-btn" href="upload_memorial.html" data-i18n="btn_upload_memorial">ä¸Šä¼ å¾€ç”Ÿå½•</a>
          <a class="btn link-btn" href="register_soul_memorial.html" data-i18n="btn_register_memorial">æ³¨å†Œçµæ€§ç©ºé—´</a>
        </div>
      </div>
    </section>

  <!-- ä¼šå‘˜ä¸“åŒºï¼ˆåŸæ ·ä¿ç•™ï¼‰ -->
  <section class="card section">
    <h2 class="group-title" data-i18n="vip_title">ğŸŒ™ ä¼šå‘˜åŒºåŸŸ VIP Segment</h2>
    <div class="columns">
      <div class="list-block">
        <div class="group-title" data-i18n="vip_mingli">ğŸ— å‘½ç†ç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_love">å§»ç¼˜æ–¹å‘ï¼šæ‹çˆ±ç¼˜åˆ†ã€å©šå§»èµ°åŠ¿</li>
          <li data-i18n="vip_career">äº‹ä¸šæ–¹å‘ï¼šèŒåœºå‘å±•ã€åˆ›ä¸šæ½œåŠ›</li>
          <li data-i18n="vip_wealth">è´¢è¿æ–¹å‘ï¼šè´¢ä½åˆ†æã€ç†è´¢æ—¶æœº</li>
          <li data-i18n="vip_pet">å® ç‰©å‘½ç†ï¼šä¼´ä¾£åŠ¨ç‰©çš„æ€§æ ¼ä¸ç¼˜åˆ†</li>
          <li data-i18n="vip_hepan">åˆç›˜åˆ†æï¼šå©šæœŸæ‹©æ—¥ã€æ–°ç”Ÿæ‹©æ—¶</li>
          <li data-i18n="vip_name">æµ‹ååˆ†æï¼šå…¬å¸åã€å®å®åã€å‘½åæ”¹è¿</li>
          <li data-i18n="vip_fengshui">è´¢ä½åˆç›˜ï¼šä½å®¶ / åŠå…¬å®¤åŠ¨çº¿é…åˆ</li>
        </ul>
      </div>
      <div class="list-block">
        <div class="group-title" data-i18n="vip_xinlian">ğŸŒ™ å¿ƒæ€œç©ºé—´ä¸“å±å†…å®¹</div>
        <ul>
          <li data-i18n="vip_record">çµæ€§è®°å½•ï¼šç…§ç‰‡ã€æ¢¦å¢ƒã€å£°éŸ³ã€æ„¿æœ›ç¥ˆç¥·</li>
          <li data-i18n="vip_course">å‘½ç†è¯¾ç¨‹ï¼šå…«å­— / å¡”ç½— / å æ˜Ÿ / çµæ•° / äººç±»å›¾</li>
          <li data-i18n="vip_memorial">å®¶æ—çºªå¿µç³»ç»Ÿï¼šäº²äººçµæ€§çºªå¿µ & å»¶ç»­</li>
          <li data-i18n="vip_tasks">æ¯å‘¨èƒ½é‡ç»ƒä¹  / ç¥æ˜ä»ªå¼ä»»åŠ¡</li>
          <li data-i18n="vip_shop">èƒ½é‡å•†åŸä¸“å±æŠ˜æ‰£ & å¾¡å®ˆè®¢åˆ¶</li>
        </ul>
      </div>
    </div>

    <div class="group-title" style="margin-top:14px" data-i18n="login_title">ğŸ’ ç™»å…¥ VIP åŠŸèƒ½</div>

   <section class="astro-auth">
    <div class="auth-grid">
        <!-- å·¦ä¾§ï¼šè¾“å…¥ + æ³¨å†Œ/ç™»å½• -->
        <div class="panel">
          <div class="head" data-i18n="panel_login_head">è´¦æˆ·ç™»å½• / æ³¨å†Œ</div>
          <div class="body">
            <div class="row" id="authFields">
              <label for="email" class="sr-only" data-i18n="ph_email">é‚®ç®± Email</label>
              <input
                id="email"
                name="email"
                type="email"
                inputmode="email"
                autocomplete="username"
                placeholder=""
                data-i18n-ph="ph_email"
                required
              />
              <label for="password" class="sr-only" data-i18n="ph_label_password">å¯†ç  Password</label>
              <input
                id="password"
                name="password"
                type="password"
                autocomplete="current-password"
                placeholder="å¯†ç  Passwordï¼ˆè‡³å°‘8ä½ï¼Œå«å¤§å°å†™æ•°å­—ç¬¦å·ï¼‰"
                data-i18n-ph="ph_password"
                required
              />
            </div>
            <div class="spacer"></div>
            <form id="loginForm" class="row one">
              <button class="btn block" id="loginBtn" type="submit" data-i18n="btn_login">ç™»å…¥è´¦æˆ·</button>
            </form>
            <div class="spacer"></div>
            <div class="row one">
              <button class="btn ghost block" id="resetBtn" type="button" data-i18n="btn_reset">ğŸ”‘ é‡è®¾å¯†ç </button>
            </div>
            <div class="spacer"></div>
            <form class="row one" id="registerForm">
              <button class="btn block" id="registerBtn" type="submit" data-i18n="btn_register">æ³¨å†Œè´¦æˆ·</button>
              <div class="muted" data-i18n="note_price">æ³¨å†Œè´¦å·èµ é€ä¸€æ¬¡å…è´¹ä½“éªŒ</div>
              <div class="spacer"></div>
              <div class="error-message" id="authError" style="display:none"></div>
            </form>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¼šå‘˜ä¸è¿”å› -->
        <div class="panel">
          <div class="head" data-i18n="panel_member_head">ä¼šå‘˜æœåŠ¡</div>
          <div class="body">
            <div class="row one">
              <a class="btn btn-gold block" href="https://yourshopifyshop.com/products/monthly-vip" target="_blank" rel="noopener noreferrer" data-i18n="btn_upgrade">ğŸ’ å‡çº§ä¸º VIPï¼ˆæœˆè´¹ï¼‰</a>
            </div>
            <div class="spacer"></div>
            <div class="row one">
              <a class="btn ghost block" href="https://yourshopifyshop.myshopify.com" target="_blank" rel="noopener noreferrer" data-i18n="btn_backshop">â† è¿”å›å‘½ç†å•†åŸ</a>
            </div>
            <div class="spacer"></div>
            <div class="muted" data-i18n="note_price1">$9.9 / æœˆè´¹ VIPï¼ˆå‘½ç†ç©ºé—´ + å¿ƒæ€œç©ºé—´ + çµæ€§è¯¾ç¨‹ï¼‰</div>
          </div>
        </div>
      </div>
    </section>
  </section>

  <footer>Â© 5XLiving â€¢ Astro Sanctuary</footer>
</main>
</body>
          
<!-- GPT / å¿ƒæ€œç®¡å®¶ï¼ˆç»Ÿä¸€æµ®çª—ï¼‰ -->
<button class="ss-chat-fab" id="ssChatFab" type="button">
  <span data-i18n="chat_fab">é—®</span>
</button>

<div class="ss-chat-panel" id="chatPanel" aria-hidden="true">
  <div class="ss-chat-head">
    <div class="ss-chat-title" id="chatTitle" data-i18n="chat_title">
      å¿ƒæ€œç®¡å®¶ Â· GPT
    </div>
    <div class="ss-close" id="chatClose">âœ•</div>
  </div>

  <!-- èŠå¤©å†…å®¹åŒºï¼šä¿æŒä¸ºç©ºï¼Œæ¶ˆæ¯å…¨éƒ¨ç”± JS append -->
  <div class="ss-chat-body" id="chatBody"></div>

  <!-- è¾“å…¥åŒº -->
  <div class="ss-chat-input">
    <input
      id="chatInput"
      placeholder="è¾“å…¥é—®é¢˜â€¦"
      data-i18n-ph="chat_input_ph"
    />
    <button class="btn" id="chatSend" data-i18n="chat_send">å‘é€</button>
  </div>
</div>

<script>
// ============================================
// å·¥å…·å‡½æ•°
// ============================================
const $ = id => document.getElementById(id);

function ensureErrorBox(){
  let box = $('error');
  if (!box){
    box = document.createElement('div');
    box.id = 'error';
    box.className = 'error';
    box.style.cssText = 'margin-top:10px;color:#ff8b8b';
    (document.querySelector('.section') || document.body).appendChild(box);
  }
  return box;
}
function showErr(msg){
  const e = ensureErrorBox();
  e.textContent = msg;
  e.style.display = 'block';
  setTimeout(()=>{ e.style.display='none'; }, 5000);
}
function hideErr(){
  const e = $('error');
  if (e){ e.style.display='none'; e.textContent=''; }
}
function setText(id, txt){
  const el=$(id);
  if(el) el.textContent = (txt ?? '');
}
function setBar(el, pct){
  if(!el) return;
  const v=Math.max(0,Math.min(100,Number(pct)||0));
  el.style.width = v+'%';
  el.setAttribute('aria-valuenow', String(Math.round(v)));
}
function pad2(n){ return String(n).padStart(2,'0'); }

// ============================================
// è¯­è¨€ç®¡ç†
// ============================================
const LANG_KEY = "site_lang";
function getLang(){ return localStorage.getItem(LANG_KEY) || document.documentElement.lang || "zh-CN"; }
function setLang(code){ localStorage.setItem(LANG_KEY, code); document.documentElement.lang = code; }
function t(key){
  const lang = getLang();
  const pack = (typeof translations !== 'undefined' && translations[lang]) ? translations[lang]
            : (typeof translations !== 'undefined' && translations["zh-CN"]) ? translations["zh-CN"]
            : null;
  return (pack && pack[key]) ? pack[key] : key;
}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const key = el.getAttribute("data-i18n-ph");
    el.setAttribute("placeholder", t(key));
  });
  const titleEl = document.querySelector("title[data-i18n]");
  if (titleEl) titleEl.textContent = t(titleEl.getAttribute("data-i18n"));
}

// ============================================
// âœ… ç¡®ä¿ç»“æœåŒºåŸŸå­˜åœ¨ï¼ˆä¿®å¤ï¼šrender ä¸å‡ºä»»ä½•ä¸œè¥¿ï¼‰
// ============================================
function ensureResultSection(){
  let result = $('result');
  if (!result){
    result = document.createElement('section');
    result.id = 'result';
    result.className = 'section';
    result.style.display = 'none';
    // æ’åœ¨ main æœ«å°¾ï¼ˆæ‰¾ä¸åˆ° main å°±å¡ bodyï¼‰
    (document.querySelector('main') || document.body).appendChild(result);
  }
  // butler-host
  if (!$('butler-host')){
    const host = document.createElement('div');
    host.id = 'butler-host';
    result.appendChild(host);
  }
  // rich-report
  if (!$('rich-report')){
    const rr = document.createElement('div');
    rr.id = 'rich-report';
    result.appendChild(rr);
  }
  return result;
}

// æ¯æ¬¡ç”Ÿæˆå‰æ¸…æ‰æ—§å†…å®¹ï¼Œé¿å…å ä¸€å †å¡ç‰‡
function clearResultArea(){
  const result = ensureResultSection();
  const err = $('error');

  // ä¿ç•™ error boxï¼ˆå¦‚æœå®ƒåœ¨ result é‡Œé¢ï¼‰
  result.innerHTML = `
    <div id="butler-host"></div>
    <div id="rich-report"></div>
  `;
  // å¦‚æœ error box æ›¾ç» append è¿› resultï¼Œé‡æ–°æŒ‚å›
  if (err && err.parentElement === result){
    result.appendChild(err);
  }
}

// ============================================
// æ–‡åŒ–ç±»å‹åˆ°é€‰é¢˜æ˜ å°„
// ============================================
const culturePurposeMap = {
  'ä¸œæ–¹': {
    personal: ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿', 'èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›', 'è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº', 'å©šæœŸæ‹©æ—¥', 'æ–°ç”Ÿå®å®æ‹©æ—¥', 'æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥', 'å®å®å', 'å® ç‰©å', 'å…¬å¸å', 'å‘½åæ”¹è¿', 'ä½å®¶', 'åŠå…¬å®¤'],
    compatibility: ['æƒ…ä¾£åˆç›˜ï¼ˆç¼˜åˆ†èµ·è½ / æš§æ˜§è¿›å±•ï¼‰', 'å¤«å¦»æµå¹´ï¼ˆå©šå§»å‘å±•ï¼‰', 'ä¸ªæ€§åˆç›˜ï¼ˆå†²çª / äº’è¡¥ï¼‰', 'äº‹ä¸šåˆç›˜ï¼ˆåˆä¼™äºº / å‘˜å·¥ï¼‰', 'æ–­è”ä¿®å¤ï¼ˆæœ‹å‹ / æƒ…äºº / å®¶äººï¼‰', 'å® ç‰©åˆç›˜ï¼ˆä¸»äººä¸å® ç‰©ï¼‰']
  },
  'è¥¿æ–¹': {
    personal: ['çˆ±æƒ…è¿åŠ¿', 'èŒä¸šå‘å±•', 'è´¢å¯Œå¢é•¿', 'å¿ƒçµæˆé•¿', 'å¡”ç½—å åœ', 'æ˜Ÿç›˜è§£è¯»', 'äººé™…å…³ç³»', 'å¥åº·è¿åŠ¿'],
    compatibility: ['å…³ç³»åˆç›˜', 'çµé­‚ä¼´ä¾£', 'åˆä½œè¿åŠ¿', 'å®¶åº­å…³ç³»', 'å‹è°Šåˆ†æ']
  },
  'æ—¥å¼': {
    personal: ['ä¹æ˜Ÿè¿åŠ¿', 'æ–¹ä½å‰å‡¶', 'å§“åé‰´å®š', 'æ‹çˆ±å åœ', 'èŒä¸šæŒ‡å—', 'å¥åº·å»ºè®®', 'å®¶ç›¸è¯Šæ–­'],
    compatibility: ['ç¼˜åˆ†åŒ¹é…', 'ç›¸æ€§è¯Šæ–­', 'åˆä½œç¼˜åˆ†', 'å®¶åº­å’Œè°']
  },
  'å é™€': {
    personal: ['æœ¬å‘½ç›˜', 'äº‹ä¸šæ–¹å‘', 'å©šå§»è¿åŠ¿', 'å¥åº·å»ºè®®', 'æ‹©å‰æ—¥', 'å®çŸ³æ¨è', 'ä»ªå¼å»ºè®®'],
    compatibility: ['å¤«å¦»åˆç›˜', 'åˆä½œåŒ¹é…', 'å®¶åº­åˆç›˜', 'å•†ä¸šä¼™ä¼´']
  }
};

// ============================================
// è¡¨å•åˆ‡æ¢åŠŸèƒ½
// ============================================
function togglePartner(value){
  const section = $('partner-section');
  const personal = $('purpose_personal');
  const compat = $('purpose_compatibility');
  const show = (value === "compatibility");

  if (section) section.style.display = show ? "block" : "none";
  if (personal){
    personal.style.display = show ? "none" : "block";
    personal.disabled = show;
  }
  if (compat){
    compat.style.display = show ? "block": "none";
    compat.disabled = !show;
  }

  updatePurposeOptions($('culture')?.value || 'ä¸œæ–¹');
}

function updatePurposeOptions(culture) {
  const cultureType = culture === 'auto' ? 'ä¸œæ–¹' : culture;
  const type = $('type')?.value || 'personal';
  const config = culturePurposeMap[cultureType] || culturePurposeMap['ä¸œæ–¹'];

  if (type === 'personal') updatePersonalPurposeOptions(config.personal);
  else updateCompatibilityPurposeOptions(config.compatibility);
}

function updatePersonalPurposeOptions(options) {
  const select = $('purpose_personal');
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = '';

  const groups = {
    'å§»ç¼˜ Love': ['æ‹çˆ±ç¼˜åˆ†', 'å©šå§»èµ°åŠ¿'],
    'äº‹ä¸š Career': ['èŒåœºå‘å±•', 'åˆ›ä¸šæ½œåŠ›'],
    'è´¢è¿ Wealth': ['è´¢ä½åˆ†æ', 'ç†è´¢æ—¶æœº'],
    'æ‹©æ—¥ Auspicious Date': ['å©šæœŸæ‹©æ—¥', 'æ–°ç”Ÿå®å®æ‹©æ—¥', 'æ–°å®¶å…¥ä½æ‹©æ—¥', 'æ–°å…¬å¸å…¥ä½æ‹©æ—¥'],
    'æµ‹å Name Analysis': ['å®å®å', 'å® ç‰©å', 'å…¬å¸å', 'å‘½åæ”¹è¿'],
    'é£æ°´ Feng Shui': ['ä½å®¶', 'åŠå…¬å®¤']
  };

  Object.entries(groups).forEach(([label, items]) => {
    const availableItems = items.filter(item => options.includes(item));
    if (availableItems.length > 0) {
      const optgroup = document.createElement('optgroup');
      optgroup.label = label;
      availableItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        optgroup.appendChild(option);
      });
      select.appendChild(optgroup);
    }
  });

  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  }
}

function updateCompatibilityPurposeOptions(options) {
  const select = $('purpose_compatibility');
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = '';

  const optgroup = document.createElement('optgroup');
  optgroup.label = 'åˆç›˜åˆ†æ Compatibility';
  options.forEach(item => {
    const option = document.createElement('option');
    option.value = item;
    option.textContent = item;
    optgroup.appendChild(option);
  });
  select.appendChild(optgroup);

  if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
    select.value = currentValue;
  }
}

// ============================================
// å…«å­—è®¡ç®—å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ============================================
const baziCalculator = {
  heavenlyStems: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
  earthlyBranches: ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'],

  calculateYearPillar: function(year) {
    const stemIndex = (year - 4) % 10;
    const branchIndex = (year - 4) % 12;
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: this.earthlyBranches[branchIndex],
      element: this.getStemElement(this.heavenlyStems[stemIndex])
    };
  },

  calculateMonthPillar: function(year, month, day) {
    const monthMap = {
      1: { stem: 'ä¸™', branch: 'å¯…' }, 2: { stem: 'ä¸', branch: 'å¯' },
      3: { stem: 'æˆŠ', branch: 'è¾°' }, 4: { stem: 'å·±', branch: 'å·³' },
      5: { stem: 'åºš', branch: 'åˆ' }, 6: { stem: 'è¾›', branch: 'æœª' },
      7: { stem: 'å£¬', branch: 'ç”³' }, 8: { stem: 'ç™¸', branch: 'é…‰' },
      9: { stem: 'ç”²', branch: 'æˆŒ' }, 10: { stem: 'ä¹™', branch: 'äº¥' },
      11: { stem: 'ä¸™', branch: 'å­' }, 12: { stem: 'ä¸', branch: 'ä¸‘' }
    };
    const pillar = monthMap[month] || monthMap[1];
    return {
      stem: pillar.stem,
      branch: pillar.branch,
      element: this.getStemElement(pillar.stem)
    };
  },

  calculateDayPillar: function(year, month, day) {
    const date = new Date(year, month - 1, day);
    const startDate = new Date(1900, 0, 1);
    const dayNum = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
    const stemIndex = dayNum % 10;
    const branchIndex = dayNum % 12;
    return {
      stem: this.heavenlyStems[stemIndex],
      branch: this.earthlyBranches[branchIndex],
      element: this.getStemElement(this.heavenlyStems[stemIndex])
    };
  },

  calculateHourPillar: function(dayStem, hour) {
    const hourIndex = Math.floor((hour + 1) / 2) % 12;
    const startStems = { 'ç”²': 'ç”²', 'ä¹™': 'ä¸™', 'ä¸™': 'æˆŠ', 'ä¸': 'åºš', 'æˆŠ': 'å£¬',
                         'å·±': 'ç”²', 'åºš': 'ä¸™', 'è¾›': 'æˆŠ', 'å£¬': 'åºš', 'ç™¸': 'å£¬' };
    const stem = startStems[dayStem] || 'ç”²';
    return {
      stem: stem,
      branch: this.earthlyBranches[hourIndex],
      element: this.getStemElement(stem)
    };
  },

  getStemElement: function(stem) {
    const elementMap = {
      'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«',
      'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘',
      'å£¬': 'æ°´', 'ç™¸': 'æ°´'
    };
    return elementMap[stem] || 'æœ¨';
  },

  getBranchElement: function(branch) {
    const elementMap = {
      'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨',
      'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ',
      'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
    };
    return elementMap[branch] || 'æœ¨';
  },

  calculateBazi: function(year, month, day, hour, timeUnknown) {
    const dayP = this.calculateDayPillar(year, month, day);
    const pillars = {
      year: this.calculateYearPillar(year),
      month: this.calculateMonthPillar(year, month, day),
      day: dayP,
      hour: timeUnknown ? { stem: '?', branch: '?', element: 'æœªçŸ¥' } : this.calculateHourPillar(dayP.stem, hour)
    };

    const elements = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
    Object.values(pillars).forEach(pillar => {
      if (pillar.element && pillar.element !== 'æœªçŸ¥') elements[pillar.element] += 3;
      if (pillar.branch && pillar.branch !== '?') elements[this.getBranchElement(pillar.branch)] += 2;
    });

    const total = Object.values(elements).reduce((a, b) => a + b, 0) || 1;
    const percents = {
      wood: Math.round((elements['æœ¨'] / total) * 100),
      fire: Math.round((elements['ç«'] / total) * 100),
      earth: Math.round((elements['åœŸ'] / total) * 100),
      metal: Math.round((elements['é‡‘'] / total) * 100),
      water: Math.round((elements['æ°´'] / total) * 100)
    };

    return { pillars, percents, timeUnknown };
  }
};

// âœ… Ensure it's global + matches how you call it: (result, focus)
window.generateBaziReport = function generateBaziReport(result, focus) {
  const { pillars = {}, percents = {} } = result || {};
  const focusText = String(focus || 'ç»¼åˆå‘½ç†åˆ†æ');

  // guard: if core data missing, don't crash
  if (!pillars.day || !pillars.day.stem || !pillars.day.branch) {
    return `<p class="muted">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå…«å­—æŠ¥å‘Šï¼ˆç¼ºå°‘æ—¥æŸ±ä¿¡æ¯ï¼‰ã€‚</p>`;
  }

  const dayStem = pillars.day.stem;
  const dayBranch = pillars.day.branch;

  // äº”è¡Œæ’åº
  const elements = [
    { name: 'æœ¨', value: Number(percents.wood || 0) },
    { name: 'ç«', value: Number(percents.fire || 0) },
    { name: 'åœŸ', value: Number(percents.earth || 0) },
    { name: 'é‡‘', value: Number(percents.metal || 0) },
    { name: 'æ°´', value: Number(percents.water || 0) }
  ].sort((a, b) => b.value - a.value);

  const strongest = elements[0] || { name: 'æœ¨', value: 0 };
  const weakest = elements[elements.length - 1] || { name: 'æ°´', value: 0 };

  const dayMasterAnalysis = {
    'ç”²': 'å¦‚å‚å¤©å¤§æ ‘ï¼Œæ­£ç›´ä»å¾·ï¼Œé¢†å¯¼åŠ›å¼ºï¼Œåœ¨å›¢é˜Ÿä¸­å¸¸æ‰®æ¼”æ”¯æŸ±è§’è‰²ã€‚',
    'ä¹™': 'å¦‚è—¤è”“èŠ±è‰ï¼ŒæŸ”éŸ§é€‚åº”ï¼Œå–„äºåˆä½œï¼Œäººé™…å…³ç³»å’Œè°é¡ºç•…ã€‚',
    'ä¸™': 'å¦‚å¤ªé˜³ä¹‹ç«ï¼Œçƒ­æƒ…å¼€æœ—ï¼Œæ„ŸæŸ“åŠ›å¼ºï¼Œå¤©ç”Ÿå…·æœ‰å¸å¼•åŠ›ã€‚',
    'ä¸': 'å¦‚ç¯çƒ›ä¹‹ç«ï¼Œç»†è…»èªæ…§ï¼Œè§‚å¯Ÿå…¥å¾®ï¼Œå¿ƒæ€ç¼œå¯†æœ‰è°‹ç•¥ã€‚',
    'æˆŠ': 'å¦‚åŸå¢™ä¹‹åœŸï¼Œç¨³é‡è¯šä¿¡ï¼Œè´£ä»»å¿ƒå¼ºï¼Œå€¼å¾—ä¿¡èµ–çš„ä¼™ä¼´ã€‚',
    'å·±': 'å¦‚ç”°å›­ä¹‹åœŸï¼ŒåŒ…å®¹æ»‹å…»ï¼Œå–„äºåè°ƒï¼Œå…·æœ‰è°ƒè§£æ‰èƒ½ã€‚',
    'åºš': 'å¦‚åˆ€å‰‘ä¹‹é‡‘ï¼Œåˆšæ¯…æœæ–­ï¼ŒåŸåˆ™æ€§å¼ºï¼Œæ‰§è¡ŒåŠ›å“è¶Šã€‚',
    'è¾›': 'å¦‚ç å®ä¹‹é‡‘ï¼Œç²¾è‡´æ•é”ï¼Œè¿½æ±‚å®Œç¾ï¼Œæ³¨é‡ç»†èŠ‚å“è´¨ã€‚',
    'å£¬': 'å¦‚æ±Ÿæ²³ä¹‹æ°´ï¼Œæ™ºæ…§æµåŠ¨ï¼Œé€‚åº”åŠ›å¼ºï¼Œæ€ç»´çµæ´»å¤šå˜ã€‚',
    'ç™¸': 'å¦‚é›¨éœ²ä¹‹æ°´ï¼Œç»†è…»æ•æ„Ÿï¼Œç›´è§‰åŠ›å¼ºï¼Œæƒ…æ„Ÿä¸°å¯Œæ·±åˆ»ã€‚'
  };

  const dayMasterDesc = dayMasterAnalysis[dayStem] || 'å…·æœ‰ç‹¬ç‰¹çš„å‘½ç†ç‰¹è´¨å’Œæ½œèƒ½ã€‚';

  // âœ… focus routing uses focusText (string), not undefined focus
  let focusAnalysis = '';
  if (focusText.includes('æ‹çˆ±') || focusText.includes('å§»ç¼˜') || focusText.includes('çˆ±æƒ…')) {
    focusAnalysis = (typeof generateLoveAnalysis === 'function')
      ? generateLoveAnalysis(dayStem, strongest, dayBranch)
      : `<h4>å§»ç¼˜çˆ±æƒ…</h4><p>ï¼ˆlove åˆ†æå‡½æ•°æœªåŠ è½½ï¼‰</p>`;
  } else if (focusText.includes('äº‹ä¸š') || focusText.includes('èŒåœº') || focusText.includes('åˆ›ä¸š') || focusText.includes('èŒä¸š')) {
    focusAnalysis = (typeof generateCareerAnalysis === 'function')
      ? generateCareerAnalysis(dayStem, strongest, pillars.month?.branch)
      : `<h4>äº‹ä¸šæ–¹å‘</h4><p>ï¼ˆcareer åˆ†æå‡½æ•°æœªåŠ è½½ï¼‰</p>`;
  } else if (focusText.includes('è´¢è¿') || focusText.includes('è´¢å¯Œ') || focusText.includes('ç†è´¢')) {
    focusAnalysis = (typeof generateWealthAnalysis === 'function')
      ? generateWealthAnalysis(dayStem, strongest, pillars.year?.stem)
      : `<h4>è´¢å¯Œæ ¼å±€</h4><p>ï¼ˆwealth åˆ†æå‡½æ•°æœªåŠ è½½ï¼‰</p>`;
  } else if (focusText.includes('é£æ°´') || focusText.includes('ä½å®¶') || focusText.includes('åŠå…¬å®¤')) {
    focusAnalysis = (typeof generateFengShuiAnalysis === 'function')
      ? generateFengShuiAnalysis(dayStem, pillars)
      : `<h4>é£æ°´å¸ƒå±€</h4><p>ï¼ˆfengshui åˆ†æå‡½æ•°æœªåŠ è½½ï¼‰</p>`;
  } else {
    focusAnalysis = (typeof generateGeneralAnalysis === 'function')
      ? generateGeneralAnalysis(dayStem, strongest, weakest)
      : `<h4>ç»¼åˆå»ºè®®</h4><p>å‘æŒ¥${strongest.name}ä¼˜åŠ¿ï¼Œè¡¥å¼º${weakest.name}ä¸è¶³ã€‚</p>`;
  }

  // recent fortune + quote (guarded)
  const recent = (typeof getRecentFortune === 'function') ? getRecentFortune(dayStem, pillars.month?.branch) : 'è¿‘æœŸè¿åŠ¿å¹³ç¨³ï¼Œé€‚åˆè§„åˆ’æœªæ¥å‘å±•æ–¹å‘ã€‚';
  const quote  = (typeof getInspirationalQuote === 'function') ? getInspirationalQuote(dayStem) : 'å‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œæ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚';
  const balanceAdvice = (typeof getElementBalanceAdvice === 'function')
    ? getElementBalanceAdvice(strongest.name, weakest.name)
    : 'äº”è¡Œéœ€è¦å¹³è¡¡è°ƒå’Œï¼Œæ‰¬é•¿é¿çŸ­å‘æŒ¥ä¼˜åŠ¿ã€‚';

  return `
    <h4>å‘½ç†æ ¸å¿ƒåˆ†æ</h4>
    <p><strong>æ—¥ä¸»ç‰¹è´¨ï¼š</strong>æ‚¨çš„æ—¥æŸ±ä¸º <span style="color: var(--gold2); font-weight: 600">${dayStem}${dayBranch}</span>ï¼Œä»£è¡¨æ‚¨è‡ªèº«çš„æ ¸å¿ƒèƒ½é‡ã€‚${dayMasterDesc}</p>

    <p><strong>äº”è¡Œå¹³è¡¡ï¼š</strong>å‘½ç›˜ä¸­ï¼Œ<span style="color: #7bc47f">${strongest.name}å…ƒç´ ï¼ˆ${strongest.value}%ï¼‰</span>æœ€ä¸ºæ—ºç››ï¼Œ
    <span style="color: #ff8b8b">${weakest.name}å…ƒç´ ï¼ˆ${weakest.value}%ï¼‰</span>ç›¸å¯¹è¾ƒå¼±ã€‚${balanceAdvice}</p>

    ${focusAnalysis}

    <h4>è¿‘æœŸè¿åŠ¿æé†’</h4>
    <p>${recent}</p>

    <div style="margin-top: 20px; padding: 15px; background: rgba(212, 175, 55, 0.08); border-radius: 10px; border-left: 3px solid var(--gold);">
      <strong style="color: var(--gold2);">å¿ƒçµå¯„è¯­ï¼š</strong>
      <p style="margin-top: 5px; font-style: italic;">"${quote}"</p>
    </div>
  `;
};
  
// ============================================
// å…¶ä»–æ–‡åŒ–è®¡ç®—å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ============================================
const calculators = {
  'ä¸œæ–¹': {
    name: 'å…«å­—å‘½ç†',
    calculate: (year, month, day, hour, timeUnknown) => baziCalculator.calculateBazi(year, month, day, hour, timeUnknown),
    render: renderBaziReport,
    analysis: generateBaziReport
  },
  'è¥¿æ–¹': {
    name: 'è¥¿æ´‹å æ˜Ÿ',
    calculate: (year, month, day, hour, timeUnknown) => {
      const zodiacSigns = ['æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§','ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§','å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§'];
      const signIndex = (month - 1) % 12;
      return {
        zodiac: zodiacSigns[signIndex],
        rising: timeUnknown ? 'æœªçŸ¥' : ['ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§','å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§'][hour % 12],
        moon: ['å·¨èŸ¹åº§','ç‹®å­åº§','å¤„å¥³åº§','å¤©ç§¤åº§','å¤©èåº§','å°„æ‰‹åº§','æ‘©ç¾¯åº§','æ°´ç“¶åº§','åŒé±¼åº§','ç™½ç¾Šåº§','é‡‘ç‰›åº§','åŒå­åº§'][day % 12],
        elements: { fire: 30, earth: 25, air: 25, water: 20 }
      };
    },
    render: renderWesternReport,
    analysis: generateWesternReport
  },
  'æ—¥å¼': {
    name: 'ä¹æ˜Ÿæ°—å­¦',
    calculate: (year, month, day, hour, timeUnknown) => {
      const numbers = ['ä¸€ç™½æ°´æ˜Ÿ','äºŒé»’åœŸæ˜Ÿ','ä¸‰ç¢§æœ¨æ˜Ÿ','å››ç·‘æœ¨æ˜Ÿ','äº”é»„åœŸæ˜Ÿ','å…­ç™½é‡‘æ˜Ÿ','ä¸ƒèµ¤é‡‘æ˜Ÿ','å…«ç™½åœŸæ˜Ÿ','ä¹ç´«ç«æ˜Ÿ'];
      const starIndex = (year + month + day) % 9;
      return {
        number: numbers[starIndex],
        element: ['æ°´','åœŸ','æœ¨','æœ¨','åœŸ','é‡‘','é‡‘','åœŸ','ç«'][starIndex],
        direction: ['åŒ—','è¥¿å—','æ±','æ±å—','ä¸­å¤®','è¥¿åŒ—','è¥¿','æ±åŒ—','å—'][starIndex],
        luck: ['å‰','å‡¶','å‰','å‰','å‡¶','å‰','å‰','å‰','å‰'][starIndex]
      };
    },
    render: renderJapaneseReport,
    analysis: generateJapaneseReport
  },
  'å é™€': {
    name: 'å°åº¦å é™€',
    calculate: (year, month, day, hour, timeUnknown) => {
      const rashis = ['Mesha','Vrishabha','Mithuna','Karka','Simha','Kanya','Tula','Vrishchika','Dhanu','Makara','Kumbha','Meena'];
      const rashiIndex = (month - 1) % 12;
      return {
        rashi: rashis[rashiIndex],
        nakshatra: ['Ashwini','Bharani','Krittika','Rohini','Mrigashira','Ardra','Punarvasu','Pushya','Ashlesha','Magha','Purva Phalguni','Uttara Phalguni'][day % 12],
        element: ['ç«','åœŸ','é¢¨','æ°´','ç«','åœŸ','é¢¨','æ°´','ç«','åœŸ','é¢¨','æ°´'][rashiIndex]
      };
    },
    render: renderVedicReport,
    analysis: generateVedicReport
  }
};

// ============================================
// æŠ¥å‘Šæ¸²æŸ“å‡½æ•°
// ============================================
function ensureResultHost(){
  const result = ensureResultSection();

  if (!document.getElementById('xl-free-report')){
    const free = document.createElement('div');
    free.id = 'xl-free-report';
    free.innerHTML = `
      <div class="card" style="margin-top:8px">
        <div class="h2">å‘½ç†ç®€æŠ¥</div>
        <div id="bazi-date" class="sub" style="margin-bottom:8px"></div>
        <div id="bazi-pillars" class="pillars"></div>

        <div class="row cols-5" style="align-items:center;margin-top:10px">
          <div><div>æœ¨</div><div class="bar"><i id="bar-æœ¨"></i></div><div id="pct-æœ¨" class="muted" style="margin-top:4px"></div></div>
          <div><div>ç«</div><div class="bar"><i id="bar-ç«"></i></div><div id="pct-ç«" class="muted" style="margin-top:4px"></div></div>
          <div><div>åœŸ</div><div class="bar"><i id="bar-åœŸ"></i></div><div id="pct-åœŸ" class="muted" style="margin-top:4px"></div></div>
          <div><div>é‡‘</div><div class="bar"><i id="bar-é‡‘"></i></div><div id="pct-é‡‘" class="muted" style="margin-top:4px"></div></div>
          <div><div>æ°´</div><div class="bar"><i id="bar-æ°´"></i></div><div id="pct-æ°´" class="muted" style="margin-top:4px"></div></div>
        </div>

        <div id="bazi-elements-balance" class="sub" style="margin-top:8px"></div>
      </div>
    `;
    result.appendChild(free);
  }
  return result;
}

// å…«å­—æŠ¥å‘Šæ¸²æŸ“
function renderBaziReport(result, info) {
  const { pillars, percents, timeUnknown } = result;
  const { year, month, day, hour } = info;

  const res = ensureResultHost();
  res.style.display = 'block';

  // æ¸²æŸ“å…«å­—ä¿¡æ¯
  const timeText = timeUnknown ? 'æ—¶é—´ä¸è¯¦' : `${pad2(hour)}æ—¶`;
  setText('bazi-date', `å‡ºç”Ÿæ—¥æœŸ: ${year}å¹´${month}æœˆ${day}æ—¥ ${timeText}`);
  renderPillars($('bazi-pillars'), pillars, timeUnknown);

  // æ¸²æŸ“äº”è¡Œç™¾åˆ†æ¯”
  setBar($('bar-æœ¨'), percents.wood); setText('pct-æœ¨', Math.round(percents.wood) + '%');
  setBar($('bar-ç«'), percents.fire); setText('pct-ç«', Math.round(percents.fire) + '%');
  setBar($('bar-åœŸ'), percents.earth); setText('pct-åœŸ', Math.round(percents.earth) + '%');
  setBar($('bar-é‡‘'), percents.metal); setText('pct-é‡‘', Math.round(percents.metal) + '%');
  setBar($('bar-æ°´'), percents.water); setText('pct-æ°´', Math.round(percents.water) + '%');

  const elements = [
    { name: 'æœ¨', value: percents.wood },
    { name: 'ç«', value: percents.fire },
    { name: 'åœŸ', value: percents.earth },
    { name: 'é‡‘', value: percents.metal },
    { name: 'æ°´', value: percents.water }
  ].sort((a, b) => b.value - a.value);

  setText('bazi-elements-balance', `å…ƒç´ å¹³è¡¡ï¼š${elements[0].name}åå¼º (${elements[0].value}%) Â· ${elements[4].name}åå¼± (${elements[4].value}%)`);
}

function renderPillars(root, p, timeUnknown=false){
  if(!root) return;
  root.innerHTML='';
  [['å¹´æŸ±',p.year], ['æœˆæŸ±',p.month], ['æ—¥æŸ±',p.day], ['æ—¶æŸ±',p.hour]].forEach(([tit,v])=>{
    const isUnknown = (tit==='æ—¶æŸ±' && timeUnknown);
    const stem = isUnknown ? 'ï¼Ÿ' : v.stem;
    const branch = isUnknown ? 'ï¼Ÿ' : v.branch;

    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <div class="tit">${tit}</div>
      <div class="gz">${stem}${branch}</div>
      ${v.element && v.element !== 'æœªçŸ¥' ? `<div style="color:#98a7b7;font-size:.75rem;margin-top:4px">${v.element}</div>` : ''}
    `;
    root.appendChild(div);
  });
}

// è¥¿æ–¹å æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderWesternReport(result, info) {
  const res = ensureResultSection();
  res.style.display = 'block';
  const host = $('butler-host') || res;

  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>è¥¿æ´‹å æ˜ŸæŠ¥å‘Š</h3>
    <p><strong>å¤ªé˜³æ˜Ÿåº§ï¼š</strong>${result.zodiac}</p>
    <p><strong>ä¸Šå‡æ˜Ÿåº§ï¼š</strong>${result.rising}</p>
    <p><strong>æœˆäº®æ˜Ÿåº§ï¼š</strong>${result.moon}</p>
    <div class="row cols-4" style="margin-top:15px">
      <div><div>ç«å…ƒç´ </div><div class="bar"><i style="width:${result.elements.fire}%"></i></div><div class="muted">${result.elements.fire}%</div></div>
      <div><div>åœŸå…ƒç´ </div><div class="bar"><i style="width:${result.elements.earth}%"></i></div><div class="muted">${result.elements.earth}%</div></div>
      <div><div>é£å…ƒç´ </div><div class="bar"><i style="width:${result.elements.air}%"></i></div><div class="muted">${result.elements.air}%</div></div>
      <div><div>æ°´å…ƒç´ </div><div class="bar"><i style="width:${result.elements.water}%"></i></div><div class="muted">${result.elements.water}%</div></div>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// æ—¥å¼ä¹æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderJapaneseReport(result, info) {
  const res = ensureResultSection();
  res.style.display = 'block';
  const host = $('butler-host') || res;

  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>æ—¥å¼ä¹æ˜ŸæŠ¥å‘Š</h3>
    <div style="text-align:center;padding:20px">
      <div style="font-size:2.5rem;color:var(--gold2);font-weight:800">${result.number}</div>
      <div style="margin-top:10px">
        <span class="chip">${result.element}å…ƒç´ </span>
        <span class="chip">${result.direction}æ–¹ä½</span>
        <span class="chip">${result.luck}é‹</span>
      </div>
      <p style="margin-top:15px">æœ¬å‘½æ˜Ÿå½±å“æ‚¨çš„æ€§æ ¼ç‰¹è´¨å’Œè¿åŠ¿èµ°å‘</p>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// å é™€å æ˜ŸæŠ¥å‘Šæ¸²æŸ“
function renderVedicReport(result, info) {
  const res = ensureResultSection();
  res.style.display = 'block';
  const host = $('butler-host') || res;

  const report = document.createElement('div');
  report.className = 'card';
  report.innerHTML = `
    <h3>å°åº¦å é™€æŠ¥å‘Š</h3>
    <p><strong>æœ¬å‘½æ˜Ÿåº§ (Rashi)ï¼š</strong>${result.rashi}</p>
    <p><strong>æœˆå®¿ (Nakshatra)ï¼š</strong>${result.nakshatra}</p>
    <p><strong>ä¸»å¯¼å…ƒç´ ï¼š</strong>${result.element}</p>
    <div style="margin-top:15px;padding:15px;background:rgba(212,175,55,0.1);border-radius:10px">
      <p><small>æ ¹æ®å é™€å æ˜Ÿå­¦ï¼Œæ‚¨çš„å‘½ç›˜æ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„èƒ½é‡ç‰¹è´¨ã€‚</small></p>
    </div>
  `;
  host.insertBefore(report, host.firstChild);
}

// ============================================
// æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼ˆä¿æŒä½ åŸæœ¬é€»è¾‘ï¼‰
// ============================================
// ï¼ˆä½ è¿™é‡Œ generateBaziReport / å…¶å®ƒ generate... æˆ‘ä¿ç•™ä½ åŸæœ¬çš„å®šä¹‰ï¼Œä¸æ”¹åŠ¨ï¼‰
// ä½ åŸæœ¬çš„ generateBaziReport/è¾…åŠ©å‡½æ•°ä»¬ â€”â€” ç»§ç»­æ”¾åœ¨è¿™é‡Œå³å¯ï¼ˆå†…å®¹ä¸å˜ï¼‰
/* === ä½ ç²˜è´´çš„ generateBaziReport... ç­‰å‡½æ•°ä¿æŒåŸæ · === */

// ============================================
// å¿ƒæ€œç®¡å®¶å¡ç‰‡ï¼ˆä¿æŒä½ åŸæœ¬é€»è¾‘ï¼‰
// ============================================
function mountButlerCard({ data, culture, focusArea, type = 'personal' }) {
  ensureResultSection();
  const host = $('butler-host') || $('result');

  const existingCard = host.querySelector('#aiCard');
  if (existingCard) existingCard.remove();

  let reportContent = '';
  const calculator = calculators[culture] || calculators['ä¸œæ–¹'];

  if (type === 'personal') {
    reportContent = calculator.analysis ? calculator.analysis(data, focusArea) : `<p>${culture}å‘½ç†åˆ†ææ­£åœ¨ç”Ÿæˆä¸­...</p>`;
  } else {
    reportContent = generateCompatibilityReport(data, culture, focusArea);
  }

  const card = document.createElement('div');
  card.id = 'aiCard';
  card.className = 'sec';

  card.innerHTML = `
    <h3 id="butlerTitle">${t('butler_title') || 'å¿ƒæ€œç®¡å®¶ Â· ä¸“å±æŠ¥å‘Š'}</h3>
    <div class="focus-badge" style="display:inline-block;padding:6px 12px;background:rgba(212,175,55,0.15);border:1px solid var(--gold);border-radius:20px;color:var(--gold2);font-size:0.9rem;margin-bottom:15px;">
      åˆ†æé‡ç‚¹ï¼š${focusArea} Â· ${calculator.name}
    </div>
    <div class="chips" id="butlerChips"></div>
    <div class="ai-content">${reportContent}</div>
    <div class="ai-lock-overlay">
      <div class="tip">ğŸ’ VIP è§£é”å®Œæ•´æ·±åº¦åˆ†æ</div>
      <div class="sub">ç™»å½•åå¯è·å–è¯¦ç»†æµå¹´è¿åŠ¿ã€å…·ä½“å»ºè®®å’Œæ¯æ—¥ç»ƒä¹ å¡ã€‚</div>
      <button class="btn ghost sm" style="margin-top:10px;" onclick="showLogin()" data-i18n="btn_upgrade_now">ç«‹å³å‡çº§</button>
    </div>
  `;
  host.insertBefore(card, host.firstChild);

  renderChips(focusArea, culture, type);
}

// ä½ åŸæœ¬ renderChips / generateCompatibilityReport / getCompatibility... ä¿æŒä¸åŠ¨
/* === ä½ ç²˜è´´çš„ renderChips / generateCompatibilityReport / getCompatibilityPattern... ç­‰å‡½æ•°ä¿æŒåŸæ · === */

// ============================================
// ç”Ÿæˆå‘½ç›˜ä¸»å‡½æ•°ï¼ˆä¿®å¤ï¼šç¡®ä¿ result å­˜åœ¨ + æ¸…ç©ºæ—§å†…å®¹ + ä¿®æ­£ #id ç”¨æ³•ï¼‰
// ============================================
async function genChart(){
  const get = id => $(id)?.value?.trim() || '';

  const bd1 = get('birthdate1');
  const bt1 = get('birthtime1');

  if (!bd1){ showErr('è¯·å¡«å†™æœ¬äººå‡ºç”Ÿæ—¥æœŸ'); return; }

  const [Y,M,D] = bd1.split('-').map(Number);
  const hour = bt1 ? parseInt(bt1.split(':')[0],10) : 12;
  const timeUnknown = $('timeUnknown')?.checked || false;   // âœ… ä¿®æ­£ï¼šä¸å†ç”¨ '#'

  const culture = ($('culture')?.value === 'auto') ? 'ä¸œæ–¹' : ($('culture')?.value || 'ä¸œæ–¹');
  const type = $('type')?.value || 'personal';

  const nextBtn = $('btnNext');
  if (nextBtn){ nextBtn.disabled = true; nextBtn.textContent = 'ç”Ÿæˆä¸­...'; }

  try{
    hideErr();
    clearResultArea();                 // âœ… æ¯æ¬¡ç”Ÿæˆå…ˆæ¸…ç©º
    const res = ensureResultSection(); // âœ… ç¡®ä¿ result å­˜åœ¨
    res.style.display = 'block';

    const calculator = calculators[culture] || calculators['ä¸œæ–¹'];

    if (type === 'personal') {
      const result = await calculator.calculate(Y, M, D, hour, timeUnknown);

      const purposeSelect = $('purpose_personal');
      const focusText = purposeSelect?.options[purposeSelect.selectedIndex]?.text || 'ç»¼åˆå‘½ç†åˆ†æ';

      calculator.render(result, { year: Y, month: M, day: D, hour, timeUnknown });

      mountButlerCard({
        data: result,
        culture,
        focusArea: focusText,
        type: 'personal'
      });

    } else if (type === 'compatibility') {
      const bd2 = get('birthdate2');
      if (!bd2) { showErr('è¯·å¡«å†™ç¬¬äºŒäººå‡ºç”Ÿæ—¥æœŸ'); return; }

      const [Y2, M2, D2] = bd2.split('-').map(Number);
      const hour2 = get('birthtime2') ? parseInt(get('birthtime2').split(':')[0],10) : 12;
      const timeUnknown2 = $('timeUnknown2')?.checked || false; // âœ… ä¿®æ­£

      const result1 = await calculator.calculate(Y, M, D, hour, timeUnknown);
      const result2 = await calculator.calculate(Y2, M2, D2, hour2, timeUnknown2);

      const compatibility = {
        score: calculateCompatibilityScore(result1, result2, culture),
        summary: getCompatibilitySummary(result1, result2, culture)
      };

      renderCompatibilityReport(result1, result2, compatibility, culture);

      const purposeSelect = $('purpose_compatibility');
      const focusText = purposeSelect?.options[purposeSelect.selectedIndex]?.text || 'åˆç›˜åˆ†æ';

      mountButlerCard({
        data: { person1: result1, person2: result2, compatibility },
        culture,
        focusArea: focusText,
        type: 'compatibility'
      });
    }

  } catch (err){
    console.error(err);
    showErr('è®¡ç®—å‘½ç›˜æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
  } finally {
    if (nextBtn){ nextBtn.disabled = false; nextBtn.textContent = t('btn_next') || 'ç”Ÿæˆåˆ†æ'; }
    $('result')?.scrollIntoView({ behavior:'smooth', block:'start' });
  }
}

// ä½ åŸæœ¬ calculateCompatibilityScore / getCompatibilitySummary / renderCompatibilityReport / getCompatibilityLevel ä¿æŒåŸæ ·
/* === ä½ ç²˜è´´çš„ calculateCompatibilityScore / getCompatibilitySummary / renderCompatibilityReport / getCompatibilityLevel ä¿æŒåŸæ · === */

// ============================================
// ä¼šå‘˜çŠ¶æ€ç®¡ç†ï¼ˆä½ åŸæœ¬é€»è¾‘ä¿æŒï¼‰
// ============================================
let memberStatus = { isLoggedIn:false, name:'', expiry:null, daysLeft:0 };

function checkLoginStatus() {
  const stored = localStorage.getItem('member_data');
  if (stored) {
    try {
      const data = JSON.parse(stored);
      memberStatus = { ...memberStatus, ...data, isLoggedIn: true };
      showMemberStatus();
    } catch (e) {
      console.error('è§£æä¼šå‘˜æ•°æ®å¤±è´¥:', e);
    }
  }
}

function showMemberStatus() {
  const statusEl = $('memberStatus');
  const welcomeEl = $('memberWelcome');
  const expiryEl = $('memberExpiry');

  if (memberStatus.isLoggedIn && statusEl && welcomeEl && expiryEl) {
    statusEl.style.display = 'block';
    welcomeEl.textContent = `æ¬¢è¿å›æ¥ï¼Œ${memberStatus.name || 'å°Šè´µä¼šå‘˜'}ï¼`;
    expiryEl.textContent = memberStatus.daysLeft > 0 ? `VIP æœ‰æ•ˆæœŸï¼šè¿˜æœ‰ ${memberStatus.daysLeft} å¤©` : 'VIP ä¼šå‘˜èº«ä»½æœ‰æ•ˆ';

    const authGrid = document.querySelector('.auth-grid');
    if (authGrid) authGrid.style.display = 'none';
  }
}

function showLogin() {
  document.querySelector('.astro-auth')?.scrollIntoView({ behavior: 'smooth' });
  const authGrid = document.querySelector('.auth-grid');
  if (authGrid) {
    authGrid.style.display = 'grid';
    if ($('memberStatus')) $('memberStatus').style.display = 'none';
  }
}

function setupLogout() {
  const logoutBtn = $('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
      localStorage.removeItem('member_data');
      memberStatus = { isLoggedIn: false, name: '', expiry: null, daysLeft: 0 };
      if ($('memberStatus')) $('memberStatus').style.display = 'none';
      const grid = document.querySelector('.auth-grid');
      if (grid) grid.style.display = 'grid';
      alert('å·²æˆåŠŸç™»å‡º');
    });
  }
}

// ============================================
// å¯ŒæŠ¥å‘Šå‡½æ•°ï¼ˆå¯é€‰ï¼‰
// ============================================
function mountRichReport({ pillars, percents }) {
  let host = $('rich-report');
  if (!host) host = ensureResultSection().querySelector('#rich-report');

  host.innerHTML = `
    <div class="sec">
      <h3>å…«å­—è¯¦ç»†åˆ†æ</h3>
      <p>æ‚¨çš„å…«å­—ç»„åˆæ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„å‘½ç†ç‰¹å¾ï¼š</p>
      <ul>
        <li>å¹´æŸ± ${pillars.year.stem}${pillars.year.branch} - ä»£è¡¨ç¥–ä¸Šæ ¹åŸºå’Œæ—©å¹´è¿åŠ¿</li>
        <li>æœˆæŸ± ${pillars.month.stem}${pillars.month.branch} - ä»£è¡¨çˆ¶æ¯å®«å’Œé’å¹´è¿åŠ¿</li>
        <li>æ—¥æŸ± ${pillars.day.stem}${pillars.day.branch} - ä»£è¡¨è‡ªèº«å’Œé…å¶</li>
        <li>æ—¶æŸ± ${pillars.hour.stem}${pillars.hour.branch} - ä»£è¡¨å­å¥³å’Œæ™šå¹´è¿åŠ¿</li>
      </ul>
    </div>
  `;
}

// ============================================
// âœ… é»˜è®¤å¡«å½“å‰æ—¥æœŸ/æ—¶é—´ï¼ˆä½ è¦çš„ï¼‰
// ============================================
function setDefaultNow(){
  const now = new Date();
  const y = now.getFullYear();
  const m = pad2(now.getMonth() + 1);
  const d = pad2(now.getDate());
  const hh = pad2(now.getHours());
  const mm = pad2(now.getMinutes());

  const bd1 = $('birthdate1');
  const bt1 = $('birthtime1');
  if (bd1 && !bd1.value) bd1.value = `${y}-${m}-${d}`;
  if (bt1 && !bt1.value) bt1.value = `${hh}:${mm}`;

  // ç¬¬äºŒäººä¹Ÿé¡ºæ‰‹è¡¥ï¼ˆå¦‚æœä½ ä¸æƒ³å¯åˆ æ‰ï¼‰
  const bd2 = $('birthdate2');
  const bt2 = $('birthtime2');
  if (bd2 && !bd2.value) bd2.value = `${y}-${m}-${d}`;
  if (bt2 && !bt2.value) bt2.value = `${hh}:${mm}`;
}

// ============================================
// åˆå§‹åŒ–
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  // âœ… å…ˆç¡®ä¿ result å­˜åœ¨
  ensureResultSection();

  // âœ… é»˜è®¤å¡«å½“å‰æ—¥æœŸ/æ—¶é—´
  setDefaultNow();

  // è¯­è¨€åˆå§‹åŒ–
  const select = $('langSelect');
  const current = getLang();
  if (select) {
    select.value = current;
    select.addEventListener('change', () => {
      setLang(select.value);
      applyI18n();
    });
  }
  applyI18n();

  // ç±»å‹åˆ‡æ¢
  const typeSel = $('type');
  if (typeSel){
    togglePartner(typeSel.value);
    typeSel.addEventListener('change', e => togglePartner(e.target.value));
  }

  // æ–‡åŒ–ç±»å‹æ”¹å˜æ—¶æ›´æ–°é€‰é¢˜
  const cultureSelect = $('culture');
  if (cultureSelect) {
    cultureSelect.addEventListener('change', function() {
      const culture = this.value === 'auto' ? 'ä¸œæ–¹' : this.value;
      updatePurposeOptions(culture);
    });
  }

  // ç”Ÿæˆåˆ†ææŒ‰é’®
  const nextBtn = $('btnNext');
  if (nextBtn){
    nextBtn.addEventListener('click', (e) => {
      e.preventDefault();
      hideErr();
      genChart();
    });
  }

  // æ—¶é—´ä¸è¯¦å¤„ç†ï¼ˆâœ… ä¿®æ­£ï¼šä¸ä½¿ç”¨ '#id'ï¼‰
  const timeUnknown = $('timeUnknown');
  const birthtime1 = $('birthtime1');
  if (timeUnknown && birthtime1) {
    timeUnknown.addEventListener('change', function() {
      birthtime1.disabled = this.checked;
      if (this.checked) birthtime1.value = '';
    });
  }

  const timeUnknown2 = $('timeUnknown2');
  const birthtime2 = $('birthtime2');
  if (timeUnknown2 && birthtime2) {
    timeUnknown2.addEventListener('change', function() {
      birthtime2.disabled = this.checked;
      if (this.checked) birthtime2.value = '';
    });
  }

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLoginStatus();
  setupLogout();

  // ç™»å½•/æ³¨å†Œ/é‡è®¾ï¼ˆä½ åŸæœ¬é€»è¾‘ä¿æŒï¼‰
  $('loginBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    const email = $('email')?.value;
    const password = $('password')?.value;

    if (!email || !password) { showErr('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '); return; }

    const memberData = { isLoggedIn:true, name: email.split('@')[0] || 'VIPä¼šå‘˜', daysLeft: 30, email };
    localStorage.setItem('member_data', JSON.stringify(memberData));
    checkLoginStatus();
    alert('ç™»å½•æˆåŠŸï¼');
  });

  $('registerBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    const email = $('email')?.value;
    const password = $('password')?.value;

    if (!email || !password) { showErr('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '); return; }
    if (password.length < 8) { showErr('å¯†ç è‡³å°‘éœ€è¦8ä½'); return; }

    const memberData = { isLoggedIn:true, name: email.split('@')[0] || 'æ–°ä¼šå‘˜', daysLeft: 7, email, isNew:true };
    localStorage.setItem('member_data', JSON.stringify(memberData));
    checkLoginStatus();
    alert('æ³¨å†ŒæˆåŠŸï¼èµ é€7å¤©VIPä½“éªŒã€‚');
  });

  $('resetBtn')?.addEventListener('click', function() {
    const email = $('email')?.value;
    if (!email) { showErr('è¯·è¾“å…¥é‚®ç®±åœ°å€'); return; }
    alert(`å¯†ç é‡è®¾é“¾æ¥å·²å‘é€åˆ° ${email}ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ã€‚`);
  });

  // åˆå§‹åŒ–é€‰é¢˜
  updatePurposeOptions('ä¸œæ–¹');

  // å¤´éƒ¨æ»šåŠ¨æ•ˆæœ
  (function initHeaderScroll() {
    const header = document.querySelector(".site-header");
    if (!header) return;
    const onScroll = () => {
      if (window.scrollY > 4) header.classList.add("scrolled");
      else header.classList.remove("scrolled");
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll();
  })();

  // èŠå¤©åŠŸèƒ½åˆå§‹åŒ–ï¼ˆä½ åŸæœ¬é€»è¾‘ä¿æŒï¼‰
  (function initChat() {
    const fab = $("ssChatFab");
    const panel = $("chatPanel");
    const closeBtn = $("chatClose");
    const body = $("chatBody");
    const input = $("chatInput");
    const sendBtn = $("chatSend");
    if (!fab || !panel || !closeBtn || !body || !input || !sendBtn) return;

    function toggle() {
      const hidden = panel.getAttribute("aria-hidden") === "true";
      panel.setAttribute("aria-hidden", hidden ? "false" : "true");
      if (!hidden) return;
      if (!body.dataset.welcomed) {
        body.dataset.welcomed = "1";
        appendMsg("æ‚¨å¥½ï¼æˆ‘æ˜¯å¿ƒæ€œç®¡å®¶ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ", false);
      }
    }

    function appendMsg(text, me) {
      const div = document.createElement("div");
      div.className = "ss-msg" + (me ? " me" : "");
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
      return div;
    }

    async function handleSend() {
      const msg = input.value.trim();
      if (!msg) return;

      appendMsg(msg, true);
      input.value = "";

      const pending = appendMsg("æ­£åœ¨æ€è€ƒ...", false);

      setTimeout(() => {
        const replies = [
          "æ ¹æ®æ‚¨çš„å…«å­—åˆ†æï¼Œæˆ‘å»ºè®®æ‚¨å¤šå…³æ³¨äººé™…å…³ç³»çš„å‘å±•ã€‚",
          "åœ¨è´¢è¿æ–¹é¢ï¼Œè¿‘æœŸæœ‰ä¸é”™çš„æŠ•èµ„æœºä¼šï¼Œä½†éœ€è°¨æ…è¯„ä¼°é£é™©ã€‚",
          "æ„Ÿæƒ…è¿åŠ¿æ–¹é¢ï¼Œéœ€è¦æ›´å¤šçš„æ²Ÿé€šå’Œç†è§£æ¥å¢è¿›å…³ç³»ã€‚",
          "äº‹ä¸šä¸Šï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„é¢†å¯¼æ½œåŠ›ï¼Œå¯ä»¥é€‚å½“å±•ç°è‡ªå·±çš„èƒ½åŠ›ã€‚",
          "å¥åº·æ–¹é¢ï¼Œå»ºè®®æ‚¨æ³¨æ„ä¼‘æ¯ï¼Œä¿æŒè‰¯å¥½çš„ä½œæ¯ä¹ æƒ¯ã€‚"
        ];
        pending.textContent = replies[Math.floor(Math.random() * replies.length)];
      }, 1000);
    }

    fab.addEventListener("click", toggle);
    closeBtn.addEventListener("click", toggle);
    sendBtn.addEventListener("click", handleSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); handleSend(); }
    });
  })();

});
</script>
</body>
</html>
