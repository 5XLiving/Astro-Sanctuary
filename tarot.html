
<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · 5X</title>
<style>
  :root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#98a7b7;--gold:#e6c76e;--brand:#d4af37;--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans SC",system-ui,sans-serif}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:#0b0f14cc;border-bottom:1px solid var(--line)}
  .head-inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .brand-badge{background:var(--brand);color:#111;padding:6px 10px;border-radius:8px;font-weight:800}
  .title{font-weight:700}
  .lang select{padding:6px 8px;border-radius:8px;background:#0f1420;color:#e8edf3;border:1px solid #273245}
  .app{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:6px 0 14px;color:var(--brand);font-weight:800}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
  .controls input,.controls select,.controls button{padding:12px;border-radius:12px;border:1px solid #273245;background:#0f1420;color:var(--text)}
  .controls input{flex:1;min-width:220px}
  .controls button{cursor:pointer;background:linear-gradient(180deg,#fff9e6,var(--gold));color:#121212;border-color:var(--gold);font-weight:800}
  .q{margin:6px 0 12px;font-weight:600}
  .board{display:grid;gap:14px;justify-content:center}
  .card{display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px 10px 12px}
  .imgwrap{width:128px;height:212px;border-radius:10px;overflow:hidden;background:#000;display:grid;place-items:center;border:1px solid #34455a}
  .card-img{width:100%;height:100%;object-fit:contain;display:block}
  .cap{font-size:13px;color:#cfe3ff}
  .mean{font-size:12px;color:#a7b5c8}
  .spread-1{grid-template-columns:128px}
  .spread-3{grid-template-columns:repeat(3,128px)}
  .spread-5{grid-template-areas:"top top top" "left center right" ". bottom .";grid-template-columns:128px 128px 128px}
  .pos-top{grid-area:top}.pos-left{grid-area:left}.pos-center{grid-area:center}.pos-right{grid-area:right}.pos-bottom{grid-area:bottom}
  /* 10张：桌面 3-3-4 */
  .spread-10{display:grid;grid-template-columns:repeat(4,128px);grid-auto-rows:auto;gap:14px}
  .spread-10 .c1{grid-column:1;grid-row:1}.spread-10 .c2{grid-column:2;grid-row:1}.spread-10 .c3{grid-column:3;grid-row:1}
  .spread-10 .c4{grid-column:1;grid-row:2}.spread-10 .c5{grid-column:2;grid-row:2}.spread-10 .c6{grid-column:3;grid-row:2}
  .spread-10 .c7{grid-column:1;grid-row:3}.spread-10 .c8{grid-column:2;grid-row:3}.spread-10 .c9{grid-column:3;grid-row:3}
  .spread-10 .c10{grid-column:4;grid-row:3}
  @media(max-width:560px){
    .imgwrap{width:100px;height:166px}
    .spread-1{grid-template-columns:100px}
    .spread-3{grid-template-columns:repeat(3,100px)}
    .spread-5{grid-template-columns:100px 100px 100px}
    .spread-10{grid-template-columns:repeat(2,1fr);grid-auto-flow:row}
    .spread-10 .c1,.spread-10 .c2,.spread-10 .c3,.spread-10 .c4,.spread-10 .c5,.spread-10 .c6,.spread-10 .c7,.spread-10 .c8,.spread-10 .c9,.spread-10 .c10{grid-column:auto;grid-row:auto}
  }
  .panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 8px;font-size:1.05rem;color:#ffe084}
  .muted{color:#98a7b7}
</style>
</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand_title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh">简体中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">塔罗牌占卜</h1>
  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">单张</option>
      <option value="3" data-i18n="s3">三张（过去 / 现在 / 未来）</option>
      <option value="5" data-i18n="s5">十字排法（5张）</option>
      <option value="10" data-i18n="s10">凯尔特十字（10张）</option>
    </select>
    <button id="go" data-i18n="draw_btn">抽牌</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      <span data-i18n="reading_title">解读与建议</span>
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">🔊 <span data-i18n="tts_btn">朗读</span></button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted" data-i18n="disclaimer">
    说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。
  </div>
</div>

<script>
/* --- 抽牌与渲染 --- */
let currentLang = 'zh'; // 先全局声明，供 draw() 使用

function draw(){
  const n=+document.getElementById('spread').value;
  const q=document.getElementById('question').value.trim();
  document.getElementById('qdisplay').textContent = q
    ? (currentLang==='en' ? `Question: ${q}` : `问题：${q}`)
    : (I18N[currentLang].tip_focus);

  const board=document.getElementById('board');
  board.innerHTML='';
  board.className='board '+(n===1?'spread-1':n===3?'spread-3':n===5?'spread-5':'spread-10');

  const pool=[...DECK], take=()=>pool.splice(Math.floor(Math.random()*pool.length),1)[0], picks=[];
  function place(pair,label,extra=''){
    const [name,url]=pair, reversed=Math.random()<0.5; picks.push({name,reversed});
    const wrap=document.createElement('div'); wrap.className='card '+extra;
    const imgw=document.createElement('div'); imgw.className='imgwrap';
    const img=new Image(); img.className='card-img'; img.loading='eager';
    img.src=viaProxy(url,400); img.onerror=()=>{img.onerror=null;img.src=url}; if(reversed) img.style.transform='rotate(180deg)';
    const cap=document.createElement('div'); cap.className='cap'; cap.textContent=label?`${name} · ${label}`:name;
    const mean=document.createElement('div'); mean.className='mean'; mean.textContent=parseMeaning(name,reversed);
    imgw.appendChild(img); wrap.appendChild(imgw); wrap.appendChild(cap); wrap.appendChild(mean); board.appendChild(wrap);
  }
  if(n===1){place(take(),'当下')}
  else if(n===3){place(take(),'过去');place(take(),'现在');place(take(),'未来')}
  else if(n===5){
    place(take(),'过去','pos-top');
    place(take(),'潜意识','pos-left');
    place(take(),'当下','pos-center');
    place(take(),'外在影响','pos-right');
    place(take(),'未来趋势','pos-bottom')
  }
  else{
    const labels10=['当下','阻碍','潜意识','显意识','过去','未来','自我','环境','希望/恐惧','结果'];
    for(let i=0;i<10;i++) place(take(),labels10[i],`c${i+1}`)
  }

  // 统一解读
  const unified = buildReading(q,picks,n);
  document.getElementById('readingText').innerHTML = unified;
  document.getElementById('reading').style.display = 'block';
  lastSpoken = stripTags(unified);
} // ← 关键：结束 draw()

/* --- TTS --- */
let lastSpoken='',speaking=false;
function pickZhVoice(){const vs=speechSynthesis.getVoices();return vs.find(v=>/zh|cmn/i.test(v.lang))||vs[0]}
function speak(text){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  const v=pickZhVoice(); if(v)u.voice=v;
  u.rate=1;u.pitch=1;u.volume=1;
  u.onend=()=>{speaking=false;document.getElementById('ttsBtn').innerHTML='🔊 <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>'};
  speaking=true;
  document.getElementById('ttsBtn').textContent='⏸ 暂停';
  speechSynthesis.speak(u);
}
function toggleTTS(){
  if(!('speechSynthesis'in window)) return alert('当前浏览器不支持语音朗读');
  if(speaking){
    speechSynthesis.cancel(); speaking=false;
    document.getElementById('ttsBtn').innerHTML='🔊 <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>';
  }else{
    speak(lastSpoken||'暂无可朗读内容。');
  }
}

/* --- 小工具：去标签供朗读 --- */
function stripTags(html){
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  let text = tmp.textContent || tmp.innerText || '';
  return text.replace(/[•【】—·]/g,' ').replace(/\s+/g,' ').trim();
}

/* --- 事件绑定 & 语言切换（必须在 draw() 外） --- */
document.getElementById('go').addEventListener('click', draw);
document.getElementById('ttsBtn').addEventListener('click', toggleTTS);
document.getElementById('langSel').addEventListener('change', e=>{
  currentLang = e.target.value;
  applyI18N(currentLang);
});
applyI18N(currentLang);

// 预热语音（有些浏览器需要）
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = ()=>{};
}
</script>
</body>
</html>
