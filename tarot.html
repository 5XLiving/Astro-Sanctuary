<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å¡”ç½—ç‰Œå åœ Â· Tarot</title>
<style>
/* ======================
   THEME Â· VARIABLES
====================== */
:root{
  --bg:#0b0f14;
  --card:#11161dcc;
  --line:#1f2a36;
  --text:#e8edf3;
  --muted:#98a7b7;
  --gold:#e6c76e;
  --brand:#d4af37;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;
  --card-h:212px;
  --gap:14px;
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* ç»Ÿä¸€é‡‘è‰²å­—ä½“ï¼ˆå åœåŒº & ä¸»è¦æ­£æ–‡ï¼‰ */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* æ·±è‰²æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼‰ */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* é€‰å‡ å¼ ç‰Œçš„ UIï¼ˆä»…æ ·å¼ï¼ŒåŠŸèƒ½ç”¨ JS æ¥ï¼‰ */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD Â· CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* å•å¼ å¡ç‰‡ç»„ä»¶ï¼ˆå›¾+æ ‡é¢˜+ç®€æ„ï¼‰ */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 å¼  */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 å¼ ï¼ˆæ¨ªæ’ï¼‰ */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 å¼ ï¼ˆåå­—ï¼‰ */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 å¼ ï¼š3-3-4 å±…ä¸­ï¼ˆè¡Œå®¹å™¨æ³•ï¼Œä¿è¯æ¯è¡Œå±…ä¸­ï¼‰ */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center;
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* ===============
   PANELS / BLOCKS
=============== */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* ä»£ç å—æ ·å¼ */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* å°å¾½ç«  & é€†ä½æ ‡è®° */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{ --card-w:100px; --card-h:166px; --gap:12px; }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>
</head>

<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">Tarot</div>
      <div class="title" data-i18n="brand_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="en-US">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">å¡”ç½—ç‰Œå åœ</h1>
  <div class="controls">
    <input id="question" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">å•å¼ </option>
      <option value="3" data-i18n="s3">ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰</option>
      <option value="5" data-i18n="s5">åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰</option>
      <option value="10" data-i18n="s10">å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰</option>
    </select>
    <button id="go" data-i18n="draw_btn">æŠ½ç‰Œ</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
<h3 style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
  <span data-i18n="reading_title">è§£è¯»ä¸å»ºè®®</span>
  <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">ğŸ”Š <span data-i18n="tts_btn">æœ—è¯»</span></button>
  <label class="muted" style="display:inline-flex;align-items:center;gap:8px">
    <span>è¯­é€Ÿ</span>
    <input id="rateCtrl" type="range" min="0.70" max="1.30" step="0.05" value="0.90" style="width:120px">
    <span id="rateVal">0.90Ã—</span>
  </label>
</h3>
<div id="readingText"></div>

  <div class="panel muted" data-i18n="disclaimer">
    è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚
  </div>
</div>

<script>
/* ===========================
   I18Nï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
=========================== */
const I18N = {
  'zh-CN': {
    ui: {
      page_title: 'å¡”ç½—ç‰Œå åœ',
      q_ph:'è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰',
      s1:'å•å¼ ', s3:'ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰', s5:'åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰', s10:'å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰',
      draw_btn:'æŠ½ç‰Œ',
      tip_focus:'ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰',
      reading_title:'è§£è¯»ä¸å»ºè®®',
      tts_btn:'æœ—è¯»',
      tts_tip_start:'ç‚¹å‡»å¼€å§‹æœ—è¯»',
      tts_tip_stop:'å†æ¬¡ç‚¹å‡»åœæ­¢æœ—è¯»',
      disclaimer:'è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚'
    },
    pos: {
      single:'å½“ä¸‹æ ¸å¿ƒ', past:'è¿‡å»', present:'ç°åœ¨', future:'æœªæ¥',
      top:'æŒ‡å¼•/ä¸»é¢˜', left:'è¿‡å»æ ¹æº', center:'å½“ä¸‹æ ¸å¿ƒ', right:'å¤–åœ¨å½±å“', bottom:'æœªæ¥å‘å±•',
      p1:'å½“ä¸‹', p2:'é˜»ç¢', p3:'æ½œæ„è¯†', p4:'è¿‡å»', p5:'æ˜¾æ„è¯†', p6:'æœªæ¥', p7:'è‡ªæˆ‘', p8:'ç¯å¢ƒ', p9:'å¸Œæœ›/ææƒ§', p10:'ç»“æœ'
    },
    suits: {
      wands:{name:'æƒæ–', domain:'è¡ŒåŠ¨/çƒ­æƒ…'},
      cups:{name:'åœ£æ¯', domain:'æƒ…æ„Ÿ/å…³ç³»'},
      swords:{name:'å®å‰‘', domain:'æ€ç»´/æ²Ÿé€š'},
      pentacles:{name:'é’±å¸', domain:'ç°å®/èµ„æº'}
    },
    ranks:{
      ace:'ä¸€','2':'äºŒ','3':'ä¸‰','4':'å››','5':'äº”','6':'å…­','7':'ä¸ƒ','8':'å…«','9':'ä¹','10':'å',
      page:'ä¾ä»', knight:'éª‘å£«', queen:'çš‡å', king:'å›½ç‹',
      tone:{ ace:'èµ·ç‚¹/æ½œèƒ½','2':'å¯¹è¯/é€‰æ‹©','3':'åä½œ/æˆé•¿','4':'ç»“æ„/ç¨³å®š','5':'æŒ‘æˆ˜/æ³¢åŠ¨','6':'äº¤æµ/æ”¯æŒ','7':'è¯„ä¼°/è€å¿ƒ','8':'æ¨è¿›/æ•ˆç‡','9':'æˆæœ/è´Ÿæ‹…','10':'é˜¶æ®µå®Œæˆ', page:'è®¯æ¯/å­¦ä¹ ', knight:'è¡ŒåŠ¨/æ¨åŠ¨', queen:'æˆç†Ÿ/æ»‹å…»', king:'æŒæ§/å®šè°ƒ'}
    },
    majors:[
      ['æ„šè€…','è‡ªç”±/è·ƒè¿','æ‹¥æŠ±æœªçŸ¥ï¼Œè½»è£…å¯ç¨‹'],['é­”æœ¯å¸ˆ','æ„å¿—/æ˜¾åŒ–','é›†ä¸­èµ„æºï¼Œç«‹å³è¡ŒåŠ¨'],['å¥³ç¥­å¸','ç›´è§‰/æ½œæ„è¯†','å…ˆè§‚å¯Ÿï¼Œåè¡¨æ€'],['å¥³çš‡','æ»‹å…»/ä¸°ç››','ä»¥æ¸©æŸ”ä¸ç…§æ–™ä¿ƒè¿›æˆé•¿'],['çš‡å¸','ç§©åº/ç»“æ„','å®šè§„åˆ™ã€ç«‹è¾¹ç•Œã€ç»™å®‰å…¨æ„Ÿ'],['æ•™çš‡','è§„èŒƒ/ä¼ æ‰¿','éµå¾ªåˆ¶åº¦ä¸é•¿è¾ˆå»ºè®®'],['æ‹äºº','é€‰æ‹©/è¿ç»“','å¯¹é½ä»·å€¼è§‚å†æ‰¿è¯º'],['æˆ˜è½¦','æ¨è¿›/èƒœè´Ÿ','å®šç›®æ ‡ï¼Œå¼ºåŠ¿æ¨è¿›'],['åŠ›é‡','å‹‡æ°”/æ¸©æŸ”','ä»¥æŸ”å…‹åˆšï¼Œç¨³å®šè€å¿ƒ'],['éšè€…','å†…çœ/ç‹¬å¤„','æ”¶å¿ƒå®¡è§†ï¼Œç‹¬ç«‹åˆ¤æ–­'],['å‘½è¿ä¹‹è½®','å‘¨æœŸ/æœºç¼˜','é¡ºåŠ¿è€Œä¸ºï¼ŒæŠ“æ—¶æœº'],['æ­£ä¹‰','è¡¡é‡/å…¬å¹³','ä»¥äº‹å®ä¸è¾¹ç•Œè§£å†³'],['å€’åŠäºº','åœæ­¢/æ¢è§’','æš‚ç¼“æ¨è¿›ï¼Œæ¢ä½æ€è€ƒ'],['æ­»ç¥','ç»“æŸ/é‡ç”Ÿ','æœæ–­æ­¢æŸï¼Œè¿æ¥æ–°ç”Ÿ'],['èŠ‚åˆ¶','è°ƒå’Œ/èŠ‚å¾‹','é™å¼ºåº¦ï¼Œç¨³èŠ‚å¥'],['æ¶é­”','æ‰§è‘—/è¯±æƒ‘','è¾¨ä¾èµ–ï¼Œæ–­ä¸è‰¯å¾ªç¯'],['é«˜å¡”','çªå˜/ç“¦è§£','æ¥çº³å˜åŒ–ï¼Œå¿«é€Ÿé‡ç»„'],['æ˜Ÿæ˜Ÿ','å¸Œæœ›/å¤åŸ','é‡å»ºä¿¡ä»»ï¼Œæ¸©æŸ”ä¿®å¤'],['æœˆäº®','è¿·é›¾/ä¸å®‰','æ¨è¿Ÿé‡å¤§å†³å®šï¼Œå…ˆæŸ¥æ˜'],['å¤ªé˜³','æ¸…æ™°/å–œæ‚¦','å…¬å¼€é€æ˜ï¼Œåº†ç¥æˆæœ'],['å®¡åˆ¤','è§‰é†’/å¬å›','å›åº”å¬å”¤ï¼Œçº åå¤ç›˜'],['ä¸–ç•Œ','å®Œæˆ/æ•´åˆ','é—­ç¯ä¸å‡çº§ï¼Œå¼€å¯æ–°ç¯‡']
    ],
    tags:{upright:'æ­£ä½', reversed:'é€†ä½'},
    nextSteps:'<b>ä¸‹ä¸€æ­¥ï¼ˆ48 å°æ—¶å†…ï¼‰ï¼š</b><br>â‘  å†™ä¸‹ 1 æ¡å°ç›®æ ‡ï¼›â‘¡ å®‰æ’ 1 ä¸ªå…·ä½“è¡ŒåŠ¨ï¼ˆåŠ åˆ°æ—¥å†ï¼‰ï¼›â‘¢ ç”¨ 3 ä¸ªå®¢è§‚æŒ‡æ ‡è¡¡é‡ï¼ˆå¦‚å›å¤é¢‘ç‡ã€é¢è°ˆæ—¶é•¿ã€å®é™…æˆäº¤/é¢„çº¦ï¼‰ã€‚',
    posHint:{
      past:'å›é¡¾è¿‡å»ç»éªŒï¼Œæ‰¾å¯å¤ç”¨æˆ–éœ€æ”¾ä¸‹çš„éƒ¨åˆ†',
      present:'æè¿°å½“å‰æ ¸å¿ƒçŸ›ç›¾ä¸å…³é”®å˜é‡',
      future:'ç»™å‡ºä¸¤æ­¥ä»¥å†…å¯æ‰§è¡ŒåŠ¨ä½œï¼Œé¿å…ç©ºè°ˆæ„¿æ™¯',
      top:'ä»¥â€œä¸»é¢˜/åŸåˆ™â€å®šè°ƒå½“ä¸‹é€‰æ‹©',
      left:'è¯†åˆ«å†å²æƒ¯æ€§ä¸æ—§ä¿¡å¿µçš„å½±å“',
      center:'èšç„¦æ­¤åˆ»çœŸæ­£è¦è§£å†³çš„ä¸€ä»¶äº‹',
      right:'è¯„ä¼°å¤–éƒ¨å› ç´ /ä»–äººç«‹åœº',
      bottom:'è§„åˆ’æ¥ä¸‹æ¥ 1â€“3 å‘¨è·¯å¾„',
      p1:'æè¿°å½“ä¸‹çŠ¶æ€ä¸ä¸»è¦å¼ åŠ›',
      p2:'æŒ‡å‡ºé˜»ç¢ä¸å¯¹ç­–',
      p3:'ç‚¹ç ´æ½œæ„è¯†åŠ¨æœº/ææƒ§',
      p4:'å›é¡¾æˆå› ä¸æ—¢å¾€æ¨¡å¼',
      p5:'çœ¼å‰è®¤çŸ¥ä¸æ˜¾æ€§ç›®æ ‡',
      p6:'æœªæ¥ 1â€“6 å‘¨çš„è¶‹åŠ¿',
      p7:'è‡ªæˆ‘å®šä½ä¸è§’è‰²é€‰æ‹©',
      p8:'ç¯å¢ƒ/ä»–äºº/æƒ…å¢ƒå½±å“',
      p9:'å¸Œæœ›ä¸ææƒ§çš„ä¸¤é¢',
      p10:'é˜¶æ®µæ€§ç»“æœä¸è°ƒæ•´å»ºè®®',
      single:'æç‚¼æœ¬æ¬¡å åœçš„å”¯ä¸€å…³é”®è¡ŒåŠ¨'
    },
    domainAdvice:{
      love:{majorRev:'å…ˆæ”¾æ…¢è¡¨è¾¾å¼ºåº¦ï¼Œå°Šé‡å¯¹æ–¹è¾¹ç•Œä¸èŠ‚å¥', majorOk:'ä»¥çœŸè¯šä¸ç¨³å®šè¡ŒåŠ¨å»ºç«‹å®‰å…¨æ„Ÿ',
        wands:'é¿å…æƒ…ç»ªåŒ–æ¨è¿›ï¼Œå…ˆç¡®è®¤å½¼æ­¤æ„æ„¿',
        cups:'å…ˆè‡ªç¨³æƒ…ç»ªï¼Œå†è°ˆéœ€æ±‚ä¸äº²å¯†',
        swords:'å‡å°‘è´¨é—®ï¼Œå¤šç”¨æ¾„æ¸…å¼æé—®',
        pentacles:'å°‘ç‰©è´¨å¯¹å†²ï¼Œå¤šé«˜è´¨é‡ç›¸å¤„'},
      career:{majorRev:'ä¿®æ­£æ–¹å‘ä¸åˆ†å·¥ï¼Œåˆ«ç¡¬æ¨', majorOk:'åˆ¶å®šé‡Œç¨‹ç¢‘ä¸è´Ÿè´£çŸ©é˜µ',
        wands:'æ§åˆ¶èŠ‚å¥ï¼Œæ‹†å°æ­¥',
        cups:'å‡èšå›¢é˜Ÿæƒ…ç»ªï¼Œæé«˜åä½œ',
        swords:'ç”¨æ•°æ®ä¸äº‹å®é¿å…å†…è€—',
        pentacles:'å…ˆè¡¥èµ„æº/æµç¨‹å†æ‰©å¼ '},
      money:{majorRev:'æ”¶ç¼©é£é™©ï¼Œç°é‡‘æµä¼˜å…ˆ', majorOk:'è°¨æ…æ‰©å¼ ï¼ŒæŒ‡æ ‡é©±åŠ¨',
        wands:'é™æˆæœ¬/ææ•ˆå¹¶è¡Œ',
        cups:'æ…é€‰åˆä½œï¼Œæ˜ç¡®åˆ†è´¦',
        swords:'å¤ç›˜æ¨¡å‹ä¸å‡è®¾',
        pentacles:'åº“å­˜/é¢„ç®—/è´¹ç”¨ä¸‰è¡¨è”åŠ¨'},
      health:{majorRev:'å…ˆä¼‘æ¯ä¸å°±åŒ»è¯„ä¼°', majorOk:'å»ºç«‹ä½œæ¯ä¸è½»è¿åŠ¨',
        wands:'é¿å…è¿‡é‡è®­ç»ƒ',
        cups:'æƒ…ç»ªæŠ¤ç†ä¸æ”¯æŒ',
        swords:'å‡å‹ä¸ç¡çœ ä¼˜å…ˆ',
        pentacles:'è§„å¾‹é¥®é£Ÿä¸ä½“æ£€'},
      general:{majorRev:'å…ˆç¨³ä½å†å†³ç­–', majorOk:'å°æ­¥éªŒè¯ï¼Œé€æ­¥æ¨è¿›',
        wands:'æ”¾ç¼“èŠ‚å¥ï¼Œèšç„¦ä¸€ä»¶äº‹',
        cups:'ä¼˜å…ˆå…³ç³»è´¨é‡',
        swords:'å…ˆä¿¡æ¯å¯¹é½',
        pentacles:'å…ˆåšå¯è½åœ°èµ„æºé…ç½®'}
    }
  },

  'en-US': {
    ui: {
      page_title:'Tarot Reading',
      q_ph:'Type your question (focuses the reading)',
      s1:'Single', s3:'Three (Past / Present / Future)', s5:'Cross (5)', s10:'Celtic Cross (10)',
      draw_btn:'Draw',
      tip_focus:'(Tip: a clear question focuses the reading)',
      reading_title:'Insights & Advice',
      tts_btn:'Read Aloud',
      tts_tip_start:'Press to read aloud',
      tts_tip_stop:'Press again to stop reading',
      disclaimer:'Tarot offers guidance, not medical/legal/financial advice. Use your judgment.'
    },
    pos:{single:'Core Now', past:'Past', present:'Present', future:'Future',
         top:'Theme/Guidance', left:'Roots', center:'Core Now', right:'External', bottom:'Development',
         p1:'Present', p2:'Obstacle', p3:'Subconscious', p4:'Past', p5:'Conscious', p6:'Future', p7:'Self', p8:'Environment', p9:'Hopes/Fears', p10:'Outcome'},
    suits:{
      wands:{name:'Wands', domain:'Action/Passion'},
      cups:{name:'Cups', domain:'Emotion/Relations'},
      swords:{name:'Swords', domain:'Mind/Communication'},
      pentacles:{name:'Pentacles', domain:'Material/Resources'}
    },
    ranks:{
      ace:'Ace','2':'Two','3':'Three','4':'Four','5':'Five','6':'Six','7':'Seven','8':'Eight','9':'Nine','10':'Ten',
      page:'Page', knight:'Knight', queen:'Queen', king:'King',
      tone:{ace:'Seed/Potential','2':'Duality/Choice','3':'Collab/Growth','4':'Structure/Stability','5':'Challenge/Flux','6':'Exchange/Support','7':'Evaluate/Patience','8':'Momentum/Efficiency','9':'Result/Burden','10':'Completion',
            page:'Message/Learning', knight:'Action/Drive', queen:'Maturity/Nurture', king:'Authority/Setting Tone'}
    },
    majors:[
      ['The Fool','Freedom/Leap','Embrace the unknown; travel light'],
      ['The Magician','Will/Manifest','Align resources; act now'],
      ['The High Priestess','Intuition/Subconscious','Observe first, speak later'],
      ['The Empress','Nurture/Abundance','Gentle care grows results'],
      ['The Emperor','Order/Structure','Set rules and safety'],
      ['The Hierophant','Norms/Tradition','Follow guidance and standards'],
      ['The Lovers','Choice/Union','Align values before commitment'],
      ['The Chariot','Push/Win','Pick a target; drive forward'],
      ['Strength','Courage/Gentleness','Soft power, steady patience'],
      ['The Hermit','Introspect/Alone','Withdraw to assess'],
      ['Wheel of Fortune','Cycle/Timing','Ride the turn; seize timing'],
      ['Justice','Measure/Fairness','Facts and boundaries solve it'],
      ['The Hanged Man','Pause/Reframe','Wait; see from another angle'],
      ['Death','Ending/Rebirth','Cut losses; welcome renewal'],
      ['Temperance','Blend/Rhythm','Lower intensity; steady cadence'],
      ['The Devil','Attachment/Temptation','Name the bind; break the loop'],
      ['The Tower','Shock/Collapse','Accept change; rebuild swiftly'],
      ['The Star','Hope/Recovery','Restore trust; heal gently'],
      ['The Moon','Fog/Anxiety','Delay big moves; verify facts'],
      ['The Sun','Clarity/Joy','Be open; celebrate wins'],
      ['Judgement','Awakening/Call','Answer the call; correct course'],
      ['The World','Completion/Integration','Close the loop; level up']
    ],
    tags:{upright:'Upright', reversed:'Reversed'},
    nextSteps:'<b>Next 48h:</b><br>(1) Write one small goal; (2) Schedule one concrete action; (3) Track 3 objective metrics (e.g., reply cadence, meeting time, actual bookings).',
    posHint:{
      past:'Extract reusable lessons or what to release',
      present:'Name the core tension and variables',
      future:'Give 1â€“2 actionable next steps',
      top:'Set principles to guide choices',
      left:'Spot legacy patterns/beliefs',
      center:'Focus on the one real problem',
      right:'Weigh external factors/others',
      bottom:'Plan next 1â€“3 weeks',
      p1:'Describe current state and tension',
      p2:'Point out obstacle and counter-move',
      p3:'Expose hidden motives/fears',
      p4:'Review causes and patterns',
      p5:'Conscious goal and frame',
      p6:'Trend for next 1â€“6 weeks',
      p7:'Your role/stance',
      p8:'Context and stakeholders',
      p9:'Hope vs fear twin view',
      p10:'Likely outcome & adjustment',
      single:'One key action for this session'
    },
    domainAdvice:{
      love:{majorRev:'Slow intensity; honor boundaries', majorOk:'Build safety with steady acts',
        wands:'Curb impulsive pushes; confirm consent',
        cups:'Regulate emotion before needs talk',
        swords:'Use clarifying questions over grilling',
        pentacles:'Less gifting; more quality time'},
      career:{majorRev:'Fix direction/roles before pushing', majorOk:'Milestones and RACI',
        wands:'Control pace; break into sprints',
        cups:'Rally morale; improve collaboration',
        swords:'Use data to avoid churn',
        pentacles:'Secure resources/process first'},
      money:{majorRev:'De-risk; protect cashflow', majorOk:'Cautious growth; KPI-led',
        wands:'Cut cost + raise efficiency',
        cups:'Choose partners carefully; clear split',
        swords:'Audit assumptions and model',
        pentacles:'Tie inventory/budget/expenses'},
      health:{majorRev:'Rest & seek evaluation', majorOk:'Routines + light exercise',
        wands:'Avoid over-training',
        cups:'Emotional support',
        swords:'Reduce stress; prioritize sleep',
        pentacles:'Diet regularity; check-ups'},
      general:{majorRev:'Stabilize before deciding', majorOk:'Validate in small steps',
        wands:'Slow down; single-task',
        cups:'Prioritize relationship quality',
        swords:'Align information first',
        pentacles:'Resource a concrete plan first'}
    }
  }
};

/* å°å·¥å…· */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rnd = n => Math.floor(Math.random()*n);

/* è¯­è¨€å¤„ç† */
const FALLBACK = 'zh-CN';
function detectLang(){
  const nav=(navigator.language||'').toLowerCase();
  if(nav.startsWith('zh')) return 'zh-CN';
  if(nav.startsWith('en')) return 'en-US';
  return FALLBACK;
}
let CUR = detectLang();
const langSel = document.getElementById('langSel');
langSel.value = CUR;

/* t(): è¯»å–æ–‡æ¡ˆ */
function t(path, dflt=''){
  const parts = path.split('.');
  let node = I18N[CUR];
  for(const p of parts){ if(!node) break; node=node[p]; }
  return node==null ? dflt : node;
}
window.t = t; // ä¾› TTS æç¤ºç”¨

/* åº”ç”¨é™æ€ UI æ–‡æ¡ˆ */
function applyStaticUI(){
  $('[data-i18n="page_title"]').textContent = t('ui.page_title');
  $('[data-i18n="tip_focus"]').textContent = t('ui.tip_focus');
  $('[data-i18n="reading_title"]').textContent = t('ui.reading_title');
  $('[data-i18n="disclaimer"]').textContent = t('ui.disclaimer');
  $('#go').textContent = t('ui.draw_btn');
  // ä¸‹æ‹‰é€‰é¡¹
  const spread = $('#spread');
  spread.options[0].textContent = t('ui.s1');
  spread.options[1].textContent = t('ui.s3');
  spread.options[2].textContent = t('ui.s5');
  spread.options[3].textContent = t('ui.s10');
  // è¾“å…¥æ¡† placeholder
  $('#question').setAttribute('placeholder', t('ui.q_ph'));
  // TTS æŒ‰é’®æ–‡æ¡ˆ
  const ttsSpan = $('#ttsBtn span'); if(ttsSpan) ttsSpan.textContent = t('ui.tts_btn');
}

/* ==============
   ç‰Œåº“ & æŠ½ç‰Œ
================ */
const SUITS = [
  {key:'wands',    zh:'æƒæ–'},
  {key:'cups',     zh:'åœ£æ¯'},
  {key:'swords',   zh:'å®å‰‘'},
  {key:'pentacles',zh:'é’±å¸'}
];
const RANKS = [
  {id:'ace', zh:'ä¸€'},{id:'2', zh:'äºŒ'},{id:'3', zh:'ä¸‰'},{id:'4', zh:'å››'},{id:'5', zh:'äº”'},
  {id:'6', zh:'å…­'},{id:'7', zh:'ä¸ƒ'},{id:'8', zh:'å…«'},{id:'9', zh:'ä¹'},{id:'10', zh:'å'},
  {id:'page', zh:'ä¾ä»'},{id:'knight', zh:'éª‘å£«'},{id:'queen', zh:'çš‡å'},{id:'king', zh:'å›½ç‹'}
];
const MAJORS = Array.from({length:22},(_,i)=>i);

function buildDeck(){
  const deck=[];
  // majors
  MAJORS.forEach(i=>{
    const row = I18N['zh-CN'].majors[i]; // ä»…å–ç´¢å¼•ï¼›åç§°åœ¨æœ¬åœ°åŒ–å‡½æ•°é‡Œå–
    deck.push({id:`major_${String(i).padStart(2,'0')}`, group:'major', idx:i});
  });
  // minors
  SUITS.forEach(s=>{
    RANKS.forEach(r=>{
      deck.push({id:`${s.key}_${r.id}`, group:'minor', suit:s.key, rank:r.id});
    });
  });
  return deck;
}
const DECK = buildDeck();
function draw(n){
  const pool=[...DECK], picks=[];
  for(let i=0;i<n;i++){
    const idx=rnd(pool.length);
    const card=pool.splice(idx,1)[0];
    card.reversed = Math.random()<0.5;
    picks.push(card);
  }
  return picks;
}
function imgFor(card){
  return `/img/tarot/${card.id}.webp`;
}

/* ==============
   å¸ƒå±€å®šä¹‰
================ */
const SPREADS = {
  1:  { layout:'spread-1',  positions:[{key:'single'}]},
  3:  { layout:'spread-3',  positions:[{key:'past'},{key:'present'},{key:'future'}]},
  5:  { layout:'spread-5',  positions:[
        {key:'top',cls:'pos-top'}, {key:'left',cls:'pos-left'}, {key:'center',cls:'pos-center'},
        {key:'right',cls:'pos-right'}, {key:'bottom',cls:'pos-bottom'}
      ]},
  10: { layout:'spread-10', positions:[
        {key:'p1'},{key:'p2'},{key:'p3'},{key:'p4'},{key:'p5'},{key:'p6'},{key:'p7'},{key:'p8'},{key:'p9'},{key:'p10'}
      ]}
};

/* ==============
   æœ¬åœ°åŒ–å¸®åŠ©
================ */
function cardName(card){
  if(card.group==='major'){
    return I18N[CUR].majors[card.idx][0];
  }else{
    const s=I18N[CUR].suits[card.suit];
    const r=I18N[CUR].ranks[card.rank] || card.rank.toUpperCase();
    return `${s.name}${r}`;
  }
}
function previewLineLocalized(card){
  if(card.group==='major'){
    const row = I18N[CUR].majors[card.idx];
    return `${row[1]} Â· ${row[2]}`;
  }else{
    const s = I18N[CUR].suits[card.suit];
    const tone = I18N[CUR].ranks.tone[card.rank];
    return `${s.name}ï¼ˆ${s.domain}ï¼‰Â· ${tone}`;
  }
}
function posLabel(key){ return I18N[CUR].pos[key] || key; }
function tagFor(rev){ return rev ? I18N[CUR].tags.reversed : I18N[CUR].tags.upright; }
function classifyQuestion(q){
  q=(q||'').toLowerCase();
  const love = ['æ‹','çˆ±','å–œæ¬¢','æ„Ÿæƒ…','æš§æ˜§','ç»“å©š','åˆ†æ‰‹','å¤åˆ','will she','will he','relationship','love'];
  const career=['å·¥ä½œ','å‡èŒ','è·³æ§½','offer','äº‹ä¸š','è€æ¿','åŒäº‹','é¡¹ç›®','career','job'];
  const money =['é’±','è´¢','æ”¶å…¥','æŠ•èµ„','ç”Ÿæ„','é”€å”®','é¢„ç®—','money'];
  const health=['å¥åº·','èº«ä½“','ç–¾ç—…','ç¡çœ ','ç„¦è™‘','æŠ‘éƒ','ä½“æ£€','health'];
  if(love.some(k=>q.includes(k))) return 'love';
  if(career.some(k=>q.includes(k))) return 'career';
  if(money.some(k=>q.includes(k))) return 'money';
  if(health.some(k=>q.includes(k))) return 'health';
  return 'general';
}

/* ==============
   æ¸²æŸ“æ£‹ç›˜
================ */
function cardNode(card, cls, posKey){
  const div=document.createElement('div');
  div.className=`card ${cls||''}`;
  div.setAttribute('data-card-id', card.id);
  div.setAttribute('data-reversed', card.reversed?'true':'false');

  const wrap=document.createElement('div'); wrap.className='imgwrap';
  if(card.reversed) wrap.style.transform='rotate(180deg)';
  const img=document.createElement('img'); img.className='card-img'; img.src=imgFor(card); img.alt=cardName(card);
  wrap.appendChild(img);

  const cap=document.createElement('div'); cap.className='cap';
  cap.textContent = `ã€${posLabel(posKey)}ã€‘${cardName(card)}ï¼ˆ${tagFor(card.reversed)}ï¼‰`;

  const mean=document.createElement('div'); mean.className='mean';
  mean.textContent = previewLineLocalized(card);

  div.appendChild(wrap); div.appendChild(cap); div.appendChild(mean);
  return div;
}

function renderBoard(n, cards){
  const board = document.getElementById('board');
  board.className='board';
  const conf = SPREADS[n]; if(!conf){ board.innerHTML=''; return; }
  board.classList.add(conf.layout);

  if(n===10){
    board.innerHTML = `<div class="row row-1"></div><div class="row row-2"></div><div class="row row-3"></div>`;
    const rows = $$('#board .row'); const slots=[3,3,4];
    let k=0;
    slots.forEach((count,rowi)=>{
      for(let j=0;j<count;j++){
        const c = cards[k++];
        const posKey = conf.positions[k-1].key;
        rows[rowi].appendChild(cardNode(c, `c${k}`, posKey));
      }
    });
  }else{
    board.innerHTML='';
    cards.forEach((c,i)=>{
      const pos=conf.positions[i];
      board.appendChild(cardNode(c, `c${i+1} ${pos.cls||''}`, pos.key));
    });
  }
}

/* ==============
   åŠ¨æ€è§£è¯»
================ */
function renderReadingLocalized(question, n, cards){
  const domain = classifyQuestion(question);
  const posKeys = (n===10)? ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p10']
              : (n===5)?  ['top','left','center','right','bottom']
              : (n===3)?  ['past','present','future']
              : ['single'];

  const domAdv = I18N[CUR].domainAdvice[domain] || I18N[CUR].domainAdvice.general;

  const segments = cards.map((card,i)=>{
    const title = `ã€${posLabel(posKeys[i])}ã€‘${cardName(card)}ï¼ˆ${tagFor(card.reversed)}ï¼‰`;
    const arch  = previewLineLocalized(card);
    const hint  = I18N[CUR].posHint[posKeys[i]] ? `ï¼ˆ${I18N[CUR].posHint[posKeys[i]]}ï¼‰` : '';

    let adv1='';
    if(card.group==='major'){
      adv1 = card.reversed ? domAdv.majorRev : domAdv.majorOk;
    }else{
      const mapKey = card.suit; // wands/cups/swords/pentacles
      adv1 = domAdv[mapKey] || domAdv.general;
    }

    let adv2='';
    if(card.group!=='major'){
      const tone = I18N[CUR].ranks.tone[card.rank];
      adv2 = (CUR==='en-US')
        ? `Plan one actionable step around â€œ${tone}â€.`
        : `å›´ç»•â€œ${tone}â€åˆ¶å®šä¸€æ¡å¯æ‰§è¡Œçš„å°è¡ŒåŠ¨ã€‚`;
    }

    return `
      <div style="margin:8px 0 12px">
        <div style="font-weight:700">${title}</div>
        <div class="muted" style="margin:4px 0">${arch} ${hint}</div>
        <ul style="margin:6px 0 0 18px">
          <li>${adv1}</li>${adv2?`<li>${adv2}</li>`:''}
        </ul>
      </div>`;
  }).join('');

  const youLabel = (CUR==='en-US'?'You':'ä½ ');
  const readingLabel = (CUR==='en-US'?'Reading':'è§£è¯»');

  return `<div class="chat">
    <div class="msg user"><div class="meta">${youLabel}</div>${escapeHTML(question||'')}</div>
    <div class="msg assistant"><div class="meta">${readingLabel}</div>
      ${segments}
      <hr style="border:0;border-top:1px solid #273245;margin:12px 0">
      ${I18N[CUR].nextSteps}
    </div>
  </div>`;
}

function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

/* ==============
   TTSï¼ˆæœ—è¯»åˆ‡æ¢ï¼Œå«å¤šè¯­è¨€æç¤ºï¼‰
================ */
// ---- TTS: æ¸…ç†ç¬¦å· + è¯­é€Ÿå¯è°ƒ ----
window.__TTS_LANG  = window.__TTS_LANG || 'zh-CN';
window.__TTS_RATE  = Number(localStorage.getItem('__TTS_RATE')||'0.90') || 0.90;

function cleanForTTS(text){
  if(!text) return '';
  let s = text.replace(/[ã€ã€‘\[\]ï¼ˆï¼‰()ã€Šã€‹<>]/g, '');     // å»æ‹¬å·ç¬¦å·
  s = s.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š,.!?;:]{2,}/g, m=>m[0]);   // åˆå¹¶é‡å¤æ ‡ç‚¹
  s = s.replace(/\s{2,}/g, ' ').trim();                   // åˆå¹¶ç©ºæ ¼
  return s;
}

function speakFromHTML(html){
  const synth = window.speechSynthesis;
  if (!synth) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»'); return; }
  const tmp = document.createElement('div'); tmp.innerHTML = html;
  const text = cleanForTTS(tmp.textContent || tmp.innerText || '');

  const u = new SpeechSynthesisUtterance(text);
  u.lang = window.__TTS_LANG || 'zh-CN';
  u.rate = window.__TTS_RATE;               // â† ä½¿ç”¨å¯è°ƒè¯­é€Ÿ
  u.onend = u.onpause = u.onerror = () => setTTSState(false);

  synth.cancel();
  synth.speak(u);
  setTTSState(true);
}

let __isReading = false;
function setTTSState(on){
  __isReading = !!on;
  const btn = document.getElementById('ttsBtn'); if(!btn) return;
  const base = (btn.dataset.baseLabel) || (btn.querySelector('span')?.textContent || 'æœ—è¯»');
  btn.setAttribute('aria-pressed', on ? 'true' : 'false');
  btn.title = on ? 'å†æ¬¡ç‚¹å‡»åœæ­¢' : 'ç‚¹å‡»å¼€å§‹æœ—è¯»';
  btn.innerHTML = (on ? 'â¹ ' : 'ğŸ”Š ') + '<span>' + base + '</span>';
}

(function initTTS(){
  const btn = document.getElementById('ttsBtn'); if(!btn) return;
  btn.dataset.baseLabel = btn.querySelector('span')?.textContent || 'æœ—è¯»';
  setTTSState(false);

  // æœ—è¯»æŒ‰é’®
  btn.addEventListener('click', ()=>{
    const synth = window.speechSynthesis;
    if (!synth) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»');
    if (__isReading || synth.speaking) { synth.cancel(); setTTSState(false); return; }
    const readingText = document.getElementById('readingText');
    const html = (readingText && (readingText.innerHTML || '')).trim();
    if (!html) return;
    speakFromHTML(html);
  });

  // è¯­é€Ÿæ»‘æ†
  const rate = document.getElementById('rateCtrl');
  const rateVal = document.getElementById('rateVal');
  if(rate && rateVal){
    rate.value = String(window.__TTS_RATE.toFixed(2));
    rateVal.textContent = rate.value + 'Ã—';
    rate.addEventListener('input', ()=>{
      window.__TTS_RATE = Number(rate.value) || 1.0;
      rateVal.textContent = rate.value + 'Ã—';
      localStorage.setItem('__TTS_RATE', String(window.__TTS_RATE));
    });
  }

  // i18n åˆ·æ–°é’©å­ä¿æŒæŒ‰é’®æ–‡å­—
  const orig = window.__I18N_REFRESH;
  window.__I18N_REFRESH = function(){
    if (typeof orig==='function') orig();
    btn.dataset.baseLabel = btn.querySelector('span')?.textContent || btn.dataset.baseLabel || 'æœ—è¯»';
    setTTSState(__isReading);
  };
})();

/* ==============
   äº‹ä»¶ç»‘å®š
================ */
const goBtn = $('#go');
const spreadSel = $('#spread');
const qInput = $('#question');
const qDisplay = $('#qdisplay');
const readingPanel = $('#reading');
const readingText = $('#readingText');

qInput.addEventListener('input', ()=>{
  qDisplay.textContent = qInput.value ? ((CUR==='en-US'?'Question: ':'é—®é¢˜ï¼š') + qInput.value) : t('ui.tip_focus');
});

goBtn.addEventListener('click', ()=>{
  const n = parseInt(spreadSel.value,10);
  const picks = draw(n);
  window.__LAST_PICKS = picks;
  renderBoard(n, picks);

  const q = qInput.value || (CUR==='en-US'?'(No question)':'ï¼ˆæœªå¡«å†™é—®é¢˜ï¼‰');
  const html = renderReadingLocalized(q, n, picks);
  readingText.innerHTML = html;
  readingPanel.style.display = 'block';

  if (window.__I18N_REFRESH) window.__I18N_REFRESH();
});

/* è¯­è¨€åˆ‡æ¢ï¼šåº”ç”¨ UIã€é‡ç»˜å½“å‰å†…å®¹ã€åˆ‡æ¢ TTS è¯­è¨€ */
function refreshAll(){
  applyStaticUI();
  // é‡æ–°ç»™æ£‹ç›˜ä¸Šçš„æ ‡é¢˜/ç®€æ„æœ¬åœ°åŒ–
  const picks = window.__LAST_PICKS || null;
  if(picks){
    const n = parseInt(spreadSel.value,10);
    renderBoard(n, picks);
    const q = qInput.value || '';
    readingText.innerHTML = renderReadingLocalized(q, n, picks);
    readingPanel.style.display = 'block';
  }
  if (window.__I18N_REFRESH) window.__I18N_REFRESH();
}
langSel.addEventListener('change', ()=>{
  CUR = langSel.value in I18N ? langSel.value : FALLBACK;
  refreshAll();
});

/* é¦–æ¬¡åŠ è½½ï¼šæŒ‰æµè§ˆå™¨è¯­è¨€è®¾ç½®ä¸€æ¬¡ UI */
refreshAll();
</script>
</body>
</html>
