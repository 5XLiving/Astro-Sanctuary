<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å¡”ç½—ç‰Œå åœ Â· 5X</title>
<style>
/* ======================
   THEME Â· VARIABLES
====================== */
:root{
  --bg:#0b0f14;          /* é¡µé¢èƒŒæ™¯ */
  --card:#11161dcc;      /* å¡ç‰‡åº•è‰² */
  --line:#1f2a36;        /* è¾¹æ¡†çº¿ */
  --text:#e8edf3;        /* å¤‡ç”¨æµ…å­—è‰² */
  --muted:#98a7b7;       /* æ¬¡çº§æ–‡å­— */
  --gold:#e6c76e;        /* ä¸»é‡‘è‰² */
  --brand:#d4af37;       /* å“ç‰Œé‡‘è‰²æ›´åé»„ */
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;        /* ç‰Œå¡å®½ï¼ˆæ¡Œé¢ï¼‰ */
  --card-h:212px;        /* ç‰Œå¡é«˜ï¼ˆæ¡Œé¢ï¼‰ */
  --gap:14px;            /* æ …æ ¼é—´è· */
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* ç»Ÿä¸€é‡‘è‰²å­—ä½“ï¼ˆå åœåŒº & ä¸»è¦æ­£æ–‡ï¼‰ */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* æ·±è‰²æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼‰ */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* é€‰å‡ å¼ ç‰Œçš„ UIï¼ˆä»…æ ·å¼ï¼ŒåŠŸèƒ½ç”¨ JS æ¥ï¼‰ */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD Â· CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* å•å¼ å¡ç‰‡ç»„ä»¶ï¼ˆå›¾+æ ‡é¢˜+ç®€æ„ï¼‰ */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 å¼  */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 å¼ ï¼ˆæ¨ªæ’ï¼‰ */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 å¼ ï¼ˆåå­—ï¼‰ */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 å¼ ï¼š3-3-4 å±…ä¸­ï¼ˆè¡Œå®¹å™¨æ³•ï¼Œä¿è¯æ¯è¡Œå±…ä¸­ï¼‰ */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}

/* æ¯ä¸€è¡Œéƒ½æ˜¯ç‹¬ç«‹çš„ gridï¼Œä¾¿äºå±…ä¸­ä¸‰åˆ—æˆ–å››åˆ— */
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center; /* è¡Œå†…æ•´ä½“å±…ä¸­ */
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* ä½ç½®æ ‡è®°ï¼ˆc1..c10ï¼‰ä»…ç”¨äºè¯­ä¹‰ï¼Œå®é™…å¸ƒå±€äº¤ç»™ row å®¹å™¨ */
.c1,.c2,.c3,.c4,.c5,.c6,.c7,.c8,.c9,.c10{}

/* =================
   PANELS / BLOCKS
================= */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* ä»£ç å—æ ·å¼ï¼ˆä¸ index ä¿æŒä¸€è‡´çš„æ·±è‰²è¾¹æ¡† & é‡‘è‰²æ–‡å­—ï¼‰ */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* å°å¾½ç«  & é€†ä½æ ‡è®° */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{
    --card-w:100px;
    --card-h:166px;
    --gap:12px;
  }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  /* 10å¼ å°å±ï¼šæŒ‰ä¸¤åˆ—æµå¼æ’å¸ƒï¼Œé¿å…æ‹¥æŒ¤ */
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>

</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh">ç®€ä½“ä¸­æ–‡</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">å¡”ç½—ç‰Œå åœ</h1>
  <div class="controls">
    <input id="question" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">å•å¼ </option>
      <option value="3" data-i18n="s3">ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰</option>
      <option value="5" data-i18n="s5">åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰</option>
      <option value="10" data-i18n="s10">å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰</option>
    </select>
    <button id="go" data-i18n="draw_btn">æŠ½ç‰Œ</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      <span data-i18n="reading_title">è§£è¯»ä¸å»ºè®®</span>
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">ğŸ”Š <span data-i18n="tts_btn">æœ—è¯»</span></button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted" data-i18n="disclaimer">
    è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚
  </div>
</div>

<script>
/** TarotApp v1.0 â€” æŠ½å®Œç‰Œå†è§£è¯»ï¼ˆä¸ç°æœ‰ HTML/CSS å¯¹æ¥ï¼‰ **/
(function(){
  // ---------- å·¥å…· ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const rnd = n => Math.floor(Math.random()*n);
  const choice = arr => arr[rnd(arr.length)];

  // ---------- é—®é¢˜åˆ†ç±» ----------
  function classifyQuestion(q){
    q = (q||'').toLowerCase();
    const love = ['æ‹','çˆ±','å–œæ¬¢','æ„Ÿæƒ…','æš§æ˜§','ç»“å©š','åˆ†æ‰‹','å¤åˆ','å¥¹ä¼šä¸ä¼š','ä»–ä¼šä¸ä¼š','will she','will he','relationship','love'];
    const career = ['å·¥ä½œ','å‡èŒ','è·³æ§½','offer','äº‹ä¸š','è€æ¿','åŒäº‹','é¡¹ç›®','ç”²æ–¹','æŠ•æ ‡','career','job'];
    const money = ['é’±','è´¢','æ”¶å…¥','æŠ•èµ„','ç”Ÿæ„','é¡¾å®¢','é”€å”®','å›æ¬¾','èŠ±åº—','ç›ˆåˆ©','äº','é¢„ç®—','roas','è´¢åŠ¡','money'];
    const health = ['å¥åº·','èº«ä½“','ç–¾ç—…','å¤å¥','ç¡çœ ','å¤´ç—›','ç„¦è™‘','æŠ‘éƒ','ä½“æ£€','health'];
    if(love.some(k=>q.includes(k))) return 'love';
    if(career.some(k=>q.includes(k))) return 'career';
    if(money.some(k=>q.includes(k))) return 'money';
    if(health.some(k=>q.includes(k))) return 'health';
    return 'general';
  }

  // ---------- ç‰Œåº“ï¼ˆç¨‹åºç”Ÿæˆ 78 å¼ ï¼‰ ----------
  const SUITS = [
    {key:'wands',    zh:'æƒæ–', domain:'è¡ŒåŠ¨/çƒ­æƒ…', axis:['è¡ŒåŠ¨','æ‹“å±•','é©±åŠ¨åŠ›']},
    {key:'cups',     zh:'åœ£æ¯', domain:'æƒ…æ„Ÿ/å…³ç³»', axis:['æƒ…æ„Ÿ','è¿ç»“','å…±é¸£']},
    {key:'swords',   zh:'å®å‰‘', domain:'æ€ç»´/æ²Ÿé€š', axis:['æ€è€ƒ','æ´å¯Ÿ','è¡¨è¾¾']},
    {key:'pentacles',zh:'é’±å¸', domain:'ç°å®/èµ„æº', axis:['ç‰©è´¨','ç¨³å®š','æ‰§è¡Œ']}
  ];
  const RANKS = [
    {id:'ace', zh:'ä¸€',  tone:'èµ·ç‚¹/æ½œèƒ½'},
    {id:'2',   zh:'äºŒ',  tone:'å¯¹è¯/é€‰æ‹©'},
    {id:'3',   zh:'ä¸‰',  tone:'åä½œ/æˆé•¿'},
    {id:'4',   zh:'å››',  tone:'ç»“æ„/ç¨³å®š'},
    {id:'5',   zh:'äº”',  tone:'æŒ‘æˆ˜/æ³¢åŠ¨'},
    {id:'6',   zh:'å…­',  tone:'äº¤æµ/æ”¯æŒ'},
    {id:'7',   zh:'ä¸ƒ',  tone:'è¯„ä¼°/è€å¿ƒ'},
    {id:'8',   zh:'å…«',  tone:'æ¨è¿›/æ•ˆç‡'},
    {id:'9',   zh:'ä¹',  tone:'æˆæœ/è´Ÿæ‹…'},
    {id:'10',  zh:'å',  tone:'é˜¶æ®µå®Œæˆ'},
    {id:'page',zh:'ä¾ä»',tone:'è®¯æ¯/å­¦ä¹ '},
    {id:'knight', zh:'éª‘å£«',tone:'è¡ŒåŠ¨/æ¨åŠ¨'},
    {id:'queen', zh:'çš‡å',tone:'æˆç†Ÿ/æ»‹å…»'},
    {id:'king',  zh:'å›½ç‹',tone:'æŒæ§/å®šè°ƒ'},
  ];
  const MAJORS = [
    'æ„šè€…','é­”æœ¯å¸ˆ','å¥³ç¥­å¸','å¥³çš‡','çš‡å¸','æ•™çš‡','æ‹äºº','æˆ˜è½¦','åŠ›é‡','éšè€…','å‘½è¿ä¹‹è½®','æ­£ä¹‰','å€’åŠäºº','æ­»ç¥','èŠ‚åˆ¶','æ¶é­”','é«˜å¡”','æ˜Ÿæ˜Ÿ','æœˆäº®','å¤ªé˜³','å®¡åˆ¤','ä¸–ç•Œ'
  ];
  function buildDeck(){
    const deck = [];
    // å¤§é˜¿å°”å¡é‚£ 0-21
    MAJORS.forEach((name,i)=>{
      deck.push({id:`major_${String(i).padStart(2,'0')}`, name:name, group:'major', idx:i});
    });
    // å°é˜¿å°”å¡é‚£ 4Ã—14
    SUITS.forEach(s=>{
      RANKS.forEach(r=>{
        deck.push({id:`${s.key}_${r.id}`, name:`${s.zh}${r.zh}`, group:'minor', suit:s, rank:r});
      });
    });
    return deck;
  }
  const DECK = buildDeck();

  // å›¾ç‰‡è·¯å¾„ï¼ˆæŒ‰ä½ ç´ æå‘½åè§„åˆ™æ”¹å†™å³å¯ï¼‰
  function imgFor(card){
    // ç¤ºä¾‹ï¼š/img/tarot/{id}.webp ï¼›è‹¥æ²¡æœ‰å›¾ç‰‡ï¼Œç”¨å ä½
    return `/img/tarot/${card.id}.webp`;
  }

  // ---------- ç‰Œé˜µå®šä¹‰ï¼ˆä½ç½®æ ‡ç­¾ & è¯­ä¹‰è§’è‰²ï¼‰ ----------
  const SPREADS = {
    1:  { layout:'spread-1',  positions:[{key:'single', label:'å½“ä¸‹æ ¸å¿ƒ'}]},
    3:  { layout:'spread-3',  positions:[
          {key:'past', label:'è¿‡å»'},
          {key:'present', label:'ç°åœ¨'},
          {key:'future', label:'æœªæ¥'},
        ]},
    5:  { layout:'spread-5',  positions:[
          {key:'top', label:'æŒ‡å¼•/ä¸»é¢˜',   cls:'pos-top'},
          {key:'left',label:'è¿‡å»æ ¹æº',     cls:'pos-left'},
          {key:'center',label:'å½“ä¸‹æ ¸å¿ƒ',   cls:'pos-center'},
          {key:'right',label:'å¤–åœ¨å½±å“',    cls:'pos-right'},
          {key:'bottom',label:'æœªæ¥å‘å±•',   cls:'pos-bottom'},
        ]},
    10: { layout:'spread-10', positions:[
          {key:'p1',label:'å½“ä¸‹'}, {key:'p2',label:'é˜»ç¢'}, {key:'p3',label:'æ½œæ„è¯†'},
          {key:'p4',label:'è¿‡å»'}, {key:'p5',label:'æ˜¾æ„è¯†'}, {key:'p6',label:'æœªæ¥'},
          {key:'p7',label:'è‡ªæˆ‘'}, {key:'p8',label:'ç¯å¢ƒ'},   {key:'p9',label:'å¸Œæœ›/ææƒ§'},
          {key:'p10',label:'ç»“æœ'},
        ]}
  };

  // ---------- æŠ½ç‰Œ ----------
  function draw(n){
    const pool = [...DECK];
    const picks = [];
    for(let i=0;i<n;i++){
      const idx = rnd(pool.length);
      const card = pool.splice(idx,1)[0];
      // 50% é€†ä½
      card.reversed = Math.random()<0.5;
      picks.push(card);
    }
    return picks;
  }

  // ---------- æ¸²æŸ“æ£‹ç›˜ ----------
  function renderBoard(n, cards){
    const board = $('#board');
    board.className = 'board'; // reset
    const conf = SPREADS[n];
    if(!conf){ board.innerHTML=''; return; }

    board.classList.add(conf.layout);

    if(n === 10){
      // 3-3-4 å±…ä¸­ï¼šä¸‰è¡Œå®¹å™¨
      board.innerHTML = `
        <div class="row row-1"></div>
        <div class="row row-2"></div>
        <div class="row row-3"></div>
      `;
      const rows = $$('#board .row');
      const slots = [3,3,4];
      let k=0;
      slots.forEach((count,rowi)=>{
        for(let j=0;j<count;j++){
          const c = cards[k++];
          rows[rowi].appendChild(cardNode(c, `c${k}`, conf.positions[k-1]?.label || `ç¬¬${k}ä½`));
        }
      });
    }else{
      // 1/3/5ï¼šç›´æ’æˆ–åå­—
      board.innerHTML = '';
      cards.forEach((c,i)=>{
        const pos = conf.positions[i];
        const node = cardNode(c, `c${i+1} ${pos?.cls||''}`, pos?.label || `ç¬¬${i+1}ä½`);
        board.appendChild(node);
      });
    }
  }

  function cardNode(card, cls, posLabel){
    const div = document.createElement('div');
    div.className = `card ${cls||''}`;
    div.setAttribute('data-card-id', card.id);
    div.setAttribute('data-reversed', card.reversed?'true':'false');

    const img = document.createElement('img');
    img.className = 'card-img';
    img.src = imgFor(card);
    img.alt = card.name;
    const wrap = document.createElement('div');
    wrap.className = 'imgwrap';
    if(card.reversed) wrap.style.transform = 'rotate(180deg)';

    const cap  = document.createElement('div'); cap.className='cap';
    cap.textContent = `ã€${posLabel}ã€‘${card.name} ${card.reversed?'(é€†ä½)':'(æ­£ä½)'}`;

    const mean = document.createElement('div'); mean.className='mean';
    mean.textContent = previewLine(card);

    wrap.appendChild(img);
    div.appendChild(wrap);
    div.appendChild(cap);
    div.appendChild(mean);
    return div;
  }

  // ---------- è§£è¯»å¼•æ“ï¼ˆæ¨¡æ¿ç»„åˆï¼‰ ----------
  const MAJOR_ARCH = [
    ['æ„šè€…','è‡ªç”±/è·ƒè¿','æ‹¥æŠ±æœªçŸ¥ï¼Œè½»è£…å¯ç¨‹'],
    ['é­”æœ¯å¸ˆ','æ„å¿—/æ˜¾åŒ–','é›†ä¸­èµ„æºï¼Œç«‹å³è¡ŒåŠ¨'],
    ['å¥³ç¥­å¸','ç›´è§‰/æ½œæ„è¯†','å…ˆè§‚å¯Ÿï¼Œåè¡¨æ€'],
    ['å¥³çš‡','æ»‹å…»/ä¸°ç››','ä»¥æ¸©æŸ”ä¸ç…§æ–™ä¿ƒè¿›æˆé•¿'],
    ['çš‡å¸','ç§©åº/ç»“æ„','å®šè§„åˆ™ã€ç«‹è¾¹ç•Œã€ç»™å®‰å…¨æ„Ÿ'],
    ['æ•™çš‡','è§„èŒƒ/ä¼ æ‰¿','éµå¾ªåˆ¶åº¦ä¸é•¿è¾ˆå»ºè®®'],
    ['æ‹äºº','é€‰æ‹©/è¿ç»“','å¯¹é½ä»·å€¼è§‚å†æ‰¿è¯º'],
    ['æˆ˜è½¦','æ¨è¿›/èƒœè´Ÿ','å®šç›®æ ‡ï¼Œå¼ºåŠ¿æ¨è¿›'],
    ['åŠ›é‡','å‹‡æ°”/æ¸©æŸ”','ä»¥æŸ”å…‹åˆšï¼Œç¨³å®šè€å¿ƒ'],
    ['éšè€…','å†…çœ/ç‹¬å¤„','æ”¶å¿ƒå®¡è§†ï¼Œç‹¬ç«‹åˆ¤æ–­'],
    ['å‘½è¿ä¹‹è½®','å‘¨æœŸ/æœºç¼˜','é¡ºåŠ¿è€Œä¸ºï¼ŒæŠ“æ—¶æœº'],
    ['æ­£ä¹‰','è¡¡é‡/å…¬å¹³','ä»¥äº‹å®ä¸è¾¹ç•Œè§£å†³'],
    ['å€’åŠäºº','åœæ­¢/æ¢è§’','æš‚ç¼“æ¨è¿›ï¼Œæ¢ä½æ€è€ƒ'],
    ['æ­»ç¥','ç»“æŸ/é‡ç”Ÿ','æœæ–­æ­¢æŸï¼Œè¿æ¥æ–°ç”Ÿ'],
    ['èŠ‚åˆ¶','è°ƒå’Œ/èŠ‚å¾‹','é™å¼ºåº¦ï¼Œç¨³èŠ‚å¥'],
    ['æ¶é­”','æ‰§è‘—/è¯±æƒ‘','è¾¨ä¾èµ–ï¼Œæ–­ä¸è‰¯å¾ªç¯'],
    ['é«˜å¡”','çªå˜/ç“¦è§£','æ¥çº³å˜åŒ–ï¼Œå¿«é€Ÿé‡ç»„'],
    ['æ˜Ÿæ˜Ÿ','å¸Œæœ›/å¤åŸ','é‡å»ºä¿¡ä»»ï¼Œæ¸©æŸ”ä¿®å¤'],
    ['æœˆäº®','è¿·é›¾/ä¸å®‰','æ¨è¿Ÿé‡å¤§å†³å®šï¼Œå…ˆæŸ¥æ˜'],
    ['å¤ªé˜³','æ¸…æ™°/å–œæ‚¦','å…¬å¼€é€æ˜ï¼Œåº†ç¥æˆæœ'],
    ['å®¡åˆ¤','è§‰é†’/å¬å›','å›åº”å¬å”¤ï¼Œçº åå¤ç›˜'],
    ['ä¸–ç•Œ','å®Œæˆ/æ•´åˆ','é—­ç¯ä¸å‡çº§ï¼Œå¼€å¯æ–°ç¯‡']
  ];

  function previewLine(card){
    if(card.group==='major'){
      const row = MAJOR_ARCH[card.idx];
      return `${row[1]} Â· ${row[2]}`;
    }else{
      return `${card.suit.zh}ï¼ˆ${card.suit.domain}ï¼‰Â· ${card.rank.tone}`;
    }
  }

  const POS_HINT = {
    past:['å›é¡¾è¿‡å»ç»éªŒï¼Œæ‰¾å¯å¤ç”¨æˆ–éœ€æ”¾ä¸‹çš„éƒ¨åˆ†'],
    present:['æè¿°å½“å‰æ ¸å¿ƒçŸ›ç›¾ä¸å…³é”®å˜é‡'],
    future:['ç»™å‡ºä¸¤æ­¥ä»¥å†…å¯æ‰§è¡ŒåŠ¨ä½œï¼Œé¿å…ç©ºè°ˆæ„¿æ™¯'],
    top:['ä»¥â€œä¸»é¢˜/åŸåˆ™â€å®šè°ƒå½“ä¸‹é€‰æ‹©'],
    left:['è¯†åˆ«å†å²æƒ¯æ€§ä¸æ—§ä¿¡å¿µçš„å½±å“'],
    center:['èšç„¦æ­¤åˆ»çœŸæ­£è¦è§£å†³çš„ä¸€ä»¶äº‹'],
    right:['è¯„ä¼°å¤–éƒ¨å› ç´ /ä»–äººç«‹åœº'],
    bottom:['è§„åˆ’æ¥ä¸‹æ¥ 1-3 å‘¨çš„è·¯å¾„'],
    p1:['æè¿°å½“ä¸‹çŠ¶æ€ä¸ä¸»è¦å¼ åŠ›'],
    p2:['æŒ‡å‡ºé˜»ç¢ä¸å¯¹ç­–'],
    p3:['ç‚¹ç ´æ½œæ„è¯†åŠ¨æœº/ææƒ§'],
    p4:['å›é¡¾æˆå› ä¸æ—¢å¾€æ¨¡å¼'],
    p5:['çœ¼å‰è®¤çŸ¥ä¸æ˜¾æ€§ç›®æ ‡'],
    p6:['æœªæ¥ 1-6 å‘¨çš„è¶‹åŠ¿'],
    p7:['è‡ªæˆ‘å®šä½ä¸è§’è‰²é€‰æ‹©'],
    p8:['ç¯å¢ƒ/ä»–äºº/æƒ…å¢ƒå½±å“'],
    p9:['å¸Œæœ›ä¸ææƒ§çš„ä¸¤é¢'],
    p10:['é˜¶æ®µæ€§ç»“æœä¸è°ƒæ•´å»ºè®®'],
    single:['æç‚¼æœ¬æ¬¡å åœçš„å”¯ä¸€å…³é”®è¡ŒåŠ¨']
  };

  const DOMAIN_ADV = {
    love:{
      major: (row,rev)=> rev? 'å…ˆæ”¾æ…¢è¡¨è¾¾å¼ºåº¦ï¼Œå°Šé‡å¯¹æ–¹è¾¹ç•Œä¸èŠ‚å¥' : 'ä»¥çœŸè¯šä¸ç¨³å®šè¡ŒåŠ¨å»ºç«‹å®‰å…¨æ„Ÿ',
      wands: rev=>'é¿å…æƒ…ç»ªåŒ–æ¨è¿›ï¼Œå…ˆç¡®è®¤å½¼æ­¤æ„æ„¿',
      cups:  rev=>'å…ˆè‡ªç¨³æƒ…ç»ªï¼Œæ‰è°ˆéœ€æ±‚ä¸äº²å¯†',
      swords:rev=>'å‡å°‘è´¨é—®ï¼Œå¤šç”¨æ¾„æ¸…å¼æé—®',
      pentacles:rev=>'å°‘ç‰©è´¨å¯¹å†²ï¼Œå¤šé«˜è´¨é‡ç›¸å¤„'
    },
    career:{
      major: (row,rev)=> rev? 'ä¿®æ­£æ–¹å‘ä¸åˆ†å·¥ï¼Œåˆ«ç¡¬æ¨' : 'åˆ¶å®šé‡Œç¨‹ç¢‘ä¸è´Ÿè´£çŸ©é˜µ',
      wands: rev=>'æ§åˆ¶èŠ‚å¥ï¼Œæ‹†å°æ­¥',
      cups:  rev=>'å‡èšå›¢é˜Ÿæƒ…ç»ªï¼Œæé«˜åä½œ',
      swords:rev=>'ç”¨æ•°æ®ä¸äº‹å®é¿å…å†…è€—',
      pentacles:rev=>'å…ˆè¡¥èµ„æºä¸æµç¨‹åå†æ‰©å¼ '
    },
    money:{
      major: (row,rev)=> rev? 'æ”¶ç¼©é£é™©ï¼Œç°é‡‘æµä¼˜å…ˆ' : 'è°¨æ…æ‰©å¼ ï¼ŒæŒ‡æ ‡é©±åŠ¨',
      wands: rev=>'é™æˆæœ¬/ææ•ˆå¹¶è¡Œ',
      cups:  rev=>'æ…é€‰åˆä½œï¼Œæ˜ç¡®åˆ†è´¦',
      swords:rev=>'å¤ç›˜æ¨¡å‹ä¸å‡è®¾',
      pentacles:rev=>'åº“å­˜/é¢„ç®—/è´¹ç”¨ä¸‰è¡¨è”åŠ¨'
    },
    health:{
      major: (row,rev)=> rev? 'å…ˆä¼‘æ¯ä¸å°±åŒ»è¯„ä¼°' : 'å»ºç«‹ä½œæ¯ä¸è½»è¿åŠ¨',
      wands: rev=>'é¿å…è¿‡é‡è®­ç»ƒ',
      cups:  rev=>'æƒ…ç»ªæŠ¤ç†ä¸æ”¯æŒ',
      swords:rev=>'å‡å‹ä¸ç¡çœ ä¼˜å…ˆ',
      pentacles:rev=>'è§„å¾‹é¥®é£Ÿä¸ä½“æ£€'
    },
    general:{
      major: (row,rev)=> rev? 'å…ˆç¨³ä½å†å†³ç­–' : 'å°æ­¥éªŒè¯ï¼Œé€æ­¥æ¨è¿›',
      wands: rev=>'æ”¾ç¼“èŠ‚å¥ï¼Œèšç„¦ä¸€ä»¶äº‹',
      cups:  rev=>'ä¼˜å…ˆå…³ç³»è´¨é‡',
      swords:rev=>'å…ˆä¿¡æ¯å¯¹é½',
      pentacles:rev=>'å…ˆåšå¯è½åœ°èµ„æºé…ç½®'
    }
  };

  function cardAdviceByDomain(card, qtype){
    const dom = DOMAIN_ADV[qtype] || DOMAIN_ADV.general;
    if(card.group==='major'){
      const row = MAJOR_ARCH[card.idx];
      const a = typeof dom.major==='function' ? dom.major(row, card.reversed) : dom.major;
      return [a];
    }
    const key = card.suit.key; // wands/cups/swords/pentacles
    const fn = dom[key] || dom.general;
    const a = typeof fn==='function' ? fn(card.reversed) : fn;
    // ç»“åˆç‚¹æ•°è¯­ä¹‰å¾®è°ƒ
    const note = card.rank.tone;
    return [a, `å›´ç»•â€œ${note}â€åˆ¶å®šä¸€æ¡æœ¬å‘¨å¯æ‰§è¡Œçš„è¡ŒåŠ¨`];
  }

  function positionNudge(posKey){
    return POS_HINT[posKey] ? `ï¼ˆä½ç½®æç¤ºï¼š${POS_HINT[posKey][0]}ï¼‰` : '';
  }

  function buildReading(question, spreadN, cards){
    const qtype = classifyQuestion(question);
    const conf = SPREADS[spreadN];
    let out = [];
    out.push(`<div class="chat">`);
    out.push(`<div class="msg user"><div class="meta">ä½ </div>${escapeHTML(question||'ï¼ˆæœªå¡«å†™é—®é¢˜ï¼‰')}</div>`);
    out.push(`<div class="msg assistant"><div class="meta">è§£è¯»</div>`);

    const blocks = [];
    if(spreadN===10){
      const posKeys = ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p10'];
      cards.forEach((c,i)=>{
        const pk = posKeys[i];
        blocks.push(sectionLine(conf.positions[i].label, c, pk, qtype));
      });
    }else if(spreadN===5){
      const posKeys = ['top','left','center','right','bottom'];
      cards.forEach((c,i)=> blocks.push(sectionLine(conf.positions[i].label, c, posKeys[i], qtype)));
    }else if(spreadN===3){
      const posKeys = ['past','present','future'];
      cards.forEach((c,i)=> blocks.push(sectionLine(conf.positions[i].label, c, posKeys[i], qtype)));
    }else{
      const posKeys = ['single'];
      blocks.push(sectionLine('å½“ä¸‹æ ¸å¿ƒ', cards[0], posKeys[0], qtype));
    }

    out.push(blocks.join(''));
    // æ€»ç»“ & ä¸‹ä¸€æ­¥
    out.push(`<hr style="border:0;border-top:1px solid #273245;margin:12px 0">`);
    out.push(`<b>ä¸‹ä¸€æ­¥ï¼ˆ48 å°æ—¶å†…ï¼‰ï¼š</b><br>â‘  å†™ä¸‹ 1 æ¡ä¸é—®é¢˜æœ€ç›¸å…³çš„â€œå°ç›®æ ‡â€ï¼›â‘¡ å®‰æ’ 1 ä¸ªå…·ä½“è¡ŒåŠ¨ï¼ˆå¯åœ¨æ—¥å†ä¸Šï¼‰ï¼›â‘¢ ç”¨ 3 ä¸ªå®¢è§‚æŒ‡æ ‡è¡¡é‡æ•ˆæœï¼ˆä¾‹å¦‚ï¼šå›å¤é¢‘ç‡ã€é¢è°ˆæ—¶é•¿ã€å®é™…æˆäº¤/é¢„çº¦ï¼‰ã€‚`);
    out.push(`</div>`);
    out.push(`</div>`);
    return out.join('');
  }

  function sectionLine(label, card, posKey, qtype){
    const title = `ã€${label}ã€‘${card.name}${card.reversed?'ï¼ˆé€†ä½ï¼‰':'ï¼ˆæ­£ä½ï¼‰'}`;
    const arch = (card.group==='major')
      ? `${MAJOR_ARCH[card.idx][1]} Â· ${MAJOR_ARCH[card.idx][2]}`
      : `${card.suit.zh}ï¼ˆ${card.suit.domain}ï¼‰Â· ${card.rank.tone}`;
    const tips = cardAdviceByDomain(card, qtype);
    const pos = positionNudge(posKey);
    const list = tips.map(t=>`<li>${t}</li>`).join('');
    return `
      <div style="margin:8px 0 12px">
        <div style="font-weight:700">${title}</div>
        <div class="muted" style="margin:4px 0">${arch} ${pos}</div>
        <ul style="margin:6px 0 0 18px">${list}</ul>
      </div>
    `;
  }

  function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  // ---------- TTS ----------
  function speak(html){
    const s = window.speechSynthesis;
    if(!s) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»');
    const u = new SpeechSynthesisUtterance(strip(html));
    u.lang = 'zh-CN';
    u.rate = 1.0;
    s.cancel(); s.speak(u);
    function strip(h){const d=document.createElement('div'); d.innerHTML=h; return d.textContent||d.innerText||'';}
  }

  // ---------- äº‹ä»¶ ----------
  const goBtn = $('#go');
  const spreadSel = $('#spread');
  const qInput = $('#question');
  const qDisplay = $('#qdisplay');
  const readingPanel = $('#reading');
  const readingText = $('#readingText');
  const ttsBtn = $('#ttsBtn');

  qInput.addEventListener('input', ()=>{ qDisplay.textContent = qInput.value ? `é—®é¢˜ï¼š${qInput.value}` : 'ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰'; });

  goBtn.addEventListener('click', ()=>{
    const n = parseInt(spreadSel.value,10);
    const picks = draw(n);
    renderBoard(n, picks);
    // æŠ½å®Œå†è§£è¯»
    const html = buildReading(qInput.value, n, picks);
    readingText.innerHTML = html;
    readingPanel.style.display = 'block';
  });

  ttsBtn.addEventListener('click', ()=>{
    const txt = readingText.innerText || readingText.textContent || '';
    if(!txt.trim()) return;
    speak(txt);
  });
})();
</script>
</body>
</html>
