<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>5X · 塔罗指引（专业版）</title>
<style>
  :root{
    --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
    --brand:#d4af37; --accent:#58b9ff; --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family: ui-sans-serif, Inter, system-ui, -apple-system, "PingFang SC", "Microsoft Yahei", Segoe UI, Roboto, Helvetica, Arial;
    background:
      radial-gradient(1200px 600px at 70% -10%, #16202b 10%, transparent 60%) no-repeat,
      linear-gradient(180deg,#0b0f14,#0b0f14);
  }
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .title{font-size:22px;letter-spacing:.5px;color:var(--text);display:flex;align-items:center;gap:10px}
  .title .badge{font-size:12px;color:#0b0f14;background:var(--brand);padding:2px 8px;border-radius:999px}
  .panel{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .spacer{height:14px}
  .tab{
    padding:.6rem 1rem;border:1px solid var(--line);border-radius:12px;cursor:pointer;background:transparent;color:var(--text);
    transition:.2s;
  }
  .tab:hover{border-color:#2f3b49}
  .tab.active{border-color:var(--brand); box-shadow:0 0 0 2px rgba(212,175,55,.18)}
  .confirm{
    padding:.7rem 1.1rem;border:1px solid var(--brand);border-radius:12px;background:transparent;color:var(--brand);cursor:pointer;font-weight:600;
  }
  .confirm:disabled{opacity:.5;cursor:not-allowed}
  .note{font-size:12px;color:var(--muted)}
  .board{display:flex;gap:18px;flex-wrap:wrap}
  .cardbox{display:flex;flex-direction:column;align-items:center;gap:10px}
  .card-img{width:160px;height:260px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#0e141b}
  .cap{font-size:13px;color:var(--muted)}
  .field{flex:1;min-width:240px}
  .input{
    width:100%;padding:.7rem 1rem;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);
    outline:none;
  }
  .footer{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
  .link{color:var(--brand);text-decoration:none;border-bottom:1px dotted var(--brand)}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">塔罗指引 <span class="badge">专业</span></div>
  <div class="spacer"></div>

  <!-- 控制区 -->
  <div class="panel">
    <div class="row">
      <button class="tab" data-spread="1">抽单张</button>
      <button class="tab" data-spread="3">抽三张（过去/现在/未来）</button>

      <button id="btn-draw" class="confirm">确认抽牌</button>
      <button id="btn-redraw" class="confirm" style="display:none">重抽</button>

      <div class="field">
        <input id="q" class="input" placeholder="（可选）写下你的问题，仅用于记录与分享链接，不影响结果" />
      </div>
    </div>
    <div class="spacer"></div>
    <div class="note">说明：请选择排阵后再点击【确认抽牌】。结果会在本机保留 24 小时；你也可以复制“可复现链接”分享或保存。</div>
  </div>

  <div class="spacer"></div>

  <!-- 结果区 -->
  <div class="panel">
    <div id="board" class="board"></div>
    <div class="spacer"></div>
    <div class="footer">
      <div class="note" id="meta"></div>
      <div class="row">
        <a id="share" class="link" href="#">复制可复现链接</a>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== 配置：你的牌面图片目录（最后不要漏斜杠） ====== */
const TAROT_ASSET_PATH = "assets/tarot/"; // e.g. assets/tarot/00_Fool.jpg
const PLACEHOLDER_IMG  = TAROT_ASSET_PATH + "placeholder.jpg";

/* ====== 牌组（示例仅列大阿尔卡那，你可扩展到78张） ====== */
const MAJORS = [
  "00_Fool","01_Magician","02_High_Priestess","03_Empress","04_Emperor",
  "05_Hierophant","06_Lovers","07_Chariot","08_Strength","09_Hermit",
  "10_Wheel","11_Justice","12_Hanged_Man","13_Death","14_Temperance",
  "15_Devil","16_Tower","17_Star","18_Moon","19_Sun","20_Judgement","21_World"
];
// 如需 78 张：把四套花色加入到 DECK 中即可
const DECK = [...MAJORS];

(function(){
  const LS_KEY = 'tarot_state_v1';
  const DEFAULT = { spread: 1, cards: [], ts: 0, q: '' };

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const spreadTabs = $$('.tab');
  const btnDraw    = $('#btn-draw');
  const btnRedraw  = $('#btn-redraw');
  const board      = $('#board');
  const meta       = $('#meta');
  const inputQ     = $('#q');
  const shareLink  = $('#share');

  // ---- 状态读写 ----
  const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || {...DEFAULT}; } catch { return {...DEFAULT}; } };
  const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));

  // ---- 工具 ----
  const setActiveTab = (spread) => spreadTabs.forEach(t => t.classList.toggle('active', +t.dataset.spread === +spread));
  const pad2 = n => String(n).padStart(2,'0');
  const fmt  = ts => {
    if(!ts) return '';
    const d = new Date(ts);
    const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
    const h=pad2(d.getHours()), mi=pad2(d.getMinutes());
    return `${y}-${m}-${da} ${h}:${mi}`;
  };
  const imgPath = name => `${TAROT_ASSET_PATH}${name}.jpg`;

  // 稳定图片：失败回占位
  function makeImg(name){
    const img = new Image();
    img.loading = "eager";
    img.decoding = "sync";
    img.className = "card-img";
    img.alt = name;
    img.src = imgPath(name);
    img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER_IMG; };
    return img;
  }

  // 可复现随机（Park–Miller LCG）
  function seededPick(n, seed){
    let s = seed || Date.now();
    const rnd = () => (s = (s * 48271) % 0x7fffffff) / 0x7fffffff;
    const pool = [...DECK];
    const out = [];
    for(let i=0;i<n;i++){
      const idx = Math.floor(rnd()*pool.length);
      out.push(pool.splice(idx,1)[0]);
    }
    return out;
  }

  function draw(spread){
    const seed = Date.now();
    const cards = seededPick(spread, seed);
    const q = inputQ.value || '';
    const state = { spread, cards, ts: seed, q };
    save(state);
    render(state);
  }

  function render(state){
    setActiveTab(state.spread);
    inputQ.value = state.q || '';
    board.innerHTML = '';
    const labels = state.spread === 3 ? ["过去","现在","未来"] : ["当下"];
    state.cards.forEach((c, i) => {
      const box = document.createElement('div');
      box.className = 'cardbox';
      box.appendChild(makeImg(c));
      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = labels[i] || '';
      box.appendChild(cap);
      board.appendChild(box);
    });
    btnRedraw.style.display = state.cards.length ? '' : 'none';

    // 元信息
    const kept = state.cards.length ? `已抽于 ${fmt(state.ts)} · 保留 24 小时（本机）` : `尚未抽牌`;
    meta.textContent = kept + (state.q ? ` · 主题：「${state.q}」` : '');

    // 分享链接（包含 spread/seed/q）
    const u = new URL(location.href);
    u.searchParams.set('spread', state.spread);
    if(state.cards.length) u.searchParams.set('seed', state.ts);
    else u.searchParams.delete('seed');
    if(state.q) u.searchParams.set('q', state.q); else u.searchParams.delete('q');
    shareLink.href = u.toString();
  }

  // ---- 事件 ----
  spreadTabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      const s = load();
      s.spread = +tab.dataset.spread;
      s.cards = []; // 切换排阵不自动出结果
      save(s);
      render(s);
    });
  });

  btnDraw.addEventListener('click', ()=>{
    const s = load();
    draw(s.spread || 1);
  });

  btnRedraw.addEventListener('click', ()=>{
    const s = load();
    draw(s.spread || 1);
  });

  shareLink.addEventListener('click', (e)=>{
    e.preventDefault();
    try{
      navigator.clipboard.writeText(shareLink.href);
      shareLink.textContent = "已复制可复现链接";
      setTimeout(()=> shareLink.textContent = "复制可复现链接", 1500);
    }catch{
      window.prompt("复制下方链接：", shareLink.href);
    }
  });

  // ---- 首次加载：支持 ?spread & ?seed & ?q 参数；24h后仅保留排阵 ----
  const url = new URL(location.href);
  const qsSpread = +url.searchParams.get('spread');
  const qsSeed   = +url.searchParams.get('seed');
  const qsQ      = url.searchParams.get('q') || '';

  let state = load();

  if (qsSpread === 1 || qsSpread === 3) state.spread = qsSpread;
  if (qsQ) state.q = qsQ;

  if (qsSeed && !Number.isNaN(qsSeed)) {
    // 复现模式：用 seed 生成同一手牌
    state.ts = qsSeed;
    state.cards = seededPick(state.spread, qsSeed);
  } else {
    // 普通恢复：过期清空结果
    const within24h = (Date.now() - (state.ts||0)) < 24*60*60*1000;
    if (!within24h) { state.cards = []; state.ts = 0; }
  }

  save(state);
  render(state);
})();
</script>
</body>
</html>
