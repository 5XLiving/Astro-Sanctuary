<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · Tarot</title>
<style>
/* ======================
   THEME · VARIABLES
====================== */
:root{
  --bg:#0b0f14;
  --card:#11161dcc;
  --line:#1f2a36;
  --text:#e8edf3;
  --muted:#98a7b7;
  --gold:#e6c76e;
  --brand:#d4af37;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;
  --card-h:212px;
  --gap:14px;
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* 统一金色字体（占卜区 & 主要正文） */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* 深色滚动条（可选） */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* 选几张牌的 UI（仅样式，功能用 JS 接） */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD · CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* 单张卡片组件（图+标题+简意） */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 张 */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 张（横排） */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 张（十字） */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 张：3-3-4 居中（行容器法，保证每行居中） */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center;
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* ===============
   PANELS / BLOCKS
=============== */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* 代码块样式 */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* 小徽章 & 逆位标记 */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{ --card-w:100px; --card-h:166px; --gap:12px; }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>
</head>

<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">Tarot</div>
      <div class="title" data-i18n="brand_title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh-CN">简体中文</option>
        <option value="en-US">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">塔罗牌占卜</h1>
  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">单张</option>
      <option value="3" data-i18n="s3">三张（过去 / 现在 / 未来）</option>
      <option value="5" data-i18n="s5">十字排法（5张）</option>
      <option value="10" data-i18n="s10">凯尔特十字（10张）</option>
    </select>
    <button id="go" data-i18n="draw_btn">抽牌</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
<h3 style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
  <span data-i18n="reading_title">解读与建议</span>
  <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">🔊 <span data-i18n="tts_btn">朗读</span></button>
  <label class="muted" style="display:inline-flex;align-items:center;gap:8px">
    <span>语速</span>
    <input id="rateCtrl" type="range" min="0.70" max="1.30" step="0.05" value="0.90" style="width:120px">
    <span id="rateVal">0.90×</span>
  </label>
</h3>
<div id="readingText"></div>

  <div class="panel muted" data-i18n="disclaimer">
    说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。
  </div>
</div>

<script>
/* ===========================
   I18N（中文/英文）
=========================== */
const I18N = {
  'zh-CN': {
    ui: {
      page_title: '塔罗牌占卜',
      q_ph:'请输入你的问题（必填，决定解读方向）',
      s1:'单张', s3:'三张（过去 / 现在 / 未来）', s5:'十字排法（5张）', s10:'凯尔特十字（10张）',
      draw_btn:'抽牌',
      tip_focus:'（提示：输入问题会让解读更聚焦）',
      reading_title:'解读与建议',
      tts_btn:'朗读',
      tts_tip_start:'点击开始朗读',
      tts_tip_stop:'再次点击停止朗读',
      disclaimer:'说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。'
    },
    pos: {
      single:'当下核心', past:'过去', present:'现在', future:'未来',
      top:'指引/主题', left:'过去根源', center:'当下核心', right:'外在影响', bottom:'未来发展',
      p1:'当下', p2:'阻碍', p3:'潜意识', p4:'过去', p5:'显意识', p6:'未来', p7:'自我', p8:'环境', p9:'希望/恐惧', p10:'结果'
    },
    suits: {
      wands:{name:'权杖', domain:'行动/热情'},
      cups:{name:'圣杯', domain:'情感/关系'},
      swords:{name:'宝剑', domain:'思维/沟通'},
      pentacles:{name:'钱币', domain:'现实/资源'}
    },
    ranks:{
      ace:'一','2':'二','3':'三','4':'四','5':'五','6':'六','7':'七','8':'八','9':'九','10':'十',
      page:'侍从', knight:'骑士', queen:'皇后', king:'国王',
      tone:{ ace:'起点/潜能','2':'对话/选择','3':'协作/成长','4':'结构/稳定','5':'挑战/波动','6':'交流/支持','7':'评估/耐心','8':'推进/效率','9':'成果/负担','10':'阶段完成', page:'讯息/学习', knight:'行动/推动', queen:'成熟/滋养', king:'掌控/定调'}
    },
    majors:[
      ['愚者','自由/跃迁','拥抱未知，轻装启程'],['魔术师','意志/显化','集中资源，立即行动'],['女祭司','直觉/潜意识','先观察，后表态'],['女皇','滋养/丰盛','以温柔与照料促进成长'],['皇帝','秩序/结构','定规则、立边界、给安全感'],['教皇','规范/传承','遵循制度与长辈建议'],['恋人','选择/连结','对齐价值观再承诺'],['战车','推进/胜负','定目标，强势推进'],['力量','勇气/温柔','以柔克刚，稳定耐心'],['隐者','内省/独处','收心审视，独立判断'],['命运之轮','周期/机缘','顺势而为，抓时机'],['正义','衡量/公平','以事实与边界解决'],['倒吊人','停止/换角','暂缓推进，换位思考'],['死神','结束/重生','果断止损，迎接新生'],['节制','调和/节律','降强度，稳节奏'],['恶魔','执著/诱惑','辨依赖，断不良循环'],['高塔','突变/瓦解','接纳变化，快速重组'],['星星','希望/复原','重建信任，温柔修复'],['月亮','迷雾/不安','推迟重大决定，先查明'],['太阳','清晰/喜悦','公开透明，庆祝成果'],['审判','觉醒/召回','回应召唤，纠偏复盘'],['世界','完成/整合','闭环与升级，开启新篇']
    ],
    tags:{upright:'正位', reversed:'逆位'},
    nextSteps:'<b>下一步（48 小时内）：</b><br>① 写下 1 条小目标；② 安排 1 个具体行动（加到日历）；③ 用 3 个客观指标衡量（如回复频率、面谈时长、实际成交/预约）。',
    posHint:{
      past:'回顾过去经验，找可复用或需放下的部分',
      present:'描述当前核心矛盾与关键变量',
      future:'给出两步以内可执行动作，避免空谈愿景',
      top:'以“主题/原则”定调当下选择',
      left:'识别历史惯性与旧信念的影响',
      center:'聚焦此刻真正要解决的一件事',
      right:'评估外部因素/他人立场',
      bottom:'规划接下来 1–3 周路径',
      p1:'描述当下状态与主要张力',
      p2:'指出阻碍与对策',
      p3:'点破潜意识动机/恐惧',
      p4:'回顾成因与既往模式',
      p5:'眼前认知与显性目标',
      p6:'未来 1–6 周的趋势',
      p7:'自我定位与角色选择',
      p8:'环境/他人/情境影响',
      p9:'希望与恐惧的两面',
      p10:'阶段性结果与调整建议',
      single:'提炼本次占卜的唯一关键行动'
    },
    domainAdvice:{
      love:{majorRev:'先放慢表达强度，尊重对方边界与节奏', majorOk:'以真诚与稳定行动建立安全感',
        wands:'避免情绪化推进，先确认彼此意愿',
        cups:'先自稳情绪，再谈需求与亲密',
        swords:'减少质问，多用澄清式提问',
        pentacles:'少物质对冲，多高质量相处'},
      career:{majorRev:'修正方向与分工，别硬推', majorOk:'制定里程碑与负责矩阵',
        wands:'控制节奏，拆小步',
        cups:'凝聚团队情绪，提高协作',
        swords:'用数据与事实避免内耗',
        pentacles:'先补资源/流程再扩张'},
      money:{majorRev:'收缩风险，现金流优先', majorOk:'谨慎扩张，指标驱动',
        wands:'降成本/提效并行',
        cups:'慎选合作，明确分账',
        swords:'复盘模型与假设',
        pentacles:'库存/预算/费用三表联动'},
      health:{majorRev:'先休息与就医评估', majorOk:'建立作息与轻运动',
        wands:'避免过量训练',
        cups:'情绪护理与支持',
        swords:'减压与睡眠优先',
        pentacles:'规律饮食与体检'},
      general:{majorRev:'先稳住再决策', majorOk:'小步验证，逐步推进',
        wands:'放缓节奏，聚焦一件事',
        cups:'优先关系质量',
        swords:'先信息对齐',
        pentacles:'先做可落地资源配置'}
    }
  },

  'en-US': {
    ui: {
      page_title:'Tarot Reading',
      q_ph:'Type your question (focuses the reading)',
      s1:'Single', s3:'Three (Past / Present / Future)', s5:'Cross (5)', s10:'Celtic Cross (10)',
      draw_btn:'Draw',
      tip_focus:'(Tip: a clear question focuses the reading)',
      reading_title:'Insights & Advice',
      tts_btn:'Read Aloud',
      tts_tip_start:'Press to read aloud',
      tts_tip_stop:'Press again to stop reading',
      disclaimer:'Tarot offers guidance, not medical/legal/financial advice. Use your judgment.'
    },
    pos:{single:'Core Now', past:'Past', present:'Present', future:'Future',
         top:'Theme/Guidance', left:'Roots', center:'Core Now', right:'External', bottom:'Development',
         p1:'Present', p2:'Obstacle', p3:'Subconscious', p4:'Past', p5:'Conscious', p6:'Future', p7:'Self', p8:'Environment', p9:'Hopes/Fears', p10:'Outcome'},
    suits:{
      wands:{name:'Wands', domain:'Action/Passion'},
      cups:{name:'Cups', domain:'Emotion/Relations'},
      swords:{name:'Swords', domain:'Mind/Communication'},
      pentacles:{name:'Pentacles', domain:'Material/Resources'}
    },
    ranks:{
      ace:'Ace','2':'Two','3':'Three','4':'Four','5':'Five','6':'Six','7':'Seven','8':'Eight','9':'Nine','10':'Ten',
      page:'Page', knight:'Knight', queen:'Queen', king:'King',
      tone:{ace:'Seed/Potential','2':'Duality/Choice','3':'Collab/Growth','4':'Structure/Stability','5':'Challenge/Flux','6':'Exchange/Support','7':'Evaluate/Patience','8':'Momentum/Efficiency','9':'Result/Burden','10':'Completion',
            page:'Message/Learning', knight:'Action/Drive', queen:'Maturity/Nurture', king:'Authority/Setting Tone'}
    },
    majors:[
      ['The Fool','Freedom/Leap','Embrace the unknown; travel light'],
      ['The Magician','Will/Manifest','Align resources; act now'],
      ['The High Priestess','Intuition/Subconscious','Observe first, speak later'],
      ['The Empress','Nurture/Abundance','Gentle care grows results'],
      ['The Emperor','Order/Structure','Set rules and safety'],
      ['The Hierophant','Norms/Tradition','Follow guidance and standards'],
      ['The Lovers','Choice/Union','Align values before commitment'],
      ['The Chariot','Push/Win','Pick a target; drive forward'],
      ['Strength','Courage/Gentleness','Soft power, steady patience'],
      ['The Hermit','Introspect/Alone','Withdraw to assess'],
      ['Wheel of Fortune','Cycle/Timing','Ride the turn; seize timing'],
      ['Justice','Measure/Fairness','Facts and boundaries solve it'],
      ['The Hanged Man','Pause/Reframe','Wait; see from another angle'],
      ['Death','Ending/Rebirth','Cut losses; welcome renewal'],
      ['Temperance','Blend/Rhythm','Lower intensity; steady cadence'],
      ['The Devil','Attachment/Temptation','Name the bind; break the loop'],
      ['The Tower','Shock/Collapse','Accept change; rebuild swiftly'],
      ['The Star','Hope/Recovery','Restore trust; heal gently'],
      ['The Moon','Fog/Anxiety','Delay big moves; verify facts'],
      ['The Sun','Clarity/Joy','Be open; celebrate wins'],
      ['Judgement','Awakening/Call','Answer the call; correct course'],
      ['The World','Completion/Integration','Close the loop; level up']
    ],
    tags:{upright:'Upright', reversed:'Reversed'},
    nextSteps:'<b>Next 48h:</b><br>(1) Write one small goal; (2) Schedule one concrete action; (3) Track 3 objective metrics (e.g., reply cadence, meeting time, actual bookings).',
    posHint:{
      past:'Extract reusable lessons or what to release',
      present:'Name the core tension and variables',
      future:'Give 1–2 actionable next steps',
      top:'Set principles to guide choices',
      left:'Spot legacy patterns/beliefs',
      center:'Focus on the one real problem',
      right:'Weigh external factors/others',
      bottom:'Plan next 1–3 weeks',
      p1:'Describe current state and tension',
      p2:'Point out obstacle and counter-move',
      p3:'Expose hidden motives/fears',
      p4:'Review causes and patterns',
      p5:'Conscious goal and frame',
      p6:'Trend for next 1–6 weeks',
      p7:'Your role/stance',
      p8:'Context and stakeholders',
      p9:'Hope vs fear twin view',
      p10:'Likely outcome & adjustment',
      single:'One key action for this session'
    },
    domainAdvice:{
      love:{majorRev:'Slow intensity; honor boundaries', majorOk:'Build safety with steady acts',
        wands:'Curb impulsive pushes; confirm consent',
        cups:'Regulate emotion before needs talk',
        swords:'Use clarifying questions over grilling',
        pentacles:'Less gifting; more quality time'},
      career:{majorRev:'Fix direction/roles before pushing', majorOk:'Milestones and RACI',
        wands:'Control pace; break into sprints',
        cups:'Rally morale; improve collaboration',
        swords:'Use data to avoid churn',
        pentacles:'Secure resources/process first'},
      money:{majorRev:'De-risk; protect cashflow', majorOk:'Cautious growth; KPI-led',
        wands:'Cut cost + raise efficiency',
        cups:'Choose partners carefully; clear split',
        swords:'Audit assumptions and model',
        pentacles:'Tie inventory/budget/expenses'},
      health:{majorRev:'Rest & seek evaluation', majorOk:'Routines + light exercise',
        wands:'Avoid over-training',
        cups:'Emotional support',
        swords:'Reduce stress; prioritize sleep',
        pentacles:'Diet regularity; check-ups'},
      general:{majorRev:'Stabilize before deciding', majorOk:'Validate in small steps',
        wands:'Slow down; single-task',
        cups:'Prioritize relationship quality',
        swords:'Align information first',
        pentacles:'Resource a concrete plan first'}
    }
  }
};

/* 小工具 */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rnd = n => Math.floor(Math.random()*n);

/* 语言处理 */
const FALLBACK = 'zh-CN';
function detectLang(){
  const nav=(navigator.language||'').toLowerCase();
  if(nav.startsWith('zh')) return 'zh-CN';
  if(nav.startsWith('en')) return 'en-US';
  return FALLBACK;
}
let CUR = detectLang();
const langSel = document.getElementById('langSel');
langSel.value = CUR;

/* t(): 读取文案 */
function t(path, dflt=''){
  const parts = path.split('.');
  let node = I18N[CUR];
  for(const p of parts){ if(!node) break; node=node[p]; }
  return node==null ? dflt : node;
}
window.t = t; // 供 TTS 提示用

/* 应用静态 UI 文案 */
function applyStaticUI(){
  $('[data-i18n="page_title"]').textContent = t('ui.page_title');
  $('[data-i18n="tip_focus"]').textContent = t('ui.tip_focus');
  $('[data-i18n="reading_title"]').textContent = t('ui.reading_title');
  $('[data-i18n="disclaimer"]').textContent = t('ui.disclaimer');
  $('#go').textContent = t('ui.draw_btn');
  // 下拉选项
  const spread = $('#spread');
  spread.options[0].textContent = t('ui.s1');
  spread.options[1].textContent = t('ui.s3');
  spread.options[2].textContent = t('ui.s5');
  spread.options[3].textContent = t('ui.s10');
  // 输入框 placeholder
  $('#question').setAttribute('placeholder', t('ui.q_ph'));
  // TTS 按钮文案
  const ttsSpan = $('#ttsBtn span'); if(ttsSpan) ttsSpan.textContent = t('ui.tts_btn');
}

/* ==============
   牌库 & 抽牌
================ */
const SUITS = [
  {key:'wands',    zh:'权杖'},
  {key:'cups',     zh:'圣杯'},
  {key:'swords',   zh:'宝剑'},
  {key:'pentacles',zh:'钱币'}
];
const RANKS = [
  {id:'ace', zh:'一'},{id:'2', zh:'二'},{id:'3', zh:'三'},{id:'4', zh:'四'},{id:'5', zh:'五'},
  {id:'6', zh:'六'},{id:'7', zh:'七'},{id:'8', zh:'八'},{id:'9', zh:'九'},{id:'10', zh:'十'},
  {id:'page', zh:'侍从'},{id:'knight', zh:'骑士'},{id:'queen', zh:'皇后'},{id:'king', zh:'国王'}
];
const MAJORS = Array.from({length:22},(_,i)=>i);

function buildDeck(){
  const deck=[];
  // majors
  MAJORS.forEach(i=>{
    const row = I18N['zh-CN'].majors[i]; // 仅取索引；名称在本地化函数里取
    deck.push({id:`major_${String(i).padStart(2,'0')}`, group:'major', idx:i});
  });
  // minors
  SUITS.forEach(s=>{
    RANKS.forEach(r=>{
      deck.push({id:`${s.key}_${r.id}`, group:'minor', suit:s.key, rank:r.id});
    });
  });
  return deck;
}
const DECK = buildDeck();
function draw(n){
  const pool=[...DECK], picks=[];
  for(let i=0;i<n;i++){
    const idx=rnd(pool.length);
    const card=pool.splice(idx,1)[0];
    card.reversed = Math.random()<0.5;
    picks.push(card);
  }
  return picks;
}
function imgFor(card){
  return `/img/tarot/${card.id}.webp`;
}

/* ==============
   布局定义
================ */
const SPREADS = {
  1:  { layout:'spread-1',  positions:[{key:'single'}]},
  3:  { layout:'spread-3',  positions:[{key:'past'},{key:'present'},{key:'future'}]},
  5:  { layout:'spread-5',  positions:[
        {key:'top',cls:'pos-top'}, {key:'left',cls:'pos-left'}, {key:'center',cls:'pos-center'},
        {key:'right',cls:'pos-right'}, {key:'bottom',cls:'pos-bottom'}
      ]},
  10: { layout:'spread-10', positions:[
        {key:'p1'},{key:'p2'},{key:'p3'},{key:'p4'},{key:'p5'},{key:'p6'},{key:'p7'},{key:'p8'},{key:'p9'},{key:'p10'}
      ]}
};

/* ==============
   本地化帮助
================ */
function cardName(card){
  if(card.group==='major'){
    return I18N[CUR].majors[card.idx][0];
  }else{
    const s=I18N[CUR].suits[card.suit];
    const r=I18N[CUR].ranks[card.rank] || card.rank.toUpperCase();
    return `${s.name}${r}`;
  }
}
function previewLineLocalized(card){
  if(card.group==='major'){
    const row = I18N[CUR].majors[card.idx];
    return `${row[1]} · ${row[2]}`;
  }else{
    const s = I18N[CUR].suits[card.suit];
    const tone = I18N[CUR].ranks.tone[card.rank];
    return `${s.name}（${s.domain}）· ${tone}`;
  }
}
function posLabel(key){ return I18N[CUR].pos[key] || key; }
function tagFor(rev){ return rev ? I18N[CUR].tags.reversed : I18N[CUR].tags.upright; }
function classifyQuestion(q){
  q=(q||'').toLowerCase();
  const love = ['恋','爱','喜欢','感情','暧昧','结婚','分手','复合','will she','will he','relationship','love'];
  const career=['工作','升职','跳槽','offer','事业','老板','同事','项目','career','job'];
  const money =['钱','财','收入','投资','生意','销售','预算','money'];
  const health=['健康','身体','疾病','睡眠','焦虑','抑郁','体检','health'];
  if(love.some(k=>q.includes(k))) return 'love';
  if(career.some(k=>q.includes(k))) return 'career';
  if(money.some(k=>q.includes(k))) return 'money';
  if(health.some(k=>q.includes(k))) return 'health';
  return 'general';
}

/* ==============
   渲染棋盘
================ */
function cardNode(card, cls, posKey){
  const div=document.createElement('div');
  div.className=`card ${cls||''}`;
  div.setAttribute('data-card-id', card.id);
  div.setAttribute('data-reversed', card.reversed?'true':'false');

  const wrap=document.createElement('div'); wrap.className='imgwrap';
  if(card.reversed) wrap.style.transform='rotate(180deg)';
  const img=document.createElement('img'); img.className='card-img'; img.src=imgFor(card); img.alt=cardName(card);
  wrap.appendChild(img);

  const cap=document.createElement('div'); cap.className='cap';
  cap.textContent = `【${posLabel(posKey)}】${cardName(card)}（${tagFor(card.reversed)}）`;

  const mean=document.createElement('div'); mean.className='mean';
  mean.textContent = previewLineLocalized(card);

  div.appendChild(wrap); div.appendChild(cap); div.appendChild(mean);
  return div;
}

function renderBoard(n, cards){
  const board = document.getElementById('board');
  board.className='board';
  const conf = SPREADS[n]; if(!conf){ board.innerHTML=''; return; }
  board.classList.add(conf.layout);

  if(n===10){
    board.innerHTML = `<div class="row row-1"></div><div class="row row-2"></div><div class="row row-3"></div>`;
    const rows = $$('#board .row'); const slots=[3,3,4];
    let k=0;
    slots.forEach((count,rowi)=>{
      for(let j=0;j<count;j++){
        const c = cards[k++];
        const posKey = conf.positions[k-1].key;
        rows[rowi].appendChild(cardNode(c, `c${k}`, posKey));
      }
    });
  }else{
    board.innerHTML='';
    cards.forEach((c,i)=>{
      const pos=conf.positions[i];
      board.appendChild(cardNode(c, `c${i+1} ${pos.cls||''}`, pos.key));
    });
  }
}

/* ==============
   动态解读
================ */
function renderReadingLocalized(question, n, cards){
  const domain = classifyQuestion(question);
  const posKeys = (n===10)? ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p10']
              : (n===5)?  ['top','left','center','right','bottom']
              : (n===3)?  ['past','present','future']
              : ['single'];

  const domAdv = I18N[CUR].domainAdvice[domain] || I18N[CUR].domainAdvice.general;

  const segments = cards.map((card,i)=>{
    const title = `【${posLabel(posKeys[i])}】${cardName(card)}（${tagFor(card.reversed)}）`;
    const arch  = previewLineLocalized(card);
    const hint  = I18N[CUR].posHint[posKeys[i]] ? `（${I18N[CUR].posHint[posKeys[i]]}）` : '';

    let adv1='';
    if(card.group==='major'){
      adv1 = card.reversed ? domAdv.majorRev : domAdv.majorOk;
    }else{
      const mapKey = card.suit; // wands/cups/swords/pentacles
      adv1 = domAdv[mapKey] || domAdv.general;
    }

    let adv2='';
    if(card.group!=='major'){
      const tone = I18N[CUR].ranks.tone[card.rank];
      adv2 = (CUR==='en-US')
        ? `Plan one actionable step around “${tone}”.`
        : `围绕“${tone}”制定一条可执行的小行动。`;
    }

    return `
      <div style="margin:8px 0 12px">
        <div style="font-weight:700">${title}</div>
        <div class="muted" style="margin:4px 0">${arch} ${hint}</div>
        <ul style="margin:6px 0 0 18px">
          <li>${adv1}</li>${adv2?`<li>${adv2}</li>`:''}
        </ul>
      </div>`;
  }).join('');

  const youLabel = (CUR==='en-US'?'You':'你');
  const readingLabel = (CUR==='en-US'?'Reading':'解读');

  return `<div class="chat">
    <div class="msg user"><div class="meta">${youLabel}</div>${escapeHTML(question||'')}</div>
    <div class="msg assistant"><div class="meta">${readingLabel}</div>
      ${segments}
      <hr style="border:0;border-top:1px solid #273245;margin:12px 0">
      ${I18N[CUR].nextSteps}
    </div>
  </div>`;
}

function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

/* ==============
   TTS（朗读切换，含多语言提示）
================ */
// ---- TTS: 清理符号 + 语速可调 ----
window.__TTS_LANG  = window.__TTS_LANG || 'zh-CN';
window.__TTS_RATE  = Number(localStorage.getItem('__TTS_RATE')||'0.90') || 0.90;

function cleanForTTS(text){
  if(!text) return '';
  let s = text.replace(/[【】\[\]（）()《》<>]/g, '');     // 去括号符号
  s = s.replace(/[，。！？、；：,.!?;:]{2,}/g, m=>m[0]);   // 合并重复标点
  s = s.replace(/\s{2,}/g, ' ').trim();                   // 合并空格
  return s;
}

function speakFromHTML(html){
  const synth = window.speechSynthesis;
  if (!synth) { alert('当前浏览器不支持语音朗读'); return; }
  const tmp = document.createElement('div'); tmp.innerHTML = html;
  const text = cleanForTTS(tmp.textContent || tmp.innerText || '');

  const u = new SpeechSynthesisUtterance(text);
  u.lang = window.__TTS_LANG || 'zh-CN';
  u.rate = window.__TTS_RATE;               // ← 使用可调语速
  u.onend = u.onpause = u.onerror = () => setTTSState(false);

  synth.cancel();
  synth.speak(u);
  setTTSState(true);
}

let __isReading = false;
function setTTSState(on){
  __isReading = !!on;
  const btn = document.getElementById('ttsBtn'); if(!btn) return;
  const base = (btn.dataset.baseLabel) || (btn.querySelector('span')?.textContent || '朗读');
  btn.setAttribute('aria-pressed', on ? 'true' : 'false');
  btn.title = on ? '再次点击停止' : '点击开始朗读';
  btn.innerHTML = (on ? '⏹ ' : '🔊 ') + '<span>' + base + '</span>';
}

(function initTTS(){
  const btn = document.getElementById('ttsBtn'); if(!btn) return;
  btn.dataset.baseLabel = btn.querySelector('span')?.textContent || '朗读';
  setTTSState(false);

  // 朗读按钮
  btn.addEventListener('click', ()=>{
    const synth = window.speechSynthesis;
    if (!synth) return alert('当前浏览器不支持语音朗读');
    if (__isReading || synth.speaking) { synth.cancel(); setTTSState(false); return; }
    const readingText = document.getElementById('readingText');
    const html = (readingText && (readingText.innerHTML || '')).trim();
    if (!html) return;
    speakFromHTML(html);
  });

  // 语速滑杆
  const rate = document.getElementById('rateCtrl');
  const rateVal = document.getElementById('rateVal');
  if(rate && rateVal){
    rate.value = String(window.__TTS_RATE.toFixed(2));
    rateVal.textContent = rate.value + '×';
    rate.addEventListener('input', ()=>{
      window.__TTS_RATE = Number(rate.value) || 1.0;
      rateVal.textContent = rate.value + '×';
      localStorage.setItem('__TTS_RATE', String(window.__TTS_RATE));
    });
  }

  // i18n 刷新钩子保持按钮文字
  const orig = window.__I18N_REFRESH;
  window.__I18N_REFRESH = function(){
    if (typeof orig==='function') orig();
    btn.dataset.baseLabel = btn.querySelector('span')?.textContent || btn.dataset.baseLabel || '朗读';
    setTTSState(__isReading);
  };
})();

/* ==============
   事件绑定
================ */
const goBtn = $('#go');
const spreadSel = $('#spread');
const qInput = $('#question');
const qDisplay = $('#qdisplay');
const readingPanel = $('#reading');
const readingText = $('#readingText');

qInput.addEventListener('input', ()=>{
  qDisplay.textContent = qInput.value ? ((CUR==='en-US'?'Question: ':'问题：') + qInput.value) : t('ui.tip_focus');
});

goBtn.addEventListener('click', ()=>{
  const n = parseInt(spreadSel.value,10);
  const picks = draw(n);
  window.__LAST_PICKS = picks;
  renderBoard(n, picks);

  const q = qInput.value || (CUR==='en-US'?'(No question)':'（未填写问题）');
  const html = renderReadingLocalized(q, n, picks);
  readingText.innerHTML = html;
  readingPanel.style.display = 'block';

  if (window.__I18N_REFRESH) window.__I18N_REFRESH();
});

/* 语言切换：应用 UI、重绘当前内容、切换 TTS 语言 */
function refreshAll(){
  applyStaticUI();
  // 重新给棋盘上的标题/简意本地化
  const picks = window.__LAST_PICKS || null;
  if(picks){
    const n = parseInt(spreadSel.value,10);
    renderBoard(n, picks);
    const q = qInput.value || '';
    readingText.innerHTML = renderReadingLocalized(q, n, picks);
    readingPanel.style.display = 'block';
  }
  if (window.__I18N_REFRESH) window.__I18N_REFRESH();
}
langSel.addEventListener('change', ()=>{
  CUR = langSel.value in I18N ? langSel.value : FALLBACK;
  refreshAll();
});

/* 首次加载：按浏览器语言设置一次 UI */
refreshAll();
</script>
</body>
</html>
