<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · 5X</title>
<style>
/* ======================
   THEME · VARIABLES
====================== */
:root{
  --bg:#0b0f14;          /* 页面背景 */
  --card:#11161dcc;      /* 卡片底色 */
  --line:#1f2a36;        /* 边框线 */
  --text:#e8edf3;        /* 备用浅字色 */
  --muted:#98a7b7;       /* 次级文字 */
  --gold:#e6c76e;        /* 主金色 */
  --brand:#d4af37;       /* 品牌金色更偏黄 */
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;        /* 牌卡宽（桌面） */
  --card-h:212px;        /* 牌卡高（桌面） */
  --gap:14px;            /* 栅格间距 */
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* 统一金色字体（占卜区 & 主要正文） */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* 深色滚动条（可选） */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* 选几张牌的 UI（仅样式，功能用 JS 接） */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD · CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* 单张卡片组件（图+标题+简意） */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 张 */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 张（横排） */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 张（十字） */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 张：3-3-4 居中（行容器法，保证每行居中） */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}

/* 每一行都是独立的 grid，便于居中三列或四列 */
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center; /* 行内整体居中 */
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* 位置标记（c1..c10）仅用于语义，实际布局交给 row 容器 */
.c1,.c2,.c3,.c4,.c5,.c6,.c7,.c8,.c9,.c10{}

/* =================
   PANELS / BLOCKS
================= */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* 代码块样式（与 index 保持一致的深色边框 & 金色文字） */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* 小徽章 & 逆位标记 */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{
    --card-w:100px;
    --card-h:166px;
    --gap:12px;
  }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  /* 10张小屏：按两列流式排布，避免拥挤 */
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>

</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand_title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh">简体中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">塔罗牌占卜</h1>
  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">单张</option>
      <option value="3" data-i18n="s3">三张（过去 / 现在 / 未来）</option>
      <option value="5" data-i18n="s5">十字排法（5张）</option>
      <option value="10" data-i18n="s10">凯尔特十字（10张）</option>
    </select>
    <button id="go" data-i18n="draw_btn">抽牌</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      <span data-i18n="reading_title">解读与建议</span>
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">🔊 <span data-i18n="tts_btn">朗读</span></button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted" data-i18n="disclaimer">
    说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。
  </div>
</div>

<script>
/** TarotApp v1.0 — 抽完牌再解读（与现有 HTML/CSS 对接） **/
(function(){
  // ---------- 工具 ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const rnd = n => Math.floor(Math.random()*n);
  const choice = arr => arr[rnd(arr.length)];

  // ---------- 问题分类 ----------
  function classifyQuestion(q){
    q = (q||'').toLowerCase();
    const love = ['恋','爱','喜欢','感情','暧昧','结婚','分手','复合','她会不会','他会不会','will she','will he','relationship','love'];
    const career = ['工作','升职','跳槽','offer','事业','老板','同事','项目','甲方','投标','career','job'];
    const money = ['钱','财','收入','投资','生意','顾客','销售','回款','花店','盈利','亏','预算','roas','财务','money'];
    const health = ['健康','身体','疾病','复健','睡眠','头痛','焦虑','抑郁','体检','health'];
    if(love.some(k=>q.includes(k))) return 'love';
    if(career.some(k=>q.includes(k))) return 'career';
    if(money.some(k=>q.includes(k))) return 'money';
    if(health.some(k=>q.includes(k))) return 'health';
    return 'general';
  }

  // ---------- 牌库（程序生成 78 张） ----------
  const SUITS = [
    {key:'wands',    zh:'权杖', domain:'行动/热情', axis:['行动','拓展','驱动力']},
    {key:'cups',     zh:'圣杯', domain:'情感/关系', axis:['情感','连结','共鸣']},
    {key:'swords',   zh:'宝剑', domain:'思维/沟通', axis:['思考','洞察','表达']},
    {key:'pentacles',zh:'钱币', domain:'现实/资源', axis:['物质','稳定','执行']}
  ];
  const RANKS = [
    {id:'ace', zh:'一',  tone:'起点/潜能'},
    {id:'2',   zh:'二',  tone:'对话/选择'},
    {id:'3',   zh:'三',  tone:'协作/成长'},
    {id:'4',   zh:'四',  tone:'结构/稳定'},
    {id:'5',   zh:'五',  tone:'挑战/波动'},
    {id:'6',   zh:'六',  tone:'交流/支持'},
    {id:'7',   zh:'七',  tone:'评估/耐心'},
    {id:'8',   zh:'八',  tone:'推进/效率'},
    {id:'9',   zh:'九',  tone:'成果/负担'},
    {id:'10',  zh:'十',  tone:'阶段完成'},
    {id:'page',zh:'侍从',tone:'讯息/学习'},
    {id:'knight', zh:'骑士',tone:'行动/推动'},
    {id:'queen', zh:'皇后',tone:'成熟/滋养'},
    {id:'king',  zh:'国王',tone:'掌控/定调'},
  ];
  const MAJORS = [
    '愚者','魔术师','女祭司','女皇','皇帝','教皇','恋人','战车','力量','隐者','命运之轮','正义','倒吊人','死神','节制','恶魔','高塔','星星','月亮','太阳','审判','世界'
  ];
  function buildDeck(){
    const deck = [];
    // 大阿尔卡那 0-21
    MAJORS.forEach((name,i)=>{
      deck.push({id:`major_${String(i).padStart(2,'0')}`, name:name, group:'major', idx:i});
    });
    // 小阿尔卡那 4×14
    SUITS.forEach(s=>{
      RANKS.forEach(r=>{
        deck.push({id:`${s.key}_${r.id}`, name:`${s.zh}${r.zh}`, group:'minor', suit:s, rank:r});
      });
    });
    return deck;
  }
  const DECK = buildDeck();

  // 图片路径（按你素材命名规则改写即可）
  function imgFor(card){
    // 示例：/img/tarot/{id}.webp ；若没有图片，用占位
    return `/img/tarot/${card.id}.webp`;
  }

  // ---------- 牌阵定义（位置标签 & 语义角色） ----------
  const SPREADS = {
    1:  { layout:'spread-1',  positions:[{key:'single', label:'当下核心'}]},
    3:  { layout:'spread-3',  positions:[
          {key:'past', label:'过去'},
          {key:'present', label:'现在'},
          {key:'future', label:'未来'},
        ]},
    5:  { layout:'spread-5',  positions:[
          {key:'top', label:'指引/主题',   cls:'pos-top'},
          {key:'left',label:'过去根源',     cls:'pos-left'},
          {key:'center',label:'当下核心',   cls:'pos-center'},
          {key:'right',label:'外在影响',    cls:'pos-right'},
          {key:'bottom',label:'未来发展',   cls:'pos-bottom'},
        ]},
    10: { layout:'spread-10', positions:[
          {key:'p1',label:'当下'}, {key:'p2',label:'阻碍'}, {key:'p3',label:'潜意识'},
          {key:'p4',label:'过去'}, {key:'p5',label:'显意识'}, {key:'p6',label:'未来'},
          {key:'p7',label:'自我'}, {key:'p8',label:'环境'},   {key:'p9',label:'希望/恐惧'},
          {key:'p10',label:'结果'},
        ]}
  };

  // ---------- 抽牌 ----------
  function draw(n){
    const pool = [...DECK];
    const picks = [];
    for(let i=0;i<n;i++){
      const idx = rnd(pool.length);
      const card = pool.splice(idx,1)[0];
      // 50% 逆位
      card.reversed = Math.random()<0.5;
      picks.push(card);
    }
    return picks;
  }

  // ---------- 渲染棋盘 ----------
  function renderBoard(n, cards){
    const board = $('#board');
    board.className = 'board'; // reset
    const conf = SPREADS[n];
    if(!conf){ board.innerHTML=''; return; }

    board.classList.add(conf.layout);

    if(n === 10){
      // 3-3-4 居中：三行容器
      board.innerHTML = `
        <div class="row row-1"></div>
        <div class="row row-2"></div>
        <div class="row row-3"></div>
      `;
      const rows = $$('#board .row');
      const slots = [3,3,4];
      let k=0;
      slots.forEach((count,rowi)=>{
        for(let j=0;j<count;j++){
          const c = cards[k++];
          rows[rowi].appendChild(cardNode(c, `c${k}`, conf.positions[k-1]?.label || `第${k}位`));
        }
      });
    }else{
      // 1/3/5：直排或十字
      board.innerHTML = '';
      cards.forEach((c,i)=>{
        const pos = conf.positions[i];
        const node = cardNode(c, `c${i+1} ${pos?.cls||''}`, pos?.label || `第${i+1}位`);
        board.appendChild(node);
      });
    }
  }

  function cardNode(card, cls, posLabel){
    const div = document.createElement('div');
    div.className = `card ${cls||''}`;
    div.setAttribute('data-card-id', card.id);
    div.setAttribute('data-reversed', card.reversed?'true':'false');

    const img = document.createElement('img');
    img.className = 'card-img';
    img.src = imgFor(card);
    img.alt = card.name;
    const wrap = document.createElement('div');
    wrap.className = 'imgwrap';
    if(card.reversed) wrap.style.transform = 'rotate(180deg)';

    const cap  = document.createElement('div'); cap.className='cap';
    cap.textContent = `【${posLabel}】${card.name} ${card.reversed?'(逆位)':'(正位)'}`;

    const mean = document.createElement('div'); mean.className='mean';
    mean.textContent = previewLine(card);

    wrap.appendChild(img);
    div.appendChild(wrap);
    div.appendChild(cap);
    div.appendChild(mean);
    return div;
  }

  // ---------- 解读引擎（模板组合） ----------
  const MAJOR_ARCH = [
    ['愚者','自由/跃迁','拥抱未知，轻装启程'],
    ['魔术师','意志/显化','集中资源，立即行动'],
    ['女祭司','直觉/潜意识','先观察，后表态'],
    ['女皇','滋养/丰盛','以温柔与照料促进成长'],
    ['皇帝','秩序/结构','定规则、立边界、给安全感'],
    ['教皇','规范/传承','遵循制度与长辈建议'],
    ['恋人','选择/连结','对齐价值观再承诺'],
    ['战车','推进/胜负','定目标，强势推进'],
    ['力量','勇气/温柔','以柔克刚，稳定耐心'],
    ['隐者','内省/独处','收心审视，独立判断'],
    ['命运之轮','周期/机缘','顺势而为，抓时机'],
    ['正义','衡量/公平','以事实与边界解决'],
    ['倒吊人','停止/换角','暂缓推进，换位思考'],
    ['死神','结束/重生','果断止损，迎接新生'],
    ['节制','调和/节律','降强度，稳节奏'],
    ['恶魔','执著/诱惑','辨依赖，断不良循环'],
    ['高塔','突变/瓦解','接纳变化，快速重组'],
    ['星星','希望/复原','重建信任，温柔修复'],
    ['月亮','迷雾/不安','推迟重大决定，先查明'],
    ['太阳','清晰/喜悦','公开透明，庆祝成果'],
    ['审判','觉醒/召回','回应召唤，纠偏复盘'],
    ['世界','完成/整合','闭环与升级，开启新篇']
  ];

  function previewLine(card){
    if(card.group==='major'){
      const row = MAJOR_ARCH[card.idx];
      return `${row[1]} · ${row[2]}`;
    }else{
      return `${card.suit.zh}（${card.suit.domain}）· ${card.rank.tone}`;
    }
  }

  const POS_HINT = {
    past:['回顾过去经验，找可复用或需放下的部分'],
    present:['描述当前核心矛盾与关键变量'],
    future:['给出两步以内可执行动作，避免空谈愿景'],
    top:['以“主题/原则”定调当下选择'],
    left:['识别历史惯性与旧信念的影响'],
    center:['聚焦此刻真正要解决的一件事'],
    right:['评估外部因素/他人立场'],
    bottom:['规划接下来 1-3 周的路径'],
    p1:['描述当下状态与主要张力'],
    p2:['指出阻碍与对策'],
    p3:['点破潜意识动机/恐惧'],
    p4:['回顾成因与既往模式'],
    p5:['眼前认知与显性目标'],
    p6:['未来 1-6 周的趋势'],
    p7:['自我定位与角色选择'],
    p8:['环境/他人/情境影响'],
    p9:['希望与恐惧的两面'],
    p10:['阶段性结果与调整建议'],
    single:['提炼本次占卜的唯一关键行动']
  };

  const DOMAIN_ADV = {
    love:{
      major: (row,rev)=> rev? '先放慢表达强度，尊重对方边界与节奏' : '以真诚与稳定行动建立安全感',
      wands: rev=>'避免情绪化推进，先确认彼此意愿',
      cups:  rev=>'先自稳情绪，才谈需求与亲密',
      swords:rev=>'减少质问，多用澄清式提问',
      pentacles:rev=>'少物质对冲，多高质量相处'
    },
    career:{
      major: (row,rev)=> rev? '修正方向与分工，别硬推' : '制定里程碑与负责矩阵',
      wands: rev=>'控制节奏，拆小步',
      cups:  rev=>'凝聚团队情绪，提高协作',
      swords:rev=>'用数据与事实避免内耗',
      pentacles:rev=>'先补资源与流程后再扩张'
    },
    money:{
      major: (row,rev)=> rev? '收缩风险，现金流优先' : '谨慎扩张，指标驱动',
      wands: rev=>'降成本/提效并行',
      cups:  rev=>'慎选合作，明确分账',
      swords:rev=>'复盘模型与假设',
      pentacles:rev=>'库存/预算/费用三表联动'
    },
    health:{
      major: (row,rev)=> rev? '先休息与就医评估' : '建立作息与轻运动',
      wands: rev=>'避免过量训练',
      cups:  rev=>'情绪护理与支持',
      swords:rev=>'减压与睡眠优先',
      pentacles:rev=>'规律饮食与体检'
    },
    general:{
      major: (row,rev)=> rev? '先稳住再决策' : '小步验证，逐步推进',
      wands: rev=>'放缓节奏，聚焦一件事',
      cups:  rev=>'优先关系质量',
      swords:rev=>'先信息对齐',
      pentacles:rev=>'先做可落地资源配置'
    }
  };

  function cardAdviceByDomain(card, qtype){
    const dom = DOMAIN_ADV[qtype] || DOMAIN_ADV.general;
    if(card.group==='major'){
      const row = MAJOR_ARCH[card.idx];
      const a = typeof dom.major==='function' ? dom.major(row, card.reversed) : dom.major;
      return [a];
    }
    const key = card.suit.key; // wands/cups/swords/pentacles
    const fn = dom[key] || dom.general;
    const a = typeof fn==='function' ? fn(card.reversed) : fn;
    // 结合点数语义微调
    const note = card.rank.tone;
    return [a, `围绕“${note}”制定一条本周可执行的行动`];
  }

  function positionNudge(posKey){
    return POS_HINT[posKey] ? `（位置提示：${POS_HINT[posKey][0]}）` : '';
  }

  function buildReading(question, spreadN, cards){
    const qtype = classifyQuestion(question);
    const conf = SPREADS[spreadN];
    let out = [];
    out.push(`<div class="chat">`);
    out.push(`<div class="msg user"><div class="meta">你</div>${escapeHTML(question||'（未填写问题）')}</div>`);
    out.push(`<div class="msg assistant"><div class="meta">解读</div>`);

    const blocks = [];
    if(spreadN===10){
      const posKeys = ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p10'];
      cards.forEach((c,i)=>{
        const pk = posKeys[i];
        blocks.push(sectionLine(conf.positions[i].label, c, pk, qtype));
      });
    }else if(spreadN===5){
      const posKeys = ['top','left','center','right','bottom'];
      cards.forEach((c,i)=> blocks.push(sectionLine(conf.positions[i].label, c, posKeys[i], qtype)));
    }else if(spreadN===3){
      const posKeys = ['past','present','future'];
      cards.forEach((c,i)=> blocks.push(sectionLine(conf.positions[i].label, c, posKeys[i], qtype)));
    }else{
      const posKeys = ['single'];
      blocks.push(sectionLine('当下核心', cards[0], posKeys[0], qtype));
    }

    out.push(blocks.join(''));
    // 总结 & 下一步
    out.push(`<hr style="border:0;border-top:1px solid #273245;margin:12px 0">`);
    out.push(`<b>下一步（48 小时内）：</b><br>① 写下 1 条与问题最相关的“小目标”；② 安排 1 个具体行动（可在日历上）；③ 用 3 个客观指标衡量效果（例如：回复频率、面谈时长、实际成交/预约）。`);
    out.push(`</div>`);
    out.push(`</div>`);
    return out.join('');
  }

  function sectionLine(label, card, posKey, qtype){
    const title = `【${label}】${card.name}${card.reversed?'（逆位）':'（正位）'}`;
    const arch = (card.group==='major')
      ? `${MAJOR_ARCH[card.idx][1]} · ${MAJOR_ARCH[card.idx][2]}`
      : `${card.suit.zh}（${card.suit.domain}）· ${card.rank.tone}`;
    const tips = cardAdviceByDomain(card, qtype);
    const pos = positionNudge(posKey);
    const list = tips.map(t=>`<li>${t}</li>`).join('');
    return `
      <div style="margin:8px 0 12px">
        <div style="font-weight:700">${title}</div>
        <div class="muted" style="margin:4px 0">${arch} ${pos}</div>
        <ul style="margin:6px 0 0 18px">${list}</ul>
      </div>
    `;
  }

  function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

  // ---------- TTS ----------
  function speak(html){
    const s = window.speechSynthesis;
    if(!s) return alert('当前浏览器不支持语音朗读');
    const u = new SpeechSynthesisUtterance(strip(html));
    u.lang = 'zh-CN';
    u.rate = 1.0;
    s.cancel(); s.speak(u);
    function strip(h){const d=document.createElement('div'); d.innerHTML=h; return d.textContent||d.innerText||'';}
  }

  // ---------- 事件 ----------
  const goBtn = $('#go');
  const spreadSel = $('#spread');
  const qInput = $('#question');
  const qDisplay = $('#qdisplay');
  const readingPanel = $('#reading');
  const readingText = $('#readingText');
  const ttsBtn = $('#ttsBtn');

  qInput.addEventListener('input', ()=>{ qDisplay.textContent = qInput.value ? `问题：${qInput.value}` : '（提示：输入问题会让解读更聚焦）'; });

  goBtn.addEventListener('click', ()=>{
    const n = parseInt(spreadSel.value,10);
    const picks = draw(n);
    renderBoard(n, picks);
    // 抽完再解读
    const html = buildReading(qInput.value, n, picks);
    readingText.innerHTML = html;
    readingPanel.style.display = 'block';
  });

  ttsBtn.addEventListener('click', ()=>{
    const txt = readingText.innerText || readingText.textContent || '';
    if(!txt.trim()) return;
    speak(txt);
  });
})();
</script>
</body>
</html>
