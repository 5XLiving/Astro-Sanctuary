<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å¡”ç½—ç‰Œå åœ Â· 5X</title>
<style>
/* ======================
   THEME Â· VARIABLES
====================== */
:root{
  --bg:#0b0f14;          /* é¡µé¢èƒŒæ™¯ */
  --card:#11161dcc;      /* å¡ç‰‡åº•è‰² */
  --line:#1f2a36;        /* è¾¹æ¡†çº¿ */
  --text:#e8edf3;        /* å¤‡ç”¨æµ…å­—è‰² */
  --muted:#98a7b7;       /* æ¬¡çº§æ–‡å­— */
  --gold:#e6c76e;        /* ä¸»é‡‘è‰² */
  --brand:#d4af37;       /* å“ç‰Œé‡‘è‰²æ›´åé»„ */
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;        /* ç‰Œå¡å®½ï¼ˆæ¡Œé¢ï¼‰ */
  --card-h:212px;        /* ç‰Œå¡é«˜ï¼ˆæ¡Œé¢ï¼‰ */
  --gap:14px;            /* æ …æ ¼é—´è· */
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* ç»Ÿä¸€é‡‘è‰²å­—ä½“ï¼ˆå åœåŒº & ä¸»è¦æ­£æ–‡ï¼‰ */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* æ·±è‰²æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼‰ */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* é€‰å‡ å¼ ç‰Œçš„ UIï¼ˆä»…æ ·å¼ï¼ŒåŠŸèƒ½ç”¨ JS æ¥ï¼‰ */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD Â· CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* å•å¼ å¡ç‰‡ç»„ä»¶ï¼ˆå›¾+æ ‡é¢˜+ç®€æ„ï¼‰ */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 å¼  */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 å¼ ï¼ˆæ¨ªæ’ï¼‰ */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 å¼ ï¼ˆåå­—ï¼‰ */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 å¼ ï¼š3-3-4 å±…ä¸­ï¼ˆè¡Œå®¹å™¨æ³•ï¼Œä¿è¯æ¯è¡Œå±…ä¸­ï¼‰ */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}

/* æ¯ä¸€è¡Œéƒ½æ˜¯ç‹¬ç«‹çš„ gridï¼Œä¾¿äºå±…ä¸­ä¸‰åˆ—æˆ–å››åˆ— */
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center; /* è¡Œå†…æ•´ä½“å±…ä¸­ */
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* ä½ç½®æ ‡è®°ï¼ˆc1..c10ï¼‰ä»…ç”¨äºè¯­ä¹‰ï¼Œå®é™…å¸ƒå±€äº¤ç»™ row å®¹å™¨ */
.c1,.c2,.c3,.c4,.c5,.c6,.c7,.c8,.c9,.c10{}

/* =================
   PANELS / BLOCKS
================= */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* ä»£ç å—æ ·å¼ï¼ˆä¸ index ä¿æŒä¸€è‡´çš„æ·±è‰²è¾¹æ¡† & é‡‘è‰²æ–‡å­—ï¼‰ */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* å°å¾½ç«  & é€†ä½æ ‡è®° */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{
    --card-w:100px;
    --card-h:166px;
    --gap:12px;
  }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  /* 10å¼ å°å±ï¼šæŒ‰ä¸¤åˆ—æµå¼æ’å¸ƒï¼Œé¿å…æ‹¥æŒ¤ */
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>

</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand_title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh">ç®€ä½“ä¸­æ–‡</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">å¡”ç½—ç‰Œå åœ</h1>
  <div class="controls">
    <input id="question" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">å•å¼ </option>
      <option value="3" data-i18n="s3">ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰</option>
      <option value="5" data-i18n="s5">åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰</option>
      <option value="10" data-i18n="s10">å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰</option>
    </select>
    <button id="go" data-i18n="draw_btn">æŠ½ç‰Œ</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      <span data-i18n="reading_title">è§£è¯»ä¸å»ºè®®</span>
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">ğŸ”Š <span data-i18n="tts_btn">æœ—è¯»</span></button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted" data-i18n="disclaimer">
    è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚
  </div>
</div>

<script>
/* ============ ç®€æ˜“ i18n ============ */
const I18N = {
  zh: {
    brand_title: "å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary",
    page_title: "å¡”ç½—ç‰Œå åœ",
    q_ph: "è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰",
    s1: "å•å¼ ",
    s3: "ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰",
    s5: "åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰",
    s10: "å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰",
    draw_btn: "æŠ½ç‰Œ",
    tip_focus: "ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰",
    reading_title: "è§£è¯»ä¸å»ºè®®",
    tts_btn: "æœ—è¯»",
    disclaimer: "è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚"
  },
  en: {
    brand_title: "Soul Sanctuary Â· 5X",
    page_title: "Tarot Reading",
    q_ph: "Type your question (required, focuses the reading)",
    s1: "Single card",
    s3: "Three cards (Past / Present / Future)",
    s5: "Cross Spread (5)",
    s10: "Celtic Cross (10)",
    draw_btn: "Draw",
    tip_focus: "(Tip: entering a question helps focus the reading.)",
    reading_title: "Reading & Advice",
    tts_btn: "Read Aloud",
    disclaimer: "Note: Tarot offers guidance only. Not medical/legal/financial adviceâ€”use your judgment and free will."
  }
};
let currentLang='zh';
function applyI18N(lang){
  const dict = I18N[lang] || I18N.zh;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k = el.getAttribute("data-i18n");
    if (dict[k] != null) el.textContent = dict[k];
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const k = el.getAttribute("data-i18n-placeholder");
    if (dict[k] != null) el.setAttribute("placeholder", dict[k]);
  });
}

/* --- å·¥å…·ï¼šå›¾ç‰‡ä»£ç† --- */
function viaProxy(url,w=360){const noProto=url.replace(/^https?:\/\//,'');return `https://images.weserv.nl/?url=${encodeURIComponent(noProto)}&w=${w}`}

/* --- ç‰Œåº“ï¼ˆç»´åŸº 78 å¼ ï¼‰ --- */
const WIKI_CARDS={
  "00_æ„šè€… Fool":"https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_00_Fool.jpg",
  "01_é­”æœ¯å¸ˆ Magician":"https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg",
  "02_å¥³ç¥­å¸ High Priestess":"https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg",
  "03_å¥³çš‡ Empress":"https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg",
  "04_çš‡å¸ Emperor":"https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg",
  "05_æ•™çš‡ Hierophant":"https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg",
  "06_æ‹äºº Lovers":"https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg",
  "07_æˆ˜è½¦ Chariot":"https://upload.wikimedia.org/wikipedia/commons/9/9b/TheChariot.jpg",
  "08_åŠ›é‡ Strength":"https://upload.wikimedia.org/wikipedia/commons/f/f5/Strength_tarot_card.jpg",
  "09_éšå£« Hermit":"https://upload.wikimedia.org/wikipedia/commons/4/4d/TheHermit.jpg",
  "10_å‘½è¿ä¹‹è½® Wheel of Fortune":"https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg",
  "11_æ­£ä¹‰ Justice":"https://upload.wikimedia.org/wikipedia/commons/e/e0/JusticeTarot.JPG",
  "12_å€’åŠäºº Hanged Man":"https://upload.wikimedia.org/wikipedia/commons/2/2b/TheHangedMan.jpg",
  "13_æ­»ç¥ Death":"https://upload.wikimedia.org/wikipedia/commons/d/d7/Death_card.jpg",
  "14_èŠ‚åˆ¶ Temperance":"https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg",
  "15_æ¶é­” Devil":"https://upload.wikimedia.org/wikipedia/commons/5/55/TheDevil.jpg",
  "16_é«˜å¡” Tower":"https://upload.wikimedia.org/wikipedia/commons/5/53/TheTower.jpg",
  "17_æ˜Ÿæ˜Ÿ Star":"https://upload.wikimedia.org/wikipedia/commons/d/db/TheStar.jpg",
  "18_æœˆäº® Moon":"https://upload.wikimedia.org/wikipedia/commons/7/7f/TheMoonTarotCard.jpg",
  "19_å¤ªé˜³ Sun":"https://upload.wikimedia.org/wikipedia/commons/1/17/TheSunTarotCard.jpg",
  "20_å®¡åˆ¤ Judgement":"https://upload.wikimedia.org/wikipedia/commons/d/dd/JudgementTarot.jpg",
  "21_ä¸–ç•Œ World":"https://upload.wikimedia.org/wikipedia/commons/f/ff/TheWorldTarotCard.jpg",
  "åœ£æ¯Ace":"https://upload.wikimedia.org/wikipedia/commons/3/36/Cups01.jpg",
  "åœ£æ¯2":"https://upload.wikimedia.org/wikipedia/commons/f/f8/Cups02.jpg",
  "åœ£æ¯3":"https://upload.wikimedia.org/wikipedia/commons/7/7d/Cups03.jpg",
  "åœ£æ¯4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Cups04.jpg",
  "åœ£æ¯5":"https://upload.wikimedia.org/wikipedia/commons/0/06/Cups05.jpg",
  "åœ£æ¯6":"https://upload.wikimedia.org/wikipedia/commons/1/17/Cups06.jpg",
  "åœ£æ¯7":"https://upload.wikimedia.org/wikipedia/commons/a/ab/Cups07.jpg",
  "åœ£æ¯8":"https://upload.wikimedia.org/wikipedia/commons/6/60/Cups08.jpg",
  "åœ£æ¯9":"https://upload.wikimedia.org/wikipedia/commons/2/24/Cups09.jpg",
  "åœ£æ¯10":"https://upload.wikimedia.org/wikipedia/commons/8/84/Cups10.jpg",
  "åœ£æ¯ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Cups11.jpg",
  "åœ£æ¯éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Cups12.jpg",
  "åœ£æ¯çš‡å":"https://upload.wikimedia.org/wikipedia/commons/6/62/Cups13.jpg",
  "åœ£æ¯å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/0/04/Cups14.jpg",
  "æƒæ–Ace":"https://upload.wikimedia.org/wikipedia/commons/1/11/Wands01.jpg",
  "æƒæ–2":"https://upload.wikimedia.org/wikipedia/commons/0/0f/Wands02.jpg",
  "æƒæ–3":"https://upload.wikimedia.org/wikipedia/commons/f/ff/Wands03.jpg",
  "æƒæ–4":"https://upload.wikimedia.org/wikipedia/commons/a/a4/Wands04.jpg",
  "æƒæ–5":"https://upload.wikimedia.org/wikipedia/commons/9/9d/Wands05.jpg",
  "æƒæ–6":"https://upload.wikimedia.org/wikipedia/commons/3/3b/Wands06.jpg",
  "æƒæ–7":"https://upload.wikimedia.org/wikipedia/commons/e/e4/Wands07.jpg",
  "æƒæ–8":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands08.jpg",
  "æƒæ–9":"https://upload.wikimedia.org/wikipedia/commons/0/0b/Wands09.jpg",
  "æƒæ–10":"https://upload.wikimedia.org/wikipedia/commons/4/4d/Wands10.jpg",
  "æƒæ–ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/0/0a/Wands11.jpg",
  "æƒæ–éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands12.jpg",
  "æƒæ–çš‡å":"https://upload.wikimedia.org/wikipedia/commons/1/1c/Wands13.jpg",
  "æƒæ–å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/0/0d/Wands14.jpg",
  "å®å‰‘Ace":"https://upload.wikimedia.org/wikipedia/commons/1/1a/Swords01.jpg",
  "å®å‰‘2":"https://upload.wikimedia.org/wikipedia/commons/9/9e/Swords02.jpg",
  "å®å‰‘3":"https://upload.wikimedia.org/wikipedia/commons/0/02/Swords03.jpg",
  "å®å‰‘4":"https://upload.wikimedia.org/wikipedia/commons/b/bf/Swords04.jpg",
  "å®å‰‘5":"https://upload.wikimedia.org/wikipedia/commons/2/23/Swords05.jpg",
  "å®å‰‘6":"https://upload.wikimedia.org/wikipedia/commons/2/29/Swords06.jpg",
  "å®å‰‘7":"https://upload.wikimedia.org/wikipedia/commons/3/34/Swords07.jpg",
  "å®å‰‘8":"https://upload.wikimedia.org/wikipedia/commons/b/b8/Swords08.jpg",
  "å®å‰‘9":"https://upload.wikimedia.org/wikipedia/commons/2/2f/Swords09.jpg",
  "å®å‰‘10":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords10.jpg",
  "å®å‰‘ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords11.jpg",
  "å®å‰‘éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords12.jpg",
  "å®å‰‘çš‡å":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords13.jpg",
  "å®å‰‘å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/3/31/Swords14.jpg",
  "é’±å¸Ace":"https://upload.wikimedia.org/wikipedia/commons/f/fd/Pents01.jpg",
  "é’±å¸2":"https://upload.wikimedia.org/wikipedia/commons/9/9f/Pents02.jpg",
  "é’±å¸3":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents03.jpg",
  "é’±å¸4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Pents04.jpg",
  "é’±å¸5":"https://upload.wikimedia.org/wikipedia/commons/5/50/Pents05.jpg",
  "é’±å¸6":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents06.jpg",
  "é’±å¸7":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Pents07.jpg",
  "é’±å¸8":"https://upload.wikimedia.org/wikipedia/commons/e/e7/Pents08.jpg",
  "é’±å¸9":"https://upload.wikimedia.org/wikipedia/commons/6/6a/Pents09.jpg",
  "é’±å¸10":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents10.jpg",
  "é’±å¸ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/7/78/Pents11.jpg",
  "é’±å¸éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/2/2d/Pents12.jpg",
  "é’±å¸çš‡å":"https://upload.wikimedia.org/wikipedia/commons/8/88/Pents13.jpg",
  "é’±å¸å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents14.jpg"
};
const DECK=Object.entries(WIKI_CARDS);

/* --- ç‰Œä¹‰ï¼ˆç®€æ˜ï¼‰ --- */
const MAJOR_MEAN={0:"æ–°çš„å¼€å§‹/è‡ªç”±/æ½œèƒ½",1:"æ„å¿—/è¡ŒåŠ¨/æ˜¾åŒ–",2:"ç›´è§‰/ç¥ç§˜/å†…åœ¨æ™ºæ…§",3:"æ»‹å…»/ä¸°ç››/åˆ›é€ ",4:"ç§©åº/æƒå¨/ç»“æ„",5:"ä¼ ç»Ÿ/ä¿¡å¿µ/å¯¼å¸ˆ",6:"é€‰æ‹©/å…³ç³»/å¸å¼•",7:"å‰è¿›/æŒæ§/èƒœåˆ©",8:"å‹‡æ°”/æ¸©æŸ”çš„åŠ›é‡",9:"ç‹¬å¤„/å¯»æ‰¾ç­”æ¡ˆ",10:"å‘¨æœŸ/è½¬æŠ˜/å‘½è¿",11:"å…¬å¹³/å› æœ/å¹³è¡¡",12:"æš‚åœ/æ¢ä½/è‡£æœ",13:"ç»“æŸä¸é‡ç”Ÿ",14:"è°ƒå’Œ/èŠ‚åˆ¶/ä¸­é“",15:"è¯±æƒ‘/æŸç¼š/é˜´å½±",16:"çªå˜/ç“¦è§£/é†’æ‚Ÿ",17:"å¸Œæœ›/ç–—æ„ˆ/å¯å‘",18:"ä¸å®‰/æ½œæ„è¯†/è¿·é›¾",19:"å–œæ‚¦/æˆåŠŸ/æ¸…æ™°",20:"è§‰é†’/å¬å”¤/èµ¦å…",21:"å®Œæˆ/æ•´åˆ/ä¸–ç•Œ"};
const SUIT={"åœ£æ¯":"æƒ…æ„Ÿ/å…³ç³»","æƒæ–":"è¡ŒåŠ¨/çƒ­æƒ…","å®å‰‘":"æ€ç»´/æ²Ÿé€š/æŒ‘æˆ˜","é’±å¸":"ç‰©è´¨/è´¢åŠ¡/äº‹ä¸š"};
const RANK={"Ace":"å¼€å§‹/æœºé‡","2":"å¹³è¡¡/å¯¹ç«‹","3":"æˆé•¿/åä½œ","4":"ç¨³å®š/åœæ»","5":"å†²çª/å‹åŠ›","6":"ç»™äºˆ/å’Œè°","7":"è€ƒéªŒ/é€‰æ‹©","8":"è¡ŒåŠ¨/è¿›å±•","9":"æˆæœ/è´Ÿæ‹…","10":"é˜¶æ®µç»“æŸ/ä¸°æ”¶","ä¾ä»":"è®¯æ¯/èµ·æ­¥","éª‘å£«":"æ¨åŠ¨/è¿½æ±‚","çš‡å":"æˆç†Ÿ/å¸å¼•","å›½ç‹":"æŒæ§/è´Ÿè´£"};

function parseMeaning(name,reversed){
  if(/^\d{2}_/.test(name)){
    const n=+name.slice(0,2),base=MAJOR_MEAN[n]||"";
    return (reversed?"é€†ä½ï¼š":"æ­£ä½ï¼š")+(reversed?base.replaceAll("/","/é˜»æ»Â·"):base);
  }
  const m=name.match(/^(åœ£æ¯|æƒæ–|å®å‰‘|é’±å¸)(Ace|[2-9]|10|ä¾ä»|éª‘å£«|çš‡å|å›½ç‹)/);
  if(m){
    const suit=m[1],rank=m[2],base=`${SUIT[suit]} Â· ${RANK[rank]||""}`;
    return (reversed?"é€†ä½ï¼š":"æ­£ä½ï¼š")+(reversed?`${base}ï¼ˆé˜»æ»/åå‘ï¼‰`:base);
  }
  return reversed?"é€†ä½":"æ­£ä½";
}

/* --- ä¸»é¢˜æ¨æ–­ä¸å»ºè®® --- */
// ç»Ÿè®¡èŠ±è‰²/å¤§ç‰Œ/é€†ä½
function suitStats(picks){
  const s={åœ£æ¯:0,æƒæ–:0,å®å‰‘:0,é’±å¸:0,major:0,rev:0};
  for(const {name,reversed} of picks){
    if(/^\d{2}_/.test(name)) s.major++;
    else{
      const m=name.match(/^(åœ£æ¯|æƒæ–|å®å‰‘|é’±å¸)/);
      if(m) s[m[1]]++;
    }
    if(reversed) s.rev++;
  }
  return s;
}

// æ ¹æ®é—®é¢˜(ä¸­è‹±)+ç‰Œé¢ç»Ÿè®¡ æ¨æ–­ä¸»é¢˜ï¼›é—®é¢˜ç¼ºå¤±æ—¶ç”¨èŠ±è‰²å…œåº•
function inferTopic(q, picks, stats){
  const text = (q || '').toLowerCase();

  const isLove   = /(çˆ±|æ‹|æ„Ÿæƒ…|å©š|å¤åˆ|æš§æ˜§|æ¡ƒèŠ±)/.test(q||'') || /(love|relationship|crush|ex|marriage)/i.test(text);
  const isCareer = /(å·¥ä½œ|èŒ|äº‹ä¸š|é¢è¯•|å‡èŒ|è·³æ§½|åˆä½œ|è€æ¿|å›¢é˜Ÿ|é¡¹ç›®)/.test(q||'') || /(career|job|work|interview|promotion|boss|project|startup)/i.test(text);
  const isWealth = /(è´¢|é’±|æ”¶å…¥|æŠ•èµ„|å€Ÿè´·|è‚¡ç¥¨|åŸºé‡‘|æˆ¿|è½¦|è–ª|æŠ¥é…¬)/.test(q||'') || /(money|finance|wealth|investment|stock|crypto|salary|pay|house)/i.test(text);
  const isStudy  = /(å­¦ä¸š|è€ƒè¯•|å½•å–|è®ºæ–‡|æˆç»©|è€ƒç ”|å­¦æ ¡)/.test(q||'') || /(study|exam|test|school|grade|admission|thesis)/i.test(text);

  let topic = isLove ? 'love' : isCareer ? 'career' : isWealth ? 'wealth' : isStudy ? 'study' : 'general';

  if (topic === 'general'){
    const suitCount = { 'åœ£æ¯':'love', 'æƒæ–':'career', 'é’±å¸':'wealth', 'å®å‰‘':'study' };
    const entries = Object.entries(suitCount).map(([suit,t])=>({ suit, t, n: stats[suit] || 0 }));
    entries.sort((a,b)=>b.n - a.n);
    if (entries[0].n > 0) topic = entries[0].t;
  }
  return topic;
}

// ä¸“ä¸šå»ºè®®ï¼šç»“åˆä¸»é¢˜ + é€†ä½/å¤§ç‰Œå æ¯”å¾®è°ƒè¯­æ°”
function topicAdvice(topic, stats, spreadName){
  const total = (stats.åœ£æ¯ + stats.æƒæ– + stats.å®å‰‘ + stats.é’±å¸ + stats.major) || 1;
  const revRate   = Math.round(stats.rev / total * 100);
  const majorRate = Math.round(stats.major / total * 100);

  const caution = revRate >= 50 ? 'å½“å‰é˜»æ»è¾ƒå¤šï¼Œå®œå…ˆæ’é›·åè¡ŒåŠ¨ã€‚' :
                  revRate >= 30 ? 'å­˜åœ¨åˆ†æ­§æˆ–å»¶è¿Ÿï¼ŒèŠ‚å¥æ”¾æ…¢ã€å…ˆåšæ ¡å‡†ã€‚' : 'æœºé‡å¤§äºé˜»ç¢ï¼Œä¿æŒèŠ‚å¥å³å¯ã€‚';
  const phase    = majorRate >= 50 ? 'è¿™æ˜¯é˜¶æ®µæ€§çš„å…³é”®è¯¾é¢˜ï¼Œå»ºè®®è®¾å®šé‡Œç¨‹ç¢‘å¹¶å¤ç›˜ã€‚' : '';

  const base = {
    love:   `æ„Ÿæƒ…ä¸»é¢˜${spreadName ? `ï¼ˆ${spreadName}ï¼‰` : ''}ï¼šä¼˜å…ˆã€ŒçœŸè¯šæ²Ÿé€š + è¾¹ç•Œæ„Ÿã€ã€‚è‹¥è¿›å±•å¡ä½ï¼Œå…ˆåŒæ­¥æœŸå¾…å€¼ä¸èŠ‚å¥ï¼Œå†è°ˆç»“è®ºã€‚`,
    career: `äº‹ä¸š/å·¥ä½œ${spreadName ? `ï¼ˆ${spreadName}ï¼‰` : ''}ï¼šæŠŠç›®æ ‡æ‹†æˆæœ¬å‘¨å¯äº¤ä»˜ï¼Œå…³é”®ä»»åŠ¡å…ˆè¡Œï¼›å¯¹ä¸ç¡®å®šé¡¹åšé¢„æ¡ˆä¸å¯¹é½ã€‚`,
    wealth: `é‡‘é’±/æŠ•èµ„${spreadName ? `ï¼ˆ${spreadName}ï¼‰` : ''}ï¼šä»¥ç¨³å¥ä¸ºå…ˆï¼Œæ§åˆ¶æ”¯å‡ºã€åˆ†æ•£é£é™©ï¼›ä»»ä½•åŠ ä»“å‰å…ˆç¡®è®¤æ•°æ®ä¸æ­¢æŸä½ã€‚`,
    study:  `å­¦ä¹ /è€ƒè¯•${spreadName ? `ï¼ˆ${spreadName}ï¼‰` : ''}ï¼šå…ˆè¡¥å¼±é¡¹ï¼Œå»ºç«‹æ¯æ—¥å›ºå®šæ—¶æ®µï¼›ç”¨ç•ªèŒ„é’Ÿä¸é˜¶æ®µå°æµ‹éªŒè¯è¿›åº¦ã€‚`,
    general:`å½“å‰è®®é¢˜${spreadName ? `ï¼ˆ${spreadName}ï¼‰` : ''}ï¼šå…ˆæ˜ç¡®ä¸‹ä¸€æ­¥å¯æ§åŠ¨ä½œï¼Œä¿æŒå°æ­¥å¿«è·‘ä¸å¤ç›˜ã€‚`
  }[topic];

  return `${base} ${caution} ${phase}`.trim();
}

/* --- æ–‡æœ¬è§£è¯»ï¼ˆç»Ÿä¸€å£å¾„ï¼‰ --- */
function buildReading(q, picks, spread){
  const pos10=['å½“ä¸‹','é˜»ç¢','æ½œæ„è¯†','æ˜¾æ„è¯†','è¿‡å»','æœªæ¥','è‡ªæˆ‘','ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ'];
  const pos5 =['è¿‡å»','æ½œæ„è¯†','å½“ä¸‹','å¤–åœ¨å½±å“','æœªæ¥è¶‹åŠ¿'];
  const pos3 =['è¿‡å»','ç°åœ¨','æœªæ¥'];
  const spreadName = ({1:'å•å¼ ',3:'ä¸‰å¼ ï¼ˆè¿‡å»/ç°åœ¨/æœªæ¥ï¼‰',5:'åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰',10:'å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰'})[spread];

  // ç»Ÿè®¡
  const stats = suitStats(picks);
  const total = picks.length || 1;
  const majorRate = Math.round(stats.major/total*100);
  const revRate   = Math.round(stats.rev/total*100);
  const focus = Object.entries({åœ£æ¯:stats.åœ£æ¯,æƒæ–:stats.æƒæ–,å®å‰‘:stats.å®å‰‘,é’±å¸:stats.é’±å¸})
                      .sort((a,b)=>b[1]-a[1])[0];
  const suitHint = (focus && focus[1] > 0)
    ? `æœ¬æ¬¡æŠ½ç‰Œä»¥ã€${focus[0]}ã€‘ä¸ºä¸»ï¼ˆ${SUIT[focus[0]]}ï¼‰ï¼Œè¯´æ˜è¿™ä»¶äº‹å½“å‰æ›´ä¾§é‡è¯¥ç»´åº¦ã€‚`
    : `æœ¬æ¬¡æŠ½ç‰Œä»¥å¤§é˜¿å°”å…‹é‚£ä¸ºä¸»ï¼Œæç¤ºè¿™æ˜¯é˜¶æ®µæ€§çš„å…³é”®è¯¾é¢˜ã€‚`;

  // é€ä½ç½®è§£è¯»
  const list = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : spread===5 ? pos5[i] : spread===3 ? pos3[i] : 'å½“ä¸‹';
    const dir = c.reversed ? 'é€†ä½' : 'æ­£ä½';
    const mean = parseMeaning(c.name,c.reversed).replace(/^æ­£ä½ï¼š|^é€†ä½ï¼š/,'');
    return `â€¢ ã€${label}ã€‘${c.name}ï¼ˆ${dir}ï¼‰â€” ${mean}`;
  }).join('<br>');

  // æ ¸å¿ƒï¼šä¸»é¢˜æ¨æ–­ + ç»¼åˆå»ºè®®
  const topic  = inferTopic(q, picks, stats);
  const advice = topicAdvice(topic, stats, spreadName);

  return `
    <p><b>é—®é¢˜ï¼š</b>${q||'ï¼ˆæœªå¡«å†™ï¼‰'}</p>
    <p><b>ç‰Œé˜µï¼š</b>${spreadName}</p>
    <p>${suitHint} å¤§é˜¿å°”å…‹é‚£å æ¯”çº¦ <b>${majorRate}%</b>ï¼›é€†ä½çº¦ <b>${revRate}%</b>ã€‚</p>
    <p><b>é€ä½ç½®è§£è¯»ï¼š</b><br>${list}</p>
    <p><b>ç»¼åˆå»ºè®®ï¼š</b>${advice}</p>
  `;
}

/* --- TTS --- */
let lastSpoken='',speaking=false;
function pickZhVoice(){const vs=speechSynthesis.getVoices();return vs.find(v=>/zh|cmn/i.test(v.lang))||vs[0]}
function speak(text){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  const v=pickZhVoice(); if(v)u.voice=v;
  u.rate=1;u.pitch=1;u.volume=1;
  u.onend=()=>{speaking=false;document.getElementById('ttsBtn').innerHTML='ğŸ”Š <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>'};
  speaking=true;
  document.getElementById('ttsBtn').textContent='â¸ æš‚åœ';
  speechSynthesis.speak(u);
}
function toggleTTS(){
  if(!('speechSynthesis'in window)) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»');
  if(speaking){
    speechSynthesis.cancel(); speaking=false;
    document.getElementById('ttsBtn').innerHTML='ğŸ”Š <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>';
  }else{
    speak(lastSpoken||'æš‚æ— å¯æœ—è¯»å†…å®¹ã€‚');
  }
}

/* --- å»æ ‡ç­¾ä¾›æœ—è¯» --- */
function stripTags(html){
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  let text = tmp.textContent || tmp.innerText || '';
  return text.replace(/[â€¢ã€ã€‘â€”Â·]/g,' ').replace(/\s+/g,' ').trim();
}

/* --- æŠ½ç‰Œä¸æ¸²æŸ“ --- */
function draw(){
  const n=+document.getElementById('spread').value;
  const q=document.getElementById('question').value.trim();
  document.getElementById('qdisplay').textContent = q
    ? (currentLang==='en' ? `Question: ${q}` : `é—®é¢˜ï¼š${q}`)
    : (I18N[currentLang].tip_focus);

  const board=document.getElementById('board');
  board.innerHTML='';
  board.className='board '+(n===1?'spread-1':n===3?'spread-3':n===5?'spread-5':'spread-10');

  const pool=[...DECK], take=()=>pool.splice(Math.floor(Math.random()*pool.length),1)[0], picks=[];
  function place(pair,label,extra=''){
    const [name,url]=pair, reversed=Math.random()<0.5; picks.push({name,reversed});
    const wrap=document.createElement('div'); wrap.className='card '+extra;
    const imgw=document.createElement('div'); imgw.className='imgwrap';
    const img=new Image(); img.className='card-img'; img.loading='eager';
    img.src=viaProxy(url,400); img.onerror=()=>{img.onerror=null;img.src=url}; if(reversed) img.style.transform='rotate(180deg)';
    const cap=document.createElement('div'); cap.className='cap'; cap.textContent=label?`${name} Â· ${label}`:name;
    const mean=document.createElement('div'); mean.className='mean'; mean.textContent=parseMeaning(name,reversed);
    imgw.appendChild(img); wrap.appendChild(imgw); wrap.appendChild(cap); wrap.appendChild(mean); board.appendChild(wrap);
  }
  if(n===1){place(take(),'å½“ä¸‹')}
  else if(n===3){place(take(),'è¿‡å»');place(take(),'ç°åœ¨');place(take(),'æœªæ¥')}
  else if(n===5){
    place(take(),'è¿‡å»','pos-top');
    place(take(),'æ½œæ„è¯†','pos-left');
    place(take(),'å½“ä¸‹','pos-center');
    place(take(),'å¤–åœ¨å½±å“','pos-right');
    place(take(),'æœªæ¥è¶‹åŠ¿','pos-bottom');
  }else{
    const labels10=['å½“ä¸‹','é˜»ç¢','æ½œæ„è¯†','æ˜¾æ„è¯†','è¿‡å»','æœªæ¥','è‡ªæˆ‘','ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ'];
    for(let i=0;i<10;i++) place(take(),labels10[i],`c${i+1}`);
  }

  const unified = buildReading(q, picks, n);
  document.getElementById('readingText').innerHTML = unified;
  document.getElementById('reading').style.display = 'block';
  lastSpoken = stripTags(unified);
}

/* --- äº‹ä»¶ç»‘å®š & åˆå§‹åŒ– --- */
document.getElementById('go').addEventListener('click', draw);
document.getElementById('ttsBtn').addEventListener('click', toggleTTS);
document.getElementById('langSel').addEventListener('change', e=>{
  currentLang = e.target.value;
  applyI18N(currentLang);
});
applyI18N(currentLang);

// è¯­éŸ³é¢„çƒ­ï¼ˆéƒ¨åˆ†æµè§ˆå™¨éœ€è¦ï¼‰
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = ()=>{};
}
</script>
</body>
</html>
