<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å¡”ç½—ç‰Œå åœ Â· 5X</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#11161dcc; --line:#1f2a36; --text:#e8edf3; --muted:#98a7b7;
      --gold:#e6c76e; --brand:#d4af37; --accent:#58b9ff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans SC",system-ui,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:#0b0f14cc;border-bottom:1px solid var(--line)}
    .head-inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{background:var(--brand);color:#111;padding:6px 10px;border-radius:8px;font-weight:800}
    .title{font-weight:700}
    .lang select{padding:6px 8px;border-radius:8px;background:#0f1420;color:#e8edf3;border:1px solid #273245}

    .app{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:6px 0 14px;color:var(--brand);font-weight:800}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .controls input,.controls select,.controls button{
      padding:12px;border-radius:12px;border:1px solid #273245;background:#0f1420;color:var(--text)
    }
    .controls input{flex:1;min-width:220px}
    .controls button{cursor:pointer;background:linear-gradient(180deg,#fff9e6,var(--gold));color:#121212;border-color:var(--gold);font-weight:800}
    .q{margin:6px 0 12px;font-weight:600}

    .board{display:grid;gap:14px;justify-content:center}
    .card{display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;background:var(--card);
      border:1px solid var(--line);border-radius:14px;padding:10px 10px 12px}
    .imgwrap{width:128px;height:212px;border-radius:10px;overflow:hidden;background:#000;display:grid;place-items:center;border:1px solid #34455a}
    img.card-img{width:100%;height:100%;object-fit:contain;display:block;background:#000}
    .cap{font-size:13px;color:#cfe3ff}
    .mean{font-size:12px;color:#a7b5c8}

    /* å¸ƒå±€ï¼šæ ¹æ®æŠ½ç‰Œæ•°åˆ‡æ¢ */
    .spread-1{grid-template-columns:128px}
    .spread-3{grid-template-columns:repeat(3,128px)}
    .spread-5{grid-template-areas:
      "top top top"
      "left center right"
      ". bottom .";
      grid-template-columns:128px 128px 128px}
    .pos-top{grid-area:top}.pos-left{grid-area:left}.pos-center{grid-area:center}
    .pos-right{grid-area:right}.pos-bottom{grid-area:bottom}
    .spread-10{grid-template-columns:repeat(5,128px)} /* æ¡Œé¢ï¼šä¸¤æ’äº”å¼  */

    @media(max-width:560px){
      .imgwrap{width:100px;height:166px}
      .spread-1{grid-template-columns:100px}
      .spread-3{grid-template-columns:repeat(3,100px)}
      .spread-5{grid-template-columns:100px 100px 100px}
      .spread-10{grid-template-columns:repeat(2,1fr)} /* æ‰‹æœºï¼š2 åˆ— x 5 è¡Œï¼Œä¿è¯ 10 å¼ éƒ½å¯è§ */
    }

    .panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .panel h3{margin:0 0 8px;font-size:1.05rem;color:#ffe084}
    .panel p,.panel li{color:#d8e3ef}
    .panel .muted{color:var(--muted)}

    /* ç®€æ˜“å¼¹çª—ï¼ˆå¯é€‰ï¼‰ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-content{background:#0f1420;border:1px solid #273245;border-radius:14px;padding:18px;max-width:420px}
    .modal-close{float:right;cursor:pointer;color:#ffe084}
    /* 10å¼ ï¼šæ¡Œé¢ 3-3-4 */
.spread-10{
  display:grid;
  grid-template-columns:repeat(4,128px);
  grid-auto-rows:auto;
  gap:14px;
}
.spread-10 .c1{grid-column:1;grid-row:1}
.spread-10 .c2{grid-column:2;grid-row:1}
.spread-10 .c3{grid-column:3;grid-row:1}
.spread-10 .c4{grid-column:1;grid-row:2}
.spread-10 .c5{grid-column:2;grid-row:2}
.spread-10 .c6{grid-column:3;grid-row:2}
.spread-10 .c7{grid-column:1;grid-row:3}
.spread-10 .c8{grid-column:2;grid-row:3}
.spread-10 .c9{grid-column:3;grid-row:3}
.spread-10 .c10{grid-column:4;grid-row:3}

/* æ‰‹æœºç«¯ä»ç”¨ 2Ã—5ï¼Œä¿è¯ä¸æŒ¤çˆ†å±å¹• */
@media(max-width:560px){
  .imgwrap{width:100px;height:166px}
  .spread-10{
    grid-template-columns:repeat(2,1fr);
    grid-auto-flow:row;
  }
  .spread-10 .c1,.spread-10 .c2,.spread-10 .c3,.spread-10 .c4,.spread-10 .c5,
  .spread-10 .c6,.spread-10 .c7,.spread-10 .c8,.spread-10 .c9,.spread-10 .c10{
    grid-column:auto;grid-row:auto; /* è®©æ‰‹æœºæ”¹å›è‡ªç„¶æµ */
  }
}
  </style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div class="brand">
        <div class="brand-badge">5X</div>
        <div class="title">å‘½ç†å¿ƒæ€œç©ºé—´ Â· Soul Sanctuary</div>
      </div>
      <div class="lang">
        <select>
          <option>ç®€ä½“ä¸­æ–‡</option><option>ç¹é«”ä¸­æ–‡</option><option>English</option>
          <option>æ—¥æœ¬èª</option><option>à¹„à¸—à¸¢</option><option>Bahasa Melayu</option>
        </select>
      </div>
  </header>

  <div class="app">
    <h1>å¡”ç½—ç‰Œå åœ</h1>

    <div class="controls">
      <input id="question" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆå¿…å¡«ï¼Œå†³å®šè§£è¯»æ–¹å‘ï¼‰" />
      <select id="spread">
        <option value="1">å•å¼ </option>
        <option value="3">ä¸‰å¼ ï¼ˆè¿‡å» / ç°åœ¨ / æœªæ¥ï¼‰</option>
        <option value="5">åå­—æ’æ³•ï¼ˆ5å¼ ï¼‰</option>
        <option value="10">å‡¯å°”ç‰¹åå­—ï¼ˆ10å¼ ï¼‰</option>
      </select>
      <button id="go">æŠ½ç‰Œ</button>
    </div>

    <div id="qdisplay" class="q muted">ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰</div>
    <div id="board" class="board"></div>

    <div id="reading" class="panel" style="display:none">
      <h3>è§£è¯»ä¸å»ºè®®</h3>
      <div id="readingText"></div>
    </div>

    <div id="disclaimer" class="panel muted">
      è¯´æ˜ï¼šå¡”ç½—ä¸ºæŒ‡å¼•å·¥å…·ï¼ŒéåŒ»å­¦/æ³•å¾‹/é‡‘èå»ºè®®ï¼Œè¯·ä»¥ç†æ€§åˆ¤æ–­ä¸è‡ªæˆ‘æ„æ„¿ä¸ºå…ˆã€‚
    </div>
  </div>

  <!-- è§£è¯»å¼¹çª—ï¼ˆå¯é€‰ï¼Œç”¨ä¸åˆ°å¯åˆ ï¼‰ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">âœ–</span>
      <h3 id="modal-title"></h3>
      <p id="modal-text"></p>
    </div>
  </div>
  
  <div id="reading" class="panel" style="display:none">
  <h3 style="display:flex;align-items:center;gap:10px">
    è§£è¯»ä¸å»ºè®®
    <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">
      ğŸ”Š æœ—è¯»
    </button>
  </h3>
  <div id="readingText"></div>
</div>

<script>
/* ------------------ å›¾ç‰‡ä»£ç†ï¼šç»Ÿä¸€èµ° https://images.weserv.nl/ ä¿éšœåŠ è½½ ------------------ */
function viaProxy(url, w=360){
  const noProto = url.replace(/^https?:\/\//,'');
  return `https://images.weserv.nl/?url=${encodeURIComponent(noProto)}&w=${w}`;
}

/* ------------------ 78 å¼ ç‰Œï¼ˆç»´åŸºåŸå›¾ï¼‰ ------------------ */
const WIKI_CARDS = {
  "00_æ„šè€… Fool":"https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_00_Fool.jpg",
  "01_é­”æœ¯å¸ˆ Magician":"https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg",
  "02_å¥³ç¥­å¸ High Priestess":"https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg",
  "03_å¥³çš‡ Empress":"https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg",
  "04_çš‡å¸ Emperor":"https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg",
  "05_æ•™çš‡ Hierophant":"https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg",
  "06_æ‹äºº Lovers":"https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg",
  "07_æˆ˜è½¦ Chariot":"https://upload.wikimedia.org/wikipedia/commons/9/9b/TheChariot.jpg",
  "08_åŠ›é‡ Strength":"https://upload.wikimedia.org/wikipedia/commons/f/f5/Strength_tarot_card.jpg",
  "09_éšå£« Hermit":"https://upload.wikimedia.org/wikipedia/commons/4/4d/TheHermit.jpg",
  "10_å‘½è¿ä¹‹è½® Wheel of Fortune":"https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg",
  "11_æ­£ä¹‰ Justice":"https://upload.wikimedia.org/wikipedia/commons/e/e0/JusticeTarot.JPG",
  "12_å€’åŠäºº Hanged Man":"https://upload.wikimedia.org/wikipedia/commons/2/2b/TheHangedMan.jpg",
  "13_æ­»ç¥ Death":"https://upload.wikimedia.org/wikipedia/commons/d/d7/Death_card.jpg",
  "14_èŠ‚åˆ¶ Temperance":"https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg",
  "15_æ¶é­” Devil":"https://upload.wikimedia.org/wikipedia/commons/5/55/TheDevil.jpg",
  "16_é«˜å¡” Tower":"https://upload.wikimedia.org/wikipedia/commons/5/53/TheTower.jpg",
  "17_æ˜Ÿæ˜Ÿ Star":"https://upload.wikimedia.org/wikipedia/commons/d/db/TheStar.jpg",
  "18_æœˆäº® Moon":"https://upload.wikimedia.org/wikipedia/commons/7/7f/TheMoonTarotCard.jpg",
  "19_å¤ªé˜³ Sun":"https://upload.wikimedia.org/wikipedia/commons/1/17/TheSunTarotCard.jpg",
  "20_å®¡åˆ¤ Judgement":"https://upload.wikimedia.org/wikipedia/commons/d/dd/JudgementTarot.jpg",
  "21_ä¸–ç•Œ World":"https://upload.wikimedia.org/wikipedia/commons/f/ff/TheWorldTarotCard.jpg",
  "åœ£æ¯Ace":"https://upload.wikimedia.org/wikipedia/commons/3/36/Cups01.jpg",
  "åœ£æ¯2":"https://upload.wikimedia.org/wikipedia/commons/f/f8/Cups02.jpg",
  "åœ£æ¯3":"https://upload.wikimedia.org/wikipedia/commons/7/7d/Cups03.jpg",
  "åœ£æ¯4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Cups04.jpg",
  "åœ£æ¯5":"https://upload.wikimedia.org/wikipedia/commons/0/06/Cups05.jpg",
  "åœ£æ¯6":"https://upload.wikimedia.org/wikipedia/commons/1/17/Cups06.jpg",
  "åœ£æ¯7":"https://upload.wikimedia.org/wikipedia/commons/a/ab/Cups07.jpg",
  "åœ£æ¯8":"https://upload.wikimedia.org/wikipedia/commons/6/60/Cups08.jpg",
  "åœ£æ¯9":"https://upload.wikimedia.org/wikipedia/commons/2/24/Cups09.jpg",
  "åœ£æ¯10":"https://upload.wikimedia.org/wikipedia/commons/8/84/Cups10.jpg",
  "åœ£æ¯ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Cups11.jpg",
  "åœ£æ¯éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Cups12.jpg",
  "åœ£æ¯çš‡å":"https://upload.wikimedia.org/wikipedia/commons/6/62/Cups13.jpg",
  "åœ£æ¯å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/0/04/Cups14.jpg",
  "æƒæ–Ace":"https://upload.wikimedia.org/wikipedia/commons/1/11/Wands01.jpg",
  "æƒæ–2":"https://upload.wikimedia.org/wikipedia/commons/0/0f/Wands02.jpg",
  "æƒæ–3":"https://upload.wikimedia.org/wikipedia/commons/f/ff/Wands03.jpg",
  "æƒæ–4":"https://upload.wikimedia.org/wikipedia/commons/a/a4/Wands04.jpg",
  "æƒæ–5":"https://upload.wikimedia.org/wikipedia/commons/9/9d/Wands05.jpg",
  "æƒæ–6":"https://upload.wikimedia.org/wikipedia/commons/3/3b/Wands06.jpg",
  "æƒæ–7":"https://upload.wikimedia.org/wikipedia/commons/e/e4/Wands07.jpg",
  "æƒæ–8":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands08.jpg",
  "æƒæ–9":"https://upload.wikimedia.org/wikipedia/commons/0/0b/Wands09.jpg",
  "æƒæ–10":"https://upload.wikimedia.org/wikipedia/commons/4/4d/Wands10.jpg",
  "æƒæ–ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/0/0a/Wands11.jpg",
  "æƒæ–éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands12.jpg",
  "æƒæ–çš‡å":"https://upload.wikimedia.org/wikipedia/commons/1/1c/Wands13.jpg",
  "æƒæ–å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/0/0d/Wands14.jpg",
  "å®å‰‘Ace":"https://upload.wikimedia.org/wikipedia/commons/1/1a/Swords01.jpg",
  "å®å‰‘2":"https://upload.wikimedia.org/wikipedia/commons/9/9e/Swords02.jpg",
  "å®å‰‘3":"https://upload.wikimedia.org/wikipedia/commons/0/02/Swords03.jpg",
  "å®å‰‘4":"https://upload.wikimedia.org/wikipedia/commons/b/bf/Swords04.jpg",
  "å®å‰‘5":"https://upload.wikimedia.org/wikipedia/commons/2/23/Swords05.jpg",
  "å®å‰‘6":"https://upload.wikimedia.org/wikipedia/commons/2/29/Swords06.jpg",
  "å®å‰‘7":"https://upload.wikimedia.org/wikipedia/commons/3/34/Swords07.jpg",
  "å®å‰‘8":"https://upload.wikimedia.org/wikipedia/commons/b/b8/Swords08.jpg",
  "å®å‰‘9":"https://upload.wikimedia.org/wikipedia/commons/2/2f/Swords09.jpg",
  "å®å‰‘10":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords10.jpg",
  "å®å‰‘ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords11.jpg",
  "å®å‰‘éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords12.jpg",
  "å®å‰‘çš‡å":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords13.jpg",
  "å®å‰‘å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/3/31/Swords14.jpg",
  "é’±å¸Ace":"https://upload.wikimedia.org/wikipedia/commons/f/fd/Pents01.jpg",
  "é’±å¸2":"https://upload.wikimedia.org/wikipedia/commons/9/9f/Pents02.jpg",
  "é’±å¸3":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents03.jpg",
  "é’±å¸4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Pents04.jpg",
  "é’±å¸5":"https://upload.wikimedia.org/wikipedia/commons/5/50/Pents05.jpg",
  "é’±å¸6":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents06.jpg",
  "é’±å¸7":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Pents07.jpg",
  "é’±å¸8":"https://upload.wikimedia.org/wikipedia/commons/e/e7/Pents08.jpg",
  "é’±å¸9":"https://upload.wikimedia.org/wikipedia/commons/6/6a/Pents09.jpg",
  "é’±å¸10":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents10.jpg",
  "é’±å¸ä¾ä»":"https://upload.wikimedia.org/wikipedia/commons/7/78/Pents11.jpg",
  "é’±å¸éª‘å£«":"https://upload.wikimedia.org/wikipedia/commons/2/2d/Pents12.jpg",
  "é’±å¸çš‡å":"https://upload.wikimedia.org/wikipedia/commons/8/88/Pents13.jpg",
  "é’±å¸å›½ç‹":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents14.jpg"
};
const DECK = Object.entries(WIKI_CARDS);

/* ------------------ ç‰Œä¹‰ï¼ˆç®€æ˜ï¼‰ ------------------ */
const MAJOR_MEAN = {
  0:"æ–°çš„å¼€å§‹/è‡ªç”±/æ½œèƒ½",1:"æ„å¿—/è¡ŒåŠ¨/æ˜¾åŒ–",2:"ç›´è§‰/ç¥ç§˜/å†…åœ¨æ™ºæ…§",3:"æ»‹å…»/ä¸°ç››/åˆ›é€ ",
  4:"ç§©åº/æƒå¨/ç»“æ„",5:"ä¼ ç»Ÿ/ä¿¡å¿µ/å¯¼å¸ˆ",6:"é€‰æ‹©/å…³ç³»/å¸å¼•",7:"å‰è¿›/æŒæ§/èƒœåˆ©",
  8:"å‹‡æ°”/æ¸©æŸ”çš„åŠ›é‡",9:"ç‹¬å¤„/å¯»æ‰¾ç­”æ¡ˆ",10:"å‘¨æœŸ/è½¬æŠ˜/å‘½è¿",11:"å…¬å¹³/å› æœ/å¹³è¡¡",
  12:"æš‚åœ/æ¢ä½/è‡£æœ",13:"ç»“æŸä¸é‡ç”Ÿ",14:"è°ƒå’Œ/èŠ‚åˆ¶/ä¸­é“",15:"è¯±æƒ‘/æŸç¼š/é˜´å½±",
  16:"çªå˜/ç“¦è§£/é†’æ‚Ÿ",17:"å¸Œæœ›/ç–—æ„ˆ/å¯å‘",18:"ä¸å®‰/æ½œæ„è¯†/è¿·é›¾",19:"å–œæ‚¦/æˆåŠŸ/æ¸…æ™°",
  20:"è§‰é†’/å¬å”¤/èµ¦å…",21:"å®Œæˆ/æ•´åˆ/ä¸–ç•Œ"
};
const SUIT = {"åœ£æ¯":"æƒ…æ„Ÿ/å…³ç³»","æƒæ–":"è¡ŒåŠ¨/çƒ­æƒ…","å®å‰‘":"æ€ç»´/æ²Ÿé€š/æŒ‘æˆ˜","é’±å¸":"ç‰©è´¨/è´¢åŠ¡/äº‹ä¸š"};
const RANK = {"Ace":"å¼€å§‹/æœºé‡","2":"å¹³è¡¡/å¯¹ç«‹","3":"æˆé•¿/åä½œ","4":"ç¨³å®š/åœæ»","5":"å†²çª/å‹åŠ›","6":"ç»™äºˆ/å’Œè°","7":"è€ƒéªŒ/é€‰æ‹©","8":"è¡ŒåŠ¨/è¿›å±•","9":"æˆæœ/è´Ÿæ‹…","10":"é˜¶æ®µç»“æŸ/ä¸°æ”¶","ä¾ä»":"è®¯æ¯/èµ·æ­¥","éª‘å£«":"æ¨åŠ¨/è¿½æ±‚","çš‡å":"æˆç†Ÿ/å¸å¼•","å›½ç‹":"æŒæ§/è´Ÿè´£"};

function parseMeaning(name, reversed){
  if (/^\d{2}_/.test(name)){
    const n = +name.slice(0,2);
    const base = MAJOR_MEAN[n] || "";
    return (reversed ? "é€†ä½ï¼š" : "æ­£ä½ï¼š") + (reversed ? base.replaceAll("/","/é˜»æ»Â·") : base);
  }
  const m = name.match(/^(åœ£æ¯|æƒæ–|å®å‰‘|é’±å¸)(Ace|[2-9]|10|ä¾ä»|éª‘å£«|çš‡å|å›½ç‹)/);
  if (m){
    const suit=m[1], rank=m[2];
    const base = `${SUIT[suit]} Â· ${RANK[rank]||""}`;
    return (reversed ? "é€†ä½ï¼š" : "æ­£ä½ï¼š") + (reversed ? `${base}ï¼ˆé˜»æ»/åå‘ï¼‰` : base);
  }
  return reversed ? "é€†ä½" : "æ­£ä½";
}

/* ------------------ è§£è¯»ç”Ÿæˆ ------------------ */
function detectTopic(q){
  q = (q||"").toLowerCase();
  if (/[çˆ±æ‹æƒ…æ„Ÿå©š]/.test(q)) return "love";
  if (/[å·¥èŒäº‹ä¸šå‡èŒè·³æ§½é¢è¯•]/.test(q)) return "career";
  if (/[è´¢é’±æ”¶å…¥æŠ•èµ„å€Ÿè´·è‚¡ç¥¨æˆ¿]/.test(q)) return "wealth";
  if (/[å­¦ä¸šè€ƒè¯•å½•å–è®ºæ–‡]/.test(q)) return "study";
  return "general";
}
function suitStats(picks){
  const s = {åœ£æ¯:0,æƒæ–:0,å®å‰‘:0,é’±å¸:0,major:0,rev:0};
  for(const {name,reversed} of picks){
    if (/^\d{2}_/.test(name)) s.major++;
    else{
      const m = name.match(/^(åœ£æ¯|æƒæ–|å®å‰‘|é’±å¸)/);
      if (m) s[m[1]]++;
    }
    if (reversed) s.rev++;
  }
  return s;
}
function topicAdvice(topic){
  switch(topic){
    case "love":   return "æ„Ÿæƒ…å±‚é¢æ›´è¦çœŸè¯šæ²Ÿé€šã€ç»™å¯¹æ–¹ç©ºé—´ï¼›æŠŠç„¦ç‚¹æ”¾åœ¨åŒæ–¹çš„æ„Ÿå—ä¸èŠ‚å¥ï¼Œè€Œä¸æ˜¯ç»“è®ºã€‚";
    case "career": return "å·¥ä½œä¸Šå…ˆæ˜ç¡®ç›®æ ‡ä¸è¾¹ç•Œï¼Œæ‹†è§£ä»»åŠ¡ã€ç¨³æ­¥æ¨è¿›ï¼›é¿å…æƒ…ç»ªåŒ–å†³ç­–ï¼Œä¿ç•™Plan Bã€‚";
    case "wealth": return "è´¢åŠ¡ä»¥ç¨³å¥ä¸ºå…ˆï¼Œæ§åˆ¶æ”¯å‡ºã€åˆ†æ•£é£é™©ï¼›é¿å…è¿½é«˜ï¼ŒåŸºäºæ•°æ®åˆ¶å®šèŠ‚å¥ã€‚";
    case "study":  return "å­¦ä¹ è¦åˆ¶å®šå¯æ‰§è¡Œçš„è®¡åˆ’ï¼Œå…ˆè¡¥è–„å¼±ç¯èŠ‚ï¼Œåˆ©ç”¨ç•ªèŒ„é’Ÿä¿æŒä¸“æ³¨ã€‚";
    default:       return "è¯·æŠŠç²¾åŠ›æ”¾åœ¨å¯æ§çš„ä¸‹ä¸€æ­¥ï¼Œå…è®¸è¿‡ç¨‹ä¸­çš„ä¸ç¡®å®šï¼ŒæŒç»­å¾®è°ƒå°±ä¼šçœ‹åˆ°è¿›å±•ã€‚";
  }
}
function buildReading(q, picks, spread){
  const topic = detectTopic(q);
  const stats = suitStats(picks);
  const total = picks.length;
  const majorRate = Math.round(stats.major/total*100);
  const revRate = Math.round(stats.rev/total*100);

  const suitFocus = Object.entries({åœ£æ¯:stats.åœ£æ¯,æƒæ–:stats.æƒæ–,å®å‰‘:stats.å®å‰‘,é’±å¸:stats.é’±å¸})
    .sort((a,b)=>b[1]-a[1])[0];
  const suitHint = suitFocus && suitFocus[1]>0
      ? `æœ¬æ¬¡æŠ½ç‰Œä»¥ã€${suitFocus[0]}ã€‘ä¸ºä¸»ï¼ˆ${SUIT[suitFocus[0]]}ï¼‰ï¼Œè¯´æ˜è¿™ä»¶äº‹å½“å‰æ›´ä¾§é‡è¯¥ç»´åº¦ã€‚`
      : "æœ¬æ¬¡æŠ½ç‰Œä»¥å¤§é˜¿å°”å…‹é‚£ä¸ºä¸»ï¼Œæç¤ºè¿™æ˜¯é˜¶æ®µæ€§çš„å…³é”®è¯¾é¢˜ã€‚";

  const pos10 = ['å½“ä¸‹','é˜»ç¢','æ½œæ„è¯†','æ˜¾æ„è¯†','è¿‡å»','æœªæ¥','è‡ªæˆ‘','ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ'];
  const pos5  = ['è¿‡å»','æ½œæ„è¯†','å½“ä¸‹','å¤–åœ¨å½±å“','æœªæ¥è¶‹åŠ¿'];
  const list = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : (spread===5 ? pos5[i] : (spread===3 ? ['è¿‡å»','ç°åœ¨','æœªæ¥'][i] : 'å½“ä¸‹'));
    return `â€¢ ã€${label}ã€‘${c.name}ï¼ˆ${c.reversed?'é€†ä½':'æ­£ä½'}ï¼‰â€” ${parseMeaning(c.name,c.reversed).replace(/^æ­£ä½ï¼š|^é€†ä½ï¼š/,'')}`;
  }).join('<br>');

  const summary = `
    <p><b>é—®é¢˜ï¼š</b>${q||'ï¼ˆæœªå¡«å†™ï¼‰'}</p>
    <p>${suitHint} å¤§é˜¿å°”å…‹é‚£å æ¯”çº¦ <b>${majorRate}%</b>ï¼›é€†ä½çº¦ <b>${revRate}%</b>ï¼Œæç¤ºç›®å‰å­˜åœ¨ä¸€äº›é˜»æ»/éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†ã€‚</p>
    <p><b>é€ä½ç½®è§£è¯»ï¼š</b><br>${list}</p>
    <p><b>ç»¼åˆå»ºè®®ï¼š</b>${topicAdvice(topic)}</p>
  `;
  return summary;
}

/* ------------------ æŠ½ç‰Œ & æ¸²æŸ“ ------------------ */
function draw(){
  const n = +document.getElementById('spread').value;
  const q = document.getElementById('question').value.trim();
  document.getElementById('qdisplay').textContent = q ? `é—®é¢˜ï¼š${q}` : 'ï¼ˆæç¤ºï¼šè¾“å…¥é—®é¢˜ä¼šè®©è§£è¯»æ›´èšç„¦ï¼‰';

  const board = document.getElementById('board');
  board.innerHTML = '';
  board.className = 'board ' + (n===1?'spread-1':n===3?'spread-3':n===5?'spread-5':'spread-10');

  const pool = [...DECK];
  const take = ()=> pool.splice(Math.floor(Math.random()*pool.length),1)[0];
  const picks = [];

  function place(pair,label,extra=''){
    const [name,url] = pair;
    const reversed = Math.random() < 0.5;
    picks.push({name,reversed});

    const wrap = document.createElement('div');
    wrap.className = 'card ' + extra;

    const imgw = document.createElement('div'); imgw.className='imgwrap';
    const img = new Image();
    img.className='card-img';
    img.loading = 'eager';
    img.src = viaProxy(url, 400);           // ç›´æ¥èµ°ä»£ç†ï¼Œå‡å°‘åŠ è½½å¤±è´¥
    img.onerror = ()=>{ img.onerror=null; img.src = url; }; // ä»£ç†å¤±è´¥å†å›æº

    if (reversed) img.style.transform='rotate(180deg)';

    const cap = document.createElement('div'); cap.className='cap';
    cap.textContent = label ? `${name} Â· ${label}` : name;

    const mean = document.createElement('div'); mean.className='mean';
    mean.textContent = parseMeaning(name,reversed);

    imgw.appendChild(img);
    wrap.appendChild(imgw);
    wrap.appendChild(cap);
    wrap.appendChild(mean);
    board.appendChild(wrap);
  }

  if (n===1){
    place(take(),'å½“ä¸‹');
  }else if(n===3){
    place(take(),'è¿‡å»'); place(take(),'ç°åœ¨'); place(take(),'æœªæ¥');
  }else if(n===5){
    place(take(),'è¿‡å»','pos-top');
    place(take(),'æ½œæ„è¯†','pos-left');
    place(take(),'å½“ä¸‹','pos-center');
    place(take(),'å¤–åœ¨å½±å“','pos-right');
    place(take(),'æœªæ¥è¶‹åŠ¿','pos-bottom');
  }else{
    const labels10 = ['å½“ä¸‹','é˜»ç¢','æ½œæ„è¯†','æ˜¾æ„è¯†','è¿‡å»','æœªæ¥','è‡ªæˆ‘','ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ'];
    for(let i=0;i<10;i++) place(take(), labels10[i], `c${i+1}`);
  }

  // ç”Ÿæˆè§£è¯»
  const reading = document.getElementById('reading');
  const text = document.getElementById('readingText');
  text.innerHTML = buildReading(q, picks, n);
  reading.style.display = 'block';
}
function buildStory(q, picks, spread){
  const topicMap = {1:'å•å¼ æŒ‡å¼•',3:'ä¸‰å¼ ï¼ˆè¿‡å»/ç°åœ¨/æœªæ¥ï¼‰',5:'åå­—æ’æ³•',10:'å‡¯å°”ç‰¹åå­—'};
  const pos10 = ['å½“ä¸‹','é˜»ç¢','æ½œæ„è¯†','æ˜¾æ„è¯†','è¿‡å»','æœªæ¥','è‡ªæˆ‘','ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ'];
  const pos5  = ['è¿‡å»','æ½œæ„è¯†','å½“ä¸‹','å¤–åœ¨å½±å“','æœªæ¥è¶‹åŠ¿'];
  const pos3  = ['è¿‡å»','ç°åœ¨','æœªæ¥'];

  const head = `ä½ é—®çš„æ˜¯ã€Œ${q||'ï¼ˆæœªå¡«å†™ï¼‰'}ã€ã€‚æœ¬æ¬¡ä½¿ç”¨${topicMap[spread]}ã€‚æˆ‘ä¼šæŒ‰ä½ç½®é€å¼ è¯´æ˜ç‰Œé¢å«ä¹‰ä¸å½¼æ­¤çš„å½±å“ã€‚`;
  const lines = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : (spread===5 ? pos5[i] : (spread===3 ? pos3[i] : 'å½“ä¸‹'));
    const dir = c.reversed?'é€†ä½':'æ­£ä½';
    const mean = parseMeaning(c.name, c.reversed).replace(/^æ­£ä½ï¼š|^é€†ä½ï¼š/,'');
    return `ã€${label}ã€‘æŠ½åˆ°ã€Œ${c.name}ã€${dir}ã€‚è¿™å¼ ç‰Œæç¤ºï¼š${mean}ã€‚`;
  });

  // å…³è”/é€»è¾‘ï¼šæŠ“å–ç›¸é‚»å†²çª or åŒèŠ±è‰²å‘¼åº”
  const suit = n => (n.match(/^(åœ£æ¯|æƒæ–|å®å‰‘|é’±å¸)/)||[])[1]||'å¤§é˜¿å°”å…‹é‚£';
  const hooks = [];
  for(let i=0;i<picks.length-1;i++){
    if (suit(picks[i].name)===suit(picks[i+1].name))
      hooks.push(`ç¬¬${i+1}ä¸ç¬¬${i+2}å¼ åŒå±ã€Œ${suit(picks[i].name)}ã€ï¼Œä¸»é¢˜æœ‰è¿ç»­æ€§ï¼Œè¦ç‰¹åˆ«å…³æ³¨è¯¥ç»´åº¦çš„æ¨è¿›èŠ‚å¥ã€‚`);
    if (picks[i].reversed!==picks[i+1].reversed)
      hooks.push(`ç¬¬${i+1}ä¸ç¬¬${i+2}å¼ ä¸€æ­£ä¸€é€†ï¼Œæ„å‘³ç€æ­¤ç¯èŠ‚æ—¢æœ‰æœºä¼šä¹Ÿæœ‰é˜»æ»ï¼Œè¡ŒåŠ¨ä¸Šå®œå…ˆå°èŒƒå›´è¯•é”™å†æ”¾å¤§ã€‚`);
  }

  const tail = `ç»¼åˆæ¥çœ‹ï¼Œ${topicAdvice(detectTopic(q))}`;
  return [head, ...lines, (hooks.length?('è¡¥å……ï¼š'+hooks.join(' ')):''),
          tail].filter(Boolean).join('\n');
}

  const reading = document.getElementById('reading');
const text = document.getElementById('readingText');
const summaryHTML = buildReading(q, picks, n);      // ç»Ÿè®¡ + é€ä½ç½®åˆ—è¡¨ + å»ºè®®ï¼ˆä½ å·²æœ‰ï¼‰
const story = buildStory(q, picks, n)               // æ–°çš„ä¸²è®²
  .split('\n').map(p=>`<p>${p}</p>`).join('');
text.innerHTML = summaryHTML + `<hr style="border:0;border-top:1px solid #273245;margin:12px 0">` + story;
reading.style.display = 'block';

document.getElementById('go').addEventListener('click', draw);
        let lastSpoken = '';  // ç¼“å­˜ä¸Šæ¬¡è¦è¯»çš„æ–‡æœ¬
let speaking = false;

function pickZhVoice(){
  const vs = speechSynthesis.getVoices();
  // ä¼˜å…ˆä¸­æ–‡ï¼›æ‰¾ä¸åˆ°å°±ç”¨é»˜è®¤
  return vs.find(v=>/zh|cmn/i.test(v.lang)) || vs[0];
}

function speak(text){
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const v = pickZhVoice();
  if (v) u.voice = v;
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  u.onend = ()=>{ speaking=false; document.getElementById('ttsBtn').textContent='ğŸ”Š æœ—è¯»'; };
  speaking = true;
  document.getElementById('ttsBtn').textContent='â¸ æš‚åœ';
  speechSynthesis.speak(u);
}

function toggleTTS(){
  if (!('speechSynthesis' in window)) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»'); return; }
  if (speaking){
    speechSynthesis.cancel();
    speaking=false;
    document.getElementById('ttsBtn').textContent='ğŸ”Š æœ—è¯»';
  }else{
    speak(lastSpoken || 'æš‚æ— å¯æœ—è¯»å†…å®¹ã€‚');
  }
}

document.getElementById('ttsBtn')?.addEventListener('click', toggleTTS);

/* æ¯æ¬¡æŠ½ç‰Œåï¼Œæ›´æ–° lastSpoken ä¸ºâ€œä¸²è®²å…¨æ–‡â€ */
function updateSpeechBuffer(q, picks, n){
  lastSpoken = buildStory(q, picks, n);
}
</script>
</body>
</html>  

</script>
</body>
</html>
