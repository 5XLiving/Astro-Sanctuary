<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · 5X</title>
<style>
  :root{--bg:#0b0f14;--card:#11161dcc;--line:#1f2a36;--text:#e8edf3;--muted:#98a7b7;--gold:#e6c76e;--brand:#d4af37;--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans SC",system-ui,sans-serif}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:#0b0f14cc;border-bottom:1px solid var(--line)}
  .head-inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .brand-badge{background:var(--brand);color:#111;padding:6px 10px;border-radius:8px;font-weight:800}
  .title{font-weight:700}
  .lang select{padding:6px 8px;border-radius:8px;background:#0f1420;color:#e8edf3;border:1px solid #273245}
  .app{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:6px 0 14px;color:var(--brand);font-weight:800}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
  .controls input,.controls select,.controls button{padding:12px;border-radius:12px;border:1px solid #273245;background:#0f1420;color:var(--text)}
  .controls input{flex:1;min-width:220px}
  .controls button{cursor:pointer;background:linear-gradient(180deg,#fff9e6,var(--gold));color:#121212;border-color:var(--gold);font-weight:800}
  .q{margin:6px 0 12px;font-weight:600}
  .board{display:grid;gap:14px;justify-content:center}
  .card{display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px 10px 12px}
  .imgwrap{width:128px;height:212px;border-radius:10px;overflow:hidden;background:#000;display:grid;place-items:center;border:1px solid #34455a}
  .card-img{width:100%;height:100%;object-fit:contain;display:block}
  .cap{font-size:13px;color:#cfe3ff}
  .mean{font-size:12px;color:#a7b5c8}
  .spread-1{grid-template-columns:128px}
  .spread-3{grid-template-columns:repeat(3,128px)}
  .spread-5{grid-template-areas:"top top top" "left center right" ". bottom .";grid-template-columns:128px 128px 128px}
  .pos-top{grid-area:top}.pos-left{grid-area:left}.pos-center{grid-area:center}.pos-right{grid-area:right}.pos-bottom{grid-area:bottom}
  /* 10张：桌面 3-3-4 */
  .spread-10{display:grid;grid-template-columns:repeat(4,128px);grid-auto-rows:auto;gap:14px}
  .spread-10 .c1{grid-column:1;grid-row:1}.spread-10 .c2{grid-column:2;grid-row:1}.spread-10 .c3{grid-column:3;grid-row:1}
  .spread-10 .c4{grid-column:1;grid-row:2}.spread-10 .c5{grid-column:2;grid-row:2}.spread-10 .c6{grid-column:3;grid-row:2}
  .spread-10 .c7{grid-column:1;grid-row:3}.spread-10 .c8{grid-column:2;grid-row:3}.spread-10 .c9{grid-column:3;grid-row:3}
  .spread-10 .c10{grid-column:4;grid-row:3}
  @media(max-width:560px){
    .imgwrap{width:100px;height:166px}
    .spread-1{grid-template-columns:100px}
    .spread-3{grid-template-columns:repeat(3,100px)}
    .spread-5{grid-template-columns:100px 100px 100px}
    .spread-10{grid-template-columns:repeat(2,1fr);grid-auto-flow:row}
    .spread-10 .c1,.spread-10 .c2,.spread-10 .c3,.spread-10 .c4,.spread-10 .c5,.spread-10 .c6,.spread-10 .c7,.spread-10 .c8,.spread-10 .c9,.spread-10 .c10{grid-column:auto;grid-row:auto}
  }
  .panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 8px;font-size:1.05rem;color:#ffe084}
  .muted{color:#98a7b7}
  
    /* Chat 浮窗按钮也换成亮金 */
  .ss-chat-fab{
    position: fixed; right: 18px; bottom: 18px; z-index: 50;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(180deg,#fff9e6,#e6c76e);
    color:#191919;
    display:grid; place-items:center; font-weight:800;
    box-shadow:0 8px 30px rgba(0,0,0,.35); cursor:pointer;
    border:1px solid #e6c76e;
  }
</style>
</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select>
        <option>简体中文</option><option>繁體中文</option><option>English</option>
        <option>日本語</option><option>ไทย</option><option>Bahasa Melayu</option>
      </select>
    </div>
  </div><!-- 关闭 .head-inner -->
</header>

<div class="app">
  <h1>塔罗牌占卜</h1>
  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" />
    <select id="spread">
      <option value="1">单张</option>
      <option value="3">三张（过去 / 现在 / 未来）</option>
      <option value="5">十字排法（5张）</option>
      <option value="10">凯尔特十字（10张）</option>
    </select>
    <button id="go">抽牌</button>
  </div>
  <div id="qdisplay" class="q muted">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <!-- 只保留一个解读面板（带朗读按钮） -->
  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      解读与建议
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">🔊 朗读</button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted">说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。</div>
</div>

<script>
/* --- 工具：图片代理 --- */
function viaProxy(url,w=360){const noProto=url.replace(/^https?:\/\//,'');return `https://images.weserv.nl/?url=${encodeURIComponent(noProto)}&w=${w}`}

/* --- 牌库（维基 78 张） --- */
const WIKI_CARDS={
  "00_愚者 Fool":"https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_00_Fool.jpg",
  "01_魔术师 Magician":"https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg",
  "02_女祭司 High Priestess":"https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg",
  "03_女皇 Empress":"https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg",
  "04_皇帝 Emperor":"https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg",
  "05_教皇 Hierophant":"https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg",
  "06_恋人 Lovers":"https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg",
  "07_战车 Chariot":"https://upload.wikimedia.org/wikipedia/commons/9/9b/TheChariot.jpg",
  "08_力量 Strength":"https://upload.wikimedia.org/wikipedia/commons/f/f5/Strength_tarot_card.jpg",
  "09_隐士 Hermit":"https://upload.wikimedia.org/wikipedia/commons/4/4d/TheHermit.jpg",
  "10_命运之轮 Wheel of Fortune":"https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg",
  "11_正义 Justice":"https://upload.wikimedia.org/wikipedia/commons/e/e0/JusticeTarot.JPG",
  "12_倒吊人 Hanged Man":"https://upload.wikimedia.org/wikipedia/commons/2/2b/TheHangedMan.jpg",
  "13_死神 Death":"https://upload.wikimedia.org/wikipedia/commons/d/d7/Death_card.jpg",
  "14_节制 Temperance":"https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg",
  "15_恶魔 Devil":"https://upload.wikimedia.org/wikipedia/commons/5/55/TheDevil.jpg",
  "16_高塔 Tower":"https://upload.wikimedia.org/wikipedia/commons/5/53/TheTower.jpg",
  "17_星星 Star":"https://upload.wikimedia.org/wikipedia/commons/d/db/TheStar.jpg",
  "18_月亮 Moon":"https://upload.wikimedia.org/wikipedia/commons/7/7f/TheMoonTarotCard.jpg",
  "19_太阳 Sun":"https://upload.wikimedia.org/wikipedia/commons/1/17/TheSunTarotCard.jpg",
  "20_审判 Judgement":"https://upload.wikimedia.org/wikipedia/commons/d/dd/JudgementTarot.jpg",
  "21_世界 World":"https://upload.wikimedia.org/wikipedia/commons/f/ff/TheWorldTarotCard.jpg",
  "圣杯Ace":"https://upload.wikimedia.org/wikipedia/commons/3/36/Cups01.jpg","圣杯2":"https://upload.wikimedia.org/wikipedia/commons/f/f8/Cups02.jpg","圣杯3":"https://upload.wikimedia.org/wikipedia/commons/7/7d/Cups03.jpg","圣杯4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Cups04.jpg","圣杯5":"https://upload.wikimedia.org/wikipedia/commons/0/06/Cups05.jpg","圣杯6":"https://upload.wikimedia.org/wikipedia/commons/1/17/Cups06.jpg","圣杯7":"https://upload.wikimedia.org/wikipedia/commons/a/ab/Cups07.jpg","圣杯8":"https://upload.wikimedia.org/wikipedia/commons/6/60/Cups08.jpg","圣杯9":"https://upload.wikimedia.org/wikipedia/commons/2/24/Cups09.jpg","圣杯10":"https://upload.wikimedia.org/wikipedia/commons/8/84/Cups10.jpg","圣杯侍从":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Cups11.jpg","圣杯骑士":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Cups12.jpg","圣杯皇后":"https://upload.wikimedia.org/wikipedia/commons/6/62/Cups13.jpg","圣杯国王":"https://upload.wikimedia.org/wikipedia/commons/0/04/Cups14.jpg",
  "权杖Ace":"https://upload.wikimedia.org/wikipedia/commons/1/11/Wands01.jpg","权杖2":"https://upload.wikimedia.org/wikipedia/commons/0/0f/Wands02.jpg","权杖3":"https://upload.wikimedia.org/wikipedia/commons/f/ff/Wands03.jpg","权杖4":"https://upload.wikimedia.org/wikipedia/commons/a/a4/Wands04.jpg","权杖5":"https://upload.wikimedia.org/wikipedia/commons/9/9d/Wands05.jpg","权杖6":"https://upload.wikimedia.org/wikipedia/commons/3/3b/Wands06.jpg","权杖7":"https://upload.wikimedia.org/wikipedia/commons/e/e4/Wands07.jpg","权杖8":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands08.jpg","权杖9":"https://upload.wikimedia.org/wikipedia/commons/0/0b/Wands09.jpg","权杖10":"https://upload.wikimedia.org/wikipedia/commons/4/4d/Wands10.jpg","权杖侍从":"https://upload.wikimedia.org/wikipedia/commons/0/0a/Wands11.jpg","权杖骑士":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands12.jpg","权杖皇后":"https://upload.wikimedia.org/wikipedia/commons/1/1c/Wands13.jpg","权杖国王":"https://upload.wikimedia.org/wikipedia/commons/0/0d/Wands14.jpg",
  "宝剑Ace":"https://upload.wikimedia.org/wikipedia/commons/1/1a/Swords01.jpg","宝剑2":"https://upload.wikimedia.org/wikipedia/commons/9/9e/Swords02.jpg","宝剑3":"https://upload.wikimedia.org/wikipedia/commons/0/02/Swords03.jpg","宝剑4":"https://upload.wikimedia.org/wikipedia/commons/b/bf/Swords04.jpg","宝剑5":"https://upload.wikimedia.org/wikipedia/commons/2/23/Swords05.jpg","宝剑6":"https://upload.wikimedia.org/wikipedia/commons/2/29/Swords06.jpg","宝剑7":"https://upload.wikimedia.org/wikipedia/commons/3/34/Swords07.jpg","宝剑8":"https://upload.wikimedia.org/wikipedia/commons/b/b8/Swords08.jpg","宝剑9":"https://upload.wikimedia.org/wikipedia/commons/2/2f/Swords09.jpg","宝剑10":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords10.jpg","宝剑侍从":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords11.jpg","宝剑骑士":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords12.jpg","宝剑皇后":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords13.jpg","宝剑国王":"https://upload.wikimedia.org/wikipedia/commons/3/31/Swords14.jpg",
  "钱币Ace":"https://upload.wikimedia.org/wikipedia/commons/f/fd/Pents01.jpg","钱币2":"https://upload.wikimedia.org/wikipedia/commons/9/9f/Pents02.jpg","钱币3":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents03.jpg","钱币4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Pents04.jpg","钱币5":"https://upload.wikimedia.org/wikipedia/commons/5/50/Pents05.jpg","钱币6":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents06.jpg","钱币7":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Pents07.jpg","钱币8":"https://upload.wikimedia.org/wikipedia/commons/e/e7/Pents08.jpg","钱币9":"https://upload.wikimedia.org/wikipedia/commons/6/6a/Pents09.jpg","钱币10":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents10.jpg","钱币侍从":"https://upload.wikimedia.org/wikipedia/commons/7/78/Pents11.jpg","钱币骑士":"https://upload.wikimedia.org/wikipedia/commons/2/2d/Pents12.jpg","钱币皇后":"https://upload.wikimedia.org/wikipedia/commons/8/88/Pents13.jpg","钱币国王":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents14.jpg"
};
const DECK=Object.entries(WIKI_CARDS);

/* --- 牌义（简明） --- */
const MAJOR_MEAN={0:"新的开始/自由/潜能",1:"意志/行动/显化",2:"直觉/神秘/内在智慧",3:"滋养/丰盛/创造",4:"秩序/权威/结构",5:"传统/信念/导师",6:"选择/关系/吸引",7:"前进/掌控/胜利",8:"勇气/温柔的力量",9:"独处/寻找答案",10:"周期/转折/命运",11:"公平/因果/平衡",12:"暂停/换位/臣服",13:"结束与重生",14:"调和/节制/中道",15:"诱惑/束缚/阴影",16:"突变/瓦解/醒悟",17:"希望/疗愈/启发",18:"不安/潜意识/迷雾",19:"喜悦/成功/清晰",20:"觉醒/召唤/赦免",21:"完成/整合/世界"};
const SUIT={"圣杯":"情感/关系","权杖":"行动/热情","宝剑":"思维/沟通/挑战","钱币":"物质/财务/事业"};
const RANK={"Ace":"开始/机遇","2":"平衡/对立","3":"成长/协作","4":"稳定/停滞","5":"冲突/压力","6":"给予/和谐","7":"考验/选择","8":"行动/进展","9":"成果/负担","10":"阶段结束/丰收","侍从":"讯息/起步","骑士":"推动/追求","皇后":"成熟/吸引","国王":"掌控/负责"};

function parseMeaning(name,reversed){
  if(/^\d{2}_/.test(name)){const n=+name.slice(0,2),base=MAJOR_MEAN[n]||"";return (reversed?"逆位：":"正位：")+(reversed?base.replaceAll("/","/阻滞·"):base)}
  const m=name.match(/^(圣杯|权杖|宝剑|钱币)(Ace|[2-9]|10|侍从|骑士|皇后|国王)/);
  if(m){const suit=m[1],rank=m[2],base=`${SUIT[suit]} · ${RANK[rank]||""}`;return (reversed?"逆位：":"正位：")+(reversed?`${base}（阻滞/反向）`:base)}
  return reversed?"逆位":"正位";
}

function buildReading(q, picks, spread){
  const stats = suitStats(picks);
  const total = picks.length;
  const majorRate = Math.round(stats.major / total * 100);
  const revRate   = Math.round(stats.rev   / total * 100);

  const focus = Object.entries({圣杯:stats.圣杯, 权杖:stats.权杖, 宝剑:stats.宝剑, 钱币:stats.钱币})
    .sort((a,b)=>b[1]-a[1])[0];

  const suitHint = (focus && focus[1] > 0)
    ? `本次抽牌以【${focus[0]}】为主（${SUIT[focus[0]]}），说明这件事当前更侧重该维度。`
    : '本次抽牌以大阿尔克那为主，提示这是阶段性的关键课题。';

  const pos10 = ['当下','阻碍','潜意识','显意识','过去','未来','自我','环境','希望/恐惧','结果'];
  const pos5  = ['过去','潜意识','当下','外在影响','未来趋势'];

  const list = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : spread===5 ? pos5[i] : spread===3 ? ['过去','现在','未来'][i] : '当下';
    return `• 【${label}】${c.name}（${c.reversed?'逆位':'正位'}）— ${parseMeaning(c.name,c.reversed).replace(/^正位：|^逆位：/,'')}`;
  }).join('<br>');

  return `
    <p><b>问题：</b>${q || '（未填写）'}</p>
    <p>${suitHint} 大阿尔克那占比约 <b>${majorRate}%</b>；逆位约 <b>${revRate}%</b>。</p>
    <p><b>逐位置解读：</b><br>${list}</p>
    <p><b>综合建议：</b>${topicAdvice(detectTopic(q))}</p>
  `;
}

function buildStory(q, picks, spread){
  const topicMap = {1:'单张指引',3:'三张（过去/现在/未来）',5:'十字排法',10:'凯尔特十字'};
  const pos10 = ['当下','阻碍','潜意识','显意识','过去','未来','自我','环境','希望/恐惧','结果'];
  const pos5  = ['过去','潜意识','当下','外在影响','未来趋势'];
  const pos3  = ['过去','现在','未来'];

  const head = `你问的是「${q || '（未填写）'}」。本次使用${topicMap[spread]}。我会按位置逐张说明牌面含义与彼此的影响。`;

  const lines = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : spread===5 ? pos5[i] : spread===3 ? pos3[i] : '当下';
    const dir   = c.reversed ? '逆位' : '正位';
    const mean  = parseMeaning(c.name, c.reversed).replace(/^正位：|^逆位：/,'');
    return `【${label}】抽到「${c.name}」${dir}。这张牌提示：${mean}。`;
  });

  const getSuit = n => (n.match(/^(圣杯|权杖|宝剑|钱币)/)||[])[1] || '大阿尔克那';
  const hooks = [];
  for (let i=0;i<picks.length-1;i++){
    if (getSuit(picks[i].name) === getSuit(picks[i+1].name)){
      hooks.push(`第${i+1}与第${i+2}张同属「${getSuit(picks[i].name)}」，主题有连续性。`);
    }
    if (picks[i].reversed !== picks[i+1].reversed){
      hooks.push(`第${i+1}与第${i+2}张一正一逆，意味着此环节既有机会也有阻滞。`);
    }
  }

  const tail = `综合来看，${topicAdvice(detectTopic(q))}`;
  return [head, ...lines, (hooks.length ? ('补充：' + hooks.join(' ')) : ''), tail]
    .filter(Boolean)
    .join('\n');
}
      // —— Chat 浮窗文案 ——
    chat_fab:"Chat",
    chat_placeholder:"有什么想咨询的？",
    chat_send:"发送"
  }
</script>
</body>
</html>
