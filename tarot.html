<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · 5X</title>
<style>
/* ======================
   THEME · VARIABLES
====================== */
:root{
  --bg:#0b0f14;          /* 页面背景 */
  --card:#11161dcc;      /* 卡片底色 */
  --line:#1f2a36;        /* 边框线 */
  --text:#e8edf3;        /* 备用浅字色 */
  --muted:#98a7b7;       /* 次级文字 */
  --gold:#e6c76e;        /* 主金色 */
  --brand:#d4af37;       /* 品牌金色更偏黄 */
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;        /* 牌卡宽（桌面） */
  --card-h:212px;        /* 牌卡高（桌面） */
  --gap:14px;            /* 栅格间距 */
}

/* ==============
   GLOBAL RESET
============== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* 统一金色字体（占卜区 & 主要正文） */
body, p, h1, h2, h3, h4, h5, h6, span, div { color: var(--gold); }
.card-text, .tarot-desc { color: var(--gold) !important; }

/* 深色滚动条（可选） */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* ==================
   FLOATING HEADER
================== */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700}
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* ==================
   PAGE CONTAINER
================== */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--brand); font-weight:800}

/* ===============
   CONTROLS BAR
================ */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600}

/* 选几张牌的 UI（仅样式，功能用 JS 接） */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--gold); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* ==========================
   BOARD · CARD COMMON STYLES
========================== */
.board{display:grid; gap:var(--gap); justify-content:center}

/* 单张卡片组件（图+标题+简意） */
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:#cfe3ff}
.mean{font-size:12px; color:#a7b5c8}

/* =========
   SPREADS
========= */
/* 1 张 */
.spread-1{grid-template-columns:var(--card-w)}

/* 3 张（横排） */
.spread-3{grid-template-columns:repeat(3,var(--card-w))}

/* 5 张（十字） */
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}

/* 10 张：3-3-4 居中（行容器法，保证每行居中） */
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}

/* 每一行都是独立的 grid，便于居中三列或四列 */
.spread-10 .row{
  display:grid; gap:var(--gap);
  justify-content:center; /* 行内整体居中 */
}
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* 位置标记（c1..c10）仅用于语义，实际布局交给 row 容器 */
.c1,.c2,.c3,.c4,.c5,.c6,.c7,.c8,.c9,.c10{}

/* =================
   PANELS / BLOCKS
================= */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* =======================
   CHATGPT-LIKE BUBBLES
======================= */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--gold)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* 代码块样式（与 index 保持一致的深色边框 & 金色文字） */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* 小徽章 & 逆位标记 */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* ===============
   RESPONSIVE
=============== */
@media (max-width:560px){
  :root{
    --card-w:100px;
    --card-h:166px;
    --gap:12px;
  }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  /* 10张小屏：按两列流式排布，避免拥挤 */
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>

</head>
<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <div class="brand-badge">5X</div>
      <div class="title" data-i18n="brand_title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh">简体中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">塔罗牌占卜</h1>
  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">单张</option>
      <option value="3" data-i18n="s3">三张（过去 / 现在 / 未来）</option>
      <option value="5" data-i18n="s5">十字排法（5张）</option>
      <option value="10" data-i18n="s10">凯尔特十字（10张）</option>
    </select>
    <button id="go" data-i18n="draw_btn">抽牌</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px">
      <span data-i18n="reading_title">解读与建议</span>
      <button id="ttsBtn" class="btn" style="padding:6px 10px;border-radius:10px;border:1px solid #273245;background:#0f1420;color:#ffe084;cursor:pointer">🔊 <span data-i18n="tts_btn">朗读</span></button>
    </h3>
    <div id="readingText"></div>
  </div>

  <div class="panel muted" data-i18n="disclaimer">
    说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。
  </div>
</div>

<script>
/* ============ 简易 i18n ============ */
const I18N = {
  zh: {
    brand_title: "命理心怜空间 · Soul Sanctuary",
    page_title: "塔罗牌占卜",
    q_ph: "请输入你的问题（必填，决定解读方向）",
    s1: "单张",
    s3: "三张（过去 / 现在 / 未来）",
    s5: "十字排法（5张）",
    s10: "凯尔特十字（10张）",
    draw_btn: "抽牌",
    tip_focus: "（提示：输入问题会让解读更聚焦）",
    reading_title: "解读与建议",
    tts_btn: "朗读",
    disclaimer: "说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先。"
  },
  en: {
    brand_title: "Soul Sanctuary · 5X",
    page_title: "Tarot Reading",
    q_ph: "Type your question (required, focuses the reading)",
    s1: "Single card",
    s3: "Three cards (Past / Present / Future)",
    s5: "Cross Spread (5)",
    s10: "Celtic Cross (10)",
    draw_btn: "Draw",
    tip_focus: "(Tip: entering a question helps focus the reading.)",
    reading_title: "Reading & Advice",
    tts_btn: "Read Aloud",
    disclaimer: "Note: Tarot offers guidance only. Not medical/legal/financial advice—use your judgment and free will."
  }
};
let currentLang='zh';
function applyI18N(lang){
  const dict = I18N[lang] || I18N.zh;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k = el.getAttribute("data-i18n");
    if (dict[k] != null) el.textContent = dict[k];
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const k = el.getAttribute("data-i18n-placeholder");
    if (dict[k] != null) el.setAttribute("placeholder", dict[k]);
  });
}

/* --- 工具：图片代理 --- */
function viaProxy(url,w=360){const noProto=url.replace(/^https?:\/\//,'');return `https://images.weserv.nl/?url=${encodeURIComponent(noProto)}&w=${w}`}

/* --- 牌库（维基 78 张） --- */
const WIKI_CARDS={
  "00_愚者 Fool":"https://upload.wikimedia.org/wikipedia/commons/5/53/RWS_Tarot_00_Fool.jpg",
  "01_魔术师 Magician":"https://upload.wikimedia.org/wikipedia/commons/d/de/RWS_Tarot_01_Magician.jpg",
  "02_女祭司 High Priestess":"https://upload.wikimedia.org/wikipedia/commons/8/88/RWS_Tarot_02_High_Priestess.jpg",
  "03_女皇 Empress":"https://upload.wikimedia.org/wikipedia/commons/d/d2/RWS_Tarot_03_Empress.jpg",
  "04_皇帝 Emperor":"https://upload.wikimedia.org/wikipedia/commons/c/c3/RWS_Tarot_04_Emperor.jpg",
  "05_教皇 Hierophant":"https://upload.wikimedia.org/wikipedia/commons/8/8d/RWS_Tarot_05_Hierophant.jpg",
  "06_恋人 Lovers":"https://upload.wikimedia.org/wikipedia/commons/3/3a/TheLovers.jpg",
  "07_战车 Chariot":"https://upload.wikimedia.org/wikipedia/commons/9/9b/TheChariot.jpg",
  "08_力量 Strength":"https://upload.wikimedia.org/wikipedia/commons/f/f5/Strength_tarot_card.jpg",
  "09_隐士 Hermit":"https://upload.wikimedia.org/wikipedia/commons/4/4d/TheHermit.jpg",
  "10_命运之轮 Wheel of Fortune":"https://upload.wikimedia.org/wikipedia/commons/3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg",
  "11_正义 Justice":"https://upload.wikimedia.org/wikipedia/commons/e/e0/JusticeTarot.JPG",
  "12_倒吊人 Hanged Man":"https://upload.wikimedia.org/wikipedia/commons/2/2b/TheHangedMan.jpg",
  "13_死神 Death":"https://upload.wikimedia.org/wikipedia/commons/d/d7/Death_card.jpg",
  "14_节制 Temperance":"https://upload.wikimedia.org/wikipedia/commons/f/f8/RWS_Tarot_14_Temperance.jpg",
  "15_恶魔 Devil":"https://upload.wikimedia.org/wikipedia/commons/5/55/TheDevil.jpg",
  "16_高塔 Tower":"https://upload.wikimedia.org/wikipedia/commons/5/53/TheTower.jpg",
  "17_星星 Star":"https://upload.wikimedia.org/wikipedia/commons/d/db/TheStar.jpg",
  "18_月亮 Moon":"https://upload.wikimedia.org/wikipedia/commons/7/7f/TheMoonTarotCard.jpg",
  "19_太阳 Sun":"https://upload.wikimedia.org/wikipedia/commons/1/17/TheSunTarotCard.jpg",
  "20_审判 Judgement":"https://upload.wikimedia.org/wikipedia/commons/d/dd/JudgementTarot.jpg",
  "21_世界 World":"https://upload.wikimedia.org/wikipedia/commons/f/ff/TheWorldTarotCard.jpg",
  "圣杯Ace":"https://upload.wikimedia.org/wikipedia/commons/3/36/Cups01.jpg",
  "圣杯2":"https://upload.wikimedia.org/wikipedia/commons/f/f8/Cups02.jpg",
  "圣杯3":"https://upload.wikimedia.org/wikipedia/commons/7/7d/Cups03.jpg",
  "圣杯4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Cups04.jpg",
  "圣杯5":"https://upload.wikimedia.org/wikipedia/commons/0/06/Cups05.jpg",
  "圣杯6":"https://upload.wikimedia.org/wikipedia/commons/1/17/Cups06.jpg",
  "圣杯7":"https://upload.wikimedia.org/wikipedia/commons/a/ab/Cups07.jpg",
  "圣杯8":"https://upload.wikimedia.org/wikipedia/commons/6/60/Cups08.jpg",
  "圣杯9":"https://upload.wikimedia.org/wikipedia/commons/2/24/Cups09.jpg",
  "圣杯10":"https://upload.wikimedia.org/wikipedia/commons/8/84/Cups10.jpg",
  "圣杯侍从":"https://upload.wikimedia.org/wikipedia/commons/6/6d/Cups11.jpg",
  "圣杯骑士":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Cups12.jpg",
  "圣杯皇后":"https://upload.wikimedia.org/wikipedia/commons/6/62/Cups13.jpg",
  "圣杯国王":"https://upload.wikimedia.org/wikipedia/commons/0/04/Cups14.jpg",
  "权杖Ace":"https://upload.wikimedia.org/wikipedia/commons/1/11/Wands01.jpg",
  "权杖2":"https://upload.wikimedia.org/wikipedia/commons/0/0f/Wands02.jpg",
  "权杖3":"https://upload.wikimedia.org/wikipedia/commons/f/ff/Wands03.jpg",
  "权杖4":"https://upload.wikimedia.org/wikipedia/commons/a/a4/Wands04.jpg",
  "权杖5":"https://upload.wikimedia.org/wikipedia/commons/9/9d/Wands05.jpg",
  "权杖6":"https://upload.wikimedia.org/wikipedia/commons/3/3b/Wands06.jpg",
  "权杖7":"https://upload.wikimedia.org/wikipedia/commons/e/e4/Wands07.jpg",
  "权杖8":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands08.jpg",
  "权杖9":"https://upload.wikimedia.org/wikipedia/commons/0/0b/Wands09.jpg",
  "权杖10":"https://upload.wikimedia.org/wikipedia/commons/4/4d/Wands10.jpg",
  "权杖侍从":"https://upload.wikimedia.org/wikipedia/commons/0/0a/Wands11.jpg",
  "权杖骑士":"https://upload.wikimedia.org/wikipedia/commons/6/6b/Wands12.jpg",
  "权杖皇后":"https://upload.wikimedia.org/wikipedia/commons/1/1c/Wands13.jpg",
  "权杖国王":"https://upload.wikimedia.org/wikipedia/commons/0/0d/Wands14.jpg",
  "宝剑Ace":"https://upload.wikimedia.org/wikipedia/commons/1/1a/Swords01.jpg",
  "宝剑2":"https://upload.wikimedia.org/wikipedia/commons/9/9e/Swords02.jpg",
  "宝剑3":"https://upload.wikimedia.org/wikipedia/commons/0/02/Swords03.jpg",
  "宝剑4":"https://upload.wikimedia.org/wikipedia/commons/b/bf/Swords04.jpg",
  "宝剑5":"https://upload.wikimedia.org/wikipedia/commons/2/23/Swords05.jpg",
  "宝剑6":"https://upload.wikimedia.org/wikipedia/commons/2/29/Swords06.jpg",
  "宝剑7":"https://upload.wikimedia.org/wikipedia/commons/3/34/Swords07.jpg",
  "宝剑8":"https://upload.wikimedia.org/wikipedia/commons/b/b8/Swords08.jpg",
  "宝剑9":"https://upload.wikimedia.org/wikipedia/commons/2/2f/Swords09.jpg",
  "宝剑10":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords10.jpg",
  "宝剑侍从":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords11.jpg",
  "宝剑骑士":"https://upload.wikimedia.org/wikipedia/commons/4/4c/Swords12.jpg",
  "宝剑皇后":"https://upload.wikimedia.org/wikipedia/commons/d/d4/Swords13.jpg",
  "宝剑国王":"https://upload.wikimedia.org/wikipedia/commons/3/31/Swords14.jpg",
  "钱币Ace":"https://upload.wikimedia.org/wikipedia/commons/f/fd/Pents01.jpg",
  "钱币2":"https://upload.wikimedia.org/wikipedia/commons/9/9f/Pents02.jpg",
  "钱币3":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents03.jpg",
  "钱币4":"https://upload.wikimedia.org/wikipedia/commons/3/35/Pents04.jpg",
  "钱币5":"https://upload.wikimedia.org/wikipedia/commons/5/50/Pents05.jpg",
  "钱币6":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents06.jpg",
  "钱币7":"https://upload.wikimedia.org/wikipedia/commons/f/f0/Pents07.jpg",
  "钱币8":"https://upload.wikimedia.org/wikipedia/commons/e/e7/Pents08.jpg",
  "钱币9":"https://upload.wikimedia.org/wikipedia/commons/6/6a/Pents09.jpg",
  "钱币10":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents10.jpg",
  "钱币侍从":"https://upload.wikimedia.org/wikipedia/commons/7/78/Pents11.jpg",
  "钱币骑士":"https://upload.wikimedia.org/wikipedia/commons/2/2d/Pents12.jpg",
  "钱币皇后":"https://upload.wikimedia.org/wikipedia/commons/8/88/Pents13.jpg",
  "钱币国王":"https://upload.wikimedia.org/wikipedia/commons/4/42/Pents14.jpg"
};
const DECK=Object.entries(WIKI_CARDS);

/* --- 牌义（简明） --- */
const MAJOR_MEAN={0:"新的开始/自由/潜能",1:"意志/行动/显化",2:"直觉/神秘/内在智慧",3:"滋养/丰盛/创造",4:"秩序/权威/结构",5:"传统/信念/导师",6:"选择/关系/吸引",7:"前进/掌控/胜利",8:"勇气/温柔的力量",9:"独处/寻找答案",10:"周期/转折/命运",11:"公平/因果/平衡",12:"暂停/换位/臣服",13:"结束与重生",14:"调和/节制/中道",15:"诱惑/束缚/阴影",16:"突变/瓦解/醒悟",17:"希望/疗愈/启发",18:"不安/潜意识/迷雾",19:"喜悦/成功/清晰",20:"觉醒/召唤/赦免",21:"完成/整合/世界"};
const SUIT={"圣杯":"情感/关系","权杖":"行动/热情","宝剑":"思维/沟通/挑战","钱币":"物质/财务/事业"};
const RANK={"Ace":"开始/机遇","2":"平衡/对立","3":"成长/协作","4":"稳定/停滞","5":"冲突/压力","6":"给予/和谐","7":"考验/选择","8":"行动/进展","9":"成果/负担","10":"阶段结束/丰收","侍从":"讯息/起步","骑士":"推动/追求","皇后":"成熟/吸引","国王":"掌控/负责"};

function parseMeaning(name,reversed){
  if(/^\d{2}_/.test(name)){
    const n=+name.slice(0,2),base=MAJOR_MEAN[n]||"";
    return (reversed?"逆位：":"正位：")+(reversed?base.replaceAll("/","/阻滞·"):base);
  }
  const m=name.match(/^(圣杯|权杖|宝剑|钱币)(Ace|[2-9]|10|侍从|骑士|皇后|国王)/);
  if(m){
    const suit=m[1],rank=m[2],base=`${SUIT[suit]} · ${RANK[rank]||""}`;
    return (reversed?"逆位：":"正位：")+(reversed?`${base}（阻滞/反向）`:base);
  }
  return reversed?"逆位":"正位";
}

/* --- 主题推断与建议 --- */
// 统计花色/大牌/逆位
function suitStats(picks){
  const s={圣杯:0,权杖:0,宝剑:0,钱币:0,major:0,rev:0};
  for(const {name,reversed} of picks){
    if(/^\d{2}_/.test(name)) s.major++;
    else{
      const m=name.match(/^(圣杯|权杖|宝剑|钱币)/);
      if(m) s[m[1]]++;
    }
    if(reversed) s.rev++;
  }
  return s;
}

// 根据问题(中英)+牌面统计 推断主题；问题缺失时用花色兜底
function inferTopic(q, picks, stats){
  const text = (q || '').toLowerCase();

  const isLove   = /(爱|恋|感情|婚|复合|暧昧|桃花)/.test(q||'') || /(love|relationship|crush|ex|marriage)/i.test(text);
  const isCareer = /(工作|职|事业|面试|升职|跳槽|合作|老板|团队|项目)/.test(q||'') || /(career|job|work|interview|promotion|boss|project|startup)/i.test(text);
  const isWealth = /(财|钱|收入|投资|借贷|股票|基金|房|车|薪|报酬)/.test(q||'') || /(money|finance|wealth|investment|stock|crypto|salary|pay|house)/i.test(text);
  const isStudy  = /(学业|考试|录取|论文|成绩|考研|学校)/.test(q||'') || /(study|exam|test|school|grade|admission|thesis)/i.test(text);

  let topic = isLove ? 'love' : isCareer ? 'career' : isWealth ? 'wealth' : isStudy ? 'study' : 'general';

  if (topic === 'general'){
    const suitCount = { '圣杯':'love', '权杖':'career', '钱币':'wealth', '宝剑':'study' };
    const entries = Object.entries(suitCount).map(([suit,t])=>({ suit, t, n: stats[suit] || 0 }));
    entries.sort((a,b)=>b.n - a.n);
    if (entries[0].n > 0) topic = entries[0].t;
  }
  return topic;
}

// 专业建议：结合主题 + 逆位/大牌占比微调语气
function topicAdvice(topic, stats, spreadName){
  const total = (stats.圣杯 + stats.权杖 + stats.宝剑 + stats.钱币 + stats.major) || 1;
  const revRate   = Math.round(stats.rev / total * 100);
  const majorRate = Math.round(stats.major / total * 100);

  const caution = revRate >= 50 ? '当前阻滞较多，宜先排雷后行动。' :
                  revRate >= 30 ? '存在分歧或延迟，节奏放慢、先做校准。' : '机遇大于阻碍，保持节奏即可。';
  const phase    = majorRate >= 50 ? '这是阶段性的关键课题，建议设定里程碑并复盘。' : '';

  const base = {
    love:   `感情主题${spreadName ? `（${spreadName}）` : ''}：优先「真诚沟通 + 边界感」。若进展卡住，先同步期待值与节奏，再谈结论。`,
    career: `事业/工作${spreadName ? `（${spreadName}）` : ''}：把目标拆成本周可交付，关键任务先行；对不确定项做预案与对齐。`,
    wealth: `金钱/投资${spreadName ? `（${spreadName}）` : ''}：以稳健为先，控制支出、分散风险；任何加仓前先确认数据与止损位。`,
    study:  `学习/考试${spreadName ? `（${spreadName}）` : ''}：先补弱项，建立每日固定时段；用番茄钟与阶段小测验证进度。`,
    general:`当前议题${spreadName ? `（${spreadName}）` : ''}：先明确下一步可控动作，保持小步快跑与复盘。`
  }[topic];

  return `${base} ${caution} ${phase}`.trim();
}

/* --- 文本解读（统一口径） --- */
function buildReading(q, picks, spread){
  const pos10=['当下','阻碍','潜意识','显意识','过去','未来','自我','环境','希望/恐惧','结果'];
  const pos5 =['过去','潜意识','当下','外在影响','未来趋势'];
  const pos3 =['过去','现在','未来'];
  const spreadName = ({1:'单张',3:'三张（过去/现在/未来）',5:'十字排法（5张）',10:'凯尔特十字（10张）'})[spread];

  // 统计
  const stats = suitStats(picks);
  const total = picks.length || 1;
  const majorRate = Math.round(stats.major/total*100);
  const revRate   = Math.round(stats.rev/total*100);
  const focus = Object.entries({圣杯:stats.圣杯,权杖:stats.权杖,宝剑:stats.宝剑,钱币:stats.钱币})
                      .sort((a,b)=>b[1]-a[1])[0];
  const suitHint = (focus && focus[1] > 0)
    ? `本次抽牌以【${focus[0]}】为主（${SUIT[focus[0]]}），说明这件事当前更侧重该维度。`
    : `本次抽牌以大阿尔克那为主，提示这是阶段性的关键课题。`;

  // 逐位置解读
  const list = picks.map((c,i)=>{
    const label = spread===10 ? pos10[i] : spread===5 ? pos5[i] : spread===3 ? pos3[i] : '当下';
    const dir = c.reversed ? '逆位' : '正位';
    const mean = parseMeaning(c.name,c.reversed).replace(/^正位：|^逆位：/,'');
    return `• 【${label}】${c.name}（${dir}）— ${mean}`;
  }).join('<br>');

  // 核心：主题推断 + 综合建议
  const topic  = inferTopic(q, picks, stats);
  const advice = topicAdvice(topic, stats, spreadName);

  return `
    <p><b>问题：</b>${q||'（未填写）'}</p>
    <p><b>牌阵：</b>${spreadName}</p>
    <p>${suitHint} 大阿尔克那占比约 <b>${majorRate}%</b>；逆位约 <b>${revRate}%</b>。</p>
    <p><b>逐位置解读：</b><br>${list}</p>
    <p><b>综合建议：</b>${advice}</p>
  `;
}

/* --- TTS --- */
let lastSpoken='',speaking=false;
function pickZhVoice(){const vs=speechSynthesis.getVoices();return vs.find(v=>/zh|cmn/i.test(v.lang))||vs[0]}
function speak(text){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  const v=pickZhVoice(); if(v)u.voice=v;
  u.rate=1;u.pitch=1;u.volume=1;
  u.onend=()=>{speaking=false;document.getElementById('ttsBtn').innerHTML='🔊 <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>'};
  speaking=true;
  document.getElementById('ttsBtn').textContent='⏸ 暂停';
  speechSynthesis.speak(u);
}
function toggleTTS(){
  if(!('speechSynthesis'in window)) return alert('当前浏览器不支持语音朗读');
  if(speaking){
    speechSynthesis.cancel(); speaking=false;
    document.getElementById('ttsBtn').innerHTML='🔊 <span data-i18n="tts_btn">'+(I18N[currentLang].tts_btn)+'</span>';
  }else{
    speak(lastSpoken||'暂无可朗读内容。');
  }
}

/* --- 去标签供朗读 --- */
function stripTags(html){
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  let text = tmp.textContent || tmp.innerText || '';
  return text.replace(/[•【】—·]/g,' ').replace(/\s+/g,' ').trim();
}

/* --- 抽牌与渲染 --- */
function draw(){
  const n=+document.getElementById('spread').value;
  const q=document.getElementById('question').value.trim();
  document.getElementById('qdisplay').textContent = q
    ? (currentLang==='en' ? `Question: ${q}` : `问题：${q}`)
    : (I18N[currentLang].tip_focus);

  const board=document.getElementById('board');
  board.innerHTML='';
  board.className='board '+(n===1?'spread-1':n===3?'spread-3':n===5?'spread-5':'spread-10');

  const pool=[...DECK], take=()=>pool.splice(Math.floor(Math.random()*pool.length),1)[0], picks=[];
  function place(pair,label,extra=''){
    const [name,url]=pair, reversed=Math.random()<0.5; picks.push({name,reversed});
    const wrap=document.createElement('div'); wrap.className='card '+extra;
    const imgw=document.createElement('div'); imgw.className='imgwrap';
    const img=new Image(); img.className='card-img'; img.loading='eager';
    img.src=viaProxy(url,400); img.onerror=()=>{img.onerror=null;img.src=url}; if(reversed) img.style.transform='rotate(180deg)';
    const cap=document.createElement('div'); cap.className='cap'; cap.textContent=label?`${name} · ${label}`:name;
    const mean=document.createElement('div'); mean.className='mean'; mean.textContent=parseMeaning(name,reversed);
    imgw.appendChild(img); wrap.appendChild(imgw); wrap.appendChild(cap); wrap.appendChild(mean); board.appendChild(wrap);
  }
  if(n===1){place(take(),'当下')}
  else if(n===3){place(take(),'过去');place(take(),'现在');place(take(),'未来')}
  else if(n===5){
    place(take(),'过去','pos-top');
    place(take(),'潜意识','pos-left');
    place(take(),'当下','pos-center');
    place(take(),'外在影响','pos-right');
    place(take(),'未来趋势','pos-bottom');
  }else{
    const labels10=['当下','阻碍','潜意识','显意识','过去','未来','自我','环境','希望/恐惧','结果'];
    for(let i=0;i<10;i++) place(take(),labels10[i],`c${i+1}`);
  }

  const unified = buildReading(q, picks, n);
  document.getElementById('readingText').innerHTML = unified;
  document.getElementById('reading').style.display = 'block';
  lastSpoken = stripTags(unified);
}

/* --- 事件绑定 & 初始化 --- */
document.getElementById('go').addEventListener('click', draw);
document.getElementById('ttsBtn').addEventListener('click', toggleTTS);
document.getElementById('langSel').addEventListener('change', e=>{
  currentLang = e.target.value;
  applyI18N(currentLang);
});
applyI18N(currentLang);

// 语音预热（部分浏览器需要）
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = ()=>{};
}
</script>
</body>
</html>
