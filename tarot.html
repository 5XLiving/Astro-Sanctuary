<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>塔罗牌占卜 · Tarot</title>
<style>
:root{
  --bg:#0b0f14;
  --card:#11161dcc;
  --line:#1f2a36;
  --text:#e8edf3;      /* page body text = white */
  --muted:#98a7b7;
  --gold:#e6c76e;      /* header/title accents */
  --brand:#d4af37;
  --radius:14px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --card-w:128px;
  --card-h:212px;
  --gap:14px;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,"Noto Sans SC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
  line-height:1.6;
}

/* (NEW) Remove sitewide gold text — keep white body text.
   If you previously injected gold globally, ensure that rule is deleted. */

/* Scrollbar (optional) */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{background:#1b2430;border-radius:8px;border:2px solid #0b0f14}
*::-webkit-scrollbar-track{background:#0b0f14}

/* Header */
header{
  position:sticky; top:0; z-index:20;
  backdrop-filter:blur(10px);
  background:#0b0f14cc;
  border-bottom:1px solid var(--line);
}
.head-inner{
  max-width:1100px; margin:0 auto;
  padding:12px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:10px}
.brand img.logo{
  width:28px; height:28px; object-fit:contain; display:block;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
}
.brand-badge{
  background:var(--brand); color:#111;
  padding:6px 10px; border-radius:8px; font-weight:800
}
.title{font-weight:700; color:var(--gold);}     /* header font = gold */
.lang select{
  padding:6px 8px; border-radius:8px;
  background:#0f1420; color:#e8edf3;
  border:1px solid #273245
}

/* Page container */
.app{max-width:1100px; margin:0 auto; padding:18px}
h1{margin:6px 0 14px; color:var(--gold); font-weight:800} /* section title keeps gold accent */

/* Controls */
.controls{
  display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px
}
.controls input, .controls select, .controls button{
  padding:12px; border-radius:12px;
  border:1px solid #273245; background:#0f1420; color:var(--text)
}
.controls input{flex:1; min-width:220px}
.controls button{
  cursor:pointer;
  background:linear-gradient(180deg,#fff9e6,var(--gold));
  color:#121212; border-color:var(--gold); font-weight:800
}
.q{margin:6px 0 12px; font-weight:600; color:var(--muted)}

/* Pills */
.pick-group{display:flex; align-items:center; gap:8px}
.pick-group .pill{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background:#0f1420; color:var(--text); cursor:pointer; user-select:none
}
.pill.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(230,199,110,.15)}

/* Board + cards */
.board{display:grid; gap:var(--gap); justify-content:center}
.card{
  display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center;
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  padding:10px 10px 12px; box-shadow:var(--shadow)
}
.imgwrap{
  width:var(--card-w); height:var(--card-h);
  border-radius:10px; overflow:hidden; background:#000;
  display:grid; place-items:center; border:1px solid #34455a
}
.card-img{width:100%; height:100%; object-fit:contain; display:block}
.cap{font-size:13px; color:var(--gold)}
.mean{font-size:12px; color:#c9d4e3}

/* Spreads */
.spread-1{grid-template-columns:var(--card-w)}
.spread-3{grid-template-columns:repeat(3,var(--card-w))}
.spread-5{
  display:grid;
  grid-template-areas:
    "top top top"
    "left center right"
    ". bottom .";
  grid-template-columns:var(--card-w) var(--card-w) var(--card-w);
  gap:var(--gap); justify-content:center;
}
.pos-top{grid-area:top} .pos-left{grid-area:left} .pos-center{grid-area:center}
.pos-right{grid-area:right} .pos-bottom{grid-area:bottom}
.spread-10{
  display:grid; gap:var(--gap);
  grid-template-rows:auto auto auto; justify-items:center;
}
.spread-10 .row{ display:grid; gap:var(--gap); justify-content:center; }
.spread-10 .row.row-1,
.spread-10 .row.row-2{ grid-template-columns:repeat(3,var(--card-w)); }
.spread-10 .row.row-3{ grid-template-columns:repeat(4,var(--card-w)); }

/* Panels */
.panel{
  margin-top:16px; background:var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:14px
}
.panel h3{margin:0 0 8px; font-size:1.05rem; color:#ffe084}
.muted{color:var(--muted)}

/* Chat bubbles */
.chat{display:flex; flex-direction:column; gap:10px}
.msg{
  max-width:90%;
  padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:var(--card); box-shadow:var(--shadow); color:var(--text)
}
.msg.user{
  align-self:flex-end;
  background:linear-gradient(180deg,rgba(212,175,55,.18),rgba(212,175,55,.10));
  border-color:#4b3b15;
  color:var(--gold);
}
.msg.assistant{
  align-self:flex-start;
  background:#0e141d; border-color:#1c2634;
}
.msg .meta{font-size:12px; color:var(--muted); margin-bottom:6px}

/* Code blocks */
pre, code, .code{
  background:#0f1420; color:#e8edf3; border:1px solid #273245;
  border-radius:10px; padding:10px 12px; overflow:auto
}
pre code{padding:0; border:0; background:transparent; color:#e8edf3}

/* Tags */
.tag{font-size:12px; padding:2px 8px; border:1px solid var(--gold); border-radius:999px; opacity:.95}
.rev{border-color:#f19e9e; color:#f3b6b6}

/* Responsive */
@media (max-width:560px){
  :root{ --card-w:100px; --card-h:166px; --gap:12px; }
  .head-inner{padding:10px 12px}
  .app{padding:14px}
  .spread-1{grid-template-columns:var(--card-w)}
  .spread-3{grid-template-columns:repeat(3,var(--card-w))}
  .spread-5{grid-template-columns:var(--card-w) var(--card-w) var(--card-w)}
  .spread-10{display:grid}
  .spread-10 .row{grid-template-columns:repeat(2,var(--card-w))}
}
</style>
</head>

<body>
<header>
  <div class="head-inner">
    <div class="brand">
      <!-- NEW: 5X logo (replace src with your real path) -->
      <img class="logo" src="/img/5x-logo.png" alt="5X" />
      <div class="brand-badge">Tarot</div>
      <div class="title" data-i18n="brand_title">命理心怜空间 · Soul Sanctuary</div>
    </div>
    <div class="lang">
      <select id="langSel">
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
        <option value="en">English</option>
        <option value="en-US">English (US)</option>
        <option value="ja">日本語</option>
        <option value="th">ไทย</option>
        <option value="ms">Bahasa Melayu</option>
      </select>
    </div>
  </div>
</header>

<div class="app">
  <h1 data-i18n="page_title">塔罗牌占卜</h1>

  <div class="controls">
    <input id="question" placeholder="请输入你的问题（必填，决定解读方向）" data-i18n-placeholder="q_ph" />
    <select id="spread">
      <option value="1" data-i18n="s1">单张</option>
      <option value="3" data-i18n="s3">三张（过去 / 现在 / 未来）</option>
      <option value="5" data-i18n="s5">十字排法（5张）</option>
      <option value="10" data-i18n="s10">凯尔特十字（10张）</option>
    </select>
    <button id="go" data-i18n="draw_btn">抽牌</button>
  </div>

  <div id="qdisplay" class="q muted" data-i18n="tip_focus">（提示：输入问题会让解读更聚焦）</div>
  <div id="board" class="board"></div>

  <!-- FIX: restore explanation area so 心怜管家显示 -->
  <div id="reading" class="panel" style="display:none">
    <h3 style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span data-i18n="reading_title">解读与建议 - 说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先</span>
      </div>
  <br>
    </h3>
    <div id="readingText"></div>
  </div>
</div>

<script>
/* ===========================
   I18N
=========================== */
const I18N = {
  'zh-CN': {
    ui: {
      page_title: '塔罗牌占卜',
      q_ph:'请输入你的问题（必填，决定解读方向）',
      s1:'单张', s3:'三张（过去 / 现在 / 未来）', s5:'十字排法（5张）', s10:'凯尔特十字（10张）',
      draw_btn:'抽牌',
      tip_focus:'（提示：输入问题会让解读更聚焦）',
      reading_title:'解读与建议 - 说明：塔罗为指引工具，非医学/法律/金融建议，请以理性判断与自我意愿为先',
    },
    pos: { single:'当下核心', past:'过去', present:'现在', future:'未来',
      top:'指引/主题', left:'过去根源', center:'当下核心', right:'外在影响', bottom:'未来发展',
      p1:'当下', p2:'阻碍', p3:'潜意识', p4:'过去', p5:'显意识', p6:'未来', p7:'自我', p8:'环境', p9:'希望/恐惧', p10:'结果'},
    suits: {
      wands:{name:'权杖', domain:'行动/热情'},
      cups:{name:'圣杯', domain:'情感/关系'},
      swords:{name:'宝剑', domain:'思维/沟通'},
      pentacles:{name:'钱币', domain:'现实/资源'}
    },
    ranks:{
      ace:'一','2':'二','3':'三','4':'四','5':'五','6':'六','7':'七','8':'八','9':'九','10':'十',
      page:'侍从', knight:'骑士', queen:'皇后', king:'国王',
      tone:{ ace:'起点/潜能','2':'对话/选择','3':'协作/成长','4':'结构/稳定','5':'挑战/波动','6':'交流/支持','7':'评估/耐心','8':'推进/效率','9':'成果/负担','10':'阶段完成', page:'讯息/学习', knight:'行动/推动', queen:'成熟/滋养', king:'掌控/定调'}
    },
    majors:[
      ['愚者','自由/跃迁','拥抱未知，轻装启程'],['魔术师','意志/显化','集中资源，立即行动'],['女祭司','直觉/潜意识','先观察，后表态'],['女皇','滋养/丰盛','以温柔与照料促进成长'],['皇帝','秩序/结构','定规则、立边界、给安全感'],['教皇','规范/传承','遵循制度与长辈建议'],['恋人','选择/连结','对齐价值观再承诺'],['战车','推进/胜负','定目标，强势推进'],['力量','勇气/温柔','以柔克刚，稳定耐心'],['隐者','内省/独处','收心审视，独立判断'],['命运之轮','周期/机缘','顺势而为，抓时机'],['正义','衡量/公平','以事实与边界解决'],['倒吊人','停止/换角','暂缓推进，换位思考'],['死神','结束/重生','果断止损，迎接新生'],['节制','调和/节律','降强度，稳节奏'],['恶魔','执著/诱惑','辨依赖，断不良循环'],['高塔','突变/瓦解','接纳变化，快速重组'],['星星','希望/复原','重建信任，温柔修复'],['月亮','迷雾/不安','推迟重大决定，先查明'],['太阳','清晰/喜悦','公开透明，庆祝成果'],['审判','觉醒/召回','回应召唤，纠偏复盘'],['世界','完成/整合','闭环与升级，开启新篇']
    ],
    tags:{upright:'正位', reversed:'逆位'},
    nextSteps:'<b>下一步（48 小时内）：</b><br>① 写下 1 条小目标；② 安排 1 个具体行动（加到日历）；③ 用 3 个客观指标衡量（如回复频率、面谈时长、实际成交/预约）。',
    posHint:{
      past:'回顾过去经验，找可复用或需放下的部分',
      present:'描述当前核心矛盾与关键变量',
      future:'给出两步以内可执行动作，避免空谈愿景',
      top:'以“主题/原则”定调当下选择',
      left:'识别历史惯性与旧信念的影响',
      center:'聚焦此刻真正要解决的一件事',
      right:'评估外部因素/他人立场',
      bottom:'规划接下来 1–3 周路径',
      p1:'描述当下状态与主要张力',
      p2:'指出阻碍与对策',
      p3:'点破潜意识动机/恐惧',
      p4:'回顾成因与既往模式',
      p5:'眼前认知与显性目标',
      p6:'未来 1–6 周的趋势',
      p7:'自我定位与角色选择',
      p8:'环境/他人/情境影响',
      p9:'希望与恐惧的两面',
      p10:'阶段性结果与调整建议',
      single:'提炼本次占卜的唯一关键行动'
    },
    domainAdvice:{
      love:{majorRev:'先放慢表达强度，尊重对方边界与节奏', majorOk:'以真诚与稳定行动建立安全感',
        wands:'避免情绪化推进，先确认彼此意愿',
        cups:'先自稳情绪，再谈需求与亲密',
        swords:'减少质问，多用澄清式提问',
        pentacles:'少物质对冲，多高质量相处'},
      career:{majorRev:'修正方向与分工，别硬推', majorOk:'制定里程碑与负责矩阵',
        wands:'控制节奏，拆小步',
        cups:'凝聚团队情绪，提高协作',
        swords:'用数据与事实避免内耗',
        pentacles:'先补资源/流程再扩张'},
      money:{majorRev:'收缩风险，现金流优先', majorOk:'谨慎扩张，指标驱动',
        wands:'降成本/提效并行',
        cups:'慎选合作，明确分账',
        swords:'复盘模型与假设',
        pentacles:'库存/预算/费用三表联动'},
      health:{majorRev:'先休息与就医评估', majorOk:'建立作息与轻运动',
        wands:'避免过量训练',
        cups:'情绪护理与支持',
        swords:'减压与睡眠优先',
        pentacles:'规律饮食与体检'},
      general:{majorRev:'先稳住再决策', majorOk:'小步验证，逐步推进',
        wands:'放缓节奏，聚焦一件事',
        cups:'优先关系质量',
        swords:'先信息对齐',
        pentacles:'先做可落地资源配置'}
  },

  'en-US': {
    ui: {
      page_title:'Tarot Reading',
      q_ph:'Type your question (focuses the reading)',
      s1:'Single', s3:'Three (Past / Present / Future)', s5:'Cross (5)', s10:'Celtic Cross (10)',
      draw_btn:'Draw',
      tip_focus:'(Tip: a clear question focuses the reading)',
      reading_title:'Insights & Advice - Tarot offers guidance, not medical/legal/financial advice. Use your judgment',
    },
    pos:{single:'Core Now', past:'Past', present:'Present', future:'Future',
         top:'Theme/Guidance', left:'Roots', center:'Core Now', right:'External', bottom:'Development',
         p1:'Present', p2:'Obstacle', p3:'Subconscious', p4:'Past', p5:'Conscious', p6:'Future', p7:'Self', p8:'Environment', p9:'Hopes/Fears', p10:'Outcome'},
    suits:{
      wands:{name:'Wands', domain:'Action/Passion'},
      cups:{name:'Cups', domain:'Emotion/Relations'},
      swords:{name:'Swords', domain:'Mind/Communication'},
      pentacles:{name:'Pentacles', domain:'Material/Resources'}
    },
    ranks:{
      ace:'Ace','2':'Two','3':'Three','4':'Four','5':'Five','6':'Six','7':'Seven','8':'Eight','9':'Nine','10':'Ten',
      page:'Page', knight:'Knight', queen:'Queen', king:'King',
      tone:{ace:'Seed/Potential','2':'Duality/Choice','3':'Collab/Growth','4':'Structure/Stability','5':'Challenge/Flux','6':'Exchange/Support','7':'Evaluate/Patience','8':'Momentum/Efficiency','9':'Result/Burden','10':'Completion',
            page:'Message/Learning', knight:'Action/Drive', queen:'Maturity/Nurture', king:'Authority/Setting Tone'}
    },
    majors:[
      ['The Fool','Freedom/Leap','Embrace the unknown; travel light'],
      ['The Magician','Will/Manifest','Align resources; act now'],
      ['The High Priestess','Intuition/Subconscious','Observe first, speak later'],
      ['The Empress','Nurture/Abundance','Gentle care grows results'],
      ['The Emperor','Order/Structure','Set rules and safety'],
      ['The Hierophant','Norms/Tradition','Follow guidance and standards'],
      ['The Lovers','Choice/Union','Align values before commitment'],
      ['The Chariot','Push/Win','Pick a target; drive forward'],
      ['Strength','Courage/Gentleness','Soft power, steady patience'],
      ['The Hermit','Introspect/Alone','Withdraw to assess'],
      ['Wheel of Fortune','Cycle/Timing','Ride the turn; seize timing'],
      ['Justice','Measure/Fairness','Facts and boundaries solve it'],
      ['The Hanged Man','Pause/Reframe','Wait; see from another angle'],
      ['Death','Ending/Rebirth','Cut losses; welcome renewal'],
      ['Temperance','Blend/Rhythm','Lower intensity; steady cadence'],
      ['The Devil','Attachment/Temptation','Name the bind; break the loop'],
      ['The Tower','Shock/Collapse','Accept change; rebuild swiftly'],
      ['The Star','Hope/Recovery','Restore trust; heal gently'],
      ['The Moon','Fog/Anxiety','Delay big moves; verify facts'],
      ['The Sun','Clarity/Joy','Be open; celebrate wins'],
      ['Judgement','Awakening/Call','Answer the call; correct course'],
      ['The World','Completion/Integration','Close the loop; level up']
    ],
    tags:{upright:'Upright', reversed:'Reversed'},
    nextSteps:'<b>Next 48h:</b><br>(1) Write one small goal; (2) Schedule one concrete action; (3) Track 3 objective metrics (e.g., reply cadence, meeting time, actual bookings).',
    posHint:{
      past:'Extract reusable lessons or what to release',
      present:'Name the core tension and variables',
      future:'Give 1–2 actionable next steps',
      top:'Set principles to guide choices',
      left:'Spot legacy patterns/beliefs',
      center:'Focus on the one real problem',
      right:'Weigh external factors/others',
      bottom:'Plan next 1–3 weeks',
      p1:'Describe current state and tension',
      p2:'Point out obstacle and counter-move',
      p3:'Expose hidden motives/fears',
      p4:'Review causes and patterns',
      p5:'Conscious goal and frame',
      p6:'Trend for next 1–6 weeks',
      p7:'Your role/stance',
      p8:'Context and stakeholders',
      p9:'Hope vs fear twin view',
      p10:'Likely outcome & adjustment',
      single:'One key action for this session'
    },
    domainAdvice:{
      love:{majorRev:'Slow intensity; honor boundaries', majorOk:'Build safety with steady acts',
        wands:'Curb impulsive pushes; confirm consent',
        cups:'Regulate emotion before needs talk',
        swords:'Use clarifying questions over grilling',
        pentacles:'Less gifting; more quality time'},
      career:{majorRev:'Fix direction/roles before pushing', majorOk:'Milestones and RACI',
        wands:'Control pace; break into sprints',
        cups:'Rally morale; improve collaboration',
        swords:'Use data to avoid churn',
        pentacles:'Secure resources/process first'},
      money:{majorRev:'De-risk; protect cashflow', majorOk:'Cautious growth; KPI-led',
        wands:'Cut cost + raise efficiency',
        cups:'Choose partners carefully; clear split',
        swords:'Audit assumptions and model',
        pentacles:'Tie inventory/budget/expenses'},
      health:{majorRev:'Rest & seek evaluation', majorOk:'Routines + light exercise',
        wands:'Avoid over-training',
        cups:'Emotional support',
        swords:'Reduce stress; prioritize sleep',
        pentacles:'Diet regularity; check-ups'},
      general:{majorRev:'Stabilize before deciding', majorOk:'Validate in small steps',
        wands:'Slow down; single-task',
        cups:'Prioritize relationship quality',
        swords:'Align information first',
        pentacles:'Resource a concrete plan first'}
    },
      'ja': {
    ui: {
      page_title:'タロット占い',
      q_ph:'質問を入力してください（解釈の焦点になります）',
      s1:'1枚', s3:'3枚（過去/現在/未来）', s5:'十字法（5枚）', s10:'ケルト十字（10枚）',
      draw_btn:'カードを引く',
      tip_focus:'（ヒント：具体的な質問ほど読みが明確になります）',
      reading_title:'解釈とアドバイス - タロットは指針であり、医療・法律・金融の助言ではありません。最終判断はご自身で',
    },
    pos:{single:'核心（今）', past:'過去', present:'現在', future:'未来',
         top:'テーマ/指針', left:'ルーツ', center:'核心（今）', right:'外部要因', bottom:'展開/見通し',
         p1:'現在', p2:'障害', p3:'無意識', p4:'過去', p5:'顕在意識', p6:'未来', p7:'自己', p8:'環境', p9:'希望/恐れ', p10:'結果'},
    suits:{
      wands:{name:'ワンド', domain:'行動/情熱'},
      cups:{name:'カップ', domain:'感情/関係'},
      swords:{name:'ソード', domain:'思考/コミュニケーション'},
      pentacles:{name:'ペンタクル', domain:'物質/資源'}
    },
    ranks:{
      ace:'エース','2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9','10':'10',
      page:'ペイジ', knight:'ナイト', queen:'クイーン', king:'キング',
      tone:{ace:'種/可能性','2':'二項/選択','3':'協働/成長','4':'構造/安定','5':'挑戦/変動','6':'交換/支援','7':'評価/忍耐','8':'推進/効率','9':'成果/負担','10':'完了',
            page:'メッセージ/学び', knight:'行動/推進', queen:'成熟/育成', king:'権威/方針決定'}
    },
    majors:[
      ['愚者','自由/跳躍','未知を受け入れ、軽やかに進む'],
      ['魔術師','意志/具現','資源を整え、今すぐ動く'],
      ['女教皇','直感/潜在意識','まず観察し、その後に言葉を'],
      ['女帝','養育/豊かさ','優しさが成長を促す'],
      ['皇帝','秩序/構造','ルールと安全を整える'],
      ['法王','規範/伝統','指導と規格に従う'],
      ['恋人','選択/結びつき','価値観を合わせてから決断'],
      ['戦車','前進/勝利','目標を定め、力強く進む'],
      ['力','勇気/柔和','柔らかい力で粘り強く'],
      ['隠者','内省/独立','一度引き、静かに見直す'],
      ['運命の輪','循環/タイミング','流れに乗り、機を掴む'],
      ['正義','測定/公平','事実と境界で解く'],
      ['吊るされた男','停止/視点変更','待って視点を変える'],
      ['死神','終焉/再生','損切りし、新生を迎える'],
      ['節制','調和/リズム','強度を下げ、リズムを整える'],
      ['悪魔','執着/誘惑','依存を名指し、ループを断つ'],
      ['塔','崩壊/急変','変化を受け入れ再構築'],
      ['星','希望/回復','信頼を回復し、優しく癒す'],
      ['月','霧/不安','大決断を延期し、検証する'],
      ['太陽','明瞭/喜び','オープンにし、成果を祝う'],
      ['審判','覚醒/呼びかけ','呼びかけに応え軌道修正'],
      ['世界','完成/統合','ループを閉じ、次段へ']
    ],
    tags:{upright:'正位置', reversed:'逆位置'},
    nextSteps:'<b>次の48時間：</b><br>① 小さな目標を1つ書く ② 具体的行動を1つ予定に入れる ③ 客観指標を3つで追跡（返信頻度/面談時間/実予約など）',
    posHint:{
      past:'再利用できる教訓/手放すものを抽出',
      present:'核心の緊張と変数を特定',
      future:'1–2歩の実行アクションを示す',
      top:'原則で選択をガイド',
      left:'過去のパターン/信念を認識',
      center:'解くべき一点に集中',
      right:'外部/他者の影響を評価',
      bottom:'1–3週間の道筋を描く',
      p1:'現状と張力を言語化',
      p2:'障害と対抗策を提示',
      p3:'動機/恐れの可視化',
      p4:'原因と既往パターン',
      p5:'現在の枠組みと狙い',
      p6:'1–6週のトレンド',
      p7:'自分の立ち位置',
      p8:'文脈/関係者',
      p9:'希望と恐れの両面',
      p10:'見込み結果と調整',
      single:'今回の唯一の行動ポイント'
    },
    domainAdvice:{
      love:{majorRev:'強度を落とし、境界とペースを尊重', majorOk:'誠実で安定した行動で安心感を築く',
        wands:'突進を抑え、合意を確認',
        cups:'感情を整えてからニーズを対話',
        swords:'詰問よりも確認質問を',
        pentacles:'物で埋めず、質の高い時間を'},
      career:{majorRev:'方向/役割を整えてから推進', majorOk:'マイルストーンと責任表',
        wands:'ペース管理、タスク分割',
        cups:'士気と協働を高める',
        swords:'データで空転を防ぐ',
        pentacles:'資源/プロセスを先に整備'},
      money:{majorRev:'リスク縮小、キャッシュ重視', majorOk:'慎重拡大、KPI駆動',
        wands:'コスト削減＋効率化',
        cups:'提携は選別し配分明確に',
        swords:'前提とモデルを監査',
        pentacles:'在庫/予算/費用を連動'},
      health:{majorRev:'休息と受診評価を優先', majorOk:'生活リズム＋軽運動',
        wands:'過剰トレを避ける',
        cups:'情緒ケアと支援',
        swords:'ストレス軽減と睡眠優先',
        pentacles:'食事の規則性と検診'},
      general:{majorRev:'まず安定、その後決断', majorOk:'小さく検証し段階推進',
        wands:'ペースを落とし一点集中',
        cups:'関係の質を優先',
        swords:'情報整合を先に',
        pentacles:'実行可能な資源計画を先に'}
  },

  'th': {
    ui: {
      page_title:'ทำนายไพ่ทาโรต์',
      q_ph:'พิมพ์คำถามของคุณ (ช่วยโฟกัสคำทำนาย)',
      s1:'ใบเดียว', s3:'3 ใบ (อดีต/ปัจจุบัน/อนาคต)', s5:'ไม้กางเขน (5 ใบ)', s10:'เซลติกครอส (10 ใบ)',
      draw_btn:'สุ่มไพ่',
      tip_focus:'(ทิป: คำถามชัดเจนทำให้การอ่านแม่นยำขึ้น)',
      reading_title:'คำตีความ & คำแนะนำ - ไพ่ทาโรต์ให้แนวทาง ไม่ใช่คำแนะนำทางแพทย์/กฎหมาย/การเงิน กรุณาใช้วิจารณญาณของตนเอง',
    },
    pos:{single:'แก่นตอนนี้', past:'อดีต', present:'ปัจจุบัน', future:'อนาคต',
         top:'ธีม/แนวทาง', left:'รากเหง้า', center:'แก่นตอนนี้', right:'ปัจจัยภายนอก', bottom:'พัฒนา/แนวโน้ม',
         p1:'ปัจจุบัน', p2:'อุปสรรค', p3:'จิตใต้สำนึก', p4:'อดีต', p5:'จิตสำนึก', p6:'อนาคต', p7:'ตนเอง', p8:'สภาพแวดล้อม', p9:'ความหวัง/ความกลัว', p10:'ผลลัพธ์'},
    suits:{
      wands:{name:'ไม้เท้า', domain:'การลงมือ/แรงผลักดัน'},
      cups:{name:'ถ้วย', domain:'อารมณ์/ความสัมพันธ์'},
      swords:{name:'ดาบ', domain:'ความคิด/การสื่อสาร'},
      pentacles:{name:'เหรียญ', domain:'วัตถุ/ทรัพยากร'}
    },
    ranks:{
      ace:'เอซ','2':'สอง','3':'สาม','4':'สี่','5':'ห้า','6':'หก','7':'เจ็ด','8':'แปด','9':'เก้า','10':'สิบ',
      page:'ไพ่เด็ก', knight:'อัศวิน', queen:'ราชินี', king:'ราชา',
      tone:{ace:'เมล็ด/ศักยภาพ','2':'คู่/ทางเลือก','3':'ร่วมมือ/เติบโต','4':'โครงสร้าง/มั่นคง','5':'ท้าทาย/ผันผวน','6':'แลกเปลี่ยน/สนับสนุน','7':'ประเมิน/อดทน','8':'ขับเคลื่อน/ประสิทธิภาพ','9':'ผลลัพธ์/ภาระ','10':'จบขั้น',
            page:'สาร/การเรียนรู้', knight:'การกระทำ/ผลักดัน', queen:'วุฒิภาวะ/เลี้ยงดู', king:'อำนาจ/กำหนดทิศ'}
    },
    majors:[
      ['คนโง่','อิสระ/ก้าวกระโดด','โอบรับความไม่รู้ เดินหน้าอย่างเบา'],
      ['นักมายากล','เจตจำนง/สร้างผล','รวบรวมทรัพยากร ลงมือทันที'],
      ['นักบวชหญิง','สัญชาตญาณ/จิตลึก','สังเกตก่อน พูดภายหลัง'],
      ['จักรพรรดินี','การเลี้ยงดู/ความอุดม','ความอ่อนโยนทำให้เติบโต'],
      ['จักรพรรดิ','ระเบียบ/โครงสร้าง','วางกติกาและความปลอดภัย'],
      ['พระสังฆราช','บรรทัดฐาน/ประเพณี','เชื่อคำแนะนำและมาตรฐาน'],
      ['คนรัก','ทางเลือก/สายใย','ให้ค่านิยมสอดคล้องก่อนผูกมัด'],
      ['รถศึก','ผลักดัน/ชัยชนะ','ตั้งเป้าแล้วขับเคลื่อน'],
      ['พลัง','ความกล้า/อ่อนโยน','พลังนุ่มนวล อดทนมั่นคง'],
      ['ฤาษี','ครุ่นคิด/ลำพัง','ถอยมาทบทวนอย่างสงบ'],
      ['วงล้อแห่งโชคชะตา','วัฏจักร/จังหวะ','ไปตามกระแส จับจังหวะ'],
      ['ความยุติธรรม','ชั่งตวง/ความยุติธรรม','ข้อเท็จจริงและขอบเขตช่วยแก้'],
      ['คนถูกแขวนคอ','หยุด/เปลี่ยนมุมมอง','รอและมองอีกมุม'],
      ['ความตาย','สิ้นสุด/เกิดใหม่','ตัดขาดเพื่อเริ่มใหม่'],
      ['ความพอประมาณ','ผสาน/จังหวะ','ลดความเข้ม รักษาจังหวะ'],
      ['ปีศาจ','ยึดติด/สิ่งล่อใจ','ตั้งชื่อพันธนาการแล้วตัดวงจร'],
      ['หอคอย','ช็อก/พังทลาย','ยอมรับความเปลี่ยน รีบสร้างใหม่'],
      ['ดาว','ความหวัง/เยียวยา','ฟื้นความไว้ใจ เยียวยาอย่างอ่อนโยน'],
      ['พระจันทร์','หมอก/ความกังวล','เลื่อนการตัดสินใจใหญ่ ตรวจสอบก่อน'],
      ['พระอาทิตย์','ความชัด/ความสุข','โปร่งใสและเฉลิมฉลอง'],
      ['การพิพากษา','ตื่นรู้/การเรียก','ตอบเสียงเรียกและปรับทิศ'],
      ['โลก','เสร็จสิ้น/บูรณาการ','ปิดวงแล้วยกระดับ']
    ],
    tags:{upright:'ตั้งตรง', reversed:'กลับหัว'},
    nextSteps:'<b>ภายใน 48 ชม.:</b><br>1) เขียนเป้าหมายเล็ก 1 ข้อ 2) ใส่แผนการกระทำลงปฏิทิน 3) ติดตามตัวชี้วัด 3 อย่าง (จังหวะตอบกลับ เวลาเจอจริง การจองจริง ฯลฯ)',
    posHint:{
      past:'ดึงบทเรียนที่ใช้ได้/สิ่งที่ควรวาง',
      present:'ระบุความตึงเครียดหลักและตัวแปร',
      future:'ให้ขั้นถัดไปที่ทำได้ 1–2 ขั้น',
      top:'ใช้หลักการกำกับการเลือก',
      left:'สังเกตแบบแผน/ความเชื่อเดิม',
      center:'โฟกัสปัญหาแกนเดียว',
      right:'ชั่งปัจจัยภายนอก/ผู้มีส่วนได้เสีย',
      bottom:'วางแผน 1–3 สัปดาห์ถัดไป',
      p1:'บรรยายสถานะและแรงตึง',
      p2:'ชี้อุปสรรคและทางแก้',
      p3:'เปิดเผยแรงขับ/ความกลัวลึก',
      p4:'ทบทวนสาเหตุและรูปแบบเดิม',
      p5:'กรอบคิดและเป้าชัด',
      p6:'แนวโน้ม 1–6 สัปดาห์',
      p7:'บทบาท/จุดยืนของคุณ',
      p8:'บริบทและผู้เกี่ยวข้อง',
      p9:'มุมคู่ของหวัง/กลัว',
      p10:'ผลลัพธ์น่าจะเป็น & การปรับ',
      single:'หนึ่งการกระทำสำคัญของครั้งนี้'
    },
    domainAdvice:{
      love:{majorRev:'ลดความรุนแรง เคารพขอบเขตและจังหวะ', majorOk:'สร้างความปลอดภัยด้วยการกระทำสม่ำเสมอ',
        wands:'อย่าผลีผลาม ตรวจสอบความยินยอม',
        cups:'จัดอารมณ์ก่อนคุยความต้องการ',
        swords:'ใช้คำถามเพื่อความเข้าใจแทนซักไซ้',
        pentacles:'ให้น้อยลง เน้นเวลาคุณภาพมากขึ้น'},
      career:{majorRev:'จัดทิศ/บทบาทก่อนดันงาน', majorOk:'กำหนดไมล์สโตนและความรับผิด',
        wands:'คุมจังหวะ แยกย่อยงาน',
        cups:'ยกระดับขวัญและการร่วมมือ',
        swords:'ใช้ข้อมูลลดการวนลูป',
        pentacles:'จัดสรรทรัพยากร/ขั้นตอนให้พร้อมก่อน'},
      money:{majorRev:'ลดความเสี่ยง เน้นกระแสเงินสด', majorOk:'โตอย่างระวัง อิงตัวชี้วัด',
        wands:'ลดต้นทุน + เพิ่มประสิทธิภาพ',
        cups:'คัดคู่ค้า แบ่งรายได้ให้ชัด',
        swords:'ตรวจสมมติฐานและแบบจำลอง',
        pentacles:'เชื่อมสต็อก/งบประมาณ/ค่าใช้จ่าย'},
      health:{majorRev:'พักและประเมินกับแพทย์', majorOk:'วินัยชีวิต + ออกกำลังเบา',
        wands:'หลีกเลี่ยงซ้อมหนักเกิน',
        cups:'ดูแลอารมณ์และการสนับสนุน',
        swords:'ลดความเครียด เน้นการนอน',
        pentacles:'กินเป็นเวลา ตรวจสุขภาพ'},
      general:{majorRev:'ตั้งหลักก่อนตัดสินใจ', majorOk:'ทดสอบเล็ก ๆ แล้วค่อยขยาย',
        wands:'ชะลอจังหวะ โฟกัสงานเดียว',
        cups:'ให้ความสำคัญคุณภาพความสัมพันธ์',
        swords:'จัดแนวข้อมูลให้ตรงกันก่อน',
        pentacles:'จัดทรัพยากรแผนที่ทำได้จริงก่อน'}
  },

  'ms': {
    ui: {
      page_title:'Bacaan Tarot',
      q_ph:'Taip soalan anda (membantu fokus bacaan)',
      s1:'Satu Kad', s3:'Tiga (Lalu/Kini/Akan Datang)', s5:'Salib (5)', s10:'Celtic Cross (10)',
      draw_btn:'Tarik Kad',
      tip_focus:'(Petua: soalan yang jelas menjadikan bacaan lebih fokus)',
      reading_title:'Tafsiran & Nasihat - Tarot memberi panduan, bukan nasihat perubatan/undang-undang/kewangan. Gunakan pertimbangan sendiri',
    },
    pos:{single:'Teras Kini', past:'Masa Lalu', present:'Masa Kini', future:'Masa Depan',
         top:'Tema/Panduan', left:'Asal Usul', center:'Teras Kini', right:'Luaran', bottom:'Perkembangan',
         p1:'Kini', p2:'Halangan', p3:'Bawah Sedar', p4:'Lalu', p5:'Sedaran', p6:'Akan Datang', p7:'Diri', p8:'Persekitaran', p9:'Harapan/Ketakutan', p10:'Hasil'},
    suits:{
      wands:{name:'Tongkat', domain:'Tindakan/Passion'},
      cups:{name:'Cawan', domain:'Emosi/Hubungan'},
      swords:{name:'Pedang', domain:'Minda/Komunikasi'},
      pentacles:{name:'Syiling', domain:'Material/Sumber'}
    },
    ranks:{
      ace:'Ace','2':'Dua','3':'Tiga','4':'Empat','5':'Lima','6':'Enam','7':'Tujuh','8':'Lapan','9':'Sembilan','10':'Sepuluh',
      page:'Pemuda', knight:'Kesatria', queen:'Permaisuri', king:'Raja',
      tone:{ace:'Benih/Potensi','2':'Dwiti/ Pilihan','3':'Kerjasama/Pertumbuhan','4':'Struktur/Kestabilan','5':'Cabaran/Fluks','6':'Pertukaran/Sokongan','7':'Nilai/Tekun','8':'Momentum/Kecekapan','9':'Hasil/Beban','10':'Tamat Peringkat',
            page:'Mesej/Pembelajaran', knight:'Aksi/Pacu', queen:'Matang/Asuhan', king:'Autoriti/Penetapan Nada'}
    },
    majors:[
      ['The Fool','Kebebasan/Lompatan','Rangkul yang tidak diketahui; mara dengan ringan'],
      ['The Magician','Kemahuan/Manifest','Selaraskan sumber; bertindak sekarang'],
      ['The High Priestess','Intuisi/Bawah Sedar','Pemerhati dahulu, bersuara kemudian'],
      ['The Empress','Asuhan/Kemakmuran','Lembut menumbuhkan hasil'],
      ['The Emperor','Tertib/Struktur','Tetapkan peraturan dan keselamatan'],
      ['The Hierophant','Norma/Tradisi','Ikut bimbingan dan standard'],
      ['The Lovers','Pilihan/Ikatan','Selaraskan nilai sebelum komitmen'],
      ['The Chariot','Dorong/Menang','Tetapkan sasaran; mara ke hadapan'],
      ['Strength','Berani/Lunak','Kekuatan lembut, sabar teguh'],
      ['The Hermit','Introspeksi/Alone','Berundur untuk menilai'],
      ['Wheel of Fortune','Kitaran/Masa','Tumpang arus; rebut masa'],
      ['Justice','Ukur/Adil','Fakta dan sempadan menyelesaikan'],
      ['The Hanged Man','Henti/Tukar Sudut','Tunggu; lihat dari sudut lain'],
      ['Death','Tamat/Kelahiran Semula','Potong kerugian; sambut baharu'],
      ['Temperance','Adun/Ritma','Rendahkan intensiti; stabilkan ritma'],
      ['The Devil','Lekat/Godaan','Namakan belenggu; putuskan kitaran'],
      ['The Tower','Kejutan/Runtuh','Terima perubahan; bina semula cepat'],
      ['The Star','Harapan/Pemulihan','Pulih kepercayaan; sembuh lembut'],
      ['The Moon','Kabur/Gelisah','Tangguh keputusan besar; sahkan fakta'],
      ['The Sun','Jelas/Keriangan','Terbuka; raikan kejayaan'],
      ['Judgement','Sedarkan/Panggilan','Sambut panggilan; betulkan haluan'],
      ['The World','Lengkap/Integrasi','Tutup gelung; naik taraf']
    ],
    tags:{upright:'Tegak', reversed:'Songsang'},
    nextSteps:'<b>48 jam seterusnya:</b><br>1) Tulis satu matlamat kecil; 2) Jadualkan satu tindakan konkrit; 3) Jejak 3 metrik objektif (kadar respons, masa pertemuan, tempahan sebenar).',
    posHint:{
      past:'Tarik pengajaran boleh guna/apa yang perlu dilepas',
      present:'Namakan ketegangan teras dan pembolehubah',
      future:'Beri 1–2 langkah boleh laksana',
      top:'Tetapkan prinsip untuk memandu pilihan',
      left:'Kenal pasti pola/kepercayaan lama',
      center:'Fokus pada masalah sebenar satu perkara',
      right:'Timbang faktor luar/pihak lain',
      bottom:'Rancang 1–3 minggu akan datang',
      p1:'Huraikan keadaan & ketegangan kini',
      p2:'Tunjuk halangan & tindak balas',
      p3:'Dedah motif/kebimbangan tersembunyi',
      p4:'Ulas punca & pola lalu',
      p5:'Matlamat sedar & bingkai',
      p6:'Aliran 1–6 minggu',
      p7:'Peranan/pendirian anda',
      p8:'Konteks & pihak berkepentingan',
      p9:'Harapan vs ketakutan',
      p10:'Hasil mungkin & pelarasan',
      single:'Satu tindakan utama sesi ini'
    },
    domainAdvice:{
      love:{majorRev:'Perlahankan intensiti; hormati sempadan & tempo', majorOk:'Bina rasa selamat dengan tindakan stabil',
        wands:'Kawal impuls; sahkan persetujuan',
        cups:'Atur emosi sebelum bincang keperluan',
        swords:'Guna soalan penjelasan, bukan menyoal siasat',
        pentacles:'Kurang hadiah, lebih masa berkualiti'},
      career:{majorRev:'Betulkan haluan/peranan sebelum menolak', majorOk:'Milestone & matriks tanggungjawab',
        wands:'Kawal tempo; pecah kecil',
        cups:'Satukan moral & kerjasama',
        swords:'Guna data elak putaran kosong',
        pentacles:'Sumber/proses sedia dahulu'},
      money:{majorRev:'Kurangkan risiko; utamakan aliran tunai', majorOk:'Kembang berhati-hati berasaskan KPI',
        wands:'Potong kos + tingkat efisiensi',
        cups:'Pilih rakan kongsi teliti; pecahan jelas',
        swords:'Audit andaian & model',
        pentacles:'Pautkan stok/bajet/perbelanjaan'},
      health:{majorRev:'Rehat & dapatkan penilaian', majorOk:'Rutin + senaman ringan',
        wands:'Elak latihan berlebihan',
        cups:'Sokongan emosi',
        swords:'Kurangkan stres; utamakan tidur',
        pentacles:'Diet berkala & pemeriksaan'},
      general:{majorRev:'Stabilkan dahulu, kemudian putuskan', majorOk:'Sahkan kecil-kecilan lalu skala',
        wands:'Perlahankan; fokus satu perkara',
        cups:'Utamakan kualiti hubungan',
        swords:'Selaraskan maklumat dahulu',
        pentacles:'Rancang sumber yang boleh dilaksana dahulu'}
   }
};

/* Helpers */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const rnd = n => Math.floor(Math.random()*n);

/* Language detect + aliases */
const FALLBACK = 'zh-CN';
function detectLang(){
  const nav=(navigator.language||'').toLowerCase();
  if(nav.startsWith('zh')) return 'zh-CN';
  if(nav.startsWith('en')) return 'en-US';
  return FALLBACK;
}
let CUR = detectLang();
const langSel = document.getElementById('langSel');
langSel.value = CUR;

/* Map alias (new options) */
const LANG_ALIAS = {
  'en':'en-US',
  'ja':'zh-CN',   // no JP pack yet -> fallback
  'th':'zh-CN',   // fallback
  'ms':'zh-CN',   // fallback
  'zh-TW':'zh-CN' // until Traditional set is added
};

/* t() */
function t(path, dflt=''){
  const parts = path.split('.');
  let node = I18N[CUR];
  for(const p of parts){ if(!node) break; node=node[p]; }
  return node==null ? dflt : node;
}

/* Apply static text */
function applyStaticUI(){
  $('[data-i18n="page_title"]').textContent = t('ui.page_title');
  $('[data-i18n="tip_focus"]').textContent = t('ui.tip_focus');
  $('[data-i18n="reading_title"]').textContent = t('ui.reading_title');
  $('[data-i18n="disclaimer"]').textContent = t('ui.disclaimer');
  $('#go').textContent = t('ui.draw_btn');
  const spread = $('#spread');
  spread.options[0].textContent = t('ui.s1');
  spread.options[1].textContent = t('ui.s3');
  spread.options[2].textContent = t('ui.s5');
  spread.options[3].textContent = t('ui.s10');
  $('#question').setAttribute('placeholder', t('ui.q_ph'));
}

/* Deck */
const SUITS = [
  {key:'wands',    zh:'权杖'},
  {key:'cups',     zh:'圣杯'},
  {key:'swords',   zh:'宝剑'},
  {key:'pentacles',zh:'钱币'}
];
const RANKS = [
  {id:'ace', zh:'一'},{id:'2', zh:'二'},{id:'3', zh:'三'},{id:'4', zh:'四'},{id:'5', zh:'五'},
  {id:'6', zh:'六'},{id:'7', zh:'七'},{id:'8', zh:'八'},{id:'9', zh:'九'},{id:'10', zh:'十'},
  {id:'page', zh:'侍从'},{id:'knight', zh:'骑士'},{id:'queen', zh:'皇后'},{id:'king', zh:'国王'}
];
const MAJORS = Array.from({length:22},(_,i)=>i);

function buildDeck(){
  const deck=[];
  MAJORS.forEach(i=>{
    deck.push({id:`major_${String(i).padStart(2,'0')}`, group:'major', idx:i});
  });
  SUITS.forEach(s=>{
    RANKS.forEach(r=>{
      deck.push({id:`${s.key}_${r.id}`, group:'minor', suit:s.key, rank:r.id});
    });
  });
  return deck;
}
const DECK = buildDeck();
function draw(n){
  const pool=[...DECK], picks=[];
  for(let i=0;i<n;i++){
    const idx=rnd(pool.length);
    const card=pool.splice(idx,1)[0];
    card.reversed = Math.random()<0.5;
    picks.push(card);
  }
  return picks;
}
function imgFor(card){
  return `/img/tarot/${card.id}.webp`;
}

/* Spreads */
const SPREADS = {
  1:  { layout:'spread-1',  positions:[{key:'single'}]},
  3:  { layout:'spread-3',  positions:[{key:'past'},{key:'present'},{key:'future'}]},
  5:  { layout:'spread-5',  positions:[
        {key:'top',cls:'pos-top'}, {key:'left',cls:'pos-left'}, {key:'center',cls:'pos-center'},
        {key:'right',cls:'pos-right'}, {key:'bottom',cls:'pos-bottom'}
      ]},
  10: { layout:'spread-10', positions:[
        {key:'p1'},{key:'p2'},{key:'p3'},{key:'p4'},{key:'p5'},{key:'p6'},{key:'p7'},{key:'p8'},{key:'p9'},{key:'p10'}
      ]}
};

/* Localize helpers */
function cardName(card){
  if(card.group==='major'){
    return I18N[CUR].majors[card.idx][0];
  }else{
    const s=I18N[CUR].suits[card.suit];
    const r=I18N[CUR].ranks[card.rank] || card.rank.toUpperCase();
    return `${s.name}${r}`;
  }
}
function previewLineLocalized(card){
  if(card.group==='major'){
    const row = I18N[CUR].majors[card.idx];
    return `${row[1]} · ${row[2]}`;
  }else{
    const s = I18N[CUR].suits[card.suit];
    const tone = I18N[CUR].ranks.tone[card.rank];
    return `${s.name}（${s.domain}）· ${tone}`;
  }
}
function posLabel(key){ return I18N[CUR].pos[key] || key; }
function tagFor(rev){ return rev ? I18N[CUR].tags.reversed : I18N[CUR].tags.upright; }
function classifyQuestion(q){
  q=(q||'').toLowerCase();
  const love = ['恋','爱','喜欢','感情','暧昧','结婚','分手','复合','will she','will he','relationship','love'];
  const career=['工作','升职','跳槽','offer','事业','老板','同事','项目','career','job'];
  const money =['钱','财','收入','投资','生意','销售','预算','money'];
  const health=['健康','身体','疾病','睡眠','焦虑','抑郁','体检','health'];
  if(love.some(k=>q.includes(k))) return 'love';
  if(career.some(k=>q.includes(k))) return 'career';
  if(money.some(k=>q.includes(k))) return 'money';
  if(health.some(k=>q.includes(k))) return 'health';
  return 'general';
}

/* Render board */
function cardNode(card, cls, posKey){
  const div=document.createElement('div');
  div.className=`card ${cls||''}`;
  div.setAttribute('data-card-id', card.id);
  div.setAttribute('data-reversed', card.reversed?'true':'false');

  const wrap=document.createElement('div'); wrap.className='imgwrap';
  if(card.reversed) wrap.style.transform='rotate(180deg)';
  const img=document.createElement('img'); img.className='card-img'; img.src=imgFor(card); img.alt=cardName(card);
  wrap.appendChild(img);

  const cap=document.createElement('div'); cap.className='cap';
  cap.textContent = `【${posLabel(posKey)}】${cardName(card)}（${tagFor(card.reversed)}）`;

  const mean=document.createElement('div'); mean.className='mean';
  mean.textContent = previewLineLocalized(card);

  div.appendChild(wrap); div.appendChild(cap); div.appendChild(mean);
  return div;
}

function renderBoard(n, cards){
  const board = document.getElementById('board');
  board.className='board';
  const conf = SPREADS[n]; if(!conf){ board.innerHTML=''; return; }
  board.classList.add(conf.layout);

  if(n===10){
    board.innerHTML = `<div class="row row-1"></div><div class="row row-2"></div><div class="row row-3"></div>`;
    const rows = $$('#board .row'); const slots=[3,3,4];
    let k=0;
    slots.forEach((count,rowi)=>{
      for(let j=0;j<count;j++){
        const c = cards[k++];
        const posKey = conf.positions[k-1].key;
        rows[rowi].appendChild(cardNode(c, `c${k}`, posKey));
      }
    });
  }else{
    board.innerHTML='';
    cards.forEach((c,i)=>{
      const pos=conf.positions[i];
      board.appendChild(cardNode(c, `c${i+1} ${pos.cls||''}`, pos.key));
    });
  }
}

/* Dynamic reading — 心怜管家显示 */
function renderReadingLocalized(question, n, cards){
  const domain = classifyQuestion(question);
  const posKeys = (n===10)? ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p10']
              : (n===5)?  ['top','left','center','right','bottom']
              : (n===3)?  ['past','present','future']
              : ['single'];

  const domAdv = I18N[CUR].domainAdvice[domain] || I18N[CUR].domainAdvice.general;

  const segments = cards.map((card,i)=>{
    const title = `【${posLabel(posKeys[i])}】${cardName(card)}（${tagFor(card.reversed)}）`;
    const arch  = previewLineLocalized(card);
    const hint  = I18N[CUR].posHint[posKeys[i]] ? `（${I18N[CUR].posHint[posKeys[i]]}）` : '';

    let adv1='';
    if(card.group==='major'){
      adv1 = card.reversed ? domAdv.majorRev : domAdv.majorOk;
    }else{
      const mapKey = card.suit;
      adv1 = domAdv[mapKey] || domAdv.general;
    }

    let adv2='';
    if(card.group!=='major'){
      const tone = I18N[CUR].ranks.tone[card.rank];
      adv2 = (CUR==='en-US')
        ? `Plan one actionable step around “${tone}”.`
        : `围绕“${tone}”制定一条可执行的小行动。`;
    }

    return `
      <div style="margin:8px 0 12px">
        <div style="font-weight:700;color:var(--gold)">${title}</div>
        <div class="muted" style="margin:4px 0">${arch} ${hint}</div>
        <ul style="margin:6px 0 0 18px">
          <li>${adv1}</li>${adv2?`<li>${adv2}</li>`:''}
        </ul>
      </div>`;
  }).join('');

  const who = (CUR==='en-US'?'Xinlian Butler':'心怜管家');

  return `<div class="chat">
    <div class="msg user"><div class="meta">${CUR==='en-US'?'You':'你'}</div>${escapeHTML(question||'')}</div>
    <div class="msg assistant"><div class="meta">${who}</div>
      ${segments}
      <hr style="border:0;border-top:1px solid #273245;margin:12px 0">
      ${I18N[CUR].nextSteps}
    </div>
  </div>`;
}

function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

/* Events */
const goBtn = $('#go');
const spreadSel = $('#spread');
const qInput = $('#question');
const qDisplay = $('#qdisplay');
const readingPanel = $('#reading');
const readingText = $('#readingText');

qInput.addEventListener('input', ()=>{
  qDisplay.textContent = qInput.value ? ((CUR==='en-US'?'Question: ':'问题：') + qInput.value) : t('ui.tip_focus');
});

goBtn.addEventListener('click', ()=>{
  const n = parseInt(spreadSel.value,10);
  const picks = draw(n);
  window.__LAST_PICKS = picks;
  renderBoard(n, picks);

  const q = qInput.value || (CUR==='en-US'?'(No question)':'（未填写问题）');
  const html = renderReadingLocalized(q, n, picks);
  readingText.innerHTML = html;
  readingPanel.style.display = 'block';
});

/* Refresh all */
function refreshAll(){
  applyStaticUI();
  const picks = window.__LAST_PICKS || null;
  if(picks){
    const n = parseInt(spreadSel.value,10);
    renderBoard(n, picks);
    const q = qInput.value || '';
    readingText.innerHTML = renderReadingLocalized(q, n, picks);
    readingPanel.style.display = 'block';
  }
}
langSel.addEventListener('change', ()=>{
  const v = langSel.value;
  CUR = I18N[v] ? v : (LANG_ALIAS[v] || FALLBACK);
  refreshAll();
});

/* First load */
refreshAll();
</script>
</body>
</html>
